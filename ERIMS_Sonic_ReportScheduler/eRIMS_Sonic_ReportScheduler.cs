using System;
using System.Configuration;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Diagnostics;
using System.ServiceProcess;
using System.Text;
using System.IO;
using System.Net.Mail;
using System.Threading;
using ERIMS_DAL;
using System.Web;
using Winnovative.WnvHtmlConvert;

namespace ERIMS_Sonic_ReportScheduler
{
    //*****************************************************//
    // This is a window service to send the scheduled report 
    // Report will be sent to the recipient selected while scheduling
    // Service is continuously running on system and invoke function
    // to send report everyday at the 12:01 AM
    //*****************************************************//
    partial class eRIMS_Sonic_ReportScheduler : ServiceBase
    {
        #region Public Variables
        private const string FirstMonthName = "Jan";
        private const string LastMonthName = "Dec";
        //flag to check status of mail for today is sent or not
        bool flgSendEmail = true;

        //Report schedule on this date will be send.
        DateTime dtSchduleDate = DateTime.Today;

        //Date time format to display in attached excel with Email
        public const String DateDisplayFormat = "MM/dd/yyyy";
        public string _strServiceRunTime = string.Empty;
        public static string Platinum = "90EE90";//Light Green
        public static string Gold = "ADD8E6";//Light Blue
        public static string Silver = "FFFF00";//Yellow
        public static string Bronze = "FFA500";//Orange
        public static string Tin = "FF0000";//Red
        public static string White = "FFFFFF";
        public static string Platinum_Label = "Platinum";
        public static string Gold_Label = "Gold";
        public static string Silver_Label = "Silver";
        public static string Bronze_Label = "Bronze";
        public static string Tin_Label = "Tin";
        public static string Platinum_Label_Graph = "P";
        public static string Gold_Label_Graph = "G";
        public static string Silver_Label_Graph = "S";
        public static string Bronze_Label_Graph = "B";
        public static string Tin_Label_Graph = "T";

        public static string PDFLicenseKey
        {
            get
            {
                return Convert.ToString(ConfigurationManager.AppSettings["LicenseKey"]);
            }
        }

        private bool isGrid = false;

        #endregion

        #region Private enum Variable
        private enum DashboardReport
        {
            Facility_Inspection = 1,
            Incident_Investigation = 2,
            Incident_Reduction = 3,
            WC_Claim_Management = 4
        }
        #endregion

        #region Constructor
        public eRIMS_Sonic_ReportScheduler()
        {
            InitializeComponent();
        }
        #endregion

        #region Events
        /// <summary>
        /// Being Executed when Scheduler service starts
        /// </summary>
        /// <param name="args"></param>
        protected override void OnStart(string[] args)
        {
            ReadConfigSetting();
            // TODO: Add code here to start your service.

            //Make event log entry to indicate starting of service
            EventLog.WriteEntry("eRIMS_Sonic Report Scheduler Started At : " + DateTime.Now.ToString());

            //Create a thread for the function which send email
            Thread TSendMail = default(Thread);
            TSendMail = new System.Threading.Thread(SendReportAsAttachment);

            //Start the thread
            TSendMail.Start();
            TSendMail.CurrentCulture = new System.Globalization.CultureInfo("en-US");
        }

        public void OnStart()
        {
            ReadConfigSetting();
            // TODO: Add code here to start your service.

            //Make event log entry to indicate starting of service
            EventLog.WriteEntry("eRIMS_Sonic Report Scheduler Started At : " + DateTime.Now.ToString());

            //Create a thread for the function which send email
            Thread TSendMail = default(Thread);
            TSendMail = new System.Threading.Thread(SendReportAsAttachment);

            //Start the thread
            TSendMail.Start();
            TSendMail.CurrentCulture = new System.Globalization.CultureInfo("en-US");
        }

        private void ReadConfigSetting()
        {
            _strServiceRunTime = ConfigurationSettings.AppSettings.Get("ServiceRunTime");
        }

        /// <summary>
        /// Being Executed when Scheduler service stops
        /// </summary>
        protected override void OnStop()
        {
            // TODO: Add code here to perform any tear-down necessary to stop your service.
        }

        #endregion

        #region Private Methods
        /// <summary>
        /// Main Function which contains infinite loop and send report when date changed
        /// </summary>
        public void SendReportAsAttachment()
        {
            Thread.Sleep(1000);
            //Thread.Sleep(3600000);
            while (true)
            {
                object objMailSending = ConfigurationManager.AppSettings.Get("AllowMailSending");
                bool _bAllowMailSending = false;
                bool bOutMail;
                if (bool.TryParse(Convert.ToString(objMailSending), out bOutMail))
                    _bAllowMailSending = bOutMail;
                else
                    _bAllowMailSending = false;

                //Check send mail status for today
                if (!Directory.Exists(AppDomain.CurrentDomain.BaseDirectory + @"temp\"))
                    Directory.CreateDirectory(AppDomain.CurrentDomain.BaseDirectory + @"temp\");

                if (flgSendEmail && _bAllowMailSending)
                {
                    EventLog.WriteEntry("Total No of Database Connection String Found : " + ConfigurationManager.ConnectionStrings.Count.ToString());
                    for (int i = 1; i < ConfigurationManager.ConnectionStrings.Count; i++)
                    {
                        if (!string.IsNullOrEmpty(ConfigurationManager.ConnectionStrings[i].ConnectionString))
                        {
                            Report.strConn = ConfigurationManager.ConnectionStrings[i].ConnectionString;
                            //Send report for the schedule date
                            SendReports();
                        }
                    }
                    flgSendEmail = false;
                }

                //Stop Process For 1 Hour to reduce CPU Utilization
                //Thread.Sleep(3600000);

                //service start at 9:00 AM everyday
                //get current date time and tomorrow date time with 9:00 am ::subtract that and get ms this is sleep time of thread
                if (string.IsNullOrEmpty(_strServiceRunTime)) _strServiceRunTime = "09:00:00";

                DateTime dtNextDateTime = Convert.ToDateTime(DateTime.Now.AddDays(1).ToString("yyyy-MM-dd") + " " + _strServiceRunTime);
                DateTime dtCurrentDateTime = DateTime.Now;

                TimeSpan span = dtNextDateTime - dtCurrentDateTime;
                int ms = (int)span.TotalMilliseconds;

                if (ms > 0)
                {
                    EventLog.WriteEntry("Thread sleeps for next " + ms / 3600000 + " Hours");
                    Thread.Sleep(ms);
                    dtSchduleDate = DateTime.Today;
                    flgSendEmail = true;
                }

                //if date changes set schedule date to today's date(new schedule date)
                //if (dtSchduleDate.Date < DateTime.Today.Date)
                //{
                //    dtSchduleDate = DateTime.Today;
                //    flgSendEmail = true;
                //}

            }
        }

        /// <summary>
        /// Sub function to get the scheduled report and send as per report type(report number)
        /// </summary>
        private void SendReports()
        {
            try
            {
                //Fetch All scheduled report for the specified schedule date
                DataTable dtScheduleReports = Report.GetScheduleReports(dtSchduleDate);

                //Send Each report as per report type
                for (int i = 0; i < dtScheduleReports.Rows.Count; i++)
                {
                    switch (Convert.ToInt32(dtScheduleReports.Rows[i]["FK_Report"]))
                    {
                        case 1:
                            BindFinancialSummaryReport(dtScheduleReports.Rows[i]);
                            break;
                        case 2:
                            BindFinancialPayTypeSummaryReport(dtScheduleReports.Rows[i]);
                            break;
                        case 3:
                            BindEmployerLagSummaryReport(dtScheduleReports.Rows[i]);
                            break;
                        case 4:
                            BindInsurerLagSummaryReport(dtScheduleReports.Rows[i]);
                            break;
                        case 5:
                            BindCompletionLagSummaryReport(dtScheduleReports.Rows[i]);
                            break;
                        case 6:
                            BindFreqencyAnalysisReport(dtScheduleReports.Rows[i]);
                            break;
                        case 7:
                            BindWCCauseAnalysisReport(dtScheduleReports.Rows[i]);
                            break;
                        case 8:
                            BindLossLimitationReport(dtScheduleReports.Rows[i]);
                            break;
                        case 9:
                            BindLossStratificationReport(dtScheduleReports.Rows[i]);
                            break;
                        case 10:
                            BindDetailPITReport(dtScheduleReports.Rows[i]);
                            break;
                        case 11:
                            BindTPALagSummaryReport(dtScheduleReports.Rows[i]);
                            break;
                        case 12:
                            BindSummaryPITReport(dtScheduleReports.Rows[i]);
                            break;
                        case 13:
                            BindThreePITSummaryReport(dtScheduleReports.Rows[i]);
                            break;
                        case 14:
                            BindBordereauReport(dtScheduleReports.Rows[i]);
                            break;
                        case 15:
                            BindNotif_BordereauReport(dtScheduleReports.Rows[i]);
                            break;
                        case 16:
                            BindEPLIPendingInvestigationandLitigationSummaryReport(dtScheduleReports.Rows[i]);
                            break;
                        case 17:
                            BindImmediatelyReportableClaims(dtScheduleReports.Rows[i]);
                            break;
                        case 18:
                            BindNetworkCallSummaryReport(dtScheduleReports.Rows[i]);
                            break;
                        case 19:
                            BindWCAllocationDetailReport(dtScheduleReports.Rows[i]);
                            break;
                        case 20:
                            BindWCAllocationSummaryReport(dtScheduleReports.Rows[i]);
                            break;
                        case 21:
                            BindWCAllocationLocationReport(dtScheduleReports.Rows[i]);
                            break;
                        case 22:
                            BindWCAllocationMonthlyDetailReport(dtScheduleReports.Rows[i]);
                            break;
                        case 23:
                            BindWCMonthlyAllocationSummaryReport(dtScheduleReports.Rows[i]);
                            break;
                        case 24:
                            BindPurchaseServiceContractDetailReport(dtScheduleReports.Rows[i]);
                            break;
                        case 25:
                            BindLeaseRentalAgreementDetailReport(dtScheduleReports.Rows[i]);
                            break;
                        case 26:
                            BindPurchaseAssetReport(dtScheduleReports.Rows[i]);
                            break;
                        case 27:
                            BindLeaseDetailReport(dtScheduleReports.Rows[i]);
                            break;
                        case 28:
                            BindRentProjectionsHistoryReport(dtScheduleReports.Rows[i]);
                            break;
                        case 29:
                            BindLeaseTerm(dtScheduleReports.Rows[i]);
                            break;
                        case 30:
                            BindSubspacesByLocation(dtScheduleReports.Rows[i]);
                            break;
                        case 31:
                            BindRentableAreaByExpirationDate(dtScheduleReports.Rows[i]);
                            break;
                        case 32:
                            BindMonthlyExpenseByLocation(dtScheduleReports.Rows[i]);
                            break;
                        case 33:
                            BindLeasesWithSecurityDeposit(dtScheduleReports.Rows[i]);
                            break;
                        case 34:
                            BindLandlordReport(dtScheduleReports.Rows[i]);
                            break;
                        case 35:
                            BindMaintenanceReport(dtScheduleReports.Rows[i]);
                            break;
                        case 36:
                            BindWCAllocationYTDCharge(dtScheduleReports.Rows[i]);
                            break;
                        case 37:
                            BindExposuresPropertyStatementofValue(dtScheduleReports.Rows[i]);
                            break;
                        case 38:
                            BindLeaseReport(dtScheduleReports.Rows[i]);
                            break;
                        case 39:
                            BindMasterDealership(dtScheduleReports.Rows[i]);
                            break;
                        case 40:
                            BindLandlordInfoReport(dtScheduleReports.Rows[i]);
                            break;
                        case 41:
                            BindPolicyInsuranceScheduleReport(dtScheduleReports.Rows[i]);
                            break;
                        case 42:
                            BindExp_ThirdPartyOwnedReport(dtScheduleReports.Rows[i]);
                            break;
                        case 43:
                            BindFacilityInspectionReport(dtScheduleReports.Rows[i]);
                            break;
                        case 44:
                            BindCustomerIncidentSummaryReport(dtScheduleReports.Rows[i]);
                            break;
                        case 45:
                            BindNonCustomerInquirySummaryReport(dtScheduleReports.Rows[i]);
                            break;
                        case 46:
                            BindCustomerIncidentTotalsReport(dtScheduleReports.Rows[i]);
                            break;
                        case 47:
                            BindDashboardReport(DashboardReport.Facility_Inspection, dtScheduleReports.Rows[i], 47);
                            break;
                        case 48:
                            BindDashboardReport(DashboardReport.Incident_Investigation, dtScheduleReports.Rows[i], 48);
                            break;
                        case 49:
                            BindDashboardReport(DashboardReport.Incident_Reduction, dtScheduleReports.Rows[i], 49);
                            break;
                        case 50:
                            BindDashboardReport(DashboardReport.WC_Claim_Management, dtScheduleReports.Rows[i], 50);
                            break;
                        case 51:
                            BindCriticalDatesReport(dtScheduleReports.Rows[i]);
                            break;
                        case 52:
                            BindSubLeaseReport(dtScheduleReports.Rows[i]);
                            break;
                        case 53:
                            BindSonicCauseCodeReclassificationReport(dtScheduleReports.Rows[i]);
                            break;
                        case 54:
                            BindSafetyFirstAwardReport(dtScheduleReports.Rows[i]);
                            break;
                        case 55:
                            BindLandlordNotificationReport(dtScheduleReports.Rows[i]);
                            break;
                        case 56:
                            BindInpectionsByInspector(dtScheduleReports.Rows[i]);
                            break;
                        case 57:
                            BindRiskManagementWorkSheet(dtScheduleReports.Rows[i]);
                            break;
                        case 59:
                            BindInspectionLagTime(dtScheduleReports.Rows[i]);
                            break;
                        case 60:
                            BindAdHocReportWriter(dtScheduleReports.Rows[i]);
                            break;
                        case 62:
                            BindFROIRecapReport(dtScheduleReports.Rows[i]);
                            break;
                        case 63:
                            BindACI_AdHocReportWriter(dtScheduleReports.Rows[i]);
                            break;
                        case 64:
                            BindSafetyTrainingReport(dtScheduleReports.Rows[i]);
                            break;
                        case 65:
                            BindACI_ManagementAdHocReportWriter(dtScheduleReports.Rows[i]);
                            break;
                        case 67:
                            BindConstructionAdHocReport(dtScheduleReports.Rows[i]);
                            break;
                        case 71:
                            BindACIKeyContactReport(dtScheduleReports.Rows[i]);
                            break;
                        case 72:
                            BindVOCEmissionsReport(dtScheduleReports.Rows[i]);
                            break;
                        case 75:
                            BindSafetyTraining_AdHocReportWriter(dtScheduleReports.Rows[i]);
                            break;
                        case 77:
                            BindProperty_AdHocReportWriter(dtScheduleReports.Rows[i]);
                            break;
                        default:
                            break;

                    }
                }
                //Make event log entry on successful completion of sending mail.
                EventLog.WriteEntry("eRIMS_Sonic Scheduled Reports sent successfully on " + dtSchduleDate.ToString());
            }
            catch (Exception ex)
            {
                //write exception to event log
                EventLog.WriteEntry("Error Occurred while sending eRIMS_Sonic Scheduled Reports on " + dtSchduleDate.ToString() + ", " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
        }


        private void BindAdHocReportWriter(DataRow drReportSchedule)
        //private void BindAdHocReportWriter()
        {
            //Commented this section due to errors on 22-9-2014
            //IDataReader Reader = null;
            //try
            //{
            //    decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
            //    decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
            //    decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);
            //    string strReportSchedulerName = Convert.ToString(drReportSchedule["ReportSchedulerName"]);
            //    //decimal pK_Schedule_ID = 6;
            //    //decimal Fk_RecipientList = 2;
            //    //decimal FK_Security_Id = 1;
            //    //string strReportSchedulerName = "test";
            //    //Get Report criteria for the scheduled report
            //    DataSet ds = new DataSet();
            //    ds = Report.SelectFilterCriteria(60, pK_Schedule_ID);
            //    if (ds != null && ds.Tables[0].Rows.Count > 0)
            //    {
            //        DataTable dtFilter = ds.Tables[0];
            //        if (dtFilter.Rows.Count > 0)
            //        {
            //            string strCoverageType = string.Empty, strOutPutFields = string.Empty, strFirstGroupBy = string.Empty, strSecGroupBy = string.Empty;
            //            DateTime? dtPriorValuationDate = null;

            //            if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["PriorValuationDate"])))
            //                dtPriorValuationDate = Convert.ToDateTime(dtFilter.Rows[0]["PriorValuationDate"]);

            //            if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["PriorValuation_RelativeDate"])))
            //            {
            //                // set Relative Date From criteria
            //                AdHocReportHelper.RaltiveDates RelType = (AdHocReportHelper.RaltiveDates)Enum.Parse(typeof(AdHocReportHelper.RaltiveDates), Convert.ToString(dtFilter.Rows[0]["PriorValuation_RelativeDate"]));
            //                dtPriorValuationDate = AdHocReportHelper.GetRelativeDate(RelType);
            //            }

            //            decimal _dcSelectedReport = 0;

            //            List<AdHocFilter> lstFilter = new List<AdHocFilter>();

            //            _dcSelectedReport = Convert.ToDecimal(dtFilter.Rows[0]["Pk_AdHocReport"]);
            //            lstFilter = new ERIMS_DAL.AdHocFilter().GetAdHocReportFieldByPk(_dcSelectedReport);

            //            ERIMS_DAL.AdHocReport ObjAdHocReport = new ERIMS_DAL.AdHocReport(_dcSelectedReport);

            //            strOutPutFields = ObjAdHocReport.OutputFields;
            //            string strFilterIDs = string.Empty;
            //            for (int i = 0; i < lstFilter.Count; i++)
            //            {
            //                AdhocReportFields obj = new AdhocReportFields();
            //                List<AdhocReportFields> lstAdhoc = obj.GetAdHocReportFieldByPk(Convert.ToDecimal(lstFilter[i].FK_AdHocReportFields));
            //                strFilterIDs += lstFilter[i].FK_AdHocReportFields + ",";
            //            }
            //            strFilterIDs = strFilterIDs.TrimEnd(',');

            //            StringBuilder sbRecord = new StringBuilder();
            //            if (dtFilter.Rows.Count > 0)
            //            {
            //                //Get the recipient from the recipient list 
            //                DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];
            //                DataRow drFilterCriteria = dtFilter.Rows[0];
            //                //Get the user who has scheduled the report
            //                DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

            //                String strFirstName, strLastName, strMailFrom;
            //                strFirstName = strLastName = strMailFrom = "";
            //                if (dtUser.Rows.Count > 0)
            //                {
            //                    strFirstName = Convert.ToString(dtUser.Rows[0]["FIRST_NAME"]).Trim();
            //                    strLastName = Convert.ToString(dtUser.Rows[0]["LAST_NAME"]).Trim();
            //                    strMailFrom = Convert.ToString(dtUser.Rows[0]["Email"]).Trim();
            //                }
            //                //Get Records in Reader
            //                Reader = AdHocReportHelper.GetAdHocReport(strOutPutFields, BindGroupBy(ObjAdHocReport), dtPriorValuationDate, GetWhereCondition(lstFilter), BindOrderBy(ObjAdHocReport), strFilterIDs, FK_Security_Id, true);
            //                //Get File path where Records Save.
            //                string strFilePath = BindReport(ref sbRecord, Reader, ObjAdHocReport, lstFilter, strReportSchedulerName);

            //                //If records found
            //                if (File.Exists(strFilePath))
            //                {
            //                    try
            //                    {
            //                        SendMail(strReportSchedulerName, strReportSchedulerName + ".xls", strFirstName, strLastName, strMailFrom, strFilePath, dtRecipients, FK_Security_Id);
            //                        ErrorLog.WriteLog("eRIMS_ACI Scheduled Reports Sent successfully scheduled on " + dtSchduleDate.ToString(), _strFolderPath, false);
            //                    }
            //                    catch (Exception ex)
            //                    {
            //                        ErrorLog.WriteLog("Error Occurred while sending eRIMS_ACI Scheduled Reports on " + dtSchduleDate.ToString() + ", " + ex.Message, _strFolderPath, true);
            //                    }
            //                    finally
            //                    {
            //                        dtRecipients.Dispose();
            //                        dtUser.Dispose();
            //                    }
            //                }
            //            }
            //        }
            //    }
            //}

            //catch (Exception ex)
            //{
            //    ErrorLog.WriteLog("Error Occurred while sending eRIMS_Sonic ACI Scheduled Reports on " + dtSchduleDate.ToString() + ", " + ex.Message, _strFolderPath, true);
            //}
        }

        /// <summary>
        /// get claim type description from the initial claim type
        /// </summary>
        /// <param name="strClaimType"></param>
        /// <returns></returns>
        private String GetClaimTypeDescription(String strClaimType)
        {
            switch (strClaimType.ToUpper())
            {
                case "W":
                    return "Workers Compensation";
                case "A":
                    return "Auto Loss";
                case "P":
                    return "Premises Loss";
                default:
                    return String.Empty;
            }
        }

        /// <summary>
        /// Get the Claim type string to display in filter setting for all claims
        /// </summary>
        /// <param name="strClaimTypes"></param>
        /// <returns></returns>
        private String GetClaimTypeString(String strClaimTypes)
        {
            return strClaimTypes.Replace("W", "Workers Compensation").Replace("A", "Auto Loss").Replace("P", "Premises Loss");
        }

        /// <summary>
        ///  Generates report HTML as a string- Being called from BindDashboardReport
        /// </summary>
        /// <param name="drReportSchedule"></param>
        /// <param name="dtFilter"></param>
        /// <param name="FK_Security_Id"></param>
        /// <param name="objRptDashboard"></param>
        /// <returns></returns>
        private StringBuilder GetDashboardReportText(DataRow drReportSchedule, DataTable dtFilter, decimal FK_Security_Id, DashboardReport objRptDashboard)
        {
            string strRegion = Convert.ToString(dtFilter.Rows[0]["Region"]).Trim();
            string strMarket = null;
            if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Market"])))
            {
                strMarket = Convert.ToString(dtFilter.Rows[0]["Market"]).Trim();
            }
            string strYear = Convert.ToString(dtFilter.Rows[0]["Year"]).Trim();
            string strReportInterval = Convert.ToString(dtFilter.Rows[0]["Report_Interval"]).Trim();

            //Create HTML for the report and write into HTML Write object
            StringBuilder strHTML = new StringBuilder();


            string strReportTitle = "";
            string strGridHeader = "";

            switch (objRptDashboard)
            {
                case DashboardReport.Facility_Inspection:
                    strReportTitle = "EHS Inspection";
                    strGridHeader = strReportTitle.ToUpper();
                    break;
                case DashboardReport.Incident_Investigation:
                    strReportTitle = "Incident Investigation";
                    strGridHeader = strReportTitle.ToUpper();
                    break;
                case DashboardReport.Incident_Reduction:
                    strReportTitle = "Incident Reduction";
                    strGridHeader = strReportTitle.ToUpper();
                    break;
                case DashboardReport.WC_Claim_Management:
                    strReportTitle = "Worker's Compensation Claims Management";
                    strGridHeader = strReportTitle;
                    break;
            }

            #region "Report Title"
            //Retrieve Region's value
            string strRegionString = string.Empty;
            if (string.IsNullOrEmpty(strRegion))
                strRegionString = "All Region";
            else
                strRegionString = strRegion;


            //Retrieve Market Values
            string strMarketString = string.Empty;
            if (string.IsNullOrEmpty(strMarket))
            {
                strMarketString = "All Market";
            }
            else
            {
                string[] strMar = strMarket.Split(Convert.ToChar(","));
                for (int i = 0; i < strMar.Length; i++)
                {
                    strMarketString += Report.SelectMarketInfoById(Convert.ToDecimal(strMar[i].ToString())).Tables[0].Rows[0]["Market"].ToString() + ",";
                }
                strMarketString = strMarketString.TrimEnd(',');
            }

            //Add Report Title and Schedule Date
            strHTML.Append("<table><tr><td colspan='8'>");

            strHTML.Append("<br />");
            strHTML.Append("<b>Report Title : " + strReportTitle + " </b>");
            strHTML.Append("<br /><br />");
            strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
            strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
            strHTML.Append("<br />");
            strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"].ToString());
            strHTML.Append("<br />");
            strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

            //Add Report Filter Criteria 
            strHTML.Append("<br /><br />");
            strHTML.Append("<b>Report Filters </b>");
            strHTML.Append("<br />");
            strHTML.Append("Report Interval   : " + strReportInterval);
            strHTML.Append("<br />");
            strHTML.Append("Year   : " + strYear);
            strHTML.Append("<br />");
            strHTML.Append("Region   : " + strRegionString);
            strHTML.Append("<br />");
            strHTML.Append("Market        : " + strMarketString);
            strHTML.Append("<br /><br />");
            strHTML.Append("</td></tr></table>");

            #endregion

            #region "Report Data"
            //Monthly Report
            DataSet dsReport = null;

            if (objRptDashboard == DashboardReport.Facility_Inspection)
                dsReport = Report.GetFacilityInspectionReport(strRegion, strMarket, Convert.ToInt32(strYear), strReportInterval, FK_Security_Id);
            else if (objRptDashboard == DashboardReport.Incident_Investigation)
                dsReport = Report.GetIncidentInvestigationReport(strRegion, strMarket, Convert.ToInt32(strYear), strReportInterval, FK_Security_Id);
            else if (objRptDashboard == DashboardReport.Incident_Reduction)
                dsReport = Report.GetIncidentReductionReport(strRegion, strMarket, Convert.ToInt32(strYear), strReportInterval, FK_Security_Id);
            else if (objRptDashboard == DashboardReport.WC_Claim_Management)
                dsReport = Report.GetWCClaimManagementReport(strRegion, strMarket, Convert.ToInt32(strYear), strReportInterval, FK_Security_Id);

            if (strReportInterval.ToString() == "Monthly")
            {
                #region " MONTHLY "
                if (dsReport != null && dsReport.Tables.Count > 0 && dsReport.Tables[0].Rows.Count > 0)
                {
                    // get data tables from dataset
                    DataTable dtRegions = dsReport.Tables[0];

                    //strHTML.Append("<table border='1' style='border: black 0.5px solid;border-collapse: collapse;' cellpadding='0' cellspacing='0'  Width='100%px'><tr><td>");

                    strHTML.Append("<table border='1' style='padding-left:4px;font-size:8.5pt;font-family:Tahoma' cellpadding='4' cellspacing='0' Width='1980px'>");//Sub Table
                    strHTML.Append("<tr style='font-weight: bold;font-size:11pt;height:25'>"); //Title
                    strHTML.Append("<td align='left' style='font-size:9pt;' colspan='2'><b>Sonic Automotive</b></td>");
                    strHTML.Append("<td align='center' style='font-size:9pt;' colspan='9' ><b> " + strGridHeader + " - MONTHLY REPORT FOR " + strYear + " </b></td>");
                    strHTML.Append("<td style='font-size:9pt' align='right' colspan='4'>Valuation Date: " + DateTime.Now.ToString("MM/dd/yyy HH:mm tt") + "</td></tr>");

                    strHTML.Append("<tr align='left' border='1' style='border: black 0.5px solid;'>");
                    strHTML.Append("<td  width='180px'><b>REGION</b></td>");
                    strHTML.Append("<td  width='230px'><b>STORE</b></td>");
                    strHTML.Append("<td  width='120px'><b>JANUARY</b></td>");
                    strHTML.Append("<td  width='120px'><b>FEBRUARY</b></td>");
                    strHTML.Append("<td  width='120px'><b>MARCH</b></td>");
                    strHTML.Append("<td  width='120px'><b>APRIL</b></td>");
                    strHTML.Append("<td  width='120px'><b>MAY</b></td>");
                    strHTML.Append("<td  width='120px'><b>JUNE</b></td>");
                    strHTML.Append("<td  width='120px'><b>JULY</b></td>");
                    strHTML.Append("<td  width='120px'><b>AUGUST</b></td>");
                    strHTML.Append("<td  width='120px'><b>SEPTEMBER</b></td>");
                    strHTML.Append("<td  width='120px'><b>OCTOBER</b></td>");
                    strHTML.Append("<td  width='120px'><b>NOVEMBER</b></td>");
                    strHTML.Append("<td  width='120px'><b>DECEMBER</b></td>");
                    strHTML.Append("<td  width='130px'><b>AVERAGE SCORE</b></td>");
                    strHTML.Append("</tr>");
                    for (int intI3 = 0; intI3 < dtRegions.Rows.Count; intI3++)
                    {
                        DataRow drRecords = dtRegions.Rows[intI3];
                        //int intRes;
                        //int intDiv = System.Math.DivRem(intI3, 2, out intRes);
                        //if (intRes == 0)
                        //strHTML.Append("<tr align='left' style='font-size:8pt;background-color:#EAEAEA;font-family:Tahoma;'>");
                        // else
                        strHTML.Append("<tr align='left' style='font-size:8pt;border: black 0.5px solid;' border='1'>");

                        strHTML.Append("<td  align='left' >" + Convert.ToString(drRecords["Region"]) + "</td>");
                        strHTML.Append("<td  align='left'>" + Convert.ToString(drRecords["DBA"]) + "</td>");
                        strHTML.Append("<td  align='left'>" + GetScoreName(drRecords["JANUARY"]) + "</td>");
                        strHTML.Append("<td  align='left'>" + GetScoreName(drRecords["FEBRUARY"]) + "</td>");
                        strHTML.Append("<td  align='left'>" + GetScoreName(drRecords["MARCH"]) + "</td>");
                        strHTML.Append("<td  align='left'>" + GetScoreName(drRecords["APRIL"]) + "</td>");
                        strHTML.Append("<td  align='left'>" + GetScoreName(drRecords["MAY"]) + "</td>");
                        strHTML.Append("<td  align='left'>" + GetScoreName(drRecords["JUNE"]) + "</td>");
                        strHTML.Append("<td  align='left'>" + GetScoreName(drRecords["JULY"]) + "</td>");
                        strHTML.Append("<td  align='left'>" + GetScoreName(drRecords["AUGUST"]) + "</td>");
                        strHTML.Append("<td  align='left'>" + GetScoreName(drRecords["SEPTEMBER"]) + "</td>");
                        strHTML.Append("<td  align='left'>" + GetScoreName(drRecords["OCTOBER"]) + "</td>");
                        strHTML.Append("<td  align='left'>" + GetScoreName(drRecords["NOVEMBER"]) + "</td>");
                        strHTML.Append("<td  align='left'>" + GetScoreName(drRecords["DECEMBER"]) + "</td>");
                        strHTML.Append("<td  align='left'>" + GetScoreName(drRecords["Average"]) + "</td>");
                        strHTML.Append("</tr>");
                    }

                    //strHTML.Append("<tr><td colspan='15' class='cols_'>&nbsp;</td></tr>");
                    strHTML.Append("</table>");
                    //strHTML.Append("</table></td></tr></table>");
                }
                else
                {
                    strHTML.Append("<table style='font-family:Tahoma' cellpadding='4' cellspacing='0' Width='100%'>");
                    strHTML.Append("<tr style='background-color:#F2F2F2;color:Black;'>");
                    strHTML.Append("<td align='center' style='font-size:9pt;'>No Records found.</td></tr></table>");
                }
                #endregion
            }
            else if (strReportInterval.ToString() == "Quarterly")
            {
                #region " QUARTERLY "
                if (dsReport != null && dsReport.Tables.Count > 0 && dsReport.Tables[0].Rows.Count > 0)
                {
                    DataTable dtRegions = dsReport.Tables[0];

                    strHTML.Append("<table border='1' style='border: black 0.5px solid;border-collapse: collapse;' cellpadding='0' cellspacing='0'  Width='100%px'><tr><td>");

                    strHTML.Append("<table border='1' style='padding-left:4px;font-size:8.5pt;font-family:Tahoma' cellpadding='4' cellspacing='0' Width='995px'>");//Sub Table
                    strHTML.Append("<tr style='font-weight: bold;font-size:11pt;height:25'>"); //Title
                    strHTML.Append("<td align='left' style='font-size:9pt;' colspan='1'><b>Sonic Automotive</b></td>");
                    strHTML.Append("<td align='center' style='font-size:9pt;' colspan='3' ><b> " + strGridHeader + " - QUARTERLY REPORT FOR " + strYear + " </b></td>");
                    strHTML.Append("<td style='font-size:9pt' align='right' colspan='3'>Valuation Date: " + DateTime.Now.ToString("MM/dd/yyy HH:mm tt") + "</td></tr>");

                    strHTML.Append("<tr align='left' border='1' style='border: black 0.5px solid;' >");
                    strHTML.Append("<td  width='185px'><b>REGION</b></td>");
                    strHTML.Append("<td  width='220px'><b>STORE</b></td>");
                    strHTML.Append("<td  width='120px'><b>Q1</b></td>");
                    strHTML.Append("<td  width='120px'><b>Q2</b></td>");
                    strHTML.Append("<td  width='120px'><b>Q3</b></td>");
                    strHTML.Append("<td  width='120px'><b>Q4</b></td>");
                    strHTML.Append("<td  width='110px'><b>AVERAGE SCORE</b></td>");
                    strHTML.Append("</tr>");
                    for (int intI3 = 0; intI3 < dtRegions.Rows.Count; intI3++)
                    {
                        DataRow drRecords = dtRegions.Rows[intI3];
                        //int intRes;
                        //int intDiv = System.Math.DivRem(intI3, 2, out intRes);
                        //if (intRes == 0)
                        //    strHTML.Append("<tr align='left' style='font-size:8pt;background-color:#EAEAEA;font-family:Tahoma;'>");
                        //else
                        strHTML.Append("<tr align='left' style='font-size:8pt;border: black 0.5px solid;' border='1'>");

                        strHTML.Append("<td  align='left' >" + Convert.ToString(drRecords["Region"]) + "</td>");
                        strHTML.Append("<td>" + Convert.ToString(drRecords["DBA"]) + "</td>");
                        strHTML.Append("<td align='left'>" + GetScoreName(drRecords["Q1"]) + "</td>");
                        strHTML.Append("<td align='left'>" + GetScoreName(drRecords["Q2"]) + "</td>");
                        strHTML.Append("<td align='left'>" + GetScoreName(drRecords["Q3"]) + "</td>");
                        strHTML.Append("<td align='left'>" + GetScoreName(drRecords["Q4"]) + "</td>");
                        strHTML.Append("<td align='left'>" + GetScoreName(drRecords["Average"]) + "</td>");
                        strHTML.Append("</tr>");
                    }
                    strHTML.Append("</table></td></tr>");
                    strHTML.Append("</table></td></tr></table>");
                }
                else
                {
                    strHTML.Append("<table style='font-family:Tahoma' cellpadding='4' cellspacing='0' Width='100%'>");
                    strHTML.Append("<tr style='background-color:#F2F2F2;color:Black;'>");
                    strHTML.Append("<td align='center' style='font-size:9pt;'>No Records found.</td></tr></table>");
                }
                #endregion
            }
            else if (strReportInterval.ToString() == "Annually")
            {
                #region " ANNUALLY "
                if (dsReport != null && dsReport.Tables.Count > 0 && dsReport.Tables[0].Rows.Count > 0)
                {
                    DataTable dtRegions = dsReport.Tables[0];
                    strHTML.Append("<table border='1' style='border: black 0.5px solid;border-collapse: collapse;' cellpadding='0' cellspacing='0'  Width='100%px'><tr><td>");

                    strHTML.Append("<table border='1' style='padding-left:4px;font-size:8.5pt;font-family:Tahoma' cellpadding='4' cellspacing='0' Width='996px'>");//Sub Table
                    strHTML.Append("<tr style='font-weight: bold;font-size:11pt;height:25'>"); //Title
                    strHTML.Append("<td align='left' style='font-size:9pt;' colspan='1'><b>Sonic Automotive</b></td>");
                    strHTML.Append("<td align='center' style='font-size:9pt;' colspan='4' ><b> " + strGridHeader + " - ANNUAL REPORT FOR " + strYear + " </b></td>");
                    strHTML.Append("<td style='font-size:9pt' align='right' colspan='3'>Valuation Date: " + DateTime.Now.ToString("MM/dd/yyy HH:mm tt") + "</td></tr>");

                    strHTML.Append("<tr align='left' border='1' style='border: black 0.5px solid;'>");
                    strHTML.Append("<td width='180px'><b>REGION</b></td>");
                    strHTML.Append("<td width='230px'><b>STORE</b></td>");
                    strHTML.Append("<td width='120px'><b>" + Convert.ToString(Convert.ToInt32(strYear) - 4) + "</b></td>");
                    strHTML.Append("<td width='120px'><b>" + Convert.ToString(Convert.ToInt32(strYear) - 3) + "</b></td>");
                    strHTML.Append("<td width='120px'><b>" + Convert.ToString(Convert.ToInt32(strYear) - 2) + "</b></td>");
                    strHTML.Append("<td width='120px'><b>" + Convert.ToString(Convert.ToInt32(strYear) - 1) + "</b></td>");
                    strHTML.Append("<td width='120px'><b>" + Convert.ToString(Convert.ToInt32(strYear)) + "</b></td>");
                    strHTML.Append("<td width='110px'><b>AVERAGE SCORE</b></td>");
                    strHTML.Append("</tr>");
                    for (int intI3 = 0; intI3 < dtRegions.Rows.Count; intI3++)
                    {
                        DataRow drRecords = dtRegions.Rows[intI3];
                        //int intRes;
                        //int intDiv = System.Math.DivRem(intI3, 2, out intRes);
                        //if (intRes == 0)
                        //    strHTML.Append("<tr align='left' style='font-size:8pt;background-color:#EAEAEA;font-family:Tahoma;'>");
                        //else
                        strHTML.Append("<tr align='left' style='font-size:8pt;border: black 0.5px solid;' border='1'>");

                        strHTML.Append("<td align='left' >" + Convert.ToString(drRecords["Region"]) + "</td>");
                        strHTML.Append("<td>" + Convert.ToString(drRecords["DBA"]) + "</td>");
                        strHTML.Append("<td align='left'>" + GetScoreName(drRecords["Year1"]) + "</td>");
                        strHTML.Append("<td align='left'>" + GetScoreName(drRecords["Year2"]) + "</td>");
                        strHTML.Append("<td align='left'>" + GetScoreName(drRecords["Year3"]) + "</td>");
                        strHTML.Append("<td align='left'>" + GetScoreName(drRecords["Year4"]) + "</td>");
                        strHTML.Append("<td align='left'>" + GetScoreName(drRecords["Year5"]) + "</td>");
                        strHTML.Append("<td align='left'>" + GetScoreName(drRecords["Average"]) + "</td>");
                        strHTML.Append("</tr>");
                    }
                    // sbRecorords.Append("<tr><td colspan='7' class='cols_'>&nbsp;</td></tr>");
                    strHTML.Append("</table></td></tr>");
                    strHTML.Append("</table></td></tr></table>");
                }
                else
                {
                    strHTML.Append("<table style='font-family:Tahoma' cellpadding='4' cellspacing='0' Width='100%'>");
                    strHTML.Append("<tr style='background-color:#F2F2F2;color:Black;'>");
                    strHTML.Append("<td align='center' style='font-size:9pt;'>No Records found.</td></tr></table>");
                }
                #endregion
            }
            #endregion
            return strHTML;

        }

        /// <summary>
        /// Combines two addresses
        /// </summary>
        /// <param name="objAddress1"></param>
        /// <param name="objAddress2"></param>
        /// <returns></returns>
        public static string FormatAddress(object objAddress1, object objAddress2, object objCity, object objState, object objZipcode)
        {
            string strAddress = string.Empty;
            if (!string.IsNullOrEmpty(Convert.ToString(objAddress1)))
                strAddress = objAddress1.ToString().Trim();
            if (!string.IsNullOrEmpty(Convert.ToString(objAddress2)))
                strAddress = (strAddress != string.Empty) ? string.Concat(strAddress, ",&nbsp;", objAddress2.ToString().Trim()) : objAddress2.ToString().Trim();
            if (!string.IsNullOrEmpty(Convert.ToString(objCity)))
                strAddress = (strAddress != string.Empty) ? string.Concat(strAddress, ",&nbsp;", objCity.ToString().Trim()) : objCity.ToString().Trim();
            if (!string.IsNullOrEmpty(Convert.ToString(objState)))
                strAddress = (strAddress != string.Empty) ? string.Concat(strAddress, ",&nbsp;", objState.ToString().Trim()) : objState.ToString().Trim();
            if (!string.IsNullOrEmpty(Convert.ToString(objZipcode)))
                strAddress = (strAddress != string.Empty) ? string.Concat(strAddress, "&nbsp;", objZipcode.ToString().Trim()) : objZipcode.ToString().Trim();

            return strAddress;
        }
        #endregion

        #region Report Methods

        //Report 1
        private void BindFinancialSummaryReport(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(1, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list 
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = dtUser.Rows[0]["FIRST_NAME"].ToString();
                        strLastName = dtUser.Rows[0]["LAST_NAME"].ToString();
                        strMailFrom = dtUser.Rows[0]["Email"].ToString();

                        //Set all filters to a variable as per report type
                        String strPolicy_Year = dtFilter.Rows[0]["Accident_Year"].ToString();
                        String strClaim_Type = dtFilter.Rows[0]["Claim_Type"].ToString();
                        string strRegion = dtFilter.Rows[0]["Region"].ToString();
                        string strMarket = null;
                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Market"])))
                        {
                            strMarket = Convert.ToString(dtFilter.Rows[0]["Market"]).Trim();
                        }
                        string strValuationDate = Convert.ToDateTime(dtFilter.Rows[0]["Prior_Valuation_Date"]).ToString(DateDisplayFormat);

                        //Get the report data
                        DataSet dsReport = Report.GetFinancialSummaryData(strPolicy_Year, strClaim_Type, strRegion, strMarket, Convert.ToDateTime(strValuationDate));

                        //Create HTML for the report and wirte into HTML Write object
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        #region "Header"

                        //Retrieve Market Values
                        string strMarketString = string.Empty;
                        if (string.IsNullOrEmpty(strMarket))
                        {
                            strMarketString = "All Market";
                        }
                        else
                        {
                            string[] strMar = strMarket.Split(Convert.ToChar(","));
                            for (int i = 0; i < strMar.Length; i++)
                            {
                                strMarketString += Report.SelectMarketInfoById(Convert.ToDecimal(strMar[i].ToString())).Tables[0].Rows[0]["Market"].ToString() + ",";
                            }
                            strMarketString = strMarketString.TrimEnd(',');
                        }

                        //Add Report Title and Schedule Date
                        strHTML.Append("<table><tr><td colspan='6'>");
                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : Financial Summary Report</b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"]).ToString();
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        //Add Report Filter Criteria 
                        strHTML.Append("<br /><br />");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Accident Year : " + strPolicy_Year);
                        strHTML.Append("<br />");
                        strHTML.Append("Claim Types : " + GetClaimTypeString(strClaim_Type));
                        strHTML.Append("<br />");
                        strHTML.Append("Regions : " + strRegion.Replace("'", ""));
                        strHTML.Append("<br />");
                        strHTML.Append("Market : " + strMarketString);
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Prior Valuation Date : " + strValuationDate);
                        strHTML.Append("<br /><br />");
                        strHTML.Append("</td></tr></table>");
                        //Add Header HTML
                        //strHTML.Append("<table width='100%' cellpadding='0' cellspacing='0'><tr><td>");
                        //strHTML.Append("<table width='100%' cellpadding='0' cellspacing='0'><tr><td>");
                        //strHTML.Append("<table width='100%' cellpadding='0' cellspacing='0'><tr><td>");
                        strHTML.Append("<table width='100%' cellpadding='0' cellspacing='0' border='1'><tr style='font-weight: bold;' >");
                        strHTML.Append("<td style='width: 25%;' align='left'>Financial Summary Report</td>");
                        strHTML.Append("<td style='width: 15%;' align='right'>Total Incurred Amount</td>");
                        strHTML.Append("<td style='width: 15%;' align='right'>Total Paid Amount</td>");
                        strHTML.Append("<td style='width: 20%;' align='right'>Total Outstanding Amount</td>");
                        strHTML.Append("<td style='width: 13%;' align='right'>Number Of Claims</td>");
                        strHTML.Append("<td style='width: 12%;' align='right'>Percent<br />Paid/Inc</td>");
                        strHTML.Append("</tr>");
                        //strHTML.Append("</table></td></tr></table>");
                        //strHTML.Append("</td></tr></table>");
                        //strHTML.Append("</td></tr></table>");

                        #endregion
                        // get datatbles from dataset
                        DataTable dtYears = dsReport.Tables[0];
                        DataTable dtDetails = dsReport.Tables[1];
                        DataTable dtRegionTotal = dsReport.Tables[2];
                        DataTable dtGrandTotal = dsReport.Tables[3];

                        if (dtDetails.Rows.Count > 0)
                        {
                            //Add Report Data Table 
                            //strHTML.Append("<table style='width: 100%;' border='1' align='left' cellpadding='4' cellspacing='0'>");

                            #region " Report Data "

                            #region " List Accident Years "

                            foreach (DataRow drYear in dtYears.Rows)
                            {
                                //Add Header for Sub Report (Year wise)
                                strHTML.Append("<tr><td width='100%' align='left' colspan='6'>");
                                strHTML.Append("<span style='color: Chocolate; font-weight: bold;'>Accident Year - " + drYear["AccidentYear"].ToString() + "</span>");
                                strHTML.Append("</td></tr>");
                                //strHTML.Append("<table cellspacing='0' cellpadding='0' align='Left' border='1' style='width: 100%;border-collapse: collapse;'>");
                                DataRow[] drRegions = dtRegionTotal.Select("AccidentYear='" + drYear["AccidentYear"].ToString() + "'");

                                #region " List Regions "
                                foreach (DataRow drRegion in drRegions)
                                {
                                    //strHTML.Append("<tr><td align='left' style='width: 100%;'><table cellpadding='0' cellspacing='0' width='100%'>");
                                    strHTML.Append("<tr><td width='100%' align='left' colspan='6'><b>Region - " + drRegion["Region"].ToString() + "</b></td></tr>");
                                    //strHTML.Append("<tr><td align='Left'><table style='width: 100%;' border='1' align='left' cellpadding='4' cellspacing='0'>");
                                    DataRow[] drDetails = dtDetails.Select("AccidentYear='" + drYear["AccidentYear"].ToString() + "' and Region='" + drRegion["Region"].ToString() + "'");

                                    #region " Print Claim Details "
                                    foreach (DataRow drDetail in drDetails)
                                    {
                                        strHTML.Append("<tr>");
                                        strHTML.Append("<td align='left' style='width: 25%;'>" + drDetail["dba"].ToString() + "</td>");
                                        strHTML.Append("<td align='right' style='width: 15%;'>" + string.Format("{0:C2}", drDetail["Incurred"]) + "</td>");
                                        strHTML.Append("<td align='right' style='width: 15%;'>" + string.Format("{0:C2}", drDetail["Paid"]) + "</td>");
                                        strHTML.Append("<td align='right' style='width: 20%;'>" + string.Format("{0:C2}", drDetail["Outstanding"]) + "</td>");
                                        strHTML.Append("<td align='right' style='width: 13%;'>" + string.Format("{0:N0}", drDetail["ClaimCount"]) + "</td>");
                                        strHTML.Append("<td align='right' style='width: 12%;'>" + string.Format("{0:N2}", drDetail["Percentage"]) + "</td>");
                                        strHTML.Append("</tr>");
                                    }
                                    #endregion

                                    #region " Print Region-wise sub totals "
                                    // print sub totals for region
                                    strHTML.Append("<tr style='color: Black; font-weight: bold;'>");
                                    strHTML.Append("<td align='left'>Sub Totals For Region: </td>");
                                    strHTML.Append("<td align='right'>" + string.Format("{0:C2}", drRegion["Total_Incurred"]) + "</td>");
                                    strHTML.Append("<td align='right'>" + string.Format("{0:C2}", drRegion["Total_Paid"]) + "</td>");
                                    strHTML.Append("<td align='right'>" + string.Format("{0:C2}", drRegion["Total_OutStanding"]) + "</td>");
                                    strHTML.Append("<td align='right'>" + string.Format("{0:N0}", drRegion["Total_Claims"]) + "</td>");
                                    strHTML.Append("<td align='right'>" + string.Format("{0:N2}", drRegion["Total_Percent"]) + "</td>");
                                    strHTML.Append("</tr>");
                                    //strHTML.Append("</table></td></tr></table></td></tr>");
                                    #endregion
                                }
                                #endregion

                                //strHTML.Append("</table></td></tr>");
                            }
                            #endregion

                            #endregion

                            //strHTML.Append("</table>");

                            #region " Print Grand Totals "
                            if (dtGrandTotal.Rows.Count > 0)
                            {
                                DataRow drTotal = dtGrandTotal.Rows[0];
                                //strHTML.Append("<table width='100%' cellpadding='0' cellspacing='0'><tr><td>");
                                //strHTML.Append("<table width='100%' cellpadding='0' cellspacing='0'><tr><td>");
                                //strHTML.Append("<table width='100%' cellpadding='0' cellspacing='0'><tr><td>");
                                //strHTML.Append("<table width='100%' style='font-weight: bold; background-color: #507CD1;color: White;' border='1'><tr>");
                                strHTML.Append("<tr style='background-color:#507CD1;color:white;font-weight:bold'><td style='width: 25%;' align='left'>Totals - </td>");
                                strHTML.Append("<td style='width: 15%;font-weight:bold' align='right'>" + string.Format("{0:C2}", drTotal["Total_Incurred"]) + "</td>");
                                strHTML.Append("<td style='width: 15%;font-weight:bold' align='right'>" + string.Format("{0:C2}", drTotal["Total_Paid"]) + "</td>");
                                strHTML.Append("<td style='width: 20%;font-weight:bold' align='right'>" + string.Format("{0:C2}", drTotal["Total_OutStanding"]) + "</td>");
                                strHTML.Append("<td style='width: 13%;font-weight:bold' align='right'>" + drTotal["Total_Claims"].ToString() + "</td>");
                                strHTML.Append("<td style='width: 12%;font-weight:bold' align='right'>" + string.Format("{0:N2}", drTotal["Total_Percent"]) + "</td>");
                                strHTML.Append("</tr>");
                                //strHTML.Append("</table></td></tr></table>");
                                //strHTML.Append("</td></tr></table>");
                                //strHTML.Append("</td></tr></table>");
                            }
                            #endregion
                            strHTML.Append("</table>");
                        }
                        else
                        {
                            //Add No record found line for year
                            strHTML.Append("<tr><td align='left' colspan='6'>No Record Found!</td></tr>");
                        }
                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        SendMail("Financial Summary Report", "FinancialSummary.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in Financial Summary, " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
        }

        //Report 2
        private void BindFinancialPayTypeSummaryReport(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(2, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list 
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];
                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = dtUser.Rows[0]["FIRST_NAME"].ToString();
                        strLastName = dtUser.Rows[0]["LAST_NAME"].ToString();
                        strMailFrom = dtUser.Rows[0]["Email"].ToString();

                        //Set all filters to a variable as per report type
                        String strPolicy_Year = dtFilter.Rows[0]["Accident_Year"].ToString();
                        string strRegion = dtFilter.Rows[0]["Region"].ToString();
                        string strMarket = null;
                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Market"])))
                        {
                            strMarket = Convert.ToString(dtFilter.Rows[0]["Market"]).Trim();
                        }
                        string strValuationDate = Convert.ToDateTime(dtFilter.Rows[0]["Prior_Valuation_Date"]).ToString(DateDisplayFormat);

                        //Get the report data
                        DataSet dsReport = Report.GetFinancialPayTypeSummaryData(strPolicy_Year, strRegion, strMarket, Convert.ToDateTime(strValuationDate));

                        //Create HTML for the report and wirte into HTML Write object
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        #region " Header "


                        //Retrieve Market Values
                        string strMarketString = string.Empty;
                        if (string.IsNullOrEmpty(strMarket))
                        {
                            strMarketString = "All Market";
                        }
                        else
                        {
                            string[] strMar = strMarket.Split(Convert.ToChar(","));
                            for (int i = 0; i < strMar.Length; i++)
                            {
                                strMarketString += Report.SelectMarketInfoById(Convert.ToDecimal(strMar[i].ToString())).Tables[0].Rows[0]["Market"].ToString() + ",";
                            }
                            strMarketString = strMarketString.TrimEnd(',');
                        }

                        //Add Report Title and Schedule Date
                        strHTML.Append("<table><tr><td colspan='6'>");
                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : Financial Pay Type Summary Report</b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"]).ToString();
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        //Add Report Filter Criteria 
                        strHTML.Append("<br /><br />");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Accident Year : " + strPolicy_Year);
                        strHTML.Append("<br />");
                        strHTML.Append("Regions : " + strRegion.Replace("'", ""));
                        strHTML.Append("<br />");
                        strHTML.Append("Market : " + strMarketString);
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Prior Valuation Date : " + strValuationDate);
                        strHTML.Append("<br /><br />");
                        strHTML.Append("</td></tr></table>");

                        //Add Header HTML
                        strHTML.Append("<table width='100%' cellpadding='0' cellspacing='0'><tr><td>");
                        strHTML.Append("<table width='100%' cellpadding='0' cellspacing='0'><tr><td>");
                        strHTML.Append("<table width='100%' cellpadding='0' cellspacing='0'><tr><td>");
                        strHTML.Append("<table border='0' cellpadding='0' cellspacing='0' width='100%' style='font-weight:bold;' border='1'>");
                        strHTML.Append("<tr><td style='width: 20%'>&nbsp;</td>");
                        strHTML.Append("<td style='width: 16%;' align='right'>Indemnity/PD</td>");
                        strHTML.Append("<td style='width: 16%;' align='right'>Medical/BI</td>");
                        strHTML.Append("<td style='width: 16%;' align='right'>Expense</td>");
                        strHTML.Append("<td style='width: 16%;' align='right'>Total</td>");
                        strHTML.Append("<td style='width: 16%;' align='center'>Claim Count</td></tr>");
                        strHTML.Append("</table>");
                        strHTML.Append("</td></tr></table>");
                        strHTML.Append("</td></tr></table>");
                        strHTML.Append("</td></tr></table>");
                        #endregion

                        // get datatbles from dataset
                        DataTable dtYears = dsReport.Tables[0];
                        DataTable dtDetails = dsReport.Tables[1];
                        DataTable dtRegionTotal = dsReport.Tables[2];
                        DataTable dtGrandTotal = dsReport.Tables[3];

                        if (dtDetails.Rows.Count > 0)
                        {
                            //Add Report Data Table 
                            strHTML.Append("<table style='width: 100%;' border='1' cellpadding='4' cellspacing='0'>");

                            #region " Report Data "

                            #region " List Accident Years "

                            foreach (DataRow drYear in dtYears.Rows)
                            {
                                //Add Header for Sub Report (Year wise)
                                strHTML.Append("<tr><td width='100%' align='left' colspan='6'>");
                                strHTML.Append("<span style='color: Chocolate; font-weight: bold;'>Accident Year - " + drYear["AccidentYear"].ToString() + "</span>");
                                strHTML.Append("</td></tr>");
                                //strHTML.Append("<tr><td align='left'><table cellspacing='0' cellpadding='0' align='Left' border='1' style='width: 100%;border-collapse: collapse;'>");
                                DataRow[] drRegions = dtRegionTotal.Select("AccidentYear='" + drYear["AccidentYear"].ToString() + "'");

                                #region " List Regions "
                                foreach (DataRow drRegion in drRegions)
                                {
                                    //strHTML.Append("<tr><td align='left' style='width: 100%;'><table cellpadding='0' cellspacing='0' width='100%'>");
                                    strHTML.Append("<tr><td width='100%' align='left' colspan='6'><b>Region - " + drRegion["Region"].ToString() + "</b></td></tr>");
                                    //strHTML.Append("<tr><td align='Left'><table style='width: 100%;' border='1' align='left' cellpadding='4' cellspacing='0'>");
                                    DataRow[] drDetails = dtDetails.Select("AccidentYear='" + drYear["AccidentYear"].ToString() + "' and Region='" + drRegion["Region"].ToString() + "'");

                                    #region " Print Claim Details "
                                    foreach (DataRow drDetail in drDetails)
                                    {
                                        strHTML.Append("<tr><td align='left' colspan='6'><b>" + drDetail["ClaimType"].ToString() + "</b></td></tr>");

                                        strHTML.Append("<tr>");
                                        strHTML.Append("<td style='width: 20%' align='left'>Incurred</td>");
                                        strHTML.Append("<td style='width: 16%' align='right'>" + string.Format("{0:C2}", drDetail["Indemnity_Incurred"]) + "</td>");
                                        strHTML.Append("<td style='width: 16%' align='right'>" + string.Format("{0:C2}", drDetail["Medical_Incurred"]) + "</td>");
                                        strHTML.Append("<td style='width: 16%' align='right'>" + string.Format("{0:C2}", drDetail["Expense_Incurred"]) + "</td>");
                                        strHTML.Append("<td style='width: 16%' align='right'>" + string.Format("{0:C2}", drDetail["Total_Incurred"]) + "</td>");
                                        strHTML.Append("<td style='width: 16%' align='center'>" + string.Format("{0:N0}", drDetail["ClaimCount"]) + "</td>");
                                        strHTML.Append("</tr>");

                                        strHTML.Append("<tr>");
                                        strHTML.Append("<td style='width: 20%' align='left'>Paid</td>");
                                        strHTML.Append("<td style='width: 16%' align='right'>" + string.Format("{0:C2}", drDetail["Indemnity_Paid"]) + "</td>");
                                        strHTML.Append("<td style='width: 16%' align='right'>" + string.Format("{0:C2}", drDetail["Medical_Paid"]) + "</td>");
                                        strHTML.Append("<td style='width: 16%' align='right'>" + string.Format("{0:C2}", drDetail["Expense_Paid"]) + "</td>");
                                        strHTML.Append("<td style='width: 16%' align='right'>" + string.Format("{0:C2}", drDetail["Total_Paid"]) + "</td>");
                                        strHTML.Append("<td style='width: 16%' align='center'>&nbsp;</td>");
                                        strHTML.Append("</tr>");

                                        strHTML.Append("<tr>");
                                        strHTML.Append("<td style='width: 20%' align='left'>Outstanding</td>");
                                        strHTML.Append("<td style='width: 16%' align='right'>" + string.Format("{0:C2}", drDetail["Indemnity_Outstanding"]) + "</td>");
                                        strHTML.Append("<td style='width: 16%' align='right'>" + string.Format("{0:C2}", drDetail["Medical_Outstanding"]) + "</td>");
                                        strHTML.Append("<td style='width: 16%' align='right'>" + string.Format("{0:C2}", drDetail["Expense_Outstanding"]) + "</td>");
                                        strHTML.Append("<td style='width: 16%' align='right'>" + string.Format("{0:C2}", drDetail["Total_Outstanding"]) + "</td>");
                                        strHTML.Append("<td style='width: 16%' align='center'>&nbsp;</td>");
                                        strHTML.Append("</tr>");
                                    }
                                    #endregion

                                    #region " Print Region-wise sub totals "
                                    // print sub totals for region
                                    strHTML.Append("<tr style='color: Black; font-weight: bold;'><td align='left' colspan='6'>Sub Total</td></tr>");
                                    strHTML.Append("<tr style='color: Black; font-weight: bold;'>");

                                    strHTML.Append("<td align='left'>Incurred</td>");
                                    strHTML.Append("<td align='right'>" + string.Format("{0:C2}", drRegion["Total_Indemnity_Incurred"]) + "</td>");
                                    strHTML.Append("<td align='right'>" + string.Format("{0:C2}", drRegion["Total_Medical_Incurred"]) + "</td>");
                                    strHTML.Append("<td align='right'>" + string.Format("{0:C2}", drRegion["Total_Expense_Incurred"]) + "</td>");
                                    strHTML.Append("<td align='right'>" + string.Format("{0:C2}", drRegion["Total_Incurred"]) + "</td>");
                                    strHTML.Append("<td align='center'>" + string.Format("{0:N0}", drRegion["Total_Claims"]) + "</td>");
                                    strHTML.Append("</tr>");

                                    strHTML.Append("<tr style='color: Black; font-weight: bold;'>");
                                    strHTML.Append("<td align='left'>Paid</td>");
                                    strHTML.Append("<td align='right'>" + string.Format("{0:C2}", drRegion["Total_Indemnity_Paid"]) + "</td>");
                                    strHTML.Append("<td align='right'>" + string.Format("{0:C2}", drRegion["Total_Medical_Paid"]) + "</td>");
                                    strHTML.Append("<td align='right'>" + string.Format("{0:C2}", drRegion["Total_Expense_Paid"]) + "</td>");
                                    strHTML.Append("<td align='right'>" + string.Format("{0:C2}", drRegion["Total_Paid"]) + "</td>");
                                    strHTML.Append("<td align='center'>&nbsp;</td>");
                                    strHTML.Append("</tr>");
                                    strHTML.Append("<tr style='color: Black; font-weight: bold;'>");
                                    strHTML.Append("<td align='left'>Outstanding</td>");
                                    strHTML.Append("<td align='right'>" + string.Format("{0:C2}", drRegion["Total_Indemnity_OutStanding"]) + "</td>");
                                    strHTML.Append("<td align='right'>" + string.Format("{0:C2}", drRegion["Total_Medical_OutStanding"]) + "</td>");
                                    strHTML.Append("<td align='right'>" + string.Format("{0:C2}", drRegion["Total_Expense_OutStanding"]) + "</td>");
                                    strHTML.Append("<td align='right'>" + string.Format("{0:C2}", drRegion["Total_Outstanding"]) + "</td>");
                                    strHTML.Append("<td align='center'>&nbsp;</td>");
                                    strHTML.Append("</tr>");
                                    //strHTML.Append("</table></td></tr></table></td></tr>");
                                    #endregion
                                }
                                #endregion

                                //strHTML.Append("</table></td></tr>");
                            }
                            #endregion

                            #endregion

                            strHTML.Append("</table>");

                            #region " Print Grand Totals "
                            if (dtGrandTotal.Rows.Count > 0)
                            {
                                DataRow drTotal = dtGrandTotal.Rows[0];
                                strHTML.Append("<table width='100%' cellpadding='0' cellspacing='0'><tr><td>");
                                strHTML.Append("<table width='100%' cellpadding='0' cellspacing='0'><tr><td>");
                                strHTML.Append("<table width='100%' cellpadding='0' cellspacing='0'><tr><td>");
                                strHTML.Append("<table border='0' cellpadding='0' cellspacing='0' style='font-weight: bold; background-color: #507CD1;color: White;' border='1'>");
                                strHTML.Append("<tr><td style='width: 100%' colspan='6'>* Report Grand Total</td></tr>");

                                strHTML.Append("<tr><td style='width: 20%'>Incurred</td>");
                                strHTML.Append("<td style='width: 16%;' align='right'>" + string.Format("{0:C2}", drTotal["Total_Indemnity_Incurred"]) + "</td>");
                                strHTML.Append("<td style='width: 16%;' align='right'>" + string.Format("{0:C2}", drTotal["Total_Medical_Incurred"]) + "</td>");
                                strHTML.Append("<td style='width: 16%;' align='right'>" + string.Format("{0:C2}", drTotal["Total_Expense_Incurred"]) + "</td>");
                                strHTML.Append("<td style='width: 16%;' align='right'>" + string.Format("{0:C2}", drTotal["Total_Incurred"]) + "</td>");
                                strHTML.Append("<td style='width: 16%;' align='center'>" + string.Format("{0:N2}", drTotal["Total_Claims"]) + "</td></tr>");

                                strHTML.Append("<tr>");
                                strHTML.Append("<td align='left'>Paid</td>");
                                strHTML.Append("<td align='right'>" + string.Format("{0:C2}", drTotal["Total_Indemnity_Paid"]) + "</td>");
                                strHTML.Append("<td align='right'>" + string.Format("{0:C2}", drTotal["Total_Medical_Paid"]) + "</td>");
                                strHTML.Append("<td align='right'>" + string.Format("{0:C2}", drTotal["Total_Expense_Paid"]) + "</td>");
                                strHTML.Append("<td align='right'>" + string.Format("{0:C2}", drTotal["Total_Paid"]) + "</td>");
                                strHTML.Append("<td align='center'>&nbsp;</td>");
                                strHTML.Append("</tr>");

                                strHTML.Append("<tr>");
                                strHTML.Append("<td align='left'>Outstanding</td>");
                                strHTML.Append("<td align='right'>" + string.Format("{0:C2}", drTotal["Total_Indemnity_OutStanding"]) + "</td>");
                                strHTML.Append("<td align='right'>" + string.Format("{0:C2}", drTotal["Total_Medical_OutStanding"]) + "</td>");
                                strHTML.Append("<td align='right'>" + string.Format("{0:C2}", drTotal["Total_Expense_OutStanding"]) + "</td>");
                                strHTML.Append("<td align='right'>" + string.Format("{0:C2}", drTotal["Total_Outstanding"]) + "</td>");
                                strHTML.Append("<td align='center'>&nbsp;</td>");
                                strHTML.Append("</tr>");

                                strHTML.Append("</table>");
                                strHTML.Append("</td></tr></table>");
                                strHTML.Append("</td></tr></table>");
                                strHTML.Append("</td></tr></table>");
                            }
                            #endregion
                        }
                        else
                        {
                            //Add No record found line for year
                            strHTML.Append("<tr><td align='left' colspan='6'>No Record Found!</td></tr>");
                        }

                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        isGrid = true;
                        SendMail("Financial Pay Type Summary Report", "FinancialPayTypeSummary.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
                        isGrid = false;
                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in Financial Pay Type Summary, " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
        }

        //Report 3
        private void BindEmployerLagSummaryReport(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(3, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list 
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];
                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = dtUser.Rows[0]["FIRST_NAME"].ToString();
                        strLastName = dtUser.Rows[0]["LAST_NAME"].ToString();
                        strMailFrom = dtUser.Rows[0]["Email"].ToString();

                        //Set all filters to a variable as per report type
                        String strRegions = dtFilter.Rows[0]["Region"].ToString();
                        string strMarket = null;
                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Market"])))
                        {
                            strMarket = Convert.ToString(dtFilter.Rows[0]["Market"]).Trim();
                        }
                        DateTime date_of_loss_from = Convert.ToDateTime(dtFilter.Rows[0]["From_Date_Of_Loss"].ToString());
                        DateTime date_of_loss_to = Convert.ToDateTime(dtFilter.Rows[0]["To_Date_Of_Loss"].ToString());

                        //Get the report data
                        DataSet dsReport = Report.GetEmployerLagSummaryData(date_of_loss_from, date_of_loss_to, strRegions, strMarket);

                        //Create HTML for the report and wirte into HTML Write object
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        #region " Header "

                        //Retrieve Market Values
                        string strMarketString = string.Empty;
                        if (string.IsNullOrEmpty(strMarket))
                        {
                            strMarketString = "All Market";
                        }
                        else
                        {
                            string[] strMar = strMarket.Split(Convert.ToChar(","));
                            for (int i = 0; i < strMar.Length; i++)
                            {
                                strMarketString += Report.SelectMarketInfoById(Convert.ToDecimal(strMar[i].ToString())).Tables[0].Rows[0]["Market"].ToString() + ",";
                            }
                            strMarketString = strMarketString.TrimEnd(',');
                        }

                        //Add Report Title and Schedule Date
                        strHTML.Append("<table><tr><td colspan='5'>");
                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : Reported to Employer Lag Summary Report</b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"]).ToString();
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        //Add Report Filter Criteria 
                        strHTML.Append("<br /><br />");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Regions :" + strRegions.Replace("'", ""));
                        strHTML.Append("<br />");
                        strHTML.Append("Market : " + strMarketString);
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Date Of Loss : From : " + date_of_loss_from.ToString(DateDisplayFormat) + " &nbsp;&nbsp;&nbsp;&nbsp; To : " + date_of_loss_to.ToString(DateDisplayFormat));
                        strHTML.Append("<br /><br />");
                        strHTML.Append("</td></tr></table>");

                        //Add Header HTML
                        strHTML.Append("<table style='font-weight: bold;' cellpadding='0' cellspacing='0' width='100%' border='0'><tr><td>");
                        strHTML.Append("<table style='font-weight: bold;' cellpadding='0' cellspacing='0' width='100%' border='1'>");
                        strHTML.Append("<tr><td style='width: 26%;' align='left'>Lag Period(Days)</td>");
                        strHTML.Append("<td style='width: 14%;' align='center'>No of Claims</td>");
                        strHTML.Append("<td style='width: 14%;' align='center'>Percentage To <br />Total Claim</td>");
                        strHTML.Append("<td style='width: 18%;' align='center'>Total<br/>Incurred Dollars</td>");
                        strHTML.Append("<td style='width: 14%;' align='center'>Percentage To <br />Total Dollars</td></tr></table>");
                        strHTML.Append("</td></tr></table>");

                        #endregion

                        //Get the no of descriptions selected
                        strHTML.Append("<table style='width: 100%;' border='1' cellpadding='4' cellspacing='0'>");
                        // get data tables from dataset
                        DataTable dtRegions = dsReport.Tables[0];
                        DataTable dtDetails = dsReport.Tables[1];
                        DataTable dtRegionTotal = dsReport.Tables[2];
                        DataTable dtGrandTotal = dsReport.Tables[3];
                        int intMedian = Convert.ToInt32(dsReport.Tables[4].Rows[0][0]);
                        if (dtDetails.Rows.Count > 0)
                        {
                            foreach (DataRow drRegion in dtRegionTotal.Rows)
                            {
                                //Add Header for Sub Report (Description wise)
                                strHTML.Append("<tr><td colspan='5' style='font-weight:bold;'>" + drRegion["Region"].ToString() + "</td></tr>");
                                DataRow[] drDetails = dtDetails.Select("Region='" + drRegion["Region"].ToString() + "'");

                                foreach (DataRow drDetail in drDetails)
                                {
                                    //Add Report Data Table 
                                    strHTML.Append("<tr><td align='left' style='width: 26%'>" + drDetail["StartLimit"] + " To " + drDetail["EndLimit"] + "</td>");
                                    strHTML.Append("<td align='right' style='width: 14%'>" + String.Format("{0:N0}", drDetail["ClaimCount"]) + "</td>");
                                    strHTML.Append("<td align='right' style='width: 14%'>" + String.Format("{0:N2}", drDetail["ClaimPercent"]) + "</td>");
                                    strHTML.Append("<td align='right' style='width: 18%'>" + String.Format("{0:C2}", drDetail["Incurred"]) + "</td>");
                                    strHTML.Append("<td align='right' style='width: 14%'>" + String.Format("{0:N2}", drDetail["IncurredPercent"]) + "</td></tr>");
                                }
                                //Add Sub Total (Region wise)
                                strHTML.Append("<tr style='font-weight: bold;background-color: white; color: black;'><td align='left' style='width: 26%;'>Total </td>");
                                strHTML.Append("<td align='right' style='width: 14%'>" + String.Format("{0:N0}", drRegion["TotalClaims"]) + "</td>");
                                strHTML.Append("<td align='right' style='width: 14%'>" + String.Format("{0:N2}", drRegion["TotalClaimPercent"]) + "</td>");
                                strHTML.Append("<td align='right' style='width: 18%'>" + String.Format("{0:C2}", drRegion["TotalIncurred"]) + "</td>");
                                strHTML.Append("<td align='right' style='width: 14%'>" + String.Format("{0:N2}", drRegion["TotalIncurredPercent"]) + "</td></tr>");
                            }
                            strHTML.Append("</table>");

                            #region " Grand Total "
                            if (dtGrandTotal.Rows.Count > 0)
                            {
                                DataRow drTotal = dtGrandTotal.Rows[0];
                                strHTML.Append("<table style='font-weight: bold;' cellpadding='0' cellspacing='0' width='100%' border='0'><tr><td>");
                                strHTML.Append("<table style='font-weight: bold;' cellpadding='0' cellspacing='0' width='100%' border='1' style='font-weight: bold;background-color: #507CD1; color: #FFFFFF;'>");
                                strHTML.Append("<tr><td style='width: 26%;' align='left'>Total</td>");
                                strHTML.Append("<td style='width: 14%;' align='right'>" + String.Format("{0:N0}", drTotal["TotalClaims"]) + "</td>");
                                strHTML.Append("<td style='width: 14%;' align='right'>" + String.Format("{0:N2}", drTotal["TotalClaimPercent"]) + "</td>");
                                strHTML.Append("<td style='width: 18%;' align='right'>" + String.Format("{0:C2}", drTotal["TotalIncurred"]) + "</td>");
                                strHTML.Append("<td style='width: 14%;' align='right'>" + String.Format("{0:N2}", drTotal["TotalIncurredPercent"]) + "</td></tr></table>");
                                strHTML.Append("</td></tr></table>");
                            }
                            #endregion

                            strHTML.Append("<table style='width: 100%;' border='0' align='left' cellpadding='4' cellspacing='0'>");
                            strHTML.Append("<tr><td width='100%' align='left' colspan='5'><b>Median Lag Time in Days : " + intMedian + "</b></td></tr>");
                            strHTML.Append("</table>");
                        }
                        else
                        {
                            //Add No record found line for year
                            strHTML.Append("<tr><td align='left' colspan='5'>No Record Found!</td></tr></table>");
                        }


                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        isGrid = true;
                        SendMail("Reported to Employer Lag Summary Report", "EmployerLagSummaryReport.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
                        isGrid = false;
                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in Lag Summary : 3, " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
        }

        //Report 4
        private void BindInsurerLagSummaryReport(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(4, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list 
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];
                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = dtUser.Rows[0]["FIRST_NAME"].ToString();
                        strLastName = dtUser.Rows[0]["LAST_NAME"].ToString();
                        strMailFrom = dtUser.Rows[0]["Email"].ToString();

                        //Set all filters to a variable as per report type
                        String strRegions = dtFilter.Rows[0]["Region"].ToString();
                        string strMarket = null;
                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Market"])))
                        {
                            strMarket = Convert.ToString(dtFilter.Rows[0]["Market"]).Trim();
                        }
                        DateTime date_of_loss_from = Convert.ToDateTime(dtFilter.Rows[0]["From_Date_Of_Loss"].ToString());
                        DateTime date_of_loss_to = Convert.ToDateTime(dtFilter.Rows[0]["To_Date_Of_Loss"].ToString());

                        //Get the report data
                        DataSet dsReport = Report.GetInsurerLagSummaryData(date_of_loss_from, date_of_loss_to, strRegions, strMarket);

                        //Create HTML for the report and wirte into HTML Write object
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        #region " Header "

                        //Retrieve Market Values
                        string strMarketString = string.Empty;
                        if (string.IsNullOrEmpty(strMarket))
                        {
                            strMarketString = "All Market";
                        }
                        else
                        {
                            string[] strMar = strMarket.Split(Convert.ToChar(","));
                            for (int i = 0; i < strMar.Length; i++)
                            {
                                strMarketString += Report.SelectMarketInfoById(Convert.ToDecimal(strMar[i].ToString())).Tables[0].Rows[0]["Market"].ToString() + ",";
                            }
                            strMarketString = strMarketString.TrimEnd(',');
                        }

                        //Add Report Title and Schedule Date
                        strHTML.Append("<table><tr><td colspan='5'>");
                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : Reported to Insurer Lag Summary Report</b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"]).ToString();
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        //Add Report Filter Criteria 
                        strHTML.Append("<br /><br />");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Regions :" + strRegions.Replace("'", ""));
                        strHTML.Append("<br />");
                        strHTML.Append("Market : " + strMarketString);
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Date Of Loss : From : " + date_of_loss_from.ToString(DateDisplayFormat) + " &nbsp;&nbsp;&nbsp;&nbsp; To : " + date_of_loss_to.ToString(DateDisplayFormat));
                        strHTML.Append("<br /><br />");
                        strHTML.Append("</td></tr></table>");

                        //Add Header HTML
                        strHTML.Append("<table style='font-weight: bold;' cellpadding='0' cellspacing='0' width='100%' border='0'><tr><td>");
                        strHTML.Append("<table style='font-weight: bold;' cellpadding='0' cellspacing='0' width='100%' border='1'>");
                        strHTML.Append("<tr><td style='width: 26%;' align='left'>Lag Period(Days)</td>");
                        strHTML.Append("<td style='width: 14%;' align='center'>No of Claims</td>");
                        strHTML.Append("<td style='width: 14%;' align='center'>Percentage To <br />Total Claim</td>");
                        strHTML.Append("<td style='width: 18%;' align='center'>Total<br/>Incurred Dollars</td>");
                        strHTML.Append("<td style='width: 14%;' align='center'>Percentage To <br />Total Dollars</td></tr></table>");
                        strHTML.Append("</td></tr></table>");

                        #endregion

                        //Get the no of descriptions selected
                        strHTML.Append("<table style='width: 100%;' border='1' cellpadding='4' cellspacing='0'>");
                        // get data tables from dataset
                        DataTable dtRegions = dsReport.Tables[0];
                        DataTable dtDetails = dsReport.Tables[1];
                        DataTable dtRegionTotal = dsReport.Tables[2];
                        DataTable dtGrandTotal = dsReport.Tables[3];
                        int intMedian = Convert.ToInt32(dsReport.Tables[4].Rows[0][0]);
                        if (dtDetails.Rows.Count > 0)
                        {
                            foreach (DataRow drRegion in dtRegionTotal.Rows)
                            {
                                //Add Header for Sub Report (Description wise)
                                strHTML.Append("<tr><td colspan='5' style='font-weight:bold;'>" + drRegion["Region"].ToString() + "</td></tr>");
                                DataRow[] drDetails = dtDetails.Select("Region='" + drRegion["Region"].ToString() + "'");

                                foreach (DataRow drDetail in drDetails)
                                {
                                    //Add Report Data Table 
                                    strHTML.Append("<tr><td align='left' style='width: 26%'>" + drDetail["StartLimit"] + " To " + drDetail["EndLimit"] + "</td>");
                                    strHTML.Append("<td align='right' style='width: 14%'>" + String.Format("{0:N0}", drDetail["ClaimCount"]) + "</td>");
                                    strHTML.Append("<td align='right' style='width: 14%'>" + String.Format("{0:N2}", drDetail["ClaimPercent"]) + "</td>");
                                    strHTML.Append("<td align='right' style='width: 18%'>" + String.Format("{0:C2}", drDetail["Incurred"]) + "</td>");
                                    strHTML.Append("<td align='right' style='width: 14%'>" + String.Format("{0:N2}", drDetail["IncurredPercent"]) + "</td></tr>");
                                }
                                //Add Sub Total (Region wise)
                                strHTML.Append("<tr style='font-weight: bold;background-color: white; color: black;'><td align='left' style='width: 26%;'>Total </td>");
                                strHTML.Append("<td align='right' style='width: 14%'>" + String.Format("{0:N0}", drRegion["TotalClaims"]) + "</td>");
                                strHTML.Append("<td align='right' style='width: 14%'>" + String.Format("{0:N2}", drRegion["TotalClaimPercent"]) + "</td>");
                                strHTML.Append("<td align='right' style='width: 18%'>" + String.Format("{0:C2}", drRegion["TotalIncurred"]) + "</td>");
                                strHTML.Append("<td align='right' style='width: 14%'>" + String.Format("{0:N2}", drRegion["TotalIncurredPercent"]) + "</td></tr>");
                            }
                            strHTML.Append("</table>");
                            #region " Grand Total "
                            if (dtGrandTotal.Rows.Count > 0)
                            {
                                DataRow drTotal = dtGrandTotal.Rows[0];
                                strHTML.Append("<table style='font-weight: bold;' cellpadding='0' cellspacing='0' width='100%' border='0'><tr><td>");
                                strHTML.Append("<table style='font-weight: bold;' cellpadding='0' cellspacing='0' width='100%' border='1' style='font-weight: bold;background-color: #507CD1; color: #FFFFFF;'>");
                                strHTML.Append("<tr><td style='width: 26%;' align='left'>Total</td>");
                                strHTML.Append("<td style='width: 14%;' align='right'>" + String.Format("{0:N0}", drTotal["TotalClaims"]) + "</td>");
                                strHTML.Append("<td style='width: 14%;' align='right'>" + String.Format("{0:N2}", drTotal["TotalClaimPercent"]) + "</td>");
                                strHTML.Append("<td style='width: 18%;' align='right'>" + String.Format("{0:C2}", drTotal["TotalIncurred"]) + "</td>");
                                strHTML.Append("<td style='width: 14%;' align='right'>" + String.Format("{0:N2}", drTotal["TotalIncurredPercent"]) + "</td></tr></table>");
                                strHTML.Append("</td></tr></table>");
                            }
                            #endregion

                            strHTML.Append("<table style='width: 100%;' border='0' align='left' cellpadding='4' cellspacing='0'>");
                            strHTML.Append("<tr><td width='100%' align='left' colspan='5'><b>Median Lag Time in Days : " + intMedian + "</b></td></tr>");
                            strHTML.Append("</table>");
                        }
                        else
                        {
                            //Add No record found line for year
                            strHTML.Append("<tr><td align='left' colspan='5'>No Record Found!</td></tr></table>");
                        }

                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        isGrid = true;
                        SendMail("Reported to Insurer Lag Summary Report", "InsurerLagSummaryReport.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
                        isGrid = false;
                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in Lag Summary : 4, " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
        }

        //Report 5
        private void BindCompletionLagSummaryReport(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(5, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list 
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];
                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = dtUser.Rows[0]["FIRST_NAME"].ToString();
                        strLastName = dtUser.Rows[0]["LAST_NAME"].ToString();
                        strMailFrom = dtUser.Rows[0]["Email"].ToString();

                        //Set all filters to a variable as per report type
                        String strRegions = dtFilter.Rows[0]["Region"].ToString();
                        string strMarket = null;
                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Market"])))
                        {
                            strMarket = Convert.ToString(dtFilter.Rows[0]["Market"]).Trim();
                        }
                        DateTime date_of_loss_from = Convert.ToDateTime(dtFilter.Rows[0]["From_Date_Of_Loss"].ToString());
                        DateTime date_of_loss_to = Convert.ToDateTime(dtFilter.Rows[0]["To_Date_Of_Loss"].ToString());

                        //Get the report data
                        DataSet dsReport = Report.GetCompletionLagSummaryData(date_of_loss_from, date_of_loss_to, strRegions, strMarket);

                        //Create HTML for the report and wirte into HTML Write object
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        #region " Header "

                        //Retrieve Market Values
                        string strMarketString = string.Empty;
                        if (string.IsNullOrEmpty(strMarket))
                        {
                            strMarketString = "All Market";
                        }
                        else
                        {
                            string[] strMar = strMarket.Split(Convert.ToChar(","));
                            for (int i = 0; i < strMar.Length; i++)
                            {
                                strMarketString += Report.SelectMarketInfoById(Convert.ToDecimal(strMar[i].ToString())).Tables[0].Rows[0]["Market"].ToString() + ",";
                            }
                            strMarketString = strMarketString.TrimEnd(',');
                        }

                        //Add Report Title and Schedule Date
                        strHTML.Append("<table><tr><td colspan='5'>");
                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : Reported to Completion Lag Summary Report</b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"]).ToString();
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        //Add Report Filter Criteria 
                        strHTML.Append("<br /><br />");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Regions :" + strRegions.Replace("'", ""));
                        strHTML.Append("<br />");
                        strHTML.Append("Market : " + strMarketString);
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Date Of Loss : From : " + date_of_loss_from.ToString(DateDisplayFormat) + " &nbsp;&nbsp;&nbsp;&nbsp; To : " + date_of_loss_to.ToString(DateDisplayFormat));
                        strHTML.Append("<br /><br />");
                        strHTML.Append("</td></tr></table>");

                        //Add Header HTML
                        strHTML.Append("<table style='font-weight: bold;' cellpadding='0' cellspacing='0' width='100%' border='0'><tr><td>");
                        strHTML.Append("<table style='font-weight: bold;' cellpadding='0' cellspacing='0' width='100%' border='1'>");
                        strHTML.Append("<tr><td style='width: 26%;font-weight: bold;' align='left'>Lag Period(Days)</td>");
                        strHTML.Append("<td style='width: 14%;font-weight: bold;' align='center'>No of Claims</td>");
                        strHTML.Append("<td style='width: 14%;font-weight: bold;' align='center'>Percentage To <br />Total Claim</td>");
                        strHTML.Append("<td style='width: 18%;font-weight: bold;' align='center'>Total<br/>Incurred Dollars</td>");
                        strHTML.Append("<td style='width: 14%;font-weight: bold;' align='center'>Percentage To <br />Total Dollars</td></tr></table>");
                        strHTML.Append("</td></tr></table>");

                        #endregion

                        //Get the no of descriptions selected
                        strHTML.Append("<table style='width: 100%;' border='1' cellpadding='4' cellspacing='0'>");
                        // get data tables from dataset
                        DataTable dtRegions = dsReport.Tables[0];
                        DataTable dtDetails = dsReport.Tables[1];
                        DataTable dtRegionTotal = dsReport.Tables[2];
                        DataTable dtGrandTotal = dsReport.Tables[3];
                        int intMedian = Convert.ToInt32(dsReport.Tables[4].Rows[0][0]);
                        if (dtDetails.Rows.Count > 0)
                        {
                            foreach (DataRow drRegion in dtRegionTotal.Rows)
                            {
                                //Add Header for Sub Report (Description wise)
                                strHTML.Append("<tr><td colspan='5' style='font-weight:bold;border:thin'>" + drRegion["Region"].ToString() + "</td></tr>");
                                DataRow[] drDetails = dtDetails.Select("Region='" + drRegion["Region"].ToString() + "'");

                                foreach (DataRow drDetail in drDetails)
                                {
                                    //Add Report Data Table 
                                    strHTML.Append("<tr><td align='left' style='width: 26%'>" + drDetail["StartLimit"] + " To " + drDetail["EndLimit"] + "</td>");
                                    strHTML.Append("<td align='right' style='width: 14%'>" + String.Format("{0:N0}", drDetail["ClaimCount"]) + "</td>");
                                    strHTML.Append("<td align='right' style='width: 14%'>" + String.Format("{0:N2}", drDetail["ClaimPercent"]) + "</td>");
                                    strHTML.Append("<td align='right' style='width: 18%'>" + String.Format("{0:C2}", drDetail["Incurred"]) + "</td>");
                                    strHTML.Append("<td align='right' style='width: 14%'>" + String.Format("{0:N2}", drDetail["IncurredPercent"]) + "</td></tr>");
                                }
                                //Add Sub Total (Region wise)
                                strHTML.Append("<tr style='font-weight: bold;background-color: white; color: black;'><td align='left' style='width: 26%;'>Total </td>");
                                strHTML.Append("<td align='right' style='width: 14%'>" + String.Format("{0:N0}", drRegion["TotalClaims"]) + "</td>");
                                strHTML.Append("<td align='right' style='width: 14%'>" + String.Format("{0:N2}", drRegion["TotalClaimPercent"]) + "</td>");
                                strHTML.Append("<td align='right' style='width: 18%'>" + String.Format("{0:C2}", drRegion["TotalIncurred"]) + "</td>");
                                strHTML.Append("<td align='right' style='width: 14%'>" + String.Format("{0:N2}", drRegion["TotalIncurredPercent"]) + "</td></tr>");
                            }
                            strHTML.Append("</table>");
                            #region " Grand Total "
                            if (dtGrandTotal.Rows.Count > 0)
                            {
                                DataRow drTotal = dtGrandTotal.Rows[0];
                                strHTML.Append("<table style='font-weight: bold;' cellpadding='0' cellspacing='0' width='100%' border='0'><tr><td>");
                                strHTML.Append("<table style='font-weight: bold;' cellpadding='0' cellspacing='0' width='100%' border='1' style='font-weight: bold;background-color: #507CD1; color: #FFFFFF;'>");
                                strHTML.Append("<tr><td style='width: 26%;' align='left'>Total</td>");
                                strHTML.Append("<td style='width: 14%;' align='right'>" + String.Format("{0:N0}", drTotal["TotalClaims"]) + "</td>");
                                strHTML.Append("<td style='width: 14%;' align='right'>" + String.Format("{0:N2}", drTotal["TotalClaimPercent"]) + "</td>");
                                strHTML.Append("<td style='width: 18%;' align='right'>" + String.Format("{0:C2}", drTotal["TotalIncurred"]) + "</td>");
                                strHTML.Append("<td style='width: 14%;' align='right'>" + String.Format("{0:N2}", drTotal["TotalIncurredPercent"]) + "</td></tr></table>");
                                strHTML.Append("</td></tr></table>");
                            }
                            #endregion

                            strHTML.Append("<table style='width: 100%;' border='0' align='left' cellpadding='4' cellspacing='0'>");
                            strHTML.Append("<tr><td width='100%' align='left' colspan='5'><b>Median Lag Time in Days : " + intMedian + "</b></td></tr>");
                            strHTML.Append("</table>");
                        }
                        else
                        {
                            //Add No record found line for year
                            strHTML.Append("<tr><td align='left' colspan='5'>No Record Found!</td></tr></table>");
                        }

                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        isGrid = true;
                        SendMail("Reported to Completion Lag Summary Report", "CompletionLagSummaryReport.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
                        isGrid = false;
                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in Lag Summary : 5, " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
        }

        //Report 6
        private void BindFreqencyAnalysisReport(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(6, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list 
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];
                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = dtUser.Rows[0]["FIRST_NAME"].ToString();
                        strLastName = dtUser.Rows[0]["LAST_NAME"].ToString();
                        strMailFrom = dtUser.Rows[0]["Email"].ToString();

                        //Set all filters to a variable as per report type
                        String strClaim_Type = dtFilter.Rows[0]["Claim_Type"].ToString();
                        DateTime date_of_loss_from = Convert.ToDateTime(dtFilter.Rows[0]["From_Date_Of_Accident"].ToString());
                        DateTime date_of_loss_to = Convert.ToDateTime(dtFilter.Rows[0]["To_Date_Of_Accident"].ToString());

                        //Get the report data
                        DataSet dsReport = Report.GetFrequencyAnalysisData(date_of_loss_from, date_of_loss_to, strClaim_Type, FK_Security_Id);
                        // get data tables from the dataset
                        DataTable dtDetails = dsReport.Tables[0];
                        DataTable dtRegionTotal = dsReport.Tables[1];
                        DataTable dtGrandTotal = dsReport.Tables[2];

                        #region " Header "

                        //Create HTML for the report and wirte into HTML Write objec    
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        //Add Report Title and Schedule Date
                        strHTML.Append("<table><tr><td colspan='7'>");
                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : Frequency Analysis Report</b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"]).ToString();
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        //Add Report Filter Criteria
                        strHTML.Append("<br /><br />");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Claim Types :" + GetClaimTypeString(strClaim_Type));
                        strHTML.Append("<br />");
                        strHTML.Append("Date Of Accident : From : " + date_of_loss_from.ToString(DateDisplayFormat) + " &nbsp;&nbsp;&nbsp;&nbsp; To :" + date_of_loss_to.ToString(DateDisplayFormat));
                        strHTML.Append("<br /><br />");
                        strHTML.Append("</td></tr></table>");

                        //Add Header HTML
                        //strHTML.Append("<table style='font-weight: bold;' cellpadding='0' cellspacing='0' width='100%' border='0'><tr><td>");
                        strHTML.Append("<table  cellpadding='0' cellspacing='0' width='100%' border='1'>");
                        strHTML.Append("<tr style='font-weight: bold;'><td style='width: 20%;' align='left'>Location</td>");
                        strHTML.Append("<td style='width: 10%;' align='right'>Number of Claims</td>");
                        strHTML.Append("<td style='width: 15%;' align='right'>Percent to Total Claims</td>");
                        strHTML.Append("<td style='width: 15%;' align='right'>Total Incurred Dollars</td>");
                        strHTML.Append("<td style='width: 15%;' align='right'>Percent to Total Dollars</td>");
                        strHTML.Append("<td style='width: 15%;' align='right'>Average Cost Per Claim</td>");
                        strHTML.Append("<td style='width: 10%;' align='right'>Largest Loss</td></tr>");
                        strHTML.Append("</table>");
                        //strHTML.Append("</table></td></tr>");

                        #endregion

                        //Add Report Data Table 
                        strHTML.Append("<table style='width: 100%;' border='1' cellpadding='4' cellspacing='0'>");

                        if (dtDetails.Rows.Count > 0)
                        {
                            foreach (DataRow drRegion in dtRegionTotal.Rows)
                            {
                                //Add Header for Sub Report (Description wise)
                                strHTML.Append("<tr><td colspan='5' style='font-weight:bold;'>Region : " + drRegion["Region"].ToString() + "</td><td colspan='2'></td></tr>");
                                DataRow[] drDetails = dtDetails.Select("Region='" + drRegion["Region"].ToString() + "'");
                                foreach (DataRow drDetail in drDetails)
                                {
                                    strHTML.Append("<tr><td style='width: 20%;' align='left'>" + drDetail["dba"] + "</td>");
                                    strHTML.Append("<td style='width: 10%;' align='right'>" + drDetail["ClaimCount"] + "</td>");
                                    strHTML.Append("<td style='width: 15%;' align='right'>" + String.Format("{0:N2}", drDetail["ClaimPercent"]) + "</td>");
                                    strHTML.Append("<td style='width: 15%;' align='right'>" + String.Format("{0:C2}", drDetail["Incurred"]) + "</td>");
                                    strHTML.Append("<td style='width: 15%;' align='right'>" + String.Format("{0:N2}", drDetail["IncurredPercent"]) + "</td>");
                                    strHTML.Append("<td style='width: 15%;' align='right'>" + String.Format("{0:C2}", drDetail["AvgCostPerClaim"]) + "</td>");
                                    strHTML.Append("<td style='width: 10%;' align='right'>" + String.Format("{0:C2}", drDetail["Largest_Loss"]) + "</td></tr>");
                                }
                                //Add Sub Total (Region wise)
                                strHTML.Append("<tr style='font-weight: bold;background-color: white; color: black;'><td style='width: 20%;' align='left'>Totals</td>");
                                strHTML.Append("<td style='width: 10%;' align='right'>" + String.Format("{0:N0}", drRegion["Total_ClaimCount"]) + "</td>");
                                strHTML.Append("<td style='width: 15%;' align='right'></td>");
                                strHTML.Append("<td style='width: 15%;' align='right'>" + String.Format("{0:C2}", drRegion["Total_Incurred"]) + "</td>");
                                strHTML.Append("<td style='width: 15%;' align='right'></td>");
                                strHTML.Append("<td style='width: 15%;' align='right'>" + String.Format("{0:C2}", drRegion["Total_AvgCostPerClaim"]) + "</td>");
                                strHTML.Append("<td style='width: 10%;' align='right'></td></tr>");
                            }
                            #region " Grand Total "
                            if (dtGrandTotal.Rows.Count > 0)
                            {
                                DataRow drTotal = dtGrandTotal.Rows[0];
                                //strHTML.Append("<table style='font-weight: bold;' cellpadding='0' cellspacing='0' width='100%' border='0'><tr><td>");
                                //strHTML.Append("<table style='font-weight: bold;' cellpadding='0' cellspacing='0' width='100%' border='1' style='font-weight: bold;background-color: #507CD1; color: #FFFFFF;'>");
                                strHTML.Append("<tr style='font-weight: bold;' border='1' style='font-weight: bold;background-color: #507CD1; color: #FFFFFF;'><td style='width: 20%;' align='left'>Report Grand Totals</td>");
                                strHTML.Append("<td style='width: 10%;' align='right'>" + String.Format("{0:N0}", drTotal["Total_ClaimCount"]) + "</td>");
                                strHTML.Append("<td style='width: 15%;' align='right'></td>");
                                strHTML.Append("<td style='width: 15%;' align='right'>" + String.Format("{0:C2}", drTotal["Total_Incurred"]) + "</td>");
                                strHTML.Append("<td style='width: 15%;' align='right'></td>");
                                strHTML.Append("<td style='width: 15%;' align='right'>" + String.Format("{0:C2}", drTotal["Total_AvgCostPerClaim"]) + "</td>");
                                strHTML.Append("<td style='width: 10%;' align='right'></td></tr>");
                                //strHTML.Append("</td></tr></table>");
                            }
                            #endregion
                        }
                        else
                        {
                            //Add No record found line for year
                            strHTML.Append("<tr><td colspan='7'>No Record Found!</td></tr>");
                        }

                        strHTML.Append("</table>");

                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        SendMail("Frequency Analysis Report", "FrequencyAnalysis.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in Frequency Severity Report, " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
        }

        //Report 7
        private void BindWCCauseAnalysisReport(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(7, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list 
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];
                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = dtUser.Rows[0]["FIRST_NAME"].ToString();
                        strLastName = dtUser.Rows[0]["LAST_NAME"].ToString();
                        strMailFrom = dtUser.Rows[0]["Email"].ToString();

                        //Set all filters to a variable as per report type
                        DateTime date_of_loss_from = Convert.ToDateTime(dtFilter.Rows[0]["From_Date_Of_Accident"].ToString());
                        DateTime date_of_loss_to = Convert.ToDateTime(dtFilter.Rows[0]["To_Date_Of_Accident"].ToString());

                        //Get the report data
                        DataSet dsReport = Report.GetWCCauseAnalysisData(date_of_loss_from, date_of_loss_to, FK_Security_Id);
                        // get data tables from the dataset
                        DataTable dtDetails = dsReport.Tables[0];
                        DataTable dtRegionTotal = dsReport.Tables[1];
                        DataTable dtGrandTotal = dsReport.Tables[2];

                        #region " Header "

                        //Create HTML for the report and wirte into HTML Write objec    
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        //Add Report Title and Schedule Date
                        strHTML.Append("<table><tr><td colspan='7'>");
                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : WC Cause Analysis Report</b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"]).ToString();
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        //Add Report Filter Criteria
                        strHTML.Append("<br /><br />");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("<br />");
                        strHTML.Append("Date Of Accident : From : " + date_of_loss_from.ToString(DateDisplayFormat) + " &nbsp;&nbsp;&nbsp;&nbsp; To :" + date_of_loss_to.ToString(DateDisplayFormat));
                        strHTML.Append("<br /><br />");
                        strHTML.Append("</td></tr></table>");

                        //Add Header HTML
                        strHTML.Append("<table style='font-weight: bold;' cellpadding='0' cellspacing='0' width='100%' border='0'><tr><td>");
                        strHTML.Append("<table style='font-weight: bold;' cellpadding='0' cellspacing='0' width='100%' border='1'>");
                        strHTML.Append("<tr><td style='width: 20%;' align='left'>Cause of Claim</td>");
                        strHTML.Append("<td style='width: 10%;' align='right'>Number of Claims</td>");
                        strHTML.Append("<td style='width: 15%;' align='right'>Percent to Total Claims</td>");
                        strHTML.Append("<td style='width: 15%;' align='right'>Total Incurred Dollars</td>");
                        strHTML.Append("<td style='width: 15%;' align='right'>Percent to Total Dollars</td>");
                        strHTML.Append("<td style='width: 15%;' align='right'>Average Cost Per Claim</td>");
                        strHTML.Append("<td style='width: 10%;' align='right'>Largest Loss</td></tr></table>");
                        strHTML.Append("</td></tr></table>");

                        #endregion

                        //Add Report Data Table 
                        strHTML.Append("<table style='width: 100%;' border='1' cellpadding='4' cellspacing='0'>");

                        if (dtDetails.Rows.Count > 0)
                        {
                            foreach (DataRow drRegion in dtRegionTotal.Rows)
                            {
                                //Add Header for Sub Report (Description wise)
                                strHTML.Append("<tr><td colspan='5' style='font-weight:bold;'>Region : " + drRegion["Region"].ToString() + "</td><td colspan='2'></td></tr>");
                                DataRow[] drDetails = dtDetails.Select("Region='" + drRegion["Region"].ToString() + "'");
                                foreach (DataRow drDetail in drDetails)
                                {
                                    strHTML.Append("<tr><td style='width: 20%;' align='left'>" + drDetail["Description"] + "</td>");
                                    strHTML.Append("<td style='width: 10%;' align='right'>" + String.Format("{0:N0}", drDetail["ClaimCount"]) + "</td>");
                                    strHTML.Append("<td style='width: 15%;' align='right'>" + String.Format("{0:N2}", drDetail["ClaimPercent"]) + "</td>");
                                    strHTML.Append("<td style='width: 15%;' align='right'>" + String.Format("{0:C2}", drDetail["Incurred"]) + "</td>");
                                    strHTML.Append("<td style='width: 15%;' align='right'>" + String.Format("{0:N2}", drDetail["IncurredPercent"]) + "</td>");
                                    strHTML.Append("<td style='width: 15%;' align='right'>" + String.Format("{0:C2}", drDetail["AvgCostPerClaim"]) + "</td>");
                                    strHTML.Append("<td style='width: 10%;' align='right'>" + String.Format("{0:C2}", drDetail["Largest_Loss"]) + "</td></tr>");
                                }
                                //Add Sub Total (Region wise)
                                strHTML.Append("<tr style='font-weight: bold;background-color: white; color: black;'><td style='width: 20%;' align='left'>Totals</td>");
                                strHTML.Append("<td style='width: 10%;' align='right'>" + String.Format("{0:N0}", drRegion["Total_ClaimCount"]) + "</td>");
                                strHTML.Append("<td style='width: 15%;' align='right'></td>");
                                strHTML.Append("<td style='width: 15%;' align='right'>" + String.Format("{0:C2}", drRegion["Total_Incurred"]) + "</td>");
                                strHTML.Append("<td style='width: 15%;' align='right'></td>");
                                strHTML.Append("<td style='width: 15%;' align='right'>" + String.Format("{0:C2}", drRegion["Total_AvgCostPerClaim"]) + "</td>");
                                strHTML.Append("<td style='width: 10%;' align='right'></td></tr>");
                            }
                            #region " Grand Total "
                            if (dtGrandTotal.Rows.Count > 0)
                            {
                                DataRow drTotal = dtGrandTotal.Rows[0];
                                strHTML.Append("<table style='font-weight: bold;' cellpadding='0' cellspacing='0' width='100%' border='0'><tr><td>");
                                strHTML.Append("<table style='font-weight: bold;' cellpadding='0' cellspacing='0' width='100%' border='1' style='font-weight: bold;background-color: #507CD1; color: #FFFFFF;'>");
                                strHTML.Append("<tr><td style='width: 20%;' align='left'>Report Grand Totals</td>");
                                strHTML.Append("<td style='width: 10%;' align='right'>" + String.Format("{0:N0}", drTotal["Total_ClaimCount"]) + "</td>");
                                strHTML.Append("<td style='width: 15%;' align='right'></td>");
                                strHTML.Append("<td style='width: 15%;' align='right'>" + String.Format("{0:C2}", drTotal["Total_Incurred"]) + "</td>");
                                strHTML.Append("<td style='width: 15%;' align='right'></td>");
                                strHTML.Append("<td style='width: 15%;' align='right'>" + String.Format("{0:C2}", drTotal["Total_AvgCostPerClaim"]) + "</td>");
                                strHTML.Append("<td style='width: 10%;' align='right'></td></tr>");
                                strHTML.Append("</td></tr></table>");
                            }
                            #endregion
                        }
                        else
                        {
                            //Add No record found line for year
                            strHTML.Append("<tr><td colspan='7'>No Record Found!</td></tr>");
                        }
                        strHTML.Append("</table>");

                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        isGrid = true;
                        SendMail("WC Cause Analysis Report", "WCCauseAnalysis.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
                        isGrid = false;
                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in Frequency Severity Report, " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
        }

        //Report 8
        private void BindLossLimitationReport(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(8, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];
                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = dtUser.Rows[0]["FIRST_NAME"].ToString();
                        strLastName = dtUser.Rows[0]["LAST_NAME"].ToString();
                        strMailFrom = dtUser.Rows[0]["Email"].ToString();

                        //Set all filters to a variable as per report type
                        String strClaim_Type = dtFilter.Rows[0]["Claim_Type"].ToString();

                        //Get the report data
                        DataSet dsReport = Report.GetLossLimitationData(Convert.ToDateTime(dtFilter.Rows[0]["From_Date_Of_Loss1"]), Convert.ToDateTime(dtFilter.Rows[0]["To_Date_Of_Loss1"]), Convert.ToDecimal(dtFilter.Rows[0]["limit1"])
                            , dtFilter.Rows[0]["From_Date_Of_Loss2"] == DBNull.Value ? Convert.ToDateTime(System.Data.SqlTypes.SqlDateTime.MaxValue.ToString()) : Convert.ToDateTime(dtFilter.Rows[0]["From_Date_Of_Loss2"]), dtFilter.Rows[0]["To_Date_Of_Loss2"] == DBNull.Value ? Convert.ToDateTime(System.Data.SqlTypes.SqlDateTime.MinValue.ToString()) : Convert.ToDateTime(dtFilter.Rows[0]["To_Date_Of_Loss2"]), dtFilter.Rows[0]["limit2"] == DBNull.Value ? 0 : Convert.ToDecimal(dtFilter.Rows[0]["limit2"])
                            , dtFilter.Rows[0]["From_Date_Of_Loss3"] == DBNull.Value ? Convert.ToDateTime(System.Data.SqlTypes.SqlDateTime.MaxValue.ToString()) : Convert.ToDateTime(dtFilter.Rows[0]["From_Date_Of_Loss3"]), dtFilter.Rows[0]["To_Date_Of_Loss3"] == DBNull.Value ? Convert.ToDateTime(System.Data.SqlTypes.SqlDateTime.MinValue.ToString()) : Convert.ToDateTime(dtFilter.Rows[0]["To_Date_Of_Loss3"]), dtFilter.Rows[0]["limit3"] == DBNull.Value ? 0 : Convert.ToDecimal(dtFilter.Rows[0]["limit3"])
                            , strClaim_Type, FK_Security_Id);

                        // get data tables from the dataset
                        DataTable dtRegions = dsReport.Tables[0];
                        DataTable dtDetails = dsReport.Tables[1];
                        DataTable dtRegionTotal = dsReport.Tables[2];
                        DataTable dtGrandTotal = dsReport.Tables[3];

                        //Create HTML for the report and wirte into HTML Write object
                        Int32 rangeCount = 1;
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        #region " Header "

                        //Add Report Title and Schedule Date
                        strHTML.Append("<table><tr><td colspan='5'>");
                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : Loss Limitation Report</b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"]).ToString();
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        //Add Report Filter Criteria 
                        strHTML.Append("<br /><br />");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Claim Types :" + GetClaimTypeString(strClaim_Type));
                        strHTML.Append("<br />");

                        strHTML.Append("Accident Date Range " + rangeCount.ToString() + " : From : " + Convert.ToDateTime(dtFilter.Rows[0]["From_Date_Of_Loss1"]).ToString(DateDisplayFormat) + " &nbsp;&nbsp;&nbsp;&nbsp; TO : " + Convert.ToDateTime(dtFilter.Rows[0]["To_Date_Of_Loss1"]).ToString(DateDisplayFormat) + " &nbsp;&nbsp;&nbsp;&nbsp; Limit : " + String.Format("{0:f}", dtFilter.Rows[0]["limit1"]));
                        if (Convert.ToDateTime(dtFilter.Rows[0]["From_Date_Of_Loss2"]) != Convert.ToDateTime(System.Data.SqlTypes.SqlDateTime.MinValue.ToString()))
                        {
                            rangeCount++;
                            strHTML.Append("<br />Accident Date Range " + rangeCount.ToString() + " : From : " + Convert.ToDateTime(dtFilter.Rows[0]["From_Date_Of_Loss2"]).ToString(DateDisplayFormat) + " &nbsp;&nbsp;&nbsp;&nbsp; TO : " + Convert.ToDateTime(dtFilter.Rows[0]["To_Date_Of_Loss2"]).ToString(DateDisplayFormat) + "  &nbsp;&nbsp;&nbsp;&nbsp; Limit : " + String.Format("{0:f}", dtFilter.Rows[0]["limit2"]));
                        }
                        if (Convert.ToDateTime(dtFilter.Rows[0]["From_Date_Of_Loss3"]) != Convert.ToDateTime(System.Data.SqlTypes.SqlDateTime.MinValue.ToString()))
                        {
                            rangeCount++;
                            strHTML.Append("<br />Accident Date Range " + rangeCount.ToString() + " : From : " + Convert.ToDateTime(dtFilter.Rows[0]["From_Date_Of_Loss3"]).ToString(DateDisplayFormat) + " &nbsp;&nbsp;&nbsp;&nbsp; TO : " + Convert.ToDateTime(dtFilter.Rows[0]["To_Date_Of_Loss3"]).ToString(DateDisplayFormat) + " &nbsp;&nbsp;&nbsp;&nbsp; Limit : " + String.Format("{0:f}", dtFilter.Rows[0]["limit3"]));
                        }
                        strHTML.Append("<br /><br />");
                        strHTML.Append("</td></tr></table>");

                        //Add Header HTML
                        strHTML.Append("<table style='font-weight: bold;' cellpadding='0' cellspacing='0' width='100%' border='0'><tr><td>");
                        strHTML.Append("<table style='font-weight: bold;' cellpadding='0' cellspacing='0' width='100%' border='1'>");
                        strHTML.Append("<tr><td style='width: 30%;' align='left'>Location</td>");
                        strHTML.Append("<td style='width: 15%;' align='right'>Claim Count</td>");
                        strHTML.Append("<td style='width: 20%;' align='right'>Total Incurred Dollars</td>");
                        strHTML.Append("<td style='width: 20%;' align='right'>Limited Incurred</td>");
                        strHTML.Append("<td style='width: 15%;' align='right'>Excess</td></tr></table>");
                        strHTML.Append("</td></tr></table>");

                        #endregion

                        //Add Report Data Table 
                        strHTML.Append("<table style='width: 100%;' border='1' cellpadding='4' cellspacing='0'>");

                        if (dtDetails.Rows.Count > 0)
                        {
                            foreach (DataRow drRegion in dtRegionTotal.Rows)
                            {
                                //Add Header for Sub Report (Description wise)
                                strHTML.Append("<tr><td colspan='5' style='font-weight:bold;'>" + drRegion["Region"].ToString() + "</td></tr>");
                                DataRow[] drDetails = dtDetails.Select("Region='" + drRegion["Region"].ToString() + "'");
                                foreach (DataRow drDetail in drDetails)
                                {
                                    strHTML.Append("<tr><td style='width: 30%;' align='left'>" + drDetail["dba"] + "</td>");
                                    strHTML.Append("<td style='width: 15%;' align='right'>" + String.Format("{0:N0}", drDetail["ClaimCount"]) + "</td>");
                                    strHTML.Append("<td style='width: 20%;' align='right'>" + String.Format("{0:C2}", drDetail["TotalIncurred"]) + "</td>");
                                    strHTML.Append("<td style='width: 20%;' align='right'>" + String.Format("{0:C2}", drDetail["LimitedIncurred"]) + "</td>");
                                    strHTML.Append("<td style='width: 15%;' align='right'>" + String.Format("{0:C2}", drDetail["Excess"]) + "</td></tr>");
                                }
                                //Add Sub Total (Region wise)
                                strHTML.Append("<tr style='font-weight: bold;background-color: white; color: black;'><td style='width: 30%;' align='left'>Sub Totals</td>");
                                strHTML.Append("<td style='width: 15%;' align='right'>" + String.Format("{0:N0}", drRegion["TotalClaimCount"]) + "</td>");
                                strHTML.Append("<td style='width: 20%;' align='right'>" + String.Format("{0:C2}", drRegion["TotalIncurred"]) + "</td>");
                                strHTML.Append("<td style='width: 20%;' align='right'>" + String.Format("{0:C2}", drRegion["TotalLimitedIncurred"]) + "</td>");
                                strHTML.Append("<td style='width: 15%;' align='right'>" + String.Format("{0:C2}", drRegion["TotalExcess"]) + "</td></tr>");
                            }
                            #region " Grand Total "
                            if (dtGrandTotal.Rows.Count > 0)
                            {
                                DataRow drTotal = dtGrandTotal.Rows[0];
                                strHTML.Append("<table style='font-weight: bold;' cellpadding='0' cellspacing='0' width='100%' border='0'><tr><td>");
                                strHTML.Append("<table cellpadding='0' cellspacing='0' width='100%' border='1' style='font-weight: bold;background-color: #507CD1; color: #FFFFFF;'>");
                                strHTML.Append("<tr><td style='width: 20%;' align='left'>Report Grand Total</td>");
                                strHTML.Append("<td style='width: 15%;' align='right'>" + String.Format("{0:N0}", drTotal["TotalClaimCount"]) + "</td>");
                                strHTML.Append("<td style='width: 20%;' align='right'>" + String.Format("{0:C2}", drTotal["TotalIncurred"]) + "</td>");
                                strHTML.Append("<td style='width: 20%;' align='right'>" + String.Format("{0:C2}", drTotal["TotalLimitedIncurred"]) + "</td>");
                                strHTML.Append("<td style='width: 15%;' align='right'>" + String.Format("{0:C2}", drTotal["TotalExcess"]) + "</td></tr></table>");
                                strHTML.Append("</td></tr></table>");
                            }
                            #endregion
                        }
                        else
                        {
                            //Add No record found line for year
                            strHTML.Append("<tr><td colspan='5'>No Record Found!</td></tr>");
                        }
                        strHTML.Append("</table>");

                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        isGrid = true;
                        SendMail("Loss Limitation Report", "LossLimitation.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
                        isGrid = false;
                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in Loss Limitation Report, " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
        }

        //Report 9
        private void BindLossStratificationReport(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(9, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list 
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];
                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = dtUser.Rows[0]["FIRST_NAME"].ToString();
                        strLastName = dtUser.Rows[0]["LAST_NAME"].ToString();
                        strMailFrom = dtUser.Rows[0]["Email"].ToString();

                        //Set all filters to a variable as per report type
                        String strPolicy_Year = dtFilter.Rows[0]["Policy_Year"].ToString();
                        String strClaim_Type = dtFilter.Rows[0]["Claim_Type"].ToString();

                        //Get the report data
                        DataSet dsReport = Report.GetLossStratificationData(strPolicy_Year, strClaim_Type, FK_Security_Id);
                        // get data tables from dataset
                        DataTable dtClaimTotals = dsReport.Tables[0];
                        DataTable dtDetails = dsReport.Tables[1];
                        DataTable dtYearTotals = dsReport.Tables[2];
                        // used for calculating grand totals
                        double _dblGrandClaimCount, _dblGrandIncurredCount;
                        _dblGrandClaimCount = 0.0; _dblGrandIncurredCount = 0.0;
                        if (dtYearTotals.Rows.Count > 0)
                        {
                            _dblGrandClaimCount = Convert.ToDouble(dtYearTotals.Compute("SUM(ClaimCount)", ""));
                            _dblGrandIncurredCount = Convert.ToDouble(dtYearTotals.Compute("SUM(TotalIncurred)", ""));
                        }
                        //Create HTML for the report and wirte into HTML Write object
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        #region " Header "
                        //Add Report Title and Schedule Date
                        strHTML.Append("<table><tr><td colspan='5'>");
                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : Loss Stratification Report</b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"]).ToString();
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        //Add Report Filter Criteria 
                        strHTML.Append("<br /><br />");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Accident Year :" + strPolicy_Year);
                        strHTML.Append("<br />");
                        strHTML.Append("Claim Types :" + GetClaimTypeString(strClaim_Type));
                        strHTML.Append("<br /><br />");
                        strHTML.Append("</td></tr></table>");

                        //Add Header HTML
                        strHTML.Append("<table width='100%' cellpadding='0' cellspacing='0'><tr><td>");
                        strHTML.Append("<table width='100%' cellpadding='0' cellspacing='0'><tr><td>");
                        strHTML.Append("<table width='100%' cellpadding='0' cellspacing='0'><tr><td>");
                        strHTML.Append("<table width='100%' cellpadding='0' cellspacing='0' style='font-weight: bold;' border='1'><tr>");
                        strHTML.Append("<td align='center' style='width: 50%;' valign='middle'>Claim Size (in $)</td>");
                        strHTML.Append("<td align='center'>Number Of Claims</td>");
                        strHTML.Append("<td style='width: 12%' align='center'>Percent To<br />Total Claim</td>");
                        strHTML.Append("<td style='width: 16%' align='center'>Total<br />Incurred Dollars</td>");
                        strHTML.Append("<td style='width: 10%' align='center'>Percent To<br />Total Dollar</td>");
                        strHTML.Append("</tr></table>");
                        strHTML.Append("</td></tr></table>");
                        strHTML.Append("</td></tr></table>");
                        strHTML.Append("</td></tr></table>");

                        #endregion

                        strHTML.Append("<table style='width: 100%;' border='1' cellpadding='4' cellspacing='0'>");
                        if (dtYearTotals.Rows.Count > 0)
                        {
                            #region " List Accident Years "
                            foreach (DataRow drYear in dtYearTotals.Rows)
                            {
                                //Add Header for Sub Report (Year wise)
                                strHTML.Append("<tr><td><table border='1'>");
                                strHTML.Append("<tr><td width='100%' align='left' colspan='5' style='border:thin'>");
                                strHTML.Append("<span style='color: Chocolate; font-weight: bold;'>Year - " + drYear["AccidentYear"].ToString() + "</span>");
                                strHTML.Append("</td></tr>");
                                strHTML.Append("</table></td></tr>");
                                strHTML.Append("<tr><td align='left'>");
                                strHTML.Append("<table cellspacing='0' cellpadding='0' border='1' style='width: 100%;border:thin;border-collapse: collapse;'>");
                                DataRow[] drClaimTotals = dtClaimTotals.Select("AccidentYear='" + drYear["AccidentYear"].ToString() + "'");
                                #region " List Claim Types for Accident Year "

                                foreach (DataRow drClaimTotal in drClaimTotals)
                                {
                                    strHTML.Append("<tr><td align='left' style='width: 100%;' colspan='5'><table cellpadding='0' cellspacing='0' width='100%'>");
                                    strHTML.Append("<tr><td width='100%' align='left' colspan='5'><b>Claim Type - " + drClaimTotal["Claim_Type"].ToString() + "</b></td></tr>");
                                    strHTML.Append("<tr><td align='Left'><table style='width: 100%;' border='1' cellpadding='4' cellspacing='0'>");
                                    DataRow[] drDetails = dtDetails.Select("AccidentYear='" + drYear["AccidentYear"].ToString() + "' and Claim_Type = '" + drClaimTotal["Claim_Type"].ToString() + "'");

                                    if (drDetails.Length > 0)
                                    {
                                        #region " Print Details "
                                        foreach (DataRow drDetail in drDetails)
                                        {
                                            string strClaimSize = "";
                                            if (Convert.ToDecimal(drDetail["EndLimit"]) <= 0.01m) strClaimSize = "Less than 0.01";
                                            else if (Convert.ToDecimal(drDetail["StartLimit"]) >= 500000.01m) strClaimSize = "Greater than " + (string.Format("{0:0,0.00}", 500000.00m));
                                            else strClaimSize = string.Format("{0:0,0.00}", drDetail["StartLimit"]) + " To " + string.Format("{0:0,0.00}", drDetail["EndLimit"]);

                                            strHTML.Append("<tr>");
                                            strHTML.Append("<td style='width: 50%;' valign='middle'>" + strClaimSize + "</td>");
                                            strHTML.Append("<td align='right'>" + String.Format("{0:N0}", drDetail["ClaimCount"]) + "</td>");
                                            strHTML.Append("<td align='right' style='width: 12%'>" + String.Format("{0:N2}", drDetail["ClaimPercent"]) + "</td>");
                                            strHTML.Append("<td style='width: 16%' align='right'>" + String.Format("{0:C2}", drDetail["Incurred"]) + "</td>");
                                            strHTML.Append("<td align='right' style='width: 10%'>" + String.Format("{0:N2}", drDetail["IncurredPercent"]) + "</td>");
                                            strHTML.Append("</tr>");
                                        }
                                        #endregion
                                        strHTML.Append("</table></td></tr></table></td></tr>");
                                        #region " Print Claim-wise sub totals "
                                        DataRow[] drTotals = dtClaimTotals.Select("AccidentYear='" + drYear["AccidentYear"].ToString() + "' and Claim_Type = '" + drClaimTotal["Claim_Type"].ToString() + "'");
                                        DataRow drTotal = drTotals[0];

                                        // print sub totals for Accident Year
                                        strHTML.Append("<tr><td><table>");
                                        strHTML.Append("<tr style='color: Black; font-weight: bold;'>");
                                        strHTML.Append("<td align='left' style='width: 50%;'>Total Claim Type : " + drTotal["Claim_Type"].ToString() + "</td>");
                                        strHTML.Append("<td align='right' >" + String.Format("{0:N0}", drTotal["ClaimCount"]) + "</td>");
                                        strHTML.Append("<td align='right' style='width: 12%;'>100.00</td>");
                                        strHTML.Append("<td align='right' style='width: 16%;'>" + string.Format("{0:C2}", drTotal["TotalIncurred"]) + "</td>");
                                        strHTML.Append("<td align='right' style='width: 10%'>100.00</td>");
                                        strHTML.Append("</tr></table></td>");
                                        strHTML.Append("</tr>");
                                        #endregion
                                    }
                                    else
                                    {
                                        strHTML.Append("<tr><td align='left' colspan='5'>No Record Found!</td></tr></table></td></tr></table></td></tr>");
                                    }
                                }

                                #region " Print Year-wise totals "
                                double _dblGrandClaimPercent = (_dblGrandClaimCount != 0) ? System.Math.Round(Convert.ToDouble(drYear["ClaimCount"]) * 100 / _dblGrandClaimCount, 2) : 0.00;
                                double _dblGrandIncurredPercent = (_dblGrandIncurredCount != 0) ? System.Math.Round(Convert.ToDouble(drYear["TotalIncurred"]) * 100 / _dblGrandIncurredCount, 2) : 0.00;
                                // print sub totals for Accident Year
                                strHTML.Append("<tr style='color: Black; font-weight: bold;'>");
                                strHTML.Append("<td align='left'  style='width: 50%;'>Total Accident Year : " + drYear["AccidentYear"].ToString() + "</td>");
                                strHTML.Append("<td align='right'>" + String.Format("{0:N0}", drYear["ClaimCount"]) + "</td>");
                                strHTML.Append("<td align='right' style='width: 12%;'>" + string.Format("{0:0.00}", _dblGrandClaimPercent) + "</td>");
                                strHTML.Append("<td align='right' style='width: 16%;'>" + string.Format("{0:C2}", drYear["TotalIncurred"]) + "</td>");
                                strHTML.Append("<td align='right' style='width: 10%'>" + string.Format("{0:0.00}", _dblGrandIncurredPercent) + "</td>");
                                strHTML.Append("</tr></table></td></tr>");
                                #endregion

                                #endregion

                            }
                            strHTML.Append("</table>");
                            #endregion
                            #region " Print Grand Totals "
                            if (dtYearTotals.Rows.Count > 0)
                            {
                                strHTML.Append("<table width='100%' cellpadding='0' cellspacing='0'><tr><td>");
                                strHTML.Append("<table width='100%' cellpadding='0' cellspacing='0'><tr><td>");
                                strHTML.Append("<table width='100%' cellpadding='0' cellspacing='0'><tr><td>");
                                strHTML.Append("<table width='100%' style='font-weight: bold; background-color: #507CD1;color: White;' border='1'><tr>");
                                strHTML.Append("<td align='left' style='width: 50%;' valign='middle'>Report Grand Total</td>");
                                strHTML.Append("<td align='right'>" + String.Format("{0:N0}", _dblGrandClaimCount) + "</td>");
                                strHTML.Append("<td align='right' style='width: 12%'>100.00</td>");
                                strHTML.Append("<td style='width: 16%' align='right'>" + String.Format("{0:C2}", _dblGrandIncurredCount) + "</td>");
                                strHTML.Append("<td align='right' style='width: 10%'>100.00</td>");
                                strHTML.Append("</tr></table>");
                                strHTML.Append("</td></tr></table>");
                                strHTML.Append("</td></tr></table>");
                                strHTML.Append("</td></tr></table>");
                            }
                            #endregion
                        }
                        else
                        {
                            //Add No record found line for year
                            strHTML.Append("<tr><td align='left' style='border:thin' colspan='5'>No Record Found!</td></tr></table>");
                        }


                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        SendMail("Loss Stratification Report", "LossStratification.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in Loss Stratification Report, " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
        }

        //Report 10
        private void BindDetailPITReport(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(10, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list 
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];
                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = dtUser.Rows[0]["FIRST_NAME"].ToString();
                        strLastName = dtUser.Rows[0]["LAST_NAME"].ToString();
                        strMailFrom = dtUser.Rows[0]["Email"].ToString();

                        //Set all filters to a variable as per report type
                        String strClaim_Type = dtFilter.Rows[0]["Claim_Type"].ToString();
                        DateTime date_of_loss_from = Convert.ToDateTime(dtFilter.Rows[0]["From_Date_Of_Loss"]);
                        DateTime date_of_loss_to = Convert.ToDateTime(dtFilter.Rows[0]["To_Date_Of_Loss"]);
                        DateTime date_of_compare_first = Convert.ToDateTime(dtFilter.Rows[0]["Compare_First_Date"]);
                        DateTime date_of_compare_second = Convert.ToDateTime(dtFilter.Rows[0]["Compare_Second_Date"]);

                        //Get the report data
                        DataSet dsReport = Report.GetPointInTimeDetailData(date_of_compare_first, date_of_compare_second, date_of_loss_from, date_of_loss_to, strClaim_Type, FK_Security_Id);

                        //Create HTML for the report and wirte into HTML Write object
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        #region " Header "

                        //Add Report Title and Schedule Date
                        strHTML.Append("<table><tr><td colspan='6'>");

                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : Point-in-Time Detail Report</b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"]).ToString();
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        //Add Report Filter Criteria
                        strHTML.Append("<br /><br />");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Comparison Dates :  First : " + date_of_compare_first.ToString(DateDisplayFormat) + " &nbsp;&nbsp;&nbsp;&nbsp;  Second : " + date_of_compare_second.ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Accident Date : From : " + date_of_loss_from.ToString(DateDisplayFormat) + " &nbsp;&nbsp;&nbsp;&nbsp; To : " + date_of_loss_to.ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Claim Types :" + GetClaimTypeString(strClaim_Type));
                        strHTML.Append("<br /><br />");
                        strHTML.Append("</td></tr></table>");

                        //Add Header HTML
                        strHTML.Append("<table style='font-weight: bold;' cellpadding='0' cellspacing='0' width='100%' border='1'>");
                        strHTML.Append("<tr valign='bottom'>");
                        strHTML.Append("<td align='left'>Claim Number/Name</td>");
                        strHTML.Append("<td align='left'>Accident Date</td>");
                        strHTML.Append("<td>&nbsp;</td>");
                        strHTML.Append("<td align='right'>" + date_of_compare_first.ToString(DateDisplayFormat) + " <br /> Total Dollars</td>");
                        strHTML.Append("<td align='right'>" + date_of_compare_second.ToString(DateDisplayFormat) + " <br /> Total Dollars</td>");
                        strHTML.Append("<td align='right'>Difference</td>");
                        strHTML.Append("</tr></table>");

                        #endregion

                        //Add Report Data
                        strHTML.Append("<table style='width: 100%;' border='1' cellpadding='4' cellspacing='0'>");
                        DataTable dtReport = dsReport.Tables[0];
                        if (dtReport.Rows.Count > 0)
                        {
                            for (int i = 0; i < dtReport.Rows.Count; i++)
                            {
                                strHTML.Append("<tr><td valign='top'><span style='text-decoration: underline;'>" + dtReport.Rows[i]["origin_claim_number"].ToString() + "</span><br>" + dtReport.Rows[i]["Name"].ToString() + "</td>");
                                strHTML.Append("<td style='width: 70px;' valign='middle'>" + Convert.ToDateTime(dtReport.Rows[i]["Date_Of_Accident"]).ToString(DateDisplayFormat) + "</td>");
                                strHTML.Append("<td style='width: 90px;' align='right'>Incurred:<br>Paid:<br>Outstandings:<br></td>");
                                strHTML.Append("<td style='width: 100px;' align='right'>" + String.Format("{0:C2}", dtReport.Rows[i]["Incurred_1"]) + "<br>" + String.Format("{0:C2}", dtReport.Rows[i]["Paid_1"]) + "<br>" + String.Format("{0:C2}", dtReport.Rows[i]["Outstanding_1"]) + "<br></td>");
                                strHTML.Append("<td style='width: 100px;' align='right'>" + String.Format("{0:C2}", dtReport.Rows[i]["Incurred_2"]) + "<br>" + String.Format("{0:C2}", dtReport.Rows[i]["Paid_2"]) + "<br>" + String.Format("{0:C2}", dtReport.Rows[i]["Outstanding_2"]) + "<br></td>");
                                strHTML.Append("<td style='width: 100px;' align='right'>" + String.Format("{0:C2}", dtReport.Rows[i]["Diff_Inc"]) + "<br>" + String.Format("{0:C2}", dtReport.Rows[i]["Diff_Paid"]) + "<br>" + String.Format("{0:C2}", dtReport.Rows[i]["Diff_Out"]) + "<br></td>");
                                strHTML.Append("</tr>");
                            }
                        }
                        else
                        {
                            //Add No record found line for year
                            strHTML.Append("<tr><td>No Record Found!</td></tr>");
                        }
                        strHTML.Append("</table>");

                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        SendMail("Point-in-Time Detail Report", "PITDetailReport.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in Details Point In time Report, " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
        }

        //Report 11
        private void BindTPALagSummaryReport(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(11, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list 
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];
                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = dtUser.Rows[0]["FIRST_NAME"].ToString();
                        strLastName = dtUser.Rows[0]["LAST_NAME"].ToString();
                        strMailFrom = dtUser.Rows[0]["Email"].ToString();

                        //Set all filters to a variable as per report type
                        String strRegions = dtFilter.Rows[0]["Region"].ToString();
                        string strMarket = null;
                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Market"])))
                        {
                            strMarket = Convert.ToString(dtFilter.Rows[0]["Market"]).Trim();
                        }
                        DateTime date_of_loss_from = Convert.ToDateTime(dtFilter.Rows[0]["From_Date_Of_Loss"].ToString());
                        DateTime date_of_loss_to = Convert.ToDateTime(dtFilter.Rows[0]["To_Date_Of_Loss"].ToString());

                        //Get the report data
                        DataSet dsReport = Report.GetTPALagSummaryData(date_of_loss_from, date_of_loss_to, strRegions, strMarket);

                        //Create HTML for the report and wirte into HTML Write object
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        #region " Header "

                        //Retrieve Market Values
                        string strMarketString = string.Empty;
                        if (string.IsNullOrEmpty(strMarket))
                        {
                            strMarketString = "All Market";
                        }
                        else
                        {
                            string[] strMar = strMarket.Split(Convert.ToChar(","));
                            for (int i = 0; i < strMar.Length; i++)
                            {
                                strMarketString += Report.SelectMarketInfoById(Convert.ToDecimal(strMar[i].ToString())).Tables[0].Rows[0]["Market"].ToString() + ",";
                            }
                            strMarketString = strMarketString.TrimEnd(',');
                        }

                        //Add Report Title and Schedule Date
                        strHTML.Append("<table><tr><td colspan='5'>");

                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : Reported to TPA Lag Summary Report</b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"]).ToString();
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        //Add Report Filter Criteria 
                        strHTML.Append("<br /><br />");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Regions :" + strRegions.Replace("'", ""));
                        strHTML.Append("<br />");
                        strHTML.Append("Market : " + strMarketString);
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Date Of Loss : From : " + date_of_loss_from.ToString(DateDisplayFormat) + " &nbsp;&nbsp;&nbsp;&nbsp; To : " + date_of_loss_to.ToString(DateDisplayFormat));
                        strHTML.Append("<br /><br />");
                        strHTML.Append("</td></tr></table>");

                        //Add Header HTML
                        strHTML.Append("<table style='font-weight: bold;' cellpadding='0' cellspacing='0' width='100%' border='0'><tr><td>");
                        strHTML.Append("<table style='font-weight: bold;' cellpadding='0' cellspacing='0' width='100%' border='1'>");
                        strHTML.Append("<tr><td style='width: 26%;' align='left'>Lag Period(Days)</td>");
                        strHTML.Append("<td style='width: 14%;' align='center'>No of Claims</td>");
                        strHTML.Append("<td style='width: 14%;' align='center'>Percentage To <br />Total Claim</td>");
                        strHTML.Append("<td style='width: 18%;' align='center'>Total<br/>Incurred Dollars</td>");
                        strHTML.Append("<td style='width: 14%;' align='center'>Percentage To <br />Total Dollars</td></tr></table>");
                        strHTML.Append("</td></tr></table>");

                        #endregion

                        //Get the no of descriptions selected
                        strHTML.Append("<table style='width: 100%;' border='1' cellpadding='4' cellspacing='0'>");
                        // get data tables from dataset
                        DataTable dtRegions = dsReport.Tables[0];
                        DataTable dtDetails = dsReport.Tables[1];
                        DataTable dtRegionTotal = dsReport.Tables[2];
                        DataTable dtGrandTotal = dsReport.Tables[3];
                        int intMedian = Convert.ToInt32(dsReport.Tables[4].Rows[0][0]);

                        if (dtDetails.Rows.Count > 0)
                        {
                            foreach (DataRow drRegion in dtRegionTotal.Rows)
                            {
                                //Add Header for Sub Report (Description wise)
                                strHTML.Append("<tr><td colspan='5' style='font-weight:bold;border:thin'>" + drRegion["Region"].ToString() + "</td></tr>");
                                DataRow[] drDetails = dtDetails.Select("Region='" + drRegion["Region"].ToString() + "'");

                                foreach (DataRow drDetail in drDetails)
                                {
                                    //Add Report Data Table 
                                    strHTML.Append("<tr><td align='left' style='width: 26%'>" + drDetail["StartLimit"] + " To " + drDetail["EndLimit"] + "</td>");
                                    strHTML.Append("<td align='right' style='width: 14%'>" + String.Format("{0:N0}", drDetail["ClaimCount"]) + "</td>");
                                    strHTML.Append("<td align='right' style='width: 14%'>" + String.Format("{0:N2}", drDetail["ClaimPercent"]) + "</td>");
                                    strHTML.Append("<td align='right' style='width: 18%'>" + String.Format("{0:C2}", drDetail["Incurred"]) + "</td>");
                                    strHTML.Append("<td align='right' style='width: 14%'>" + String.Format("{0:N2}", drDetail["IncurredPercent"]) + "</td></tr>");
                                }
                                //Add Sub Total (Region wise)
                                strHTML.Append("<tr style='font-weight: bold;background-color: white; color: black;'><td align='left' style='width: 26%;'>Total </td>");
                                strHTML.Append("<td align='right' style='width: 14%'>" + String.Format("{0:N0}", drRegion["TotalClaims"]) + "</td>");
                                strHTML.Append("<td align='right' style='width: 14%'>" + String.Format("{0:N2}", drRegion["TotalClaimPercent"]) + "</td>");
                                strHTML.Append("<td align='right' style='width: 18%'>" + String.Format("{0:C2}", drRegion["TotalIncurred"]) + "</td>");
                                strHTML.Append("<td align='right' style='width: 14%'>" + String.Format("{0:N2}", drRegion["TotalIncurredPercent"]) + "</td></tr>");
                            }

                            strHTML.Append("</table>");
                            #region " Grand Total "
                            if (dtGrandTotal.Rows.Count > 0)
                            {
                                DataRow drTotal = dtGrandTotal.Rows[0];
                                strHTML.Append("<table style='font-weight: bold;' cellpadding='0' cellspacing='0' width='100%' border='0'><tr><td>");
                                strHTML.Append("<table style='font-weight: bold;' cellpadding='0' cellspacing='0' width='100%' border='1' style='font-weight: bold;background-color: #507CD1; color: #FFFFFF;'>");
                                strHTML.Append("<tr><td style='width: 26%;' align='left'>Total</td>");
                                strHTML.Append("<td style='width: 14%;' align='right'>" + String.Format("{0:N0}", drTotal["TotalClaims"]) + "</td>");
                                strHTML.Append("<td style='width: 14%;' align='right'>" + String.Format("{0:N2}", drTotal["TotalClaimPercent"]) + "</td>");
                                strHTML.Append("<td style='width: 18%;' align='right'>" + String.Format("{0:C2}", drTotal["TotalIncurred"]) + "</td>");
                                strHTML.Append("<td style='width: 14%;' align='right'>" + String.Format("{0:N2}", drTotal["TotalIncurredPercent"]) + "</td></tr></table>");
                                strHTML.Append("</td></tr></table>");
                            }
                            #endregion

                            strHTML.Append("<table style='width: 100%;' border='0' align='left' cellpadding='4' cellspacing='0'>");
                            strHTML.Append("<tr><td width='100%' align='left' colspan='5'><b>Median Lag Time in Days : " + intMedian + "</b></td></tr>");
                            strHTML.Append("</table>");
                        }
                        else
                        {
                            //Add No record found line for year
                            strHTML.Append("<tr><td align='left' colspan='5'>No Record Found!</td></tr></table>");
                        }


                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        isGrid = true;
                        SendMail("Reported to TPA Lag Summary Report", "TPALagSummaryReport.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
                        isGrid = false;
                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in Lag Summary : 11, " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
        }

        //Report 12
        private void BindSummaryPITReport(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(12, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list 
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = dtUser.Rows[0]["FIRST_NAME"].ToString();
                        strLastName = dtUser.Rows[0]["LAST_NAME"].ToString();
                        strMailFrom = dtUser.Rows[0]["Email"].ToString();

                        //Set all filters to a variable as per report type
                        String strClaim_Type = dtFilter.Rows[0]["Claim_Type"].ToString();
                        String strPolicy_Year = dtFilter.Rows[0]["Policy_Year"].ToString();
                        DateTime date_of_compare_first = Convert.ToDateTime(dtFilter.Rows[0]["Compare_First_Date"]);
                        DateTime date_of_compare_second = Convert.ToDateTime(dtFilter.Rows[0]["Compare_Second_Date"]);

                        //Get the report data
                        DataSet dsReport = Report.GetPointInTimeSummaryData(date_of_compare_first, date_of_compare_second, strPolicy_Year, strClaim_Type, FK_Security_Id);

                        //Create HTML for the report and wirte into HTML Write object
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        #region " Header "
                        //Add Report Title and Schedule Date
                        strHTML.Append("<table><tr><td colspan='6'>");
                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : Point-in-Time Summary Report</b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"]).ToString();
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        //Add Report Filter Criteria
                        strHTML.Append("<br /><br />");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Comparison Dates :  First : " + date_of_compare_first.ToString(DateDisplayFormat) + " &nbsp;&nbsp;&nbsp;&nbsp; Second : " + date_of_compare_second.ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Accident Year :" + strPolicy_Year.Trim(new char[] { ',', '|', ' ' }));
                        strHTML.Append("<br />");
                        strHTML.Append("Claim Type :" + GetClaimTypeString(strClaim_Type));
                        strHTML.Append("<br /><br />");
                        strHTML.Append("</td></tr></table>");

                        //Add Header HTML
                        strHTML.Append("<table style='font-weight: bold;' cellpadding='0' cellspacing='0' width='100%' border='1'><tr><td>");
                        strHTML.Append("<table style='font-weight: bold;' cellpadding='0' cellspacing='0' width='100%' border='1'>");
                        strHTML.Append("<tr align='right' valign='bottom'>");
                        strHTML.Append("<td align='left'>Claim Type</td>");
                        strHTML.Append("<td>&nbsp;</td>");
                        strHTML.Append("<td>" + date_of_compare_first.ToString(DateDisplayFormat) + " <br> Total Dollars</td>");
                        strHTML.Append("<td>" + date_of_compare_second.ToString(DateDisplayFormat) + " <br> Total Dollars</td>");
                        strHTML.Append("<td>Difference</td>");
                        strHTML.Append("<td>Claim Count</td></tr>");
                        strHTML.Append("</table>");
                        strHTML.Append("</td></tr></table>");

                        #endregion

                        DataTable dtYears = dsReport.Tables[0];
                        DataTable dtDetails = dsReport.Tables[1];
                        DataTable dtYearTotals = dsReport.Tables[2];
                        DataTable dtGrandTotals = dsReport.Tables[3];

                        strHTML.Append("<table style='width: 100%;' border='1' cellpadding='4' cellspacing='0'>");

                        foreach (DataRow drYear in dtYears.Rows)
                        {
                            //Add Header for Sub Report (Year wise)
                            strHTML.Append("<tr><td><table><tr><td style='font-weight:bold;border:thin' colspan='6'>Accident Year - " + drYear["AccidentYear"].ToString() + "</td></tr></table><td></tr><tr><td align='left'>");
                            DataRow[] drDetails = dtDetails.Select("AccidentYear = '" + drYear["AccidentYear"].ToString() + "'");


                            foreach (DataRow drDetail in drDetails)
                            {
                                #region " Print details data "
                                strHTML.Append("<table border='1' cellpadding='0' cellspacing='0' style='width: 100%;border-collapse: collapse;'>");
                                strHTML.Append("<tr><td colspan='6'>Claim Type - " + drDetail["ClaimType"].ToString() + "</td></tr>");
                                strHTML.Append("<tr><td></td>");
                                strHTML.Append("<td width='150px' align='right'>Incurred :</td>");
                                strHTML.Append("<td width='120px' align='right'>" + String.Format("{0:C2}", drDetail["Incurred_1"]) + "</td>");
                                strHTML.Append("<td width='120px' align='right'>" + String.Format("{0:C2}", drDetail["Incurred_2"]) + "</td>");
                                strHTML.Append("<td width='120px' align='right'>" + String.Format("{0:C2}", drDetail["Incurred_D"]) + "</td>");
                                strHTML.Append("<td width='120px' align='center'>" + String.Format("{0:N0}", drDetail["ClaimCount"]) + "</td></tr>");
                                strHTML.Append("<tr><td>&nbsp;</td>");
                                strHTML.Append("<td align='right'>Paid :</td>");
                                strHTML.Append("<td align='right'>" + String.Format("{0:C2}", drDetail["Paid_1"]) + "</td>");
                                strHTML.Append("<td align='right'>" + String.Format("{0:C2}", drDetail["Paid_2"]) + "</td>");
                                strHTML.Append("<td align='right'>" + String.Format("{0:C2}", drDetail["Paid_D"]) + "</td>");
                                strHTML.Append("<td align='center'></td></tr>");
                                strHTML.Append("<tr><td>&nbsp;</td>");
                                strHTML.Append("<td align='right'>Outstandings :</td>");
                                strHTML.Append("<td align='right'>" + String.Format("{0:C2}", drDetail["OutStanding_1"]) + "</td>");
                                strHTML.Append("<td align='right'>" + String.Format("{0:C2}", drDetail["OutStanding_2"]) + "</td>");
                                strHTML.Append("<td align='right'>" + String.Format("{0:C2}", drDetail["Out_D"]) + "</td>");
                                strHTML.Append("<td align='center'></td></tr></table>");
                                #endregion
                            }
                            if (drDetails.Length > 0)
                            {
                                #region "Add Sub Total (Year wise)"
                                DataRow[] drYearTotal = dtYearTotals.Select("AccidentYear = '" + drYear["AccidentYear"].ToString() + "'");

                                strHTML.Append("<table border='1' cellpadding='0' cellspacing='0' style='width: 100%;font-weight:bold;'>");
                                strHTML.Append("<tr><td colspan='6'>Sub Totals for Accident Year : " + drYearTotal[0]["AccidentYear"].ToString() + "</td></tr>");
                                strHTML.Append("<tr><td>&nbsp;</td>");
                                strHTML.Append("<td width='150px' align='right'>Incurred :</td>");
                                strHTML.Append("<td width='120px' align='right'>" + String.Format("{0:C2}", drYearTotal[0]["Total_Incurred_1"]) + "</td>");
                                strHTML.Append("<td width='120px' align='right'>" + String.Format("{0:C2}", drYearTotal[0]["Total_Incurred_2"]) + "</td>");
                                strHTML.Append("<td width='120px' align='right'>" + String.Format("{0:C2}", drYearTotal[0]["Total_Incurred_D"]) + "</td>");
                                strHTML.Append("<td width='120px' align='center'>" + String.Format("{0:N0}", drYearTotal[0]["Total_Claims"]) + "</td></tr>");
                                strHTML.Append("<tr><td>&nbsp;</td>");
                                strHTML.Append("<td align='right'>Paid :</td>");
                                strHTML.Append("<td align='right'>" + String.Format("{0:C2}", drYearTotal[0]["Total_Paid_1"]) + "</td>");
                                strHTML.Append("<td align='right'>" + String.Format("{0:C2}", drYearTotal[0]["Total_Paid_2"]) + "</td>");
                                strHTML.Append("<td align='right'>" + String.Format("{0:C2}", drYearTotal[0]["Total_Paid_D"]) + "</td>");
                                strHTML.Append("<td align='center'></td></tr>");
                                strHTML.Append("<tr><td>&nbsp;</td>");
                                strHTML.Append("<td align='right'>Outstandings :</td>");
                                strHTML.Append("<td align='right'>" + String.Format("{0:C2}", drYearTotal[0]["Total_Outstanding_1"]) + "</td>");
                                strHTML.Append("<td align='right'>" + String.Format("{0:C2}", drYearTotal[0]["Total_Outstanding_2"]) + "</td>");
                                strHTML.Append("<td align='right'>" + String.Format("{0:C2}", drYearTotal[0]["Total_Out_D"]) + "</td>");
                                strHTML.Append("<td align='center'>&nbsp;</td></tr></table>");
                                #endregion
                            }
                            else
                            {
                                //Add No record found line for year
                                strHTML.Append("No Record Found!");
                            }
                            strHTML.Append("</td></tr>");
                        }

                        #region " Finally Add Report Grand Total "

                        DataRow drTotal = dtGrandTotals.Rows[0];
                        strHTML.Append("<tr><td align='left'>");
                        strHTML.Append("<table border='1' cellpadding='0' cellspacing='0' style='width: 100%;font-weight: bold;background-color: #507CD1; color: #FFFFFF;'>");
                        strHTML.Append("<tr><td colspan='6'>Report Grand Total </td></tr>");
                        strHTML.Append("<tr><td>&nbsp;</td>");
                        strHTML.Append("<td width='150px' align='right'>Incurred :</td>");
                        strHTML.Append("<td width='120px' align='right'>" + String.Format("{0:C2}", drTotal["Total_Incurred_1"]) + "</td>");
                        strHTML.Append("<td width='120px' align='right'>" + String.Format("{0:C2}", drTotal["Total_Incurred_2"]) + "</td>");
                        strHTML.Append("<td width='120px' align='right'>" + String.Format("{0:C2}", drTotal["Total_Incurred_D"]) + "</td>");
                        strHTML.Append("<td width='120px' align='center'>" + String.Format("{0:N0}", drTotal["Total_Claims"]) + "</td></tr>");
                        strHTML.Append("<tr><td>&nbsp;</td>");
                        strHTML.Append("<td align='right'>Paid :</td>");
                        strHTML.Append("<td align='right'>" + String.Format("{0:C2}", drTotal["Total_Paid_1"]) + "</td>");
                        strHTML.Append("<td align='right'>" + String.Format("{0:C2}", drTotal["Total_Paid_2"]) + "</td>");
                        strHTML.Append("<td align='right'>" + String.Format("{0:C2}", drTotal["Total_Paid_D"]) + "</td>");
                        strHTML.Append("<td align='center'></td></tr>");
                        strHTML.Append("<tr><td>&nbsp;</td>");
                        strHTML.Append("<td align='right'>Outstandings :</td>");
                        strHTML.Append("<td align='right'>" + String.Format("{0:C2}", drTotal["Total_Outstanding_1"]) + "</td>");
                        strHTML.Append("<td align='right'>" + String.Format("{0:C2}", drTotal["Total_Outstanding_2"]) + "</td>");
                        strHTML.Append("<td align='right'>" + String.Format("{0:C2}", drTotal["Total_Out_D"]) + "</td>");
                        strHTML.Append("<td align='center'>&nbsp;</td></tr></table>");
                        strHTML.Append("</td></tr>");

                        #endregion

                        strHTML.Append("</table>");

                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        isGrid = true;
                        SendMail("Point-in-Time Summary Report", "PITSummaryReport.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
                        isGrid = false;
                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in Summary Point-in-Time Comparison Report, " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
        }

        //Report 13
        private void BindThreePITSummaryReport(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(13, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = dtUser.Rows[0]["FIRST_NAME"].ToString();
                        strLastName = dtUser.Rows[0]["LAST_NAME"].ToString();
                        strMailFrom = dtUser.Rows[0]["Email"].ToString();

                        //Set all filters to a variable as per report type
                        DataRow drReport = dtFilter.Rows[0];
                        DateTime as_of_date1 = Convert.ToDateTime(drReport["As_Of_Date1"]);
                        DateTime as_of_date2 = Convert.ToDateTime(drReport["As_Of_Date2"]);
                        DateTime as_of_date3 = Convert.ToDateTime(drReport["As_Of_Date3"]);

                        DateTime Compare_First_Date1 = Convert.ToDateTime(drReport["Compare_First_Date1"]);
                        DateTime Compare_First_Date2 = Convert.ToDateTime(drReport["Compare_First_Date2"]);
                        DateTime Compare_First_Date3 = Convert.ToDateTime(drReport["Compare_First_Date3"]);

                        DateTime Compare_Second_Date1 = Convert.ToDateTime(drReport["Compare_Second_Date1"]);
                        DateTime Compare_Second_Date2 = Convert.ToDateTime(drReport["Compare_Second_Date2"]);
                        DateTime Compare_Second_Date3 = Convert.ToDateTime(drReport["Compare_Second_Date3"]);

                        //Get the report data
                        DataSet dsReport = Report.GetThreePITSummaryData(as_of_date1, Compare_First_Date1, Compare_Second_Date1,
                                                                    as_of_date2, Compare_First_Date2, Compare_Second_Date2,
                                                                    as_of_date3, Compare_First_Date3, Compare_Second_Date3,
                                                                    drReport["Claim_Type"].ToString(), FK_Security_Id);
                        DataTable dtReport = dsReport.Tables[0];

                        //Create HTML for the report and wirte into HTML Write object
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        #region " Header "
                        //Add Report Title and Schedule Date
                        strHTML.Append("<table><tr><td colspan='11'>");
                        strHTML.Append("<br />");
                        strHTML.Append("<b>Title : Three Points in Time Summary Report</b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"]).ToString();
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        //Add Report Filter Criteria 
                        strHTML.Append("<br /><br />");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Claim Types :" + GetClaimTypeString(drReport["Claim_Type"].ToString()));
                        strHTML.Append("<br /><br />");

                        strHTML.Append("</td></tr></table>");

                        //Add Header HTML
                        strHTML.Append("<table width='100%' cellspacing=0 cellpadding=0><tr><td width='100%'>");
                        strHTML.Append("<table style='width: 100%; ' border='1' cellpadding='4' cellspacing='0'>");
                        strHTML.Append("<tr style='font-weight: bold;' align='center'>");
                        strHTML.Append("<td width='14%'>&nbsp;</td> "
                                            + " <td colspan='2'>Period 1 <br> " + Compare_First_Date1.ToString(DateDisplayFormat) + " To " + Compare_Second_Date1.ToString(DateDisplayFormat) + " <br> As Of " + as_of_date1.ToString("MM/yyyy") + "</td> "
                                            + " <td colspan='4'>Period 2 <br> " + Compare_First_Date2.ToString(DateDisplayFormat) + " To " + Compare_Second_Date2.ToString(DateDisplayFormat) + " <br> As Of " + as_of_date2.ToString("MM/yyyy") + "</td> "
                                            + " <td colspan='4'>Period 3 <br> " + Compare_First_Date3.ToString(DateDisplayFormat) + " To " + Compare_Second_Date3.ToString(DateDisplayFormat) + " <br> As Of " + as_of_date3.ToString("MM/yyyy") + "</td></tr>"
                                            + " <tr style='font-weight: bold;' align='center'>"
                                            + " <td style='width:14%' align='left'>Location</td> "
                                            + " <td style='width:10%' align='right'>Total Incurred Dollars</td> "
                                            + " <td style='width:8%' align='right'># of Claims</td> "
                                            + " <td style='width:10%' align='right'>Total Incurred Dollars</td> "
                                            + " <td style='width:8%' align='right'>Fin Chg Pd 2-1</td> "
                                            + " <td style='width:8%' align='right'># of Claims</td>"
                                            + " <td style='width:8%' align='right'>Claims % Chg P 1-2</td> "
                                            + " <td style='width:10%' align='right'>Total Incurred Dollars</td> "
                                            + " <td style='width:8%' align='right'>Fin chg Pd 2-3</td> "
                                            + " <td style='width:8%' align='right'># of Claims</td> "
                                            + " <td style='width:8%' align='right'>Claims % chg P 2-3</td></tr></table></td></tr></table>");

                        #endregion

                        DataTable dtDetails = dsReport.Tables[0];
                        DataTable dtRegionTotals = dsReport.Tables[1];
                        DataTable dtGrandTotal = dsReport.Tables[2];
                        //Get the no of descriptions selected
                        strHTML.Append("<table style='width: 100%;' border='1' cellpadding='4' cellspacing='0'>");

                        if (dtDetails.Rows.Count > 0)
                        {
                            foreach (DataRow drRegion in dtRegionTotals.Rows)
                            {
                                //Add Header for Sub Report (Description wise)
                                strHTML.Append("<tr><td colspan='11' style='font-weight:bold;'>Region : " + drRegion["Region"].ToString() + "</td></tr>");
                                DataRow[] drDetails = dtDetails.Select("Region = '" + drRegion["Region"] + "'");

                                #region " Region-wise Details "
                                foreach (DataRow drDetail in drDetails)
                                {

                                    strHTML.Append("<tr>" +
                                                    " <td style='width:14%' align='left'> " + drDetail["Location"].ToString() + "</td>" +
                                                    " <td style='width:10%' align='right'> " + String.Format("{0:C2}", Convert.ToDouble(drDetail["Incurred_1"])) + "</td>" +
                                                    " <td style='width:8%' align='right'> " + String.Format("{0:N0}", Convert.ToDouble(drDetail["ClaimCount_1"])) + "</td>" +
                                                    " <td style='width:10%' align='right'> " + String.Format("{0:C2}", Convert.ToDouble(drDetail["Incurred_2"])) + "</td>" +
                                                    " <td style='width:8%' align='right'> " + String.Format("{0:f}", Convert.ToDouble(drDetail["FinChgPd2Inc_2"])) + "</td>" +
                                                    " <td style='width:8%' align='right'> " + String.Format("{0:N0}", Convert.ToDouble(drDetail["ClaimCount_2"])) + "</td>" +
                                                    " <td style='width:8%' align='right'> " + String.Format("{0:f}", Convert.ToDouble(drDetail["FinChgPd2Cnt_2"])) + "</td>" +
                                                    " <td style='width:10%' align='right'> " + String.Format("{0:C2}", Convert.ToDouble(drDetail["Incurred_3"])) + "</td>" +
                                                    " <td style='width:8%' align='right'> " + String.Format("{0:f}", Convert.ToDouble(drDetail["FinChgPd2Inc_3"])) + "</td>" +
                                                    " <td style='width:8%' align='right'> " + String.Format("{0:N0}", Convert.ToDouble(drDetail["ClaimCount_3"])) + "</td>" +
                                                    " <td style='width:8%' align='right'> " + String.Format("{0:f}", Convert.ToDouble(drDetail["FinChgPd2Cnt_3"])) + "</td></tr>");
                                }
                                #endregion

                                #region " Sub Totals for Region "
                                //Add Sub Total (Region wise)
                                strHTML.Append("<tr style='font-weight: bold;background-color: white; color: black;'>");
                                strHTML.Append(" <td align='left'>Totals</td>" +
                                               " <td align='right'> " + String.Format("{0:C2}", Convert.ToDouble(drRegion["Incurred_1"])) + "</td>" +
                                               " <td align='right'> " + String.Format("{0:N0}", Convert.ToDouble(drRegion["ClaimCount_1"])) + "</td>" +
                                               " <td align='right'> " + String.Format("{0:C2}", Convert.ToDouble(drRegion["Incurred_2"])) + "</td>" +
                                               " <td align='right'> " + String.Format("{0:f}", Convert.ToDouble(drRegion["FinChgPd2Inc_2"])) + "</td>" +
                                               " <td align='right'> " + String.Format("{0:N0}", Convert.ToDouble(drRegion["ClaimCount_2"])) + "</td>" +
                                               " <td align='right'> " + String.Format("{0:f}", Convert.ToDouble(drRegion["FinChgPd2Cnt_2"])) + "</td>" +
                                               " <td align='right'> " + String.Format("{0:C2}", Convert.ToDouble(drRegion["Incurred_3"])) + "</td>" +
                                               " <td align='right'> " + String.Format("{0:f}", Convert.ToDouble(drRegion["FinChgPd2Inc_3"])) + "</td>" +
                                               " <td align='right'> " + String.Format("{0:N0}", Convert.ToDouble(drRegion["ClaimCount_3"])) + "</td>" +
                                               " <td align='right'> " + String.Format("{0:f}", Convert.ToDouble(drRegion["FinChgPd2Cnt_3"])) + "</td></tr>");
                                #endregion
                            }

                            #region " Grand Total "
                            if (dtGrandTotal.Rows.Count > 0)
                            {
                                DataRow drTotal = dtGrandTotal.Rows[0];
                                strHTML.Append("<tr><td>");
                                strHTML.Append("<table style='font-weight: bold;' cellpadding='0' cellspacing='0' width='100%' border='1' style='font-weight: bold;background-color: #507CD1; color: #FFFFFF;'><tr>");
                                strHTML.Append(" <td style='width:14%' align='left'>Report Grand Totals</td>");
                                strHTML.Append(" <td style='width:10%' align='right'> " + String.Format("{0:C2}", Convert.ToDouble(drTotal["Incurred_1"])) + "</td>" +
                                               " <td style='width:8%' align='right'> " + String.Format("{0:N0}", Convert.ToDouble(drTotal["ClaimCount_1"])) + "</td>" +
                                               " <td style='width:10%' align='right'> " + String.Format("{0:C2}", Convert.ToDouble(drTotal["Incurred_2"])) + "</td>" +
                                               " <td style='width:8%' align='right'> " + String.Format("{0:f}", Convert.ToDouble(drTotal["FinChgPd2Inc_2"])) + "</td>" +
                                               " <td style='width:8%' align='right'> " + String.Format("{0:N0}", Convert.ToDouble(drTotal["ClaimCount_2"])) + "</td>" +
                                               " <td style='width:8%' align='right'> " + String.Format("{0:f}", Convert.ToDouble(drTotal["FinChgPd2Cnt_2"])) + "</td>" +
                                               " <td style='width:10%' align='right'> " + String.Format("{0:C2}", Convert.ToDouble(drTotal["Incurred_3"])) + "</td>" +
                                               " <td style='width:8%' align='right'> " + String.Format("{0:f}", Convert.ToDouble(drTotal["FinChgPd2Inc_3"])) + "</td>" +
                                               " <td style='width:8%' align='right'> " + String.Format("{0:N0}", Convert.ToDouble(drTotal["ClaimCount_3"])) + "</td>" +
                                               " <td style='width:8%' align='right'> " + String.Format("{0:f}", Convert.ToDouble(drTotal["FinChgPd2Cnt_3"])) + "</td>");
                                strHTML.Append("</tr></table></td></tr></table>");
                            }
                            #endregion
                        }
                        else
                        {
                            //Add No record found line for year
                            strHTML.Append("<tr><td align='left' colspan='11'>No Record Found!</td></tr></table>");
                        }

                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        isGrid = true;
                        SendMail("Three Points in Time Summary Report", "ThreePITSummaryReport.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
                        isGrid = false;
                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in Three Point-in-Time Summary Report, " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
        }

        //Report 14
        private void BindBordereauReport(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(14, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = dtUser.Rows[0]["FIRST_NAME"].ToString();
                        strLastName = dtUser.Rows[0]["LAST_NAME"].ToString();
                        strMailFrom = dtUser.Rows[0]["Email"].ToString();

                        // get start date
                        DateTime Start_Date = Convert.ToDateTime(dtFilter.Rows[0]["Start_Date"]);
                        // get end date
                        DateTime End_Date = Convert.ToDateTime(dtFilter.Rows[0]["End_Date"]);

                        string strMarket = null;
                        decimal? decMarket = null;
                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Market"])))
                        {
                            decMarket = Convert.ToDecimal(dtFilter.Rows[0]["Market"]);
                        }

                        // get result records from database for the report
                        DataSet dsReport = Report.Get_Bordereau_Report(Start_Date, End_Date, Convert.ToString(dtFilter.Rows[0]["Region"]), decMarket);

                        //Create HTML for the report and wirte into HTML Write object
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        #region "Header"

                        //Retrieve Market Values
                        string strMarketString = string.Empty;
                        if (string.IsNullOrEmpty(strMarket))
                        {
                            strMarketString = "All Market";
                        }
                        else
                        {
                            string[] strMar = strMarket.Split(Convert.ToChar(","));
                            for (int i = 0; i < strMar.Length; i++)
                            {
                                strMarketString += Report.SelectMarketInfoById(Convert.ToDecimal(strMar[i].ToString())).Tables[0].Rows[0]["Market"].ToString() + ",";
                            }
                            strMarketString = strMarketString.TrimEnd(',');
                        }

                        //Add Report Title and Schedule Date
                        strHTML.Append("<table><tr><td colspan='10'>");
                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : FINPRO  Bordereau Report</b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"]).ToString();
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        //Add Report Filter Criteria 
                        strHTML.Append("<br /><br />");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Date Claim Opened Between " + Start_Date.ToString(DateDisplayFormat) + " and " + End_Date.ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Regions : " + (string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Region"])) ? "All" : dtFilter.Rows[0]["Region"].ToString()));
                        strHTML.Append("<br />");
                        strHTML.Append("Markets : " + strMarketString);
                        strHTML.Append("<br /><br />");
                        strHTML.Append("</td></tr></table>");

                        //Add Header HTML
                        strHTML.Append("<div style=\"overflow-x:scroll;overflow-y:hidden;width:1200px;\">");
                        strHTML.Append("<table cellpadding='4' cellspacing='0' style='font-weight: bold;font-family:Calibri;' width='3150px' border='1'><tr valign='top'>");

                        //strHTML.Append("<table cellpadding='4' cellspacing='0' style='font-weight: bold;font-family:Calibri;' width='3150px' border='1'><tr valign='top'>");
                        strHTML.Append("<td style='width: 80px;border:thin;' align='left' >Claim Number</td>");
                        strHTML.Append("<td style='width: 150px;border:thin;' align='left' >Type of Allegation</td>");
                        strHTML.Append("<td style='width: 150px;border:thin;' align='left' >Complainant/Plaintiff</td>");
                        strHTML.Append("<td style='width: 250px;border:thin;' align='left' >Claim Description</td>");
                        strHTML.Append("<td style='width: 100px;border:thin;' align='left' >Carrier</td>");
                        strHTML.Append("<td style='width: 150px;border:thin;' align='left' >Type of Claim</td>");
                        strHTML.Append("<td style='width: 150px;border:thin;' align='left' >Other Type Description</td>");
                        strHTML.Append("<td style='width: 150px;border:thin;' align='left' >Policy Number</td>");
                        strHTML.Append("<td style='width: 250px;border:thin;' align='right' >Deductible</td>");
                        strHTML.Append("<td style='width: 150px;border:thin;' align='left' >Date of Alleged Wrongful Act</td>");
                        strHTML.Append("<td style='width: 200px;border:thin;' align='left' >Date Claim Opened</td>");
                        strHTML.Append("<td style='width: 200px;border:thin;' align='left' >Policy Effective Date</td>");
                        strHTML.Append("<td style='width: 150px;border:thin;' align='left' >Policy Expiration Date</td>");
                        strHTML.Append("<td style='width: 250px;border:thin;' align='right' >Estimated Demand Exposure</td>");
                        strHTML.Append("<td style='width: 350px;border:thin;' align='left' >Claim Status/Comments</td>");
                        strHTML.Append("<td style='width: 150px;border:thin;' align='left' >Internal Counsel</td>");
                        strHTML.Append("<td style='width: 200px;border:thin;' align='left' >Internal Counsel Phone</td>");
                        strHTML.Append("<td style='width: 200px;border:thin;' align='left' >Location Code</td>");
                        strHTML.Append("<td style='width: 250px;border:thin;' align='left' >Sonic Location Name</td>");
                        strHTML.Append("<td style='width: 250px;border:thin;' align='left' >Location dba</td>");
                        strHTML.Append("<td style='width: 250px;border:thin;' align='left' >Entity</td>");
                        strHTML.Append("<td style='width: 200px;border:thin;' align='left' >Defense Attorney</td>");
                        strHTML.Append("<td style='border:thin'>");
                        strHTML.Append("<table style='font-weight: bold'> <tr valign='top'> <td colspan='4' style='border:thin'>Plaintiff Attorney Information</td></tr><tr valign='top'>");
                        strHTML.Append("<td style='width: 200px;border:thin' align='left' >Firm</td>");
                        strHTML.Append("<td style='width: 200px;border:thin' align='left' >Name</td>");
                        strHTML.Append("<td style='width: 200px;border:thin' align='left' >Address</td>");
                        strHTML.Append("<td style='width: 200px;border:thin' align='left' >Phone Number</td>");
                        strHTML.Append("</tr></table>");
                        strHTML.Append("</td>");
                        strHTML.Append("</tr></table>");
                        #endregion
                        //strHTML.Append("</tr>");
                        //strHTML.Append("<tr>");
                        DataTable dtReportData = dsReport.Tables[0];
                        DataTable dtRegion = dsReport.Tables[1];
                        DataTable dtTotal = dsReport.Tables[2];
                        if (dtRegion.Rows.Count > 0)
                        {
                            //    //Add Report Data Table 
                            strHTML.Append("<table style='width: 3150px;' border='1' cellpadding='4' cellspacing='0'>");
                            foreach (DataRow drRegion in dtRegion.Rows)
                            {
                                strHTML.Append("<tr><td colspan='22' style='font-family:Calibri; border:thin'><b>");
                                strHTML.Append(drRegion["Region"].ToString());
                                strHTML.Append("</b></td>");
                                strHTML.Append("<td colspan='4' style='border:thin'>");
                                strHTML.Append("<table style='font-weight: bold'> <tr valign='top'> <td style='border:thin'></td><td style='border:thin'></td><td style='border:thin'></td><td style='border:thin'></td>");
                                strHTML.Append("</tr></table></td></tr>");


                                //strHTML.Append("<tr><td colspan='26' style='border:thin'>");
                                //strHTML.Append("<table style='width: 3150px;font-family:Calibri;' border='1' cellpadding='4' cellspacing='0'>");
                                DataRow[] drDataByRegion = dtReportData.Select("Region='" + drRegion["Region"].ToString() + "'");
                                foreach (DataRow drData in drDataByRegion)
                                {
                                    strHTML.Append("<tr style='background-color:#FFFFFF;' valign='top'>");
                                    strHTML.Append("<td style='width: 80px;border:thin;' align='left'>" + drData["Claim_Number"] + "</td>");
                                    strHTML.Append("<td style='width: 150px;border:thin;' align='left' >" + drData["Type_of_Allegation"] + "</td>");
                                    strHTML.Append("<td style='width: 150px;border:thin;' align='left' >" + drData["Complainant_Plaintiff"] + "</td>");
                                    strHTML.Append("<td style='width: 250px;border:thin;' align='left' >" + drData["Claim_Description"] + "</td>");
                                    strHTML.Append("<td style='width: 100px;border:thin;' align='left' >" + drData["Carrier"] + "</td>");
                                    strHTML.Append("<td style='width: 150px;border:thin;' align='left' >" + drData["Type_Of_Claim"] + "</td>");
                                    strHTML.Append("<td style='width: 150px;border:thin;' align='left'>" + drData["Claim_Type_Other"] + "</td>");
                                    strHTML.Append("<td style='width: 150px;border:thin;' align='left' >" + drData["Primary_Insurance_Policy_Number"] + "</td>");
                                    strHTML.Append("<td style='width: 250px;border:thin;' align='right' >$ " + string.Format("{0:N2}", drData["Primary_Deductable"]) + "</td>");
                                    //Convert.ToDateTime(System.Data.SqlTypes.SqlDateTime.MinValue.ToString())
                                    if (Convert.ToDateTime(drData["Date_Alleged_Wrongful_Act"]) != Convert.ToDateTime(System.Data.SqlTypes.SqlDateTime.MinValue.ToString()))
                                    {
                                        strHTML.Append("<td style='width: 150px;border:thin' align='left'>" + Convert.ToDateTime(drData["Date_Alleged_Wrongful_Act"]).ToString(DateDisplayFormat) + "</td>");
                                    }
                                    else
                                    {
                                        strHTML.Append("<td style='width: 150px;' align='left' style='border:thin'>&nbsp;</td>");
                                    }

                                    if (Convert.ToDateTime(drData["Claim_Open_Date"]) != Convert.ToDateTime(System.Data.SqlTypes.SqlDateTime.MinValue.ToString()))
                                    {
                                        strHTML.Append("<td style='width: 200px;' align='left'>" + Convert.ToDateTime(drData["Claim_Open_Date"]).ToString(DateDisplayFormat) + "</td>");
                                    }
                                    else
                                    {
                                        strHTML.Append("<td style='width: 1200px;' align='left'>&nbsp;</td>");
                                    }

                                    if (Convert.ToDateTime(drData["Primary_Policy_Effective_Date"]) != Convert.ToDateTime(System.Data.SqlTypes.SqlDateTime.MinValue.ToString()))
                                    {
                                        strHTML.Append("<td style='width: 200px;' align='left'>" + Convert.ToDateTime(drData["Primary_Policy_Effective_Date"]).ToString(DateDisplayFormat) + "</td>");
                                    }
                                    else
                                    {
                                        strHTML.Append("<td style='width: 200px;' align='left'>&nbsp;</td>");
                                    }

                                    if (Convert.ToDateTime(drData["Primary_Policy_Expiration_Date"]) != Convert.ToDateTime(System.Data.SqlTypes.SqlDateTime.MinValue.ToString()))
                                    {
                                        strHTML.Append("<td style='width: 150px;' align='left'>" + Convert.ToDateTime(drData["Primary_Policy_Expiration_Date"]).ToString(DateDisplayFormat) + "</td>");
                                    }
                                    else
                                    {
                                        strHTML.Append("<td style='width: 150px;' align='left'>&nbsp;</td>");
                                    }
                                    strHTML.Append("<td style='width: 250px;' align='right'>$ " + string.Format("{0:N2}", drData["Estimated_Demand_Exposure"]) + "</td>");
                                    strHTML.Append("<td style='width: 350px;' align='left'>" + drData["Claim_Status_Comments"] + "</td>");
                                    strHTML.Append("<td style='width: 150px;' align='left'>" + drData["Internal_Counsel"] + "</td>");
                                    strHTML.Append("<td style='width: 200px;' align='left'>" + drData["Legal_Telephone"] + "</td>");

                                    strHTML.Append("<td style='width: 200px;' align='left'>" + drData["Sonic_Location_Code"] + "</td>");
                                    strHTML.Append("<td style='width: 250px;' align='left'>" + drData["legal_entity"] + "</td>");
                                    strHTML.Append("<td style='width: 250px;' align='left'>" + drData["dba"] + "</td>");

                                    strHTML.Append("<td style='width: 250px;' align='left'>" + drData["Entity"] + "</td>");
                                    strHTML.Append("<td style='width: 200px;' align='left'>" + drData["Firm"] + "</td>");
                                    strHTML.Append("<td >");

                                    strHTML.Append("<table border=1>");


                                    Int32 PK_Exe = Convert.ToInt32(drData["PK_Executive_Risk"]);

                                    DataRow[] drTADtl = dsReport.Tables[3].Select(" FK_Executive_Risk = " + PK_Exe.ToString());

                                    foreach (DataRow dr in drTADtl)
                                    {
                                        strHTML.Append("<tr align='left' valign='top'>");
                                        strHTML.Append("<td align='left' style='border:thin'>" + dr["Firm"] + "</td>");
                                        strHTML.Append("<td align='left' style='border:thin'>" + dr["Name"] + "</td>");
                                        strHTML.Append("<td align='left' style='border:thin'>" + dr["Full_Address"].ToString().Replace("<br>", "<br/>") + "</td>");
                                        strHTML.Append("<td align='left' style='border:thin'>" + dr["Telephone"] + "</td>");
                                        strHTML.Append("</tr>");
                                    }

                                    if (drTADtl.Length <= 0)
                                    {
                                        strHTML.Append("<tr>");
                                        strHTML.Append("<td>&nbsp;</td>");
                                        strHTML.Append("<td>&nbsp;</td>");
                                        strHTML.Append("<td>&nbsp;</td>");
                                        strHTML.Append("<td>&nbsp;</td>");
                                        strHTML.Append("</tr>");
                                    }
                                    strHTML.Append("</table>");
                                    strHTML.Append("</td>");
                                    strHTML.Append("</tr>");
                                }
                                strHTML.Append("<tr style='background-color:#FFFFFF;border=1;'>");
                                strHTML.Append("<td style='width: 150px;' align='left'><b>Total</b></td>");
                                strHTML.Append("<td style='width: 250px;' align='left'><b>" + drRegion["Total"].ToString() + "</b></td>");
                                strHTML.Append("<td style='width: 100px;' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 150px;' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 150px;' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 250px;' align='right'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 150px;' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 200px;' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 200px;' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 150px;' align='left'>&nbsp;</td>");
                                strHTML.Append("<td align='left'>&nbsp;</td>");
                                strHTML.Append("<td align='left'>&nbsp;</td>");
                                strHTML.Append("<td align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 250px;' align='right'><b>$ " + string.Format("{0:N2}", drRegion["Total_Exposure"]) + "</b></td>");
                                strHTML.Append("<td style='width: 350px;' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 150px;' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 200px;' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 200px;' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 250px;' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 250px;' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 250px;' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 200px;' align='left'>&nbsp;</td>");
                                strHTML.Append("<td align='left'>");
                                strHTML.Append("<table border=1>");
                                strHTML.Append("<tr>");
                                strHTML.Append("<td>&nbsp;</td>");
                                strHTML.Append("<td>&nbsp;</td>");
                                strHTML.Append("<td>&nbsp;</td>");
                                strHTML.Append("<td>&nbsp;</td>");
                                strHTML.Append("</tr></table>");
                                strHTML.Append("</td></tr>");
                            }

                            strHTML.Append("<tr style='background-color:#507cd1;font-family:Calibri;color:White;border:thin'>");

                            strHTML.Append("<tr style='background-color:#507cd1;font-family:Calibri;color:White;border:thin;'>");

                            strHTML.Append("<td align='left'><b>Grand Total</b></td>");
                            strHTML.Append("<td  align='left'><b>" + dtTotal.Rows[0]["Total"].ToString() + "</b></td>");
                            strHTML.Append("<td style='width: 100px;' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 150px;' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 150px;' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 250px;' align='right'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 150px;' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 200px;' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 200px;' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 150px;' align='left'>&nbsp;</td>");
                            strHTML.Append("<td align='left'>&nbsp;</td>");
                            strHTML.Append("<td align='left'>&nbsp;</td>");
                            strHTML.Append("<td  align='left'>&nbsp;</td>");
                            strHTML.Append("<td  align='right'><b>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["Total_Exposure"]) + "</b></td>");
                            strHTML.Append("<td style='width: 350px;' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 150px;' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 200px;' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 200px;' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 250px;' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 250px;' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 250px;' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 200px;' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 200px;' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 200px;' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 200px;' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 200px;' align='left'>&nbsp;</td>");
                            strHTML.Append("</tr>");
                            strHTML.Append("</table>");
                            strHTML.Append("</div>");

                            //strHTML.Append("</td></tr>");

                        }
                        else
                        {
                            //Add No record found line for year
                            strHTML.Append("<tr><td align='left' style='border:thin' colspan='26'>No Record Found!</td></tr></table>");
                            strHTML.Append("</div>");
                        }
                        //strHTML.Append("</tr></table>");


                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        SendMail("FINPRO Bordereau Report", "BordereauReport.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);


                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in Bordereau Report, " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
        }

        //Report 15
        private void BindNotif_BordereauReport(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(15, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = dtUser.Rows[0]["FIRST_NAME"].ToString();
                        strLastName = dtUser.Rows[0]["LAST_NAME"].ToString();
                        strMailFrom = dtUser.Rows[0]["Email"].ToString();
                        string strMarket = null;
                        //Added by Poonam Parekh on 06/10/2016
                        if (dtFilter.Rows[0]["Market"] == DBNull.Value)
                        {
                            strMarket = "0";
                        }
                        else if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Market"])))
                        {
                            strMarket = Convert.ToString(dtFilter.Rows[0]["Market"]).Trim();
                        }
                        // get start date
                        DateTime Start_Date = Convert.ToDateTime(dtFilter.Rows[0]["Start_Date"]);
                        // get end date
                        DateTime End_Date = Convert.ToDateTime(dtFilter.Rows[0]["End_Date"]);


                        // get result records from database for the report
                        DataSet dsReport = Report.Get_Notification_Bordereau_Report(Start_Date, End_Date, Convert.ToString(dtFilter.Rows[0]["Region"]), strMarket);

                        //Create HTML for the report and wirte into HTML Write object
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        #region "Header"

                        //Retrieve Market Values
                        string strMarketString = string.Empty;
                        //if (string.IsNullOrEmpty(strMarket))
                        //{
                        //    strMarketString = "All Market";
                        //}
                        //Updated by Poonam Parekh on 6/10/2016
                        if (strMarket == "0")
                        {
                            strMarketString = "All Market";
                        }
                        else
                        {
                            string[] strMar = strMarket.Split(Convert.ToChar(","));
                            for (int i = 0; i < strMar.Length; i++)
                            {
                                strMarketString += Report.SelectMarketInfoById(Convert.ToDecimal(strMar[i].ToString())).Tables[0].Rows[0]["Market"].ToString() + ",";
                            }
                            strMarketString = strMarketString.TrimEnd(',');
                        }

                        //Add Report Title and Schedule Date
                        strHTML.Append("<table><tr><td colspan='11'>");
                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : FINPRO Claim Notification Bordereau Report</b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"]).ToString();
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        //Add Report Filter Criteria 
                        strHTML.Append("<br /><br />");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Date Claim Opened Between " + Start_Date.ToString(DateDisplayFormat) + " and " + End_Date.ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Regions : " + (string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Region"])) ? "All" : dtFilter.Rows[0]["Region"].ToString()));
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Market : " + strMarketString);
                        strHTML.Append("<br /><br />");
                        strHTML.Append("</td></tr></table>");

                        //Add Header HTML
                        strHTML.Append("<div style=\"overflow-x:scroll;overflow-y:hidden;width:1200px;\">");
                        strHTML.Append("<table cellpadding='4' cellspacing='0' style='font-weight: bold;font-family:Calibri;' width='1400px' border='1'><tr>");
                        strHTML.Append("<td style='width: 150px;' align='left'>Date Claim Opened</td>");
                        strHTML.Append("<td style='width: 250px;' align='left'>Claimant/Plaintiff</td>");

                        strHTML.Append("<td style='width: 120px;' align='left'>Location Code</td>");
                        strHTML.Append("<td style='width: 120px;' align='left'>Sonic Location Name</td>");
                        strHTML.Append("<td style='width: 120px;' align='left'>Location dba</td>");
                        strHTML.Append("<td style='width: 120px;' align='left'>Entity</td>");
                        strHTML.Append("<td style='width: 150px;' align='right'>Defense Cost</td>");
                        strHTML.Append("<td style='width: 150px;' align='left'>Defense Attorney</td>");
                        strHTML.Append("<td style='width: 250px;' align='left'>Type of Allegation</td>");
                        strHTML.Append("<td style='width: 150px;' align='left'>Claim Status/Comments</td>");
                        strHTML.Append("<td style='width: 200px;' align='left'>Settlement</td>");
                        strHTML.Append("</tr></table>");
                        #endregion

                        DataTable dtReportData = dsReport.Tables[0];
                        DataTable dtRegion = dsReport.Tables[1];
                        DataTable dtTotal = dsReport.Tables[2];
                        if (dtRegion.Rows.Count > 0)
                        {
                            //Add Report Data Table 
                            strHTML.Append("<table style='width: 1400px;' border='1' cellpadding='4' cellspacing='0'>");
                            foreach (DataRow drRegion in dtRegion.Rows)
                            {
                                strHTML.Append("<tr><td colspan='11' style='font-family:Calibri;'><b>");
                                strHTML.Append(drRegion["Region"].ToString());
                                strHTML.Append("</b></td></tr>");
                                //strHTML.Append("<tr><td colspan='8'>");
                                //strHTML.Append("<table style='width: 1400px;font-family:Calibri;' border='1' cellpadding='4' cellspacing='0'>");
                                DataRow[] drDataByRegion = dtReportData.Select("Region='" + drRegion["Region"].ToString() + "'");
                                foreach (DataRow drData in drDataByRegion)
                                {
                                    strHTML.Append("<tr style='background-color:#FFFFFF;'>");
                                    if (Convert.ToDateTime(drData["Claim_Open_Date"]) != Convert.ToDateTime(System.Data.SqlTypes.SqlDateTime.MinValue.ToString()))
                                    {
                                        strHTML.Append("<td style='width: 150px;' align='left'>" + Convert.ToDateTime(drData["Claim_Open_Date"]).ToString(DateDisplayFormat) + "</td>");
                                    }
                                    else
                                    {
                                        strHTML.Append("<td style='width: 150px;' align='left'>&nbsp;</td>");
                                    }
                                    strHTML.Append("<td style='width: 250px;' align='left'>" + drData["Complainant_Plaintiff"] + "</td>");

                                    strHTML.Append("<td style='width: 120px;' align='left'>" + drData["Sonic_Location_Code"] + "</td>");
                                    strHTML.Append("<td style='width: 120px;' align='left'>" + drData["legal_entity"] + "</td>");
                                    strHTML.Append("<td style='width: 120px;' align='left'>" + drData["dba"] + "</td>");
                                    strHTML.Append("<td style='width: 120px;' align='left'>" + drData["Entity"] + "</td>");
                                    if (!string.IsNullOrEmpty(Convert.ToString(drData["DefenseCost"])))
                                        strHTML.Append("<td style='width: 150px;' align='right'>$ " + string.Format("{0:N2}", drData["DefenseCost"]) + "</td>");
                                    else
                                        strHTML.Append("<td style='width: 150px;' align='right'>&nbsp;</td>");
                                    strHTML.Append("<td style='width: 150px;' align='left'>" + drData["DefenseAttorney"] + "</td>");
                                    strHTML.Append("<td style='width: 250px;' align='left'>" + drData["Type_of_Allegation"] + "</td>");
                                    strHTML.Append("<td style='width: 150px;' align='left'>" + drData["Claim_Status_Comments"] + "</td>");
                                    strHTML.Append("<td style='width: 200px;' align='right'>$ " + string.Format("{0:N2}", drData["Actual_Settlement"]) + "</td>");
                                    strHTML.Append("</tr>");
                                }
                                strHTML.Append("<tr style='background-color:#FFFFFF;'>");
                                strHTML.Append("<td style='width: 150px;' align='left'><b>Total</b></td>");
                                strHTML.Append("<td style='width: 250px;' align='left'><b>" + drRegion["Total"].ToString() + "</b></td>");
                                strHTML.Append("<td style='width: 100px;' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 120px;' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 120px;' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 120px;' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 150px;' align='right'><b>$ " + string.Format("{0:N2}", drRegion["Total_DefenseCost"]) + "</b></td>");
                                strHTML.Append("<td style='width: 150px;' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 250px;' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 150px;' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 200px;' align='left'>&nbsp;</td>");
                                strHTML.Append("</tr>");
                                //strHTML.Append("</table>");
                                //strHTML.Append("</td></tr>");
                            }
                            strHTML.Append("<tr style='background-color:#507cd1;border:thin;font-family:Calibri;color:White;'>");
                            strHTML.Append("<td style='width: 150px;' align='left'><b>Grand Total</b></td>");
                            strHTML.Append("<td style='width: 250px;' align='left'><b>" + dtTotal.Rows[0]["Total"].ToString() + "</b></td>");
                            strHTML.Append("<td style='width: 120px;' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 120px;' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 120px;' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 120px;' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 150px;' align='right'><b>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["Total_DefenseCost"]) + "</b></td>");
                            strHTML.Append("<td style='width: 150px;' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 250px;' align='lef'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 150px;' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 200px;' align='left'>&nbsp;</td>");
                            strHTML.Append("</tr>");
                            //strHTML.Append("</table>");
                            //strHTML.Append("</td></tr>");
                            strHTML.Append("</table>");
                        }
                        else
                        {
                            //Add No record found line for year
                            strHTML.Append("<table style='width: 1400px;' border='1' cellpadding='4' cellspacing='0'>");
                            strHTML.Append("<tr><td align='left' colspan='11'>No Record Found!</td></tr></table>");
                        }

                        strHTML.Append("</div>");

                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        SendMail("FINPRO Claim Notification Bordereau Report", "ClaimNotificationBordereauReport .xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);


                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in Claim Notification Bordereau Report , " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
        }

        //Report 16
        private void BindEPLIPendingInvestigationandLitigationSummaryReport(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(16, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = dtUser.Rows[0]["FIRST_NAME"].ToString();
                        strLastName = dtUser.Rows[0]["LAST_NAME"].ToString();
                        strMailFrom = dtUser.Rows[0]["Email"].ToString();
                        string strMarket = null;
                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Market"])))
                        {
                            strMarket = Convert.ToString(dtFilter.Rows[0]["Market"]).Trim();
                        }
                        // get start date
                        DateTime Start_Date = Convert.ToDateTime(dtFilter.Rows[0]["Start_Date"]);
                        // get end date
                        DateTime End_Date = Convert.ToDateTime(dtFilter.Rows[0]["End_Date"]);

                        // get result records from database for the report
                        DataSet dsReport = Report.Get_Litigation_Summary_Report(Start_Date, End_Date, Convert.ToString(dtFilter.Rows[0]["Region"]), strMarket);

                        //Create HTML for the report and wirte into HTML Write object
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        #region "Header"

                        //Retrieve Market Values
                        string strMarketString = string.Empty;
                        if (string.IsNullOrEmpty(strMarket))
                        {
                            strMarketString = "All Market";
                        }
                        else
                        {
                            string[] strMar = strMarket.Split(Convert.ToChar(","));
                            for (int i = 0; i < strMar.Length; i++)
                            {
                                strMarketString += Report.SelectMarketInfoById(Convert.ToDecimal(strMar[i].ToString())).Tables[0].Rows[0]["Market"].ToString() + ",";
                            }
                            strMarketString = strMarketString.TrimEnd(',');
                        }

                        //Add Report Title and Schedule Date
                        strHTML.Append("<table><tr><td colspan='7'>");
                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : EPLI Pending Investigation and Litigation Summary Report </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"]).ToString();
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        //Add Report Filter Criteria 
                        strHTML.Append("<br /><br />");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Date Claim Opened Between " + Start_Date.ToString(DateDisplayFormat) + " and " + End_Date.ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Regions : " + (string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Region"])) ? "All" : dtFilter.Rows[0]["Region"].ToString()));
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Market : " + strMarketString);
                        strHTML.Append("<br /><br />");
                        strHTML.Append("</td></tr></table>");

                        //Add Header HTML
                        strHTML.Append("<div style=\"overflow-x:scroll;overflow-y:hidden;width:1750px;\">");
                        strHTML.Append("<table cellpadding='4' cellspacing='0' style='font-weight: bold;font-family:Calibri;' width='1750px' border='1'><tr>");
                        strHTML.Append("<th style='width: 150px;' align='left'>Region</th>");
                        strHTML.Append("<th style='width: 250px;' align='left'>Store</th>");
                        strHTML.Append("<th style='width: 150px;' align='left'>Date Claim Opened</th>");
                        strHTML.Append("<th style='width: 150px;' align='left'>Complainant/Plaintiff</th>");
                        strHTML.Append("<th style='width: 150px;' align='left'>Defense Attorney</th>");
                        strHTML.Append("<th style='width: 450px;' align='left'>Claim Description</th>");
                        strHTML.Append("<th style='width: 450px;' align='left'>Claim Status/Comments</th>");
                        strHTML.Append("</tr></table>");
                        #endregion

                        DataTable dtReportData = dsReport.Tables[0];
                        DataTable dtRegion = dsReport.Tables[1];
                        DataTable dtTotal = dsReport.Tables[2];
                        if (dtRegion.Rows.Count > 0)
                        {
                            //Add Report Data Table 
                            strHTML.Append("<table style='width: 1750px;' border='1' cellpadding='4' cellspacing='0'>");
                            foreach (DataRow drRegion in dtRegion.Rows)
                            {
                                //strHTML.Append("<tr><td colspan='7'>");
                                //strHTML.Append("<table style='width: 1750px;font-family:Calibri;' border='1' align='left' cellpadding='4' cellspacing='0'>");
                                DataRow[] drDataByRegion = dtReportData.Select("Region='" + drRegion["Region"].ToString() + "'");
                                foreach (DataRow drData in drDataByRegion)
                                {
                                    strHTML.Append("<tr style='background-color:#FFFFFF;'>");
                                    strHTML.Append("<td style='width: 150px;' align='left'>" + drData["Region"] + "</td>");
                                    strHTML.Append("<td style='width: 250px;' align='left'>" + drData["Location_Description"] + "</td>");
                                    if (Convert.ToDateTime(drData["Claim_Open_Date"]) != Convert.ToDateTime(System.Data.SqlTypes.SqlDateTime.MinValue.ToString()))
                                    {
                                        strHTML.Append("<td style='width: 150px;' align='left'>" + Convert.ToDateTime(drData["Claim_Open_Date"]).ToString(DateDisplayFormat) + "</td>");
                                    }
                                    else
                                    {
                                        strHTML.Append("<td style='width: 150px;' align='left'>&nbsp;</td>");
                                    }

                                    strHTML.Append("<td style='width: 150px;' align='left'>" + drData["Complainant_Plaintiff"] + "</td>");
                                    strHTML.Append("<td style='width: 150px;' align='left'>" + drData["DefenseAttorney"] + "</td>");
                                    strHTML.Append("<td style='width: 450px;' align='left'>");
                                    if (!string.IsNullOrEmpty(Convert.ToString(drData["Type_of_Allegation"])))
                                        strHTML.Append("<b>" + drData["Type_of_Allegation"] + "</b>:" + drData["Claim_Description"] + "</td>");
                                    else
                                        strHTML.Append(drData["Claim_Description"] + "</td>");
                                    strHTML.Append("<td style='width: 450px;' align='left'>" + drData["Claim_Status_Comments"] + "</td>");

                                    strHTML.Append("</tr>");
                                }
                                strHTML.Append("<tr style='background-color:#FFFFFF;'>");
                                strHTML.Append("<td style='width: 150px;' align='left'><b>Total</b></td>");
                                strHTML.Append("<td style='width: 250px;' align='left'><b>" + drRegion["Total"].ToString() + "</b></td>");
                                strHTML.Append("<td style='width: 150px;' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 150px;' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 150px;' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 450px;' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 450px;' align='left'>&nbsp;</td>");
                                strHTML.Append("</tr>");
                                //strHTML.Append("</table>");
                                //strHTML.Append("</td></tr>");
                            }
                            strHTML.Append("<tr style='background-color:#507cd1;font-family:Calibri;color:White;'>");
                            strHTML.Append("<td style='width: 150px;' align='left'><b>Grand Total</b></td>");
                            strHTML.Append("<td style='width: 250px;' align='left'><b>" + dtTotal.Rows[0]["Total"].ToString() + "</b></td>");
                            strHTML.Append("<td style='width: 150px;' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 150px;' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 150px;' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 450px;' align='lef'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 450px;' align='left'>&nbsp;</td>");
                            strHTML.Append("</tr>");
                            strHTML.Append("</table>");
                            //strHTML.Append("</td></tr>");
                            //strHTML.Append("</table>");
                        }
                        else
                        {
                            //Add No record found line for year
                            strHTML.Append("<tr><td align='left' colspan='7'>No Record Found!</td></tr>");
                        }

                        strHTML.Append("</div>");

                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        SendMail("EPLI Pending Investigation and Litigation Summary Report", "EPLIPendingInvestigationandLitigationSummaryReport .xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);


                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in EPLI Pending Investigation and Litigation Summary Report , " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
        }

        //Report 17
        private void BindImmediatelyReportableClaims(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(17, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = dtUser.Rows[0]["FIRST_NAME"].ToString();
                        strLastName = dtUser.Rows[0]["LAST_NAME"].ToString();
                        strMailFrom = dtUser.Rows[0]["Email"].ToString();

                        // get result records from database for the report
                        DataSet dsReport = Report.Get_Reportable_Claims_Report();

                        //Create HTML for the report and wirte into HTML Write object
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        #region "Header"

                        //Add Report Title and Schedule Date
                        strHTML.Append("<span style=\"font-family:Calibri;\">");
                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : FINPRO Immediately Reportable Claims</b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"]).ToString();
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        //Add Header HTML
                        strHTML.Append("<div style=\"overflow-x:scroll;overflow-y:hidden;width:1200px;\">");
                        strHTML.Append("<table cellpadding='4' cellspacing='0' style='font-weight: bold;font-family:Calibri;' width='3150px' border='1'><tr>");
                        strHTML.Append("<td><table><tr>");
                        strHTML.Append("<td style='width: 150px;font-weight: bold;' align='left'>Type of Allegation</td>");
                        strHTML.Append("<td style='width: 250px;font-weight: bold;' align='left'>Claim Description</td>");
                        strHTML.Append("<td style='width: 100px;font-weight: bold;' align='left'>Carrier</td>");
                        strHTML.Append("<td style='width: 150px;font-weight: bold;' align='left'>Type of Claim</td>");
                        strHTML.Append("<td style='width: 150px;font-weight: bold;' align='left'>Policy Number</td>");
                        strHTML.Append("<td style='width: 250px;font-weight: bold;' align='right'>Deductible</td>");
                        strHTML.Append("<td style='width: 150px;font-weight: bold;' align='left'>Date of Alleged Wrongful Act</td>");
                        strHTML.Append("<td style='width: 200px;font-weight: bold;' align='left'>Date Claim Opened</td>");
                        strHTML.Append("<td style='width: 200px;font-weight: bold;' align='left'>Policy Effective Date</td>");
                        strHTML.Append("<td style='width: 150px;font-weight: bold;' align='left'>Policy Expiration Date</td>");
                        strHTML.Append("<td style='width: 250px;font-weight: bold;' align='right'>Estimated Demand Exposure</td>");
                        strHTML.Append("<td style='width: 350px;font-weight: bold;' align='left'>Claim Status/Comments</td>");
                        strHTML.Append("<td style='width: 150px;font-weight: bold;' align='left'>Internal Counsel</td>");
                        strHTML.Append("<td style='width: 200px;font-weight: bold;' align='left'>Internal Counsel Phone</td>");
                        strHTML.Append("<td style='width: 250px;font-weight: bold;' align='left'>Location Code</td>");
                        strHTML.Append("<td style='width: 250px;font-weight: bold;' align='left'>Sonic Location Name</td>");
                        strHTML.Append("<td style='width: 250px;font-weight: bold;' align='left'>Location dba</td>");
                        strHTML.Append("<td style='width: 250px;font-weight: bold;' align='left'>Entity</td>");
                        strHTML.Append("<td style='width: 200px;font-weight: bold;' align='left'>Defense Attorney</td>");
                        strHTML.Append("</tr></table></td>");
                        strHTML.Append("</tr>");
                        #endregion

                        DataTable dtReportData = dsReport.Tables[0];
                        DataTable dtRegion = dsReport.Tables[1];
                        DataTable dtTotal = dsReport.Tables[2];
                        if (dtRegion.Rows.Count > 0)
                        {
                            //Add Report Data Table 
                            //strHTML.Append("<table style='width: 3150px;' border='1' align='left' cellpadding='4' cellspacing='0'>");
                            foreach (DataRow drRegion in dtRegion.Rows)
                            {
                                strHTML.Append("<tr valign='top'><td><table width='100%' cellpadding='0' cellspacing='0' border='0'>");
                                strHTML.Append("<tr><td colspan='19' style='font-family:Calibri;'><b>");
                                strHTML.Append(drRegion["Region"].ToString());
                                strHTML.Append("</b></td></tr>");
                                strHTML.Append("<tr><td>");
                                strHTML.Append("<table style='width: 3150px;font-family:Calibri;' border='1' cellpadding='4' cellspacing='0'>");
                                DataRow[] drDataByRegion = dtReportData.Select("Region='" + drRegion["Region"].ToString() + "'");
                                foreach (DataRow drData in drDataByRegion)
                                {
                                    strHTML.Append("<tr style='background-color:#FFFFFF;'>");
                                    strHTML.Append("<td style='width: 150px;' align='left'>" + drData["Type_of_Allegation"] + "</td>");
                                    strHTML.Append("<td style='width: 250px;' align='left'>" + drData["Claim_Description"] + "</td>");
                                    strHTML.Append("<td style='width: 100px;' align='left'>" + drData["Carrier"] + "</td>");
                                    strHTML.Append("<td style='width: 150px;' align='left'>" + drData["Type_Of_Claim"] + "</td>");
                                    strHTML.Append("<td style='width: 150px;' align='left'>" + drData["Primary_Insurance_Policy_Number"] + "</td>");
                                    strHTML.Append("<td style='width: 250px;' align='right'>$ " + string.Format("{0:N2}", drData["Primary_Deductable"]) + "</td>");
                                    //Convert.ToDateTime(System.Data.SqlTypes.SqlDateTime.MinValue.ToString())
                                    if (Convert.ToDateTime(drData["Date_Alleged_Wrongful_Act"]) != Convert.ToDateTime(System.Data.SqlTypes.SqlDateTime.MinValue.ToString()))
                                    {
                                        strHTML.Append("<td style='width: 150px;' align='left'>" + Convert.ToDateTime(drData["Date_Alleged_Wrongful_Act"]).ToString(DateDisplayFormat) + "</td>");
                                    }
                                    else
                                    {
                                        strHTML.Append("<td style='width: 150px;' align='left'>&nbsp;</td>");
                                    }

                                    if (Convert.ToDateTime(drData["Claim_Open_Date"]) != Convert.ToDateTime(System.Data.SqlTypes.SqlDateTime.MinValue.ToString()))
                                    {
                                        strHTML.Append("<td style='width: 200px;' align='left'>" + Convert.ToDateTime(drData["Claim_Open_Date"]).ToString(DateDisplayFormat) + "</td>");
                                    }
                                    else
                                    {
                                        strHTML.Append("<td style='width: 1200px;' align='left'>&nbsp;</td>");
                                    }

                                    if (Convert.ToDateTime(drData["Primary_Policy_Effective_Date"]) != Convert.ToDateTime(System.Data.SqlTypes.SqlDateTime.MinValue.ToString()))
                                    {
                                        strHTML.Append("<td style='width: 200px;' align='left'>" + Convert.ToDateTime(drData["Primary_Policy_Effective_Date"]).ToString(DateDisplayFormat) + "</td>");
                                    }
                                    else
                                    {
                                        strHTML.Append("<td style='width: 200px;' align='left'>&nbsp;</td>");
                                    }

                                    if (Convert.ToDateTime(drData["Primary_Policy_Expiration_Date"]) != Convert.ToDateTime(System.Data.SqlTypes.SqlDateTime.MinValue.ToString()))
                                    {
                                        strHTML.Append("<td style='width: 150px;' align='left'>" + Convert.ToDateTime(drData["Primary_Policy_Expiration_Date"]).ToString(DateDisplayFormat) + "</td>");
                                    }
                                    else
                                    {
                                        strHTML.Append("<td style='width: 150px;' align='left'>&nbsp;</td>");
                                    }
                                    strHTML.Append("<td style='width: 250px;' align='right'>$ " + string.Format("{0:N2}", drData["Estimated_Demand_Exposure"]) + "</td>");
                                    strHTML.Append("<td style='width: 350px;' align='left'>" + drData["Claim_Status_Comments"] + "</td>");
                                    strHTML.Append("<td style='width: 150px;' align='left'>" + drData["Internal_Counsel"] + "</td>");
                                    strHTML.Append("<td style='width: 200px;' align='left'>" + drData["Legal_Telephone"] + "</td>");

                                    strHTML.Append("<td style='width: 250px;' align='left'>" + drData["Sonic_Location_Code"] + "</td>");
                                    strHTML.Append("<td style='width: 250px;' align='left'>" + drData["legal_entity"] + "</td>");
                                    strHTML.Append("<td style='width: 250px;' align='left'>" + drData["dba"] + "</td>");
                                    strHTML.Append("<td style='width: 250px;' align='left'>" + drData["Entity"] + "</td>");
                                    strHTML.Append("<td style='width: 200px;' align='left'>" + drData["Firm"] + "</td>");
                                    strHTML.Append("</tr>");
                                }
                                strHTML.Append("<tr style='background-color:#FFFFFF;'>");
                                strHTML.Append("<td style='width: 150px;border:thin' align='left'><b>Total</b></td>");
                                strHTML.Append("<td style='width: 250px;border:thin' align='left'><b>" + drRegion["Total"].ToString() + "</b></td>");
                                strHTML.Append("<td style='width: 100px;border:thin' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 150px;border:thin' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 150px;border:thin' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 250px;border:thin' align='right'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 150px;border:thin' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 200px;border:thin' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 200px;border:thin' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 150px;border:thin' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 250px;border:thin' align='right'><b>$ " + string.Format("{0:N2}", drRegion["Total_Exposure"]) + "</b></td>");
                                strHTML.Append("<td style='width: 350px;border:thin' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 150px;border:thin' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 200px;border:thin' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 250px;border:thin' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 250px;border:thin' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 250px;border:thin' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 250px;border:thin' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 200px;border:thin' align='left'>&nbsp;</td>");
                                strHTML.Append("</tr>");
                                strHTML.Append("</table>");
                                strHTML.Append("</td></tr>");
                                strHTML.Append("</table>");
                                strHTML.Append("</td></tr>");
                            }
                            strHTML.Append("<tr style='background-color:#507cd1;font-family:Calibri;color:White;'>");
                            strHTML.Append("<td style='width: 150px;border:thin' align='left'><b>Grand Total</b></td>");
                            strHTML.Append("<td style='width: 250px;border:thin' align='left'><b>" + dtTotal.Rows[0]["Total"].ToString() + "</b></td>");
                            strHTML.Append("<td style='width: 100px;border:thin' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 150px;border:thin' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 150px;border:thin' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 250px;border:thin' align='right'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 150px;border:thin' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 200px;border:thin' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 200px;border:thin' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 150px;border:thin' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 250px;border:thin' align='right'><b>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["Total_Exposure"]) + "</b></td>");
                            strHTML.Append("<td style='width: 350px;border:thin' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 150px;border:thin' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 200px;border:thin' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 250px;border:thin' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 200px;border:thin' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 200px;border:thin' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 200px;border:thin' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 200px;border:thin' align='left'>&nbsp;</td>");
                            strHTML.Append("</tr>");
                            //strHTML.Append("</table>");
                            //strHTML.Append("</td></tr>");
                            strHTML.Append("</table>");
                        }
                        else
                        {
                            //Add No record found line for year
                            strHTML.Append("<tr><td align='left' style='border:thin' colspan='19'>No Record Found!</td></tr>");
                        }

                        strHTML.Append("</div>");

                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        //isGrid = true;
                        SendMail("FINPRO Immediately Reportable Claims Report", "ImmediatelyReportableClaimsReport.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
                        //isGrid = false;

                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in Immediately Reportable Claims Report, " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
        }

        //Report 18
        private void BindNetworkCallSummaryReport(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(18, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = dtUser.Rows[0]["FIRST_NAME"].ToString();
                        strLastName = dtUser.Rows[0]["LAST_NAME"].ToString();
                        strMailFrom = dtUser.Rows[0]["Email"].ToString();
                        string strMarket = null;
                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Market"])))
                        {
                            strMarket = Convert.ToString(dtFilter.Rows[0]["Market"]).Trim();
                        }
                        // get start date
                        DateTime Start_Date = Convert.ToDateTime(dtFilter.Rows[0]["Start_Date"]);
                        // get end date
                        DateTime End_Date = Convert.ToDateTime(dtFilter.Rows[0]["End_Date"]);

                        // get result records from database for the report
                        DataSet dsReport = Report.Get_Network_Call_Summary_Report(Start_Date, End_Date, Convert.ToString(dtFilter.Rows[0]["Region"]), strMarket);

                        //Create HTML for the report and wirte into HTML Write object
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        #region "Header"

                        //Retrieve Market Values
                        string strMarketString = string.Empty;
                        if (string.IsNullOrEmpty(strMarket))
                        {
                            strMarketString = "All Market";
                        }
                        else
                        {
                            string[] strMar = strMarket.Split(Convert.ToChar(","));
                            for (int i = 0; i < strMar.Length; i++)
                            {
                                strMarketString += Report.SelectMarketInfoById(Convert.ToDecimal(strMar[i].ToString())).Tables[0].Rows[0]["Market"].ToString() + ",";
                            }
                            strMarketString = strMarketString.TrimEnd(',');
                        }

                        //Add Report Title and Schedule Date
                        strHTML.Append("<table><tr><td colspan='7'>");
                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : FINPRO Network Call Summary Report</b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"]).ToString();
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        //Add Report Filter Criteria 
                        strHTML.Append("<br /><br />");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Date Claim Opened Between " + Start_Date.ToString(DateDisplayFormat) + " and " + End_Date.ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Regions              : " + (string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Region"])) ? "All" : dtFilter.Rows[0]["Region"].ToString()));
                        strHTML.Append("<br />");
                        strHTML.Append("Markets        : " + strMarketString);
                        strHTML.Append("<br /><br />");
                        strHTML.Append("</td></tr></table>");

                        //Add Header HTML
                        strHTML.Append("<div style=\"overflow-x:scroll;overflow-y:hidden;width:1300px;\">");
                        strHTML.Append("<table cellpadding='4' cellspacing='0' style='font-weight: bold;font-family:Calibri;' width='1300px' border='1'><tr>");
                        strHTML.Append("<td style='width: 150px;' align='left'>Date Claim Opened</td>");
                        strHTML.Append("<td style='width: 250px;' align='left'>Type of Allegation</td>");
                        strHTML.Append("<td style='width: 250px;' align='left'>Complainant/Plaintiff</td>");
                        strHTML.Append("<td style='width: 230px;' align='left'>Store/Facility</td>");
                        strHTML.Append("<td style='width: 250px;' align='left'>Claim Description</td>");
                        strHTML.Append("<td style='width: 250px;' align='left'>Claim Status/Comments</td>");
                        strHTML.Append("<td style='width: 150px;' align='left'>HR Contact Name</td>");
                        strHTML.Append("</tr></table>");
                        #endregion

                        DataTable dtReportData = dsReport.Tables[0];
                        DataTable dtRegion = dsReport.Tables[1];
                        DataTable dtTotal = dsReport.Tables[2];
                        if (dtRegion.Rows.Count > 0)
                        {
                            //Add Report Data Table 
                            strHTML.Append("<table style='width: 1400px;' border='1' cellpadding='4' cellspacing='0'>");
                            foreach (DataRow drRegion in dtRegion.Rows)
                            {
                                strHTML.Append("<tr><td colspan='7' style='font-family:Calibri;'><b>");
                                strHTML.Append(drRegion["Region"].ToString());
                                strHTML.Append("</b></td></tr>");
                                strHTML.Append("<tr><td colspan='7'>");
                                strHTML.Append("<table style='width: 1400px;font-family:Calibri;' border='1' cellpadding='4' cellspacing='0'>");
                                DataRow[] drDataByRegion = dtReportData.Select("Region='" + drRegion["Region"].ToString() + "'");
                                foreach (DataRow drData in drDataByRegion)
                                {
                                    strHTML.Append("<tr style='background-color:#FFFFFF;'>");
                                    if (Convert.ToDateTime(drData["Claim_Open_Date"]) != Convert.ToDateTime(System.Data.SqlTypes.SqlDateTime.MinValue.ToString()))
                                    {
                                        strHTML.Append("<td style='width: 150px;' align='left'>" + Convert.ToDateTime(drData["Claim_Open_Date"]).ToString(DateDisplayFormat) + "</td>");
                                    }
                                    else
                                    {
                                        strHTML.Append("<td style='width: 150px;' align='left'>&nbsp;</td>");
                                    }
                                    strHTML.Append("<td style='width: 250px;' align='left'>" + drData["Type_of_Allegation"] + "</td>");
                                    strHTML.Append("<td style='width: 250px;' align='left'>" + drData["Complainant_Plaintiff"] + "</td>");
                                    strHTML.Append("<td style='width: 230px;' align='left'> " + drData["Location_Description"] + "</td>");
                                    strHTML.Append("<td style='width: 250px;' align='left'>" + drData["Claim_Description"] + "</td>");
                                    strHTML.Append("<td style='width: 250px;' align='left'>" + drData["Claim_Status_Comments"] + "</td>");
                                    strHTML.Append("<td style='width: 150px;' align='left'>" + drData["Contact_Name"] + "</td>");
                                    strHTML.Append("</tr>");
                                }
                                strHTML.Append("<tr style='background-color:#FFFFFF;'>");
                                strHTML.Append("<td style='width: 150px;' align='left'><b>Total</b></td>");
                                strHTML.Append("<td style='width: 250px;' align='left'><b>" + drRegion["Total"].ToString() + "</b></td>");
                                strHTML.Append("<td style='width: 250px;' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 230px;' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 250px;' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 250px;' align='left'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 150px;' align='left'>&nbsp;</td>");
                                strHTML.Append("</tr>");
                                strHTML.Append("</table>");
                                strHTML.Append("</td></tr>");
                            }
                            strHTML.Append("<tr style='background-color:#507cd1;font-family:Calibri;color:White;'>");
                            strHTML.Append("<td style='width: 150px;' align='left'><b>Grand Total</b></td>");
                            strHTML.Append("<td style='width: 250px;' align='left'><b>" + dtTotal.Rows[0]["Total"].ToString() + "</b></td>");
                            strHTML.Append("<td style='width: 250px;' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 230px;' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 250px;' align='left'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 250px;' align='lef'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 150px;' align='left'>&nbsp;</td>");
                            strHTML.Append("</tr>");
                            strHTML.Append("</table>");
                            strHTML.Append("</td></tr>");
                            strHTML.Append("</table>");
                        }
                        else
                        {
                            //Add No record found line for year
                            strHTML.Append("<tr><td align='left' style='border:thin' colspan='7'>No Record Found!</td></tr>");
                        }

                        strHTML.Append("</div>");

                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        SendMail("FINPRO Network Call Summary Report", "NetworkCallSummaryReport.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);


                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in Network Call Summary Report, " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
        }

        //Report 19
        private void BindWCAllocationDetailReport(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(19, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = dtUser.Rows[0]["FIRST_NAME"].ToString();
                        strLastName = dtUser.Rows[0]["LAST_NAME"].ToString();
                        strMailFrom = dtUser.Rows[0]["Email"].ToString();

                        // get start date
                        Decimal Year = Convert.ToDecimal(dtFilter.Rows[0]["Year"]);
                        // get end date
                        Decimal Month = Convert.ToDecimal(dtFilter.Rows[0]["Month"]);
                        // get Region
                        string strRegion = dtFilter.Rows[0]["Region"].ToString();

                        // get result records from database for the report
                        DataSet dsReport = Report.GetWCAllocationDetailData(Convert.ToInt32(Year), Convert.ToInt32(Month), strRegion);

                        //Create HTML for the report and wirte into HTML Write object
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        #region "Header"

                        //Add Report Title and Schedule Date
                        strHTML.Append("<span style=\"font-family:Calibri;\">");
                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : WC Allocation Detail Report</b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"]).ToString();
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        //Add Report Filter Criteria 
                        strHTML.Append("<br /><br />");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Year        : " + Year);
                        strHTML.Append("<br />");
                        strHTML.Append("Month          : " + GetMonthString(Convert.ToInt32(Month)));
                        strHTML.Append("<br />");
                        strHTML.Append("Regions              : " + strRegion.TrimStart(Convert.ToChar(",")).Replace("'", ""));
                        strHTML.Append("<br /><br />");
                        strHTML.Append("</span>");

                        //Add Header HTML
                        strHTML.Append("<table cellpadding='4' cellspacing='0' style='font-weight: bold;font-family:Calibri;' width='100%' border='1'>");
                        strHTML.Append("<tr>");
                        strHTML.Append("<td colspan='11' align='center'>Sonic Automotive WC Loss Allocation Report (First Report Only)</td>");
                        strHTML.Append("</tr>");
                        strHTML.Append("<tr>");
                        strHTML.Append("<td style='width: 13%;' align='left' valign='top'>Location</td>");
                        strHTML.Append("<td style='width: 8%;' align='left' valign='top'>First Report<br/>Number</td>");
                        strHTML.Append("<td style='width: 10%;' align='left' valign='top'>Employee</td>");
                        strHTML.Append("<td style='width: 13%;' align='left' valign='top'>Cause of Incident</td>");
                        strHTML.Append("<td style='width: 8%;' align='left' valign='top'>Date of Incident</td>");
                        strHTML.Append("<td style='width: 8%;' align='left' valign='top'>Date Reported to Sonic</td>");
                        strHTML.Append("<td style='width: 8%;' align='right' valign='top'>Report Lag</td>");
                        strHTML.Append("<td style='width: 8%;' align='right' valign='top'>Claim Charge</td>");
                        strHTML.Append("<td style='width: 8%;' align='right' valign='top'>Penalty Charge</td>");
                        strHTML.Append("<td style='width: 8%;' align='right' valign='top'>Performance Credit</td>");
                        strHTML.Append("<td style='width: 8%;' align='right' valign='top'>Total Charge</td>");
                        strHTML.Append("</tr></table>");
                        #endregion

                        DataTable dtReportData = dsReport.Tables[0];
                        DataTable dtRegion = dsReport.Tables[1];
                        DataTable dtTotal = dsReport.Tables[2];
                        if (dtRegion.Rows.Count > 0)
                        {
                            //Add Report Data Table 
                            strHTML.Append("<table style='width: 100%;' border='1' align='left' cellpadding='4' cellspacing='0'>");
                            foreach (DataRow drRegion in dtRegion.Rows)
                            {
                                strHTML.Append("<tr><td colspan='11' style='font-family:Calibri;'><b>Region : ");
                                strHTML.Append(drRegion["Region"].ToString());
                                strHTML.Append("</b></td></tr>");
                                strHTML.Append("<tr><td colspan='11'>");
                                strHTML.Append("<table style='width: 100%;font-family:Calibri;' border='1' align='left' cellpadding='4' cellspacing='0'>");
                                DataRow[] drDataByRegion = dtReportData.Select("Region='" + drRegion["Region"].ToString() + "'");
                                foreach (DataRow drData in drDataByRegion)
                                {
                                    strHTML.Append("<tr style='background-color:#FFFFFF;'>");
                                    strHTML.Append("<td style='width: 13%;' align='left' valign='top'>" + drData["dba"] + "</td>");
                                    strHTML.Append("<td style='width: 8%;' align='left' valign='top'>WC-" + drData["WC_FR_Number"] + "</td>");
                                    strHTML.Append("<td style='width: 10%;' align='left' valign='top'>" + drData["Employee_Name"] + "</td>");
                                    strHTML.Append("<td style='width: 13%;' align='left' valign='top'>" + drData["Sonic_Cause_Code"] + "</td>");
                                    if (Convert.ToDateTime(drData["Date_Of_Incident"]) != Convert.ToDateTime(System.Data.SqlTypes.SqlDateTime.MinValue.ToString()))
                                    {
                                        strHTML.Append("<td style='width: 8%;' align='left' valign='top'>" + Convert.ToDateTime(drData["Date_Of_Incident"]).ToString(DateDisplayFormat) + "</td>");
                                    }
                                    else
                                    {
                                        strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                    }

                                    if (Convert.ToDateTime(drData["Date_Reported_To_Sonic"]) != Convert.ToDateTime(System.Data.SqlTypes.SqlDateTime.MinValue.ToString()))
                                    {
                                        strHTML.Append("<td style='width: 8%;' align='left' valign='top'>" + Convert.ToDateTime(drData["Date_Reported_To_Sonic"]).ToString(DateDisplayFormat) + "</td>");
                                    }
                                    else
                                    {
                                        strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                    }
                                    strHTML.Append("<td style='width: 8%;' align='right' valign='top'>" + string.Format("{0:N0}", drData["Report_Lag"]) + "</td>");
                                    strHTML.Append("<td style='width: 8%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["claimCharge"]) + "</td>");
                                    strHTML.Append("<td style='width: 8%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["PenaltyCharge"]) + "</td>");
                                    strHTML.Append("<td style='width: 8%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["PerformanceCredit"]) + "</td>");
                                    strHTML.Append("<td style='width: 8%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["TotalCharge"]) + "</td>");
                                    strHTML.Append("</tr>");
                                }
                                strHTML.Append("<tr style='background-color:#FFFFFF;'>");
                                strHTML.Append("<td style='width: 13%;' align='left' valign='top'><b>Total</b></td>");
                                strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 10%;' align='left' valign='top'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 13%;' align='left' valign='top'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>" + string.Format("{0:N0}", drRegion["Report_Lag"]) + "</b></td>");
                                strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", drRegion["claimCharge"]) + "</b></td>");
                                strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", drRegion["PenaltyCharge"]) + "</b></td>");
                                strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", drRegion["PerformanceCredit"]) + "</b></td>");
                                strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", drRegion["TotalCharge"]) + "</b></td>");
                                strHTML.Append("</tr>");
                                strHTML.Append("</table>");
                                strHTML.Append("</td></tr>");
                            }
                            strHTML.Append("<tr style='background-color:#507cd1;font-family:Calibri;color:White;'>");
                            strHTML.Append("<td style='width: 13%;' align='left' valign='top'><b>Grand Total</b></td>");
                            strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 10%;' align='left' valign='top'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 13%;' align='left' valign='top'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>" + string.Format("{0:N0}", dtTotal.Rows[0]["Report_Lag"]) + "</b></td>");
                            strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["claimCharge"]) + "</b></td>");
                            strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["PenaltyCharge"]) + "</b></td>");
                            strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["PerformanceCredit"]) + "</b></td>");
                            strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["TotalCharge"]) + "</b></td>");
                            strHTML.Append("</tr>");
                            strHTML.Append("</table>");
                            strHTML.Append("</td></tr>");
                            strHTML.Append("</table>");
                        }
                        else
                        {
                            //Add No record found line for year
                            strHTML.Append("<tr><td align='left' colspan='16'>No Record Found!</td></tr>");
                        }


                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        SendMail("WC Allocation Detail Report", "WCAllocationDetailReport.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);

                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in WC Allocation Detail Report, " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
        }

        //Report 20
        private void BindWCAllocationSummaryReport(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(20, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = dtUser.Rows[0]["FIRST_NAME"].ToString();
                        strLastName = dtUser.Rows[0]["LAST_NAME"].ToString();
                        strMailFrom = dtUser.Rows[0]["Email"].ToString();

                        // get start date
                        Decimal Year = Convert.ToDecimal(dtFilter.Rows[0]["Year"]);

                        // get result records from database for the report
                        DataSet dsReport = Report.GetWC_Allocation_Location_Summary_Report(Year);

                        //Create HTML for the report and wirte into HTML Write object
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        #region "Header"

                        //Add Report Title and Schedule Date
                        strHTML.Append("<span style=\"font-family:Calibri;\">");
                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : WC Allocation Summary Report</b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"]).ToString();
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        //Add Report Filter Criteria 
                        strHTML.Append("<br /><br />");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Year        : " + Year);
                        strHTML.Append("<br /><br />");
                        strHTML.Append("</span>");

                        //Add Header HTML
                        strHTML.Append("<table cellpadding='4' cellspacing='0' style='font-weight: bold;font-family:Calibri;' width='100%' border='1'>");
                        strHTML.Append("<tr>");
                        strHTML.Append("<td style='width: 6%;' align='left' valign='top'>Dealership</td>");
                        strHTML.Append("<td style='width: 3%;' align='left' valign='top'>Location<br/>Code</td>");
                        strHTML.Append("<td style='width: 7%;' align='right' valign='top'>JAN'" + Year.ToString().Substring(2, 2) + "</td>");
                        strHTML.Append("<td style='width: 7%;' align='right' valign='top'>FEB'" + Year.ToString().Substring(2, 2) + "</td>");
                        strHTML.Append("<td style='width: 7%;' align='right' valign='top'>MAR'" + Year.ToString().Substring(2, 2) + "</td>");
                        strHTML.Append("<td style='width: 7;' align='right' valign='top'>APR'" + Year.ToString().Substring(2, 2) + "</td>");
                        strHTML.Append("<td style='width: 7%;' align='right' valign='top'>MAY'" + Year.ToString().Substring(2, 2) + "</td>");
                        strHTML.Append("<td style='width: 7%;' align='right' valign='top'>JUN'" + Year.ToString().Substring(2, 2) + "</td>");
                        strHTML.Append("<td style='width: 7%;' align='right' valign='top'>JUL'" + Year.ToString().Substring(2, 2) + "</td>");
                        strHTML.Append("<td style='width: 7%;' align='right' valign='top'>AUG'" + Year.ToString().Substring(2, 2) + "</td>");
                        strHTML.Append("<td style='width: 7%;' align='right' valign='top'>SEP'" + Year.ToString().Substring(2, 2) + "</td>");
                        strHTML.Append("<td style='width: 7%;' align='right' valign='top'>OCT'" + Year.ToString().Substring(2, 2) + "</td>");
                        strHTML.Append("<td style='width: 7%;' align='right' valign='top'>NOV'" + Year.ToString().Substring(2, 2) + "</td>");
                        strHTML.Append("<td style='width: 7%;' align='right' valign='top'>DEC'" + Year.ToString().Substring(2, 2) + "</td>");
                        strHTML.Append("<td style='width: 7%;' align='right' valign='top'>Total Count'" + Year.ToString().Substring(2, 2) + "</td>");
                        strHTML.Append("</tr></table>");
                        #endregion

                        DataTable dtReportData = dsReport.Tables[0];
                        DataTable dtTotal = dsReport.Tables[1];
                        if (dtReportData.Rows.Count > 0)
                        {
                            //Add Report Data Table 
                            strHTML.Append("<table style='width: 100%;' border='1' align='left' cellpadding='4' cellspacing='0'>");
                            //foreach (DataRow drRegion in dtRegion.Rows)
                            //{
                            strHTML.Append("<tr><td colspan='15'>");
                            strHTML.Append("<table style='width: 100%;font-family:Calibri;' border='1' align='left' cellpadding='4' cellspacing='0'>");
                            foreach (DataRow drData in dtReportData.Rows)
                            {
                                strHTML.Append("<tr style='background-color:#FFFFFF;'>");
                                strHTML.Append("<td style='width: 6%;' align='left' valign='top'>" + drData["dba"] + "</td>");
                                strHTML.Append("<td style='width: 3%;' align='left' valign='top'>" + drData["sonic_location_code"] + "</td>");
                                strHTML.Append("<td style='width: 7%;' align='left' valign='top'>$ " + string.Format("{0:N2}", drData["JAN"]) + "</td>");
                                strHTML.Append("<td style='width: 7%;' align='left' valign='top'>$ " + string.Format("{0:N2}", drData["FEB"]) + "</td>");
                                strHTML.Append("<td style='width: 7%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["MAR"]) + "</td>");
                                strHTML.Append("<td style='width: 7%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["APR"]) + "</td>");
                                strHTML.Append("<td style='width: 7%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["MAY"]) + "</td>");
                                strHTML.Append("<td style='width: 7%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["JUN"]) + "</td>");
                                strHTML.Append("<td style='width: 7%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["JUL"]) + "</td>");
                                strHTML.Append("<td style='width: 7%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["AUG"]) + "</td>");
                                strHTML.Append("<td style='width: 7%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["SEP"]) + "</td>");
                                strHTML.Append("<td style='width: 7%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["OCT"]) + "</td>");
                                strHTML.Append("<td style='width: 7%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["NOV"]) + "</td>");
                                strHTML.Append("<td style='width: 7%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["DEC"]) + "</td>");
                                strHTML.Append("<td style='width: 7%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["Total_Count"]) + "</td>");
                                strHTML.Append("</tr>");
                            }
                            strHTML.Append("<tr style='background-color:#507cd1;font-weight:bold;font-family:Calibri;color:White;'>");
                            strHTML.Append("<td style='width: 6%;' align='left' valign='top'>Total</td>");
                            strHTML.Append("<td style='width: 3%;' align='left' valign='top'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 7%;' align='left' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["JAN"]) + "</td>");
                            strHTML.Append("<td style='width: 7%;' align='left' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["FEB"]) + "</td>");
                            strHTML.Append("<td style='width: 7%;' align='right' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["MAR"]) + "</td>");
                            strHTML.Append("<td style='width: 7%;' align='right' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["APR"]) + "</td>");
                            strHTML.Append("<td style='width: 7%;' align='right' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["MAY"]) + "</td>");
                            strHTML.Append("<td style='width: 7%;' align='right' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["JUN"]) + "</td>");
                            strHTML.Append("<td style='width: 7%;' align='right' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["JUL"]) + "</td>");
                            strHTML.Append("<td style='width: 7%;' align='right' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["AUG"]) + "</td>");
                            strHTML.Append("<td style='width: 7%;' align='right' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["SEP"]) + "</td>");
                            strHTML.Append("<td style='width: 7%;' align='right' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["OCT"]) + "</td>");
                            strHTML.Append("<td style='width: 7%;' align='right' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["NOV"]) + "</td>");
                            strHTML.Append("<td style='width: 7%;' align='right' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["DEC"]) + "</td>");
                            strHTML.Append("<td style='width: 7%;' align='right' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["Total_Count"]) + "</td>");
                            strHTML.Append("</tr>");
                            strHTML.Append("</table>");
                            strHTML.Append("</td></tr>");
                            //}
                            strHTML.Append("</table>");
                            strHTML.Append("</td></tr>");
                            strHTML.Append("</table>");
                        }
                        else
                        {
                            //Add No record found line for year
                            strHTML.Append("<tr><td align='left' colspan='16'>No Record Found!</td></tr>");
                        }


                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        SendMail("WC Allocation Summary Report", "WCAllocationSummaryReport.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);


                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in WC Allocation Detail Report, " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
        }

        //Report 21
        private void BindWCAllocationLocationReport(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(21, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = dtUser.Rows[0]["FIRST_NAME"].ToString();
                        strLastName = dtUser.Rows[0]["LAST_NAME"].ToString();
                        strMailFrom = dtUser.Rows[0]["Email"].ToString();

                        // get start date
                        Decimal Year = Convert.ToDecimal(dtFilter.Rows[0]["Year"]);
                        // get end date
                        Decimal Month = Convert.ToDecimal(dtFilter.Rows[0]["Month"]);
                        // get Region
                        Decimal Location = Convert.ToDecimal(dtFilter.Rows[0]["Location"]);
                        // get result records from database for the report
                        DataSet dsReport = Report.GetWC_Allocation_Location_Report(Year, Month, Location);

                        //Create HTML for the report and wirte into HTML Write object
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        #region "Header"

                        //Add Report Title and Schedule Date
                        strHTML.Append("<span style=\"font-family:Calibri;\">");
                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : WC Allocation Location Report</b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"]).ToString();
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        DataTable dtLocationInfo = Report.SelectLocationInfoById(Location).Tables[0];
                        //Add Report Filter Criteria 
                        strHTML.Append("<br /><br />");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Year        : " + Year);
                        strHTML.Append("<br />");
                        strHTML.Append("Month          : " + GetMonthString(Convert.ToInt32(Month)));
                        strHTML.Append("<br />");
                        strHTML.Append("Location              : " + dtLocationInfo.Rows[0]["dba"].ToString());
                        strHTML.Append("<br /><br />");
                        strHTML.Append("</span>");

                        //Add Header HTML
                        strHTML.Append("<table cellpadding='4' cellspacing='0' style='font-weight: bold;font-family:Calibri;' width='100%' border='1'>");
                        strHTML.Append("<tr>");
                        strHTML.Append("<td style='width: 7%;' align='left' valign='top'>Claim Number</td>");
                        strHTML.Append("<td style='width: 4%;' align='left' valign='top'>Employee</td>");
                        strHTML.Append("<td style='width: 9%;' align='left' valign='top'>Cause of Incident</td>");
                        strHTML.Append("<td style='width: 8%;' align='left' valign='top'>Date of Loss</td>");
                        strHTML.Append("<td style='width: 8%;' align='left' valign='top'>Date Reported</td>");
                        strHTML.Append("<td style='width: 8%;' align='right' valign='top'>Report Lag</td>");
                        strHTML.Append("<td style='width: 8%;' align='left' valign='top'>Date Claim Opened</td>");
                        strHTML.Append("<td style='width: 8%;' align='left' valign='top'>Date Claim Closed</td>");
                        strHTML.Append("<td style='width: 8%;' align='left' valign='top'>Date Claim Reopened</td>");
                        strHTML.Append("<td style='width: 8%;' align='right' valign='top'>Claim Charge</td>");
                        strHTML.Append("<td style='width: 8%;' align='right' valign='top'>Penalty Charge</td>");
                        strHTML.Append("<td style='width: 8%;' align='right' valign='top'>Performance Credit</td>");
                        strHTML.Append("<td style='width: 8%;' align='right' valign='top'>Total Charge</td>");
                        strHTML.Append("</tr></table>");
                        #endregion

                        DataTable dtReportData = dsReport.Tables[0];
                        //DataTable dtTotal = dsReport.Tables[1];
                        if (dtReportData.Rows.Count > 0)
                        {
                            //Add Report Data Table 
                            strHTML.Append("<table style='width: 100%;' border='1' align='left' cellpadding='4' cellspacing='0'>");
                            //foreach (DataRow drRegion in dtRegion.Rows)
                            //{
                            strHTML.Append("<tr><td colspan='13'>");
                            strHTML.Append("<table style='width: 100%;font-family:Calibri;' border='1' align='left' cellpadding='4' cellspacing='0'>");
                            foreach (DataRow drData in dtReportData.Rows)
                            {
                                strHTML.Append("<tr style='background-color:#FFFFFF;'>");
                                strHTML.Append("<td style='width: 7%;' align='left' valign='top'>" + drData["Claim_Number"] + "</td>");
                                strHTML.Append("<td style='width: 4%;' align='left' valign='top'>" + drData["Employee_Name"] + "</td>");
                                strHTML.Append("<td style='width: 9%;' align='left' valign='top'>" + drData["Cause_Injury_Body_Part_Description"] + "</td>");
                                if (Convert.ToDateTime(drData["Date_of_Accident"]) != Convert.ToDateTime(System.Data.SqlTypes.SqlDateTime.MinValue.ToString()))
                                {
                                    strHTML.Append("<td style='width: 8%;' align='left' valign='top'>" + Convert.ToDateTime(drData["Date_of_Accident"]).ToString(DateDisplayFormat) + "</td>");
                                }
                                else
                                {
                                    strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                }

                                if (Convert.ToDateTime(drData["Date_Reported_to_Insurer"]) != Convert.ToDateTime(System.Data.SqlTypes.SqlDateTime.MinValue.ToString()))
                                {
                                    strHTML.Append("<td style='width: 8%;' align='left' valign='top'>" + Convert.ToDateTime(drData["Date_Reported_to_Insurer"]).ToString(DateDisplayFormat) + "</td>");
                                }
                                else
                                {
                                    strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                }
                                strHTML.Append("<td style='width: 8%;' align='right' valign='top'>" + string.Format("{0:N0}", drData["Report_Lag"]) + "</td>");
                                if (Convert.ToDateTime(drData["Date_Entered"]) != Convert.ToDateTime(System.Data.SqlTypes.SqlDateTime.MinValue.ToString()))
                                {
                                    strHTML.Append("<td style='width: 8%;' align='left' valign='top'>" + Convert.ToDateTime(drData["Date_Entered"]).ToString(DateDisplayFormat) + "</td>");
                                }
                                else
                                {
                                    strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                }

                                if (Convert.ToDateTime(drData["Date_Closed"]) != Convert.ToDateTime(System.Data.SqlTypes.SqlDateTime.MinValue.ToString()))
                                {
                                    strHTML.Append("<td style='width: 8%;' align='left' valign='top'>" + Convert.ToDateTime(drData["Date_Closed"]).ToString(DateDisplayFormat) + "</td>");
                                }
                                else
                                {
                                    strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                }

                                if (drData["Date_claim_Reopened"] != DBNull.Value)
                                {
                                    if (Convert.ToDateTime(drData["Date_claim_Reopened"]) != Convert.ToDateTime(System.Data.SqlTypes.SqlDateTime.MinValue.ToString()))
                                        strHTML.Append("<td style='width: 8%;' align='left' valign='top'>" + Convert.ToDateTime(drData["Date_claim_Reopened"]).ToString(DateDisplayFormat) + "</td>");
                                    else
                                        strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                }
                                else
                                {
                                    strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                }
                                strHTML.Append("<td style='width: 8%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["Charge"]) + "</td>");
                                strHTML.Append("<td style='width: 8%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["Late_Penalty_Charge"]) + "</td>");
                                strHTML.Append("<td style='width: 8%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["Early_Reporting_Performance_Credit"]) + "</td>");
                                strHTML.Append("<td style='width: 8%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["Total_Charge"]) + "</td>");
                                strHTML.Append("</tr>");
                            }
                            //strHTML.Append("<tr style='background-color:#FFFFFF;font-weight:bold;'>");
                            //strHTML.Append("<td style='width: 6%;' align='left' valign='top'>Total</td>");
                            //strHTML.Append("<td style='width: 3%;' align='left' valign='top'>&nbsp;</td>");
                            //strHTML.Append("<td style='width: 7%;' align='left' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["JAN"]) + "</td>");
                            //strHTML.Append("<td style='width: 7%;' align='left' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["FEB"]) + "</td>");
                            //strHTML.Append("<td style='width: 7%;' align='right' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["MAR"]) + "</td>");
                            //strHTML.Append("<td style='width: 7%;' align='right' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["APR"]) + "</td>");
                            //strHTML.Append("<td style='width: 7%;' align='right' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["MAY"]) + "</td>");
                            //strHTML.Append("<td style='width: 7%;' align='right' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["JUN"]) + "</td>");
                            //strHTML.Append("<td style='width: 7%;' align='right' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["JUL"]) + "</td>");
                            //strHTML.Append("<td style='width: 7%;' align='right' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["AUG"]) + "</td>");
                            //strHTML.Append("<td style='width: 7%;' align='right' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["SEP"]) + "</td>");
                            //strHTML.Append("<td style='width: 7%;' align='right' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["OCT"]) + "</td>");
                            //strHTML.Append("<td style='width: 7%;' align='right' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["NOV"]) + "</td>");
                            //strHTML.Append("<td style='width: 7%;' align='right' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["DEC"]) + "</td>");
                            //strHTML.Append("<td style='width: 7%;' align='right' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["Total_Count"]) + "</td>");
                            //strHTML.Append("</tr>");
                            strHTML.Append("</table>");
                            strHTML.Append("</td></tr>");
                            //}
                            strHTML.Append("</table>");
                            strHTML.Append("</td></tr>");
                            strHTML.Append("</table>");
                        }
                        else
                        {
                            //Add No record found line for year
                            strHTML.Append("<tr><td align='left' colspan='13'>No Record Found!</td></tr>");
                        }


                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        SendMail("WC Allocation Location Report", "WCAllocationLocationReport.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);


                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in WC Allocation Location Report, " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
        }

        //Report 22
        private void BindWCAllocationMonthlyDetailReport(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(22, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = dtUser.Rows[0]["FIRST_NAME"].ToString();
                        strLastName = dtUser.Rows[0]["LAST_NAME"].ToString();
                        strMailFrom = dtUser.Rows[0]["Email"].ToString();

                        // get start date
                        int Year = Convert.ToInt32(dtFilter.Rows[0]["Year"]);
                        // get end date
                        int Month = Convert.ToInt32(dtFilter.Rows[0]["Month"]);
                        //get run report by name.
                        string strRun_Report_By = Convert.ToString(dtFilter.Rows[0]["Run_report_by"]);

                        if (string.IsNullOrEmpty(strRun_Report_By))
                            strRun_Report_By = "Region";

                        //Create HTML for the report and write into HTML Write object
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        #region "Header"

                        //Add Report Title and Schedule Date
                        strHTML.Append("<table><tr><td colspan='19'>");

                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : WC Allocation Monthly Detail Report</b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"]).ToString();
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        //Add Report Filter Criteria 
                        strHTML.Append("<br /><br />");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Year        : " + Year);
                        strHTML.Append("<br />");
                        strHTML.Append("Month          : " + GetMonthString(Convert.ToInt32(Month)));
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Run Report by : " + strRun_Report_By);
                        strHTML.Append("<br /><br />");

                        strHTML.Append("</td></tr></table>");

                        //Add Header HTML
                        strHTML.Append("<table cellpadding='4' cellspacing='0' style='font-weight: bold;font-family:Calibri;' width='100%' border='1'>");
                        strHTML.Append("<tr>");
                        strHTML.Append("<td colspan='19' align='center'>WC Allocation Monthly Detail Report</td>");
                        strHTML.Append("</tr>");
                        strHTML.Append("<tr>");
                        strHTML.Append("<td  align='left' valign='top'>Location</td>");
                        strHTML.Append("<td  align='left' valign='top'>Location Number</td>");
                        strHTML.Append("<td align='left' valign='top'>First Report<br/>Number</td>");
                        strHTML.Append("<td  align='left' valign='top'>Claim Number</td>");
                        strHTML.Append("<td  align='left' valign='top'>Employee</td>");
                        strHTML.Append("<td  align='left' valign='top'>Cause of Incident</td>");
                        strHTML.Append("<td align='left' valign='top'>Date of<br/>Incident</td>");
                        strHTML.Append("<td align='right' valign='top'>Claim<br/>Charge</td>");
                        strHTML.Append("<td align='left' valign='top'>Date<br/>Reported to<br/>SRS</td>");
                        strHTML.Append("<td align='right' valign='top'>Report<br/>Lag</td>");
                        strHTML.Append("<td align='right' valign='top'>Report Lag<br />Credit</td>");
                        strHTML.Append("<td align='right' valign='top'>Report Lag<br />Charge</td>");

                        strHTML.Append("<td align='right' valign='top'>Nurse Triage<br />Credit</td>");
                        strHTML.Append("<td align='right' valign='top'>Incident Investigation<br />Credit</td>");

                        strHTML.Append("<td align='left' valign='top'>Claim Closed<br />Date</td>");
                        strHTML.Append("<td align='right' valign='top'>Claim Closed<br />Credit</td>");

                        strHTML.Append("<td align='left' valign='top'>Claim Reopened<br />Date</td>");
                        strHTML.Append("<td align='right' valign='top'>Claim Reopened<br />Charge</td>");

                        strHTML.Append("<td align='right' valign='top'>Total<br/>Charge</td>");
                        strHTML.Append("</tr>");
                        #endregion

                        // get result records from database for the report
                        DataSet dsReport = new DataSet(); // Report.WCAllocationMonthlyDetailReport(Month, Year);

                        if (strRun_Report_By == "Region")
                        {
                            dsReport = Report.WCAllocationMonthlyDetailReport(Month, Year);

                            DataTable dtReportData = dsReport.Tables[0];
                            DataTable dtRegion = dsReport.Tables[1];
                            DataTable dtTotal = dsReport.Tables[2];

                            #region ::Region section::

                            if (dtRegion.Rows.Count > 0)
                            {
                                //Add Report Data Table 
                                //strHTML.Append("<table style='width: 100%;' border='1' align='left' cellpadding='4' cellspacing='0'>");
                                foreach (DataRow drRegion in dtRegion.Rows)
                                {
                                    strHTML.Append("<tr><td colspan='19' style='font-family:Calibri;'><b>");
                                    strHTML.Append("Region : " + drRegion["ReportLabel"].ToString());
                                    strHTML.Append("</b></td></tr>");
                                    //strHTML.Append("<tr><td colspan='19'>");
                                    //strHTML.Append("<table style='width: 100%;font-family:Calibri;' border='1' align='left' cellpadding='4' cellspacing='0'>");
                                    DataRow[] drDataByRegion = dtReportData.Select("ReportLabel='" + drRegion["ReportLabel"].ToString() + "'");
                                    foreach (DataRow drData in drDataByRegion)
                                    {
                                        strHTML.Append("<tr><td  align='left' valign='top'>" + drData["dba"] + "</td>");
                                        strHTML.Append("<td align='left' valign='top'>" + drData["Sonic_Location_Code"] + "</td>");
                                        strHTML.Append("<td  align='left' valign='top'>WC-" + drData["WC_FR_Number"] + "</td>");
                                        strHTML.Append("<td  align='left' valign='top'>" + drData["Origin_Claim_Number"] + "</td>");
                                        strHTML.Append("<td  align='left' valign='top'>" + drData["Employee_Name"] + "</td>");
                                        strHTML.Append("<td  align='left' valign='top'>" + drData["Sonic_Cause_Code"] + "</td>");

                                        if (!string.IsNullOrEmpty(Convert.ToString(drData["Date_Of_Incident"])))
                                        {
                                            if (Convert.ToDateTime(drData["Date_Of_Incident"]) != Convert.ToDateTime(System.Data.SqlTypes.SqlDateTime.MinValue.ToString()))
                                                strHTML.Append("<td style='width: 8%;' align='left' valign='top'>" + Convert.ToDateTime(drData["Date_Of_Incident"]).ToString(DateDisplayFormat) + "</td>");
                                            else
                                                strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                        }
                                        else
                                            strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");

                                        strHTML.Append("<td style='width: 8%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["Initial_Charge"]) + "</td>");

                                        if (drData["Initial_Charge_Date"] != DBNull.Value)
                                            strHTML.Append("<td style='width: 8%;' align='left' valign='top'>" + Convert.ToDateTime(drData["Initial_Charge_Date"]).ToString(DateDisplayFormat) + "</td>");
                                        else
                                            strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");

                                        strHTML.Append("<td style='width: 8%;' align='right' valign='top'>" + string.Format("{0:N0}", drData["Report_Lag"]) + "</td>");

                                        strHTML.Append("<td style='width: 8%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["Lag_Credit"]) + "</td>");
                                        strHTML.Append("<td style='width: 8%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["Lag_Charge"]) + "</td>");

                                        strHTML.Append("<td style='width: 8%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["Nurse_Triage_Credit"]) + "</td>");
                                        strHTML.Append("<td style='width: 8%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["Incident_Investigation_Credit"]) + "</td>");

                                        if (drData["Early_Close_Credit_Date"] != DBNull.Value)
                                            strHTML.Append("<td style='width: 8%;' align='left' valign='top'>" + Convert.ToDateTime(drData["Early_Close_Credit_Date"]).ToString(DateDisplayFormat) + "</td>");
                                        else
                                            strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");

                                        strHTML.Append("<td style='width: 8%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["Early_Close_Credit"]) + "</td>");

                                        if (drData["Reopen_Charge_Date"] != DBNull.Value)
                                            strHTML.Append("<td style='width: 8%;' align='left' valign='top'>" + Convert.ToDateTime(drData["Reopen_Charge_Date"]).ToString(DateDisplayFormat) + "</td>");
                                        else
                                            strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");

                                        strHTML.Append("<td style='width: 8%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["Reopen_Charge"]) + "</td>");

                                        strHTML.Append("<td style='width: 8%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["Total_Charge"]) + "</td>");
                                        strHTML.Append("</tr>");
                                    }
                                    strHTML.Append("<tr style='background-color:#FFFFFF;'>");
                                    strHTML.Append("<td style='width: 13%;' align='left' valign='top'><b>Total</b></td>");
                                    strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                    strHTML.Append("<td style='width: 10%;' align='left' valign='top'>&nbsp;</td>");
                                    strHTML.Append("<td style='width: 13%;' align='left' valign='top'>&nbsp;</td>");
                                    strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                    strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                    strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                    strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", drRegion["Initial_Charge"]) + "</b></td>");
                                    strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                    strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>" + string.Format("{0:N0}", drRegion["Report_Lag"]) + "</b></td>");
                                    strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$" + string.Format("{0:N2}", drRegion["Lag_Credit"]) + "</b></td>");
                                    strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", drRegion["Lag_Charge"]) + "</b></td>");

                                    strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$" + string.Format("{0:N2}", drRegion["Nurse_Triage_Credit"]) + "</b></td>");
                                    strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", drRegion["Incident_Investigation_Credit"]) + "</b></td>");
                                    strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                    strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", drRegion["Early_Close_Credit"]) + "</b></td>");
                                    strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                    strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", drRegion["Reopen_Charge"]) + "</b></td>");
                                    strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", drRegion["Total_Charge"]) + "</b></td>");
                                    strHTML.Append("</tr>");
                                    //strHTML.Append("</table>");
                                    //strHTML.Append("</td></tr>");
                                }
                                strHTML.Append("<tr style='background-color:#507cd1;font-family:Calibri;color:White;'>");
                                strHTML.Append("<td style='width: 13%;' align='left' valign='top'><b>Grand Total</b></td>");
                                strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 10%;' align='left' valign='top'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 13%;' align='left' valign='top'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["Initial_Charge"]) + "</b></td>");
                                strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>" + string.Format("{0:N0}", dtTotal.Rows[0]["Report_Lag"]) + "</b></td>");
                                strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$" + string.Format("{0:N2}", dtTotal.Rows[0]["Lag_Credit"]) + "</b></td>");
                                strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["Lag_Charge"]) + "</b></td>");

                                strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["Nurse_Triage_Credit"]) + "</b></td>");
                                strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["Incident_Investigation_Credit"]) + "</b></td>");
                                strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["Early_Close_Credit"]) + "</b></td>");
                                strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["Reopen_Charge"]) + "</b></td>");
                                strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["Total_Charge"]) + "</b></td>");
                                strHTML.Append("</tr>");
                                strHTML.Append("</table>");
                                //strHTML.Append("</td></tr>");
                                //strHTML.Append("</table>");
                            }
                            else
                            {
                                //Add No record found line for year
                                strHTML.Append("<tr><td align='left' colspan='19'>No Record Found!</td></tr>");
                            }

                            #endregion
                        }
                        else if (strRun_Report_By == "Market")
                        {
                            dsReport = Report.WCAllocationMonthlyDetailReport_ByMarket(Month, Year);

                            #region ::Region section::

                            DataTable dtDetails = dsReport.Tables[0];
                            DataTable dtMarketTotal = dsReport.Tables[1];
                            DataTable dtRegionTotals = dsReport.Tables[2];
                            DataTable dtGrandTotal = dsReport.Tables[3];

                            if (dtDetails.Rows.Count > 0)
                            {
                                //Add Report Data Table 
                                strHTML.Append("<table style='width: 100%;' border='1' align='left' cellpadding='4' cellspacing='0'>");
                                foreach (DataRow drRegion in dtRegionTotals.Rows)
                                {
                                    strHTML.Append("<tr><td colspan='19' style='font-family:Calibri;'><b>");
                                    strHTML.Append("Region : " + drRegion["Region"].ToString());
                                    strHTML.Append("</b></td></tr>");

                                    DataRow[] drDataByRegion = dtMarketTotal.Select("Region='" + drRegion["Region"].ToString() + "'");
                                    #region ::market section::
                                    foreach (DataRow drMarket in drDataByRegion)
                                    {
                                        strHTML.Append("<tr><td colspan='19' style='font-family:Calibri;'><b>");
                                        strHTML.Append("Market : " + drMarket["Market"].ToString());
                                        strHTML.Append("</b></td></tr>");
                                        strHTML.Append("<tr><td colspan='19'>");
                                        strHTML.Append("<table style='width: 100%;font-family:Calibri;' border='1' align='left' cellpadding='4' cellspacing='0'>");
                                        DataRow[] drDataByMarket = dtDetails.Select("Region='" + drMarket["Region"].ToString() + "'" + "AND Market='" + drMarket["Market"].ToString() + "'");
                                        foreach (DataRow drData in drDataByMarket)
                                        {
                                            strHTML.Append("<td  align='left' valign='top'>" + drData["dba"] + "</td>");
                                            strHTML.Append("<td align='left' valign='top'>" + drData["Sonic_Location_Code"] + "</td>");
                                            strHTML.Append("<td  align='left' valign='top'>WC-" + drData["WC_FR_Number"] + "</td>");
                                            strHTML.Append("<td  align='left' valign='top'>" + drData["Origin_Claim_Number"] + "</td>");
                                            strHTML.Append("<td  align='left' valign='top'>" + drData["Employee_Name"] + "</td>");
                                            strHTML.Append("<td  align='left' valign='top'>" + drData["Sonic_Cause_Code"] + "</td>");

                                            if (Convert.ToDateTime(drData["Date_Of_Incident"]) != Convert.ToDateTime(System.Data.SqlTypes.SqlDateTime.MinValue.ToString()))
                                                strHTML.Append("<td style='width: 8%;' align='left' valign='top'>" + Convert.ToDateTime(drData["Date_Of_Incident"]).ToString(DateDisplayFormat) + "</td>");
                                            else
                                                strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");

                                            strHTML.Append("<td style='width: 8%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["Initial_Charge"]) + "</td>");

                                            if (drData["Initial_Charge_Date"] != DBNull.Value)
                                                strHTML.Append("<td style='width: 8%;' align='left' valign='top'>" + Convert.ToDateTime(drData["Initial_Charge_Date"]).ToString(DateDisplayFormat) + "</td>");
                                            else
                                                strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");

                                            strHTML.Append("<td style='width: 8%;' align='right' valign='top'>" + string.Format("{0:N0}", drData["Report_Lag"]) + "</td>");

                                            strHTML.Append("<td style='width: 8%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["Lag_Credit"]) + "</td>");
                                            strHTML.Append("<td style='width: 8%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["Lag_Charge"]) + "</td>");

                                            strHTML.Append("<td style='width: 8%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["Nurse_Triage_Credit"]) + "</td>");
                                            strHTML.Append("<td style='width: 8%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["Incident_Investigation_Credit"]) + "</td>");

                                            if (drData["Early_Close_Credit_Date"] != DBNull.Value)
                                                strHTML.Append("<td style='width: 8%;' align='left' valign='top'>" + Convert.ToDateTime(drData["Early_Close_Credit_Date"]).ToString(DateDisplayFormat) + "</td>");
                                            else
                                                strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");

                                            strHTML.Append("<td style='width: 8%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["Early_Close_Credit"]) + "</td>");

                                            if (drData["Reopen_Charge_Date"] != DBNull.Value)
                                                strHTML.Append("<td style='width: 8%;' align='left' valign='top'>" + Convert.ToDateTime(drData["Reopen_Charge_Date"]).ToString(DateDisplayFormat) + "</td>");
                                            else
                                                strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");

                                            strHTML.Append("<td style='width: 8%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["Reopen_Charge"]) + "</td>");

                                            strHTML.Append("<td style='width: 8%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["Total_Charge"]) + "</td>");
                                            strHTML.Append("</tr>");
                                        }
                                        strHTML.Append("<tr style='background-color:#FFFFFF;'>");
                                        strHTML.Append("<td style='width: 13%;' align='left' valign='top'><b>Totals</b></td>");
                                        strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                        strHTML.Append("<td style='width: 10%;' align='left' valign='top'>&nbsp;</td>");
                                        strHTML.Append("<td style='width: 13%;' align='left' valign='top'>&nbsp;</td>");
                                        strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                        strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                        strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                        strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", drMarket["Initial_Charge"]) + "</b></td>");
                                        strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                        strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>" + string.Format("{0:N0}", drMarket["Report_Lag"]) + "</b></td>");
                                        strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$" + string.Format("{0:N2}", drMarket["Lag_Credit"]) + "</b></td>");
                                        strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", drMarket["Lag_Charge"]) + "</b></td>");

                                        strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$" + string.Format("{0:N2}", drMarket["Nurse_Triage_Credit"]) + "</b></td>");
                                        strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", drMarket["Incident_Investigation_Credit"]) + "</b></td>");
                                        strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                        strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", drMarket["Early_Close_Credit"]) + "</b></td>");
                                        strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                        strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", drMarket["Reopen_Charge"]) + "</b></td>");
                                        strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", drMarket["Total_Charge"]) + "</b></td>");
                                        strHTML.Append("</tr>");
                                        strHTML.Append("</table>");
                                        strHTML.Append("</td></tr>");
                                    }
                                    #endregion

                                    strHTML.Append("<tr style='background-color:#66ccff;'>");
                                    strHTML.Append("<td style='width: 13%;' align='left' valign='top'><b>Region Total</b></td>");
                                    strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                    strHTML.Append("<td style='width: 10%;' align='left' valign='top'>&nbsp;</td>");
                                    strHTML.Append("<td style='width: 13%;' align='left' valign='top'>&nbsp;</td>");
                                    strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                    strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                    strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                    strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", drRegion["Initial_Charge"]) + "</b></td>");
                                    strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                    strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>" + string.Format("{0:N0}", drRegion["Report_Lag"]) + "</b></td>");
                                    strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$" + string.Format("{0:N2}", drRegion["Lag_Credit"]) + "</b></td>");
                                    strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", drRegion["Lag_Charge"]) + "</b></td>");

                                    strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$" + string.Format("{0:N2}", drRegion["Nurse_Triage_Credit"]) + "</b></td>");
                                    strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", drRegion["Incident_Investigation_Credit"]) + "</b></td>");
                                    strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                    strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", drRegion["Early_Close_Credit"]) + "</b></td>");
                                    strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                    strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", drRegion["Reopen_Charge"]) + "</b></td>");
                                    strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", drRegion["Total_Charge"]) + "</b></td>");
                                    strHTML.Append("</tr>");
                                    //strHTML.Append("</table>");
                                    //strHTML.Append("</td></tr>");
                                }
                                strHTML.Append("<tr style='background-color:#507cd1;font-family:Calibri;color:White;'>");
                                strHTML.Append("<td style='width: 13%;' align='left' valign='top'><b>Report Grand Total</b></td>");
                                strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 10%;' align='left' valign='top'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 13%;' align='left' valign='top'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", dtGrandTotal.Rows[0]["Initial_Charge"]) + "</b></td>");
                                strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>" + string.Format("{0:N0}", dtGrandTotal.Rows[0]["Report_Lag"]) + "</b></td>");
                                strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$" + string.Format("{0:N2}", dtGrandTotal.Rows[0]["Lag_Credit"]) + "</b></td>");
                                strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", dtGrandTotal.Rows[0]["Lag_Charge"]) + "</b></td>");

                                strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", dtGrandTotal.Rows[0]["Nurse_Triage_Credit"]) + "</b></td>");
                                strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", dtGrandTotal.Rows[0]["Incident_Investigation_Credit"]) + "</b></td>");
                                strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", dtGrandTotal.Rows[0]["Early_Close_Credit"]) + "</b></td>");
                                strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", dtGrandTotal.Rows[0]["Reopen_Charge"]) + "</b></td>");
                                strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", dtGrandTotal.Rows[0]["Total_Charge"]) + "</b></td>");
                                strHTML.Append("</tr>");
                                strHTML.Append("</table>");
                                //strHTML.Append("</td></tr>");
                                //strHTML.Append("</table>");
                            }
                            else
                            {
                                //Add No record found line for year
                                strHTML.Append("<tr><td align='left' colspan='19'>No Record Found!</td></tr>");
                            }

                            #endregion
                        }

                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        SendMail("WC Allocation Monthly Detail Report", "WCAllocationMonthlyDetailReport.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);


                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in WC Allocation Monthly Detail Report, " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
        }

        //Report 23
        private void BindWCMonthlyAllocationSummaryReport(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(23, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = dtUser.Rows[0]["FIRST_NAME"].ToString();
                        strLastName = dtUser.Rows[0]["LAST_NAME"].ToString();
                        strMailFrom = dtUser.Rows[0]["Email"].ToString();

                        // get start date
                        Decimal Year = Convert.ToDecimal(dtFilter.Rows[0]["Year"]);

                        string strRun_Report_By = Convert.ToString(dtFilter.Rows[0]["Run_report_by"]);

                        if (string.IsNullOrEmpty(strRun_Report_By))
                            strRun_Report_By = "Region";

                        // get result records from database for the report
                        DataSet dsReport = new DataSet(); ;// Report.WC_Monthly_Allocation_Summary_Report(Year);

                        if (strRun_Report_By == "Region")
                            dsReport = Report.WC_Monthly_Allocation_Summary_Report(Year);
                        else if (strRun_Report_By == "Market")
                            dsReport = Report.WC_Monthly_Allocation_Summary_Report_ByMarket(Year);

                        //Create HTML for the report and write into HTML Write object
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        #region "Header"

                        //Add Report Title and Schedule Date

                        strHTML.Append("<table><tr><td colspan='18'>");
                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : WC Monthly Allocation Summary Report</b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"]).ToString();
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        //Add Report Filter Criteria 
                        strHTML.Append("<br /><br />");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Year          : " + Year);
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Run Report by : " + strRun_Report_By);
                        strHTML.Append("<br /><br />");

                        strHTML.Append("</td></tr></table>");

                        //Add Header HTML
                        strHTML.Append("<table cellpadding='4' cellspacing='0' style='font-family:Calibri;' width='100%' border='1'>");
                        strHTML.Append("<tr style='font-weight: bold;'>");
                        strHTML.Append("<th  align='left' valign='top'>Location</th>");
                        strHTML.Append("<th  align='left' valign='top'>Location<br/>Code</th>");
                        strHTML.Append("<th  align='left' valign='top'>Region</th>");
                        if (strRun_Report_By == "Market")
                            strHTML.Append("<th  align='left' valign='top'>Market</th>");
                        strHTML.Append("<th  align='right' valign='top'>JAN'" + Year.ToString().Substring(2, 2) + "</th>");
                        strHTML.Append("<th  align='right' valign='top'>FEB'" + Year.ToString().Substring(2, 2) + "</th>");
                        strHTML.Append("<th  align='right' valign='top'>MAR'" + Year.ToString().Substring(2, 2) + "</th>");
                        strHTML.Append("<th  align='right' valign='top'>APR'" + Year.ToString().Substring(2, 2) + "</th>");
                        strHTML.Append("<th  align='right' valign='top'>MAY'" + Year.ToString().Substring(2, 2) + "</th>");
                        strHTML.Append("<th  align='right' valign='top'>JUN'" + Year.ToString().Substring(2, 2) + "</th>");
                        strHTML.Append("<th  align='right' valign='top'>JUL'" + Year.ToString().Substring(2, 2) + "</th>");
                        strHTML.Append("<th  align='right' valign='top'>AUG'" + Year.ToString().Substring(2, 2) + "</th>");
                        strHTML.Append("<th  align='right' valign='top'>SEP'" + Year.ToString().Substring(2, 2) + "</th>");
                        strHTML.Append("<th  align='right' valign='top'>OCT'" + Year.ToString().Substring(2, 2) + "</th>");
                        strHTML.Append("<th  align='right' valign='top'>NOV'" + Year.ToString().Substring(2, 2) + "</th>");
                        strHTML.Append("<th  align='right' valign='top'>DEC'" + Year.ToString().Substring(2, 2) + "</th>");
                        strHTML.Append("<th  align='right' valign='top'>JAN'" + string.Format("{0:D2}", Convert.ToInt32(Year.ToString().Substring(2, 2)) + 1) + "</th>");
                        strHTML.Append("<th  align='right' valign='top'>FEB'" + string.Format("{0:D2}", Convert.ToInt32(Year.ToString().Substring(2, 2)) + 1) + "</th>");
                        strHTML.Append("<th  align='right' valign='top'>MAR'" + string.Format("{0:D2}", Convert.ToInt32(Year.ToString().Substring(2, 2)) + 1) + "</th>");
                        strHTML.Append("<th  align='right' valign='top'>Total Count'" + Year.ToString().Substring(2, 2) + "</th>");
                        strHTML.Append("</tr>");
                        #endregion

                        DataTable dtReportData = dsReport.Tables[0];
                        DataTable dtTotal = dsReport.Tables[1];
                        if (dtReportData.Rows.Count > 0)
                        {
                            //Add Report Data Table 
                            //strHTML.Append("<table style='width: 100%;' border='1' align='left' cellpadding='4' cellspacing='0'>");
                            //foreach (DataRow drRegion in dtRegion.Rows)
                            //{
                            //strHTML.Append("<tr><td colspan='15'>");
                            //strHTML.Append("<table style='width: 100%;font-family:Calibri;' border='1' align='left' cellpadding='4' cellspacing='0'>");
                            foreach (DataRow drData in dtReportData.Rows)
                            {
                                strHTML.Append("<tr>");
                                strHTML.Append("<td  align='left' valign='top'>" + drData["dba"] + "</td>");
                                strHTML.Append("<td  align='left' valign='top'>" + drData["sonic_location_code"] + "</td>");
                                strHTML.Append("<td  align='left' valign='top'>" + drData["Region"] + "</td>");
                                if (strRun_Report_By == "Market")
                                    strHTML.Append("<td  align='left' valign='top'>" + drData["Market"] + "</td>");
                                strHTML.Append("<td  align='right' valign='top'>$ " + string.Format("{0:N2}", drData["JAN"]) + "</td>");
                                strHTML.Append("<td  align='right' valign='top'>$ " + string.Format("{0:N2}", drData["FEB"]) + "</td>");
                                strHTML.Append("<td  align='right' valign='top'>$ " + string.Format("{0:N2}", drData["MAR"]) + "</td>");
                                strHTML.Append("<td  align='right' valign='top'>$ " + string.Format("{0:N2}", drData["APR"]) + "</td>");
                                strHTML.Append("<td  align='right' valign='top'>$ " + string.Format("{0:N2}", drData["MAY"]) + "</td>");
                                strHTML.Append("<td  align='right' valign='top'>$ " + string.Format("{0:N2}", drData["JUN"]) + "</td>");
                                strHTML.Append("<td  align='right' valign='top'>$ " + string.Format("{0:N2}", drData["JUL"]) + "</td>");
                                strHTML.Append("<td  align='right' valign='top'>$ " + string.Format("{0:N2}", drData["AUG"]) + "</td>");
                                strHTML.Append("<td  align='right' valign='top'>$ " + string.Format("{0:N2}", drData["SEP"]) + "</td>");
                                strHTML.Append("<td  align='right' valign='top'>$ " + string.Format("{0:N2}", drData["OCT"]) + "</td>");
                                strHTML.Append("<td  align='right' valign='top'>$ " + string.Format("{0:N2}", drData["NOV"]) + "</td>");
                                strHTML.Append("<td  align='right' valign='top'>$ " + string.Format("{0:N2}", drData["DEC"]) + "</td>");
                                strHTML.Append("<td  align='right' valign='top'>$ " + string.Format("{0:N2}", drData["Next_JAN"]) + "</td>");
                                strHTML.Append("<td  align='right' valign='top'>$ " + string.Format("{0:N2}", drData["Next_FEB"]) + "</td>");
                                strHTML.Append("<td  align='right' valign='top'>$ " + string.Format("{0:N2}", drData["Next_MAR"]) + "</td>");
                                strHTML.Append("<td  align='right' valign='top'>$ " + string.Format("{0:N2}", drData["Total"]) + "</td>");
                                strHTML.Append("</tr>");
                            }
                            strHTML.Append("<tr style='background-color:#507cd1;font-weight:bold;font-family:Calibri;color:White;'>");
                            strHTML.Append("<td align='left' valign='top'>Total</td>");
                            strHTML.Append("<td colspan='2' align='left' valign='top'>&nbsp;</td>");
                            if (strRun_Report_By == "Market")
                                strHTML.Append("<td align='left' valign='top'>&nbsp;</td>");
                            strHTML.Append("<td align='right' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["JAN"]) + "</td>");
                            strHTML.Append("<td align='right' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["FEB"]) + "</td>");
                            strHTML.Append("<td align='right' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["MAR"]) + "</td>");
                            strHTML.Append("<td align='right' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["APR"]) + "</td>");
                            strHTML.Append("<td align='right' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["MAY"]) + "</td>");
                            strHTML.Append("<td align='right' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["JUN"]) + "</td>");
                            strHTML.Append("<td align='right' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["JUL"]) + "</td>");
                            strHTML.Append("<td align='right' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["AUG"]) + "</td>");
                            strHTML.Append("<td align='right' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["SEP"]) + "</td>");
                            strHTML.Append("<td align='right' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["OCT"]) + "</td>");
                            strHTML.Append("<td align='right' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["NOV"]) + "</td>");
                            strHTML.Append("<td align='right' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["DEC"]) + "</td>");
                            strHTML.Append("<td align='right' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["Next_JAN"]) + "</td>");
                            strHTML.Append("<td align='right' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["Next_FEB"]) + "</td>");
                            strHTML.Append("<td align='right' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["Next_MAR"]) + "</td>");
                            strHTML.Append("<td align='right' valign='top'>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["Total"]) + "</td>");
                            strHTML.Append("</tr>");
                            //strHTML.Append("</table>");
                            //strHTML.Append("</td></tr>");
                            //}
                            strHTML.Append("</table>");
                            //strHTML.Append("</td></tr>");
                            //strHTML.Append("</table>");
                        }
                        else
                        {
                            //Add No record found line for year
                            strHTML.Append("<tr><td align='left' colspan='16'>No Record Found!</td></tr>");
                        }


                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        SendMail("WC Monthly Allocation Summary Report", "WCMonthlyAllocationSummaryReport.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);


                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in WC Monthly Allocation Summary Report, " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
        }

        //Report 24
        private void BindPurchaseServiceContractDetailReport(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(24, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = dtUser.Rows[0]["FIRST_NAME"].ToString();
                        strLastName = dtUser.Rows[0]["LAST_NAME"].ToString();
                        strMailFrom = dtUser.Rows[0]["Email"].ToString();

                        // get start date
                        string strRegion = dtFilter.Rows[0]["Region"].ToString();
                        string strMarket = null;
                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Market"])))
                        {
                            strMarket = Convert.ToString(dtFilter.Rows[0]["Market"]).Trim();
                        }
                        string strLocation = dtFilter.Rows[0]["Location"].ToString();
                        string strServiceContract = dtFilter.Rows[0]["ServiceContract"].ToString();
                        string strServiceType = dtFilter.Rows[0]["ServiceType"].ToString();
                        Nullable<DateTime> StartToDate = null;
                        Nullable<DateTime> StartFromDate = null;
                        Nullable<DateTime> EndToDate = null;
                        Nullable<DateTime> EndFromDate = null;

                        if (dtFilter.Rows[0]["StartToDate"] != null && dtFilter.Rows[0]["StartToDate"] != DBNull.Value)
                            StartToDate = Convert.ToDateTime(dtFilter.Rows[0]["StartToDate"].ToString());
                        if (dtFilter.Rows[0]["StartFromDate"] != null && dtFilter.Rows[0]["StartFromDate"] != DBNull.Value)
                            StartFromDate = Convert.ToDateTime(dtFilter.Rows[0]["StartFromDate"].ToString());
                        if (dtFilter.Rows[0]["EndToDate"] != null && dtFilter.Rows[0]["EndToDate"] != DBNull.Value)
                            EndToDate = Convert.ToDateTime(dtFilter.Rows[0]["EndToDate"].ToString());
                        if (dtFilter.Rows[0]["EndFromDate"] != null && dtFilter.Rows[0]["EndFromDate"] != DBNull.Value)
                            EndFromDate = Convert.ToDateTime(dtFilter.Rows[0]["EndFromDate"].ToString());

                        // get result records from database for the report
                        DataSet dsReport = Report.GetService_Contract_Detail_Report(strRegion, strMarket, strLocation, strServiceContract, strServiceType, StartToDate, StartFromDate, EndToDate, EndFromDate);

                        //Create HTML for the report and wirte into HTML Write object
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        #region "Header"

                        //Retrieve Market Values
                        string strMarketString = string.Empty;
                        if (string.IsNullOrEmpty(strMarket))
                        {
                            strMarketString = "All Market";
                        }
                        else
                        {
                            string[] strMar = strMarket.Split(Convert.ToChar(","));
                            for (int i = 0; i < strMar.Length; i++)
                            {
                                strMarketString += Report.SelectMarketInfoById(Convert.ToDecimal(strMar[i].ToString())).Tables[0].Rows[0]["Market"].ToString() + ",";
                            }
                            strMarketString = strMarketString.TrimEnd(',');
                        }
                        //Add Report Title and Schedule Date

                        strHTML.Append("<table><tr><td colspan='8'>");

                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : Purchase Service Contract Detail Report</b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"]).ToString();
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        string strLocationString = string.Empty;
                        string[] strLoc = strLocation.Split(Convert.ToChar(","));
                        DataTable dt;
                        for (int i = 0; i < strLoc.Length - 1; i++)
                        {
                            dt = Report.SelectLocationInfoById(Convert.ToDecimal(strLoc[i].ToString())).Tables[0];
                            if (dt.Rows.Count > 0)
                                strLocationString += dt.Rows[0]["dba"].ToString() + ",";
                        }
                        //foreach (string strl in strLoc)
                        //{
                        //    strLocationString += Report.SelectLocationInfoById(Convert.ToDecimal(strl.ToString())).Tables[0].Rows[0]["dba"].ToString() + ",";
                        //}

                        //Add Report Filter Criteria 
                        strHTML.Append("<br /><br />");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Region : " + strRegion.Trim(Convert.ToChar("'")).Replace("','", "<b>,</b>").ToString());
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Location  : " + strLocationString);
                        //strHTML.Append("Location        : " + strLocation.Replace("/", "_").Replace("'", "_").Replace("-","_").Replace(".","_").Replace("&","_").Replace(" ","_"));
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Service Contract : " + strServiceContract.Trim(Convert.ToChar("'")).Replace("','", "<b>,</b>").ToString());
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Service Type : " + strServiceType.Trim(Convert.ToChar("'")).Replace("','", "<b>,</b>").ToString());
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Start Date between " + StartFromDate != null ? Convert.ToDateTime(StartFromDate).ToString(DateDisplayFormat) : "" + " and " + StartToDate != null ? Convert.ToDateTime(StartToDate).ToString(DateDisplayFormat) : "");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("End Date between " + EndFromDate != null ? Convert.ToDateTime(EndFromDate).ToString(DateDisplayFormat) : "" + " and " + EndToDate != null ? Convert.ToDateTime(EndToDate).ToString(DateDisplayFormat) : "");
                        strHTML.Append("<br /><br />");

                        strHTML.Append("</td></tr></table>");

                        //Add Header HTML
                        strHTML.Append("<table cellpadding='4' cellspacing='0' style='font-weight: bold;font-family:Calibri;' width='100%' border='1'>");
                        strHTML.Append("<tr>");
                        strHTML.Append("<td  align='left' valign='top'>Region</td>");
                        strHTML.Append("<td  align='left' valign='top'>Supplier</td>");
                        strHTML.Append("<td  align='left' valign='top'>Location</td>");
                        strHTML.Append("<td  align='left' valign='top'>Service Type</td>");
                        strHTML.Append("<td  align='left' valign='top'>Start Date</td>");
                        strHTML.Append("<td  align='left' valign='top'>End Date</td>");
                        strHTML.Append("<td  align='right' valign='top'>Monthly Cost</td>");
                        strHTML.Append("<td  align='right' valign='top'>Annual Cost</td>");
                        strHTML.Append("</tr></table>");
                        #endregion

                        DataTable dtDetails = dsReport.Tables[0];
                        DataTable dtSupplierTotals = dsReport.Tables[1];
                        DataTable dtGrandTotal = dsReport.Tables[2];


                        DataView dvSupplierTotals = dtSupplierTotals.DefaultView;
                        dvSupplierTotals.Sort = "Region";
                        dtSupplierTotals = dvSupplierTotals.ToTable();
                        if (dtSupplierTotals.Rows.Count > 0)
                        {
                            //Add Report Data Table 
                            strHTML.Append("<table style='width: 100%;' border='1' cellpadding='4' cellspacing='0'>");
                            foreach (DataRow drSupplier in dtSupplierTotals.Rows)
                            {
                                //strHTML.Append("<tr><td colspan='11' style='font-family:Calibri;'><b>Region : ");
                                //strHTML.Append(drRegion["Region"].ToString());
                                //strHTML.Append("</b></td></tr>");
                                strHTML.Append("<tr><td colspan='8'>");
                                strHTML.Append("<table style='width: 100%;font-family:Calibri;' border='1' cellpadding='4' cellspacing='0'>");
                                DataRow[] drDataBySupplier = dtDetails.Select("Region='" + drSupplier["Region"].ToString() + "'");
                                foreach (DataRow drData in drDataBySupplier)
                                {
                                    strHTML.Append("<tr style='background-color:#FFFFFF;'>");
                                    strHTML.Append("<td style='width: 8%;' align='left' valign='top'>" + drData["Region"] + "</td>");
                                    strHTML.Append("<td style='width: 15%;' align='left' valign='top'>" + drData["Supplier"] + "</td>");
                                    strHTML.Append("<td style='width: 16%;' align='left' valign='top'>" + drData["Location"] + "</td>");
                                    strHTML.Append("<td style='width: 12%;' align='left' valign='top'>" + drData["ServiceType"] + "</td>");
                                    strHTML.Append("<td style='width: 10%;' align='left' valign='top'>" + FormatDBNullDateToDisplay(drData["Start_Date"]) + "</td>");
                                    strHTML.Append("<td style='width: 10%;' align='left' valign='top'>" + FormatDBNullDateToDisplay(drData["End_Date"]) + "</td>");
                                    strHTML.Append("<td style='width: 12%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["Monthly_Cost"]) + "</td>");
                                    strHTML.Append("<td style='width: 12%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["Annual_Cost"]) + "</td>");
                                    strHTML.Append("</tr>");
                                }
                                strHTML.Append("<tr style='background-color:#FFFFFF;'>");
                                strHTML.Append("<td style='width: 15%;' align='left' valign='top'><b>Total</b></td>");
                                strHTML.Append("<td style='width: 8%;' align='left' valign='top'><b>" + string.Format("{0:N0}", drSupplier["Total"]) + "</b></td>");
                                strHTML.Append("<td style='width: 16%;' align='left' valign='top'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 12%;' align='left' valign='top'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 10%;' align='left' valign='top'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 10%;' align='left' valign='top'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 12%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", drSupplier["Monthly_Cost"]) + "</b></td>");
                                strHTML.Append("<td style='width: 12%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", drSupplier["Annual_Cost"]) + "</b></td>");
                                strHTML.Append("</tr>");
                                strHTML.Append("</table>");
                                strHTML.Append("</td></tr>");
                            }
                            strHTML.Append("<tr style='background-color:#507cd1;font-family:Calibri;color:White;'>");
                            strHTML.Append("<td style='width: 15%;' align='left' valign='top'><b>Grand Total</b></td>");
                            strHTML.Append("<td style='width: 8%;' align='left' valign='top'><b>" + string.Format("{0:N0}", dtGrandTotal.Rows[0]["Total"]) + "</b></td>");
                            strHTML.Append("<td style='width: 16%;' align='left' valign='top'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 12%;' align='left' valign='top'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 10%;' align='left' valign='top'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 10%;' align='left' valign='top'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 12%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", dtGrandTotal.Rows[0]["Monthly_Cost"]) + "</b></td>");
                            strHTML.Append("<td style='width: 12%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", dtGrandTotal.Rows[0]["Annual_Cost"]) + "</b></td>");
                            strHTML.Append("</tr>");
                            strHTML.Append("</table>");
                            strHTML.Append("</td></tr>");
                            strHTML.Append("</table>");
                        }
                        else
                        {
                            //Add No record found line for year
                            strHTML.Append("<tr><td align='left' style='border:thin' colspan='8'>No Record Found!</td></tr>");
                        }

                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        SendMail("Purchase Serice Contract Detail Report", "PurchaseServiceContractDetail.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);


                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in Purchase Serice Contract Detail Report, " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
        }

        //Report 25
        private void BindLeaseRentalAgreementDetailReport(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(25, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = dtUser.Rows[0]["FIRST_NAME"].ToString();
                        strLastName = dtUser.Rows[0]["LAST_NAME"].ToString();
                        strMailFrom = dtUser.Rows[0]["Email"].ToString();

                        // get start date
                        string strRegion = dtFilter.Rows[0]["Region"].ToString();
                        //Updated by Poonam Parekh on 7/10/2016
                        //Initially no data was being generated
                        string strMarket = "";
                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Market"])))
                        {
                            strMarket = Convert.ToString(dtFilter.Rows[0]["Market"]).Trim();
                        }
                        string strLocation = dtFilter.Rows[0]["Location"].ToString();
                        string strEquipmentType = dtFilter.Rows[0]["EquipmentType"].ToString();
                        string strLeaseRentalType = dtFilter.Rows[0]["LeaseRentalType"].ToString();

                        Nullable<DateTime> StartToDate = null;
                        Nullable<DateTime> StartFromDate = null;
                        Nullable<DateTime> EndToDate = null;
                        Nullable<DateTime> EndFromDate = null;

                        if (dtFilter.Rows[0]["StartToDate"] != null && dtFilter.Rows[0]["StartToDate"] != DBNull.Value)
                            StartToDate = Convert.ToDateTime(dtFilter.Rows[0]["StartToDate"].ToString());
                        if (dtFilter.Rows[0]["StartFromDate"] != null && dtFilter.Rows[0]["StartFromDate"] != DBNull.Value)
                            StartFromDate = Convert.ToDateTime(dtFilter.Rows[0]["StartFromDate"].ToString());
                        if (dtFilter.Rows[0]["EndToDate"] != null && dtFilter.Rows[0]["EndToDate"] != DBNull.Value)
                            EndToDate = Convert.ToDateTime(dtFilter.Rows[0]["EndToDate"].ToString());
                        if (dtFilter.Rows[0]["EndFromDate"] != null && dtFilter.Rows[0]["EndFromDate"] != DBNull.Value)
                            EndFromDate = Convert.ToDateTime(dtFilter.Rows[0]["EndFromDate"].ToString());

                        // get result records from database for the report
                        //Updated by Poonam Parekh on 7/10/2016
                        //No data found issue
                        DataSet dsReport = Report.GetLease_Rental_Detail_Report(strRegion, strMarket, strLocation, strEquipmentType, strLeaseRentalType, StartToDate, StartFromDate, EndToDate, EndFromDate, FK_Security_Id);

                        //Create HTML for the report and wirte into HTML Write object
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        #region "Header"

                        //Add Report Title and Schedule Date
                        strHTML.Append("<table><tr><td colspan='12'>");

                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : Lease/Rental Agreement Detail Report</b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"]).ToString();
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        string strLocationString = string.Empty;
                        string[] strLoc = strLocation.Split(Convert.ToChar(","));
                        for (int i = 0; i < strLoc.Length - 1; i++)
                        {
                            strLocationString += Report.SelectLocationInfoById(Convert.ToDecimal(strLoc[i].ToString())).Tables[0].Rows[0]["dba"].ToString() + ",";
                        }
                        strLocationString = strLocationString.TrimEnd(',');

                        //Retrieve Market Values
                        string strMarketString = string.Empty;
                        if (string.IsNullOrEmpty(strMarket))
                        {
                            strMarketString = "All Market";
                        }
                        else
                        {
                            string[] strMar = strMarket.Split(Convert.ToChar(","));
                            for (int i = 0; i < strMar.Length; i++)
                            {
                                strMarketString += Report.SelectMarketInfoById(Convert.ToDecimal(strMar[i].ToString())).Tables[0].Rows[0]["Market"].ToString() + ",";
                            }
                            strMarketString = strMarketString.TrimEnd(',');
                        }

                        //foreach (string strl in strLoc)
                        //{
                        //    strLocationString += Report.SelectLocationInfoById(Convert.ToDecimal(strl.ToString())).Tables[0].Rows[0]["dba"].ToString() + ",";
                        //}

                        //Add Report Filter Criteria 
                        strHTML.Append("<br /><br />");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Region : " + strRegion.Trim(Convert.ToChar("'")).Replace("','", "<b>,</b>").ToString());
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Location : " + strLocationString);
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Market : " + strMarketString);
                        //strHTML.Append("Location        : " + strLocation.Replace("/", "_").Replace("'", "_").Replace("-","_").Replace(".","_").Replace("&","_").Replace(" ","_"));
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Equipment Type : " + strEquipmentType.Trim(Convert.ToChar("'")).Replace("','", "<b>,</b>").ToString());
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Lease/Rental Type : " + strLeaseRentalType.Trim(Convert.ToChar("'")).Replace("','", "<b>,</b>").ToString());
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Start Date between " + StartFromDate != null ? Convert.ToDateTime(StartFromDate).ToString(DateDisplayFormat) : "" + " and " + StartToDate != null ? Convert.ToDateTime(StartToDate).ToString(DateDisplayFormat) : "");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("End Date between " + EndFromDate != null ? Convert.ToDateTime(EndFromDate).ToString(DateDisplayFormat) : "" + " and " + EndToDate != null ? Convert.ToDateTime(EndToDate).ToString(DateDisplayFormat) : "");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("</td></tr></table>");

                        //Add Header HTML
                        strHTML.Append("<table cellpadding='4' cellspacing='0' style='font-weight: bold;font-family:Calibri;' width='100%' border='1'>");
                        strHTML.Append("<tr>");
                        strHTML.Append("<td  align='left' valign='top'>Region</td>");
                        strHTML.Append("<td  align='left' valign='top'>Supplier</td>");
                        strHTML.Append("<td  align='left' valign='top'>Location</td>");
                        strHTML.Append("<td  align='left' valign='top'>Equipment Type</td>");
                        strHTML.Append("<td  align='left' valign='top'>Lease/Rental Type</td>");
                        strHTML.Append("<td  align='left' valign='top'>Start Date</td>");
                        strHTML.Append("<td  align='left' valign='top'>End Date</td>");
                        strHTML.Append("<td  align='right' valign='top'>Monthly Cost</td>");
                        strHTML.Append("<td  align='right' valign='top'>Annual Cost</td>");
                        strHTML.Append("<td  align='right' valign='top'>Total Committed</td>");
                        strHTML.Append("<td  align='right' valign='top'>Months Remaining</td>");
                        strHTML.Append("</tr></table>");
                        #endregion

                        DataTable dtDetails = dsReport.Tables[0];
                        DataTable dtSupplierTotals = dsReport.Tables[1];
                        DataTable dtGrandTotal = dsReport.Tables[2];


                        DataView dvSupplierTotals = dtSupplierTotals.DefaultView;
                        dvSupplierTotals.Sort = "Region";
                        dtSupplierTotals = dvSupplierTotals.ToTable();
                        if (dtSupplierTotals.Rows.Count > 0)
                        {
                            //Add Report Data Table 
                            strHTML.Append("<table style='width: 100%;' border='1' cellpadding='4' cellspacing='0'>");
                            foreach (DataRow drSupplier in dtSupplierTotals.Rows)
                            {
                                //strHTML.Append("<tr><td colspan='11' style='font-family:Calibri;'><b>Region : ");
                                //strHTML.Append(drRegion["Region"].ToString());
                                //strHTML.Append("</b></td></tr>");
                                strHTML.Append("<tr><td colspan='11'>");
                                strHTML.Append("<table style='width: 100%;font-family:Calibri;' border='1' cellpadding='4' cellspacing='0'>");
                                DataRow[] drDataBySupplier = dtDetails.Select("Region='" + drSupplier["Region"].ToString() + "'");
                                foreach (DataRow drData in drDataBySupplier)
                                {
                                    strHTML.Append("<tr style='background-color:#FFFFFF;'>");
                                    strHTML.Append("<td style='width: 11%;' align='left' valign='top'>" + drData["Region"] + "</td>");
                                    strHTML.Append("<td style='width: 12%;' align='left' valign='top'>" + drData["Supplier"] + "</td>");
                                    strHTML.Append("<td style='width: 16%;' align='left' valign='top'>" + drData["Location"] + "</td>");
                                    strHTML.Append("<td style='width: 12%;' align='left' valign='top'>" + drData["EquipmentType"] + "</td>");
                                    strHTML.Append("<td style='width: 12%;' align='left' valign='top'>" + drData["Lease_Rental_Type"] + "</td>");

                                    strHTML.Append("<td style='width: 10%;' align='left' valign='top'>" + FormatDBNullDateToDisplay(drData["Start_Date"]) + "</td>");

                                    strHTML.Append("<td style='width: 10%;' align='left' valign='top'>" + FormatDBNullDateToDisplay(drData["End_Date"]) + "</td>");

                                    strHTML.Append("<td style='width: 12%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["Monthly_Cost"]) + "</td>");
                                    strHTML.Append("<td style='width: 12%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["Annual_Cost"]) + "</td>");
                                    strHTML.Append("<td style='width: 12%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["Total_Committed"]) + "</td>");
                                    strHTML.Append("<td style='width: 12%;' align='right' valign='top'>" + string.Format("{0:N0}", drData["Months_Remaining"]) + "</td>");
                                    strHTML.Append("</tr>");
                                }
                                strHTML.Append("<tr style='background-color:#FFFFFF;'>");
                                strHTML.Append("<td style='width: 11%;' align='left' valign='top'><b>Total</b></td>");
                                strHTML.Append("<td style='width: 12%;' align='left' valign='top'><b>" + string.Format("{0:N0}", drSupplier["Total"]) + "</b></td>");
                                strHTML.Append("<td style='width: 16%;' align='left' valign='top'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 12%;' align='left' valign='top'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 12%;' align='left' valign='top'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 10%;' align='left' valign='top'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 10%;' align='left' valign='top'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 12%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", drSupplier["Monthly_Cost"]) + "</b></td>");
                                strHTML.Append("<td style='width: 12%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", drSupplier["Annual_Cost"]) + "</b></td>");
                                strHTML.Append("<td style='width: 12%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", drSupplier["Total_Committed"]) + "</b></td>");
                                strHTML.Append("<td style='width: 12%;' align='right' valign='top'><b>" + string.Format("{0:N0}", drSupplier["Months_Remaining"]) + "</b></td>");
                                strHTML.Append("</tr>");
                                strHTML.Append("</table>");
                                strHTML.Append("</td></tr>");
                            }
                            strHTML.Append("<tr style='background-color:#507cd1;font-family:Calibri;color:White;'>");
                            strHTML.Append("<td style='width: 11%;' align='left' valign='top'><b>Grand Total</b></td>");
                            strHTML.Append("<td style='width: 12%;' align='left' valign='top'><b>" + string.Format("{0:N0}", dtGrandTotal.Rows[0]["Total"]) + "</b></td>");
                            strHTML.Append("<td style='width: 16%;' align='left' valign='top'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 12%;' align='left' valign='top'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 12%;' align='left' valign='top'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 10%;' align='left' valign='top'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 10%;' align='left' valign='top'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 12%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", dtGrandTotal.Rows[0]["Monthly_Cost"]) + "</b></td>");
                            strHTML.Append("<td style='width: 12%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", dtGrandTotal.Rows[0]["Annual_Cost"]) + "</b></td>");
                            strHTML.Append("<td style='width: 12%;' align='right' valign='top'><b>$ " + string.Format("{0:N0}", dtGrandTotal.Rows[0]["Total_Committed"]) + "</b></td>");
                            strHTML.Append("<td style='width: 12%;' align='right' valign='top'><b>" + string.Format("{0:N0}", dtGrandTotal.Rows[0]["Months_Remaining"]) + "</b></td>");
                            strHTML.Append("</tr>");
                            strHTML.Append("</table>");
                            strHTML.Append("</td></tr>");
                            strHTML.Append("</table>");
                        }
                        else
                        {
                            //Add No record found line for year
                            strHTML.Append("<table  colspan='11' style='border: black 0.5px solid;'><tr><td align='left' colspan='11'>No Record Found!</td></tr></table>");
                        }

                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        SendMail("Lease/Rental Agreement Detail Report", "LeaseRentalAgreementDetail.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);


                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in Lease/Rental Agreement Detail Report, " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
        }

        //Report 26
        private void BindPurchaseAssetReport(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(26, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = dtUser.Rows[0]["FIRST_NAME"].ToString();
                        strLastName = dtUser.Rows[0]["LAST_NAME"].ToString();
                        strMailFrom = dtUser.Rows[0]["Email"].ToString();

                        // get Region
                        string strRegion = dtFilter.Rows[0]["Region"].ToString();
                        string strMarket = "";
                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Market"])))
                        {
                            strMarket = Convert.ToString(dtFilter.Rows[0]["Market"]).Trim();
                        }
                        string strManufacturer = dtFilter.Rows[0]["Manufacutrer"].ToString();
                        string strLocation = dtFilter.Rows[0]["Location"].ToString();
                        string strType = dtFilter.Rows[0]["Type"].ToString();

                        // get result records from database for the report
                        DataSet dsReport = Report.Get_Purchase_Report(strRegion, strMarket, strManufacturer, strType, strLocation, FK_Security_Id);

                        //Create HTML for the report and wirte into HTML Write object
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        string strLocationString = string.Empty;
                        string[] strLoc = strLocation.Split(Convert.ToChar(","));
                        for (int i = 0; i < strLoc.Length - 1; i++)
                        {
                            strLocationString += Report.SelectLocationInfoById(Convert.ToDecimal(strLoc[i].ToString().TrimStart(Convert.ToChar("'")).TrimEnd(Convert.ToChar("'")))).Tables[0].Rows[0]["dba"].ToString() + ",";
                        }

                        string strManuFac = string.Empty;
                        string[] strManu = strManufacturer.Split(Convert.ToChar(","));
                        for (int j = 0; j < strManu.Length - 1; j++)
                        {
                            strManuFac += Report.SelectManufacturerByPK(Convert.ToDecimal(strManu[j].ToString().TrimStart(Convert.ToChar("'")).TrimEnd(Convert.ToChar("'")))).Tables[0].Rows[0]["Fld_Desc"].ToString() + ",";
                        }

                        #region "Header"

                        //Retrieve Market Values
                        string strMarketString = string.Empty;
                        if (string.IsNullOrEmpty(strMarket))
                        {
                            strMarketString = "All Market";
                        }
                        else
                        {
                            string[] strMar = strMarket.Split(Convert.ToChar(","));
                            for (int i = 0; i < strMar.Length; i++)
                            {
                                strMarketString += Report.SelectMarketInfoById(Convert.ToDecimal(strMar[i].ToString())).Tables[0].Rows[0]["Market"].ToString() + ",";
                            }
                            strMarketString = strMarketString.TrimEnd(',');
                        }


                        //Add Report Title and Schedule Date
                        strHTML.Append("<table><tr><td colspan='10'>");

                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : Purchasing Asset Report</b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"]).ToString();
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        //Add Report Filter Criteria 
                        strHTML.Append("<br /><br />");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Regions : " + strRegion.TrimStart(Convert.ToChar(",")).Replace("'", ""));
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Market : " + strMarketString);
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Location : " + strLocationString);
                        strHTML.Append("<br />");
                        strHTML.Append("<br />");
                        strHTML.Append("Type: " + strType.TrimStart(Convert.ToChar(",")).Replace("'", ""));
                        strHTML.Append("<br />");
                        strHTML.Append("<br />");
                        strHTML.Append("Manufacturer : " + strManuFac);
                        strHTML.Append("<br /><br />");
                        strHTML.Append("</td></tr></table>");

                        //Add Header HTML
                        strHTML.Append("<table cellpadding='4' cellspacing='0' style='font-weight: bold;font-family:Calibri;' width='100%' border='1'>");
                        //strHTML.Append("<tr>");
                        //strHTML.Append("<td colspan='10' align='center'>Sonic Automotive WC Loss Allocation Report (First Report Only)</td>");
                        //strHTML.Append("</tr>");
                        strHTML.Append("<tr>");
                        strHTML.Append("<td style='width: 10%;' align='left' valign='top'>Type</td>");
                        strHTML.Append("<td style='width: 8%;' align='left' valign='top'>Region</td>");
                        strHTML.Append("<td style='width: 8%;' align='left' valign='top'>Manufacturer</td>");
                        strHTML.Append("<td style='width: 8%;' align='left' valign='top'>Location</td>");
                        strHTML.Append("<td style='width: 10%;' align='left' valign='top'>Dealership Department</td>");
                        strHTML.Append("<td style='width: 8%;' align='left' valign='top'>Serial Number</td>");
                        strHTML.Append("<td style='width: 8%;' align='left' valign='top'>Model Number</td>");
                        strHTML.Append("<td style='width: 8%;' align='left' valign='top'>Acquisition Date</td>");
                        strHTML.Append("<td style='width: 8%;' align='right' valign='top'>Acquisition Cost</td>");
                        strHTML.Append("<td style='width: 8%;' align='right' valign='top'>Amortization Months Remaining</td>");
                        strHTML.Append("<td style='width: 8%;' align='left' valign='top'>Service Supplier</td>");
                        strHTML.Append("<td style='width: 8%;' align='left' valign='top'>Lease/Rental Supplier</td>");
                        strHTML.Append("</tr></table>");
                        #endregion

                        DataTable dtReportData = dsReport.Tables[0];
                        DataTable dtRegion = dsReport.Tables[1];
                        DataTable dtTotal = dsReport.Tables[2];
                        if (dtRegion.Rows.Count > 0)
                        {
                            //Add Report Data Table 
                            strHTML.Append("<table style='width: 100%;' border='1' cellpadding='4' cellspacing='0'>");
                            foreach (DataRow drRegion in dtRegion.Rows)
                            {
                                //strHTML.Append("<tr><td colspan='10' style='font-family:Calibri;'><b>Region : ");
                                //strHTML.Append(drRegion["Region"].ToString());
                                //strHTML.Append("</b></td></tr>");
                                strHTML.Append("<tr><td>");
                                strHTML.Append("<table style='width: 100%;font-family:Calibri;' border='1' cellpadding='4' cellspacing='0'>");
                                DataRow[] drDataByRegion = dtReportData.Select("Region='" + drRegion["Region"].ToString() + "'");
                                foreach (DataRow drData in drDataByRegion)
                                {
                                    strHTML.Append("<tr style='background-color:#FFFFFF;'>");
                                    strHTML.Append("<td style='width: 10%;' align='left' valign='top'>" + drData["Type"] + "</td>");
                                    strHTML.Append("<td style='width: 8%;' align='left' valign='top'>" + drData["Region"] + "</td>");
                                    strHTML.Append("<td style='width: 8%;' align='left' valign='top'>WC-" + drData["Manufacturer"] + "</td>");
                                    strHTML.Append("<td style='width: 8%;' align='left' valign='top'>" + drData["Location"] + "</td>");
                                    strHTML.Append("<td style='width: 10%;' align='left' valign='top'>" + drData["Dealership_Department"] + "</td>");
                                    strHTML.Append("<td style='width: 8%;' align='left' valign='top'>" + drData["Serial_Number"] + "</td>");
                                    strHTML.Append("<td style='width: 8%;' align='left' valign='top'>" + drData["Model_Number"] + "</td>");
                                    if (Convert.ToDateTime(drData["Acquisition_Date"]) != Convert.ToDateTime(System.Data.SqlTypes.SqlDateTime.MinValue.ToString()))
                                    {
                                        strHTML.Append("<td style='width: 8%;' align='left' valign='top'>" + Convert.ToDateTime(drData["Acquisition_Date"]).ToString(DateDisplayFormat) + "</td>");
                                    }
                                    else
                                    {
                                        strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                    }
                                    strHTML.Append("<td style='width: 8%;' align='right' valign='top'>$ " + string.Format("{0:N2}", drData["Acquisition_Cost"]) + "</td>");
                                    strHTML.Append("<td style='width: 8%;' align='right' valign='top'>" + drData["AmortizationMonthsRemaining"] + "</td>");
                                    strHTML.Append("<td style='width: 8%;' align='left' valign='top'>" + drData["SCSupplier"] + "</td>");
                                    strHTML.Append("<td style='width: 8%;' align='left' valign='top'>" + drData["LRSupplier"] + "</td>");
                                    strHTML.Append("</tr>");
                                }
                                strHTML.Append("<tr style='background-color:#FFFFFF;'>");
                                strHTML.Append("<td style='width: 10%;' align='left' valign='top'><b>Total</b></td>");
                                strHTML.Append("<td style='width: 8%;' align='left' valign='top'><b>" + string.Format("{0:N0}", drRegion["Total"]) + "</b></td>");
                                strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 10%;' align='left' valign='top'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", drRegion["Acquisition_Cost"]) + "</b></td>");
                                strHTML.Append("<td style='width: 8%;' align='right' valign='top'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                                strHTML.Append("</tr>");
                                strHTML.Append("</table>");
                                strHTML.Append("</td></tr>");
                            }
                            strHTML.Append("<tr style='background-color:#507cd1;font-family:Calibri;color:White;'>");
                            strHTML.Append("<td style='width: 10%;' align='left' valign='top'><b>Grand Total</b></td>");
                            strHTML.Append("<td style='width: 8%;' align='left' valign='top'><b>" + string.Format("{0:N0}", dtTotal.Rows[0]["Total"]) + "</b></td>");
                            strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 10%;' align='left' valign='top'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 8%;' align='right' valign='top'><b>$ " + string.Format("{0:N2}", dtTotal.Rows[0]["Acquisition_Cost"]) + "</b></td>");
                            strHTML.Append("<td style='width: 8%;' align='right' valign='top'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                            strHTML.Append("<td style='width: 8%;' align='left' valign='top'>&nbsp;</td>");
                            strHTML.Append("</tr>");
                            strHTML.Append("</table>");
                            strHTML.Append("</td></tr>");
                            strHTML.Append("</table>");
                        }
                        else
                        {
                            //Add No record found line for year
                            strHTML.Append("<tr><td align='left' style='border:thin' colspan='10'>No Record Found!</td></tr>");
                        }

                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        SendMail("Purchase Asset Detail Report", "PurchaseAssetDetailReport.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);


                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in Purchase Asset Detail Report, " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
        }

        //Report 27
        private void BindLeaseDetailReport(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(27, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list 
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = Convert.ToString(dtUser.Rows[0]["FIRST_NAME"]).Trim();
                        strLastName = Convert.ToString(dtUser.Rows[0]["LAST_NAME"]).Trim();
                        strMailFrom = Convert.ToString(dtUser.Rows[0]["Email"]).Trim();

                        //Set all filters to a variable as per report type
                        DateTime? dtLCDFrom = null, dtLCDTo = null, dtLEDFrom = null, dtLEDTo = null;

                        string strRegion = Convert.ToString(dtFilter.Rows[0]["Region"]).Trim();
                        string strMarket = null;
                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Market"])))
                        {
                            strMarket = Convert.ToString(dtFilter.Rows[0]["Market"]).Trim();
                        }
                        string strLeaseType = Convert.ToString(dtFilter.Rows[0]["LeaseType"]).Trim();


                        if (dtFilter.Rows[0]["LCDFrom_Date"] != null && dtFilter.Rows[0]["LCDFrom_Date"] != string.Empty && dtFilter.Rows[0]["LCDFrom_Date"] != DBNull.Value)
                            dtLCDFrom = Convert.ToDateTime(dtFilter.Rows[0]["LCDFrom_Date"]);

                        if (dtFilter.Rows[0]["LCDTo_Date"] != null && dtFilter.Rows[0]["LCDTo_Date"] != string.Empty && dtFilter.Rows[0]["LCDTo_Date"] != DBNull.Value)
                            dtLCDTo = Convert.ToDateTime(dtFilter.Rows[0]["LCDTo_Date"]);

                        if (dtFilter.Rows[0]["LEDFrom_Date"] != null && dtFilter.Rows[0]["LEDFrom_Date"] != string.Empty && dtFilter.Rows[0]["LEDFrom_Date"] != DBNull.Value)
                            dtLEDFrom = Convert.ToDateTime(dtFilter.Rows[0]["LEDFrom_Date"]);

                        if (dtFilter.Rows[0]["LEDTo_Date"] != null && dtFilter.Rows[0]["LEDTo_Date"] != string.Empty && dtFilter.Rows[0]["LEDTo_Date"] != DBNull.Value)
                            dtLEDTo = Convert.ToDateTime(dtFilter.Rows[0]["LEDTo_Date"]);


                        //Get the all Unique records for Selected group (default - last name -sort) by search criteria
                        DataSet dsGroup = Report.GetLeaseDetailReport(strRegion, strMarket, strLeaseType, dtLCDFrom, dtLCDTo, dtLEDFrom, dtLEDTo, "asc");

                        //Create HTML for the report and wirte into HTML Write object
                        StringBuilder lstLeaseType = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        #region "Search Criteria"

                        //Retrieve Market Values
                        string strMarketString = string.Empty;
                        if (string.IsNullOrEmpty(strMarket))
                        {
                            strMarketString = "All Market";
                        }
                        else
                        {
                            string[] strMar = strMarket.Split(Convert.ToChar(","));
                            for (int i = 0; i < strMar.Length; i++)
                            {
                                strMarketString += Report.SelectMarketInfoById(Convert.ToDecimal(strMar[i].ToString())).Tables[0].Rows[0]["Market"].ToString() + ",";
                            }
                            strMarketString = strMarketString.TrimEnd(',');
                        }

                        //Add Report Title and Schedule Date
                        lstLeaseType.Append("<br />");
                        lstLeaseType.Append("<b>Report Title : Lease Detail Report</b>");
                        lstLeaseType.Append("<br /><br />");
                        lstLeaseType.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        lstLeaseType.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        lstLeaseType.Append("<br />");
                        lstLeaseType.Append("Recurring Period : " + drReportSchedule["Recurring_Period"].ToString());
                        lstLeaseType.Append("<br />");
                        lstLeaseType.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        //Add Report Filter Criteria 
                        lstLeaseType.Append("<br /><br />");
                        lstLeaseType.Append("<b>Report Filters </b>");
                        lstLeaseType.Append("<br /><br />");
                        lstLeaseType.Append("Region        : " + strRegion.Replace("'", ""));
                        lstLeaseType.Append("<br />");
                        lstLeaseType.Append("Market        : " + strMarketString);
                        lstLeaseType.Append("<br /><br />");
                        lstLeaseType.Append("Lease Type    : " + Report.GetLeaseTypeList(strLeaseType));
                        lstLeaseType.Append("<br />");
                        lstLeaseType.Append("LCD From      : " + FormatDBNullDateToDisplay(dtLCDFrom));
                        lstLeaseType.Append("<br />");
                        lstLeaseType.Append("LCD To        : " + FormatDBNullDateToDisplay(dtLCDTo));
                        lstLeaseType.Append("<br />");
                        lstLeaseType.Append("LED From      : " + FormatDBNullDateToDisplay(dtLEDFrom));
                        lstLeaseType.Append("<br />");
                        lstLeaseType.Append("LED To        : " + FormatDBNullDateToDisplay(dtLEDTo));
                        lstLeaseType.Append("<br /><br />");

                        #endregion

                        #region "Grid Data"

                        lstLeaseType.Append("<table cellspacing='0' cellpadding='0' align='Left' border='0' style='width: 2800px; border-collapse: collapse;'>");
                        //Header Row
                        lstLeaseType.Append("<tr align='left'><td align='left'>");
                        lstLeaseType.Append("<table width='2800px' cellpadding='0' cellspacing='0' border='0'>");
                        lstLeaseType.Append("<tr><td align='left'>");
                        lstLeaseType.Append("<table width='2800px' cellpadding='4' cellspacing='0' border='1' style='font-weight: bold;'>");
                        lstLeaseType.Append("<tr style='font-weight: bold;'>");
                        lstLeaseType.Append("<td align='left' colspan='6'>Sonic Automotive</td>");
                        lstLeaseType.Append("<td align='left' colspan='8'>Lease Detail Report</td>");
                        lstLeaseType.Append("<td align='right' colspan='2'>" + DateTime.Now.ToString() + " </td>");
                        lstLeaseType.Append("</tr>");

                        lstLeaseType.Append(" <tr style='font-weight: bold;'>");
                        lstLeaseType.Append("<td align='left' style='width: 120px'>Lease Code </td>");
                        lstLeaseType.Append("<td align='left' style='width: 150px'>Region </td>");
                        lstLeaseType.Append("<td align='left' style='width: 180px'>Location</td>");
                        lstLeaseType.Append("<td align='left' style='width: 180px'>Address</td>");
                        lstLeaseType.Append("<td align='left' style='width: 150px'>City</td>");
                        lstLeaseType.Append("<td align='left' style='width: 150px'>State</td>");
                        lstLeaseType.Append("<td align='left' style='width: 120px'>Zip</td>");
                        lstLeaseType.Append("<td align='left' style='width: 150px'>Primary Use</td>");
                        lstLeaseType.Append("<td align='right' style='width: 150px'>Rentable Area </td>");
                        lstLeaseType.Append("<td align='left' style='width: 150px'>Lease Type</td>");
                        lstLeaseType.Append("<td align='left' style='width: 180px'>Leasee</td>");
                        lstLeaseType.Append("<td align='left' style='width: 100px'>LCD</td>");
                        lstLeaseType.Append("<td align='left' style='width: 100px'>LED</td>");
                        lstLeaseType.Append("<td align='left' style='width:120px'>Lease Term</td>");
                        lstLeaseType.Append("<td align='left' style='width: 250px'>Renew Option</td>");
                        lstLeaseType.Append("<td align='left' style='width: 250px'>Cancel Option</td>");
                        lstLeaseType.Append(" </tr>");

                        lstLeaseType.Append("</table>");
                        lstLeaseType.Append("</td></tr>");
                        lstLeaseType.Append("</table>");
                        lstLeaseType.Append("</td></tr>");
                        if (dsGroup != null && dsGroup.Tables.Count > 0 && dsGroup.Tables[0].Rows.Count > 0)
                        {
                            //Data Row
                            foreach (DataRow drGroup in dsGroup.Tables[0].Rows)
                            {
                                strRegion = Convert.ToString(drGroup["Region"]);
                                //get the all Employee records by search criteria by group
                                DataSet dsDetails = Report.GetLeaseDetailReport_SubDetails(strRegion, strLeaseType, dtLCDFrom, dtLCDTo, dtLEDFrom, dtLEDTo, "asc");
                                if (dsDetails != null && dsDetails.Tables.Count > 0 && dsDetails.Tables[0].Rows.Count > 0)
                                {
                                    lstLeaseType.Append("<tr align='left'><td align='left'>");
                                    lstLeaseType.Append("<table width='2800px' cellpadding='0' cellspacing='0' border='0'>");
                                    lstLeaseType.Append("<tr><td align='left'>");
                                    lstLeaseType.Append("<table cellspacing='0' cellpadding='0' align='Left' border='1' style='width: 100%; border-collapse: collapse;'>");

                                    foreach (DataRow dr in dsDetails.Tables[0].Rows)
                                    {
                                        lstLeaseType.Append(" <tr>");
                                        lstLeaseType.Append("<td align='left' style='width: 120px'>" + Convert.ToString(dr["Lease_Codes"]) + "</td>");
                                        lstLeaseType.Append("<td align='left' style='width: 150px'>" + Convert.ToString(dr["Region"]) + " </td>");
                                        lstLeaseType.Append("<td align='left' style='width: 180px'>" + Convert.ToString(dr["Location"]) + "</td>");
                                        lstLeaseType.Append("<td align='left' style='width: 180px'>" + Convert.ToString(dr["Address"]) + "</td>");
                                        lstLeaseType.Append("<td align='left' style='width: 150px'>" + Convert.ToString(dr["City"]) + "</td>");
                                        lstLeaseType.Append("<td align='left' style='width: 150px'>" + Convert.ToString(dr["State"]) + "</td>");
                                        lstLeaseType.Append("<td align='left' style='width: 120px'>" + Convert.ToString(dr["Zip_Code"]) + "</td>");
                                        lstLeaseType.Append("<td align='left' style='width: 150px'>" + Convert.ToString(dr["PrimaryUse"]) + "</td>");
                                        lstLeaseType.Append("<td align='right' style='width: 150px'>" + string.Format("{0:N0}", Convert.ToString(dr["Total_Gross_Leaseable_Area"])) + "</td>");
                                        lstLeaseType.Append("<td align='left' style='width: 150px'>" + Convert.ToString(dr["Lease_Type"]) + "</td>");
                                        lstLeaseType.Append("<td align='left' style='width: 180px'>" + Convert.ToString(dr["Landlord"]) + "</td>");
                                        lstLeaseType.Append("<td align='left' style='width: 100px'>" + FormatDBNullDateToDisplay(dr["Lease_Commencement_Date"]) + "</td>");
                                        lstLeaseType.Append("<td align='left' style='width: 100px'>" + FormatDBNullDateToDisplay(dr["Lease_Expiration_Date"]) + "</td>");
                                        lstLeaseType.Append("<td align='left' style='width: 120px'>" + Convert.ToString(dr["Lease_Term_Months"]) + "</td>");
                                        lstLeaseType.Append("<td align='left' style='width: 250px'>" + Convert.ToString(dr["Renew_Options"]) + "</td>");
                                        lstLeaseType.Append("<td align='left' style='width: 250px'>" + Convert.ToString(dr["Cancel_Options"]) + "</td>");

                                        lstLeaseType.Append(" </tr>");
                                    }
                                    lstLeaseType.Append(" <tr style='font-weight: bold;'>");
                                    lstLeaseType.Append("<td align='left' style='width: 120px'>Total:</td>");
                                    lstLeaseType.Append("<td align='left' style='width: 150px'>" + Convert.ToString(dsDetails.Tables[1].Rows[0][0]) + " </td>");
                                    lstLeaseType.Append("<td align='left' style='width: 180px'>&nbsp;</td>");
                                    lstLeaseType.Append("<td align='left' style='width: 180px'>&nbsp;</td>");
                                    lstLeaseType.Append("<td align='left' style='width: 150px'>&nbsp;</td>");
                                    lstLeaseType.Append("<td align='left' style='width: 150px'>&nbsp;</td>");
                                    lstLeaseType.Append("<td align='left' style='width: 120px'>&nbsp;</td>");
                                    lstLeaseType.Append("<td align='left' style='width: 150px'>&nbsp;</td>");
                                    lstLeaseType.Append("<td align='right' style='width: 150px'>" + string.Format("{0:N0}", Convert.ToString(dsDetails.Tables[2].Rows[0][0])) + "</td>");
                                    lstLeaseType.Append("<td align='left' style='width: 150px'>&nbsp;</td>");
                                    lstLeaseType.Append("<td align='left' style='width: 180px'>&nbsp;</td>");
                                    lstLeaseType.Append("<td align='left' style='width: 100px'>&nbsp;</td>");
                                    lstLeaseType.Append("<td align='left' style='width: 100px'>&nbsp;</td>");
                                    lstLeaseType.Append("<td align='left' style='width: 120px'>&nbsp;</td>");
                                    lstLeaseType.Append("<td align='left' style='width: 250px'>&nbsp;</td>");
                                    lstLeaseType.Append("<td align='left' style='width: 250px'>&nbsp;</td>");
                                    lstLeaseType.Append(" </tr>");

                                    lstLeaseType.Append("</table>");
                                    lstLeaseType.Append("</td></tr>");
                                    lstLeaseType.Append("</table>");
                                    lstLeaseType.Append("</td></tr>");
                                }
                            }
                            //Footer Row
                            lstLeaseType.Append("<tr align='left'><td align='left'>");
                            lstLeaseType.Append(" <table width='2500px' cellpadding='0' cellspacing='0' border='0'>");
                            lstLeaseType.Append("<tr><td align='left'>");
                            lstLeaseType.Append("<table width='2500px' cellpadding='4' cellspacing='0' border='1' style='font-weight: bold;background-color: #507CD1; color: White;'>");

                            lstLeaseType.Append(" <tr style='font-weight: bold;'>");
                            lstLeaseType.Append("<td align='left' style='width: 120px'>Grand Total : </td>");
                            lstLeaseType.Append("<td align='left' style='width: 150px'>" + Convert.ToString(dsGroup.Tables[1].Rows[0][0]) + "</td>");
                            lstLeaseType.Append("<td align='left' style='width: 180px'>&nbsp;</td>");
                            lstLeaseType.Append("<td align='left' style='width: 180px'>&nbsp;</td>");
                            lstLeaseType.Append("<td align='left' style='width: 150px'>&nbsp;</td>");
                            lstLeaseType.Append("<td align='left' style='width: 150px'>&nbsp;</td>");
                            lstLeaseType.Append("<td align='left' style='width: 120px'>&nbsp;</td>");
                            lstLeaseType.Append("<td align='left' style='width: 150px'>&nbsp;</td>");
                            lstLeaseType.Append("<td align='right' style='width: 150px'>" + string.Format("{0:N0}", Convert.ToString(dsGroup.Tables[2].Rows[0][0])) + " </td>");
                            lstLeaseType.Append("<td align='left' style='width: 150px'>&nbsp;</td>");
                            lstLeaseType.Append("<td align='left' style='width: 180px'>&nbsp;</td>");
                            lstLeaseType.Append("<td align='left' style='width: 100px'>&nbsp;</td>");
                            lstLeaseType.Append("<td align='left' style='width: 100px'>&nbsp;</td>");
                            lstLeaseType.Append("<td align='left' style='width: 120px'>&nbsp;</td>");
                            lstLeaseType.Append("<td align='left' style='width: 250px'>&nbsp;</td>");
                            lstLeaseType.Append("<td align='left' style='width: 250px'>&nbsp;</td>");
                            lstLeaseType.Append(" </tr>");

                            lstLeaseType.Append("</table>");
                            lstLeaseType.Append("</td></tr>");
                            lstLeaseType.Append("</table>");
                            lstLeaseType.Append("</td></tr>");
                        }
                        else
                        {
                            lstLeaseType.Append("<tr> <td style='font-weight: bold;'> No Record Found.");
                            lstLeaseType.Append("</td></tr>");
                        }
                        lstLeaseType.Append("</table>");
                        #endregion

                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(lstLeaseType.ToString());

                        //Send Mail
                        SendMail("Lease Details Report", "LeaseDetails.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in Lease Detail Report, " + ex.Message + " - " + ex.StackTrace.ToString() + " - " + ex.Source.ToString());
            }
        }

        //Report 28
        private void BindRentProjectionsHistoryReport(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(28, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list 
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = Convert.ToString(dtUser.Rows[0]["FIRST_NAME"]).Trim();
                        strLastName = Convert.ToString(dtUser.Rows[0]["LAST_NAME"]).Trim();
                        strMailFrom = Convert.ToString(dtUser.Rows[0]["Email"]).Trim();

                        string strRegion = Convert.ToString(dtFilter.Rows[0]["Region"]).Trim();
                        string strLeaseType = Convert.ToString(dtFilter.Rows[0]["LeaseType"]).Trim();
                        string strEscalationType = Convert.ToString(dtFilter.Rows[0]["EscalationType"]).Trim();

                        Int16? RentYear_From = null, RentYear_To = null;

                        if (dtFilter.Rows[0]["RentYear_From"] != DBNull.Value)
                            RentYear_From = Convert.ToInt16(dtFilter.Rows[0]["RentYear_From"]);

                        if (dtFilter.Rows[0]["RentYear_To"] != DBNull.Value)
                            RentYear_To = Convert.ToInt16(dtFilter.Rows[0]["RentYear_To"]);

                        //Get the all Unique records for Selected group (default - last name -sort) by search criteria
                        DataSet dsResult = Report.GetRentProjectionsHistory(strRegion, strLeaseType, RentYear_From, RentYear_To, strEscalationType);

                        //Create HTML for the report and wirte into HTML Write object
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        #region "Report Title"

                        //Add Report Title and Schedule Date
                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : Rent Projections/History</b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"].ToString());
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        //Add Report Filter Criteria 
                        strHTML.Append("<br /><br /><table> <tr> <td>");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br /><table> <tr> <td colspan='8'>");
                        strHTML.Append("Location   : " + (string.IsNullOrEmpty(strRegion) ? "" : GetCommaValueFromTable(Report.getLocationByIds(strRegion).Tables[0], "DBA")));
                        strHTML.Append("</td> </tr> <tr> <td colspan='8'>");
                        strHTML.Append("Lease Type : " + Report.GetLeaseTypeList(strLeaseType));
                        strHTML.Append("</td></tr> <tr> <td colspan='8'>");
                        strHTML.Append("Escalation Type : " + Report.GetEscalationTypeList(strEscalationType));
                        strHTML.Append("</td></tr> <tr> <td>");
                        strHTML.Append("Lease Year From : " + (RentYear_From == null ? "" : RentYear_From.ToString()));
                        strHTML.Append("</td></tr> <tr> <td>");
                        strHTML.Append("Lease Year To : " + (RentYear_To == null ? "" : RentYear_To.ToString()));
                        strHTML.Append("</td></tr></table> ");
                        strHTML.Append("<br /><br />");

                        #endregion

                        #region "Report Grid header"

                        strHTML.Append("<table border='1'>");
                        strHTML.Append("<tr style='font-weight: bold' valign='bottom' align='left'>");
                        strHTML.Append("<td align='left' colspan='2'> Sonic Automotive </td>");
                        strHTML.Append("<td align='center' colspan='3'> Rent Projections/History </td>");
                        strHTML.Append("<td align='right' colspan='3'> " + DateTime.Now.ToString() + "</td></tr>");
                        strHTML.Append("<tr valign='bottom;' style='font-weight: bold' align='left'>");
                        strHTML.Append("<td> Location </td>");
                        strHTML.Append("<td> Year </td>");
                        strHTML.Append("<td> From </td>");
                        strHTML.Append("<td> To </td>");
                        strHTML.Append("<td align='right'> No. of Month </td>");
                        strHTML.Append("<td align='right'> Annual Rent </td>");
                        strHTML.Append("<td align='right'> CPI Rate </td>");
                        strHTML.Append("<td align='right'> Total Rent </td>");
                        strHTML.Append("</tr>");


                        if (dsResult.Tables[0].Rows.Count > 0)
                        {
                            foreach (DataRow drReport in dsResult.Tables[0].Rows)
                            {
                                strHTML.Append("<tr valign='bottom' align='left'>");
                                strHTML.Append("<td> " + Convert.ToString(drReport["DBA"]) + " </td>");
                                strHTML.Append("<td> " + (drReport["Year"] != DBNull.Value ? drReport["Year"].ToString() : "") + " </td>");
                                strHTML.Append("<td> " + FormatDBNullDateToDisplay(drReport["From_Date"]) + " </td>");
                                strHTML.Append("<td> " + FormatDBNullDateToDisplay(drReport["To_Date"]) + " </td>");
                                strHTML.Append("<td align='right'> " + string.Format("{0:N2}", drReport["Months"]) + " </td>");
                                strHTML.Append("<td align='right'> " + string.Format("{0:C2}", drReport["Monthly_Rent"]) + " </td>");
                                strHTML.Append("<td align='right'> " + string.Format("{0:N2}", drReport["Percentage_Rate"]) + " </td>");
                                strHTML.Append("<td align='right'> " + string.Format("{0:C2}", drReport["Total_Rent"]) + " </td>");
                                strHTML.Append("</tr>");
                            }
                        }
                        else
                        {
                            //Add No record found line for year
                            strHTML.Append("<tr><td align='left' colspan='8'>No Record Found!</td></tr>");
                        }
                        strHTML.Append("</table>");
                        #endregion

                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        SendMail("Rent Projections/History Report", "RentProjectionsHistoryReport.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in Rent Projections/History Report, " + ex.Message + " - " + ex.StackTrace.ToString() + " - " + ex.Source.ToString());
            }
        }

        // Report 29
        private void BindLeaseTerm(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(29, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list 
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = Convert.ToString(dtUser.Rows[0]["FIRST_NAME"]).Trim();
                        strLastName = Convert.ToString(dtUser.Rows[0]["LAST_NAME"]).Trim();
                        strMailFrom = Convert.ToString(dtUser.Rows[0]["Email"]).Trim();

                        //Set all filters to a variable as per report type
                        DateTime? dtLCDFrom = null, dtLCDTo = null, dtLEDFrom = null, dtLEDTo = null;

                        string strRegion = Convert.ToString(dtFilter.Rows[0]["Region"]).Trim();
                        string strMarket = null;
                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Market"])))
                        {
                            strMarket = Convert.ToString(dtFilter.Rows[0]["Market"]).Trim();
                        }
                        string strLeaseType = Convert.ToString(dtFilter.Rows[0]["LeaseType"]).Trim();

                        if (dtFilter.Rows[0]["LCDFrom_Date"] != DBNull.Value)
                            dtLCDFrom = Convert.ToDateTime(dtFilter.Rows[0]["LCDFrom_Date"]);

                        if (Convert.ToString(dtFilter.Rows[0]["LCDTo_Date"]) != string.Empty && dtFilter.Rows[0]["LCDTo_Date"] != DBNull.Value)
                            dtLCDTo = Convert.ToDateTime(dtFilter.Rows[0]["LCDTo_Date"]);

                        if (Convert.ToString(dtFilter.Rows[0]["LEDFrom_Date"]) != string.Empty && dtFilter.Rows[0]["LEDFrom_Date"] != DBNull.Value)
                            dtLEDFrom = Convert.ToDateTime(dtFilter.Rows[0]["LEDFrom_Date"]);

                        if (Convert.ToString(dtFilter.Rows[0]["LEDTo_Date"]) != string.Empty && dtFilter.Rows[0]["LEDTo_Date"] != DBNull.Value)
                            dtLEDTo = Convert.ToDateTime(dtFilter.Rows[0]["LEDTo_Date"]);

                        //Get the all Unique records for Selected group (default - last name -sort) by search criteria
                        DataSet dsResult = Report.GetLeaseTermReport(strRegion, strMarket, strLeaseType, dtLCDFrom, dtLCDTo, dtLEDFrom, dtLEDTo);

                        //Create HTML for the report and wirte into HTML Write object
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        #region "Search Criteria"

                        //Retrieve Market Values
                        string strMarketString = string.Empty;
                        if (string.IsNullOrEmpty(strMarket))
                        {
                            strMarketString = "All Market";
                        }
                        else
                        {
                            string[] strMar = strMarket.Split(Convert.ToChar(","));
                            for (int i = 0; i < strMar.Length; i++)
                            {
                                strMarketString += Report.SelectMarketInfoById(Convert.ToDecimal(strMar[i].ToString())).Tables[0].Rows[0]["Market"].ToString() + ",";
                            }
                            strMarketString = strMarketString.TrimEnd(',');
                        }

                        //Add Report Title and Schedule Date
                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : Lease Term Report</b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"].ToString());
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        //Add Report Filter Criteria 
                        strHTML.Append("<br /><br />");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Region        : " + strRegion.Replace("'", ""));
                        strHTML.Append("<br />");
                        strHTML.Append("Market        : " + strMarketString);
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Lease Type    : " + Report.GetLeaseTypeList(strLeaseType));
                        strHTML.Append("<br />");
                        strHTML.Append("LCD From      : " + FormatDBNullDateToDisplay(dtLCDFrom));
                        strHTML.Append("<br />");
                        strHTML.Append("LCD To        : " + FormatDBNullDateToDisplay(dtLCDTo));
                        strHTML.Append("<br />");
                        strHTML.Append("LED From      : " + FormatDBNullDateToDisplay(dtLEDFrom));
                        strHTML.Append("<br />");
                        strHTML.Append("LED To        : " + FormatDBNullDateToDisplay(dtLEDTo));
                        strHTML.Append("<br /><br />");

                        #endregion

                        #region "Report Grid header"

                        strHTML.Append("<table border='1'>");
                        strHTML.Append("<tr style='font-weight: bold' valign='bottom' align='left'>");
                        strHTML.Append("<td align='left' colspan='3'>Sonic Automotive</td>");
                        strHTML.Append("<td align='center' colspan='5'>Lease Term</td>");
                        strHTML.Append("<td align='right' colspan='2'> " + DateTime.Now.ToString() + " </td>");
                        strHTML.Append("</tr>");
                        strHTML.Append("<tr valign='bottom' align='left' style='font-weight: bold'>");
                        strHTML.Append("<td>LL Notify Date</td>");
                        strHTML.Append("<td>Location</td>");
                        strHTML.Append("<td>Region</td>");
                        strHTML.Append("<td>Lease Type</td>");
                        strHTML.Append("<td align='right'>Rentable Area</td>");
                        strHTML.Append("<td>LCD</td>");
                        strHTML.Append("<td>Prior Lease Commencement Date</td>");
                        strHTML.Append("<td>LED</td>");
                        strHTML.Append("<td align='center'>Lease Term</td>");
                        strHTML.Append("<td>Renew/ Cancel Option</td>");
                        strHTML.Append("</tr>");

                        if (dsResult.Tables[0].Rows.Count > 0)
                        {
                            foreach (DataRow drReport in dsResult.Tables[0].Rows)
                            {
                                strHTML.Append("<tr valign='top' align='left'>");
                                strHTML.Append("<td> " + FormatDBNullDateToDisplay(drReport["Landlord_Notification_Date"]) + " </td>");
                                strHTML.Append("<td> " + Convert.ToString(drReport["DBA"]) + " </td>");
                                strHTML.Append("<td> " + Convert.ToString(drReport["Region"]) + " </td>");
                                strHTML.Append("<td> " + Convert.ToString(drReport["LU_Lease_Type"]) + " </td>");
                                strHTML.Append("<td align='right'> " + string.Format("{0:N0}", drReport["Total_Gross_Leaseable_Area"]) + " </td>");
                                strHTML.Append("<td> " + FormatDBNullDateToDisplay(drReport["Lease_Commencement_Date"]) + " </td>");
                                strHTML.Append("<td> " + FormatDBNullDateToDisplay(drReport["Prior_Lease_Commencement_Date"]) + " </td>");
                                strHTML.Append("<td> " + FormatDBNullDateToDisplay(drReport["Lease_Expiration_Date"]) + " </td>");
                                strHTML.Append("<td align='right'> " + string.Format("{0:N0}", drReport["Lease_Term_Months"]) + " </td>");
                                strHTML.Append("<td align='left'> " + Convert.ToString("<b>Cancel Options</b> " + drReport["Cancel_Options"] + "<br style='mso-data-placement:same-cell;'>" + "<b>Renew Options</b> " + drReport["Renew_Options"]) + " </td>");
                                strHTML.Append("</tr>");
                            }

                            strHTML.Append("<tr valign='top' align='left' style='font-weight: bold; background-color: #507CD1;color: White;'>");
                            strHTML.Append("<td> Grand Total </td>");
                            strHTML.Append("<td>" + dsResult.Tables[0].Rows.Count.ToString() + "</td><td></td><td></td>");
                            strHTML.Append("<td align='right'> " + string.Format("{0:N0}", dsResult.Tables[0].Compute("SUM(Total_Gross_Leaseable_Area)", "")) + " </td>");
                            strHTML.Append("<td> </td><td> </td><td> </td>");
                            strHTML.Append("<td> </td>");
                            strHTML.Append("<td </td>");
                            strHTML.Append("</tr>");
                        }
                        else
                        {
                            //Add No record found line for year
                            strHTML.Append("<tr><td align='left' colspan='10'>No Record Found!</td></tr>");
                        }
                        strHTML.Append("</table>");
                        #endregion

                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        SendMail("Lease Term Report", "LeaseTermReport.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in Lease Term Report, " + ex.Message + " - " + ex.StackTrace.ToString() + " - " + ex.Source.ToString());
            }
        }

        // Report 30
        private void BindSubspacesByLocation(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(30, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list 
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = Convert.ToString(dtUser.Rows[0]["FIRST_NAME"]).Trim();
                        strLastName = Convert.ToString(dtUser.Rows[0]["LAST_NAME"]).Trim();
                        strMailFrom = Convert.ToString(dtUser.Rows[0]["Email"]).Trim();

                        //Set all filters to a variable as per report type
                        DateTime? dtLCDFrom = null, dtLCDTo = null, dtLEDFrom = null, dtLEDTo = null;

                        string strRegion = Convert.ToString(dtFilter.Rows[0]["Region"]).Trim();
                        string strMarket = null;
                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Market"])))
                        {
                            strMarket = Convert.ToString(dtFilter.Rows[0]["Market"]).Trim();
                        }
                        string strLeaseType = Convert.ToString(dtFilter.Rows[0]["LeaseType"]).Trim();

                        if (dtFilter.Rows[0]["LCDFrom_Date"] != DBNull.Value)
                            dtLCDFrom = Convert.ToDateTime(dtFilter.Rows[0]["LCDFrom_Date"]);

                        if (Convert.ToString(dtFilter.Rows[0]["LCDTo_Date"]) != string.Empty && dtFilter.Rows[0]["LCDTo_Date"] != DBNull.Value)
                            dtLCDTo = Convert.ToDateTime(dtFilter.Rows[0]["LCDTo_Date"]);

                        if (Convert.ToString(dtFilter.Rows[0]["LEDFrom_Date"]) != string.Empty && dtFilter.Rows[0]["LEDFrom_Date"] != DBNull.Value)
                            dtLEDFrom = Convert.ToDateTime(dtFilter.Rows[0]["LEDFrom_Date"]);

                        if (Convert.ToString(dtFilter.Rows[0]["LEDTo_Date"]) != string.Empty && dtFilter.Rows[0]["LEDTo_Date"] != DBNull.Value)
                            dtLEDTo = Convert.ToDateTime(dtFilter.Rows[0]["LEDTo_Date"]);

                        //Get the all Unique records for Selected group (default - last name -sort) by search criteria
                        DataSet dsResult = Report.GetSubspacesByLocation(strRegion, strMarket, strLeaseType, dtLCDFrom, dtLCDTo, dtLEDFrom, dtLEDTo);

                        //Create HTML for the report and wirte into HTML Write object
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        #region "Report Criteria"

                        //Retrieve Market Values
                        string strMarketString = string.Empty;
                        if (string.IsNullOrEmpty(strMarket))
                        {
                            strMarketString = "All Market";
                        }
                        else
                        {
                            string[] strMar = strMarket.Split(Convert.ToChar(","));
                            for (int i = 0; i < strMar.Length; i++)
                            {
                                strMarketString += Report.SelectMarketInfoById(Convert.ToDecimal(strMar[i].ToString())).Tables[0].Rows[0]["Market"].ToString() + ",";
                            }
                            strMarketString = strMarketString.TrimEnd(',');
                        }

                        //Add Report Title and Schedule Date
                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : Subspaces By Location </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"].ToString());
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        //Add Report Filter Criteria 
                        strHTML.Append("<br /><br />");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Region        : " + strRegion.Replace("'", ""));
                        strHTML.Append("<br />");
                        strHTML.Append("Market        : " + strMarketString);
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Lease Type    : " + Report.GetLeaseTypeList(strLeaseType));
                        strHTML.Append("<br />");
                        strHTML.Append("LCD From      : " + FormatDBNullDateToDisplay(dtLCDFrom));
                        strHTML.Append("<br />");
                        strHTML.Append("LCD To        : " + FormatDBNullDateToDisplay(dtLCDTo));
                        strHTML.Append("<br />");
                        strHTML.Append("LED From      : " + FormatDBNullDateToDisplay(dtLEDFrom));
                        strHTML.Append("<br />");
                        strHTML.Append("LED To        : " + FormatDBNullDateToDisplay(dtLEDTo));
                        strHTML.Append("<br /><br />");

                        #endregion

                        #region "Report Grid header"

                        strHTML.Append("<table border='1'>");
                        strHTML.Append("<tr style='font-weight: bold' valign='bottom' align='left'>");
                        strHTML.Append("<td align='left' colspan='3'>Sonic Automotive</td>");
                        strHTML.Append("<td align='center' colspan='4'>Subspaces By Location </td>");
                        strHTML.Append("<td align='right' colspan='3'>" + DateTime.Now.ToString() + "</td>");
                        strHTML.Append("</tr>");
                        strHTML.Append("<tr valign='bottom' align='left' style='font-weight: bold'>");
                        strHTML.Append("<td>Region </td>");
                        strHTML.Append("<td>Lease Type</td>");
                        strHTML.Append("<td align='right'>Rentable Area</td>");
                        strHTML.Append("<td>Subtenant DBA</td>");
                        strHTML.Append("<td>LED </td>");
                        strHTML.Append("<td>Prior Lease Commencement Date</td>");
                        strHTML.Append("<td>LCD</td>");
                        strHTML.Append("<td align='center'>Subspaces Term</td>");
                        strHTML.Append("<td>Renew/ Cancel Option</td>");
                        strHTML.Append("<td>Landlord </td>");
                        strHTML.Append("</tr>");

                        // set Location Table 
                        DataTable dtLocation = dsResult.Tables[1];

                        // Check if record is exist for location
                        if (dtLocation.Rows.Count > 0)
                        {
                            // loop for all location
                            foreach (DataRow drLocation in dtLocation.Rows)
                            {
                                // filter Reprot Result by Locaion ID
                                DataTable dtReportDetail = dsResult.Tables[0];
                                dtReportDetail.DefaultView.RowFilter = " PK_LU_Location_Id = " + drLocation["PK_LU_Location_Id"].ToString();
                                dtReportDetail.DefaultView.Sort = "Region";
                                dtReportDetail = dtReportDetail.DefaultView.ToTable();

                                // display location for filter
                                strHTML.Append("<tr valign='top' align='left'>");
                                strHTML.Append("<td colspan='10' align-'left'><b> Location : " + Convert.ToString(drLocation["dba"]) + "</b></td>");
                                strHTML.Append("</tr>");

                                // print Report Detail
                                if (dtReportDetail.Rows.Count > 0)
                                {
                                    // display record for Location
                                    foreach (DataRow drReport in dtReportDetail.Rows)
                                    {
                                        strHTML.Append("<tr valign='top' align='left'>");
                                        strHTML.Append("<td> " + Convert.ToString(drReport["Region"]) + " </td>");
                                        strHTML.Append("<td> " + Convert.ToString(drReport["LU_Lease_Type"]) + " </td>");
                                        strHTML.Append("<td  align='right'> " + string.Format("{0:N0}", drReport["Total_Gross_Leaseable_Area"]) + " </td>");
                                        strHTML.Append("<td> " + Convert.ToString(drReport["Subtenant_DBA"]) + " </td>");
                                        strHTML.Append("<td> " + FormatDBNullDateToDisplay(drReport["Lease_Expiration_Date"]) + " </td>");
                                        strHTML.Append("<td> " + FormatDBNullDateToDisplay(drReport["Prior_Lease_Commencement_Date"]) + " </td>");
                                        strHTML.Append("<td> " + FormatDBNullDateToDisplay(drReport["Lease_Commencement_Date"]) + " </td>");
                                        strHTML.Append("<td align='right'> " + string.Format("{0:N0}", drReport["Lease_Term_Months"]) + " </td>");
                                        strHTML.Append("<td align='left'> " + Convert.ToString("<b>Cancel Options</b> " + drReport["Cancel_Options"] + "<br style='mso-data-placement:same-cell;'>" + "<b>Renew Options</b> " + drReport["Renew_Options"]) + " </td>");
                                        strHTML.Append("<td> " + Convert.ToString(drReport["Landlord"]) + " </td>");
                                        strHTML.Append("</tr>");
                                    }

                                    // print Sub Total by Location
                                    strHTML.Append("<tr valign='top' align='left' style='font-weight: bold;'>");
                                    strHTML.Append("<td> Sub Total </td>");
                                    strHTML.Append("<td>" + dtReportDetail.Rows.Count.ToString() + "</td>");
                                    strHTML.Append("<td align='right'> " + string.Format("{0:N0}", dtReportDetail.Compute("SUM(Total_Gross_Leaseable_Area)", "")) + " </td>");
                                    strHTML.Append("<td> <td> <td> <td> <td> <td><td></td>");
                                    strHTML.Append("</tr>");
                                }
                                else
                                {
                                    //Add No record found line for year
                                    strHTML.Append("<tr><td align='left' colspan='10'>No Record Found!</td></tr>");
                                }

                            }

                            // print Grand Total for Whole Report
                            strHTML.Append("<tr valign='top' align='left' style='font-weight: bold; background-color: #507CD1;color: White;'>");
                            strHTML.Append("<td> Grand Total </td>");
                            strHTML.Append("<td>" + dsResult.Tables[0].Rows.Count.ToString() + "</td>");
                            strHTML.Append("<td align='right'> " + string.Format("{0:N0}", dsResult.Tables[0].Compute("SUM(Total_Gross_Leaseable_Area)", "")) + " </td>");
                            strHTML.Append("<td> <td> <td> <td> <td> <td><td></td>");
                            strHTML.Append("</tr>");

                        }
                        strHTML.Append("</table>");
                        #endregion

                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        SendMail("Subspaces By Location Report", "SubspacesByLocationReprot.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in Subspaces By Location, " + ex.Message + " - " + ex.StackTrace.ToString() + " - " + ex.Source.ToString());
            }
        }

        // Report 31
        private void BindRentableAreaByExpirationDate(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(31, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list 
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = Convert.ToString(dtUser.Rows[0]["FIRST_NAME"]).Trim();
                        strLastName = Convert.ToString(dtUser.Rows[0]["LAST_NAME"]).Trim();
                        strMailFrom = Convert.ToString(dtUser.Rows[0]["Email"]).Trim();

                        //Set all filters to a variable as per report type
                        DateTime? dtLCDFrom = null, dtLCDTo = null, dtLEDFrom = null, dtLEDTo = null;

                        string strRegion = Convert.ToString(dtFilter.Rows[0]["Region"]).Trim();
                        string strMarket = null;
                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Market"])))
                        {
                            strMarket = Convert.ToString(dtFilter.Rows[0]["Market"]).Trim();
                        }
                        string strLeaseType = Convert.ToString(dtFilter.Rows[0]["LeaseType"]).Trim();

                        if (dtFilter.Rows[0]["LCDFrom_Date"] != DBNull.Value)
                            dtLCDFrom = Convert.ToDateTime(dtFilter.Rows[0]["LCDFrom_Date"]);

                        if (Convert.ToString(dtFilter.Rows[0]["LCDTo_Date"]) != string.Empty && dtFilter.Rows[0]["LCDTo_Date"] != DBNull.Value)
                            dtLCDTo = Convert.ToDateTime(dtFilter.Rows[0]["LCDTo_Date"]);

                        if (Convert.ToString(dtFilter.Rows[0]["LEDFrom_Date"]) != string.Empty && dtFilter.Rows[0]["LEDFrom_Date"] != DBNull.Value)
                            dtLEDFrom = Convert.ToDateTime(dtFilter.Rows[0]["LEDFrom_Date"]);

                        if (Convert.ToString(dtFilter.Rows[0]["LEDTo_Date"]) != string.Empty && dtFilter.Rows[0]["LEDTo_Date"] != DBNull.Value)
                            dtLEDTo = Convert.ToDateTime(dtFilter.Rows[0]["LEDTo_Date"]);

                        //Get the all Unique records for Selected group (default - last name -sort) by search criteria
                        DataSet dsResult = Report.GetRentableAreaByExpirationDate(strRegion, strMarket, strLeaseType, dtLCDFrom, dtLCDTo, dtLEDFrom, dtLEDTo);

                        //Create HTML for the report and wirte into HTML Write object
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        #region "Search Criteria"

                        //Retrieve Market Values
                        string strMarketString = string.Empty;
                        if (string.IsNullOrEmpty(strMarket))
                        {
                            strMarketString = "All Market";
                        }
                        else
                        {
                            string[] strMar = strMarket.Split(Convert.ToChar(","));
                            for (int i = 0; i < strMar.Length; i++)
                            {
                                strMarketString += Report.SelectMarketInfoById(Convert.ToDecimal(strMar[i].ToString())).Tables[0].Rows[0]["Market"].ToString() + ",";
                            }
                            strMarketString = strMarketString.TrimEnd(',');
                        }

                        //Add Report Title and Schedule Date
                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : Rentable Area By Expiration Date </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"].ToString());
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        //Add Report Filter Criteria 
                        strHTML.Append("<br /><br />");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Region        : " + strRegion.Replace("'", ""));
                        strHTML.Append("<br />");
                        strHTML.Append("Market        : " + strMarketString);
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Lease Type    : " + Report.GetLeaseTypeList(strLeaseType));
                        strHTML.Append("<br />");
                        strHTML.Append("LCD From      : " + FormatDBNullDateToDisplay(dtLCDFrom));
                        strHTML.Append("<br />");
                        strHTML.Append("LCD To        : " + FormatDBNullDateToDisplay(dtLCDTo));
                        strHTML.Append("<br />");
                        strHTML.Append("LED From      : " + FormatDBNullDateToDisplay(dtLEDFrom));
                        strHTML.Append("<br />");
                        strHTML.Append("LED To        : " + FormatDBNullDateToDisplay(dtLEDTo));
                        strHTML.Append("<br /><br />");

                        #endregion

                        #region "Report Grid header"
                        //FirstMonthName + "&nbsp;" + (Curr_Month + 1).ToString() + "<br style='mso-data-placement:same-cell;'> To " + LastMonthName + "&nbsp;" + (Curr_Month + 1).ToString()

                        strHTML.Append("<table border='1'>");
                        strHTML.Append("<tr style='font-weight: bold' valign='bottom' align='left'>");
                        strHTML.Append("<td align='left' colspan='3'>Sonic Automotive</td>");
                        strHTML.Append("<td align='center' colspan='5'>Rentable Area By Expiration Date</td>");
                        strHTML.Append("<td align='right' colspan='3'> " + DateTime.Now.ToString() + " </td>");
                        strHTML.Append("</tr>");
                        strHTML.Append("<tr valign='bottom' align='left' style='font-weight: bold'>");
                        strHTML.Append("<td>Region</td>");

                        for (int i = 0; i < 10; i++)
                            strHTML.Append("<td align='center'> " + FirstMonthName + "&nbsp;" + (DateTime.Now.Year + i).ToString() + "<br style='mso-data-placement:same-cell;'> To " + LastMonthName + "&nbsp;" + (DateTime.Now.Year + 1).ToString() + "</td>");

                        strHTML.Append("</tr>");

                        if (dsResult.Tables[0].Rows.Count > 0)
                        {
                            foreach (DataRow drReport in dsResult.Tables[0].Rows)
                            {
                                strHTML.Append("<tr valign='top' align='left'>");
                                strHTML.Append("<td> " + Convert.ToString(drReport["Region"]) + " </td>");

                                for (int j = 1; j <= 10; j++)
                                    strHTML.Append("<td align='right'> " + string.Format("{0:N0}", drReport["Total_Gross_Leaseable_Area" + j.ToString()]) + " </td>");
                                strHTML.Append("</tr>");
                            }

                            strHTML.Append("<tr valign='top' align='left' style='font-weight: bold; background-color: #507CD1;color: White;'>");
                            strHTML.Append("<td> Grand Total </td>");

                            for (int j = 1; j <= 10; j++)
                                strHTML.Append("<td align='right'> " + string.Format("{0:N0}", dsResult.Tables[0].Compute("sum(Total_Gross_Leaseable_Area" + j.ToString() + ")", "")) + " </td>");

                            strHTML.Append("</tr>");
                        }
                        else
                        {
                            //Add No record found line for year
                            strHTML.Append("<tr><td align='left' colspan='11'>No Record Found!</td></tr>");
                        }
                        strHTML.Append("</table>");
                        #endregion

                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        SendMail("Rentable Area By Expiration Date Report", "RentableAreaByExpirationDate.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in Rentable Area By Expiration Date Report, " + ex.Message + " - " + ex.StackTrace.ToString() + " - " + ex.Source.ToString());
            }
        }

        // Report 32
        private void BindMonthlyExpenseByLocation(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(32, pK_Schedule_ID).Tables[0];

                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list 
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];
                    DataTable dtLocationDtl, dtLocation, dtReportDetail;
                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                    String strFirstName, strLastName, strMailFrom, strAddress = "";

                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = Convert.ToString(dtUser.Rows[0]["FIRST_NAME"]).Trim();
                        strLastName = Convert.ToString(dtUser.Rows[0]["LAST_NAME"]).Trim();
                        strMailFrom = Convert.ToString(dtUser.Rows[0]["Email"]).Trim();

                        //Set all filters to a variable as per report type
                        DateTime? dtLCDFrom = null, dtLCDTo = null, dtLEDFrom = null, dtLEDTo = null;

                        string strRegion = Convert.ToString(dtFilter.Rows[0]["Region"]).Trim();
                        string strMarket = null;
                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Market"])))
                        {
                            strMarket = Convert.ToString(dtFilter.Rows[0]["Market"]).Trim();
                        }
                        string strLeaseType = Convert.ToString(dtFilter.Rows[0]["LeaseType"]).Trim();

                        if (dtFilter.Rows[0]["LCDFrom_Date"] != DBNull.Value)
                            dtLCDFrom = Convert.ToDateTime(dtFilter.Rows[0]["LCDFrom_Date"]);

                        if (Convert.ToString(dtFilter.Rows[0]["LCDTo_Date"]) != string.Empty && dtFilter.Rows[0]["LCDTo_Date"] != DBNull.Value)
                            dtLCDTo = Convert.ToDateTime(dtFilter.Rows[0]["LCDTo_Date"]);

                        if (Convert.ToString(dtFilter.Rows[0]["LEDFrom_Date"]) != string.Empty && dtFilter.Rows[0]["LEDFrom_Date"] != DBNull.Value)
                            dtLEDFrom = Convert.ToDateTime(dtFilter.Rows[0]["LEDFrom_Date"]);

                        if (Convert.ToString(dtFilter.Rows[0]["LEDTo_Date"]) != string.Empty && dtFilter.Rows[0]["LEDTo_Date"] != DBNull.Value)
                            dtLEDTo = Convert.ToDateTime(dtFilter.Rows[0]["LEDTo_Date"]);

                        //Get the all Unique records for Selected group (default - last name -sort) by search criteria
                        DataSet dsResult = Report.GetMonthlyExpenseByLocation(strRegion, strMarket, strLeaseType, dtLCDFrom, dtLCDTo, dtLEDFrom, dtLEDTo);

                        //Create HTML for the report and wirte into HTML Write object
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        #region "Report Criteria"

                        //Retrieve Market Values
                        string strMarketString = string.Empty;
                        if (string.IsNullOrEmpty(strMarket))
                        {
                            strMarketString = "All Market";
                        }
                        else
                        {
                            string[] strMar = strMarket.Split(Convert.ToChar(","));
                            for (int i = 0; i < strMar.Length; i++)
                            {
                                strMarketString += Report.SelectMarketInfoById(Convert.ToDecimal(strMar[i].ToString())).Tables[0].Rows[0]["Market"].ToString() + ",";
                            }
                            strMarketString = strMarketString.TrimEnd(',');
                        }

                        //Add Report Title and Schedule Date
                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : Monthly Expense By Location </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"].ToString());
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        //Add Report Filter Criteria 
                        strHTML.Append("<br /><br />");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Region        : " + strRegion.Replace("'", ""));
                        strHTML.Append("<br />");
                        strHTML.Append("Market        : " + strMarketString);
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Lease Type    : " + Report.GetLeaseTypeList(strLeaseType));
                        strHTML.Append("<br />");
                        strHTML.Append("LCD From      : " + FormatDBNullDateToDisplay(dtLCDFrom));
                        strHTML.Append("<br />");
                        strHTML.Append("LCD To        : " + FormatDBNullDateToDisplay(dtLCDTo));
                        strHTML.Append("<br />");
                        strHTML.Append("LED From      : " + FormatDBNullDateToDisplay(dtLEDFrom));
                        strHTML.Append("<br />");
                        strHTML.Append("LED To        : " + FormatDBNullDateToDisplay(dtLEDTo));
                        strHTML.Append("<br /><br />");

                        #endregion

                        #region "Report Grid header"

                        strHTML.Append("<table border='1'>");
                        strHTML.Append("<tr style='font-weight: bold' valign='bottom' align='left'>");
                        strHTML.Append("<td align='left' colspan='2'>Sonic Automotive</td>");
                        strHTML.Append("<td align='center' colspan='4'>Monthly Expense By Location </td>");
                        strHTML.Append("<td align='right' colspan='11'>" + DateTime.Now.ToString() + "</td>");
                        strHTML.Append("</tr>");
                        strHTML.Append("<tr valign='bottom' align='left' style='font-weight: bold'>");
                        strHTML.Append("<td>Location </td>");
                        strHTML.Append("<td>Address </td>");
                        strHTML.Append("<td>Region </td>");
                        strHTML.Append("<td>Subtenant </td>");
                        strHTML.Append("<td align='right'>Rentable Area </td>");

                        // for Display Month in Header 
                        for (int i = 0; i < 12; i++)
                            strHTML.Append("<td align='right' style=" + "\"" + "mso-number-format: 'mmm\\-yy';" + "\"" + ">" + Microsoft.VisualBasic.DateAndTime.MonthName(DateTime.Now.AddMonths(i).Month, true) + "-" + DateTime.Now.AddMonths(1).ToString("yy") + " </td>");

                        strHTML.Append("</tr>");

                        // Location Wise Total and Sum
                        dtLocationDtl = dsResult.Tables[1];
                        // set Location Table 
                        dtLocation = dsResult.Tables[2];

                        // Check if record is exist for location
                        if (dtLocation.Rows.Count > 0)
                        {
                            // loop for all location
                            foreach (DataRow drLocation in dtLocation.Rows)
                            {
                                // filter Reprot Result by Locaion ID
                                dtReportDetail = dsResult.Tables[0];
                                dtReportDetail.DefaultView.RowFilter = " PK_LU_Location_Id = " + drLocation["PK_LU_Location_Id"].ToString();
                                dtReportDetail.DefaultView.Sort = "Region";
                                dtReportDetail = dtReportDetail.DefaultView.ToTable();

                                // display location for filter
                                strHTML.Append("<tr valign='top' align='left'>");
                                strHTML.Append("<td colspan='17' align-'left'><b> Location : " + Convert.ToString(drLocation["dba"]) + "</b></td>");
                                strHTML.Append("</tr>");

                                #region "Report Detail"
                                // print Report Detail
                                if (dtReportDetail.Rows.Count > 0)
                                {
                                    // display record for Location
                                    foreach (DataRow drReport in dtReportDetail.Rows)
                                    {
                                        strAddress = Convert.ToString(drReport["Address_1"]).Trim() + "<br style='mso-data-placement:same-cell;'>" + Convert.ToString(drReport["City"]).Trim() +
                                                                                    "<br style='mso-data-placement:same-cell;'>" + Convert.ToString(drReport["State"]).Trim() +
                                                                                    "<br style='mso-data-placement:same-cell;'>" + Convert.ToString(drReport["ZIP_Code"]).Trim();
                                        strHTML.Append("<tr valign='top' align='left'>");
                                        strHTML.Append("<td> " + Convert.ToString(drReport["DBA"]) + " </td>");
                                        strHTML.Append("<td> " + strAddress + " </td>");
                                        strHTML.Append("<td  align='right'> " + drReport["Region"] + " </td>");
                                        strHTML.Append("<td> " + Convert.ToString(drReport["Subtenant_DBA"]) + " </td>");
                                        strHTML.Append("<td align='right'> " + string.Format("{0:N0}", drReport["Leaseable_Area"]) + " </td>");

                                        // for Display Month in Report Detail
                                        for (int i = 1; i <= 12; i++)
                                            strHTML.Append("<td align='right'>" + string.Format("{0:C2}", drReport["Month_" + i.ToString()]) + " </td>");

                                        strHTML.Append("</tr>");

                                    }

                                    // print Grand Total for Whole Report
                                    strHTML.Append("<tr valign='top' align='left' style='font-weight: bold;'>");
                                    strHTML.Append("<td> Sub Total </td>");

                                    // filter Location Detail Record
                                    DataRow[] dr = dtLocationDtl.Select("PK_LU_Location_ID = " + drLocation["PK_LU_Location_Id"].ToString());

                                    if (dr.Length > 0)
                                    {
                                        strHTML.Append("<td> " + string.Format("{0:N0}", dr[0]["LeaseCount"]) + "</td><td><td>");
                                        strHTML.Append("<td align='right'> " + string.Format("{0:N0}", dr[0]["Leaseable_Area"]) + "</td>");

                                        // display Monthly rent for next 12 month included Current Month
                                        for (int i = 1; i <= 12; i++)
                                            strHTML.Append("<td align='right'> " + string.Format("{0:C2}", dr[0]["Month_" + i.ToString()]) + "</td>");

                                    }

                                    strHTML.Append("</tr>");
                                }
                                else
                                {
                                    //Add No record found line for year
                                    strHTML.Append("<tr><td align='left' colspan='17'>No Record Found!</td></tr>");
                                }
                                #endregion
                            }

                            // print Grand Total for Whole Report
                            strHTML.Append("<tr valign='top' align='left' style='font-weight: bold; background-color: #507CD1;color: White;'>");
                            strHTML.Append("<td> Grand Total </td>");

                            if (dsResult.Tables[3].Rows.Count > 0)
                            {
                                strHTML.Append("<td> " + string.Format("{0:N0}", dsResult.Tables[3].Rows[0]["LeaseCount"]) + "</td><td><td>");
                                strHTML.Append("<td> " + string.Format("{0:N0}", dsResult.Tables[3].Rows[0]["Leaseable_Area"]) + "</td>");

                                // display Monthly rent for next 12 month included Current Month
                                for (int i = 1; i <= 12; i++)
                                    strHTML.Append("<td> " + string.Format("{0:C2}", dsResult.Tables[3].Rows[0]["Month_" + i.ToString()]) + "</td>");
                            }

                            strHTML.Append("</tr>");

                        }
                        strHTML.Append("</table>");
                        #endregion

                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        SendMail("Monthly Expense By Location Report", "MonthlyExpenseByLocation.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
                    }

                    // Clean Up Memory
                    dtRecipients.Dispose();
                    dtLocation = null;
                    dtRecipients = null;
                    dtLocationDtl = null;
                    dtReportDetail = null;

                }
                dtFilter.Dispose();
                dtFilter = null;
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in Monthly Expense By Location Report, " + ex.Message + " - " + ex.StackTrace.ToString() + " - " + ex.Source.ToString());
            }
        }

        // Report 33
        private void BindLeasesWithSecurityDeposit(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(33, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list 
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = Convert.ToString(dtUser.Rows[0]["FIRST_NAME"]).Trim();
                        strLastName = Convert.ToString(dtUser.Rows[0]["LAST_NAME"]).Trim();
                        strMailFrom = Convert.ToString(dtUser.Rows[0]["Email"]).Trim();

                        //Set all filters to a variable as per report type
                        DateTime? dtLCDFrom = null, dtLCDTo = null, dtLEDFrom = null, dtLEDTo = null;

                        string strRegion = Convert.ToString(dtFilter.Rows[0]["Region"]).Trim();
                        string strMarket = null;
                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Market"])))
                        {
                            strMarket = Convert.ToString(dtFilter.Rows[0]["Market"]).Trim();
                        }
                        string strLeaseType = Convert.ToString(dtFilter.Rows[0]["LeaseType"]).Trim();


                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["LCDFrom_Date"])))
                            dtLCDFrom = Convert.ToDateTime(dtFilter.Rows[0]["LCDFrom_Date"]);

                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["LCDTo_Date"])))
                            dtLCDTo = Convert.ToDateTime(dtFilter.Rows[0]["LCDTo_Date"]);

                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["LEDFrom_Date"])))
                            dtLEDFrom = Convert.ToDateTime(dtFilter.Rows[0]["LEDFrom_Date"]);

                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["LEDTo_Date"])))
                            dtLEDTo = Convert.ToDateTime(dtFilter.Rows[0]["LEDTo_Date"]);



                        //Create HTML for the report and wirte into HTML Write object
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        #region "Search Criteria"

                        //Retrieve Market Values
                        string strMarketString = string.Empty;
                        if (string.IsNullOrEmpty(strMarket))
                        {
                            strMarketString = "All Market";
                        }
                        else
                        {
                            string[] strMar = strMarket.Split(Convert.ToChar(","));
                            for (int i = 0; i < strMar.Length; i++)
                            {
                                strMarketString += Report.SelectMarketInfoById(Convert.ToDecimal(strMar[i].ToString())).Tables[0].Rows[0]["Market"].ToString() + ",";
                            }
                            strMarketString = strMarketString.TrimEnd(',');
                        }

                        //Add Report Title and Schedule Date
                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : Leases With Security Deposits</b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"].ToString());
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        //Add Report Filter Criteria 
                        strHTML.Append("<br /><br />");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Region        : " + strRegion.Replace("'", ""));
                        strHTML.Append("<br />");
                        strHTML.Append("Market        : " + strMarketString);
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Lease Type    : " + Report.GetLeaseTypeList(strLeaseType));
                        strHTML.Append("<br />");
                        strHTML.Append("LCD From      : " + FormatDBNullDateToDisplay(dtLCDFrom));
                        strHTML.Append("<br />");
                        strHTML.Append("LCD To        : " + FormatDBNullDateToDisplay(dtLCDTo));
                        strHTML.Append("<br />");
                        strHTML.Append("LED From      : " + FormatDBNullDateToDisplay(dtLEDFrom));
                        strHTML.Append("<br />");
                        strHTML.Append("LED To        : " + FormatDBNullDateToDisplay(dtLEDTo));
                        strHTML.Append("<br /><br />");

                        #endregion

                        #region "Grid Data"

                        strHTML.Append("<table cellspacing='0' cellpadding='0' align='Left' border='0' style='width: 1160px; border-collapse: collapse;'>");
                        //Header Row
                        strHTML.Append("<tr align='left'><td align='left'>");
                        strHTML.Append("<table width='1160px' cellpadding='0' cellspacing='0' border='0'>");
                        strHTML.Append("<tr><td align='left'>");
                        strHTML.Append("<table width='1160px' cellpadding='0' cellspacing='0' border='1' style='font-weight: bold;'>");
                        strHTML.Append("<tr style='font-weight: bold;'>");
                        strHTML.Append("<td align='left' colspan='2'>Sonic Automotive</td>");
                        strHTML.Append("<td align='center' colspan='5'>Leases With Security Deposits</td>");
                        strHTML.Append("<td align='right' colspan='2'>" + DateTime.Now.ToString() + " </td>");
                        strHTML.Append("</tr>");

                        strHTML.Append(" <tr style='font-weight: bold;'>");
                        strHTML.Append("<td align='left' style='width: 135px'>Lease</td>");
                        strHTML.Append("<td align='left' style='width: 250px'>Location</td>");
                        strHTML.Append("<td align='right' style='width: 100px'>Lease Term</td>");
                        strHTML.Append("<td align='right' style='width: 150px'>Rentable Area</td>");
                        strHTML.Append("<td align='left' style='width: 125px'>Landlord</td>");
                        strHTML.Append("<td align='left' style='width: 100px'>Deposit</td>");
                        strHTML.Append("<td align='center' style='width: 75px'>Deposit Reduced?</td>");
                        strHTML.Append("<td align='center' style='width: 75px'>Deposit Returned?</td>");
                        strHTML.Append("<td align='right' style='width: 150px'>Security Deposit Amount</td>");
                        strHTML.Append(" </tr>");

                        strHTML.Append("</table>");
                        strHTML.Append("</td></tr>");
                        strHTML.Append("</table>");
                        strHTML.Append("</td></tr>");


                        //get the all Employee records by search criteria by group
                        DataSet dsDetails = Report.GetLeasesWithSecurityDeposits(strRegion, strMarket, strLeaseType, dtLCDFrom, dtLCDTo, dtLEDFrom, dtLEDTo);

                        if (dsDetails != null && dsDetails.Tables.Count > 0 && dsDetails.Tables[0].Rows.Count > 0)
                        {
                            DataTable dtLocation = dsDetails.Tables[0];
                            DataTable dtDetails = dsDetails.Tables[1];

                            strHTML.Append("<tr align='left'><td align='left'>");
                            strHTML.Append("<table width='1160px' cellpadding='0' cellspacing='0' border='0'>");
                            strHTML.Append("<tr><td align='left'>");
                            strHTML.Append("<table cellspacing='0' cellpadding='0' align='Left' border='1' style='width: 100%; border-collapse: collapse;'>");

                            foreach (DataRow dr in dtLocation.Rows)
                            {
                                DataRow[] drDetails = dtDetails.Select("DBA='" + dr["DBA"] + "'");
                                foreach (DataRow drDetail in drDetails)
                                {
                                    strHTML.Append(" <tr>");
                                    strHTML.Append("<td align='left' style='width: 135px'>" + Convert.ToString(drDetail["Lease_Codes"]) + "</td>");
                                    strHTML.Append("<td align='left' style='width: 250px'>" + Convert.ToString(drDetail["DBA"]) + "<br />" + Convert.ToString(drDetail["Address"]) + " </td>");
                                    strHTML.Append("<td align='right' style='width: 100px'>" + string.Format("{0:N0}", drDetail["Lease_Term"] != DBNull.Value ? Convert.ToDecimal(drDetail["Lease_Term"]) : 0) + "</td>");
                                    strHTML.Append("<td align='right' style='width: 150px'>" + string.Format("{0:N0}", drDetail["Rentable_Area"] != DBNull.Value ? Convert.ToDecimal(drDetail["Rentable_Area"]) : 0) + "</td>");
                                    strHTML.Append("<td align='left' style='width: 125px'>" + Convert.ToString(drDetail["Landlord"]) + "</td>");
                                    strHTML.Append("<td align='left' style='width: 100px'>" + Convert.ToString(drDetail["Tender_Type"]) + "</td>");
                                    strHTML.Append("<td align='center' style='width: 75px'>" + (Convert.ToString(drDetail["Security_Deposit_Reduced"]) == "Y" ? "Yes" : "No") + "</td>");
                                    strHTML.Append("<td align='center' style='width: 75px'>" + (Convert.ToString(drDetail["Security_Deposit_Returned"]) == "Y" ? "Yes" : "No") + "</td>");
                                    strHTML.Append("<td align='right' style='width: 150px'>" + string.Format("{0:C2}", drDetail["Amount"] != DBNull.Value ? Convert.ToDecimal(drDetail["Amount"]) : 0) + "</td>");
                                    strHTML.Append(" </tr>");
                                }
                                strHTML.Append(" <tr style='font-weight: bold;'>");
                                strHTML.Append("<td align='left' style='width: 135px'>Sub Total</td>");
                                strHTML.Append("<td align='left' style='width: 250px'>" + drDetails.Length.ToString() + " </td>");
                                strHTML.Append("<td align='right' style='width: 100px'>" + string.Format("{0:N0}", dtDetails.Compute("sum(Lease_Term)", "DBA='" + dr["DBA"] + "'")) + "</td>");
                                strHTML.Append("<td align='right' style='width: 150px'>" + string.Format("{0:N0}", dtDetails.Compute("sum(Rentable_Area)", "DBA='" + dr["DBA"] + "'")) + "</td>");
                                strHTML.Append("<td align='left' style='width: 125px'>&nbsp;</td>");
                                strHTML.Append("<td align='left' style='width: 100px'>&nbsp;</td>");
                                strHTML.Append("<td align='left' style='width: 75px'>&nbsp;</td>");
                                strHTML.Append("<td align='left' style='width: 75px'>&nbsp;</td>");
                                strHTML.Append("<td align='right' style='width: 150px'>" + string.Format("{0:c2}", dtDetails.Compute("sum(Amount)", "DBA='" + dr["DBA"] + "'")) + "</td>");
                                strHTML.Append(" </tr>");
                            }
                            strHTML.Append("</table>");
                            strHTML.Append("</td></tr>");
                            strHTML.Append("</table>");
                            strHTML.Append("</td></tr>");

                            //Footer Row
                            strHTML.Append("<tr align='left'><td align='left'>");
                            strHTML.Append(" <table width='1160px' cellpadding='0' cellspacing='0' border='0'>");
                            strHTML.Append("<tr><td align='left'>");
                            strHTML.Append("<table width='1160px' cellpadding='4' cellspacing='0' border='1' style='font-weight: bold;background-color: #507CD1; color: White;'>");
                            strHTML.Append(" <tr style='font-weight: bold;'>");
                            strHTML.Append("<td align='left' style='width: 135px'>Report Grand Totals</td>");
                            strHTML.Append("<td align='left' style='width: 250px'>" + Convert.ToString(dtDetails.Rows.Count) + " </td>");
                            strHTML.Append("<td align='right' style='width: 100px'>" + string.Format("{0:N0}", dtDetails.Compute("sum(Lease_Term)", "")) + "</td>");
                            strHTML.Append("<td align='right' style='width: 150px'>" + string.Format("{0:N0}", dtDetails.Compute("sum(Rentable_Area)", "")) + "</td>");
                            strHTML.Append("<td align='left' style='width: 125px'>&nbsp;</td>");
                            strHTML.Append("<td align='left' style='width: 100px'>&nbsp;</td>");
                            strHTML.Append("<td align='left' style='width: 75px'>&nbsp;</td>");
                            strHTML.Append("<td align='left' style='width: 75px'>&nbsp;</td>");
                            strHTML.Append("<td align='right' style='width: 150px'>" + string.Format("{0:c2}", dtDetails.Compute("sum(Amount)", "")) + "</td>");
                            strHTML.Append(" </tr>");
                            strHTML.Append("</table>");
                            strHTML.Append("</td></tr>");
                            strHTML.Append("</table>");
                            strHTML.Append("</td></tr>");
                        }
                        else
                        {
                            strHTML.Append("<tr> <td style='font-weight: bold;'> No Record Found.");
                            strHTML.Append("</td></tr>");
                        }


                        strHTML.Append("</table>");
                        #endregion

                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        SendMail("Leases With Security Deposits Report", "LeasesWithSecurityDeposits.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in Leases With Security Deposits Report, " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
        }

        //Report 34
        private void BindLandlordReport(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(34, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list 
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = Convert.ToString(dtUser.Rows[0]["FIRST_NAME"]).Trim();
                        strLastName = Convert.ToString(dtUser.Rows[0]["LAST_NAME"]).Trim();
                        strMailFrom = Convert.ToString(dtUser.Rows[0]["Email"]).Trim();

                        //Set all filters to a variable as per report type
                        DateTime? dtLCDFrom = null, dtLCDTo = null, dtLEDFrom = null, dtLEDTo = null;

                        string strRegion = Convert.ToString(dtFilter.Rows[0]["Region"]).Trim();
                        string strMarket = null;
                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Market"])))
                        {
                            strMarket = Convert.ToString(dtFilter.Rows[0]["Market"]).Trim();
                        }
                        string strLeaseType = Convert.ToString(dtFilter.Rows[0]["LeaseType"]).Trim();


                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["LCDFrom_Date"])))
                            dtLCDFrom = Convert.ToDateTime(dtFilter.Rows[0]["LCDFrom_Date"]);

                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["LCDTo_Date"])))
                            dtLCDTo = Convert.ToDateTime(dtFilter.Rows[0]["LCDTo_Date"]);

                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["LEDFrom_Date"])))
                            dtLEDFrom = Convert.ToDateTime(dtFilter.Rows[0]["LEDFrom_Date"]);

                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["LEDTo_Date"])))
                            dtLEDTo = Convert.ToDateTime(dtFilter.Rows[0]["LEDTo_Date"]);

                        //Create HTML for the report and wirte into HTML Write object
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        #region "Search Criteria"

                        //Retrieve Market Values
                        string strMarketString = string.Empty;
                        if (string.IsNullOrEmpty(strMarket))
                        {
                            strMarketString = "All Market";
                        }
                        else
                        {
                            string[] strMar = strMarket.Split(Convert.ToChar(","));
                            for (int i = 0; i < strMar.Length; i++)
                            {
                                strMarketString += Report.SelectMarketInfoById(Convert.ToDecimal(strMar[i].ToString())).Tables[0].Rows[0]["Market"].ToString() + ",";
                            }
                            strMarketString = strMarketString.TrimEnd(',');
                        }


                        //Add Report Title and Schedule Date
                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : Landlord Report</b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"].ToString());
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        //Add Report Filter Criteria 
                        strHTML.Append("<br /><br />");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Region        : " + strRegion.Replace("'", ""));
                        strHTML.Append("<br />");
                        strHTML.Append("Market        : " + strMarketString);
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Lease Type    : " + Report.GetLeaseTypeList(strLeaseType));
                        strHTML.Append("<br />");
                        strHTML.Append("LCD From      : " + FormatDBNullDateToDisplay(dtLCDFrom));
                        strHTML.Append("<br />");
                        strHTML.Append("LCD To        : " + FormatDBNullDateToDisplay(dtLCDTo));
                        strHTML.Append("<br />");
                        strHTML.Append("LED From      : " + FormatDBNullDateToDisplay(dtLEDFrom));
                        strHTML.Append("<br />");
                        strHTML.Append("LED To        : " + FormatDBNullDateToDisplay(dtLEDTo));
                        strHTML.Append("<br /><br />");

                        #endregion

                        #region "Grid Data"

                        strHTML.Append("<table cellspacing='0' cellpadding='0' align='Left' border='0' style='width: 1285px; border-collapse: collapse;'>");
                        //Header Row
                        strHTML.Append("<tr align='left'><td align='left'>");
                        strHTML.Append("<table width='1285px' cellpadding='0' cellspacing='0' border='0'>");
                        strHTML.Append("<tr><td align='left'>");
                        strHTML.Append("<table width='1285px' cellpadding='0' cellspacing='0' border='1' style='font-weight: bold;'>");
                        strHTML.Append("<tr style='font-weight: bold;'>");
                        strHTML.Append("<td align='left' colspan='2'>Sonic Automotive</td>");
                        strHTML.Append("<td align='center' colspan='4'>Landlord Report</td>");
                        strHTML.Append("<td align='right' colspan='2'>" + DateTime.Now.ToString() + " </td>");
                        strHTML.Append("</tr>");

                        strHTML.Append(" <tr style='font-weight: bold;'>");
                        strHTML.Append("<td align='left' style='width: 250px'>Location</td>");
                        strHTML.Append("<td align='left' style='width: 200px'>First In House Contact</td>");
                        strHTML.Append("<td align='left' style='width: 190px'>Primary Use</td>");
                        strHTML.Append("<td align='left' style='width: 125px'>Landlord</td>");
                        strHTML.Append("<td align='left' style='width: 200px'>Type</td>");
                        strHTML.Append("<td align='left' style='width: 100px'>Lease Codes</td>");
                        strHTML.Append("<td align='right' style='width: 120px'>Rentable Area</td>");
                        strHTML.Append("<td align='right' style='width: 100px'>Lease Term</td>");
                        strHTML.Append(" </tr>");
                        strHTML.Append("</table>");
                        strHTML.Append("</td></tr>");
                        strHTML.Append("</table>");
                        strHTML.Append("</td></tr>");


                        //get the all Employee records by search criteria by group
                        DataSet dsDetails = Report.GetLandlordReport(strRegion, strMarket, strLeaseType, dtLCDFrom, dtLCDTo, dtLEDFrom, dtLEDTo);

                        if (dsDetails != null && dsDetails.Tables.Count > 0 && dsDetails.Tables[0].Rows.Count > 0)
                        {
                            DataTable dtLocation = dsDetails.Tables[0];
                            DataTable dtDetails = dsDetails.Tables[1];

                            strHTML.Append("<tr align='left'><td align='left'>");
                            strHTML.Append("<table width='1285px' cellpadding='0' cellspacing='0' border='0'>");
                            strHTML.Append("<tr><td align='left'>");
                            strHTML.Append("<table cellspacing='0' cellpadding='0' align='Left' border='1' style='width: 100%; border-collapse: collapse;'>");

                            foreach (DataRow dr in dtLocation.Rows)
                            {
                                DataRow[] drDetails = dtDetails.Select("DBA='" + dr["DBA"] + "'");
                                foreach (DataRow drDetail in drDetails)
                                {
                                    strHTML.Append(" <tr>");
                                    strHTML.Append("<td align='left' style='width: 250px'>" + Convert.ToString(drDetail["DBA"]) + "<br />" + Convert.ToString(drDetail["Address"]) + " </td>");
                                    strHTML.Append("<td align='left' style='width: 200px'>" + Convert.ToString(drDetail["Tenant_Contact"]) + "</td>");
                                    strHTML.Append("<td align='left' style='width: 190px'>" + Convert.ToString(drDetail["Primary_Use"]) + "</td>");
                                    strHTML.Append("<td align='left' style='width: 125px'>" + Convert.ToString(drDetail["Landlord"]) + "</td>");
                                    strHTML.Append("<td align='left' style='width: 200px'>" + Convert.ToString(drDetail["Type"]) + "</td>");
                                    strHTML.Append("<td align='left' style='width: 100px'>" + Convert.ToString(drDetail["Lease_Codes"]) + "</td>");
                                    strHTML.Append("<td align='right' style='width: 120px'>" + string.Format("{0:N0}", drDetail["Rentable_Area"] != DBNull.Value ? Convert.ToDecimal(drDetail["Rentable_Area"]) : 0) + "</td>");
                                    strHTML.Append("<td align='right' style='width: 100px'>" + string.Format("{0:N0}", drDetail["Lease_Term"] != DBNull.Value ? Convert.ToDecimal(drDetail["Lease_Term"]) : 0) + "</td>");
                                    strHTML.Append(" </tr>");
                                }
                                strHTML.Append(" <tr style='font-weight: bold;'>");
                                strHTML.Append("<td align='left' style='width: 250px'>Sub Total</td>");
                                strHTML.Append("<td align='left' style='width: 200px'>" + drDetails.Length.ToString() + " </td>");
                                strHTML.Append("<td align='left' style='width: 190px'>&nbsp;</td>");
                                strHTML.Append("<td align='left' style='width: 125px'>&nbsp;</td>");
                                strHTML.Append("<td align='left' style='width: 200px'>&nbsp;</td>");
                                strHTML.Append("<td align='left' style='width: 100px'>&nbsp;</td>");
                                strHTML.Append("<td align='right' style='width: 120px'>" + string.Format("{0:N0}", dtDetails.Compute("sum(Rentable_Area)", "DBA='" + dr["DBA"] + "'")) + "</td>");
                                strHTML.Append("<td align='right' style='width: 100px'>" + string.Format("{0:N0}", dtDetails.Compute("sum(Lease_Term)", "DBA='" + dr["DBA"] + "'")) + "</td>");
                                strHTML.Append(" </tr>");
                            }
                            strHTML.Append("</table>");
                            strHTML.Append("</td></tr>");
                            strHTML.Append("</table>");
                            strHTML.Append("</td></tr>");

                            //Footer Row
                            strHTML.Append("<tr align='left'><td align='left'>");
                            strHTML.Append(" <table width='1285px' cellpadding='0' cellspacing='0' border='0'>");
                            strHTML.Append("<tr><td align='left'>");
                            strHTML.Append("<table width='1285px' cellpadding='4' cellspacing='0' border='1' style='font-weight: bold;background-color: #507CD1; color: White;'>");
                            strHTML.Append(" <tr style='font-weight: bold;'>");
                            strHTML.Append("<td align='left' style='width: 250px'>Report Grand Totals</td>");
                            strHTML.Append("<td align='left' style='width: 200px'>" + Convert.ToString(dtDetails.Rows.Count) + " </td>");
                            strHTML.Append("<td align='left' style='width: 190px'>&nbsp;</td>");
                            strHTML.Append("<td align='left' style='width: 125px'>&nbsp;</td>");
                            strHTML.Append("<td align='left' style='width: 200px'>&nbsp;</td>");
                            strHTML.Append("<td align='left' style='width: 100px'>&nbsp;</td>");
                            strHTML.Append("<td align='right' style='width: 120px'>" + string.Format("{0:N0}", dtDetails.Compute("sum(Rentable_Area)", "")) + "</td>");
                            strHTML.Append("<td align='right' style='width: 100px'>" + string.Format("{0:N0}", dtDetails.Compute("sum(Lease_Term)", "")) + "</td>");
                            strHTML.Append(" </tr>");
                            strHTML.Append("</table>");
                            strHTML.Append("</td></tr>");
                            strHTML.Append("</table>");
                            strHTML.Append("</td></tr>");
                        }
                        else
                        {
                            strHTML.Append("<tr> <td style='font-weight: bold;'> No Record Found.");
                            strHTML.Append("</td></tr>");
                        }


                        strHTML.Append("</table>");
                        #endregion

                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        SendMail("Landlord Report", "LandlordReport.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in Landlord Report, " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
        }

        // Report 35
        private void BindMaintenanceReport(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(34, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list 
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = Convert.ToString(dtUser.Rows[0]["FIRST_NAME"]).Trim();
                        strLastName = Convert.ToString(dtUser.Rows[0]["LAST_NAME"]).Trim();
                        strMailFrom = Convert.ToString(dtUser.Rows[0]["Email"]).Trim();

                        //Set all filters to a variable as per report type
                        DateTime? dtLCDFrom = null, dtLCDTo = null, dtLEDFrom = null, dtLEDTo = null;

                        string strRegion = Convert.ToString(dtFilter.Rows[0]["Region"]).Trim();
                        string strMarket = null;
                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Market"])))
                        {
                            strMarket = Convert.ToString(dtFilter.Rows[0]["Market"]).Trim();
                        }
                        string strLeaseType = Convert.ToString(dtFilter.Rows[0]["LeaseType"]).Trim();


                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["LCDFrom_Date"])))
                            dtLCDFrom = Convert.ToDateTime(dtFilter.Rows[0]["LCDFrom_Date"]);

                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["LCDTo_Date"])))
                            dtLCDTo = Convert.ToDateTime(dtFilter.Rows[0]["LCDTo_Date"]);

                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["LEDFrom_Date"])))
                            dtLEDFrom = Convert.ToDateTime(dtFilter.Rows[0]["LEDFrom_Date"]);

                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["LEDTo_Date"])))
                            dtLEDTo = Convert.ToDateTime(dtFilter.Rows[0]["LEDTo_Date"]);

                        //Create HTML for the report and wirte into HTML Write object
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        #region "Search Criteria"

                        //Retrieve Market Values
                        string strMarketString = string.Empty;
                        if (string.IsNullOrEmpty(strMarket))
                        {
                            strMarketString = "All Market";
                        }
                        else
                        {
                            string[] strMar = strMarket.Split(Convert.ToChar(","));
                            for (int i = 0; i < strMar.Length; i++)
                            {
                                strMarketString += Report.SelectMarketInfoById(Convert.ToDecimal(strMar[i].ToString())).Tables[0].Rows[0]["Market"].ToString() + ",";
                            }
                            strMarketString = strMarketString.TrimEnd(',');
                        }

                        //Add Report Title and Schedule Date
                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : Maintenance and Repair Items Report</b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"].ToString());
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        //Add Report Filter Criteria 
                        strHTML.Append("<br /><br />");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Region        : " + strRegion.Replace("'", ""));
                        strHTML.Append("<br />");
                        strHTML.Append("Market        : " + strMarketString);
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Lease Type    : " + Report.GetLeaseTypeList(strLeaseType));
                        strHTML.Append("<br />");
                        strHTML.Append("LCD From      : " + FormatDBNullDateToDisplay(dtLCDFrom));
                        strHTML.Append("<br />");
                        strHTML.Append("LCD To        : " + FormatDBNullDateToDisplay(dtLCDTo));
                        strHTML.Append("<br />");
                        strHTML.Append("LED From      : " + FormatDBNullDateToDisplay(dtLEDFrom));
                        strHTML.Append("<br />");
                        strHTML.Append("LED To        : " + FormatDBNullDateToDisplay(dtLEDTo));
                        strHTML.Append("<br /><br />");

                        #endregion

                        #region "Grid Data"

                        strHTML.Append("<table cellspacing='0' cellpadding='0' align='Left' border='0' style='width: 950px; border-collapse: collapse;'>");
                        //Header Row
                        strHTML.Append("<tr align='left'><td align='left'>");
                        strHTML.Append("<table width='100%' cellpadding='0' cellspacing='0' border='0'>");
                        strHTML.Append("<tr><td align='left'>");
                        strHTML.Append("<table width='100%' cellpadding='0' cellspacing='0' border='1' style='font-weight: bold;'>");
                        strHTML.Append("<tr style='font-weight: bold;'>");
                        strHTML.Append("<td align='left'>Sonic Automotive</td>");
                        strHTML.Append("<td align='center' colspan='3'>Maintenance and Repair Items</td>");
                        strHTML.Append("<td align='right'>" + DateTime.Now.ToString() + " </td>");
                        strHTML.Append("</tr>");

                        strHTML.Append(" <tr style='font-weight: bold;'>");
                        strHTML.Append("<td align='left' style='width: 20%'>Lease Codes</td>");
                        strHTML.Append("<td align='left' style='width: 20%'>Location</td>");
                        strHTML.Append("<td align='right' style='width: 20%'>Rentable Area</td>");
                        strHTML.Append("<td align='right' style='width: 20%'>Lease Term</td>");
                        strHTML.Append("<td align='right' style='width: 20%'>Total Repair Items</td>");
                        strHTML.Append(" </tr>");
                        strHTML.Append("</table>");
                        strHTML.Append("</td></tr>");
                        strHTML.Append("</table>");
                        strHTML.Append("</td></tr>");


                        //get the all Employee records by search criteria by group
                        DataSet dsDetails = Report.GetMaintenanceAndRepairItems(strRegion, strMarket, strLeaseType, dtLCDFrom, dtLCDTo, dtLEDFrom, dtLEDTo);

                        if (dsDetails != null && dsDetails.Tables.Count > 0 && dsDetails.Tables[0].Rows.Count > 0)
                        {
                            DataTable dtLocation = dsDetails.Tables[0];
                            DataTable dtDetails = dsDetails.Tables[1];

                            strHTML.Append("<tr align='left'><td align='left'>");
                            strHTML.Append("<table width='100%' cellpadding='0' cellspacing='0' border='0'>");
                            strHTML.Append("<tr><td align='left'>");
                            strHTML.Append("<table cellspacing='0' cellpadding='0' align='Left' border='1' style='width: 100%; border-collapse: collapse;'>");

                            foreach (DataRow dr in dtLocation.Rows)
                            {
                                DataRow[] drDetails = dtDetails.Select("DBA='" + dr["DBA"] + "'");
                                foreach (DataRow drDetail in drDetails)
                                {
                                    strHTML.Append(" <tr>");
                                    strHTML.Append("<td align='left' style='width: 20%'>" + Convert.ToString(drDetail["Lease_Codes"]) + "</td>");
                                    strHTML.Append("<td align='left' style='width: 20%'>" + Convert.ToString(drDetail["DBA"]) + "<br />" + Convert.ToString(drDetail["Address"]) + " </td>");
                                    strHTML.Append("<td align='right' style='width: 20%'>" + string.Format("{0:N0}", drDetail["Rentable_Area"] != DBNull.Value ? Convert.ToDecimal(drDetail["Rentable_Area"]) : 0) + "</td>");
                                    strHTML.Append("<td align='right' style='width: 20%'>" + string.Format("{0:N0}", drDetail["Lease_Term"] != DBNull.Value ? Convert.ToDecimal(drDetail["Lease_Term"]) : 0) + "</td>");
                                    strHTML.Append("<td align='right' style='width: 20%'>" + string.Format("{0:N0}", drDetail["Items_Per_Location"] != DBNull.Value ? Convert.ToDecimal(drDetail["Items_Per_Location"]) : 0) + "</td>");
                                    strHTML.Append(" </tr>");
                                }
                                strHTML.Append(" <tr style='font-weight: bold;'>");
                                strHTML.Append("<td align='left' style='width: 20%'>Sub Total</td>");
                                strHTML.Append("<td align='left' style='width: 20%'>" + drDetails.Length.ToString() + " </td>");
                                strHTML.Append("<td align='right' style='width: 20%'>" + string.Format("{0:N0}", dtDetails.Compute("sum(Rentable_Area)", "DBA='" + dr["DBA"] + "'")) + "</td>");
                                strHTML.Append("<td align='right' style='width: 20%'>" + string.Format("{0:N0}", dtDetails.Compute("sum(Lease_Term)", "DBA='" + dr["DBA"] + "'")) + "</td>");
                                strHTML.Append("<td align='right' style='width: 20%'>" + string.Format("{0:N0}", dtDetails.Compute("sum(Items_Per_Location)", "DBA='" + dr["DBA"] + "'")) + "</td>");
                                strHTML.Append(" </tr>");
                            }
                            strHTML.Append("</table>");
                            strHTML.Append("</td></tr>");
                            strHTML.Append("</table>");
                            strHTML.Append("</td></tr>");

                            //Footer Row
                            strHTML.Append("<tr align='left'><td align='left'>");
                            strHTML.Append(" <table width='100%' cellpadding='0' cellspacing='0' border='0'>");
                            strHTML.Append("<tr><td align='left'>");
                            strHTML.Append("<table width='100%' cellpadding='4' cellspacing='0' border='1' style='font-weight: bold;background-color: #507CD1; color: White;'>");
                            strHTML.Append(" <tr style='font-weight: bold;'>");
                            strHTML.Append("<td align='left' style='width: 20%'>Report Grand Totals</td>");
                            strHTML.Append("<td align='left' style='width: 20%'>" + Convert.ToString(dtDetails.Rows.Count) + " </td>");
                            strHTML.Append("<td align='right' style='width: 20%'>" + string.Format("{0:N0}", dtDetails.Compute("sum(Rentable_Area)", "")) + "</td>");
                            strHTML.Append("<td align='right' style='width: 20%'>" + string.Format("{0:N0}", dtDetails.Compute("sum(Lease_Term)", "")) + "</td>");
                            strHTML.Append("<td align='right' style='width: 20%'>" + string.Format("{0:N0}", dtDetails.Compute("sum(Items_Per_Location)", "")) + "</td>");
                            strHTML.Append(" </tr>");
                            strHTML.Append("</table>");
                            strHTML.Append("</td></tr>");
                            strHTML.Append("</table>");
                            strHTML.Append("</td></tr>");
                        }
                        else
                        {
                            strHTML.Append("<tr> <td style='font-weight: bold;'> No Record Found.");
                            strHTML.Append("</td></tr>");
                        }


                        strHTML.Append("</table>");
                        #endregion

                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        SendMail("Maintenance and Repair Items Report", "MaintenanceAndRepairItems.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in Maintenance and Repair Items Report, " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
        }

        // Report 36
        private void BindWCAllocationYTDCharge(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(36, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list 
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = Convert.ToString(dtUser.Rows[0]["FIRST_NAME"]).Trim();
                        strLastName = Convert.ToString(dtUser.Rows[0]["LAST_NAME"]).Trim();
                        strMailFrom = Convert.ToString(dtUser.Rows[0]["Email"]).Trim();

                        string strRegion = Convert.ToString(dtFilter.Rows[0]["Region"]).Trim();
                        string strMarket = Convert.ToString(dtFilter.Rows[0]["Market"]).Trim();

                        string strLocation = Convert.ToString(dtFilter.Rows[0]["Location"]).Trim();
                        string strYear = Convert.ToString(dtFilter.Rows[0]["Year"]).Trim();
                        string strRun_Report_By = Convert.ToString(dtFilter.Rows[0]["Run_report_by"]);

                        if (string.IsNullOrEmpty(strRun_Report_By))
                            strRun_Report_By = "Region";

                        DataSet dsResult = new DataSet();

                        //Get the all Unique records for Selected group (default - last name -sort) by search criteria
                        if (strRun_Report_By == "Region")
                            dsResult = Report.GetWCAllocationYTDChargeReport(strRegion, strMarket, strLocation, strYear);
                        else if (strRun_Report_By == "Market")
                            dsResult = Report.GetWCAllocationYTDChargeReport_ByMarket(strRegion, strMarket, strLocation, strYear);

                        //Create HTML for the report and wirte into HTML Write object
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        #region "Report Title"
                        //Retrieve Market Values


                        //Add Report Title and Schedule Date
                        //strHTML.Append("<table><tr><td colspan='15'>");
                        //strHTML.Append("<br />");
                        ////strHTML.Append("<td>");
                        //strHTML.Append("<b>Report Title : Workers Comp Allocation YTD Charge Report </b>");
                        //strHTML.Append("<br /><br />");
                        //strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        //strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        //strHTML.Append("<br />");
                        //strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"].ToString());
                        //strHTML.Append("<br />");
                        //strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        ////Add Report Filter Criteria 
                        //strHTML.Append("<br /><br /><br />");
                        //strHTML.Append("<b>Report Filters </b>");
                        //strHTML.Append("<br />");
                        //strHTML.Append("Region   : " + strRegion);
                        //strHTML.Append("<br />");
                        //strHTML.Append("Market   : " + (string.IsNullOrEmpty(strMarket) ? "" : GetCommaValueFromTable(Report.getMarketByIds(strMarket).Tables[0], "Market")));
                        //strHTML.Append("<br />");
                        //strHTML.Append("Location : " + (string.IsNullOrEmpty(strLocation) ? "" : GetCommaValueFromTable(Report.getLocationByIds(strLocation).Tables[0], "DBA")));
                        //strHTML.Append("<br />");
                        //strHTML.Append("Accident Year : " + strYear);
                        //strHTML.Append("<br /><br />");
                        //strHTML.Append("</td></tr></table>");


                        strHTML.Append("<table><tr>");
                        strHTML.Append("<td colspan='15'>");
                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : Workers Comp Allocation YTD Charge Report </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("</td></tr>");
                        strHTML.Append("<tr><td colspan='15'>");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("</td></tr>");
                        strHTML.Append("<tr><td colspan='15'>");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"].ToString());
                        strHTML.Append("<br />");
                        strHTML.Append("</td></tr>");
                        strHTML.Append("<tr><td colspan='15'>");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));
                        strHTML.Append("</td></tr>");
                        strHTML.Append("<tr><td colspan='15'>");
                        //Add Report Filter Criteria 
                        strHTML.Append("<br /><br /><br />");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br />");
                        strHTML.Append("</td></tr>");
                        strHTML.Append("<tr><td colspan='15'>");
                        strHTML.Append("Region   : " + strRegion);
                        strHTML.Append("<br />");
                        strHTML.Append("</td></tr>");
                        strHTML.Append("<tr><td colspan='15'>");
                        strHTML.Append("Market   : " + (string.IsNullOrEmpty(strMarket) ? "" : GetCommaValueFromTable(Report.getMarketByIds(strMarket).Tables[0], "Market")));
                        strHTML.Append("<br />");
                        strHTML.Append("</td></tr>");
                        strHTML.Append("<tr><td colspan='15' height='auto'>");
                        strHTML.Append("Location : " + (string.IsNullOrEmpty(strLocation) ? "" : GetCommaValueFromTable(Report.getLocationByIds(strLocation).Tables[0], "DBA")));
                        strHTML.Append("<br /><br /><br /><br />");
                        strHTML.Append("</td></tr>");
                        strHTML.Append("<tr><td colspan='15'>");
                        strHTML.Append("Accident Year : " + strYear);
                        strHTML.Append("<br /><br />");
                        strHTML.Append("</td></tr></table>");
                        #endregion

                        #region "Report Grid header"

                        strHTML.Append("<table border='1'>");
                        strHTML.Append("<tr style='font-weight: bold' valign='bottom' align='left'>");
                        strHTML.Append("<td align='left' colspan='3'>Sonic Automotive</td>");
                        strHTML.Append("<td align='center' colspan='4'>WC Allocation YTD Charge Report</td>");
                        strHTML.Append("<td align='right' colspan='8'> Accident Year :" + strYear + " </td>");
                        strHTML.Append("</tr>");
                        strHTML.Append("<tr valign='bottom' align='left' style='font-weight: bold'>");
                        strHTML.Append("<td > First Report Number </td>");
                        strHTML.Append("<td >Date of Incident</td>");
                        strHTML.Append("<td >Date Reported To SRS</td>");
                        strHTML.Append("<td >Location</td>");
                        strHTML.Append("<td >Region</td>");
                        strHTML.Append("<td >Market</td>");
                        strHTML.Append("<td >Department</td>");
                        strHTML.Append("<td >Employee</td>");
                        strHTML.Append("<td >Description of Incident</td>");
                        strHTML.Append("<td >Invst. Comp.</td>");
                        strHTML.Append("<td >Cause Code</td>");
                        strHTML.Append("<td >Rep. Only</td>");
                        strHTML.Append("<td align='Right'>Initial Charge</td>");
                        strHTML.Append("<td align='Right'>Total Credits</td>");
                        strHTML.Append("<td align='Right'>Total Penalties</td>");
                        strHTML.Append("<td align='Right'>Total Charge Amount</td>");
                        strHTML.Append("</tr>");

                        // set Location Table 
                        DataTable dtLocation = dsResult.Tables[1];

                        // Check if record is exist for location
                        if (dtLocation.Rows.Count > 0)
                        {
                            // loop for all location
                            foreach (DataRow drLocation in dtLocation.Rows)
                            {
                                // filter Reprot Result by Locaion ID
                                DataTable dtReportDetail = dsResult.Tables[0];
                                dtReportDetail.DefaultView.RowFilter = " PK_LU_Location_Id = " + drLocation["PK_LU_Location_Id"].ToString();
                                dtReportDetail.DefaultView.Sort = "Region";
                                dtReportDetail = dtReportDetail.DefaultView.ToTable();

                                // display location for filter
                                strHTML.Append("<tr valign='top'>");
                                strHTML.Append("<td colspan='16' align='left'><b> Location : " + Convert.ToString(drLocation["dba"]) + "</b></td>");
                                strHTML.Append("</tr>");

                                // print Report Detail
                                if (dtReportDetail.Rows.Count > 0)
                                {
                                    // display record for Location
                                    foreach (DataRow drReport in dtReportDetail.Rows)
                                    {
                                        strHTML.Append("<tr valign='top'>");
                                        strHTML.Append("<td> " + Convert.ToString(drReport["WC_Fr_Number"]) + " </td>");
                                        strHTML.Append("<td> " + (string.IsNullOrEmpty(Convert.ToString(drReport["Date_Of_Incident"]).Trim()) ? "" : FormatDBNullDateToDisplay(drReport["Date_Of_Incident"])) + " </td>");
                                        strHTML.Append("<td> " + (Convert.ToString(drReport["Date_Reported_to_SRS"]) != string.Empty ? FormatDateToDisplay(FormatDateToStore(drReport["Date_Reported_to_SRS"])) : "") + " </td>");
                                        strHTML.Append("<td> " + Convert.ToString(drReport["DBA"]) + " </td>");
                                        strHTML.Append("<td> " + Convert.ToString(drReport["Region"]) + " </td>");
                                        strHTML.Append("<td> " + Convert.ToString(drReport["Market"]) + " </td>");
                                        strHTML.Append("<td> " + Convert.ToString(drReport["Description"]) + " </td>");
                                        strHTML.Append("<td> " + Convert.ToString(drReport["Employee_Name"]) + " </td>");
                                        strHTML.Append("<td> " + Convert.ToString(drReport["Description_of_Incident"]) + " </td>");
                                        strHTML.Append("<td> " + Convert.ToString(drReport["Inv_Comp"]) + " </td>");
                                        strHTML.Append("<td> " + Convert.ToString(drReport["Sonic_Cause_Code"]) + " </td>");
                                        strHTML.Append("<td> " + Convert.ToString(drReport["Report_Only"]) + " </td>");
                                        strHTML.Append("<td align='right'> " + string.Format("{0:C2}", drReport["Initial_Charge"]) + " </td>");
                                        strHTML.Append("<td align='right'> " + string.Format("{0:C2}", drReport["Total_Credits"]) + " </td>");
                                        strHTML.Append("<td align='right'> " + string.Format("{0:C2}", drReport["Total_Penalties"]) + " </td>");
                                        strHTML.Append("<td align='right'> " + string.Format("{0:C2}", drReport["Total_Charge"]) + " </td>");
                                        strHTML.Append("</tr>");
                                    }

                                    // print Sub Total by Location
                                    strHTML.Append("<tr valign='top' style='font-weight: bold;'>");
                                    strHTML.Append("<td> Sub Total </td>");
                                    strHTML.Append("<td>" + dtReportDetail.Rows.Count.ToString() + "</td>");
                                    strHTML.Append("<td> &nbsp;</td>");
                                    strHTML.Append("<td> &nbsp;</td>");
                                    strHTML.Append("<td> &nbsp;</td>");
                                    strHTML.Append("<td> &nbsp;</td>");
                                    strHTML.Append("<td> &nbsp;</td>");
                                    strHTML.Append("<td> &nbsp;</td>");
                                    strHTML.Append("<td> &nbsp;</td>");
                                    strHTML.Append("<td> &nbsp;</td>");
                                    strHTML.Append("<td> &nbsp;</td>");
                                    strHTML.Append("<td> &nbsp;</td>");
                                    strHTML.Append("<td align='right'> " + string.Format("{0:C2}", dtReportDetail.Compute("SUM(Initial_Charge)", "")) + " </td>");
                                    strHTML.Append("<td align='right'> " + string.Format("{0:C2}", dtReportDetail.Compute("SUM(Total_Credits)", "")) + " </td>");
                                    strHTML.Append("<td align='right'> " + string.Format("{0:C2}", dtReportDetail.Compute("SUM(Total_Penalties)", "")) + " </td>");
                                    strHTML.Append("<td align='right'> " + string.Format("{0:C2}", dtReportDetail.Compute("SUM(Total_Charge)", "")) + " </td>");
                                    strHTML.Append("</tr>");
                                }
                                else
                                {
                                    //Add No record found line for year
                                    strHTML.Append("<tr><td align='left' colspan='15'>No Record Found!</td></tr>");
                                }

                            }

                            // print Grand Total for Whole Report
                            strHTML.Append("<tr valign='top' style='font-weight: bold; background-color: #507CD1;color: White;'>");
                            strHTML.Append("<td> Grand Total </td>");
                            strHTML.Append("<td>" + dsResult.Tables[0].Rows.Count.ToString() + "</td>");
                            strHTML.Append("<td> &nbsp;</td>");
                            strHTML.Append("<td> &nbsp;</td>");
                            strHTML.Append("<td> &nbsp;</td>");
                            strHTML.Append("<td> &nbsp;</td>");
                            strHTML.Append("<td> &nbsp;</td>");
                            strHTML.Append("<td> &nbsp;</td>");
                            strHTML.Append("<td> &nbsp;</td>");
                            strHTML.Append("<td> &nbsp;</td>");
                            strHTML.Append("<td> &nbsp;</td>");
                            strHTML.Append("<td> &nbsp;</td>");
                            strHTML.Append("<td align='right'> " + string.Format("{0:C2}", dsResult.Tables[0].Compute("SUM(Initial_Charge)", "")) + " </td>");
                            strHTML.Append("<td align='right'> " + string.Format("{0:C2}", dsResult.Tables[0].Compute("SUM(Total_Credits)", "")) + " </td>");
                            strHTML.Append("<td align='right'> " + string.Format("{0:C2}", dsResult.Tables[0].Compute("SUM(Total_Penalties)", "")) + " </td>");
                            strHTML.Append("<td align='right'> " + string.Format("{0:C2}", dsResult.Tables[0].Compute("SUM(Total_Charge)", "")) + " </td>");
                            strHTML.Append("</tr>");

                        }
                        else
                        {
                            //Add No record found line for year
                            strHTML.Append("<tr><td align='left' colspan='15'>No Record Found!</td></tr>");
                        }
                        strHTML.Append("</table>");

                        #endregion

                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        SendMail("Workers Comp Allocation YTD Charge Report", "WCAllocationYTDChargeReport.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in Workers Comp Allocation YTD Charge Report, " + ex.Message + " - " + ex.StackTrace.ToString() + " - " + ex.Source.ToString());
            }
        }

        // Report 37
        private void BindExposuresPropertyStatementofValue(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(37, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list 
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = Convert.ToString(dtUser.Rows[0]["FIRST_NAME"]).Trim();
                        strLastName = Convert.ToString(dtUser.Rows[0]["LAST_NAME"]).Trim();
                        strMailFrom = Convert.ToString(dtUser.Rows[0]["Email"]).Trim();

                        string strRegion = Convert.ToString(dtFilter.Rows[0]["Region"]).Trim();
                        string strMarket = null;
                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Market"])))
                        {
                            strMarket = Convert.ToString(dtFilter.Rows[0]["Market"]).Trim();
                        }
                        string strStatus = Convert.ToString(dtFilter.Rows[0]["Status"]).Trim();
                        string strOwnership = Convert.ToString(dtFilter.Rows[0]["Ownership"]).Trim();
                        DateTime? dtPropertyValuationDateFrom = null;
                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Property_Valuation_Date_FROM"])))
                            dtPropertyValuationDateFrom = Convert.ToDateTime(dtFilter.Rows[0]["Property_Valuation_Date_FROM"]);
                        DateTime? dtPropertyValuationDateTo = null;
                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Property_Valuation_Date_To"])))
                            dtPropertyValuationDateTo = Convert.ToDateTime(dtFilter.Rows[0]["Property_Valuation_Date_To"]);

                        //Get the all Unique records for Selected group (default - last name -sort) by search criteria
                        DataSet dsResult = Report.GetPropertyStatementofValues(strRegion, strMarket, strStatus, strOwnership, dtPropertyValuationDateFrom, dtPropertyValuationDateTo);

                        //Create HTML for the report and wirte into HTML Write object
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        #region "Report Title"

                        //Retrieve Market Values
                        string strMarketString = string.Empty;
                        if (string.IsNullOrEmpty(strMarket))
                        {
                            strMarketString = "All Market";
                        }
                        else
                        {
                            string[] strMar = strMarket.Split(Convert.ToChar(","));
                            for (int i = 0; i < strMar.Length; i++)
                            {
                                strMarketString += Report.SelectMarketInfoById(Convert.ToDecimal(strMar[i].ToString())).Tables[0].Rows[0]["Market"].ToString() + ",";
                            }
                            strMarketString = strMarketString.TrimEnd(',');
                        }

                        //Add Report Title and Schedule Date
                        strHTML.Append("<table><tr><td colspan='8'>");

                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : Property  Statement of Values Report </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"].ToString());
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));
                        strHTML.Append("</td></tr></table>");
                        //Add Report Filter Criteria 
                        strHTML.Append("<br /><br /><table> <tr> <td>");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br /><table> <tr> <td colspan='8'>");
                        strHTML.Append("Region   : " + strRegion);
                        strHTML.Append("</td> </tr>");
                        strHTML.Append("<br /><table> <tr> <td colspan='8'>");
                        strHTML.Append("Market        : " + strMarketString);
                        strHTML.Append("</td> </tr>");
                        strHTML.Append("<tr> <td colspan='8'>");
                        strHTML.Append("Location Status   : " + strStatus);
                        strHTML.Append("</td> </tr>");
                        strHTML.Append("<tr> <td colspan='8'>");
                        strHTML.Append("Ownership   : " + strOwnership);
                        strHTML.Append("</td> </tr>");
                        strHTML.Append("<tr> <td colspan='8'>");
                        strHTML.Append("Property valuation Date From   : " + Convert.ToString(dtPropertyValuationDateFrom));
                        strHTML.Append("</td> </tr>");
                        strHTML.Append("<tr> <td colspan='8'>");
                        strHTML.Append("Property valuation Date To   : " + Convert.ToString(dtPropertyValuationDateTo));
                        strHTML.Append("</td> </tr>");
                        strHTML.Append("<tr> <td colspan='8'>");
                        strHTML.Append("</td></tr></table> ");
                        strHTML.Append("<br /><br />");

                        #endregion

                        #region "Report Grid header"
                        //Top Header
                        strHTML.Append("<table border='1'>");
                        strHTML.Append("<tr style='font-weight: bold;' valign='bottom' >");
                        strHTML.Append("<td align='left' colspan='2'>Sonic Automotive</td>");
                        strHTML.Append("<td align='center' colspan='89'>Property Statement of Values Report</td>");
                        strHTML.Append("<td align='right' colspan='10'> " + DateTime.Now.ToString() + " </td>");
                        strHTML.Append("</tr>");

                        //Sub Header
                        strHTML.Append("<tr style='font-weight:bold;  color : White;' align='center'>");
                        strHTML.Append("<td align='left' colspan='20' style='background-color: #993300;'>LOCATION/ADDRESS INFORMATION</td>");
                        strHTML.Append("<td align='left' colspan='10' style='background-color: #000000;'>OCCUPANCY</td>");
                        strHTML.Append("<td align='left' colspan='7' style='background-color: #008000;'>FINANCIAL INFORMATION</td>");
                        strHTML.Append("<td align='left' colspan='12' style='background-color: #9999FF; color: #FFFFFF'>FIRE INSPECTION COMPANY</td>");
                        strHTML.Append("<td align='left' colspan='13' style='background-color: #000084;'>SECURITY GUARD SERVICES</td>");
                        strHTML.Append("<td align='left' colspan='13' style='background-color: #FF6500;'>INTRUSION ALARM SERVICES</td>");
                        strHTML.Append("<td align='left' colspan='2' style='background-color: #840084;'>FENCE</td>");
                        strHTML.Append("<td align='left' colspan='3' style='background-color: #31CFCF;'>GENERATOR</td>");
                        strHTML.Append("<td align='left' colspan='2' style='background-color: #ff0000;'>FIRE DEPARTMENT</td>");
                        strHTML.Append("<td align='left' colspan='4' style='background-color: #ffff00;'></td>");
                        strHTML.Append("<td align='left' colspan='6' style='background-color: #31309C;'>CONSTRUCTION OF FLOORS (Yes to all apply)</td>");
                        strHTML.Append("<td align='left' colspan='6' style='background-color: #ff0000;'>CONSTRUCTION OF EXTERIOR WALLS (Yes to all apply)</td>");
                        strHTML.Append("<td align='left' colspan='3' style='background-color: #008284;'>MISC INFORMAION</td>");
                        strHTML.Append("</tr>");

                        strHTML.Append("<tr valign='bottom' style='font-weight: bold'>");


                        //LOCATION/ADDRESS INFORMATION 
                        strHTML.Append("<td width='150'>Region</td>");
                        strHTML.Append("<td width='150'>Sonic Location Code</td>");
                        strHTML.Append("<td width='150'>Location Name</td>");
                        //strHTML.Append("<td width='150'>Legal Entity</td>");
                        strHTML.Append("<td width='150'>Parent Company Legal Entity</td>");
                        strHTML.Append("<td width='150'>Parent Company Legal Entity FEIN</td>");
                        strHTML.Append("<td width='150'>Legal Entity (Operations)</td>");
                        strHTML.Append("<td width='150'>Legal Entity (Operations) FEIN</td>");
                        strHTML.Append("<td width='150'>Legal Entity (Properties)</td>");
                        strHTML.Append("<td width='150'>Legal Entity (Properties) FEIN</td>");
                        strHTML.Append("<td width='150'>Federal Id</td>");
                        strHTML.Append("<td width='150'>Location Status</td>");
                        strHTML.Append("<td width='150'>Building #</td>");
                        strHTML.Append("<td width='150'>Building Status</td>");
                        strHTML.Append("<td width='200'>Address 1</td>");
                        strHTML.Append("<td width='200'>Address 2</td>");
                        strHTML.Append("<td width='150'>City</td>");
                        strHTML.Append("<td width='150'>State</td>");
                        strHTML.Append("<td width='150'>Zip Code</td>");
                        strHTML.Append("<td width='150'>County</td>");
                        strHTML.Append("<td width='150'>Owned/Leased/Sub Leased/Assigned/ Management Agreement</td>");

                        //OCCUPANCY
                        strHTML.Append("<td width='120'>Sales - New</td>");
                        strHTML.Append("<td width='120'>Sales - Used</td>");
                        strHTML.Append("<td width='120'>Services</td>");
                        strHTML.Append("<td width='120'>Body Shop</td>");
                        strHTML.Append("<td width='120'>Parts</td>");
                        strHTML.Append("<td width='120'>Office</td>");
                        strHTML.Append("<td width='120'>Parking Lot</td>");
                        strHTML.Append("<td width='120'>Row Land</td>");
                        strHTML.Append("<td width='120'>Car Wash</td>");
                        strHTML.Append("<td width='120'>Photo Booth</td>");

                        //FINANCIAL INFORMATION
                        strHTML.Append("<td width='150'>Property Valuation Date</td>");
                        strHTML.Append("<td width='150'>RS Means Building Limit</td>");
                        strHTML.Append("<td width='150'>Associate Tools Limit</td>");
                        strHTML.Append("<td width='150'>Contents Limit</td>");
                        strHTML.Append("<td width='150'>Parts Limit</td>");
                        strHTML.Append("<td width='150' align='right'>Business Interruption</td>");
                        strHTML.Append("<td width='150'>Total</td>");

                        // Fire Inspection Company
                        strHTML.Append("<td width='150'>Contact Name</td>");
                        strHTML.Append("<td width='150'>Vendor Name</td>");
                        strHTML.Append("<td width='150'>Contract Expiration Date</td>");
                        strHTML.Append("<td width='150'>Address 1</td>");
                        strHTML.Append("<td width='150'>Address 2</td>");
                        strHTML.Append("<td width='150'>City</td>");
                        strHTML.Append("<td width='150'>State</td>");
                        strHTML.Append("<td width='150'>Zip</td>");
                        strHTML.Append("<td width='150'>Email</td>");
                        strHTML.Append("<td width='150'>Telephone Number</td>");
                        strHTML.Append("<td width='150'>Alternate Number</td>");
                        strHTML.Append("<td width='150'>Comments</td>");

                        //Security Guard Services
                        strHTML.Append("<td width='150'>System</td>");
                        strHTML.Append("<td width='150'>Vendor Name</td>");
                        strHTML.Append("<td width='150'>Address 1</td>");
                        strHTML.Append("<td width='150'>Address 2</td>");
                        strHTML.Append("<td width='150'>City</td>");
                        strHTML.Append("<td width='150'>State</td>");
                        strHTML.Append("<td width='150'>Zip</td>");
                        strHTML.Append("<td width='150'>Contact Name</td>");
                        strHTML.Append("<td width='150'>Contract Expiration Date</td>");
                        strHTML.Append("<td width='150'>Telephone Number</td>");
                        strHTML.Append("<td width='150'>Alternet Number</td>");
                        strHTML.Append("<td width='150'>email</td>");
                        strHTML.Append("<td width='150'>Comments</td>");


                        //INTRUSION ALARM SERVICES
                        strHTML.Append("<td width='150'>System</td>");
                        strHTML.Append("<td width='150'>Vendor Name</td>");
                        strHTML.Append("<td width='150'>Address 1</td>");
                        strHTML.Append("<td width='150'>Address 2</td>");
                        strHTML.Append("<td width='150'>City</td>");
                        strHTML.Append("<td width='150'>State</td>");
                        strHTML.Append("<td width='150'>Zip</td>");
                        strHTML.Append("<td width='150'>Contact Name</td>");
                        strHTML.Append("<td width='150'>Contract Expiration Date</td>");
                        strHTML.Append("<td width='150'>Telephone Number</td>");
                        strHTML.Append("<td width='150'>Alternet Number</td>");
                        strHTML.Append("<td width='150'>email</td>");
                        strHTML.Append("<td width='150'>Comments</td>");

                        //FENCE
                        strHTML.Append("<td width='150'>Razor Wire<br />YES/No</td>");
                        strHTML.Append("<td width='150'>Electrified<br />YES/No</td>");


                        //GENERATOR
                        strHTML.Append("<td width='150'>Make</td>");
                        strHTML.Append("<td width='150'>Model</td>");
                        strHTML.Append("<td width='150'>Size</td>");

                        //Fire Department
                        strHTML.Append("<td width='150'>Type (Paid/Part Paid/Volunteer)</td>");
                        strHTML.Append("<td width='150'>Distance - Miles</td>");


                        //___________________________
                        strHTML.Append("<td width='150'>Year Built</td>");
                        strHTML.Append("<td width='150'>Squre Footage</td>");
                        strHTML.Append("<td width='150'>Number of Floors</td>");
                        strHTML.Append("<td width='150'>% Sprink</td>");


                        //CONSTRUCTION OF FLOORS
                        strHTML.Append("<td width='150'>Reinforced Concrete</td>");
                        strHTML.Append("<td width='150'>Poured Concrete</td>");
                        strHTML.Append("<td width='150'>Concrete Panels</td>");
                        strHTML.Append("<td width='150'>Steel Deck</td>");
                        strHTML.Append("<td width='150'>Steel Deck Fastener</td>");
                        strHTML.Append("<td width='150'>Wood Joists</td>");

                        // CONSTRUCTION OF EXTERIOR WALLS
                        strHTML.Append("<td width='150'>Reinforced Concrete</td>");
                        strHTML.Append("<td width='150'>Tilt Up Concrete</td>");
                        strHTML.Append("<td width='150'>Masonry</td>");
                        strHTML.Append("<td width='150'>Glass and Steel Curtain</td>");
                        strHTML.Append("<td width='150'>Corrugated Metal Panels</td>");
                        strHTML.Append("<td width='150'>Wood Frame</td>");


                        //MISC INFORMAION 
                        strHTML.Append("<td width='150'>Number of Lifts</td>");
                        strHTML.Append("<td width='150'>Number of Paint Booths</td>");
                        strHTML.Append("<td width='300'>Other Building Comments</td>");

                        strHTML.Append("</tr>");

                        //Check Whether Record Exists or Not
                        if (dsResult != null && dsResult.Tables.Count > 0 && dsResult.Tables[0].Rows.Count > 0)
                        {
                            foreach (DataRow dr in dsResult.Tables[0].Rows)
                            {
                                strHTML.Append("<tr valign='top'>");
                                //LOCATION/ADDRESS INFORMATION 
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Region"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Sonic_Location_Code"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Location_Name"]) + "</td>");
                                //strHTML.Append("<td width='150'>" + Convert.ToString(dr["Legal_Entity"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Parent_Company_LE"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Parent_Company_LE_FEIN"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["LE_Operations"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["LE_Operations_FEIN"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["LE_Properties"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["LE_Properties_FEIN"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Federal_id"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Location_Status"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Building"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Building_Status"]) + "</td>");
                                strHTML.Append("<td width='200'>" + Convert.ToString(dr["Address1"]) + "</td>");
                                strHTML.Append("<td width='200'>" + Convert.ToString(dr["Address2"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["City"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["State"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Zip_Code"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["County"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Ownership"]) + "</td>");


                                //OCCUPANCY
                                strHTML.Append("<td width='120'>" + Convert.ToString(dr["Sales_New"]) + "</td>");
                                strHTML.Append("<td width='120'>" + Convert.ToString(dr["Sales_Used"]) + "</td>");
                                strHTML.Append("<td width='120'>" + Convert.ToString(dr["Service"]) + "</td>");
                                strHTML.Append("<td width='120'>" + Convert.ToString(dr["Body_Shop"]) + "</td>");
                                strHTML.Append("<td width='120'>" + Convert.ToString(dr["Parts"]) + "</td>");
                                strHTML.Append("<td width='120'>" + Convert.ToString(dr["Office"]) + "</td>");
                                strHTML.Append("<td width='120'>" + Convert.ToString(dr["Parking_Lot"]) + "t</td>");
                                strHTML.Append("<td width='120'>" + Convert.ToString(dr["Raw_Land"]) + "</td>");
                                strHTML.Append("<td width='120'>" + Convert.ToString(dr["Car_Wash"]) + "</td>");
                                strHTML.Append("<td width='120'>" + Convert.ToString(dr["Photo_Booth"]) + "</td>");

                                //FINANCIAL INFORMATION
                                strHTML.Append("<td width='150'>" + FormatDBNullDateToDisplay(dr["Property_Valuation_Date"]) + "</td>");
                                strHTML.Append("<td width='150'>" + GetStringValue(dr["Building_Limit"]) + "t</td>");
                                strHTML.Append("<td width='150'>" + GetStringValue(dr["Associate_Tools_Limit"]) + "</td>");
                                strHTML.Append("<td width='150'>" + GetStringValue(dr["Contents_Limit"]) + "</td>");
                                strHTML.Append("<td width='150'>" + GetStringValue(dr["Parts_Limit"]) + "</td>");
                                strHTML.Append("<td width='150' align='right'>" + String.Format("{0:C2}", dr["Business_Interruption"]) + "</td>");
                                strHTML.Append("<td width='150'>" + GetStringValue(dr["Total"]) + "</td>");

                                // Fire Inspection Company
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Fire_Contact_Name"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Fire_Vendor_Name"]) + "</td>");
                                strHTML.Append("<td width='150'>" + FormatDBNullDateToDisplay(dr["Fire_Contact_Expiration_Date"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Fire_Address_1"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Fire_Address_2"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Fire_City"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Fire_State"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Fire_Zip"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Fire_Email"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Fire_Telephone_Number"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Fire_Alternate_Number"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Fire_Comments"]) + "</td>");

                                //Security Guard Services
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["System"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Vendor_Name"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Guard_Address_1"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Guard_Address_2"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Guard_City"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Guard_State"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Guard_Zip"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Contact_Name"]) + "</td>");
                                strHTML.Append("<td width='150'>" + FormatDBNullDateToDisplay(dr["Guard_Expiration_Date"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Guard_Telephone_Number"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Guard_Alternate_Number"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Guard_Email"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Guard_Comments"]) + "</td>");


                                //INTRUSION ALARM SERVICES
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Intru_System_Name"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Intru_Vendor_Name"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Intru_Address_1"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Intru_Address_2"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Intru_City"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Intru_State"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Intru_Zip"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Intru_Contact_Name"]) + "</td>");
                                strHTML.Append("<td width='150'>" + FormatDBNullDateToDisplay(dr["Intru_Contract_Expiration_Date"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Intru_Telephone_Number"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Intru_Alternate_Number"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Intru_Email"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Intru_Comments"]) + "</td>");

                                //FENCE
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Fence_Razor_Wire"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Fence_Electrified"]) + "</td>");


                                //GENERATOR
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Generator_Make"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Generator_Model"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Generator_Size"]) + "</td>");

                                //Fire Department
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Fire_Department_Type"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Fire_Department_Distance"]) + "</td>");


                                //___________________________
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Year_Built"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Square_Footage"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Number_Of_Stories"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Percent_Sprinklered"]) + "</td>");

                                //CONSTRUCTION OF FLOORS
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Roof_Reinforced_Concrete"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Roof_Poured_Concrete"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Roof_Concrete_Panels"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Roof_Steel_Deck"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Roof_Steel_Deck_With_Fasteners"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Roof_Wood_Joists"]) + "</td>");

                                // CONSTRUCTION OF EXTERIOR WALLS
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Ext_Walls_Reinforced_Concrete"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Ext_Walls_Tilt_Up_Concrete"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Ext_Walls_Masonary"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Ext_Walls_Glass_And_Steel_Curtain"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Ext_Walls_Corrugated_Metal_Panels"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Ext_Walls_Wood_Frame"]) + "</td>");


                                //MISC INFORMAION 
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Number_Of_Lifts"]) + "</td>");
                                strHTML.Append("<td width='150'>" + Convert.ToString(dr["Number_Of_Paint_Booths"]) + "</td>");
                                strHTML.Append("<td width='300'>" + Convert.ToString(dr["Comments"]) + "</td>");

                                strHTML.Append("</tr>");
                            }
                        }
                        else
                        {
                            //Add No record found line for year
                            strHTML.Append("<tr><td align='left' colspan='81'>No Record Found!</td></tr>");
                        }
                        strHTML.Append("</table>");

                        #endregion

                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        SendMail("Property  Statement of Values Report", "ExposuresPropertyStatementofValuesReport.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in Property  Statement of Values Report, " + ex.Message + " - " + ex.StackTrace.ToString() + " - " + ex.Source.ToString());
            }
        }

        //Report 38
        private void BindLeaseReport(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(38, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list 
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = Convert.ToString(dtUser.Rows[0]["FIRST_NAME"]).Trim();
                        strLastName = Convert.ToString(dtUser.Rows[0]["LAST_NAME"]).Trim();
                        strMailFrom = Convert.ToString(dtUser.Rows[0]["Email"]).Trim();

                        //Set all filters to a variable as per report type
                        DateTime? dtLCDFrom = null, dtLCDTo = null, dtLEDFrom = null, dtLEDTo = null;

                        string strRegion = Convert.ToString(dtFilter.Rows[0]["Region"]).Trim();
                        string strMarket = null;
                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Market"])))
                        {
                            strMarket = Convert.ToString(dtFilter.Rows[0]["Market"]).Trim();
                        }
                        string strLeaseType = Convert.ToString(dtFilter.Rows[0]["LeaseType"]).Trim();
                        string strStatus = Convert.ToString(dtFilter.Rows[0]["Status"]).Trim();

                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["LCDFrom_Date"])))
                            dtLCDFrom = Convert.ToDateTime(dtFilter.Rows[0]["LCDFrom_Date"]);

                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["LCDTo_Date"])))
                            dtLCDTo = Convert.ToDateTime(dtFilter.Rows[0]["LCDTo_Date"]);

                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["LEDFrom_Date"])))
                            dtLEDFrom = Convert.ToDateTime(dtFilter.Rows[0]["LEDFrom_Date"]);

                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["LEDTo_Date"])))
                            dtLEDTo = Convert.ToDateTime(dtFilter.Rows[0]["LEDTo_Date"]);

                        //Create HTML for the report and wirte into HTML Write object
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        #region "Search Criteria"

                        //Retrieve Market Values
                        string strMarketString = string.Empty;
                        if (string.IsNullOrEmpty(strMarket))
                        {
                            strMarketString = "All Market";
                        }
                        else
                        {
                            string[] strMar = strMarket.Split(Convert.ToChar(","));
                            for (int i = 0; i < strMar.Length; i++)
                            {
                                strMarketString += Report.SelectMarketInfoById(Convert.ToDecimal(strMar[i].ToString())).Tables[0].Rows[0]["Market"].ToString() + ",";
                            }
                            strMarketString = strMarketString.TrimEnd(',');
                        }

                        //Add Report Title and Schedule Date
                        strHTML.Append("<table><tr><td colspan='13'>");
                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : Lease Report</b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"].ToString());
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        //Add Report Filter Criteria 
                        strHTML.Append("<br /><br />");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Region        : " + strRegion.Replace("'", ""));
                        strHTML.Append("<br />");
                        strHTML.Append("Market        : " + strMarketString);
                        strHTML.Append("<br /><br />");
                        strHTML.Append("LCD From      : " + FormatDBNullDateToDisplay(dtLCDFrom));
                        strHTML.Append("<br />");
                        strHTML.Append("LCD To        : " + FormatDBNullDateToDisplay(dtLCDTo));
                        strHTML.Append("<br />");
                        strHTML.Append("LED From      : " + FormatDBNullDateToDisplay(dtLEDFrom));
                        strHTML.Append("<br />");
                        strHTML.Append("LED To        : " + FormatDBNullDateToDisplay(dtLEDTo));
                        strHTML.Append("<br />");
                        strHTML.Append("Building Status        : " + strStatus.Replace("'", ""));
                        strHTML.Append("<br /><br />");
                        strHTML.Append("</td></tr></table>");

                        #endregion

                        #region "Grid Data"



                        strHTML.Append("<table width='2035px' cellpadding='0' cellspacing='0' border='1'>");


                        strHTML.Append("<tr style='font-weight: bold;'>");
                        strHTML.Append("<td><table><tr>");
                        strHTML.Append("<td align='left' style='width: 180px;font-weight:bold;'>Sonic Automotive</td>");
                        strHTML.Append("<td><table border='1'><tr style='font-weight: bold;'>");
                        //strHTML.Append("<td align='left' style='width: 180px;'>Location</td>");
                        strHTML.Append("<td align='left' style='width: 560px'>");
                        strHTML.Append("<table width='100%' cellpadding='0' cellspacing='0' border='none' style='font-weight: bold;'>");
                        strHTML.Append("<tr style='font-weight: bold;'>");
                        strHTML.Append("<td align='left' style='width: 40%'></td>");
                        strHTML.Append("<td align='left' style='width: 30%'>Lease Report</td>");
                        strHTML.Append("<td align='left' style='width: 30%'></td>");
                        strHTML.Append("</tr>");
                        strHTML.Append("</table>");
                        strHTML.Append("</td>");
                        strHTML.Append("<td align='right' colspan='9' style='font-weight: bold;border:thin;'>" + FormatDBNullDateToDisplay(DateTime.Now) + " </td>");
                        strHTML.Append("</tr></table></td>");
                        strHTML.Append("</tr>");

                        strHTML.Append("<tr style='font-weight: bold;'>");
                        strHTML.Append("<td><table><tr>");
                        strHTML.Append("<td align='left' style='width: 180px;font-weight:bold;'>Location</td>");
                        strHTML.Append("<td><table border='1'><tr style='font-weight: bold;'>");
                        //strHTML.Append("<td align='left' style='width: 180px;'>Location</td>");
                        strHTML.Append("<td align='left' style='width: 560px'>");
                        strHTML.Append("<table width='100%' cellpadding='0' cellspacing='0' border='1' style='font-weight: bold;'>");
                        strHTML.Append("<tr style='font-weight: bold;'>");
                        strHTML.Append("<td align='left' style='width: 40%'>Building Address</td>");
                        strHTML.Append("<td align='left' style='width: 30%'>Building Number</td>");
                        strHTML.Append("<td align='left' style='width: 30%'>Building Landlord Name</td>");
                        strHTML.Append("</tr>");
                        strHTML.Append("</table>");
                        strHTML.Append("</td>");
                        strHTML.Append("<td align='left' style='width: 100px;font-weight:bold;'>LCD</td>");
                        strHTML.Append("<td align='left' style='width: 100px;font-weight:bold;'>LED</td>");
                        strHTML.Append("<td align='left' style='width: 100px;font-weight:bold;'>LL Notify Date</td>");
                        strHTML.Append("<td align='left' style='width: 100px;font-weight:bold;'>Reminder Date</td>");
                        strHTML.Append("<td align='left' style='width: 100px;font-weight:bold;'>Review Date</td>");
                        strHTML.Append("<td align='right' style='width: 100px;font-weight:bold;'>Monthly Rent</td>");
                        strHTML.Append("<td align='left' style='width: 180px;font-weight:bold;'>Renewals</td>");
                        strHTML.Append("<td align='left' style='width: 180px;font-weight:bold;'>Rent Details</td>");
                        strHTML.Append("<td align='left' style='width: 180px;font-weight:bold;border:thin'>Rent Adjustments</td>");
                        strHTML.Append("</tr></table></td>");

                        strHTML.Append("</tr>");

                        //strHTML.Append("</table>");
                        //strHTML.Append("</td></tr>");
                        //strHTML.Append("</table>");
                        //strHTML.Append("</td></tr>");


                        //get the all Employee records by search criteria by group
                        DataSet dsDetails = Report.GetCriticalDatesReport(strRegion, strMarket, dtLCDFrom, dtLCDTo, dtLEDFrom, dtLEDTo, strStatus, "");

                        if (dsDetails != null && dsDetails.Tables.Count > 0 && dsDetails.Tables[0].Rows.Count > 0)
                        {
                            DataTable dtLocation = dsDetails.Tables[0];
                            DataTable dtDetails = dsDetails.Tables[0];

                            //strHTML.Append("<tr align='left'><td align='left'>");
                            //strHTML.Append("<table width='1675px' cellpadding='0' cellspacing='0' border='0'>");
                            //strHTML.Append("<tr><td align='left'>");
                            //strHTML.Append("<table cellspacing='0' cellpadding='0' align='Left' border='1' style='width: 100%; border-collapse: collapse;'>");

                            //foreach (DataRow dr in dtLocation.Rows)
                            //{

                            //DataRow[] drDetails = dtDetails.Select("DBA='" + dr["DBA"] + "'");
                            foreach (DataRow drDetail in dtDetails.Rows)
                            {

                                strHTML.Append("<tr>");
                                strHTML.Append("<td><table border='1'><tr>");
                                strHTML.Append("<td align='left' valign='top' style='width: 180px'>" + Convert.ToString(drDetail["DBA"]) + "</td>");
                                strHTML.Append("<td align='left' valign='top' style='width: 560px'>");
                                decimal _PK_RE_Information = Convert.ToDecimal(drDetail["PK_RE_Information"]);
                                DataTable dtBuilding = Report.SelectByFK_RE_Information(_PK_RE_Information).Tables[0];
                                if (dtBuilding.Rows.Count > 0)
                                {
                                    strHTML.Append("<table cellspacing='0' cellpadding='0' align='Left' border='1' style='width: 100%; border-collapse: collapse;'>");
                                    foreach (DataRow drBuilding in dtBuilding.Rows)
                                    {
                                        strHTML.Append("<tr>");
                                        strHTML.Append("<td align='left' valign='top' style='width:40%'>" + (drBuilding["Address"]) + "</td>");
                                        strHTML.Append("<td align='left' valign='top' style='width:30%'>" + Convert.ToString(drBuilding["Building_Number"]) + "</td>");
                                        strHTML.Append("<td align='left' valign='top' style='width:30%'>" + Convert.ToString(drBuilding["Landlord_Name"]) + "</td>");
                                        strHTML.Append("</tr>");
                                    }
                                    strHTML.Append("</table>");
                                }
                                else
                                {
                                    strHTML.Append("<table cellspacing='0' cellpadding='0' align='Left' border='1' style='width: 100%; border-collapse: collapse;'>");
                                    strHTML.Append("<tr>");
                                    strHTML.Append("<td align='left' valign='top' style='width:40%'>" + "" + "</td>");
                                    strHTML.Append("<td align='left' valign='top' style='width:30%'>" + "" + "</td>");
                                    strHTML.Append("<td align='left' valign='top' style='width:30%'>" + "" + "</td>");
                                    strHTML.Append("</tr>");
                                    strHTML.Append("</table>");
                                }
                                strHTML.Append("</td>");
                                strHTML.Append("<td align='left' valign='top' style='width: 100px'>" + FormatDBNullDateToDisplay(drDetail["LCD"]) + "</td>");
                                strHTML.Append("<td align='left' valign='top' style='width: 100px'>" + FormatDBNullDateToDisplay(drDetail["LED"]) + "</td>");
                                strHTML.Append("<td align='left' valign='top' style='width: 100px'>" + FormatDBNullDateToDisplay(drDetail["LLNotifyDate"]) + "</td>");
                                strHTML.Append("<td align='left' valign='top' style='width: 100px'>" + FormatDBNullDateToDisplay(drDetail["ReminderDate"]) + "</td>");
                                strHTML.Append("<td align='left' valign='top' style='width: 100px'>" + FormatDBNullDateToDisplay(drDetail["ReviewDate"]) + "</td>");
                                strHTML.Append("<td align='right' valign='top' style='width: 100px'>" + string.Format("{0:N2}", drDetail["MonthlyRent"] != DBNull.Value ? Convert.ToDecimal(drDetail["MonthlyRent"]) : 0) + "</td>");
                                strHTML.Append("<td align='left' valign='top' style='width: 180px'>" + Convert.ToString(drDetail["Renewals"]) + "</td>");
                                strHTML.Append("<td align='left' valign='top' style='width: 180px'>" + Convert.ToString(drDetail["Rent_Details"]) + "</td>");
                                strHTML.Append("<td align='left' valign='top' style='width: 180px'>" + Convert.ToString(drDetail["Rent_Adjustments"]) + "</td>");
                                strHTML.Append("</tr></table></td>");
                                strHTML.Append(" </tr>");
                            }
                            //}
                            //strHTML.Append("</table>");
                            //strHTML.Append("</td></tr>");
                            //strHTML.Append("</table>");
                            //strHTML.Append("</td></tr>");

                            //Footer Row
                            //strHTML.Append("<tr align='left'><td align='left'>");
                            //strHTML.Append("<table width='1675px' cellpadding='0' cellspacing='0' border='0'>");
                            strHTML.Append("<tr><td align='left'>");
                            strHTML.Append("<table border='1'><tr><td>");
                            strHTML.Append("<table width='1675px' cellpadding='4' cellspacing='0' border='1' style='font-weight: bold;background-color: #507CD1; color: White;'>");
                            strHTML.Append("<tr style='font-weight: bold;background-color: #507CD1; color: White;'>");
                            strHTML.Append("<td align='left' style='width: 180px'>Report Grand Totals</td>");
                            strHTML.Append("<td align='left' style='width: 560px'>" + Convert.ToString(dtDetails.Rows.Count) + " </td>");
                            strHTML.Append("<td align='left' style='width: 100px'>&nbsp;</td>");
                            strHTML.Append("<td align='left' style='width: 100px'>&nbsp;</td>");
                            strHTML.Append("<td align='left' style='width: 100px'>&nbsp;</td>");
                            strHTML.Append("<td align='left' style='width: 100px'>&nbsp;</td>");
                            strHTML.Append("<td align='left' style='width: 100px'>&nbsp;</td>");
                            strHTML.Append("<td align='left' style='width: 100px'>&nbsp;</td>");
                            strHTML.Append("<td align='left' style='width: 100px'>&nbsp;</td>");
                            strHTML.Append("<td align='right' style='width: 100px'>" + string.Format("{0:N2}", dtDetails.Compute("sum(MonthlyRent)", "")) + "</td>");
                            strHTML.Append("<td align='left' style='width: 180px'>&nbsp;</td>");
                            strHTML.Append("<td align='left' style='width: 180px'>&nbsp;</td>");
                            strHTML.Append("<td align='left' style='width: 180px'>&nbsp;</td>");
                            strHTML.Append("</tr>");
                            strHTML.Append("</table>");
                            strHTML.Append("</td></tr></table>");
                            strHTML.Append("</td></tr>");
                            strHTML.Append("</table>");
                            strHTML.Append("</td></tr>");
                        }
                        else
                        {
                            strHTML.Append("<tr> <td style='font-weight: bold;'> No Record Found.");
                            strHTML.Append("</td></tr>");
                        }

                        strHTML.Append("</table>");
                        #endregion

                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        SendMail("Lease Report", "LeaseReport.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in Lease Report, " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
        }

        // Report 39
        private void BindMasterDealership(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(39, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list 
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = Convert.ToString(dtUser.Rows[0]["FIRST_NAME"]).Trim();
                        strLastName = Convert.ToString(dtUser.Rows[0]["LAST_NAME"]).Trim();
                        strMailFrom = Convert.ToString(dtUser.Rows[0]["Email"]).Trim();

                        //Set all filters to a variable as per report type
                        DateTime? dtLCDFrom = null, dtLCDTo = null, dtLEDFrom = null, dtLEDTo = null;

                        string strRegion = Convert.ToString(dtFilter.Rows[0]["Region"]).Trim();
                        string strMarket = null;
                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Market"])))
                        {
                            strMarket = Convert.ToString(dtFilter.Rows[0]["Market"]).Trim();
                        }
                        string strLeaseType = Convert.ToString(dtFilter.Rows[0]["LeaseType"]).Trim();

                        if (dtFilter.Rows[0]["LCDFrom_Date"] != DBNull.Value)
                            dtLCDFrom = Convert.ToDateTime(dtFilter.Rows[0]["LCDFrom_Date"]);

                        if (Convert.ToString(dtFilter.Rows[0]["LCDTo_Date"]) != string.Empty && dtFilter.Rows[0]["LCDTo_Date"] != DBNull.Value)
                            dtLCDTo = Convert.ToDateTime(dtFilter.Rows[0]["LCDTo_Date"]);

                        if (Convert.ToString(dtFilter.Rows[0]["LEDFrom_Date"]) != string.Empty && dtFilter.Rows[0]["LEDFrom_Date"] != DBNull.Value)
                            dtLEDFrom = Convert.ToDateTime(dtFilter.Rows[0]["LEDFrom_Date"]);

                        if (Convert.ToString(dtFilter.Rows[0]["LEDTo_Date"]) != string.Empty && dtFilter.Rows[0]["LEDTo_Date"] != DBNull.Value)
                            dtLEDTo = Convert.ToDateTime(dtFilter.Rows[0]["LEDTo_Date"]);

                        //Get the all Unique records for Selected group (default - last name -sort) by search criteria
                        DataSet dsResult = Report.GetMasterDealership(strRegion, strMarket, dtLCDFrom, dtLCDTo, dtLEDFrom, dtLEDTo);

                        //Create HTML for the report and wirte into HTML Write object
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        #region "Report Criteria"

                        //Retrieve Market Values
                        string strMarketString = string.Empty;
                        if (string.IsNullOrEmpty(strMarket))
                        {
                            strMarketString = "All Market";
                        }
                        else
                        {
                            string[] strMar = strMarket.Split(Convert.ToChar(","));
                            for (int i = 0; i < strMar.Length; i++)
                            {
                                strMarketString += Report.SelectMarketInfoById(Convert.ToDecimal(strMar[i].ToString())).Tables[0].Rows[0]["Market"].ToString() + ",";
                            }
                            strMarketString = strMarketString.TrimEnd(',');
                        }

                        //Add Report Title and Schedule Date
                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : Master Dealership </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"].ToString());
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        //Add Report Filter Criteria 
                        strHTML.Append("<br /><br />");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Region : " + strRegion.Replace("'", ""));
                        strHTML.Append("<br />");
                        strHTML.Append("Market : " + strMarketString);
                        strHTML.Append("<br />");
                        strHTML.Append("LCD From : " + FormatDBNullDateToDisplay(dtLCDFrom));
                        strHTML.Append("<br />");
                        strHTML.Append("LCD To : " + FormatDBNullDateToDisplay(dtLCDTo));
                        strHTML.Append("<br />");
                        strHTML.Append("LED From : " + FormatDBNullDateToDisplay(dtLEDFrom));
                        strHTML.Append("<br />");
                        strHTML.Append("LED To : " + FormatDBNullDateToDisplay(dtLEDTo));
                        strHTML.Append("<br /><br />");

                        #endregion

                        #region "Report Grid header"

                        strHTML.Append("<table border='1'>");
                        strHTML.Append("<tr style='font-weight: bold' valign='bottom' align='left'>");
                        strHTML.Append("<td><table border='1'><tr style='font-weight: bold'>");
                        strHTML.Append("<td align='left' colspan='2'>Sonic Automotive</td>");
                        strHTML.Append("<td align='center' colspan='5'>Master Dealership </td>");
                        strHTML.Append("<td align='right' colspan='5'>" + FormatDBNullDateToDisplay(DateTime.Now) + "&nbsp;</td>");
                        strHTML.Append("</tr></table></td>");
                        strHTML.Append("</tr>");
                        strHTML.Append("<tr valign='bottom' align='left' style='font-weight: bold'>");
                        strHTML.Append("<td><table border='1'><tr style='font-weight: bold'>");
                        strHTML.Append("<td>Location  </td>");
                        strHTML.Append("<td align='left' style='width: 360px'>");
                        strHTML.Append("<table width='100%' cellpadding='0' cellspacing='0' border='1' style='font-weight: bold;'>");
                        strHTML.Append("<tr style='font-weight: bold'>");
                        strHTML.Append("<td align='left' style='width: 30%'>Building Number</td>");
                        strHTML.Append("<td align='left' style='width: 70%'>Building Address</td>");
                        strHTML.Append("</tr>");
                        strHTML.Append("</table>");
                        strHTML.Append("</td>");
                        strHTML.Append("<td>City </td>");
                        strHTML.Append("<td>State </td>");
                        strHTML.Append("<td>Zip  </td>");
                        strHTML.Append("<td>LCD </td>");
                        strHTML.Append("<td>LED </td>");
                        strHTML.Append("<td>Renewals </td>");
                        strHTML.Append("<td>Building Landlord Name </td>");
                        strHTML.Append("<td  align='center'>Monthly Rent </td>");
                        strHTML.Append("<td>Subtenant </td>");
                        strHTML.Append("<td align='center'>Subtenant Monthly Rent </td>");
                        strHTML.Append("</tr></table></td>");
                        strHTML.Append("</tr>");

                        // set Location Table 
                        //DataTable dtLocation = dsResult.Tables[0];

                        // Check if record is exist for location
                        // if (dtLocation.Rows.Count > 0)
                        //{
                        // loop for all location
                        // foreach (DataRow drLocation in dtLocation.Rows)
                        //{
                        // filter Reprot Result by Locaion ID
                        DataTable dtReportDetail = dsResult.Tables[0];
                        //dtReportDetail.DefaultView.RowFilter = " Region = '" + drLocation["Region"].ToString() + "'";
                        // dtReportDetail.DefaultView.Sort = "Region";
                        //dtReportDetail = dtReportDetail.DefaultView.ToTable();

                        // display location for filter
                        //strHTML.Append("<tr valign='top' align='left'>");
                        //strHTML.Append("<td colspan='10' align-'left'><b> Region : " + Convert.ToString(drLocation["Region"]) + "</b></td>");
                        //strHTML.Append("</tr>");

                        // print Report Detail
                        if (dtReportDetail.Rows.Count > 0)
                        {
                            // display record for Location
                            foreach (DataRow drReport in dtReportDetail.Rows)
                            {
                                strHTML.Append("<tr valign='top' align='left'>");

                                strHTML.Append("<td><table border='1'><tr>");
                                strHTML.Append("<td> " + Convert.ToString(drReport["DBA"]) + " </td>");
                                strHTML.Append("<td align='left' valign='top' style='width: 360px'>");
                                decimal _PK_RE_Information = Convert.ToDecimal(drReport["PK_RE_Information"]);
                                DataTable dtBuilding = Report.SelectByFK_RE_Information(_PK_RE_Information).Tables[0];
                                if (dtBuilding.Rows.Count > 0)
                                {
                                    strHTML.Append("<table cellspacing='0' cellpadding='0' align='Left' border='1' style='width: 100%; border-collapse: collapse;'>");
                                    foreach (DataRow drBuilding in dtBuilding.Rows)
                                    {
                                        strHTML.Append("<tr>");
                                        strHTML.Append("<td align='left' valign='top' style='width:30%'>" + Convert.ToString(drBuilding["Building_Number"]) + "</td>");
                                        strHTML.Append("<td align='left' valign='top' style='width:70%'>" + (drBuilding["Address"]) + "</td>");
                                        strHTML.Append("</tr>");
                                    }
                                    strHTML.Append("</table>");
                                }
                                else
                                {
                                    strHTML.Append("<table cellspacing='0' cellpadding='0' align='Left' border='1' style='width: 100%; border-collapse: collapse;'>");
                                    strHTML.Append("<tr>");
                                    strHTML.Append("<td align='left' valign='top' style='width:30%'>" + "" + "</td>");
                                    strHTML.Append("<td align='left' valign='top' style='width:70%'>" + "" + "</td>");
                                    strHTML.Append("</tr>");
                                    strHTML.Append("</table>");
                                }
                                strHTML.Append("</td>");
                                strHTML.Append("<td align='left' valign='top'> " + Convert.ToString(drReport["CITY"]) + " </td>");
                                strHTML.Append("<td align='left' valign='top'> " + Convert.ToString(drReport["STATE"]) + " </td>");
                                strHTML.Append("<td align='left' valign='top'> " + Convert.ToString(drReport["ZIP"]) + " </td>");
                                strHTML.Append("<td align='left' valign='top'> " + FormatDBNullDateToDisplay(drReport["LCD"]) + " </td>");
                                strHTML.Append("<td align='left' valign='top'> " + FormatDBNullDateToDisplay(drReport["LED"]) + " </td>");
                                strHTML.Append("<td align='left' valign='top'> " + Convert.ToString(drReport["Renewals"]) + " </td>");
                                strHTML.Append("<td align='left' valign='top'> " + Convert.ToString(drReport["Landlord_Name"]) + " </td>");
                                strHTML.Append("<td align='right' valign='top'> " + string.Format("{0:N0}", drReport["MonthlyRent"]) + " </td>");
                                strHTML.Append("<td align='left' valign='top'> " + Convert.ToString(drReport["Subtenant"]) + " </td>");
                                strHTML.Append("<td align='right' valign='top'> " + string.Format("{0:N0}", drReport["SubtenantMonthlyRent"]) + " </td>");
                                strHTML.Append("</tr></table></td>");
                                strHTML.Append("</tr>");
                            }

                            // print Sub Total by Location
                            //strHTML.Append("<tr valign='top' align='left' style='font-weight: bold;'>");
                            //strHTML.Append("<td> Sub Total </td>");
                            //strHTML.Append("<td>" + dtReportDetail.Rows.Count.ToString() + "</td>");
                            //strHTML.Append("<td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td>");
                            //strHTML.Append("<td align='right'> " + string.Format("{0:N0}", dtReportDetail.Compute("SUM(MonthlyRent)", "")) + " </td>");
                            //strHTML.Append("<td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td>");
                            //strHTML.Append("</tr>");
                        }
                        else
                        {
                            //Add No record found line for year
                            strHTML.Append("<tr><td align='left' colspan='10'>No Record Found!</td></tr>");
                        }

                        //}

                        // print Grand Total for Whole Report
                        strHTML.Append("<tr><td><table><tr>");
                        strHTML.Append("<td><table><tr valign='top' style='font-weight: bold; background-color: #507CD1;color: White;'>");
                        strHTML.Append("<td align='left'> Grand Total </td>");
                        strHTML.Append("<td colspan='2' align='left'>" + dsResult.Tables[0].Rows.Count.ToString() + "</td>");
                        strHTML.Append("<td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td><td>&nbsp;</td>");
                        strHTML.Append("<td align='right'> " + string.Format("{0:N0}", dsResult.Tables[0].Compute("SUM(MonthlyRent)", "")) + " </td>");
                        strHTML.Append("<td>&nbsp;</td><td align='right'> " + string.Format("{0:N0}", dsResult.Tables[0].Compute("SUM(SubtenantMonthlyRent)", "")) + " </td>");
                        strHTML.Append("</tr></table></td></tr></table></td>");
                        strHTML.Append("</tr>");

                        //}
                        strHTML.Append("</table>");
                        #endregion

                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        SendMail("Master Dealership Report", "MasterDealershipReport.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in Master Dealership Report, " + ex.Message + " - " + ex.StackTrace.ToString() + " - " + ex.Source.ToString());
            }
        }

        // Report 40
        private void BindLandlordInfoReport(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(40, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list 
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = Convert.ToString(dtUser.Rows[0]["FIRST_NAME"]).Trim();
                        strLastName = Convert.ToString(dtUser.Rows[0]["LAST_NAME"]).Trim();
                        strMailFrom = Convert.ToString(dtUser.Rows[0]["Email"]).Trim();

                        //Set all filters to a variable as per report type
                        DateTime? dtLCDFrom = null, dtLCDTo = null, dtLEDFrom = null, dtLEDTo = null;

                        string strRegion = Convert.ToString(dtFilter.Rows[0]["Region"]).Trim();
                        string strMarket = null;
                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Market"])))
                        {
                            strMarket = Convert.ToString(dtFilter.Rows[0]["Market"]).Trim();
                        }

                        if (dtFilter.Rows[0]["LCDFrom_Date"] != DBNull.Value)
                            dtLCDFrom = Convert.ToDateTime(dtFilter.Rows[0]["LCDFrom_Date"]);

                        if (Convert.ToString(dtFilter.Rows[0]["LCDTo_Date"]) != string.Empty && dtFilter.Rows[0]["LCDTo_Date"] != DBNull.Value)
                            dtLCDTo = Convert.ToDateTime(dtFilter.Rows[0]["LCDTo_Date"]);

                        if (Convert.ToString(dtFilter.Rows[0]["LEDFrom_Date"]) != string.Empty && dtFilter.Rows[0]["LEDFrom_Date"] != DBNull.Value)
                            dtLEDFrom = Convert.ToDateTime(dtFilter.Rows[0]["LEDFrom_Date"]);

                        if (Convert.ToString(dtFilter.Rows[0]["LEDTo_Date"]) != string.Empty && dtFilter.Rows[0]["LEDTo_Date"] != DBNull.Value)
                            dtLEDTo = Convert.ToDateTime(dtFilter.Rows[0]["LEDTo_Date"]);

                        //Get the all Unique records for Selected group (default - last name -sort) by search criteria
                        DataSet dsResult = Report.GetLandlordInfoReport(strRegion, strMarket, dtLCDFrom, dtLCDTo, dtLEDFrom, dtLEDTo);

                        //Create HTML for the report and wirte into HTML Write object
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        #region "Report Criteria"

                        //Retrieve Market Values
                        string strMarketString = string.Empty;
                        if (string.IsNullOrEmpty(strMarket))
                        {
                            strMarketString = "All Market";
                        }
                        else
                        {
                            string[] strMar = strMarket.Split(Convert.ToChar(","));
                            for (int i = 0; i < strMar.Length; i++)
                            {
                                strMarketString += Report.SelectMarketInfoById(Convert.ToDecimal(strMar[i].ToString())).Tables[0].Rows[0]["Market"].ToString() + ",";
                            }
                            strMarketString = strMarketString.TrimEnd(',');
                        }

                        //Add Report Title and Schedule Date
                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : Landlord Report </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"].ToString());
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        //Add Report Filter Criteria 
                        strHTML.Append("<br /><br />");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Region        : " + strRegion.Replace("'", ""));
                        strHTML.Append("<br />");
                        strHTML.Append("Market        : " + strMarketString);
                        strHTML.Append("<br /><br />");
                        strHTML.Append("LCD From      : " + FormatDBNullDateToDisplay(dtLCDFrom));
                        strHTML.Append("<br />");
                        strHTML.Append("LCD To        : " + FormatDBNullDateToDisplay(dtLCDTo));
                        strHTML.Append("<br />");
                        strHTML.Append("LED From      : " + FormatDBNullDateToDisplay(dtLEDFrom));
                        strHTML.Append("<br />");
                        strHTML.Append("LED To        : " + FormatDBNullDateToDisplay(dtLEDTo));
                        strHTML.Append("<br /><br />");

                        #endregion

                        #region "Report Grid header"

                        strHTML.Append("<table border='1'>");
                        strHTML.Append("<tr style='font-weight: bold' align='left'>");
                        strHTML.Append("<td><table border='1'><tr style='font-weight: bold'>");
                        strHTML.Append("<td align='left' colspan='2'>Sonic Automotive</td>");
                        strHTML.Append("<td align='center' colspan='7'>Landlord Report</td>");
                        strHTML.Append("<td align='right' colspan='6'>" + DateTime.Now.ToString() + "</td>");
                        strHTML.Append("</tr></table></td></tr>");

                        strHTML.Append("<tr><td><table cellpadding='0' cellspacing='0' width='100%' style='font-weight: bold;' border='1'>");
                        strHTML.Append("<tr valign='bottom' align='left' style='font-weight: bold'>");
                        strHTML.Append("<td> Location</td>");
                        strHTML.Append("<td align='left' style='width: 400px'>");
                        strHTML.Append("<table width='100%' cellpadding='0' cellspacing='0' border='1' style='font-weight: bold;'>");
                        strHTML.Append("<tr>");
                        strHTML.Append("<td align='left' style='width: 30%'>Building Number</td>");
                        strHTML.Append("<td align='left' style='width: 70%'>Building Address</td>");
                        strHTML.Append("</tr>");
                        strHTML.Append("</table>");
                        strHTML.Append("</td>");
                        strHTML.Append("<td> City</td>");
                        strHTML.Append("<td> State</td>");
                        strHTML.Append("<td> Zip</td>");
                        strHTML.Append("<td> LCD</td>");
                        strHTML.Append("<td> LED</td>");
                        strHTML.Append("<td> Renewals</td>");
                        strHTML.Append("<td> Building Landlord Name</td>");
                        strHTML.Append("<td> Address 1</td>");
                        strHTML.Append("<td> Address 2</td>");
                        strHTML.Append("<td> City</td>");
                        strHTML.Append("<td> State</td>");
                        strHTML.Append("<td> Zip</td>");
                        strHTML.Append("<td> Phone</td>");
                        strHTML.Append("</tr>");
                        strHTML.Append("</table></td></tr>");
                        // set Location Table 
                        // DataTable dtLocation = dsResult.Tables[0];

                        // Check if record is exist for location
                        // if (dtLocation.Rows.Count > 0)
                        //{
                        // loop for all location

                        // filter Reprot Result by Locaion ID
                        DataTable dtReportDetail = dsResult.Tables[0];


                        //dtReportDetail.DefaultView.RowFilter = " PK_LU_Location_Id = " + drLocation["PK_LU_Location_Id"].ToString();
                        //dtReportDetail.DefaultView.Sort = "DBA";
                        //dtReportDetail = dtReportDetail.DefaultView.ToTable();

                        // display location for filter
                        //strHTML.Append("<tr valign='top' align='left'>");
                        //strHTML.Append("<td colspan='15' align-'left'><b> Location : " + Convert.ToString(drLocation["dba"]) + "</b></td>");
                        //strHTML.Append("</tr>");

                        // print Report Detail
                        if (dtReportDetail.Rows.Count > 0)
                        {
                            // display record for Location
                            foreach (DataRow drReport in dtReportDetail.Rows)
                            {
                                strHTML.Append("<tr><td><table cellpadding='0' cellspacing='0' width='100%' border='1'>");
                                strHTML.Append("<tr align='left'>");
                                strHTML.Append("<td align='left' valign='top'> " + Convert.ToString(drReport["DBA"]) + " </td>");
                                strHTML.Append("<td align='left' valign='top' style='width: 400px'>");
                                decimal _PK_RE_Information = Convert.ToDecimal(drReport["PK_RE_Information"]);
                                DataTable dtBuilding = Report.SelectByFK_RE_Information(_PK_RE_Information).Tables[0];
                                if (dtBuilding.Rows.Count > 0)
                                {
                                    strHTML.Append("<table cellspacing='0' cellpadding='0' align='Left' border='1' style='width: 100%; border-collapse: collapse;'>");
                                    foreach (DataRow drBuilding in dtBuilding.Rows)
                                    {
                                        strHTML.Append("<tr>");
                                        strHTML.Append("<td align='left' valign='top' style='width:30%'>" + Convert.ToString(drBuilding["Building_Number"]) + "</td>");
                                        strHTML.Append("<td align='left' valign='top' style='width:70%'>" + (drBuilding["Address"]) + "</td>");
                                        strHTML.Append("</tr>");
                                    }
                                    strHTML.Append("</table>");
                                }
                                else
                                {
                                    strHTML.Append("<table cellspacing='0' cellpadding='0' align='Left' border='1' style='width: 100%; border-collapse: collapse;'>");
                                    strHTML.Append("<tr>");
                                    strHTML.Append("<td align='left' valign='top' style='width:30%'>" + "" + "</td>");
                                    strHTML.Append("<td align='left' valign='top' style='width:70%'>" + "" + "</td>");
                                    strHTML.Append("</tr>");
                                    strHTML.Append("</table>");
                                }
                                strHTML.Append("</td>");
                                strHTML.Append("<td align='left' valign='top'> " + Convert.ToString(drReport["City"]) + " </td>");
                                strHTML.Append("<td align='left' valign='top'> " + Convert.ToString(drReport["State"]) + " </td>");
                                strHTML.Append("<td align='left' valign='top'> " + Convert.ToString(drReport["Zip"]) + " </td>");
                                strHTML.Append("<td align='left' valign='top'> " + (drReport["Lease_Commencement_Date"] != DBNull.Value ? Convert.ToDateTime(drReport["Lease_Commencement_Date"]) == System.Data.SqlTypes.SqlDateTime.MinValue ? "" : string.Format("{0:MM/dd/yyyy}", drReport["Lease_Commencement_Date"]) : "") + " </td>");
                                strHTML.Append("<td align='left' valign='top'> " + (drReport["Lease_Expiration_Date"] != DBNull.Value ? Convert.ToDateTime(drReport["Lease_Expiration_Date"]) == System.Data.SqlTypes.SqlDateTime.MinValue ? "" : string.Format("{0:MM/dd/yyyy}", drReport["Lease_Expiration_Date"]) : "") + " </td>");
                                strHTML.Append("<td align='left' valign='top'> " + Convert.ToString(drReport["Renewals"]) + " </td>");
                                strHTML.Append("<td align='left' valign='top'> " + Convert.ToString(drReport["Landlord_Name"]) + " </td>");
                                strHTML.Append("<td align='left' valign='top'> " + Convert.ToString(drReport["Landlord_Address_1"]) + " </td>");
                                strHTML.Append("<td align='left' valign='top'> " + Convert.ToString(drReport["Landlord_Address_2"]) + " </td>");
                                strHTML.Append("<td align='left' valign='top'> " + Convert.ToString(drReport["Landlord_City"]) + " </td>");
                                strHTML.Append("<td align='left' valign='top'> " + Convert.ToString(drReport["Landlord_State"]) + " </td>");
                                strHTML.Append("<td align='left' valign='top'> " + Convert.ToString(drReport["Landlord_Zip"]) + " </td>");
                                strHTML.Append("<td align='left' valign='top'> " + Convert.ToString(drReport["Landlord_Telephone"]) + " </td>");
                                strHTML.Append("</tr>");
                                strHTML.Append("</table></td></tr>");
                            }

                            //// print Sub Total by Location
                            //strHTML.Append("<tr valign='top' align='left' style='font-weight: bold;'>");
                            //strHTML.Append("<td> Total </td>");
                            //strHTML.Append("<td>" + dtReportDetail.Rows.Count.ToString() + "</td>");
                            //strHTML.Append("<td> <td> <td> <td> <td> <td><td><td><td> <td><td><td><td></td><td></td>");
                            //strHTML.Append("</tr>");
                        }
                        else
                        {
                            //Add No record found line for year
                            strHTML.Append("<tr><td align='left' colspan='15'>No Record Found!</td></tr>");
                        }


                        // print Grand Total for Whole Report
                        strHTML.Append("<tr valign='top' align='left' style='font-weight: bold; background-color: #507CD1;color: White;border:thin'>");
                        strHTML.Append("<td style='border:thin'> Grand Total </td>");
                        strHTML.Append("<td style='border:thin'>" + dsResult.Tables[0].Rows.Count.ToString() + "</td>");
                        strHTML.Append("<td colspan='14' style='border:thin'>&nbsp; </td> ");
                        strHTML.Append("</table>");
                        strHTML.Append("<table border='1'>");
                        strHTML.Append("<tr valign='top' align='left' style='font-weight: bold; background-color: #507CD1;color: White;'>");
                        strHTML.Append("<td> Grand Total </td>");
                        strHTML.Append("<td>" + dsResult.Tables[0].Rows.Count.ToString() + "</td>");
                        strHTML.Append("<td colspan='14'>&nbsp; </td> ");
                        strHTML.Append("</tr>");

                        //}
                        strHTML.Append("</table>");
                        #endregion

                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        SendMail("Landlord Report", "LandlordReport.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in Landlord Info Report, " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
        }

        // Report 41
        private void BindPolicyInsuranceScheduleReport(DataRow drReportSchedule)
        {
            decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
            decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
            decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

            //Get Report criteria for the scheduled report
            DataTable dtFilter = Report.SelectFilterCriteria(41, pK_Schedule_ID).Tables[0];
            if (dtFilter.Rows.Count > 0)
            {
                //Get the recipient from the recipient list 
                DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                //Get the user who has scheduled the report
                DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                String strFirstName, strLastName, strMailFrom;
                strFirstName = strLastName = strMailFrom = "";
                if (dtUser.Rows.Count > 0)
                {
                    strFirstName = Convert.ToString(dtUser.Rows[0]["FIRST_NAME"]).Trim();
                    strLastName = Convert.ToString(dtUser.Rows[0]["LAST_NAME"]).Trim();
                    strMailFrom = Convert.ToString(dtUser.Rows[0]["Email"]).Trim();

                    //Set all filters to a variable as per report type
                    int? intPolicyYear = null;
                    string strProgramIDs = "";
                    string strPolicyTypes = "";


                    if (dtFilter.Rows[0]["Policy_Year"] != DBNull.Value)
                        intPolicyYear = Convert.ToInt32(dtFilter.Rows[0]["Policy_Year"]);

                    if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["ProgramID"])))
                        strProgramIDs = Convert.ToString(dtFilter.Rows[0]["ProgramID"]);

                    if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["PolicyType"])))
                        strPolicyTypes = Convert.ToString(dtFilter.Rows[0]["PolicyType"]);

                    //Get the all Unique records for Selected group (default - last name -sort) by search criteria
                    DataSet dsResult = Report.GetInsuranceSchedule(intPolicyYear, strProgramIDs, strPolicyTypes);

                    //Create HTML for the report and wirte into HTML Write object
                    StringBuilder strHTML = new StringBuilder();
                    System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                    System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                    #region "Report Criteria"

                    //Add Report Title and Schedule Date
                    strHTML.Append("<table><tr><td colspan='18'>");
                    strHTML.Append("<br />");
                    strHTML.Append("<b>Report Title : Insurance Schedule </b>");
                    strHTML.Append("<br /><br />");
                    strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                    strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                    strHTML.Append("<br />");
                    strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"].ToString());
                    strHTML.Append("<br />");
                    strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                    //Add Report Filter Criteria 
                    strHTML.Append("<br /><br />");
                    strHTML.Append("<b>Report Filters </b>");
                    strHTML.Append("<br /><br />");
                    strHTML.Append("Policy Year         : " + (intPolicyYear > 0 ? intPolicyYear.ToString() : string.Empty));
                    strHTML.Append("<br />");
                    strHTML.Append("Program             : " + Report.SelectPrograms(strProgramIDs));
                    strHTML.Append("<br />");
                    strHTML.Append("Policy Type         : " + Report.SelectPolicyTypes(strPolicyTypes));
                    strHTML.Append("<br /><br />");
                    strHTML.Append("</td></tr></table>");

                    #endregion

                    #region "Report Grid header"

                    strHTML.Append("<table border='1'>");
                    strHTML.Append("<tr style='font-weight: bold' valign='bottom' >");
                    strHTML.Append("<td align='left' colspan='2'>Sonic Automotive</td>");
                    strHTML.Append("<td align='center' colspan='13'>Insurance Schedule</td>");
                    strHTML.Append("<td align='right' colspan='3'>" + (intPolicyYear > 0 ? intPolicyYear.ToString() : string.Empty) + "</td>");
                    strHTML.Append("</tr>");
                    strHTML.Append("<tr valign='bottom' style='font-weight: bold'>");
                    strHTML.Append("<td align='left' width='125px'>Program</td>");
                    strHTML.Append("<td align='left' width='200px'>Policy Type</td>");
                    strHTML.Append("<td align='left' width='150px'>Layer</td>");
                    strHTML.Append("<td align='left' width='150px'>Insurance Carrier</td>");
                    strHTML.Append("<td align='left' width='150px'>Policy Number</td>");
                    strHTML.Append("<td align='left' width='150px'>Policy Effective Date</td>");
                    strHTML.Append("<td align='left' width='150px'>Policy Expiration Date</td>");
                    strHTML.Append("<td align='left' width='125px'>Coverage Form</td>");
                    strHTML.Append("<td align='right' width='130px'>Per Occurrence Limit $</td>");
                    strHTML.Append("<td align='right' width='125px'>Aggregate Limit $</td>");
                    strHTML.Append("<td align='right' width='125px'>Underlying Limit $</td>");
                    strHTML.Append("<td align='right' width='125px'>Share Percentage $</td>");
                    strHTML.Append("<td align='right' width='125px'>Share Limit $</td>");
                    strHTML.Append("<td align='right' width='125px'>Deductible $</td>");
                    strHTML.Append("<td align='right' width='125px'>Store Deductible $</td>");
                    strHTML.Append("<td align='right' width='125px'>Annual Premium $</td>");
                    strHTML.Append("<td align='right' width='125px'>S/L Fees $</td>");
                    strHTML.Append("<td align='right' width='125px'>Total $</td>");
                    strHTML.Append("</tr>");

                    // set Location Table 
                    DataTable dtPolicy = dsResult.Tables[0];

                    // Check if record is exist for location
                    if (dtPolicy.Rows.Count > 0)
                    {
                        // display record for Location
                        foreach (DataRow drReport in dtPolicy.Rows)
                        {
                            strHTML.Append("<tr valign='top' >");
                            strHTML.Append("<td align='left' width='125px'>" + drReport["Program"] + "</td>");
                            strHTML.Append("<td align='left' width='200px'>" + drReport["Policy_Type"] + "</td>");
                            strHTML.Append("<td align='left' width='150px'>" + drReport["Layer"] + "</td>");
                            strHTML.Append("<td align='left' width='150px'>" + drReport["Carrier"] + "</td>");
                            strHTML.Append("<td align='left' width='150px'>" + drReport["Policy_Number"] + "</td>");
                            strHTML.Append("<td align='left' width='150px'>" + string.Format("{0:MM/dd/yyyy}", drReport["Policy_Effective_Date"]) + "</td>");
                            strHTML.Append("<td align='left' width='150px'>" + string.Format("{0:MM/dd/yyyy}", drReport["Policy_Expiration_Date"]) + "</td>");
                            strHTML.Append("<td align='left' width='125px'>" + drReport["Coverage_Form"] + "</td>");
                            strHTML.Append("<td align='right' width='130px'>" + string.Format("{0:N2}", drReport["Per_Occurrence_Limit"]) + "</td>");
                            strHTML.Append("<td align='right' width='125px'>" + string.Format("{0:N2}", drReport["Aggregate_Limit"]) + "</td>");
                            strHTML.Append("<td align='right' width='125px'>" + string.Format("{0:N2}", drReport["Underlying_Limit"]) + "</td>");
                            strHTML.Append("<td align='right' width='125px'>" + string.Format("{0:N2}", drReport["Share_Precentage"]) + "</td>");
                            strHTML.Append("<td align='right' width='125px'>" + string.Format("{0:N2}", drReport["Share_Limit"]) + "</td>");
                            strHTML.Append("<td align='right' width='125px'>" + string.Format("{0:N2}", drReport["Deductible_Amount"]) + "</td>");
                            strHTML.Append("<td align='right' width='125px'>" + string.Format("{0:N2}", drReport["Store_Deductible"]) + "</td>");
                            strHTML.Append("<td align='right' width='125px'>" + string.Format("{0:N2}", drReport["Annual_Premium"]) + "</td>");
                            strHTML.Append("<td align='right' width='125px'>" + string.Format("{0:N2}", drReport["Surplus_Lines_Fees"]) + "</td>");
                            strHTML.Append("<td align='right' width='125px'>" + string.Format("{0:N2}", drReport["Total"]) + "</td>");
                            strHTML.Append("</tr>");
                        }

                        // print Sub Total by Location
                        strHTML.Append("<tr valign='top' style='font-weight: bold;'>");
                        strHTML.Append("<td>Total</td>");
                        strHTML.Append("<td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>");
                        strHTML.Append("<td align='right'>" + string.Format("{0:N2}", dtPolicy.Compute("SUM(Annual_Premium)", "")) + "</td>");
                        strHTML.Append("<td align='right'>" + string.Format("{0:N2}", dtPolicy.Compute("SUM(Surplus_Lines_Fees)", "")) + "</td>");
                        strHTML.Append("<td align='right'>" + string.Format("{0:N2}", dtPolicy.Compute("SUM(Total)", "")) + "</td>");
                        strHTML.Append("</tr>");
                    }
                    strHTML.Append("</table>");
                    #endregion

                    //Write HTML in to HtmlWriter
                    htmlWrite.WriteLine(strHTML.ToString());

                    //Send Mail
                    SendMail("Insurance Schedule", "InsuranceScheduleReport.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
                }
            }
        }

        //Report 42
        private void BindExp_ThirdPartyOwnedReport(DataRow drReportSchedule)
        {
            decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
            decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
            decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

            //Get Report criteria for the scheduled report
            DataTable dtFilter = Report.SelectFilterCriteria(42, pK_Schedule_ID).Tables[0];
            if (dtFilter.Rows.Count > 0)
            {
                //Get the recipient from the recipient list 
                DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                //Get the user who has scheduled the report
                DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                String strFirstName, strLastName, strMailFrom;
                strFirstName = strLastName = strMailFrom = "";
                if (dtUser.Rows.Count > 0)
                {
                    strFirstName = Convert.ToString(dtUser.Rows[0]["FIRST_NAME"]).Trim();
                    strLastName = Convert.ToString(dtUser.Rows[0]["LAST_NAME"]).Trim();
                    strMailFrom = Convert.ToString(dtUser.Rows[0]["Email"]).Trim();
                }
                string strRegion = Convert.ToString(dtFilter.Rows[0]["Region"]).Trim();
                string strMarket = null;
                if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Market"])))
                {
                    strMarket = Convert.ToString(dtFilter.Rows[0]["Market"]).Trim();
                }
                string strStatus = Convert.ToString(dtFilter.Rows[0]["Status"]).Trim();

                //Get the all Unique records for Selected group (default - last name -sort) by search criteria
                DataSet dsResult = Report.GetNewExposuresreport(strRegion, strMarket, strStatus, FK_Security_Id);

                //Create HTML for the report and wirte into HTML Write object
                StringBuilder strHTML = new StringBuilder();
                System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                #region "Report Title"

                //Retrieve Market Values
                string strMarketString = string.Empty;
                if (string.IsNullOrEmpty(strMarket))
                {
                    strMarketString = "All Market";
                }
                else
                {
                    string[] strMar = strMarket.Split(Convert.ToChar(","));
                    for (int i = 0; i < strMar.Length; i++)
                    {
                        strMarketString += Report.SelectMarketInfoById(Convert.ToDecimal(strMar[i].ToString())).Tables[0].Rows[0]["Market"].ToString() + ",";
                    }
                    strMarketString = strMarketString.TrimEnd(',');
                }

                //Add Report Title and Schedule Date
                strHTML.Append("<table><tr><td colspan='27'>");
                strHTML.Append("<br />");
                strHTML.Append("<b>Report Title : Third Party Owned and Sonic Leased, Subleased to Third Party and Sonic Owned with Third Party Lease</b>");
                strHTML.Append("<br /><br />");
                strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                strHTML.Append("<br />");
                strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"].ToString());
                strHTML.Append("<br />");
                strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                //Add Report Filter Criteria 
                strHTML.Append("<br /><br />");
                strHTML.Append("<b>Report Filters </b>");
                strHTML.Append("<br />");
                strHTML.Append("Region : " + strRegion);
                strHTML.Append("<br />");
                strHTML.Append("Market : " + strMarketString);
                strHTML.Append("<br />");
                //strHTML.Append("<tr> <td colspan='8'>");
                strHTML.Append("Location Status : " + strStatus);
                //strHTML.Append("</td> </tr>");
                //strHTML.Append("<tr> <td colspan='8'>");
                strHTML.Append("</td></tr></table> ");

                #endregion

                #region "Report Grid header"
                //Top Header
                strHTML.Append("<table border='1'>");
                strHTML.Append("<tr style='font-weight: bold;' valign='bottom' align='left'>");
                strHTML.Append("<td align='left' colspan='2'>Sonic Automotive</td>");
                strHTML.Append("<td align='center' colspan='22'>Third Party Owned and Sonic Leased, Subleased to Third Party and Sonic Owned with Third Party Lease</td>");
                strHTML.Append("<td align='right' colspan='3'> " + DateTime.Now.ToString() + " </td>");
                strHTML.Append("</tr>");

                //Sub Header
                strHTML.Append("<tr valign='bottom' align='left' style='font-weight: bold'>");
                strHTML.Append("<td width='150'>Region</td>");
                strHTML.Append("<td width='150'>Sonic Location D/B/A</td>");
                strHTML.Append("<td width='150'> Building Number</td>");
                strHTML.Append("<td width='160'> Building Street Address 1</td>");
                strHTML.Append("<td width='160'> Building Street Address 2</td>");
                strHTML.Append("<td width='150'> Building City</td>");
                strHTML.Append("<td width='150'> Building State</td>");
                strHTML.Append("<td width='150'> Building Zip Code</td>");
                strHTML.Append("<td width='150'>Status</td>");
                strHTML.Append("<td width='200'>Ownership</td>");
                strHTML.Append("<td width='150'>Landlord Name</td>");
                strHTML.Append("<td width='150'>Landlord Legal Entity</td>");
                strHTML.Append("<td width='150'> Address 1</td>");
                strHTML.Append("<td width='150'> Address 2</td>");
                strHTML.Append("<td width='150'>City</td>");
                strHTML.Append("<td width='150'>State</td>");
                strHTML.Append("<td width='150'>Zip Code</td>");
                strHTML.Append("<td width='150'>Lease ID</td>");
                strHTML.Append("<td width='150'>Commencement Date</td>");
                strHTML.Append("<td width='150'>Expiration Date</td>");
                strHTML.Append("<td width='150'> Sub-Lease Name</td>");
                strHTML.Append("<td width='150'> Sub-Lease Landlord</td>");
                strHTML.Append("<td width='150'>Address 1</td>");
                strHTML.Append("<td width='150'>Address 2</td>");
                strHTML.Append("<td width='150'>City</td>");
                strHTML.Append("<td width='150'>State</td>");
                strHTML.Append("<td width='150'>Zip</td>");


                strHTML.Append("</tr>");

                //Check Whether Record Exists or Not
                if (dsResult != null && dsResult.Tables.Count > 0 && dsResult.Tables[0].Rows.Count > 0)
                {
                    foreach (DataRow dr in dsResult.Tables[0].Rows)
                    {
                        strHTML.Append("<tr valign='top' align='left'>");

                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["Region"]) + "</td>");
                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["dba"]) + "</td>");
                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["BUILDING_NUMBER"]) + "</td>");
                        strHTML.Append("<td width='160'>" + Convert.ToString(dr["Building_Address_1"]) + "</td>");
                        strHTML.Append("<td width='160'>" + Convert.ToString(dr["Building_Address_2"]) + "</td>");
                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["Building_City"]) + "</td>");
                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["Building_State"]) + "</td>");
                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["Building_Zip"]) + "</td>");
                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["LOCATION_STATUS"]) + "</td>");
                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["Ownership"]) + "</td>");
                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["LANDLORD_NAME"]) + "</td>");
                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["LANDLORD_LEGAL_ENTITY"]) + "</td>");
                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["LANDLORD_ADDRESS_1"]) + "</td>");
                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["LANDLORD_ADDRESS_2"]) + "</td>");
                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["LANDLORD_CITY"]) + "</td>");
                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["Landlord_State"]) + "</td>");
                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["LANDLORD_ZIP"]) + "</td>");
                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["LEASE_ID"]) + "</td>");
                        strHTML.Append("<td width='150'>" + FormatDBNullDateToDisplay(dr["COMMENCEMENT_DATE"]) + "</td>");
                        strHTML.Append("<td width='150'>" + FormatDBNullDateToDisplay(dr["EXPIRATION_DATE"]) + "</td>");
                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["SUBLEASE_NAME"]) + "</td>");
                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["SUBLANDLORD"]) + "</td>");
                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["SUBLEASE_ADDRESS_1"]) + "</td>");
                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["SUBLEASE_ADDRESS_2"]) + "</td>");
                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["SUBLEASE_CITY"]) + "</td>");
                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["Sublease_State"]) + "</td>");
                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["SUBLEASE_ZIP"]) + "</td>");


                        strHTML.Append("</tr>");
                    }
                }
                else
                {
                    //Add No record found line for year
                    strHTML.Append("<tr><td align='left' colspan='81'>No Record Found!</td></tr>");
                }
                strHTML.Append("</table>");

                #endregion

                //Write HTML in to HtmlWriter
                htmlWrite.WriteLine(strHTML.ToString());
                //Send Mail
                SendMail("Third Party Owned and Sonic Leased and Subleased to Third Party Report", "Third_Party_Owned_Report.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
            }

        }

        // Report 43
        private void BindFacilityInspectionReport(DataRow drReportSchedule)
        {
            decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
            decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
            decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

            //Get Report criteria for the scheduled report
            DataTable dtFilter = Report.SelectFilterCriteria(43, pK_Schedule_ID).Tables[0];
            if (dtFilter.Rows.Count > 0)
            {
                //Get the recipient from the recipient list 
                DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                //Get the user who has scheduled the report
                DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                String strFirstName, strLastName, strMailFrom;
                strFirstName = strLastName = strMailFrom = "";
                if (dtUser.Rows.Count > 0)
                {
                    strFirstName = Convert.ToString(dtUser.Rows[0]["FIRST_NAME"]).Trim();
                    strLastName = Convert.ToString(dtUser.Rows[0]["LAST_NAME"]).Trim();
                    strMailFrom = Convert.ToString(dtUser.Rows[0]["Email"]).Trim();
                }
                string strRegion = Convert.ToString(dtFilter.Rows[0]["Region"]).Trim();
                string strMarket = null;
                if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Market"])))
                {
                    strMarket = Convert.ToString(dtFilter.Rows[0]["Market"]).Trim();
                }
                string strYear = Convert.ToString(dtFilter.Rows[0]["Year"]).Trim();
                string strReportInterval = Convert.ToString(dtFilter.Rows[0]["Report_Interval"]).Trim();

                //Create HTML for the report and wirte into HTML Write object
                StringBuilder strHTML = new StringBuilder();
                System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                #region "Report Title"

                //Retrieve Market Values
                string strMarketString = string.Empty;
                if (string.IsNullOrEmpty(strMarket))
                {
                    strMarketString = "All Market";
                }
                else
                {
                    string[] strMar = strMarket.Split(Convert.ToChar(","));
                    for (int i = 0; i < strMar.Length; i++)
                    {
                        strMarketString += Report.SelectMarketInfoById(Convert.ToDecimal(strMar[i].ToString())).Tables[0].Rows[0]["Market"].ToString() + ",";
                    }
                    strMarketString = strMarketString.TrimEnd(',');
                }

                //Add Report Title and Schedule Date
                strHTML.Append("<table><tr><td colspan='13'>");
                strHTML.Append("<br />");
                strHTML.Append("<b>Report Title : EHS Inspection </b>");
                strHTML.Append("<br /><br />");
                strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                strHTML.Append("<br />");
                strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"].ToString());
                strHTML.Append("<br />");
                strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                //Add Report Filter Criteria 
                strHTML.Append("<br /><br />");
                strHTML.Append("<b>Report Filters </b>");
                strHTML.Append("<br />");
                strHTML.Append("Report Interval   : " + strReportInterval);
                strHTML.Append("<br/>");
                //strHTML.Append("<tr> <td colspan='8'>");
                strHTML.Append("Year   : " + strYear);
                strHTML.Append("<br/>");
                //strHTML.Append("<tr> <td colspan='8'>");
                strHTML.Append("Region   : " + strRegion);
                //strHTML.Append("</td> </tr>");
                //strHTML.Append("<tr> <td colspan='8'>");
                strHTML.Append("</td></tr></table>");

                #endregion

                #region "Report Data"
                //Monthly Report

                if (strReportInterval.ToString() == "Monthly")
                {
                    DataSet dsReport = Report.GetFacilityInspectionReport(strRegion, strMarket, Convert.ToInt32(strYear), strReportInterval, FK_Security_Id);
                    if (dsReport != null && dsReport.Tables.Count > 0 && dsReport.Tables[0].Rows.Count > 0)
                    {
                        // get data tables from dataset
                        DataTable dtRegions = dsReport.Tables[0];

                        strHTML.Append("<table border='1' style='border: black 0.5px solid;border-collapse: collapse;' cellpadding='0' cellspacing='0'  Width='100%px'><tr><td>");

                        strHTML.Append("<table border='1' style='padding-left:4px;font-size:8.5pt;font-family:Tahoma' cellpadding='4' cellspacing='0' Width='1980px'>");//Sub Table
                        strHTML.Append("<tr style='font-weight: bold;font-size:11pt;height:25'>"); //Title
                        strHTML.Append("<td align='left' style='font-size:9pt;' colspan='2'><b>Sonic Automotive</b></td>");
                        strHTML.Append("<td align='center' style='font-size:9pt;' colspan='9' ><b> EHS INSPECTIONS - MONTHLY REPORT FOR " + strYear + " </b></td>");
                        strHTML.Append("<td style='font-size:9pt' align='right' colspan='4'>Valuation Date: " + DateTime.Now.ToString("MM/dd/yyy HH:mm tt") + "</td></tr>");

                        strHTML.Append("<tr align='left' border='1' style='border: black 0.5px solid;'>");
                        strHTML.Append("<td  width='180px'><b>REGION</b></td>");
                        strHTML.Append("<td  width='230px'><b>STORE</b></td>");
                        strHTML.Append("<td  width='120px'><b>JANUARY</b></td>");
                        strHTML.Append("<td  width='120px'><b>FEBRUARY</b></td>");
                        strHTML.Append("<td  width='120px'><b>MARCH</b></td>");
                        strHTML.Append("<td  width='120px'><b>APRIL</b></td>");
                        strHTML.Append("<td  width='120px'><b>MAY</b></td>");
                        strHTML.Append("<td  width='120px'><b>JUNE</b></td>");
                        strHTML.Append("<td  width='120px'><b>JULY</b></td>");
                        strHTML.Append("<td  width='120px'><b>AUGUST</b></td>");
                        strHTML.Append("<td  width='120px'><b>SEPTEMBER</b></td>");
                        strHTML.Append("<td  width='120px'><b>OCTOBER</b></td>");
                        strHTML.Append("<td  width='120px'><b>NOVEMBER</b></td>");
                        strHTML.Append("<td  width='120px'><b>DECEMBER</b></td>");
                        strHTML.Append("<td  width='130px'><b>AVERAGE SCORE</b></td>");
                        strHTML.Append("</tr>");
                        for (int intI3 = 0; intI3 < dtRegions.Rows.Count; intI3++)
                        {
                            DataRow drRecords = dtRegions.Rows[intI3];
                            //int intRes;
                            //int intDiv = System.Math.DivRem(intI3, 2, out intRes);
                            //if (intRes == 0)
                            //strHTML.Append("<tr align='left' style='font-size:8pt;background-color:#EAEAEA;font-family:Tahoma;'>");
                            // else
                            strHTML.Append("<tr align='left' style='font-size:8pt;border: black 0.5px solid;' border='1'>");

                            strHTML.Append("<td  align='left' >" + Convert.ToString(drRecords["Region"]) + "</td>");
                            strHTML.Append("<td  align='left'>" + Convert.ToString(drRecords["DBA"]) + "</td>");
                            strHTML.Append("<td  align='left'>" + GetScoreName(drRecords["JANUARY"]) + "</td>");
                            strHTML.Append("<td  align='left'>" + GetScoreName(drRecords["FEBRUARY"]) + "</td>");
                            strHTML.Append("<td  align='left'>" + GetScoreName(drRecords["MARCH"]) + "</td>");
                            strHTML.Append("<td  align='left'>" + GetScoreName(drRecords["APRIL"]) + "</td>");
                            strHTML.Append("<td  align='left'>" + GetScoreName(drRecords["MAY"]) + "</td>");
                            strHTML.Append("<td  align='left'>" + GetScoreName(drRecords["JUNE"]) + "</td>");
                            strHTML.Append("<td  align='left'>" + GetScoreName(drRecords["JULY"]) + "</td>");
                            strHTML.Append("<td  align='left'>" + GetScoreName(drRecords["AUGUST"]) + "</td>");
                            strHTML.Append("<td  align='left'>" + GetScoreName(drRecords["SEPTEMBER"]) + "</td>");
                            strHTML.Append("<td  align='left'>" + GetScoreName(drRecords["OCTOBER"]) + "</td>");
                            strHTML.Append("<td  align='left'>" + GetScoreName(drRecords["NOVEMBER"]) + "</td>");
                            strHTML.Append("<td  align='left'>" + GetScoreName(drRecords["DECEMBER"]) + "</td>");
                            strHTML.Append("<td  align='left'>" + GetScoreName(drRecords["Average"]) + "</td>");
                            strHTML.Append("</tr>");
                        }

                        //strHTML.Append("<tr><td colspan='15' class='cols_'>&nbsp;</td></tr>");
                        strHTML.Append("</table>");
                        strHTML.Append("</table>");
                    }
                    else
                    {
                        strHTML.Append("<table style='font-family:Tahoma' cellpadding='4' cellspacing='0' Width='100%'>");
                        strHTML.Append("<tr style='background-color:#F2F2F2;color:Black;'>");
                        strHTML.Append("<td align='center' style='font-size:9pt;'>No Records found.</td></tr></table>");
                    }
                }
                else if (strReportInterval.ToString() == "Quarterly")
                {
                    DataSet dsReport = Report.GetFacilityInspectionReport(strRegion, strMarket, Convert.ToInt32(strYear), strReportInterval, FK_Security_Id);
                    if (dsReport != null && dsReport.Tables.Count > 0 && dsReport.Tables[0].Rows.Count > 0)
                    {
                        DataTable dtRegions = dsReport.Tables[0];

                        strHTML.Append("<table border='1' style='border: black 0.5px solid;border-collapse: collapse;' cellpadding='0' cellspacing='0'  Width='100%px'><tr><td>");

                        strHTML.Append("<table border='1' style='padding-left:4px;font-size:8.5pt;font-family:Tahoma' cellpadding='4' cellspacing='0' Width='995px'>");//Sub Table
                        strHTML.Append("<tr style='font-weight: bold;font-size:11pt;height:25'>"); //Title
                        strHTML.Append("<td align='left' style='font-size:9pt;' colspan='1'><b>Sonic Automotive</b></td>");
                        strHTML.Append("<td align='center' style='font-size:9pt;' colspan='3' ><b> EHS INSPECTION - QUARTERLY REPORT FOR " + strYear + " </b></td>");
                        strHTML.Append("<td style='font-size:9pt' align='right' colspan='3'>Valuation Date: " + DateTime.Now.ToString("MM/dd/yyy HH:mm tt") + "</td></tr>");

                        strHTML.Append("<tr align='left' border='1' style='border: black 0.5px solid;' >");
                        strHTML.Append("<td  width='185px'><b>REGION</b></td>");
                        strHTML.Append("<td  width='220px'><b>STORE</b></td>");
                        strHTML.Append("<td  width='120px'><b>Q1</b></td>");
                        strHTML.Append("<td  width='120px'><b>Q2</b></td>");
                        strHTML.Append("<td  width='120px'><b>Q3</b></td>");
                        strHTML.Append("<td  width='120px'><b>Q4</b></td>");
                        strHTML.Append("<td  width='110px'><b>AVERAGE SCORE</b></td>");
                        strHTML.Append("</tr>");
                        for (int intI3 = 0; intI3 < dtRegions.Rows.Count; intI3++)
                        {
                            DataRow drRecords = dtRegions.Rows[intI3];
                            //int intRes;
                            //int intDiv = System.Math.DivRem(intI3, 2, out intRes);
                            //if (intRes == 0)
                            //    strHTML.Append("<tr align='left' style='font-size:8pt;background-color:#EAEAEA;font-family:Tahoma;'>");
                            //else
                            strHTML.Append("<tr align='left' style='font-size:8pt;border: black 0.5px solid;' border='1'>");

                            strHTML.Append("<td  align='left' >" + Convert.ToString(drRecords["Region"]) + "</td>");
                            strHTML.Append("<td>" + Convert.ToString(drRecords["DBA"]) + "</td>");
                            strHTML.Append("<td align='left'>" + GetScoreName(drRecords["Q1"]) + "</td>");
                            strHTML.Append("<td align='left'>" + GetScoreName(drRecords["Q2"]) + "</td>");
                            strHTML.Append("<td align='left'>" + GetScoreName(drRecords["Q3"]) + "</td>");
                            strHTML.Append("<td align='left'>" + GetScoreName(drRecords["Q4"]) + "</td>");
                            strHTML.Append("<td align='left'>" + GetScoreName(drRecords["Average"]) + "</td>");
                            strHTML.Append("</tr>");
                        }
                        strHTML.Append("</table>");
                        strHTML.Append("</table>");
                    }
                    else
                    {
                        strHTML.Append("<table style='font-family:Tahoma' cellpadding='4' cellspacing='0' Width='100%'>");
                        strHTML.Append("<tr style='background-color:#F2F2F2;color:Black;'>");
                        strHTML.Append("<td align='center' style='font-size:9pt;'>No Records found.</td></tr></table>");
                    }
                }
                else if (strReportInterval.ToString() == "Annually")
                {
                    DataSet dsReport = Report.GetFacilityInspectionReport(strRegion, strMarket, Convert.ToInt32(strYear), strReportInterval, FK_Security_Id);
                    if (dsReport != null && dsReport.Tables.Count > 0 && dsReport.Tables[0].Rows.Count > 0)
                    {
                        DataTable dtRegions = dsReport.Tables[0];
                        strHTML.Append("<table border='1' style='border: black 0.5px solid;border-collapse: collapse;' cellpadding='0' cellspacing='0'  Width='100%px'><tr><td>");

                        strHTML.Append("<table border='1' style='padding-left:4px;font-size:8.5pt;font-family:Tahoma' cellpadding='4' cellspacing='0' Width='996px'>");//Sub Table
                        strHTML.Append("<tr style='font-weight: bold;font-size:11pt;height:25'>"); //Title
                        strHTML.Append("<td align='left' style='font-size:9pt;' colspan='1'><b>Sonic Automotive</b></td>");
                        strHTML.Append("<td align='center' style='font-size:9pt;' colspan='4' ><b> EHS INSPECTION - ANNUAL REPORT FOR " + strYear + " </b></td>");
                        strHTML.Append("<td style='font-size:9pt' align='right' colspan='3'>Valuation Date: " + DateTime.Now.ToString("MM/dd/yyy HH:mm tt") + "</td></tr>");

                        strHTML.Append("<tr align='left' border='1' style='border: black 0.5px solid;'>");
                        strHTML.Append("<td width='180px'><b>REGION</b></td>");
                        strHTML.Append("<td width='230px'><b>STORE</b></td>");
                        strHTML.Append("<td width='120px'><b>" + Convert.ToString(Convert.ToInt32(strYear) - 4) + "</b></td>");
                        strHTML.Append("<td width='120px'><b>" + Convert.ToString(Convert.ToInt32(strYear) - 3) + "</b></td>");
                        strHTML.Append("<td width='120px'><b>" + Convert.ToString(Convert.ToInt32(strYear) - 2) + "</b></td>");
                        strHTML.Append("<td width='120px'><b>" + Convert.ToString(Convert.ToInt32(strYear) - 1) + "</b></td>");
                        strHTML.Append("<td width='120px'><b>" + Convert.ToString(Convert.ToInt32(strYear)) + "</b></td>");
                        strHTML.Append("<td width='110px'><b>AVERAGE SCORE</b></td>");
                        strHTML.Append("</tr>");
                        for (int intI3 = 0; intI3 < dtRegions.Rows.Count; intI3++)
                        {
                            DataRow drRecords = dtRegions.Rows[intI3];
                            //int intRes;
                            //int intDiv = System.Math.DivRem(intI3, 2, out intRes);
                            //if (intRes == 0)
                            //    strHTML.Append("<tr align='left' style='font-size:8pt;background-color:#EAEAEA;font-family:Tahoma;'>");
                            //else
                            strHTML.Append("<tr align='left' style='font-size:8pt;border: black 0.5px solid;' border='1'>");

                            strHTML.Append("<td align='left' >" + Convert.ToString(drRecords["Region"]) + "</td>");
                            strHTML.Append("<td>" + Convert.ToString(drRecords["DBA"]) + "</td>");
                            strHTML.Append("<td align='left'>" + GetScoreName(drRecords["Year1"]) + "</td>");
                            strHTML.Append("<td align='left'>" + GetScoreName(drRecords["Year2"]) + "</td>");
                            strHTML.Append("<td align='left'>" + GetScoreName(drRecords["Year3"]) + "</td>");
                            strHTML.Append("<td align='left'>" + GetScoreName(drRecords["Year4"]) + "</td>");
                            strHTML.Append("<td align='left'>" + GetScoreName(drRecords["Year5"]) + "</td>");
                            strHTML.Append("<td align='left'>" + GetScoreName(drRecords["Average"]) + "</td>");
                            strHTML.Append("</tr>");
                        }
                        // sbRecorords.Append("<tr><td colspan='7' class='cols_'>&nbsp;</td></tr>");
                        strHTML.Append("</table>");
                        // sbRecorords.Append("</div>");
                        strHTML.Append("</table>");
                    }
                    else
                    {
                        strHTML.Append("<table style='font-family:Tahoma' cellpadding='4' cellspacing='0' Width='100%'>");
                        strHTML.Append("<tr style='background-color:#F2F2F2;color:Black;'>");
                        strHTML.Append("<td align='center' style='font-size:9pt;'>No Records found.</td></tr></table>");
                    }
                }
                #endregion

                //Write HTML in to HtmlWriter
                htmlWrite.WriteLine(strHTML.ToString());
                //Send Mail
                SendMail("EHS Inspection Report", "FacilityInspectionReprot.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
            }
        }

        // Report 44
        private void BindCustomerIncidentSummaryReport(DataRow drReportSchedule)
        {
            decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
            decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
            decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

            //Get Report criteria for the scheduled report
            DataTable dtFilter = Report.SelectFilterCriteria(44, pK_Schedule_ID).Tables[0];
            if (dtFilter.Rows.Count > 0)
            {
                //Get the recipient from the recipient list 
                DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                //Get the user who has scheduled the report
                DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                String strFirstName, strLastName, strMailFrom;
                strFirstName = strLastName = strMailFrom = "";
                if (dtUser.Rows.Count > 0)
                {
                    strFirstName = Convert.ToString(dtUser.Rows[0]["FIRST_NAME"]).Trim();
                    strLastName = Convert.ToString(dtUser.Rows[0]["LAST_NAME"]).Trim();
                    strMailFrom = Convert.ToString(dtUser.Rows[0]["Email"]).Trim();
                }

                string strFK_LU_Locations = Convert.ToString(dtFilter.Rows[0]["FK_LU_LocationIDs"]).Trim();
                string strYear = Convert.ToString(dtFilter.Rows[0]["Year"]);

                //Create HTML for the report and wirte into HTML Write object
                StringBuilder strHTML = new StringBuilder();
                System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                #region "Report Title"

                //Add Report Title and Schedule Date
                strHTML.Append("<table><tr><td colspan='14'>");

                strHTML.Append("<br />");
                strHTML.Append("<b>Report Title : Customer Relations Incident Summary Report </b>");
                strHTML.Append("<br /><br />");
                strHTML.Append("Schedule Start Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                strHTML.Append("<br />");
                strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"].ToString());
                strHTML.Append("<br />");
                strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                //Add Report Filter Criteria 
                strHTML.Append("<br /><br />");
                strHTML.Append("<b>Report Filters </b>");
                strHTML.Append("<br />");
                strHTML.Append("Year : " + strYear);
                strHTML.Append("<br/>");
                strHTML.Append("Location D/B/A : " + Report.GetCommaSepratedDBAFromIDs(strFK_LU_Locations));
                strHTML.Append("<br /><br />");
                strHTML.Append("</td></tr></table>");

                #endregion

                #region "Report Data"
                DataSet dsReport = Report.GetCustomerIncidentSummary(Convert.ToInt32(strYear), Convert.ToString(dtFilter.Rows[0]["FK_LU_LocationIDs"]));

                DataTable dtRecordType = dsReport.Tables[0];
                DataTable dtReport = dsReport.Tables[1];

                // Check if record found or not.
                if (dtReport.Rows.Count > 0)
                {
                    strHTML.Append("<table border='1' cellpadding='0' cellspacing='0'  Width='100%px'><tr><td  >");
                    strHTML.Append("<table  cellpadding='4' cellspacing='0' Width='100%' border='1'>");//Sub Table
                    strHTML.Append("<tr style='font-weight: bold;'>"); //Title
                    strHTML.Append("<td align='center'  colspan='14' ><b> Customer Relations Incident Summary Report for " + strYear + " </b></td>");
                    strHTML.Append("</tr>");

                    strHTML.Append("<tr align='left' style='font-weight: bold;'>");
                    strHTML.Append("<td  width='130px'>&nbsp;</td>");
                    strHTML.Append("<td  width='56px' align='left'>JAN</td>");
                    strHTML.Append("<td  width='56px' align='left'>FEB</td>");
                    strHTML.Append("<td  width='56px' align='left'>MAR</td>");
                    strHTML.Append("<td  width='56px' align='left'>APR</td>");
                    strHTML.Append("<td  width='56px' align='left'>MAY</td>");
                    strHTML.Append("<td  width='56px' align='left'>JUN</td>");
                    strHTML.Append("<td  width='56px' align='left'>JUL</td>");
                    strHTML.Append("<td  width='56px' align='left'>AUG</td>");
                    strHTML.Append("<td  width='56px' align='left'>SEP</td>");
                    strHTML.Append("<td  width='56px' align='left'>OCT</td>");
                    strHTML.Append("<td  width='56px' align='left'>NOV</td>");
                    strHTML.Append("<td  width='56px' align='left'>DEC</td>");
                    strHTML.Append("<td  width='56px' align='left'>Total</td>");
                    strHTML.Append("</tr>");

                    strHTML.Append("<tr><td style='color: #FF9C09;font-weight: bold;' colspan='14'>Analysis by Incident</td></tr>");

                    for (int i = 0; i < dtRecordType.Rows.Count; i++)
                    {
                        string strRecordType = Convert.ToString(dtRecordType.Rows[i]["Type"]);
                        DataRow[] drReport = dtReport.Select("Type = '" + strRecordType + "'");

                        if (strRecordType == "Number of Dealerships with a Reported Incident")
                            strHTML.Append("<tr><td style='color: #FF9C09;font-weight: bold;' colspan='14'>Analysis by Dealership</td></tr>");

                        strHTML.Append("<tr align='left' >");

                        if (strRecordType == "Method of Contact")
                        {
                            strHTML.Append("<td   align='left' colspan='13'><b>" + strRecordType + "</b></td>");
                            strHTML.Append("<td   align='left'><b>TOTAL</b></td>");
                        }
                        else
                            strHTML.Append("<td   align='left' " + ((drReport.Length > 1) ? "colspan='14'" : "") + "><b>" + strRecordType + "</b></td>");

                        if (drReport.Length > 1) strHTML.Append("</tr>");

                        for (int j = 0; j < drReport.Length; j++)
                        {
                            DataRow drRecords = drReport[j];
                            if (drReport.Length > 1)
                            {
                                strHTML.Append("<tr align='left' >");
                                strHTML.Append("<td  align='left'>" + Convert.ToString(drRecords["Description"]) + "</td>");
                            }
                            //strHTML.Append("<tr align='left' >");
                            strHTML.Append("<td  align='left'>" + string.Format(Convert.ToBoolean(drRecords["ShowDecimalPoint"]) == true ? "{0:N1}" : "{0:N0}", drRecords["JAN"]) + "</td>");
                            strHTML.Append("<td  align='left'>" + string.Format(Convert.ToBoolean(drRecords["ShowDecimalPoint"]) == true ? "{0:N1}" : "{0:N0}", drRecords["FEB"]) + "</td>");
                            strHTML.Append("<td  align='left'>" + string.Format(Convert.ToBoolean(drRecords["ShowDecimalPoint"]) == true ? "{0:N1}" : "{0:N0}", drRecords["MAR"]) + "</td>");
                            strHTML.Append("<td  align='left'>" + string.Format(Convert.ToBoolean(drRecords["ShowDecimalPoint"]) == true ? "{0:N1}" : "{0:N0}", drRecords["APR"]) + "</td>");
                            strHTML.Append("<td  align='left'>" + string.Format(Convert.ToBoolean(drRecords["ShowDecimalPoint"]) == true ? "{0:N1}" : "{0:N0}", drRecords["MAY"]) + "</td>");
                            strHTML.Append("<td  align='left'>" + string.Format(Convert.ToBoolean(drRecords["ShowDecimalPoint"]) == true ? "{0:N1}" : "{0:N0}", drRecords["JUN"]) + "</td>");
                            strHTML.Append("<td  align='left'>" + string.Format(Convert.ToBoolean(drRecords["ShowDecimalPoint"]) == true ? "{0:N1}" : "{0:N0}", drRecords["JUL"]) + "</td>");
                            strHTML.Append("<td  align='left'>" + string.Format(Convert.ToBoolean(drRecords["ShowDecimalPoint"]) == true ? "{0:N1}" : "{0:N0}", drRecords["AUG"]) + "</td>");
                            strHTML.Append("<td  align='left'>" + string.Format(Convert.ToBoolean(drRecords["ShowDecimalPoint"]) == true ? "{0:N1}" : "{0:N0}", drRecords["SEP"]) + "</td>");
                            strHTML.Append("<td  align='left'>" + string.Format(Convert.ToBoolean(drRecords["ShowDecimalPoint"]) == true ? "{0:N1}" : "{0:N0}", drRecords["OCT"]) + "</td>");
                            strHTML.Append("<td  align='left'>" + string.Format(Convert.ToBoolean(drRecords["ShowDecimalPoint"]) == true ? "{0:N1}" : "{0:N0}", drRecords["NOV"]) + "</td>");
                            strHTML.Append("<td  align='left'>" + string.Format(Convert.ToBoolean(drRecords["ShowDecimalPoint"]) == true ? "{0:N1}" : "{0:N0}", drRecords["DEC"]) + "</td>");

                            if (strRecordType == "Incidents Closed in Month Received")
                                strHTML.Append("<td  align='left'><b>AVG</b></td>");
                            else
                                strHTML.Append("<td  align='left'>" + string.Format(Convert.ToBoolean(drRecords["ShowDecimalPoint"]) == true ? "{0:N1}" : "{0:N0}", drRecords["Total"]) + "</td>");

                            strHTML.Append("</tr>");
                        }
                        if (i < dtRecordType.Rows.Count - 1)
                            strHTML.Append("<tr align='left'><td colspan='14'>&nbsp;</td></tr>");
                    }

                    //strHTML.Append("<tr><td colspan='14' >&nbsp;</td></tr>");
                    strHTML.Append("</table>");
                    strHTML.Append("</td></tr></table>");
                }
                else
                {
                    // if record not found then hide Header and set width and height so scroll bar not visible.            
                    strHTML.Append("<table style='font-family:Tahoma' cellpadding='4' cellspacing='0' Width='100%' border='1'>");
                    strHTML.Append("<tr>");
                    strHTML.Append("<td align='center' >No Records found.</td></tr></table>");
                }
                #endregion

                //Write HTML in to HtmlWriter
                htmlWrite.WriteLine(strHTML.ToString());
                //Send Mail
                isGrid = true;
                SendMail("Customer Relations Incident Summary Report", "CustomerRelationsIncidentSummaryReport.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
                isGrid = false;
            }
        }

        // Report 45
        private void BindNonCustomerInquirySummaryReport(DataRow drReportSchedule)
        {
            decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
            decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
            decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

            //Get Report criteria for the scheduled report
            DataTable dtFilter = Report.SelectFilterCriteria(45, pK_Schedule_ID).Tables[0];
            if (dtFilter.Rows.Count > 0)
            {
                //Get the recipient from the recipient list 
                DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                //Get the user who has scheduled the report
                DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                String strFirstName, strLastName, strMailFrom;
                strFirstName = strLastName = strMailFrom = "";
                if (dtUser.Rows.Count > 0)
                {
                    strFirstName = Convert.ToString(dtUser.Rows[0]["FIRST_NAME"]).Trim();
                    strLastName = Convert.ToString(dtUser.Rows[0]["LAST_NAME"]).Trim();
                    strMailFrom = Convert.ToString(dtUser.Rows[0]["Email"]).Trim();
                }

                string strFK_LU_Locations = Convert.ToString(dtFilter.Rows[0]["FK_LU_LocationIDs"]).Trim();
                string strYear = Convert.ToString(dtFilter.Rows[0]["Year"]);

                //Create HTML for the report and wirte into HTML Write object
                StringBuilder strHTML = new StringBuilder();
                System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                #region "Report Title"

                //Add Report Title and Schedule Date
                strHTML.Append("<table><tr><td colspan='14'>");

                strHTML.Append("<br />");
                strHTML.Append("<b>Report Title : Non-Customer Inquiry Summary </b>");
                strHTML.Append("<br /><br />");
                strHTML.Append("Schedule Start Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                strHTML.Append("<br />");
                strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"].ToString());
                strHTML.Append("<br />");
                strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                //Add Report Filter Criteria 
                strHTML.Append("<br /><br />");
                strHTML.Append("<b>Report Filters </b>");
                strHTML.Append("<br />");
                strHTML.Append("Year : " + strYear);
                strHTML.Append("<br />");
                strHTML.Append("Location D/B/A : " + Report.GetCommaSepratedDBAFromIDs(strFK_LU_Locations));
                strHTML.Append("<br /><br />");
                strHTML.Append("</td></tr></table>");

                #endregion

                #region "Report Data"

                DataSet dsReport = Report.GetNonCustomerInquiryData(Convert.ToInt32(strYear), Convert.ToString(dtFilter.Rows[0]["FK_LU_LocationIDs"]));

                DataTable dtRecordType = dsReport.Tables[0];
                DataTable dtReport = dsReport.Tables[1];

                // Check if record found or not.
                if (dtReport.Rows.Count > 0)
                {
                    strHTML.Append("<table border='1'  cellpadding='0' cellspacing='0'  Width='100%px'><tr><td  >");
                    strHTML.Append("<table cellpadding='4' cellspacing='0' Width='100%' border='1'>");//Sub Table
                    strHTML.Append("<tr style='font-weight: bold;'>"); //Title
                    strHTML.Append("<td align='center' colspan='14' ><b> Non-Customer Inquiry Summary Report for " + strYear + " </b></td>");
                    strHTML.Append("</tr>");

                    strHTML.Append("<tr align='left'  style='font-weight: bold;'>");
                    strHTML.Append("<td  width='100px'>&nbsp;</td>");
                    strHTML.Append("<td  width='56px' align='left'>JAN</td>");
                    strHTML.Append("<td  width='56px' align='left'>FEB</td>");
                    strHTML.Append("<td  width='56px' align='left'>MAR</td>");
                    strHTML.Append("<td  width='56px' align='left'>APR</td>");
                    strHTML.Append("<td  width='56px' align='left'>MAY</td>");
                    strHTML.Append("<td  width='56px' align='left'>JUN</td>");
                    strHTML.Append("<td  width='56px' align='left'>JUL</td>");
                    strHTML.Append("<td  width='56px' align='left'>AUG</td>");
                    strHTML.Append("<td  width='56px' align='left'>SEP</td>");
                    strHTML.Append("<td  width='56px' align='left'>OCT</td>");
                    strHTML.Append("<td  width='56px' align='left'>NOV</td>");
                    strHTML.Append("<td  width='56px' align='left'>DEC</td>");
                    strHTML.Append("<td  width='56px' align='left'>Total</td>");
                    strHTML.Append("</tr>");


                    for (int i = 0; i < dtRecordType.Rows.Count; i++)
                    {
                        string strRecordType = Convert.ToString(dtRecordType.Rows[i]["Type"]);
                        DataRow[] drReport = dtReport.Select("Type = '" + strRecordType + "'");

                        strHTML.Append("<tr align='left'>");
                        strHTML.Append("<td align='left' " + ((drReport.Length > 1) ? "colspan='14'" : "") + "><b>" + strRecordType + "</b></td>");

                        if (drReport.Length > 1) strHTML.Append("</tr>");

                        for (int j = 0; j < drReport.Length; j++)
                        {
                            DataRow drRecords = drReport[j];
                            if (drReport.Length > 1)
                            {
                                strHTML.Append("<tr align='left'>");
                                strHTML.Append("<td  align='left'>" + Convert.ToString(drRecords["Description"]) + "</td>");
                            }

                            strHTML.Append("<td  align='left'>" + string.Format("{0:N0}", drRecords["JAN"]) + "</td>");
                            strHTML.Append("<td  align='left'>" + string.Format("{0:N0}", drRecords["FEB"]) + "</td>");
                            strHTML.Append("<td  align='left'>" + string.Format("{0:N0}", drRecords["MAR"]) + "</td>");
                            strHTML.Append("<td  align='left'>" + string.Format("{0:N0}", drRecords["APR"]) + "</td>");
                            strHTML.Append("<td  align='left'>" + string.Format("{0:N0}", drRecords["MAY"]) + "</td>");
                            strHTML.Append("<td  align='left'>" + string.Format("{0:N0}", drRecords["JUN"]) + "</td>");
                            strHTML.Append("<td  align='left'>" + string.Format("{0:N0}", drRecords["JUL"]) + "</td>");
                            strHTML.Append("<td  align='left'>" + string.Format("{0:N0}", drRecords["AUG"]) + "</td>");
                            strHTML.Append("<td  align='left'>" + string.Format("{0:N0}", drRecords["SEP"]) + "</td>");
                            strHTML.Append("<td  align='left'>" + string.Format("{0:N0}", drRecords["OCT"]) + "</td>");
                            strHTML.Append("<td  align='left'>" + string.Format("{0:N0}", drRecords["NOV"]) + "</td>");
                            strHTML.Append("<td  align='left'>" + string.Format("{0:N0}", drRecords["DEC"]) + "</td>");
                            strHTML.Append("<td  align='left'>" + string.Format("{0:N0}", drRecords["Total"]) + "</td>");

                            strHTML.Append("</tr>");
                        }

                        if (i < dtRecordType.Rows.Count - 1)
                            strHTML.Append("<tr align='left'><td colspan='14'>&nbsp;</td></tr>");
                    }

                    //strHTML.Append("<tr><td colspan='14' >&nbsp;</td></tr>");
                    strHTML.Append("</table></td></tr>");
                    strHTML.Append("</table>");
                }
                else
                {
                    // if record not found then hide Header and set width and height so scroll bar not visible.            
                    strHTML.Append("<table cellpadding='4' cellspacing='0' Width='100%' border='1'>");
                    strHTML.Append("<tr>");
                    strHTML.Append("<td align='center'>No Records found.</td></tr></table>");
                }
                #endregion

                //Write HTML in to HtmlWriter
                htmlWrite.WriteLine(strHTML.ToString());
                //Send Mail
                isGrid = true;
                SendMail("Non-Customer Inquiry Summary", "NonCustomerInquirySummary.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
                isGrid = false;
            }
        }

        // Report 46
        private void BindCustomerIncidentTotalsReport(DataRow drReportSchedule)
        {
            decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
            decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
            decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

            //Get Report criteria for the scheduled report
            DataTable dtFilter = Report.SelectFilterCriteria(46, pK_Schedule_ID).Tables[0];
            if (dtFilter.Rows.Count > 0)
            {
                //Get the recipient from the recipient list 
                DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                //Get the user who has scheduled the report
                DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                String strFirstName, strLastName, strMailFrom;
                strFirstName = strLastName = strMailFrom = "";
                if (dtUser.Rows.Count > 0)
                {
                    strFirstName = Convert.ToString(dtUser.Rows[0]["FIRST_NAME"]).Trim();
                    strLastName = Convert.ToString(dtUser.Rows[0]["LAST_NAME"]).Trim();
                    strMailFrom = Convert.ToString(dtUser.Rows[0]["Email"]).Trim();
                }

                string strFK_LU_Locations = Convert.ToString(dtFilter.Rows[0]["FK_LU_LocationIDs"]).Trim();
                DateTime dtBegin = Convert.ToDateTime(dtFilter.Rows[0]["Begin_Date"]);
                DateTime dtEnd = Convert.ToDateTime(dtFilter.Rows[0]["End_Date"]);

                //Create HTML for the report and wirte into HTML Write object
                StringBuilder strHTML = new StringBuilder();
                System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                #region "Report Title"

                //Add Report Title and Schedule Date
                strHTML.Append("<table><tr><td colspan='7'>");
                strHTML.Append("<br />");
                strHTML.Append("<b>Report Title : Customer Relationship Incident Totals by Dealership </b>");
                strHTML.Append("<br /><br />");
                strHTML.Append("Schedule Start Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                strHTML.Append("<br />");
                strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"].ToString());
                strHTML.Append("<br />");
                strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                //Add Report Filter Criteria 
                strHTML.Append("<br /><br />");
                strHTML.Append("<b>Report Filters </b>");
                strHTML.Append("<br />");
                strHTML.Append("Time Period Begin : " + FormatDateToDisplay(dtBegin));
                strHTML.Append("<br />");
                strHTML.Append("Time Period End : " + FormatDateToDisplay(dtEnd));
                strHTML.Append("<br />");
                strHTML.Append("Location D/B/A : " + Report.GetCommaSepratedDBAFromIDs(strFK_LU_Locations));
                strHTML.Append("<br /><br />");
                strHTML.Append("</td></tr></table>");

                #endregion

                #region "Report Data"

                DataSet dsReport = Report.GetIncidentTotalsByDealership(dtBegin, dtEnd, Convert.ToString(dtFilter.Rows[0]["FK_LU_LocationIDs"]));

                DataTable dtReport = dsReport.Tables[0];
                dtReport.Columns.Add(new DataColumn("Total", typeof(int)));

                for (int i = 0; i < dtReport.Rows.Count; i++)
                {
                    decimal? decTotal = 0;

                    for (int j = 1; j < dtReport.Columns.Count - 1; j++)
                    {
                        decTotal = decTotal + Convert.ToDecimal(dtReport.Rows[i][j]);
                    }
                    dtReport.Rows[i]["Total"] = decTotal;
                }

                int intColspan = dtReport.Columns.Count;

                // Check if record found or not.
                if (dtReport.Rows.Count > 0)
                {
                    strHTML.Append("<table border='1' cellpadding='0' cellspacing='0'  Width='100%px'><tr><td >");
                    strHTML.Append("<table cellpadding='4' cellspacing='0' Width='100%' border='1'>");//Sub Table
                    strHTML.Append("<tr style='font-weight: bold;'>"); //Title
                    strHTML.Append("<td align='center' colspan='" + intColspan.ToString() + "' ><b> Customer Relationship Incident Totals by Dealership Report for " + FormatDateToDisplay(dtBegin) + " To " + FormatDateToDisplay(dtEnd) + " </b></td>");
                    strHTML.Append("</tr>");

                    strHTML.Append("<tr style='font-weight: bold;'>");
                    strHTML.Append("<td width='230px'>Location D/B/A</td>");
                    for (int j = 1; j < dtReport.Columns.Count; j++)
                    {
                        strHTML.Append("<td width='120px' align='left'>" + dtReport.Columns[j].ColumnName + "</td>");
                    }
                    strHTML.Append("</tr>");


                    for (int i = 0; i < dtReport.Rows.Count; i++)
                    {
                        strHTML.Append("<tr>");

                        DataRow drRecords = dtReport.Rows[i];

                        for (int j = 0; j < dtReport.Columns.Count; j++)
                        {
                            if (j == 0)
                                strHTML.Append("<td align='left'>" + Convert.ToString(drRecords["DBA"]) + "</td>");
                            else
                                strHTML.Append("<td align='left'>" + string.Format("{0:N0}", drRecords[j]) + "</td>");
                        }
                        strHTML.Append("</tr>");
                    }

                    //strHTML.Append("<tr><td colspan='14' class='cols_'>&nbsp;</td></tr>");
                    strHTML.Append("</table>");
                    strHTML.Append("</td></tr></table>");
                }
                else
                {
                    // if record not found then hide Header and set width and height so scroll bar not visible.            
                    strHTML.Append("<table cellpadding='4' cellspacing='0' Width='100%' border='1'>");
                    strHTML.Append("<tr>");
                    strHTML.Append("<td align='center'>No Records found.</td></tr></table>");
                }
                #endregion

                //Write HTML in to HtmlWriter
                htmlWrite.WriteLine(strHTML.ToString());
                //Send Mail
                SendMail("Customer Relationship Incident Totals by Dealership", "CustomerIncidentTotalsbyDealership.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
            }
        }

        // Report 47, 48, 49, 50
        private void BindDashboardReport(DashboardReport objRptDashboard, DataRow drReportSchedule, int intReportID)
        {
            decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
            decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
            decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);


            //Get Report criteria for the scheduled report
            DataTable dtFilter = Report.SelectFilterCriteria(intReportID, pK_Schedule_ID).Tables[0];
            if (dtFilter.Rows.Count > 0)
            {
                //Get the recipient from the recipient list 
                DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                //Get the user who has scheduled the report
                DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                String strFirstName, strLastName, strMailFrom;
                strFirstName = strLastName = strMailFrom = "";
                if (dtUser.Rows.Count > 0)
                {
                    strFirstName = Convert.ToString(dtUser.Rows[0]["FIRST_NAME"]).Trim();
                    strLastName = Convert.ToString(dtUser.Rows[0]["LAST_NAME"]).Trim();
                    strMailFrom = Convert.ToString(dtUser.Rows[0]["Email"]).Trim();
                }

                //Create HTML for the report and wirte into HTML Write object
                StringBuilder strHTML = new StringBuilder();

                // get report text as per the report type
                strHTML.Append(GetDashboardReportText(drReportSchedule, dtFilter, FK_Security_Id, objRptDashboard));

                System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);
                //Write HTML in to HtmlWriter
                htmlWrite.WriteLine(strHTML.ToString());


                string strReportTitle = "";
                string strXLSFileName = "";

                if (objRptDashboard == DashboardReport.Facility_Inspection)
                {
                    strReportTitle = "EHS Inspection Report"; strXLSFileName = "FacilityInspectionReport.xls";
                }
                else if (objRptDashboard == DashboardReport.Incident_Investigation)
                {
                    strReportTitle = "Incident Investigation Report"; strXLSFileName = "IncidentInvestigationReport.xls";
                }
                else if (objRptDashboard == DashboardReport.Incident_Reduction)
                {
                    strReportTitle = "Incident Reduction Report"; strXLSFileName = "IncidentReductionReport.xls";
                }
                else if (objRptDashboard == DashboardReport.WC_Claim_Management)
                {
                    strReportTitle = "Worker's Compensation Claims Management"; strXLSFileName = "WCClaimsManagement.xls";
                }
                //Send Mail
                SendMail(strReportTitle, strXLSFileName, strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
            }
        }

        //Report 51
        private void BindCriticalDatesReport(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(51, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list 
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                    String strFirstName, strLastName, strMailFrom, strStatus;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = Convert.ToString(dtUser.Rows[0]["FIRST_NAME"]).Trim();
                        strLastName = Convert.ToString(dtUser.Rows[0]["LAST_NAME"]).Trim();
                        strMailFrom = Convert.ToString(dtUser.Rows[0]["Email"]).Trim();

                        //Set all filters to a variable as per report type
                        DateTime? dtLCDFrom = null, dtLCDTo = null, dtLEDFrom = null, dtLEDTo = null;

                        string strRegion = Convert.ToString(dtFilter.Rows[0]["Region"]).Trim();
                        string strMarket = null;
                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Market"])))
                        {
                            strMarket = Convert.ToString(dtFilter.Rows[0]["Market"]).Trim();
                        }
                        string strLeaseType = Convert.ToString(dtFilter.Rows[0]["LeaseType"]).Trim();
                        strStatus = Convert.ToString(dtFilter.Rows[0]["Status"]).Trim();

                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["LCDFrom_Date"])))
                            dtLCDFrom = Convert.ToDateTime(dtFilter.Rows[0]["LCDFrom_Date"]);

                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["LCDTo_Date"])))
                            dtLCDTo = Convert.ToDateTime(dtFilter.Rows[0]["LCDTo_Date"]);

                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["LEDFrom_Date"])))
                            dtLEDFrom = Convert.ToDateTime(dtFilter.Rows[0]["LEDFrom_Date"]);

                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["LEDTo_Date"])))
                            dtLEDTo = Convert.ToDateTime(dtFilter.Rows[0]["LEDTo_Date"]);


                        //Create HTML for the report and wirte into HTML Write object
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        #region "Search Criteria"

                        //Retrieve Market Values
                        string strMarketString = string.Empty;
                        if (string.IsNullOrEmpty(strMarket))
                        {
                            strMarketString = "All Market";
                        }
                        else
                        {
                            string[] strMar = strMarket.Split(Convert.ToChar(","));
                            for (int i = 0; i < strMar.Length; i++)
                            {
                                strMarketString += Report.SelectMarketInfoById(Convert.ToDecimal(strMar[i].ToString())).Tables[0].Rows[0]["Market"].ToString() + ",";
                            }
                            strMarketString = strMarketString.TrimEnd(',');
                        }

                        //Add Report Title and Schedule Date
                        strHTML.Append("<table><tr><td colspan='8'>");
                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : Critical Dates Report</b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"].ToString());
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        //Add Report Filter Criteria 
                        strHTML.Append("<br /><br />");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Region        : " + strRegion.Replace("'", ""));
                        strHTML.Append("<br />");
                        strHTML.Append("Market        : " + strMarketString);
                        strHTML.Append("<br /><br />");
                        strHTML.Append("LCD From      : " + FormatDBNullDateToDisplay(dtLCDFrom));
                        strHTML.Append("<br />");
                        strHTML.Append("LCD To        : " + FormatDBNullDateToDisplay(dtLCDTo));
                        strHTML.Append("<br />");
                        strHTML.Append("LED From      : " + FormatDBNullDateToDisplay(dtLEDFrom));
                        strHTML.Append("<br />");
                        strHTML.Append("LED To        : " + FormatDBNullDateToDisplay(dtLEDTo));
                        strHTML.Append("<br />");
                        strHTML.Append("Building Status        : " + strStatus.Replace("'", ""));
                        strHTML.Append("<br /><br />");
                        strHTML.Append("</td></tr></table>");

                        #endregion

                        #region "Grid Data"

                        strHTML.Append("<table cellspacing='0' cellpadding='0' align='Left' border='1' style='width: 1340px; border-collapse: collapse;'>");
                        //Header Row
                        //strHTML.Append("<tr align='left'><td align='left'>");
                        //strHTML.Append("<table width='1625px' cellpadding='0' cellspacing='0' border='0'>");
                        strHTML.Append("<tr><td align='left'>");
                        strHTML.Append("<table width='1625px' cellpadding='0' cellspacing='0' border='1' style='font-weight: bold;'>");
                        strHTML.Append("<tr style='font-weight: bold;'>");
                        strHTML.Append("<td align='left' colspan='2'>Sonic Automotive</td>");
                        strHTML.Append("<td align='center' colspan='3'>Critical Dates Report</td>");
                        strHTML.Append("<td align='right' colspan='4'>" + FormatDBNullDateToDisplay(DateTime.Now) + " </td>");
                        strHTML.Append("</tr>");
                        strHTML.Append("</table></td></tr>");

                        strHTML.Append("<tr style='font-weight: bold;'>");
                        strHTML.Append("<td><table border='1'><tr style='font-weight: bold;'>");

                        strHTML.Append("<td align='left' style='width: 100px'>LED</td>");
                        strHTML.Append("<td align='left' style='width: 180px'>Location</td>");
                        strHTML.Append("<td align='left' style='width: 560px'>");
                        strHTML.Append("<table width='100%' cellpadding='0' cellspacing='0' border='1' style='font-weight: bold;'>");
                        strHTML.Append("<tr style='font-weight: bold;'>");
                        strHTML.Append("<td align='left' style='width: 40%'>Building Address</td>");
                        strHTML.Append("<td align='left' style='width: 30%'>Building Number</td>");
                        strHTML.Append("<td align='left' style='width: 30%'>Building Landlord Name</td>");
                        strHTML.Append("</tr>");
                        strHTML.Append("</table>");
                        strHTML.Append("</td>");
                        strHTML.Append("<td align='left' style='width: 100px'>LCD</td>");
                        strHTML.Append("<td align='left' style='width: 100px'>LL Notify Date</td>");
                        strHTML.Append("<td align='left' style='width: 100px'>Reminder Date</td>");
                        strHTML.Append("<td align='left' style='width: 100px'>Review Date</td>");
                        strHTML.Append("<td align='right' style='width: 100px'>Monthly Rent</td>");
                        strHTML.Append("<td align='left' style='width: 180px'>Renewals</td>");
                        strHTML.Append("</tr>");
                        strHTML.Append("</table>");
                        strHTML.Append("</td></tr>");

                        //strHTML.Append("</table>");
                        //strHTML.Append("</td></tr>");


                        //get the all Employee records by search criteria by group
                        DataSet dsDetails = Report.GetCriticalDatesReport(strRegion, strMarket, dtLCDFrom, dtLCDTo, dtLEDFrom, dtLEDTo, strStatus, "CriticalDates");

                        if (dsDetails != null && dsDetails.Tables.Count > 0 && dsDetails.Tables[0].Rows.Count > 0)
                        {
                            DataTable dtLocation = dsDetails.Tables[0];
                            DataTable dtDetails = dsDetails.Tables[0];

                            //strHTML.Append("<tr align='left'><td align='left'>");
                            //strHTML.Append("<table width='1625px' cellpadding='0' cellspacing='0' border='0'>");
                            //strHTML.Append("<tr><td align='left'>");
                            //strHTML.Append("<table cellspacing='0' cellpadding='0' align='Left' border='1' style='width: 100%; border-collapse: collapse;'>");

                            //foreach (DataRow dr in dtLocation.Rows)
                            //{
                            // DataRow[] drDetails = dtDetails.Select("DBA='" + dr["DBA"] + "'");
                            foreach (DataRow drDetail in dtLocation.Rows)
                            {
                                strHTML.Append("<tr><td>");
                                strHTML.Append("<table cellpadding='4' cellspacing='0' border='1'>");
                                strHTML.Append("<tr>");
                                strHTML.Append("<td valign='top' align='left' style='width: 100px'>" + FormatDBNullDateToDisplay(drDetail["LED"]) + "</td>");
                                strHTML.Append("<td align='left' valign=top>" + Convert.ToString(drDetail["DBA"]) + "</td>");
                                strHTML.Append("<td valign='top' align='left' style='width: 560px'>");
                                decimal _PK_RE_Information = Convert.ToDecimal(drDetail["PK_RE_Information"]);
                                DataTable dtBuilding = Report.SelectByFK_RE_Information(_PK_RE_Information).Tables[0];
                                if (dtBuilding.Rows.Count > 0)
                                {
                                    strHTML.Append("<table cellspacing='0' cellpadding='0' align='Left' border='1' style='width: 100%; border-collapse: collapse;'>");
                                    foreach (DataRow drBuilding in dtBuilding.Rows)
                                    {
                                        strHTML.Append("<tr>");
                                        strHTML.Append("<td align='left' valign='top' style='width:40%'>" + (drBuilding["Address"]) + "</td>");
                                        strHTML.Append("<td align='left' valign='top' style='width:30%'>" + Convert.ToString(drBuilding["Building_Number"]) + "</td>");
                                        strHTML.Append("<td align='left' valign='top' style='width:30%'>" + Convert.ToString(drBuilding["Landlord_Name"]) + "</td>");
                                        strHTML.Append("</tr>");
                                    }
                                    strHTML.Append("</table>");
                                }
                                else
                                {
                                    strHTML.Append("<table cellspacing='0' cellpadding='0' align='Left' border='1' style='width: 100%; border-collapse: collapse;'>");
                                    strHTML.Append("<tr>");
                                    strHTML.Append("<td align='left' valign='top' style='width:40%'>" + "" + "</td>");
                                    strHTML.Append("<td align='left' valign='top' style='width:30%'>" + "" + "</td>");
                                    strHTML.Append("<td align='left' valign='top' style='width:30%'>" + "" + "</td>");
                                    strHTML.Append("</tr>");
                                    strHTML.Append("</table>");
                                }

                                strHTML.Append("</td>");
                                strHTML.Append("<td valign='top' align='left' style='width: 100px'>" + FormatDBNullDateToDisplay(drDetail["LCD"]) + "</td>");
                                strHTML.Append("<td valign='top' align='left' style='width: 100px'>" + FormatDBNullDateToDisplay(drDetail["LLNotifyDate"]) + "</td>");
                                strHTML.Append("<td valign='top' align='left' style='width: 100px'>" + FormatDBNullDateToDisplay(drDetail["ReminderDate"]) + "</td>");
                                strHTML.Append("<td valign='top' align='left' style='width: 100px'>" + FormatDBNullDateToDisplay(drDetail["ReviewDate"]) + "</td>");
                                strHTML.Append("<td valign='top' align='right' style='width: 100px'>" + string.Format("{0:N2}", drDetail["MonthlyRent"] != DBNull.Value ? Convert.ToDecimal(drDetail["MonthlyRent"]) : 0) + "</td>");
                                strHTML.Append("<td valign='top' align='left' style='width: 180px'>" + Convert.ToString(drDetail["Renewals"]) + "</td>");


                                strHTML.Append(" </tr>");
                                strHTML.Append(" </table>");
                                strHTML.Append("</td></tr>");
                            }
                            //}
                            //strHTML.Append("</table>");
                            //strHTML.Append("</td></tr>");
                            //strHTML.Append("</table>");
                            //strHTML.Append("</td></tr>");

                            //Footer Row
                            strHTML.Append("<tr align='left'><td align='left'>");
                            strHTML.Append(" <table width='1625px' cellpadding='0' cellspacing='0' border='0'>");
                            //strHTML.Append("<tr><td align='left'>");
                            strHTML.Append("<tr><td>");
                            strHTML.Append("<table width='1625px' cellpadding='4' cellspacing='0' border='1' style='font-weight: bold;background-color: #507CD1; color: White;'>");
                            strHTML.Append("<tr style='font-weight: bold;color: White;'>");
                            strHTML.Append("<td align='left' style='width: 100px'>Report Grand Totals</td>");
                            strHTML.Append("<td align='left' style='width: 180px'>" + Convert.ToString(dtDetails.Rows.Count) + " </td>");
                            strHTML.Append("<td align='left' colspan='3' style='width: 560px'>&nbsp;</td>");
                            //strHTML.Append("<td align='left' style='width: 100px'>&nbsp;</td>");
                            //strHTML.Append("<td align='left' style='width: 100px'>&nbsp;</td>");
                            strHTML.Append("<td align='left' style='width: 100px'>&nbsp;</td>");
                            strHTML.Append("<td align='left' style='width: 100px'>&nbsp;</td>");
                            strHTML.Append("<td align='left' style='width: 100px'>&nbsp;</td>");
                            strHTML.Append("<td align='left' style='width: 100px'>&nbsp;</td>");
                            strHTML.Append("<td align='right' style='width: 100px'>" + string.Format("{0:N2}", dtDetails.Compute("sum(MonthlyRent)", "")) + "</td>");
                            strHTML.Append("<td align='left' style='width: 180px'>&nbsp;</td>");
                            strHTML.Append(" </tr>");

                            strHTML.Append("</table>");
                            strHTML.Append("</td></tr>");
                            strHTML.Append("</td></tr>");
                            strHTML.Append("</table>");
                            //strHTML.Append("</td></tr>");
                        }
                        else
                        {
                            strHTML.Append("<tr> <td style='font-weight: bold;'> No Record Found.");
                            strHTML.Append("</td></tr>");
                        }

                        strHTML.Append("</table>");
                        #endregion

                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        SendMail("Critical Dates Report", "CriticalDates.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in Critical Dates Report, " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
        }

        //Report 52
        private void BindSubLeaseReport(DataRow drReportSchedule)
        {
            decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
            decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
            decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

            //Get Report criteria for the scheduled report
            DataTable dtFilter = Report.SelectFilterCriteria(52, pK_Schedule_ID).Tables[0];
            if (dtFilter.Rows.Count > 0)
            {
                //Get the recipient from the recipient list 
                DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                //Get the user who has scheduled the report
                DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                String strFirstName, strLastName, strMailFrom;
                strFirstName = strLastName = strMailFrom = "";
                if (dtUser.Rows.Count > 0)
                {
                    strFirstName = Convert.ToString(dtUser.Rows[0]["FIRST_NAME"]).Trim();
                    strLastName = Convert.ToString(dtUser.Rows[0]["LAST_NAME"]).Trim();
                    strMailFrom = Convert.ToString(dtUser.Rows[0]["Email"]).Trim();
                }
                string strRegion = Convert.ToString(dtFilter.Rows[0]["Location"]).Trim();
                string strMarket = null;
                if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Market"])))
                {
                    strMarket = Convert.ToString(dtFilter.Rows[0]["Market"]).Trim();
                }
                string strStatus = Convert.ToString(dtFilter.Rows[0]["Status"]).Trim();
                //Set all filters to a variable as per report type
                DateTime? dtLCDFrom = null, dtLCDTo = null, dtLEDFrom = null, dtLEDTo = null;

                if (dtFilter.Rows[0]["LCDFrom_Date"] != DBNull.Value)
                    dtLCDFrom = Convert.ToDateTime(dtFilter.Rows[0]["LCDFrom_Date"]);

                if (Convert.ToString(dtFilter.Rows[0]["LCDTo_Date"]) != string.Empty && dtFilter.Rows[0]["LCDTo_Date"] != DBNull.Value)
                    dtLCDTo = Convert.ToDateTime(dtFilter.Rows[0]["LCDTo_Date"]);

                if (Convert.ToString(dtFilter.Rows[0]["LEDFrom_Date"]) != string.Empty && dtFilter.Rows[0]["LEDFrom_Date"] != DBNull.Value)
                    dtLEDFrom = Convert.ToDateTime(dtFilter.Rows[0]["LEDFrom_Date"]);

                if (Convert.ToString(dtFilter.Rows[0]["LEDTo_Date"]) != string.Empty && dtFilter.Rows[0]["LEDTo_Date"] != DBNull.Value)
                    dtLEDTo = Convert.ToDateTime(dtFilter.Rows[0]["LEDTo_Date"]);

                DataSet dsResult = Report.GetSubLeaseReport(strRegion, strMarket, dtLCDFrom, dtLCDTo, dtLEDFrom, dtLEDTo, FK_Security_Id, strStatus);


                //Create HTML for the report and wirte into HTML Write object
                StringBuilder strHTML = new StringBuilder();
                System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                #region "Report Title"

                //Retrieve Market Values
                string strMarketString = string.Empty;
                if (string.IsNullOrEmpty(strMarket))
                {
                    strMarketString = "All Market";
                }
                else
                {
                    string[] strMar = strMarket.Split(Convert.ToChar(","));
                    for (int i = 0; i < strMar.Length; i++)
                    {
                        strMarketString += Report.SelectMarketInfoById(Convert.ToDecimal(strMar[i].ToString())).Tables[0].Rows[0]["Market"].ToString() + ",";
                    }
                    strMarketString = strMarketString.TrimEnd(',');
                }

                //Add Report Title and Schedule Date
                strHTML.Append("<table> <tr> <td colspan='8'>");
                strHTML.Append("<br />");
                strHTML.Append("<b>Report Title : Sublease Report</b>");
                strHTML.Append("<br /><br />");
                strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                strHTML.Append("<br />");
                strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"].ToString());
                strHTML.Append("<br />");
                strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                //Add Report Filter Criteria 
                strHTML.Append("<br /><br />");
                strHTML.Append("<b>Report Filters </b>");
                strHTML.Append("<br />");
                strHTML.Append("Region : " + (string.IsNullOrEmpty(strRegion) ? "" : strRegion.Replace("'", "")));
                // strHTML.Append("Location DBA   : " + strRegion);
                //strHTML.Append("</td> </tr>");
                strHTML.Append("<br />");
                strHTML.Append("Market        : " + strMarketString);
                //strHTML.Append("</td> </tr>");
                strHTML.Append("<br />");
                strHTML.Append("LCD From      : " + FormatDBNullDateToDisplay(dtLCDFrom));
                strHTML.Append("<br />");
                strHTML.Append("LCD To        : " + FormatDBNullDateToDisplay(dtLCDTo));
                strHTML.Append("<br />");
                strHTML.Append("LED From      : " + FormatDBNullDateToDisplay(dtLEDFrom));
                strHTML.Append("<br />");
                strHTML.Append("LED To        : " + FormatDBNullDateToDisplay(dtLEDTo));
                strHTML.Append("<br />");
                strHTML.Append("Building Status        : " + strStatus.Replace("'", ""));
                strHTML.Append("<br /><br />");
                //strHTML.Append("<tr> <td colspan='8'>");
                strHTML.Append("</td></tr></table> ");


                #endregion

                #region "Report Grid header"
                //Top Header
                strHTML.Append("<table border='1'>");
                strHTML.Append("<tr style='font-weight: bold;' valign='bottom' >");
                strHTML.Append("<td align='left' colspan='2'>Sonic Automotive</td>");
                strHTML.Append("<td align='center' colspan='9'>Sublease Report</td>");
                strHTML.Append("<td align='right' colspan='3'> " + DateTime.Now.ToString() + " </td>");
                strHTML.Append("</tr>");

                //Sub Header
                strHTML.Append("<tr valign='bottom' align='left' style='font-weight: bold'>");
                strHTML.Append("<td width='150'>Location</td>");
                strHTML.Append("<td width='150'> Building Number</td>");
                strHTML.Append("<td width='160'>  Address 1</td>");
                strHTML.Append("<td width='160'>  Address 2</td>");
                strHTML.Append("<td width='150'>  City</td>");
                strHTML.Append("<td width='150'>  State</td>");
                strHTML.Append("<td width='150'>  Zip Code</td>");
                strHTML.Append("<td width='150'>Landlord Name</td>");
                strHTML.Append("<td width='150'> Sub-Lease Name</td>");
                strHTML.Append("<td width='210'>SubLease Commencement Date</td>");
                strHTML.Append("<td width='210'>SubLease Expiration Date</td>");
                strHTML.Append("<td width='210'>Sublease Notification Due Date </td>");
                strHTML.Append("<td width='150'>Monthly Sub-Rent</td>");
                strHTML.Append("<td width='150'>Renewals</td>");



                strHTML.Append("</tr>");

                //Check Whether Record Exists or Not
                if (dsResult != null && dsResult.Tables.Count > 0 && dsResult.Tables[0].Rows.Count > 0)
                {
                    foreach (DataRow dr in dsResult.Tables[0].Rows)
                    {
                        strHTML.Append("<tr valign='top' align='left'>");

                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["dba"]) + "</td>");
                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["BUILDING_NUMBER"]) + "</td>");
                        strHTML.Append("<td width='160'>" + Convert.ToString(dr["Building_Address_1"]) + "</td>");
                        strHTML.Append("<td width='160'>" + Convert.ToString(dr["Building_Address_2"]) + "</td>");
                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["Building_City"]) + "</td>");
                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["Building_State"]) + "</td>");
                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["Building_Zip"]) + "</td>");
                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["LANDLORD_NAME"]) + "</td>");
                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["SUBLEASE_NAME"]) + "</td>");
                        strHTML.Append("<td width='150'>" + FormatDBNullDateToDisplay(dr["COMMENCEMENT_DATE"]) + "</td>");
                        strHTML.Append("<td width='150'>" + FormatDBNullDateToDisplay(dr["EXPIRATION_DATE"]) + "</td>");
                        strHTML.Append("<td width='150'>" + FormatDBNullDateToDisplay(dr["Landlord_Notification_Date"]) + "</td>");
                        strHTML.Append("<td width='150'>" + Convert.ToString(String.Format("{0:C2}", dr["Subtenant_Monthly_Rent"])) + "</td>");
                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["Renew_Options"]) + "</td>");


                        strHTML.Append("</tr>");
                    }
                }
                else
                {
                    //Add No record found line for year
                    strHTML.Append("<tr><td align='left' colspan='14'>No Record Found!</td></tr>");
                }
                strHTML.Append("</table>");

                #endregion

                //Write HTML in to HtmlWriter
                htmlWrite.WriteLine(strHTML.ToString());
                //Send Mail
                SendMail("Sublease Report", "SubLeaseReport.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
            }

        }

        //Report 53
        private void BindSonicCauseCodeReclassificationReport(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(53, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list 
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = Convert.ToString(dtUser.Rows[0]["FIRST_NAME"]).Trim();
                        strLastName = Convert.ToString(dtUser.Rows[0]["LAST_NAME"]).Trim();
                        strMailFrom = Convert.ToString(dtUser.Rows[0]["Email"]).Trim();

                        DateTime? dtInjuryDateFrom = null, dtInjuryDateEnd = null;
                        string strRegion = string.Empty, strLocationStatus = string.Empty, strDBA = string.Empty, strClaimnumber = string.Empty;
                        decimal? decFirsrRepot = null, decIncidentNumber = null;


                        strRegion = Convert.ToString(dtFilter.Rows[0]["Region"]).Trim();
                        string strMarket = null;
                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Market"])))
                        {
                            strMarket = Convert.ToString(dtFilter.Rows[0]["Market"]).Trim();
                        }
                        strDBA = Convert.ToString(dtFilter.Rows[0]["Location"]).Trim();
                        strClaimnumber = Convert.ToString(dtFilter.Rows[0]["ClaimNumber"]).Trim();


                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Date_of_Injury_Begin"])))
                            dtInjuryDateFrom = Convert.ToDateTime(dtFilter.Rows[0]["Date_of_Injury_Begin"]);

                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Date_of_Injury_End"])))
                            dtInjuryDateEnd = Convert.ToDateTime(dtFilter.Rows[0]["Date_of_Injury_End"]);

                        if (dtFilter.Rows[0]["FirstReportNumber"] != DBNull.Value)
                            decFirsrRepot = Convert.ToDecimal(dtFilter.Rows[0]["FirstReportNumber"]);
                        if (dtFilter.Rows[0]["IncidentInvestigationNumber"] != DBNull.Value)
                            decIncidentNumber = Convert.ToDecimal(dtFilter.Rows[0]["IncidentInvestigationNumber"]);

                        //Create HTML for the report and wirte into HTML Write object
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        #region "Search Criteria"

                        //Retrieve Market Values
                        string strMarketString = string.Empty;
                        if (string.IsNullOrEmpty(strMarket))
                        {
                            strMarketString = "All Market";
                        }
                        else
                        {
                            string[] strMar = strMarket.Split(Convert.ToChar(","));
                            for (int i = 0; i < strMar.Length; i++)
                            {
                                strMarketString += Report.SelectMarketInfoById(Convert.ToDecimal(strMar[i].ToString())).Tables[0].Rows[0]["Market"].ToString() + ",";
                            }
                            strMarketString = strMarketString.TrimEnd(',');
                        }

                        //Add Report Title and Schedule Date
                        strHTML.Append("<table><tr><td colspan='14'>");

                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : Sonic Cause Code Reclassification Report</b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"].ToString());
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        //Add Report Filter Criteria 
                        strHTML.Append("<br /><br />");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Region        : " + strRegion.Replace("'", ""));
                        strHTML.Append("<br />");
                        strHTML.Append("Market        : " + strMarketString);
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Location : " + (string.IsNullOrEmpty(strDBA) ? "" : GetCommaValueFromTable(Report.getLocationByIds(strDBA).Tables[0], "DBA")));
                        strHTML.Append("<br />");
                        strHTML.Append("Date of Injury Begin      : " + FormatDBNullDateToDisplay(dtInjuryDateFrom));
                        strHTML.Append("<br />");
                        strHTML.Append("Date of Injury End        : " + FormatDBNullDateToDisplay(dtInjuryDateEnd));
                        strHTML.Append("<br />");
                        strHTML.Append("First Report Number       : " + decFirsrRepot);
                        strHTML.Append("<br />");
                        strHTML.Append("Incident Investigation Number        : " + decIncidentNumber);
                        strHTML.Append("<br />");
                        strHTML.Append("Claim Number        : " + strClaimnumber.Replace("'", ""));
                        strHTML.Append("<br /><br />");
                        strHTML.Append("</td></tr></table>");

                        #endregion

                        #region "Grid Data"

                        strHTML.Append("<table cellspacing='0' cellpadding='0' border='0' style='width: 2340px; border-collapse: collapse;'>");
                        //Header Row



                        strHTML.Append("<tr><td align='left'>");
                        strHTML.Append("<table width='2340px' cellpadding='0' cellspacing='0' border='0'>");
                        strHTML.Append("<tr><td align='left'>");
                        strHTML.Append("<table width='2340px' cellpadding='0' cellspacing='0' border='1' style='font-weight: bold;'>");
                        strHTML.Append("<tr style='font-weight: bold;'>");
                        strHTML.Append("<td align='left' colspan='2'>Sonic Automotive</td>");
                        strHTML.Append("<td align='center' colspan='9'>Sonic Cause Code Reclassification Report</td>");
                        strHTML.Append("<td align='right' colspan='3'>" + FormatDBNullDateToDisplay(DateTime.Now) + " </td>");
                        strHTML.Append("</tr>");

                        strHTML.Append("<tr style='font-weight: bold;'>");
                        strHTML.Append("<td align='left' style='width: 150px'>Region</td>");
                        strHTML.Append("<td align='left' style='width: 150px'>Location</td>");
                        strHTML.Append("<td align='left' style='width: 140px'>Claim Number</td>");
                        strHTML.Append("<td align='left' style='width: 150px'>First Report Number</td>");
                        strHTML.Append("<td align='left' style='width: 210px'>Incident Investigation Number</td>");
                        strHTML.Append("<td align='left' style='width: 150px'>Date of Injury</td>");
                        strHTML.Append("<td align='left' style='width: 150px'>Date Reported to Sonic</td>");
                        strHTML.Append("<td align='left' style='width: 180px'>Date Reported to SRS</td>");
                        strHTML.Append("<td align='left' style='width: 200px'>Date when SRS Closed File/Claim</td>");
                        strHTML.Append("<td align='left' style='width: 150px'>Original S0 Code</td>");
                        strHTML.Append("<td align='left' style='width: 150px'>Reclassified S-Code</td>");
                        strHTML.Append("<td align='right' style='width: 150px'>Total Incurred</td>");
                        strHTML.Append("<td align='right' style='width: 150px'>Total Paid</td>");
                        strHTML.Append("<td align='right' style='width: 150px'>Total Outstanding</td>");
                        strHTML.Append("</tr>");
                        strHTML.Append("</table>");
                        strHTML.Append("</td></tr>");
                        strHTML.Append("</table>");
                        strHTML.Append("</td></tr>");


                        DataSet dsDetails = Report.GetSonicCauseCodeReclassification_Report(strRegion, strMarket, strDBA, dtInjuryDateFrom, dtInjuryDateEnd, decFirsrRepot, decIncidentNumber, strClaimnumber);

                        if (dsDetails != null && dsDetails.Tables.Count > 0 && dsDetails.Tables[0].Rows.Count > 0)
                        {
                            DataTable dtLocation = dsDetails.Tables[0];
                            DataTable dtDetails = dsDetails.Tables[0];

                            strHTML.Append("<tr><td align='left'>");
                            strHTML.Append("<table width='2340px' cellpadding='0' cellspacing='0' border='0'>");
                            strHTML.Append("<tr><td align='left'>");
                            strHTML.Append("<table cellspacing='0' cellpadding='0' border='1' style='width: 100%; border-collapse: collapse;'>");


                            foreach (DataRow drDetail in dsDetails.Tables[0].Rows)
                            {
                                strHTML.Append("<tr>");
                                strHTML.Append("<td align='left' style='width: 150px'>" + Convert.ToString(drDetail["Region"]) + "</td>");
                                strHTML.Append("<td align='left' style='width: 150px'>" + Convert.ToString(drDetail["DBA"]) + "</td>");
                                strHTML.Append("<td align='left' style='width: 140px'>" + Convert.ToString(drDetail["Origin_Claim_Number"]) + "</td>");
                                strHTML.Append("<td align='left' style='width: 150px'>" + Convert.ToString(drDetail["WC_FR_Number"]) + "</td>");
                                strHTML.Append("<td align='left' style='width: 210px'>" + Convert.ToString(drDetail["PK_Investigation_Id"]) + "</td>");

                                strHTML.Append("<td align='left' style='width: 150px'>" + FormatDBNullDateToDisplay(drDetail["Date_Of_Accident"]) + "</td>");
                                strHTML.Append("<td align='left' style='width: 150px'>" + FormatDBNullDateToDisplay(drDetail["Date_Reported_To_Employer"]) + "</td>");
                                strHTML.Append("<td align='left' style='width: 180px'>" + FormatDBNullDateToDisplay(drDetail["Date_Reported_To_Insurer"]) + "</td>");
                                strHTML.Append("<td align='left' style='width: 200px'>" + FormatDBNullDateToDisplay(drDetail["Date_Closed"]) + "</td>");
                                strHTML.Append("<td align='left' style='width: 150px'>" + Convert.ToString(drDetail["Original_Sonic_S0_Cause_Code"]) + "</td>");
                                strHTML.Append("<td align='left' style='width: 150px'>" + Convert.ToString(drDetail["Sonic_Cause_Code"]) + "</td>");

                                strHTML.Append("<td align='right' style='width: 150px'>" + string.Format("{0:C2}", drDetail["TotalIncurred"] != DBNull.Value ? Convert.ToDecimal(drDetail["TotalIncurred"]) : 0) + "</td>");
                                strHTML.Append("<td align='right' style='width: 150px'>" + string.Format("{0:C2}", drDetail["TotalPaid"] != DBNull.Value ? Convert.ToDecimal(drDetail["TotalPaid"]) : 0) + "</td>");
                                strHTML.Append("<td align='right' style='width: 150px'>" + string.Format("{0:C2}", drDetail["TotalOutstanding"] != DBNull.Value ? Convert.ToDecimal(drDetail["TotalOutstanding"]) : 0) + "</td>");

                                strHTML.Append(" </tr>");
                            }

                            strHTML.Append("</table>");
                            strHTML.Append("</td></tr>");
                            strHTML.Append("</table>");
                            strHTML.Append("</td></tr>");

                            //Footer Row
                            strHTML.Append("<tr><td align='left'>");
                            strHTML.Append(" <table width='2340px' cellpadding='0' cellspacing='0' border='0'>");
                            strHTML.Append("<tr><td align='left'>");
                            strHTML.Append("<table width='2340px' cellpadding='4' cellspacing='0' border='1' style='font-weight: bold;background-color: #507CD1; color: White;'>");
                            strHTML.Append("<tr style='font-weight: bold;'>");
                            strHTML.Append("<td align='left' style='width: 150px'>Report Grand Totals</td>");
                            strHTML.Append("<td align='left' style='width: 150px'>" + Convert.ToString(dtDetails.Rows.Count) + " </td>");
                            strHTML.Append("<td align='left' style='width: 140px'>&nbsp;</td>");
                            strHTML.Append("<td align='left' style='width: 150px'>&nbsp;</td>");
                            strHTML.Append("<td align='left' style='width: 210px'>&nbsp;</td>");
                            strHTML.Append("<td align='left' style='width: 150px'>&nbsp;</td>");
                            strHTML.Append("<td align='left' style='width: 150px'>&nbsp;</td>");
                            strHTML.Append("<td align='left' style='width: 180px'>&nbsp;</td>");
                            strHTML.Append("<td align='left' style='width: 200px'>&nbsp;</td>");
                            strHTML.Append("<td align='left' style='width: 150px'>&nbsp;</td>");
                            strHTML.Append("<td align='left' style='width: 150px'>&nbsp;</td>");
                            strHTML.Append("<td align='right' style='width: 150px'>" + string.Format("{0:C2}", dtDetails.Compute("sum(TotalIncurred)", "")) + "</td>");
                            strHTML.Append("<td align='right' style='width: 150px'>" + string.Format("{0:C2}", dtDetails.Compute("sum(TotalPaid)", "")) + "</td>");
                            strHTML.Append("<td align='right' style='width: 150px'>" + string.Format("{0:C2}", dtDetails.Compute("sum(TotalOutstanding)", "")) + "</td>");

                            strHTML.Append(" </tr>");
                            strHTML.Append("</table>");
                            strHTML.Append("</td></tr>");
                            strHTML.Append("</table>");
                            strHTML.Append("</td></tr>");
                        }
                        else
                        {
                            strHTML.Append("<tr> <td style='font-weight: bold;'> No Record Found.");
                            strHTML.Append("</td></tr>");
                        }

                        strHTML.Append("</table>");
                        #endregion

                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        SendMail("Sonic Cause Code Reclassification Report", "SonicCauseCodeReclassificationReport.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in Sonic Cause Code Reclassification Report , " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }




        }

        // Report 54
        private void BindSafetyFirstAwardReport(DataRow drReportSchedule)
        {
            decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
            decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
            decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

            //Get Report criteria for the scheduled report
            DataTable dtFilter = Report.SelectFilterCriteria(54, pK_Schedule_ID).Tables[0];
            if (dtFilter.Rows.Count > 0)
            {
                //Get the recipient from the recipient list 
                DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                //Get the user who has scheduled the report
                DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                String strFirstName, strLastName, strMailFrom;
                strFirstName = strLastName = strMailFrom = "";
                if (dtUser.Rows.Count > 0)
                {
                    strFirstName = Convert.ToString(dtUser.Rows[0]["FIRST_NAME"]).Trim();
                    strLastName = Convert.ToString(dtUser.Rows[0]["LAST_NAME"]).Trim();
                    strMailFrom = Convert.ToString(dtUser.Rows[0]["Email"]).Trim();
                }

                string strYear = Convert.ToString(dtFilter.Rows[0]["Year"]).Trim();
                string strRegion = Convert.ToString(dtFilter.Rows[0]["Region"]);
                string strMarket = null;
                if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Market"])))
                {
                    strMarket = Convert.ToString(dtFilter.Rows[0]["Market"]).Trim();
                }
                //Create HTML for the report and wirte into HTML Write object
                StringBuilder strHTML = new StringBuilder();
                System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                #region "Report Title"

                //Retrive Region
                string strRegionString = string.Empty;
                if (string.IsNullOrEmpty(strRegion))
                    strRegionString = "All Region";
                else
                    strRegionString = strRegion;

                //Retrieve Market Values
                string strMarketString = string.Empty;
                if (string.IsNullOrEmpty(strMarket))
                {
                    strMarketString = "All Market";
                }
                else
                {
                    string[] strMar = strMarket.Split(Convert.ToChar(","));
                    for (int i = 0; i < strMar.Length; i++)
                    {
                        strMarketString += Report.SelectMarketInfoById(Convert.ToDecimal(strMar[i].ToString())).Tables[0].Rows[0]["Market"].ToString() + ",";
                    }
                    strMarketString = strMarketString.TrimEnd(',');
                }

                //Add Report Title and Schedule Date
                strHTML.Append("<table>");

                //strHTML.Append("<br/>");
                //strHTML.Append("<td colspan='9'><b>Report Title : Risk Management Playbook Scorecard </b></td>");
                //strHTML.Append("<br/><br/>");
                //strHTML.Append("Schedule Start Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                //strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                //strHTML.Append("<br/>");
                //strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"].ToString());
                //strHTML.Append("<br/>");
                //strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                ////Add Report Filter Criteria    
                //strHTML.Append("<br /><br />");
                //strHTML.Append("<b>Report Filters </b>");
                //strHTML.Append("<br />");
                //strHTML.Append("Year   : " + strYear);
                //strHTML.Append("<br />");
                //strHTML.Append("Region   : " + strRegion);
                //strHTML.Append("<br />");
                //strHTML.Append("Market        : " + strMarketString);
                //strHTML.Append("<br /><br />");
                //strHTML.Append("</td></tr></table>");

                //strHTML.Append("<br/>");
                strHTML.Append("<tr><td colspan='9'><b>Report Title : Risk Management Playbook Scorecard </b></tr>");
                //strHTML.Append("<br/><br/>");
                strHTML.Append("</td></tr><tr><td colspan='9'>Schedule Start Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                strHTML.Append("</td></tr><tr><td colspan='9'>Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                //strHTML.Append("<br/>");
                strHTML.Append("</td></tr><tr><td colspan='9'>Recurring Period : " + drReportSchedule["Recurring_Period"].ToString());
                //strHTML.Append("<br/>");
                strHTML.Append("</td></tr><tr><td colspan='9'>Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                //Add Report Filter Criteria    
                //strHTML.Append("<br /><br />");
                strHTML.Append("</td></tr><tr><td colspan='9'><b>Report Filters </b>");
                //strHTML.Append("<br />");
                strHTML.Append("</td></tr><tr><td colspan='9'>Year   : " + strYear);
                //strHTML.Append("<br />");
                strHTML.Append("</td></tr><tr><td colspan='9'>Region   : " + strRegionString);
                //strHTML.Append("<br />");
                strHTML.Append("</td></tr><tr><td colspan='9'>Market        : " + strMarketString);
                //strHTML.Append("<br /><br />");
                strHTML.Append("</td></tr></table>");

                #endregion


                #region "Grid Data"

                strHTML.Append("<table cellspacing='0' cellpadding='0' border='0' style='width: 1700px; border-collapse: collapse;'>");
                //Header Row                
                strHTML.Append("<tr><td>");
                strHTML.Append("<table width='1700px' cellpadding='0' cellspacing='0' border='0'>");
                strHTML.Append("<tr><td>");
                strHTML.Append("<table width='1700px' cellpadding='0' cellspacing='0' border='1' style='font-weight: bold;'>");
                strHTML.Append("<tr style='font-weight: bold;'>");
                strHTML.Append("<td align='left' colspan='2'>Sonic Automotive</td>");
                strHTML.Append("<td align='center' colspan='5'>Risk Management Playbook Scorecard </td>");
                strHTML.Append("<td align='right' colspan='3'>Valuation Date: " + DateTime.Now.ToString("MM/dd/yyy") + " </td>");
                strHTML.Append("</tr>");

                strHTML.Append("<tr style='font-weight: bold;'>");
                strHTML.Append("<td align='left' style='width: 200px'>Region</td>");
                strHTML.Append("<td align='left' style='width: 200px'>Location D/B/A</td>");
                strHTML.Append("<td align='center' style='width: 150px'>Safety Leadership Team Score</td>");
                strHTML.Append("<td align='center' style='width: 150px'>EHS Inspection Score</td>");
                strHTML.Append("<td align='center' style='width: 150px'>Safety Training Score</td>");
                strHTML.Append("<td align='center' style='width: 170px'>Incident Investigation Score</td>");
                strHTML.Append("<td align='center' style='width: 180px'>W.C. Claims Management Score</td>");
                strHTML.Append("<td align='center' style='width: 150px'>Incident Reduction Score</td>");
                strHTML.Append("<td align='center' style='width: 150px'>Total Aggregate Score</td>");
                //strHTML.Append("<td align='left' style='width: 150px'>Resulting Score</td>");
                strHTML.Append("<td align='center' style='width: 150px'>Final Playbook Scorecard (100 Point Program)</td>");
                strHTML.Append("</tr>");
                strHTML.Append("</table>");
                strHTML.Append("</td></tr>");
                strHTML.Append("</table>");
                strHTML.Append("</td></tr>");


                DataSet dsReport = Report.GetSafertyFirstAwardReport(strRegion, strMarket, Convert.ToInt32(strYear), FK_Security_Id);

                if (dsReport != null && dsReport.Tables.Count > 0 && dsReport.Tables[0].Rows.Count > 0)
                {
                    DataTable dtLocation = dsReport.Tables[0];
                    DataTable dtDetails = dsReport.Tables[0];

                    strHTML.Append("<tr><td>");
                    strHTML.Append("<table width='1700px' cellpadding='0' cellspacing='0' border='0'>");
                    strHTML.Append("<tr><td>");
                    strHTML.Append("<table cellspacing='0' cellpadding='0'  border='1' style='width: 100%; border-collapse: collapse;'>");
                    string strFinalScoreCard = "", strScoreCardBgColor = "";
                    int Is_Total = 0;
                    double decTotalScore = 0;

                    foreach (DataRow drDetail in dsReport.Tables[0].Rows)
                    {
                        Is_Total = 0;
                        decTotalScore = 0;
                        int.TryParse(Convert.ToString(drDetail["Is_Total"]), out Is_Total);
                        double.TryParse(Convert.ToString(drDetail["ResultingScore"]), out decTotalScore);

                        if (Is_Total == 1)
                        {
                            //strScoreCardBgColor = "#ADD8E6";
                            strHTML.Append("<tr bgcolor='#ADD8E6'>");
                        }
                        else if (Is_Total == 2)
                        {
                            //strScoreCardBgColor = "#76bdd5";
                            strHTML.Append("<tr bgcolor='#76bdd5'>");
                        }
                        else
                            strHTML.Append("<tr>");



                        if (decTotalScore >= 95 && decTotalScore <= 100)
                        {
                            //strFinalScoreCard = decTotalScore + " (" + Platinum_Label + ")";                
                            strScoreCardBgColor = "#" + Platinum; ;// "green";
                        }
                        else if (decTotalScore >= 90 && decTotalScore < 95)
                        {
                            //strFinalScoreCard = decTotalScore + " (" + Gold_Label + ")";             
                            strScoreCardBgColor = "#" + Gold;//"blue";
                        }
                        else if (decTotalScore >= 80 && decTotalScore < 90)
                        {
                            //strFinalScoreCard = decTotalScore + " (" + Silver_Label + ")";             
                            strScoreCardBgColor = "#" + Silver;//"Yellow";
                        }
                        else if (decTotalScore >= 70 && decTotalScore < 80)
                        {
                            //strFinalScoreCard = decTotalScore + " (" + Bronze_Label + ")";
                            strScoreCardBgColor = "#" + Bronze;//"orange";
                        }
                        else if (decTotalScore >= 0 && decTotalScore < 70)
                        {
                            // strFinalScoreCard = decTotalScore + " (" + Tin_Label + ")";
                            strScoreCardBgColor = "#" + Tin;//"red";
                        }

                        //else
                        //    strScoreCardBgColor = "White";                

                        string strTempRegion = string.Empty;
                        //strHTML.Append("<tr>");
                        if (Convert.ToString(drDetail["Region"]) == "ZZZZ" && Convert.ToString(drDetail["IS_EchoPark"]) == "1" && Convert.ToString(drDetail["Is_Total"]) == "2")
                            strTempRegion = "EchoPark Average";
                        else if (Convert.ToString(drDetail["Region"]) == "ZZZZ" && Convert.ToString(drDetail["Is_Total"]) == "2")
                            strTempRegion = "Non-EchoPark Average";
                        else strTempRegion = Convert.ToString(drDetail["Region"]);

                        strHTML.Append("<td align='left' style='width: 200px'>" + strTempRegion + "</td>");
                        strHTML.Append("<td align='left' style='width: 200px'>" + Convert.ToString(drDetail["DBA"]) + "</td>");
                        strHTML.Append("<td align='center' style='width: 150px;'>" + Convert.ToString(drDetail["SLT_Score"]) + "</td>");
                        strHTML.Append("<td align='center' style='width: 150px;'>" + Convert.ToString(drDetail["FI_Score"]) + "</td>");
                        strHTML.Append("<td align='center' style='width: 150px'>" + Convert.ToString(drDetail["SUT_Score"]) + "</td>");
                        strHTML.Append("<td align='center' style='width: 170px'>" + Convert.ToString(drDetail["II_Score"]) + "</td>");

                        strHTML.Append("<td align='center' style='width: 180px'>" + Convert.ToString(drDetail["WM_Score"]) + "</td>");
                        strHTML.Append("<td align='center' style='width: 150px'>" + Convert.ToString(drDetail["IR_Score"]) + "</td>");
                        strHTML.Append("<td align='center' style='width: 150px'>" + Convert.ToString(drDetail["TotalScore"]) + "</td>");
                        strHTML.Append("<td align='center' style='width: 150px;background-color:" + strScoreCardBgColor + "' >" + Final_ScoreCard(Convert.ToString(drDetail["ResultingScore"])) + "</td>");
                        strHTML.Append(" </tr>");
                    }
                    strHTML.Append("</table>");
                    strHTML.Append("</td></tr>");
                    strHTML.Append("</table>");
                    strHTML.Append("</td></tr>");
                }
                else
                {
                    strHTML.Append("<tr> <td style='font-weight: bold;'> No Record Found.");
                    strHTML.Append("</td></tr>");
                }

                strHTML.Append("</table>");
                #endregion

                //Write HTML in to HtmlWriter
                htmlWrite.WriteLine(strHTML.ToString());
                //Send Mail
                SendMail("Risk Management Playbook Scorecard Report", "RiskManagementPlaybookScorecard.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
            }
        }

        //Report 55
        private void BindLandlordNotificationReport(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(55, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list 
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                    String strFirstName, strLastName, strMailFrom, strStatus;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = Convert.ToString(dtUser.Rows[0]["FIRST_NAME"]).Trim();
                        strLastName = Convert.ToString(dtUser.Rows[0]["LAST_NAME"]).Trim();
                        strMailFrom = Convert.ToString(dtUser.Rows[0]["Email"]).Trim();

                        //Set all filters to a variable as per report type
                        DateTime? dtLCDFrom = null, dtLCDTo = null, dtLEDFrom = null, dtLEDTo = null;

                        string strRegion = Convert.ToString(dtFilter.Rows[0]["Region"]).Trim();
                        string strMarket = null;
                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Market"])))
                        {
                            strMarket = Convert.ToString(dtFilter.Rows[0]["Market"]).Trim();
                        }
                        string strLeaseType = Convert.ToString(dtFilter.Rows[0]["LeaseType"]).Trim();
                        strStatus = Convert.ToString(dtFilter.Rows[0]["Status"]).Trim();

                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["LCDFrom_Date"])))
                            dtLCDFrom = Convert.ToDateTime(dtFilter.Rows[0]["LCDFrom_Date"]);

                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["LCDTo_Date"])))
                            dtLCDTo = Convert.ToDateTime(dtFilter.Rows[0]["LCDTo_Date"]);

                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["LEDFrom_Date"])))
                            dtLEDFrom = Convert.ToDateTime(dtFilter.Rows[0]["LEDFrom_Date"]);

                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["LEDTo_Date"])))
                            dtLEDTo = Convert.ToDateTime(dtFilter.Rows[0]["LEDTo_Date"]);


                        //Create HTML for the report and wirte into HTML Write object
                        StringBuilder strHTML = new StringBuilder();
                        System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                        System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                        #region "Search Criteria"

                        //Retrieve Market Values
                        string strMarketString = string.Empty;
                        if (string.IsNullOrEmpty(strMarket))
                        {
                            strMarketString = "All Market";
                        }
                        else
                        {
                            string[] strMar = strMarket.Split(Convert.ToChar(","));
                            for (int i = 0; i < strMar.Length; i++)
                            {
                                strMarketString += Report.SelectMarketInfoById(Convert.ToDecimal(strMar[i].ToString())).Tables[0].Rows[0]["Market"].ToString() + ",";
                            }
                            strMarketString = strMarketString.TrimEnd(',');
                        }

                        //Add Report Title and Schedule Date
                        strHTML.Append("<table><tr><td colspan='11'>");
                        //strHTML.Append("<table><tr><td>");
                        strHTML.Append("<br />");
                        strHTML.Append("<b>Report Title : Landlord Notification Report</b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"].ToString());
                        strHTML.Append("<br />");
                        strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                        //Add Report Filter Criteria 
                        strHTML.Append("<br /><br />");
                        strHTML.Append("<b>Report Filters </b>");
                        strHTML.Append("<br /><br />");
                        strHTML.Append("Region        : " + strRegion.Replace("'", ""));
                        strHTML.Append("Market        : " + strMarketString);
                        strHTML.Append("<br /><br />");
                        strHTML.Append("<br />");
                        strHTML.Append("LCD From      : " + FormatDBNullDateToDisplay(dtLCDFrom));
                        strHTML.Append("<br />");
                        strHTML.Append("LCD To        : " + FormatDBNullDateToDisplay(dtLCDTo));
                        strHTML.Append("<br />");
                        strHTML.Append("LED From      : " + FormatDBNullDateToDisplay(dtLEDFrom));
                        strHTML.Append("<br />");
                        strHTML.Append("LED To        : " + FormatDBNullDateToDisplay(dtLEDTo));
                        strHTML.Append("<br />");
                        strHTML.Append("Building Status        : " + strStatus.Replace("'", ""));
                        strHTML.Append("<br /><br />");

                        strHTML.Append("</td></tr></table>");


                        //strHTML.Append("</td></tr></table>");

                        #endregion

                        #region "Grid Data"

                        strHTML.Append("<table cellspacing='0' cellpadding='0' align='Left' border='1' style='width: 1340px; border-collapse: collapse;'>");
                        //Header Row
                        strHTML.Append("<tr><td align='left'>");
                        strHTML.Append("<table width='1625px' cellpadding='0' cellspacing='0' border='1'>");
                        strHTML.Append("<tr><td align='left'>");
                        strHTML.Append("<table width='1625px' cellpadding='0' cellspacing='0' border='1' style='font-weight: bold;'>");
                        strHTML.Append("<tr style='font-weight: bold;'>");
                        strHTML.Append("<td align='left' colspan='2'>Sonic Automotive</td>");
                        strHTML.Append("<td align='center' colspan='3'>Landlord Notification Report</td>");
                        strHTML.Append("<td align='right' style='border:thin' colspan='4'>" + FormatDBNullDateToDisplay(DateTime.Now) + " </td>");
                        strHTML.Append("</tr>");
                        strHTML.Append("<table width='100%' cellpadding='0' cellspacing='0' border='1' style='font-weight: bold;'>");
                        strHTML.Append("<tr style='font-weight: bold;'>");
                        strHTML.Append("<td align='left' style='width: 100px'>LL Notify Date</td>");
                        strHTML.Append("<td align='left' style='width: 180px'>Location</td>");
                        strHTML.Append("<td align='left' style='width: 560px'>");
                        strHTML.Append("<table width='100%' cellpadding='0' cellspacing='0' border='1' style='font-weight: bold;'>");
                        strHTML.Append("<tr>");
                        strHTML.Append("<td align='left' style='width: 40%'>Building Address</td>");
                        strHTML.Append("<td align='left' style='width: 30%'>Building Number</td>");
                        strHTML.Append("<td align='left' style='width: 30%'>Building Landlord Name</td>");
                        strHTML.Append("</tr>");
                        strHTML.Append("</table>");
                        strHTML.Append("</td>");
                        strHTML.Append("<td align='left' style='width: 100px'>LCD</td>");
                        strHTML.Append("<td align='left' style='width: 100px'>LED</td>");
                        strHTML.Append("<td align='left' style='width: 100px'>Reminder Date</td>");
                        strHTML.Append("<td align='left' style='width: 100px'>Review Date</td>");
                        strHTML.Append("<td align='right' style='width: 100px'>Monthly Rent</td>");
                        strHTML.Append("<td align='left' style='width: 180px'>Renewals</td>");

                        strHTML.Append("</tr>");
                        strHTML.Append("</table>");
                        strHTML.Append("</td></tr>");
                        strHTML.Append("</table>");
                        strHTML.Append("</td></tr>");


                        //get the all Employee records by search criteria by group
                        DataSet dsDetails = Report.GetLandlordNotificationReport(strRegion, strMarket, dtLCDFrom, dtLCDTo, dtLEDFrom, dtLEDTo, strStatus);

                        if (dsDetails != null && dsDetails.Tables.Count > 0 && dsDetails.Tables[0].Rows.Count > 0)
                        {
                            DataTable dtLocation = dsDetails.Tables[0];
                            DataTable dtDetails = dsDetails.Tables[0];

                            strHTML.Append("<tr align='left'><td align='left' valign='top'>");
                            strHTML.Append("<table width='1625px' cellpadding='0' cellspacing='0' border='0'>");
                            strHTML.Append("<tr><td align='left' valign='top'>");
                            strHTML.Append("<table cellspacing='0' cellpadding='0' border='1' style='width: 100%; border-collapse: collapse;'>");

                            //foreach (DataRow dr in dtLocation.Rows)
                            //{
                            // DataRow[] drDetails = dtDetails.Select("DBA='" + dr["DBA"] + "'");
                            foreach (DataRow drDetail in dtLocation.Rows)
                            {
                                strHTML.Append("<tr>");
                                strHTML.Append("<td valign='top' align='left' style='width: 100px'>" + FormatDBNullDateToDisplay(drDetail["LLNotifyDate"]) + "</td>");
                                strHTML.Append("<td valign='top' align='left'>" + Convert.ToString(drDetail["DBA"]) + "</td>");
                                strHTML.Append("<td valign='top' align='left' valign='top' style='width: 560px'>");
                                decimal _PK_RE_Information = Convert.ToDecimal(drDetail["PK_RE_Information"]);
                                DataTable dtBuilding = Report.SelectByFK_RE_Information(_PK_RE_Information).Tables[0];
                                if (dtBuilding.Rows.Count > 0)
                                {
                                    strHTML.Append("<table cellspacing='0' cellpadding='0' border='1' style='width: 100%; border-collapse: collapse;'>");
                                    foreach (DataRow drBuilding in dtBuilding.Rows)
                                    {
                                        strHTML.Append("<tr>");
                                        strHTML.Append("<td align='left' valign='top' style='width:40%'>" + (drBuilding["Address"]) + "</td>");
                                        strHTML.Append("<td align='left' valign='top' style='width:30%'>" + Convert.ToString(drBuilding["Building_Number"]) + "</td>");
                                        strHTML.Append("<td align='left' valign='top' style='width:30%'>" + Convert.ToString(drBuilding["Landlord_Name"]) + "</td>");
                                        strHTML.Append("</tr>");

                                    }
                                    strHTML.Append("</table>");
                                }
                                else
                                {
                                    strHTML.Append("<table cellspacing='0' cellpadding='0' align='Left' border='1' style='width: 100%; border-collapse: collapse;'>");
                                    strHTML.Append("<tr>");
                                    strHTML.Append("<td align='left' valign='top' style='width:40%'>" + "" + "</td>");
                                    strHTML.Append("<td align='left' valign='top' style='width:30%'>" + "" + "</td>");
                                    strHTML.Append("<td align='left' valign='top' style='width:30%'>" + "" + "</td>");
                                    strHTML.Append("</tr>");
                                    strHTML.Append("</table>");
                                }

                                strHTML.Append("</td>");
                                strHTML.Append("<td valign='top' align='left' >" + FormatDBNullDateToDisplay(drDetail["LCD"]) + "</td>");
                                strHTML.Append("<td valign='top' align='left' >" + FormatDBNullDateToDisplay(drDetail["LED"]) + "</td>");
                                strHTML.Append("<td valign='top' align='left' style='width: 100px'>" + FormatDBNullDateToDisplay(drDetail["ReminderDate"]) + "</td>");
                                strHTML.Append("<td valign='top' align='left' style='width: 100px'>" + FormatDBNullDateToDisplay(drDetail["ReviewDate"]) + "</td>");
                                strHTML.Append("<td valign='top' align='right' >" + string.Format("{0:N2}", drDetail["MonthlyRent"] != DBNull.Value ? Convert.ToDecimal(drDetail["MonthlyRent"]) : 0) + "</td>");
                                strHTML.Append("<td valign='top' align='left' style='width: 180px'>" + Convert.ToString(drDetail["Renewals"]) + "</td>");


                                strHTML.Append(" </tr>");
                            }
                            //}
                            strHTML.Append("</table>");
                            strHTML.Append("</td></tr>");
                            strHTML.Append("</table>");
                            strHTML.Append("</td></tr>");

                            //Footer Row
                            strHTML.Append("<tr><td align='left' valign='top'>");
                            strHTML.Append(" <table width='1625px' cellpadding='0' cellspacing='0' border='0'>");
                            strHTML.Append("<tr><td align='left'>");
                            strHTML.Append("<table width='1625px' cellpadding='4' cellspacing='0' border='1' style='font-weight: bold;background-color: #507CD1; color: White;'>");
                            strHTML.Append("<tr style='font-weight: bold;'>");
                            strHTML.Append("<td valign='top' align='left' style='width: 100px'>Report Grand Totals</td>");
                            strHTML.Append("<td valign='top' align='left'  style='width: 180px'>" + Convert.ToString(dtDetails.Rows.Count) + " </td>");
                            strHTML.Append("<td valign='top' align='left' colspan='3' style='width: 560px'>&nbsp;</td>");
                            //strHTML.Append("<td valign='top' align='left' style='width: 100px'>&nbsp;</td>");
                            //strHTML.Append("<td valign='top' align='left' style='width: 100px'>&nbsp;</td>");
                            strHTML.Append("<td valign='top' align='left' style='width: 100px'>&nbsp;</td>");
                            strHTML.Append("<td valign='top' align='left' style='width: 100px'>&nbsp;</td>");
                            strHTML.Append("<td valign='top' align='left' style='width: 100px'>&nbsp;</td>");
                            strHTML.Append("<td valign='top' align='left' style='width: 100px'>&nbsp;</td>");
                            strHTML.Append("<td valign='top' align='right' style='width: 100px'>" + string.Format("{0:N2}", dtDetails.Compute("sum(MonthlyRent)", "")) + "</td>");
                            strHTML.Append("<td valign='top' align='left' style='width: 180px'>&nbsp;</td>");
                            //strHTML.Append("<td align='left' style='width: 100px'>Report Grand Totals</td>");
                            //strHTML.Append("<td align='left' style='width: 180px'>" + Convert.ToString(dtDetails.Rows.Count) + " </td>");
                            //strHTML.Append("<td align='left' style='width: 560px' colspan='3'>&nbsp;</td>");
                            ////strHTML.Append("<td align='left' style='width: 100px'>&nbsp;</td>");
                            ////strHTML.Append("<td align='left' style='width: 100px'>&nbsp;</td>");
                            //strHTML.Append("<td align='left' style='width: 100px'>&nbsp;</td>");
                            //strHTML.Append("<td align='left' style='width: 100px'>&nbsp;</td>");
                            //strHTML.Append("<td align='left' style='width: 100px'>&nbsp;</td>");
                            //strHTML.Append("<td align='left' style='width: 100px'>&nbsp;</td>");
                            //strHTML.Append("<td align='right' style='width: 100px'>" + string.Format("{0:N2}", dtDetails.Compute("sum(MonthlyRent)", "")) + "</td>");
                            //strHTML.Append("<td align='left' style='width: 180px'>&nbsp;</td>");

                            strHTML.Append(" </tr>");
                            strHTML.Append("</table>");
                            strHTML.Append("</td></tr>");
                            strHTML.Append("</table>");
                            strHTML.Append("</td></tr>");
                        }
                        else
                        {
                            strHTML.Append("<tr> <td style='font-weight: bold;'> No Record Found.");
                            strHTML.Append("</td></tr>");
                        }

                        strHTML.Append("</table>");
                        #endregion

                        //Write HTML in to HtmlWriter
                        htmlWrite.WriteLine(strHTML.ToString());

                        //Send Mail
                        SendMail("Landlord Notification Report", "LandlordNotificationReport.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
                    }
                }
            }
            catch (Exception ex)
            {
                EventLog.WriteEntry("ERROR in Landlord Notification Report, " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
        }

        //Report 56
        private void BindInpectionsByInspector(DataRow drReportSchedule)
        {
            decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
            decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
            decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

            //Get Report criteria for the scheduled report
            DataTable dtFilter = Report.SelectFilterCriteria(56, pK_Schedule_ID).Tables[0];
            if (dtFilter.Rows.Count > 0)
            {
                //Get the recipient from the recipient list 
                DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                //Get the user who has scheduled the report
                DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                String strFirstName, strLastName, strMailFrom;
                strFirstName = strLastName = strMailFrom = "";
                if (dtUser.Rows.Count > 0)
                {
                    strFirstName = Convert.ToString(dtUser.Rows[0]["FIRST_NAME"]).Trim();
                    strLastName = Convert.ToString(dtUser.Rows[0]["LAST_NAME"]).Trim();
                    strMailFrom = Convert.ToString(dtUser.Rows[0]["Email"]).Trim();
                }
                string strRegion = Convert.ToString(dtFilter.Rows[0]["Region"]).Trim();
                string strMarket = null;
                if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Market"])))
                {
                    strMarket = Convert.ToString(dtFilter.Rows[0]["Market"]).Trim();
                }
                string strDBA = Convert.ToString(dtFilter.Rows[0]["DBA"]).Trim();
                string strInspector = Convert.ToString(dtFilter.Rows[0]["Inspector_Name"]).Trim();
                DateTime? dtInspection_Date_From;
                DateTime? dtInspection_Date_To;
                if (dtFilter.Rows[0]["Inspection_Date_From"] != DBNull.Value)
                    dtInspection_Date_From = Convert.ToDateTime(dtFilter.Rows[0]["Inspection_Date_From"]);
                else
                    dtInspection_Date_From = null;
                if (dtFilter.Rows[0]["Inspection_Date_To"] != DBNull.Value)
                    dtInspection_Date_To = Convert.ToDateTime(dtFilter.Rows[0]["Inspection_Date_To"]);
                else
                    dtInspection_Date_To = null;

                //Get the all Unique records for Selected group (default - last name -sort) by search criteria
                DataSet dsResult = Report.GetInspectionsByInspector(strRegion, strMarket, strDBA, strInspector, dtInspection_Date_From, dtInspection_Date_To);

                //Create HTML for the report and wirte into HTML Write object
                StringBuilder strHTML = new StringBuilder();
                System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                #region "Report Title"

                //Retrieve Market Values
                string strMarketString = string.Empty;
                if (string.IsNullOrEmpty(strMarket))
                {
                    strMarketString = "All Market";
                }
                else
                {
                    string[] strMar = strMarket.Split(Convert.ToChar(","));
                    for (int i = 0; i < strMar.Length; i++)
                    {
                        strMarketString += Report.SelectMarketInfoById(Convert.ToDecimal(strMar[i].ToString())).Tables[0].Rows[0]["Market"].ToString() + ",";
                    }
                    strMarketString = strMarketString.TrimEnd(',');
                }

                //Add Report Title and Schedule Date
                strHTML.Append("<table><tr><td colspan='5'>");
                strHTML.Append("<br />");
                strHTML.Append("<b>Report Title : Inspections By Inspector</b>");
                strHTML.Append("<br /><br />");
                strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                strHTML.Append("<br />");
                strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"].ToString());
                strHTML.Append("<br />");
                strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                //Add Report Filter Criteria 
                strHTML.Append("<br /><br />");
                strHTML.Append("<b>Report Filters </b>");
                strHTML.Append("<br />");
                strHTML.Append("Region   : " + strRegion);
                //strHTML.Append("</td> </tr>");
                strHTML.Append("<br />");
                strHTML.Append("Market        : " + strMarketString);
                strHTML.Append("<br/>");
                //strHTML.Append("<tr> <td colspan='8'>");
                strHTML.Append("Location D/B/A   : " + strDBA);
                strHTML.Append("<br/>");
                //strHTML.Append("<tr> <td colspan='8'>");
                strHTML.Append("Inspector Name   : " + strInspector);
                strHTML.Append("<br/>");
                //strHTML.Append("<tr> <td colspan='8'>");
                strHTML.Append("Inspection Date From   : " + Convert.ToString(dtInspection_Date_From));
                strHTML.Append("<br/>");
                //strHTML.Append("<tr> <td colspan='8'>");
                strHTML.Append("Inspection Date To   : " + Convert.ToString(dtInspection_Date_To));
                strHTML.Append("<br/>");
                //strHTML.Append("</td> </tr>");
                //strHTML.Append("<tr> <td colspan='8'>");
                strHTML.Append("</td></tr></table> ");


                #endregion

                #region "Report Grid header"
                //Top Header
                strHTML.Append("<table border='1'>");
                strHTML.Append("<tr style='font-weight: bold;' valign='bottom'>");
                strHTML.Append("<td align='left' >Sonic Automotive</td>");
                strHTML.Append("<td align='center' colspan='3'>Inspections By Inspector</td>");
                strHTML.Append("<td align='right' > " + DateTime.Now.ToString() + " </td>");
                strHTML.Append("</tr>");

                //Sub Header
                strHTML.Append("<tr valign='bottom' align='left' style='font-weight: bold'>");
                strHTML.Append("<td width='150'>Region</td>");
                strHTML.Append("<td width='150'>Inspector</td>");
                strHTML.Append("<td width='150'>Location D/B/A</td>");
                strHTML.Append("<td width='160'>Inspection Date</td>");
                strHTML.Append("<td width='160'>Number of Deficiencies</td>");

                strHTML.Append("</tr>");

                //Check Whether Record Exists or Not
                if (dsResult != null && dsResult.Tables.Count > 0 && dsResult.Tables[0].Rows.Count > 0)
                {
                    foreach (DataRow dr in dsResult.Tables[0].Rows)
                    {
                        strHTML.Append("<tr valign='top' align='left'>");

                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["Region"]) + "</td>");
                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["Inspector_Name"]) + "</td>");
                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["dba"]) + "</td>");
                        strHTML.Append("<td width='150'>" + FormatDBNullDateToDisplay(dr["Date"]) + "</td>");
                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["No_Deficiencies"]) + "</td>");

                        strHTML.Append("</tr>");
                    }
                }
                else
                {
                    //Add No record found line for year
                    strHTML.Append("<tr><td align='left' colspan='5'>No Record Found!</td></tr>");
                }
                strHTML.Append("</table>");

                #endregion

                //Write HTML in to HtmlWriter
                htmlWrite.WriteLine(strHTML.ToString());
                //Send Mail
                SendMail("Inspections By Inspector", "Inspections_By_Inspector_Report.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
            }

        }



        //Report 57
        private void BindRiskManagementWorkSheet(DataRow drReportSchedule)
        {
            decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
            decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
            decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

            //Get Report criteria for the scheduled report
            DataTable dtFilter = Report.SelectFilterCriteria(57, pK_Schedule_ID).Tables[0];
            if (dtFilter.Rows.Count > 0)
            {
                //Get the recipient from the recipient list 
                DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                //Get the user who has scheduled the report
                DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];
                String strFirstName, strLastName, strMailFrom;
                strFirstName = strLastName = strMailFrom = "";
                if (dtUser.Rows.Count > 0)
                {
                    strFirstName = Convert.ToString(dtUser.Rows[0]["FIRST_NAME"]).Trim();
                    strLastName = Convert.ToString(dtUser.Rows[0]["LAST_NAME"]).Trim();
                    strMailFrom = Convert.ToString(dtUser.Rows[0]["Email"]).Trim();
                }

                string strRegion = Convert.ToString(dtFilter.Rows[0]["Region"]).Trim();
                string strMarket = null;
                if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Market"])))
                {
                    strMarket = Convert.ToString(dtFilter.Rows[0]["Market"]).Trim();
                }
                string strDBA = Convert.ToString(dtFilter.Rows[0]["DBA"]).Trim();
                string strBodyPart = Convert.ToString(dtFilter.Rows[0]["FK_Part_of_Body"]).Trim();
                string strClaimStatus = Convert.ToString(dtFilter.Rows[0]["Claim_Status"]).Trim();
                string strClaim_StatusSelected = Convert.ToString(dtFilter.Rows[0]["Claim_StatusSelected"]).Trim();
                string strDBAList = Convert.ToString(dtFilter.Rows[0]["DBAList"]).Trim();
                string strPartofBodyist = Convert.ToString(dtFilter.Rows[0]["Part_of_Body"]).Trim();
                DateTime? dtIncident_Date_From;
                DateTime? dtIncident_Date_To;
                if (dtFilter.Rows[0]["Date_of_Incident_From"] != DBNull.Value)
                    dtIncident_Date_From = Convert.ToDateTime(dtFilter.Rows[0]["Date_of_Incident_From"]);
                else
                    dtIncident_Date_From = null;
                if (dtFilter.Rows[0]["Date_of_Incident_To"] != DBNull.Value)
                    dtIncident_Date_To = Convert.ToDateTime(dtFilter.Rows[0]["Date_of_Incident_To"]);
                else
                    dtIncident_Date_To = null;

                DataSet dsResult = Report.GetRiskManagementWorksheet(strRegion, strMarket, strDBA, dtIncident_Date_From, dtIncident_Date_To, strBodyPart, strClaimStatus);

                //Create HTML for the report and wirte into HTML Write object
                StringBuilder strHTML = new StringBuilder();
                System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                #region "Report Title"

                //Retrieve Market Values
                string strMarketString = string.Empty;
                if (string.IsNullOrEmpty(strMarket))
                {
                    strMarketString = "All Market";
                }
                else
                {
                    string[] strMar = strMarket.Split(Convert.ToChar(","));
                    for (int i = 0; i < strMar.Length; i++)
                    {
                        strMarketString += Report.SelectMarketInfoById(Convert.ToDecimal(strMar[i].ToString())).Tables[0].Rows[0]["Market"].ToString() + ",";
                    }
                    strMarketString = strMarketString.TrimEnd(',');
                }

                //Add Report Title and Schedule Date
                strHTML.Append("<table><tr><td colspan='11'>");
                strHTML.Append("<br />");
                strHTML.Append("<b>Report Title : Risk Management Worksheet</b>");
                strHTML.Append("<br /><br />");
                strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                strHTML.Append("<br />");
                strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"].ToString());
                strHTML.Append("<br />");
                strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                //Add Report Filter Criteria 
                strHTML.Append("<br /><br /><table> <tr> <td colspan='11'>");
                strHTML.Append("<b>Report Filters </b>");
                strHTML.Append("</td></tr> <tr> <td colspan='11'>");
                strHTML.Append("Region : " + strRegion.Replace("'", ""));
                strHTML.Append("</td> </tr>");
                strHTML.Append("<tr> <td colspan='11'>");
                strHTML.Append("Market : " + strMarketString);
                strHTML.Append("</td> </tr>");
                strHTML.Append("<tr> <td colspan='11'>");
                strHTML.Append("Location D/B/A : " + strDBAList);
                strHTML.Append("</td> </tr>");
                strHTML.Append("<tr> <td colspan='11'>");
                strHTML.Append("Parts of Body : " + strPartofBodyist);
                strHTML.Append("</td> </tr>");
                strHTML.Append("<tr> <td colspan='11'>");
                strHTML.Append("Date of Incident From   : " + Convert.ToString(dtIncident_Date_From));
                strHTML.Append("</td> </tr>");
                strHTML.Append("<tr> <td colspan='11'>");
                strHTML.Append("Date of Incident To : " + Convert.ToString(dtIncident_Date_To));
                strHTML.Append("</td> </tr>");
                strHTML.Append("<tr> <td colspan='11'>");
                strHTML.Append("Claim Status : " + strClaim_StatusSelected);
                strHTML.Append("</td> </tr>");
                strHTML.Append("<tr> <td colspan='11'>");
                strHTML.Append("</td></tr></table> ");

                strHTML.Append("</td></tr></table>");

                #endregion


                #region "Report Grid header"
                //Top Header
                strHTML.Append("<table border='1'><tr><td><table  border='1'>");
                strHTML.Append("<tr style='font-weight: bold;' valign='bottom' align='left'>");
                strHTML.Append("<td align='left' style='border:thin'>Sonic Automotive</td>");
                strHTML.Append("<td align='center' colspan='9' style='border:thin'>Risk Management Worksheet</td>");
                strHTML.Append("<td align='right' style='border:thin'> " + DateTime.Now.ToString() + " </td>");
                strHTML.Append("</tr></table></td></tr>");

                //Sub Header
                strHTML.Append("<tr><td><table  border='1'>");
                strHTML.Append("<tr valign='bottom' align='left' style='font-weight: bold'>");
                strHTML.Append("<td width='120' style='border:thin'>Region</td>");
                strHTML.Append("<td width='150' style='border:thin'>Location D/B/A</td>");
                strHTML.Append("<td width='130' style='border:thin'>Associate Name</td>");
                strHTML.Append("<td width='100' style='border:thin'>Claim Number</td>");
                strHTML.Append("<td width='100' style='border:thin'>Date of Incident</td>");
                strHTML.Append("<td width='180' style='border:thin'>Part of Body</td>");
                strHTML.Append("<td width='100' style='border:thin'>Claim Status</td>");
                strHTML.Append("<td width='500' align='center' style='border:thin'>Reserves and Payments</td>");
                strHTML.Append("<td width='100' style='border:thin'>Resignation</td>");
                strHTML.Append("<td width='120' align='right' style='border:thin'>Settlement Amount</td>");
                strHTML.Append("<td width='100' style='border:thin'>Who Approved</td>");
                strHTML.Append("</tr></table></td>");
                strHTML.Append("</tr>");

                //Check Whether Record Exists or Not
                if (dsResult != null && dsResult.Tables.Count > 0 && dsResult.Tables[0].Rows.Count > 0)
                {
                    foreach (DataRow dr in dsResult.Tables[0].Rows)
                    {
                        strHTML.Append("<tr><td><table border='1'>");
                        strHTML.Append("<tr valign='top' align='left'>");

                        strHTML.Append("<td style='border:thin'>" + Convert.ToString(dr["Region"]) + "</td>");
                        strHTML.Append("<td style='border:thin'>" + Convert.ToString(dr["DBA"]) + "</td>");
                        strHTML.Append("<td style='border:thin'>" + Convert.ToString(dr["Employee_Name"]) + "</td>");
                        strHTML.Append("<td style='border:thin'>" + Convert.ToString(dr["Origin_Claim_Number"]) + "</td>");
                        strHTML.Append("<td style='border:thin'>" + FormatDBNullDateToDisplay(dr["Date_Of_Accident"]) + "</td>");
                        strHTML.Append("<td style='border:thin'>" + Convert.ToString(dr["Part_of_Body"]) + "</td>");
                        strHTML.Append("<td style='border:thin'>" + Convert.ToString(dr["Claim_Status"]) + "</td>");

                        strHTML.Append("<td style='border:thin'> <table width='100%' cellpadding='3' cellspacing='2' border='1'>");
                        strHTML.Append("<tr><td width='16%' align='left' style='border:thin'>&nbsp;</td>");
                        strHTML.Append("<td style='border:thin' width='21%' align='right'><b>Indemnity $</b></td>");
                        strHTML.Append("<td style='border:thin' width='21%' align='right'><b>Medical $</b></td>");
                        strHTML.Append("<td style='border:thin' width='21%' align='right'><b>Expenses $</b></td>");
                        strHTML.Append("<td style='border:thin' width='21%' align='right'><b>Total $</b></td></tr>");
                        strHTML.Append("<tr><td  align='left' style='border:thin'><b>Reserve</b></td>");
                        strHTML.Append("<td  align='right' style='border:thin'>" + string.Format("{0:C2}", dr["Reserve_Indemnity"]) + "</td>");
                        strHTML.Append("<td  align='right' style='border:thin'>" + string.Format("{0:C2}", dr["Resrve_Medical"]) + "</td>");
                        strHTML.Append("<td  align='right' style='border:thin'>" + string.Format("{0:C2}", dr["Reserve_Expense"]) + "</td>");
                        strHTML.Append("<td  align='right' style='border:thin'>" + string.Format("{0:C2}", dr["Reserve_Total"]) + "</td> </tr>");
                        strHTML.Append("<tr><td  align='left' style='border:thin'><b>Paid</b></td>");
                        strHTML.Append("<td  align='right' style='border:thin'>" + string.Format("{0:C2}", dr["Paid_Indemnity"]) + "</td>");
                        strHTML.Append("<td  align='right' style='border:thin'>" + string.Format("{0:C2}", dr["Paid_Medical"]) + "</td>");
                        strHTML.Append("<td  align='right' style='border:thin'>" + string.Format("{0:C2}", dr["Paid_Expense"]) + "</td>");
                        strHTML.Append("<td  align='right' style='border:thin'>" + string.Format("{0:C2}", dr["Paid_Total"]) + "</td></tr>");
                        strHTML.Append(" <tr><td  align='left' style='border:thin'><b>Outstanding</b></td>");
                        strHTML.Append("<td  align='right' style='border:thin'>" + string.Format("{0:C2}", dr["Out_Indemnity"]) + "</td>");
                        strHTML.Append("<td  align='right' style='border:thin'>" + string.Format("{0:C2}", dr["Out_Medical"]) + "</td>");
                        strHTML.Append("<td  align='right' style='border:thin'>" + string.Format("{0:C2}", dr["Out_Expense"]) + "</td>");
                        strHTML.Append("<td  align='right' style='border:thin'>" + string.Format("{0:C2}", dr["Out_Total"]) + "</td>");
                        strHTML.Append(" </tr></table></td>");
                        strHTML.Append("<td style='border:thin'>" + Convert.ToString(dr["Resignation"]) + "</td>");
                        strHTML.Append("<td align='right' style='border:thin'>" + string.Format("{0:C2}", dr["Settled_Amount"]) + "</td>");
                        //strHTML.Append("<td style='border:thin'>" + Convert.ToString(dr["Who_Approved"]).Replace("</br>", " , ") + "</td>");
                        strHTML.Append("<td style='border:thin'>" + Convert.ToString(dr["Who_Approved"]).Replace("<br/>", " , ") + "</td>");
                        strHTML.Append("</tr></table></td>");
                        strHTML.Append("</tr>");
                    }
                }
                else
                {
                    //Add No record found line for year
                    strHTML.Append("<tr><td align='left' colspan='5' style='border:thin'>No Record Found!</td></tr>");
                }
                strHTML.Append("</table>");

                #endregion

                //Write HTML in to HtmlWriter
                htmlWrite.WriteLine(strHTML.ToString());
                //Send Mail
                SendMail("Risk Management Worksheet", "Risk_Management_Worksheet_Report.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);

            }
        }




        //Report 59
        private void BindInspectionLagTime(DataRow drReportSchedule)
        {
            decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
            decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
            decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

            //Get Report criteria for the scheduled report
            DataTable dtFilter = Report.SelectFilterCriteria(59, pK_Schedule_ID).Tables[0];
            if (dtFilter.Rows.Count > 0)
            {
                //Get the recipient from the recipient list 
                DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                //Get the user who has scheduled the report
                DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                String strFirstName, strLastName, strMailFrom;
                strFirstName = strLastName = strMailFrom = "";
                if (dtUser.Rows.Count > 0)
                {
                    strFirstName = Convert.ToString(dtUser.Rows[0]["FIRST_NAME"]).Trim();
                    strLastName = Convert.ToString(dtUser.Rows[0]["LAST_NAME"]).Trim();
                    strMailFrom = Convert.ToString(dtUser.Rows[0]["Email"]).Trim();
                }
                string strRegion = Convert.ToString(dtFilter.Rows[0]["Region"]).Trim();
                string strMarket = null;
                if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Market"])))
                {
                    strMarket = Convert.ToString(dtFilter.Rows[0]["Market"]).Trim();
                }
                string strDBA = Convert.ToString(dtFilter.Rows[0]["DBA"]).Trim();
                string strInspector = Convert.ToString(dtFilter.Rows[0]["Inspector_Name"]).Trim();
                string strInspectionArea = Convert.ToString(dtFilter.Rows[0]["InspectionArea"]).Trim();
                string strLagDayOption = Convert.ToString(dtFilter.Rows[0]["LagDayOption"]).Trim();

                DateTime? dtInspection_Date_From;
                DateTime? dtInspection_Date_To;
                if (dtFilter.Rows[0]["Inspection_Date_From"] != DBNull.Value)
                    dtInspection_Date_From = Convert.ToDateTime(dtFilter.Rows[0]["Inspection_Date_From"]);
                else
                    dtInspection_Date_From = null;
                if (dtFilter.Rows[0]["Inspection_Date_To"] != DBNull.Value)
                    dtInspection_Date_To = Convert.ToDateTime(dtFilter.Rows[0]["Inspection_Date_To"]);
                else
                    dtInspection_Date_To = null;

                //Get the all Unique records for Selected group (default - last name -sort) by search criteria
                DataSet dsResult = Report.GetInspectionLagTime(strRegion, strMarket, strDBA, strInspectionArea, strInspector, dtInspection_Date_From, dtInspection_Date_To, strLagDayOption);

                //Create HTML for the report and wirte into HTML Write object
                StringBuilder strHTML = new StringBuilder();
                System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                #region "Report Title"

                //Retrieve Market Values
                string strMarketString = string.Empty;
                if (string.IsNullOrEmpty(strMarket))
                {
                    strMarketString = "All Market";
                }
                else
                {
                    string[] strMar = strMarket.Split(Convert.ToChar(","));
                    for (int i = 0; i < strMar.Length; i++)
                    {
                        strMarketString += Report.SelectMarketInfoById(Convert.ToDecimal(strMar[i].ToString())).Tables[0].Rows[0]["Market"].ToString() + ",";
                    }
                    strMarketString = strMarketString.TrimEnd(',');
                }

                //Add Report Title and Schedule Date
                strHTML.Append("<table><tr><td colspan='7'>");
                strHTML.Append("<br />");
                strHTML.Append("<b>Report Title : Inspection Distribution Lag Time</b>");
                strHTML.Append("<br /><br />");
                strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                strHTML.Append("<br />");
                strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"].ToString());
                strHTML.Append("<br />");
                strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));
                strHTML.Append("</td></tr></table>");

                //Add Report Filter Criteria 
                strHTML.Append("<br /><br /><table> <tr> <td>");
                strHTML.Append("<b>Report Filters </b>");
                strHTML.Append("<br /><table> <tr> <td colspan='8'>");
                strHTML.Append("Region   : " + strRegion);
                strHTML.Append("</td> </tr>");
                strHTML.Append("<br /><table> <tr> <td colspan='8'>");
                strHTML.Append("Market        : " + strMarketString);
                strHTML.Append("</td> </tr>");
                strHTML.Append("<tr> <td colspan='8'>");
                strHTML.Append("Location D/B/A   : " + ((!string.IsNullOrEmpty(strDBA)) ? Report.GetCommaSeperatedDescFromVal("LU_Location", "dba", "PK_LU_Location_ID", strDBA) : ""));
                strHTML.Append("</td> </tr>");
                strHTML.Append("<tr> <td colspan='8'>");
                strHTML.Append("Inspector Name   : " + strInspector);
                strHTML.Append("</td> </tr>");
                strHTML.Append("<tr> <td colspan='8'>");
                strHTML.Append("Inspection Date From   : " + Convert.ToString(dtInspection_Date_From));
                strHTML.Append("</td> </tr>");
                strHTML.Append("<tr> <td colspan='8'>");
                strHTML.Append("Inspection Date To   : " + Convert.ToString(dtInspection_Date_To));
                strHTML.Append("</td> </tr>");
                strHTML.Append("<tr> <td colspan='8'>");
                strHTML.Append("Inspection Area   : " + ((!string.IsNullOrEmpty(strInspectionArea)) ? Report.GetCommaSeperatedDescFromVal("LU_Inspection_Area", "Fld_desc", "PK_LU_Inspection_Area", strInspectionArea) : ""));
                strHTML.Append("</td> </tr>");
                strHTML.Append("<tr> <td colspan='8'>");
                string strLagTimeDesc = "";
                if (strLagDayOption.IndexOf("1") > -1)
                    strLagTimeDesc = "<=2";
                if (strLagDayOption.IndexOf("2") > -1)
                    strLagTimeDesc = strLagTimeDesc + (strLagTimeDesc != "" ? ", " : "") + "3 to 5";
                if (strLagDayOption.IndexOf("3") > -1)
                    strLagTimeDesc = strLagTimeDesc + (strLagTimeDesc != "" ? ", " : "") + "6 to 10";
                if (strLagDayOption.IndexOf("4") > -1)
                    strLagTimeDesc = strLagTimeDesc + (strLagTimeDesc != "" ? ", " : "") + "11 to 15";
                if (strLagDayOption.IndexOf("5") > -1)
                    strLagTimeDesc = strLagTimeDesc + (strLagTimeDesc != "" ? ", " : "") + ">15";

                strHTML.Append("Lag Time in Days  : " + strLagTimeDesc);
                strHTML.Append("</td> </tr>");
                strHTML.Append("<tr> <td colspan='8'>");
                strHTML.Append("</td></tr></table> ");

                #endregion

                #region "Report Grid header"
                //Top Header
                strHTML.Append("<table border='1'>");
                strHTML.Append("<tr style='font-weight: bold;' valign='bottom'>");
                strHTML.Append("<td align='left' >Sonic Automotive</td>");
                strHTML.Append("<td align='center' colspan='5'>Inspection Distribution Lag Time</td>");
                strHTML.Append("<td align='right' > " + DateTime.Now.ToString() + " </td>");
                strHTML.Append("</tr>");

                //Sub Header
                strHTML.Append("<tr valign='bottom' style='font-weight: bold'>");
                strHTML.Append("<td width='150'>Region</td>");
                strHTML.Append("<td width='150'>Inspector</td>");
                strHTML.Append("<td width='150'>Location D/B/A</td>");
                strHTML.Append("<td width='150'>Inspection Area</td>");
                strHTML.Append("<td width='150'>Inspection Date</td>");
                strHTML.Append("<td width='160'>Date Inspection Report was Initially Distributed</td>");
                strHTML.Append("<td width='150' align='right'>Lag Time in Days</td>");

                strHTML.Append("</tr>");

                //Check Whether Record Exists or Not
                if (dsResult != null && dsResult.Tables.Count > 0 && dsResult.Tables[0].Rows.Count > 0)
                {
                    foreach (DataRow dr in dsResult.Tables[0].Rows)
                    {
                        strHTML.Append("<tr valign='top'>");

                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["Region"]) + "</td>");
                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["Inspector_Name"]) + "</td>");
                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["dba"]) + "</td>");
                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["FLD_Desc"]) + "</td>");
                        strHTML.Append("<td width='150'>" + FormatDBNullDateToDisplay(dr["Date"]) + "</td>");
                        strHTML.Append("<td width='160'>" + FormatDBNullDateToDisplay(dr["Date_Report_Initially_Distibuted"]) + "</td>");
                        strHTML.Append("<td width='150' align='right'>" + string.Format("{0:N0}", dr["Lag_Time"]) + "</td>");
                        strHTML.Append("</tr>");
                    }
                }
                else
                {
                    //Add No record found line for year
                    strHTML.Append("<tr><td align='left' colspan='5'>No Record Found!</td></tr>");
                }
                strHTML.Append("</table>");

                #endregion

                //Write HTML in to HtmlWriter
                htmlWrite.WriteLine(strHTML.ToString());
                //Send Mail
                SendMail("Inspection Distribution Lag Time", "Inspection_Distribution_Lag_Time.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
            }
        }

        private static string TotalAggregateScore(string strscore)
        {
            string strTotalAggregateScore = "";
            int TotalScore = 0;
            int.TryParse(Convert.ToString(strscore), out TotalScore);
            if (TotalScore >= 25)
                strTotalAggregateScore = "Platinum";
            else if (TotalScore >= 20 && TotalScore < 25)
                strTotalAggregateScore = "Gold";
            else if (TotalScore >= 15 && TotalScore < 20)
                strTotalAggregateScore = "Silver";
            else if (TotalScore >= 10 && TotalScore < 15)
                strTotalAggregateScore = "Bronze";
            else if (TotalScore < 10)
                strTotalAggregateScore = "Tin";
            return strTotalAggregateScore;
        }

        private static string ResultingScore(string strscore)
        {
            string strResultingScore = "";
            double decTotalScore = 0;
            double.TryParse(Convert.ToString(strscore), out decTotalScore);
            if (decTotalScore >= 5)
                strResultingScore = "Platinum";
            else if (decTotalScore >= 4 && decTotalScore < 5)
                strResultingScore = "Gold";
            else if (decTotalScore >= 3 && decTotalScore < 4)
                strResultingScore = "Silver";
            else if (decTotalScore >= 2 && decTotalScore < 3)
                strResultingScore = "Bronze";
            else if (decTotalScore < 2)
                strResultingScore = "Tin";
            return strResultingScore;
        }

        private static string Final_ScoreCard(string strscore)
        {
            string strResultingScore = "";
            double decTotalScore = 0;
            double.TryParse(Convert.ToString(strscore), out decTotalScore);

            if (decTotalScore > 94.5 && decTotalScore <= 100)
                strResultingScore = decTotalScore + " (Platinum)";
            else if (decTotalScore > 89.5 && decTotalScore <= 94.5)
                strResultingScore = decTotalScore + " (Gold)";
            else if (decTotalScore > 79.5 && decTotalScore <= 89.5)
                strResultingScore = decTotalScore + " (Silver)";
            else if (decTotalScore > 69.5 && decTotalScore <= 79.5)
                strResultingScore = decTotalScore + " (Bronze)";
            else if (decTotalScore >= 0 && decTotalScore <= 69.5)
                strResultingScore = decTotalScore + " (Tin)";

            return strResultingScore;
        }

        //Report 62
        private void BindFROIRecapReport(DataRow drReportSchedule)
        {
            decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
            decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
            decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

            //Get Report criteria for the scheduled report
            DataTable dtFilter = Report.SelectFilterCriteria(62, pK_Schedule_ID).Tables[0];
            if (dtFilter.Rows.Count > 0)
            {
                try
                {
                    //Get the recipient from the recipient list 
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];
                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = Convert.ToString(dtUser.Rows[0]["FIRST_NAME"]).Trim();
                        strLastName = Convert.ToString(dtUser.Rows[0]["LAST_NAME"]).Trim();
                        strMailFrom = Convert.ToString(dtUser.Rows[0]["Email"]).Trim();
                    }

                    string strRegion = Convert.ToString(dtFilter.Rows[0]["Region"]).Trim();
                    string strMarket = null;
                    if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Market"])))
                    {
                        strMarket = Convert.ToString(dtFilter.Rows[0]["Market"]).Trim();
                    }
                    string strDBA = Convert.ToString(dtFilter.Rows[0]["DBA"]).Trim();
                    string strCategory = Convert.ToString(dtFilter.Rows[0]["First_Report_Category"]).Trim();


                    DateTime? dtIncident_Date_From;
                    DateTime? dtIncident_Date_To;
                    if (dtFilter.Rows[0]["Inspection_Date_From"] != DBNull.Value)
                        dtIncident_Date_From = Convert.ToDateTime(dtFilter.Rows[0]["Inspection_Date_From"]);
                    else
                        dtIncident_Date_From = null;
                    if (dtFilter.Rows[0]["Inspection_Date_To"] != DBNull.Value)
                        dtIncident_Date_To = Convert.ToDateTime(dtFilter.Rows[0]["Inspection_Date_To"]);
                    else
                        dtIncident_Date_To = null;

                    DataSet dsResult = Report.GetFroiRecapReport(strRegion, strMarket, strDBA, dtIncident_Date_From, dtIncident_Date_To, strCategory);

                    StringBuilder strHTML = new StringBuilder();
                    System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                    System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                    #region "Report Title"

                    //Retrieve Market Values
                    string strMarketString = string.Empty;
                    if (string.IsNullOrEmpty(strMarket))
                    {
                        strMarketString = "All Market";
                    }
                    else
                    {
                        string[] strMar = strMarket.Split(Convert.ToChar(","));
                        for (int i = 0; i < strMar.Length; i++)
                        {
                            strMarketString += Report.SelectMarketInfoById(Convert.ToDecimal(strMar[i].ToString())).Tables[0].Rows[0]["Market"].ToString() + ",";
                        }
                        strMarketString = strMarketString.TrimEnd(',');
                    }

                    //Add Report Title and Schedule Date
                    strHTML.Append("<table><tr><td colspan='9'>");
                    strHTML.Append("<br />");
                    strHTML.Append("<b>Report Title : FROI Recapt Report</b>");
                    strHTML.Append("<br /><br />");
                    strHTML.Append("Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                    strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                    strHTML.Append("<br />");
                    strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"].ToString());
                    strHTML.Append("<br />");
                    strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                    //Add Report Filter Criteria 
                    strHTML.Append("<br /><br />");
                    strHTML.Append("<b>Report Filters </b>");
                    strHTML.Append("<br />");
                    strHTML.Append("Region   : " + strRegion.Replace("'", ""));
                    strHTML.Append("<br />");
                    strHTML.Append("Market        : " + strMarketString);
                    strHTML.Append("<br />");
                    strHTML.Append("Location D/B/A   : " + strDBA.Replace("'", ""));
                    strHTML.Append("<br />");
                    strHTML.Append("Date of Incident From   : " + Convert.ToString(dtIncident_Date_From));
                    strHTML.Append("<br />");
                    strHTML.Append("Date of Incident To   : " + Convert.ToString(dtIncident_Date_To));
                    strHTML.Append("<br /><br /><br />");
                    strHTML.Append("</td></tr></table>");

                    #endregion

                    #region "Report Grid header"
                    //Top Header
                    strHTML.Append("<table border='1'>");
                    strHTML.Append("<tr style='font-weight: bold;' valign='bottom'>");
                    strHTML.Append("<td align='left' >Sonic Automotive</td>");
                    strHTML.Append("<td align='center' colspan='7'>FROI Recap Report</td>");
                    strHTML.Append("<td align='right' > " + DateTime.Now.ToString() + " </td>");
                    strHTML.Append("</tr>");
                    strHTML.Append("</table>");


                    for (int i = 0; i < dsResult.Tables.Count; i = i + 2)
                    {
                        string strReportType = dsResult.Tables[i].Rows[0][0].ToString();
                        DataTable dtTemp = new DataTable();
                        switch (strReportType)
                        {
                            case "AL":
                                #region Generate AL region
                                strHTML.Append("<table><tr><td>&nbsp;</td></tr>");
                                strHTML.Append("<tr><td>&nbsp;</td></tr>");
                                strHTML.Append("<tr><td><b>AL FROI</b></td></tr>");
                                strHTML.Append("<tr><td>&nbsp;</td></tr>");
                                strHTML.Append("<table>");
                                //Sub Header
                                strHTML.Append("<table border='1'><tr valign='bottom' style='font-weight: bold'>");
                                strHTML.Append("<td width='150'>Location</td>");
                                strHTML.Append("<td width='100' align='right'>Location Number</td>");
                                strHTML.Append("<td width='120' align='right'>FROI Number</td>");
                                strHTML.Append("<td width='100' align='right'>Date Of Loss</td>");
                                strHTML.Append("<td width='250'>Description of Loss</td>");
                                strHTML.Append("<td width='50' align='center'>Vehicle SubType<br style=\"mso-data-placement:same-cell;\"/>Vehicle Make<br style=\"mso-data-placement:same-cell;\"/>Vehicle Model<br style=\"mso-data-placement:same-cell;\"/>Vehicle Year</td>");
                                strHTML.Append("<td width='50'>Were Policed Notified?</td>");
                                strHTML.Append("<td width='50'>Is there a Security Video<br style=\"mso-data-placement:same-cell;\"/>Surveillance System?</td>");
                                strHTML.Append("<td width='250'>Comments</td>");
                                strHTML.Append("</tr>");
                                dtTemp = dsResult.Tables[i + 1];
                                if (dtTemp.Rows.Count > 0)
                                {
                                    foreach (DataRow dr in dtTemp.Rows)
                                    {
                                        strHTML.Append("<tr valign='top'>");
                                        strHTML.Append("<td >" + Convert.ToString(dr["dba"]) + "</td>");
                                        strHTML.Append("<td align='right'>" + Convert.ToString(dr["Sonic_Location_Code"]) + "</td>");
                                        strHTML.Append("<td align='right'>" + Convert.ToString(dr["AL_FR_Number"]) + "</td>");
                                        strHTML.Append("<td align='right'>" + FormatDBNullDateToDisplay(dr["Date_Of_Loss"]) + "</td>");
                                        strHTML.Append("<td >" + Convert.ToString(dr["Description_Of_Loss"]) + "</td>");
                                        strHTML.Append("<td >" + Convert.ToString(dr["Vehicle"]).Replace("</br>", "<br style=\"mso-data-placement:same-cell;\"/>") + "</td>");
                                        strHTML.Append("<td >" + Convert.ToString(dr["Were_Police_Notified"]) + "</td>");
                                        strHTML.Append("<td >" + Convert.ToString(dr["Security_Video_System"]) + "</td>");
                                        strHTML.Append("<td >" + Convert.ToString(dr["Comments"]) + "</td>");
                                        strHTML.Append("</tr>");
                                    }
                                }
                                else
                                {
                                    //Add No record found line for year
                                    strHTML.Append("<tr><td align='left' style='border:thin' colspan='5'>No Record Found!</td></tr>");
                                }
                                strHTML.Append("</table>");

                                #endregion
                                break;
                            case "DPD":
                                #region Generate DPD region
                                strHTML.Append("<table><tr><td>&nbsp;</td></tr>");
                                strHTML.Append("<tr><td>&nbsp;</td></tr>");
                                strHTML.Append("<tr><td><b>DPD FROI</b></td></tr>");
                                strHTML.Append("<tr><td>&nbsp;</td></tr>");
                                strHTML.Append("<table>");
                                //Sub Header

                                strHTML.Append("<table border='1'><tr valign='bottom' style='font-weight: bold'>");
                                strHTML.Append("<td width='150'>Location</td>");
                                strHTML.Append("<td width='100' align='right'>Location Number</td>");
                                strHTML.Append("<td width='120' align='right'>FROI Number</td>");
                                strHTML.Append("<td width='100'>Date Of Loss</td>");
                                strHTML.Append("<td width='100'>Cause Of Loss</td>");
                                strHTML.Append("<td width='250'>Loss Description</td>");
                                strHTML.Append("<td width='80' align='center'>Vehicle Make<br style=\"mso-data-placement:same-cell;\">Vehicle Model<br style=\"mso-data-placement:same-cell;\"/>Vehicle Year<br style=\"mso-data-placement:same-cell;\"/>Invoice Value</td>");
                                strHTML.Append("<td width='80'>Were Policed Notified?</td>");
                                strHTML.Append("<td width='80'>Is there a Security Video<br style=\"mso-data-placement:same-cell;\"/>Surveillance System?</td>");
                                strHTML.Append("<td width='100'>Recovered<br style=\"mso-data-placement:same-cell;\">Damage Amount<br style=\"mso-data-placement:same-cell;\"/>Recovered Amount</td>");
                                strHTML.Append("<td width='250'>Comments</td>");
                                strHTML.Append("</tr>");
                                dtTemp = dsResult.Tables[i + 1];
                                if (dtTemp.Rows.Count > 0)
                                {
                                    foreach (DataRow dr in dtTemp.Rows)
                                    {
                                        strHTML.Append("<tr valign='top'>");
                                        strHTML.Append("<td >" + Convert.ToString(dr["dba"]) + "</td>");
                                        strHTML.Append("<td align='right'>" + Convert.ToString(dr["Sonic_Location_Code"]) + "</td>");
                                        strHTML.Append("<td align='right'>" + Convert.ToString(dr["DPD_FR_Number"]) + "</td>");
                                        strHTML.Append("<td >" + FormatDBNullDateToDisplay(dr["Date_Of_Loss"]) + "</td>");
                                        strHTML.Append("<td >" + Convert.ToString(dr["Cause_Of_Loss"]).Replace("</br>", "<br style=\"mso-data-placement:same-cell;\"/>") + "</td>");
                                        strHTML.Append("<td >" + Convert.ToString(dr["Loss_Description"]) + "</td>");
                                        strHTML.Append("<td >" + Convert.ToString(dr["Vehicle"]).Replace("</br>", "<br style=\"mso-data-placement:same-cell;\"/>") + "</td>");
                                        strHTML.Append("<td >" + Convert.ToString(dr["Were_Police_Notified"]) + "</td>");
                                        strHTML.Append("<td >" + Convert.ToString(dr["Security_Video_System"]) + "</td>");
                                        strHTML.Append("<td >" + Convert.ToString(dr["Recovered"]).Replace("</br>", "<br style=\"mso-data-placement:same-cell;\"/>") + "</td>");
                                        strHTML.Append("<td >" + Convert.ToString(dr["Comments"]) + "</td>");
                                        strHTML.Append("</tr>");
                                    }
                                }
                                else
                                {
                                    //Add No record found line for year
                                    strHTML.Append("<tr><td align='left' style='border:thin' colspan='5'>No Record Found!</td></tr>");
                                }
                                strHTML.Append("</table>");
                                #endregion
                                break;
                            case "NS":
                                #region Generate NS region

                                strHTML.Append("<table><tr><td>&nbsp;</td></tr>");
                                strHTML.Append("<tr><td>&nbsp;</td></tr>");
                                strHTML.Append("<tr><td><b>NS FROI</b></td></tr>");
                                strHTML.Append("<tr><td>&nbsp;</td></tr>");
                                strHTML.Append("<table>");
                                //Sub Header

                                strHTML.Append("<table border='1'><tr valign='bottom' style='font-weight: bold'>");
                                strHTML.Append("<td width='150'>Location</td>");
                                strHTML.Append("<td width='100' align='right'>Location Number</td>");
                                strHTML.Append("<td width='120' align='right'>FROI Number</td>");
                                strHTML.Append("<td width='120'>Associate Name</td>");
                                strHTML.Append("<td width='100'>Date Of Loss</td>");
                                strHTML.Append("<td width='300'>Description Of Incident</td>");
                                strHTML.Append("<td width='100'>Taken By Emergency Transportation?</td>");
                                strHTML.Append("<td width='250'>Comments</td>");
                                strHTML.Append("</tr>");
                                dtTemp = dsResult.Tables[i + 1];
                                if (dtTemp.Rows.Count > 0)
                                {
                                    foreach (DataRow dr in dtTemp.Rows)
                                    {
                                        strHTML.Append("<tr valign='top'>");
                                        strHTML.Append("<td >" + Convert.ToString(dr["dba"]) + "</td>");
                                        strHTML.Append("<td align='right'>" + Convert.ToString(dr["Sonic_Location_Code"]) + "</td>");
                                        strHTML.Append("<td align='right'>" + Convert.ToString(dr["WC_FR_Number"]) + "</td>");
                                        strHTML.Append("<td >" + Convert.ToString(dr["Associate_Name"]) + "</td>");
                                        strHTML.Append("<td >" + FormatDBNullDateToDisplay(dr["Date_Of_Incident"]) + "</td>");
                                        strHTML.Append("<td >" + Convert.ToString(dr["Description_Of_Incident"]) + "</td>");
                                        strHTML.Append("<td >" + Convert.ToString(dr["Taken_By_Emergency_Transportation"]) + "</td>");
                                        strHTML.Append("<td >" + Convert.ToString(dr["Comments"]) + "</td>");
                                        strHTML.Append("</tr>");
                                    }
                                }
                                else
                                {
                                    //Add No record found line for year
                                    strHTML.Append("<tr><td align='left' style='border:thin' colspan='5'>No Record Found!</td></tr>");
                                }
                                strHTML.Append("</table>");

                                #endregion
                                break;
                            case "PL":
                                #region Generate PL region

                                strHTML.Append("<table><tr><td>&nbsp;</td></tr>");
                                strHTML.Append("<tr><td>&nbsp;</td></tr>");
                                strHTML.Append("<tr><td><b>PL FROI</b></td></tr>");
                                strHTML.Append("<tr><td>&nbsp;</td></tr>");
                                strHTML.Append("<table>");
                                //Sub Header
                                strHTML.Append("<table border='1'><tr valign='bottom' style='font-weight: bold'>");
                                strHTML.Append("<td width='150'>Location</td>");
                                strHTML.Append("<td width='100' align='right'>Location Number</td>");
                                strHTML.Append("<td width='120' align='right'>FROI Number</td>");
                                strHTML.Append("<td width='100'>Date Of Loss</td>");
                                strHTML.Append("<td width='300'>Description Of Loss</td>");
                                strHTML.Append("<td width='80'>Were Policed Notified?</td>");
                                strHTML.Append("<td width='250'>Comments</td>");
                                strHTML.Append("</tr>");
                                dtTemp = dsResult.Tables[i + 1];
                                if (dtTemp.Rows.Count > 0)
                                {
                                    foreach (DataRow dr in dtTemp.Rows)
                                    {
                                        strHTML.Append("<tr valign='top'>");
                                        strHTML.Append("<td >" + Convert.ToString(dr["dba"]) + "</td>");
                                        strHTML.Append("<td align='right'>" + Convert.ToString(dr["Sonic_Location_Code"]) + "</td>");
                                        strHTML.Append("<td align='right'>" + Convert.ToString(dr["PL_FR_Number"]) + "</td>");
                                        strHTML.Append("<td >" + FormatDBNullDateToDisplay(dr["Date_Of_Loss"]) + "</td>");
                                        strHTML.Append("<td >" + Convert.ToString(dr["Description_of_Loss"]) + "</td>");
                                        strHTML.Append("<td >" + Convert.ToString(dr["Were_Police_Notified"]) + "</td>");
                                        strHTML.Append("<td >" + Convert.ToString(dr["Comments"]) + "</td>");
                                        strHTML.Append("</tr>");
                                    }
                                }
                                else
                                {
                                    //Add No record found line for year
                                    strHTML.Append("<tr><td align='left' style='border:thin' colspan='5'>No Record Found!</td></tr>");
                                }
                                strHTML.Append("</table>");

                                #endregion
                                break;
                            case "Property":
                                #region Generate Property region

                                strHTML.Append("<table><tr><td>&nbsp;</td></tr>");
                                strHTML.Append("<tr><td>&nbsp;</td></tr>");
                                strHTML.Append("<tr><td><b>Property FROI</b></td></tr>");
                                strHTML.Append("<tr><td>&nbsp;</td></tr>");
                                strHTML.Append("<table>");
                                //Sub Header
                                strHTML.Append("<table border='1'><tr valign='bottom' style='font-weight: bold'>");
                                strHTML.Append("<td width='150'>Location</td>");
                                strHTML.Append("<td width='100' align='right'>Location Number</td>");
                                strHTML.Append("<td width='120' align='right'>FROI Number</td>");
                                strHTML.Append("<td width='100'>Date Of Loss</td>");
                                strHTML.Append("<td width='120'>Type Of Loss</td>");
                                strHTML.Append("<td width='300'>Description Of Loss</td>");
                                strHTML.Append("<td width='120'>Total Estimated Cost</td>");
                                strHTML.Append("<td width='100'>Is there a Security Video<br style=\"mso-data-placement:same-cell;\">Surveillance System?</td>");
                                strHTML.Append("<td width='250'>Comments</td>");
                                strHTML.Append("</tr>");
                                dtTemp = dsResult.Tables[i + 1];
                                if (dtTemp.Rows.Count > 0)
                                {
                                    foreach (DataRow dr in dtTemp.Rows)
                                    {
                                        strHTML.Append("<tr valign='top'>");
                                        strHTML.Append("<td >" + Convert.ToString(dr["dba"]) + "</td>");
                                        strHTML.Append("<td align='right'>" + Convert.ToString(dr["Sonic_Location_Code"]) + "</td>");
                                        strHTML.Append("<td align='right'>" + Convert.ToString(dr["Property_FR_Number"]) + "</td>");
                                        strHTML.Append("<td >" + FormatDBNullDateToDisplay(dr["Date_Of_Loss"]) + "</td>");
                                        strHTML.Append("<td >" + Convert.ToString(dr["Type_of_Loss"]).Replace("</br>", "<br style=\"mso-data-placement:same-cell;\">") + "</td>");
                                        strHTML.Append("<td >" + Convert.ToString(dr["Description_of_Loss"]) + "</td>");
                                        strHTML.Append("<td >" + Convert.ToString(dr["Estimated_Cost"]).Replace("</br>", "<br style=\"mso-data-placement:same-cell;\">") + "</td>");
                                        strHTML.Append("<td >" + Convert.ToString(dr["Security_Video_Surveillance"]) + "</td>");
                                        strHTML.Append("<td >" + Convert.ToString(dr["Comments"]) + "</td>");
                                        strHTML.Append("</tr>");
                                    }
                                }
                                else
                                {
                                    //Add No record found line for year
                                    strHTML.Append("<tr><td align='left' style='border:thin' colspan='5'>No Record Found!</td></tr>");
                                }
                                strHTML.Append("</table>");

                                #endregion
                                break;
                            case "WC":
                                #region Generate WC region

                                strHTML.Append("<table><tr><td>&nbsp;</td></tr>");
                                strHTML.Append("<tr><td>&nbsp;</td></tr>");
                                strHTML.Append("<tr><td><b>WC FROI</b></td></tr>");
                                strHTML.Append("<tr><td>&nbsp;</td></tr>");
                                strHTML.Append("<table>");
                                //Sub Header
                                strHTML.Append("<table border='1'><tr valign='bottom' style='font-weight: bold'>");
                                strHTML.Append("<td width='150'>Location</td>");
                                strHTML.Append("<td width='100' align='right'>Location Number</td>");
                                strHTML.Append("<td width='120' align='right'>FROI Number</td>");
                                strHTML.Append("<td width='120'>Associate Name</td>");
                                strHTML.Append("<td width='100'>Date Of Loss</td>");
                                strHTML.Append("<td width='300'>Description Of Incident</td>");
                                strHTML.Append("<td width='100'>Taken By Emergency<br style=\"mso-data-placement:same-cell;\">Transportation?</td>");
                                strHTML.Append("<td width='250'>Comments</td>");
                                strHTML.Append("</tr>");
                                dtTemp = dsResult.Tables[i + 1];
                                if (dtTemp.Rows.Count > 0)
                                {
                                    foreach (DataRow dr in dtTemp.Rows)
                                    {
                                        strHTML.Append("<tr valign='top'>");
                                        strHTML.Append("<td >" + Convert.ToString(dr["dba"]) + "</td>");
                                        strHTML.Append("<td  align='right'>" + Convert.ToString(dr["Sonic_Location_Code"]) + "</td>");
                                        strHTML.Append("<td align='right'>" + Convert.ToString(dr["WC_FR_Number"]) + "</td>");
                                        strHTML.Append("<td >" + Convert.ToString(dr["Associate_Name"]) + "</td>");
                                        strHTML.Append("<td >" + FormatDBNullDateToDisplay(dr["Date_Of_Incident"]) + "</td>");
                                        strHTML.Append("<td >" + Convert.ToString(dr["Description_Of_Incident"]) + "</td>");
                                        strHTML.Append("<td >" + Convert.ToString(dr["Taken_By_Emergency_Transportation"]) + "</td>");
                                        strHTML.Append("<td >" + Convert.ToString(dr["Comments"]) + "</td>");
                                        strHTML.Append("</tr>");
                                    }
                                }
                                else
                                {
                                    //Add No record found line for year
                                    strHTML.Append("<tr><td align='left' style='border:thin' colspan='5'>No Record Found!</td></tr>");
                                }
                                strHTML.Append("</table>");

                                #endregion
                                break;
                        }


                    }


                    #endregion

                    //Write HTML in to HtmlWriter
                    htmlWrite.WriteLine(strHTML.ToString());
                    //Send Mail
                    SendMail("FROI Recap Report", "FROI_Recapt_Report.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
                }
                catch (Exception ex)
                {
                    EventLog.WriteEntry("Error Occurred in FROI Recap Report on " + dtSchduleDate.ToString() + ", " + ex.Message + ",Stack Trace:" + ex.StackTrace);
                }
            }
        }

        //Report 63
        private void BindACI_AdHocReportWriter(DataRow drReportSchedule)
        {
            IDataReader Reader = null;
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);
                string strReportSchedulerName = Convert.ToString(drReportSchedule["ReportSchedulerName"]);
                //decimal pK_Schedule_ID = 6;
                //decimal Fk_RecipientList = 2;
                //decimal FK_Security_Id = 1;
                //string strReportSchedulerName = "test";
                //Get Report criteria for the scheduled report
                DataSet ds = new DataSet();
                ds = Report.SelectFilterCriteria(63, pK_Schedule_ID);
                if (ds != null && ds.Tables[0].Rows.Count > 0)
                {
                    DataTable dtFilter = ds.Tables[0];
                    if (dtFilter.Rows.Count > 0)
                    {
                        string strCoverageType = string.Empty, strOutPutFields = string.Empty, strFirstGroupBy = string.Empty, strSecGroupBy = string.Empty;
                        DateTime? dtPriorValuationDate = null;

                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["PriorValuationDate"])))
                            dtPriorValuationDate = Convert.ToDateTime(dtFilter.Rows[0]["PriorValuationDate"]);

                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["PriorValuation_RelativeDate"])))
                        {
                            // set Relative Date From criteria
                            AdHocReportHelper.RaltiveDates RelType = (AdHocReportHelper.RaltiveDates)Enum.Parse(typeof(AdHocReportHelper.RaltiveDates), Convert.ToString(dtFilter.Rows[0]["PriorValuation_RelativeDate"]));
                            dtPriorValuationDate = AdHocReportHelper.GetRelativeDate(RelType);
                        }

                        decimal _dcSelectedReport = 0;

                        List<ERIMS_DAL.AdHocFilter> lstFilter = new List<AdHocFilter>();

                        _dcSelectedReport = Convert.ToDecimal(dtFilter.Rows[0]["Pk_AdHocReport"]);
                        lstFilter = new ERIMS_DAL.AdHocFilter().GetAdHocReportFieldByPk(_dcSelectedReport);

                        ERIMS_DAL.AdHocReport ObjAdHocReport = new ERIMS_DAL.AdHocReport(_dcSelectedReport);

                        strOutPutFields = ObjAdHocReport.OutputFields;
                        string strFilterIDs = string.Empty;
                        for (int i = 0; i < lstFilter.Count; i++)
                        {
                            AdhocReportFields obj = new AdhocReportFields();
                            List<AdhocReportFields> lstAdhoc = obj.GetAdHocReportFieldByPk(Convert.ToDecimal(lstFilter[i].FK_AdHocReportFields));
                            strFilterIDs += lstFilter[i].FK_AdHocReportFields + ",";
                        }
                        strFilterIDs = strFilterIDs.TrimEnd(',');

                        StringBuilder sbRecord = new StringBuilder();
                        if (dtFilter.Rows.Count > 0)
                        {
                            //Get the recipient from the recipient list 
                            DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];
                            DataRow drFilterCriteria = dtFilter.Rows[0];
                            //Get the user who has scheduled the report
                            DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                            String strFirstName, strLastName, strMailFrom;
                            strFirstName = strLastName = strMailFrom = "";
                            if (dtUser.Rows.Count > 0)
                            {
                                strFirstName = Convert.ToString(dtUser.Rows[0]["FIRST_NAME"]).Trim();
                                strLastName = Convert.ToString(dtUser.Rows[0]["LAST_NAME"]).Trim();
                                strMailFrom = Convert.ToString(dtUser.Rows[0]["Email"]).Trim();
                            }
                            //Get Records in Reader
                            Reader = AdHocReportHelper.GetAdHocReportACI(strOutPutFields, BindGroupBy(ObjAdHocReport), dtPriorValuationDate, GetWhereCondition(lstFilter), BindOrderBy(ObjAdHocReport), strFilterIDs, FK_Security_Id, true);
                            //Get File path where Records Save.
                            string strFilePath = BindReport(ref sbRecord, Reader, ObjAdHocReport, lstFilter, strReportSchedulerName);

                            //If records found
                            if (File.Exists(strFilePath))
                            {
                                try
                                {
                                    isGrid = false;
                                    SendMail(strReportSchedulerName, strReportSchedulerName + ".xls", strFirstName, strLastName, strMailFrom, strFilePath, dtRecipients, FK_Security_Id);
                                    //isGrid = false;
                                    EventLog.WriteEntry("eRIMS_Sonic Scheduled Reports Sent successfully scheduled on " + dtSchduleDate.ToString());
                                }
                                catch (Exception ex)
                                {
                                    EventLog.WriteEntry("Error Occurred while sending eRIMS_Sonic Scheduled Reports on " + dtSchduleDate.ToString() + ", " + ex.Message + ",Stack Trace:" + ex.StackTrace);
                                }
                                finally
                                {
                                    dtRecipients.Dispose();
                                    dtUser.Dispose();
                                }
                            }
                        }
                    }
                }
            }

            catch (Exception ex)
            {
                //EventLog.WriteEntry("Error Occurred while sending eRIMS_Sonic Scheduled Reports on " + dtSchduleDate.ToString() + ", " + ex.Message);
                EventLog.WriteEntry("Error Occurred in ACI Adhoc Report on " + dtSchduleDate.ToString() + ", " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
        }

        //Report 64
        private void BindSafetyTrainingReport(DataRow drReportSchedule)
        {
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

                //Get Report criteria for the scheduled report
                DataTable dtFilter = Report.SelectFilterCriteria(64, pK_Schedule_ID).Tables[0];
                if (dtFilter.Rows.Count > 0)
                {
                    //Get the recipient from the recipient list 
                    DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                    //Get the user who has scheduled the report
                    DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                    String strFirstName, strLastName, strMailFrom;
                    strFirstName = strLastName = strMailFrom = "";
                    if (dtUser.Rows.Count > 0)
                    {
                        strFirstName = Convert.ToString(dtUser.Rows[0]["FIRST_NAME"]).Trim();
                        strLastName = Convert.ToString(dtUser.Rows[0]["LAST_NAME"]).Trim();
                        strMailFrom = Convert.ToString(dtUser.Rows[0]["Email"]).Trim();
                    }

                    string strYear = Convert.ToString(dtFilter.Rows[0]["Year"]).Trim();
                    string strRegion = null;
                    if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Region"])))
                        strRegion = Convert.ToString(dtFilter.Rows[0]["Region"]);

                    string strMarket = null;
                    if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["Market"])))
                    {
                        strMarket = Convert.ToString(dtFilter.Rows[0]["Market"]).Trim();
                    }
                    //Create HTML for the report and wirte into HTML Write object
                    StringBuilder strHTML = new StringBuilder();
                    System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                    System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                    #region "Report Title"

                    //Retrive Region
                    string strRegionString = string.Empty;
                    if (string.IsNullOrEmpty(strRegion))
                        strRegionString = "All Region";
                    else
                        strRegionString = strRegion;


                    //Retrieve Market Values
                    string strMarketString = string.Empty;
                    if (string.IsNullOrEmpty(strMarket))
                    {
                        strMarketString = "All Market";
                    }
                    else
                    {
                        string[] strMar = strMarket.Split(Convert.ToChar(","));
                        for (int i = 0; i < strMar.Length; i++)
                        {
                            strMarketString += Report.SelectMarketInfoById(Convert.ToDecimal(strMar[i].ToString())).Tables[0].Rows[0]["Market"].ToString() + ",";
                        }
                        strMarketString = strMarketString.TrimEnd(',');
                    }

                    //Add Report Title and Schedule Date
                    strHTML.Append("<table><tr><td colspan='8'>");

                    strHTML.Append("<br />");
                    strHTML.Append("<b>Report Title : Safety Training Report </b>");
                    strHTML.Append("<br /><br />");
                    strHTML.Append("Schedule Start Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat));
                    strHTML.Append("&nbsp;&nbsp;&nbsp;&nbsp;Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat));
                    strHTML.Append("<br />");
                    strHTML.Append("Recurring Period : " + drReportSchedule["Recurring_Period"].ToString());
                    strHTML.Append("<br />");
                    strHTML.Append("Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat));

                    //Add Report Filter Criteria    
                    strHTML.Append("<br /><br />");
                    strHTML.Append("<b>Report Filters </b>");
                    strHTML.Append("<br />");
                    strHTML.Append("Year   : " + strYear);
                    strHTML.Append("<br />");
                    strHTML.Append("Region   : " + strRegionString);
                    strHTML.Append("<br />");
                    strHTML.Append("Market        : " + strMarketString);
                    strHTML.Append("<br />");
                    strHTML.Append("<br /><br />");
                    strHTML.Append("</td></tr></table>");

                    #endregion

                    #region "Grid Data"

                    strHTML.Append("<table cellspacing='0' cellpadding='0' align='Left' border='0' style='width: 1700px; border-collapse: collapse;'>");
                    //Header Row  


                    strHTML.Append("<tr align='left'><td align='left'>");
                    strHTML.Append("<table width='1700px' cellpadding='0' cellspacing='0' border='0'>");
                    strHTML.Append("<tr><td align='left'>");
                    strHTML.Append("<table width='1700px' cellpadding='0' cellspacing='0' border='1' style='font-weight: bold;'>");
                    strHTML.Append("<tr style='font-weight: bold;'>");
                    strHTML.Append("<td align='left' colspan='2'>Sonic Automotive</td>");
                    strHTML.Append("<td align='center' colspan='4'>Safety Training Report </td>");
                    strHTML.Append("<td align='right' colspan='2'>Valuation Date: " + DateTime.Now.ToString("MM/dd/yyy") + " </td>");
                    strHTML.Append("</tr>");

                    strHTML.Append("<tr style='font-weight: bold;'>");
                    strHTML.Append("<td class='cols_' width='180px'>Company Name</td>");
                    strHTML.Append("<td class='cols_' width='120px'>Employee Name</td>");
                    strHTML.Append("<td class='cols_' width='120px'>JobTitle</td>");
                    strHTML.Append("<td class='cols_' width='120px'>Region</td>");
                    strHTML.Append("<td class='cols_' width='120px'>Last Hire Date</td>");
                    strHTML.Append("<td class='cols_' width='120px'>Quarter</td>");
                    strHTML.Append("<td class='cols_' width='250px'>Class Name</td>");
                    strHTML.Append("<td class='cols_' width='110px'>Status</td>");
                    strHTML.Append("</tr>");
                    strHTML.Append("</table>");
                    strHTML.Append("</td></tr>");
                    strHTML.Append("</table>");
                    strHTML.Append("</td></tr>");


                    DataSet dsReport = Report.GetSafetyTrainingReport(strRegion, strMarket, Convert.ToInt32(strYear), null, FK_Security_Id);

                    if (dsReport != null && dsReport.Tables.Count > 0 && dsReport.Tables[0].Rows.Count > 0)
                    {
                        DataTable dtLocation = dsReport.Tables[0];
                        DataTable dtDetails = dsReport.Tables[0];

                        strHTML.Append("<tr align='left'><td align='left'>");
                        strHTML.Append("<table width='1700px' cellpadding='0' cellspacing='0' border='0'>");
                        strHTML.Append("<tr><td align='left'>");
                        strHTML.Append("<table cellspacing='0' cellpadding='0' align='Left' border='1' style='width: 100%; border-collapse: collapse;'>");

                        foreach (DataRow drDetail in dsReport.Tables[0].Rows)
                        {
                            strHTML.Append("<tr>");
                            strHTML.Append("<td align='left' style='width: 180px'>" + Convert.ToString(drDetail["CompanyName"]) + "</td>");
                            strHTML.Append("<td align='left' style='width: 120px'>" + Convert.ToString(drDetail["EmployeeName"]) + "</td>");
                            strHTML.Append("<td align='left' style='width: 120px'>" + Convert.ToString(drDetail["Job_Title"]) + "</td>");
                            strHTML.Append("<td align='left' style='width: 120px'>" + Convert.ToString(drDetail["Region"]) + "</td>");
                            strHTML.Append("<td align='left' style='width: 120px'>" + Convert.ToString(drDetail["LastHireDate"]) + "</td>");
                            strHTML.Append("<td align='left' style='width: 120px'>" + Convert.ToString(drDetail["AssociateQuarter"]) + "</td>");
                            strHTML.Append("<td align='left' style='width: 250px'>" + Convert.ToString(drDetail["LearningProgramTitle"]) + "</td>");
                            strHTML.Append("<td align='left' style='width: 110px'>" + Convert.ToString(drDetail["LearningProgramStatus"]) + "</td>");
                            strHTML.Append(" </tr>");
                        }
                        strHTML.Append("</table>");
                        strHTML.Append("</td></tr>");
                        strHTML.Append("</table>");
                        strHTML.Append("</td></tr>");
                    }
                    else
                    {
                        strHTML.Append("<tr> <td style='border:thin;' colspan='8'> No Record Found.");
                        strHTML.Append("</td></tr>");
                    }

                    strHTML.Append("</table>");
                    #endregion

                    //Write HTML in to HtmlWriter
                    htmlWrite.WriteLine(strHTML.ToString());
                    //Send Mail
                    SendMail("Safety Training Report", "SafetyTrainingReport.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
                }
            }
            catch (Exception ex)
            {
                //EventLog.WriteEntry("Error Occurred while sending eRIMS_Sonic Scheduled Reports on " + dtSchduleDate.ToString() + ", " + ex.Message);
                EventLog.WriteEntry("Error Occurred in Safety Training Report on " + dtSchduleDate.ToString() + ", " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
        }

        //Report 65
        private void BindACI_ManagementAdHocReportWriter(DataRow drReportSchedule)
        {
            IDataReader Reader = null;
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);
                string strReportSchedulerName = Convert.ToString(drReportSchedule["ReportSchedulerName"]);
                //decimal pK_Schedule_ID = 6;
                //decimal Fk_RecipientList = 2;
                //decimal FK_Security_Id = 1;
                //string strReportSchedulerName = "test";
                //Get Report criteria for the scheduled report
                DataSet ds = new DataSet();
                ds = Report.SelectFilterCriteria(65, pK_Schedule_ID);
                if (ds != null && ds.Tables[0].Rows.Count > 0)
                {
                    DataTable dtFilter = ds.Tables[0];
                    if (dtFilter.Rows.Count > 0)
                    {
                        string strCoverageType = string.Empty, strOutPutFields = string.Empty, strFirstGroupBy = string.Empty, strSecGroupBy = string.Empty;
                        DateTime? dtPriorValuationDate = null;

                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["PriorValuationDate"])))
                            dtPriorValuationDate = Convert.ToDateTime(dtFilter.Rows[0]["PriorValuationDate"]);

                        if (!string.IsNullOrEmpty(Convert.ToString(dtFilter.Rows[0]["PriorValuation_RelativeDate"])))
                        {
                            // set Relative Date From criteria
                            AdHocReportHelper.RaltiveDates RelType = (AdHocReportHelper.RaltiveDates)Enum.Parse(typeof(AdHocReportHelper.RaltiveDates), Convert.ToString(dtFilter.Rows[0]["PriorValuation_RelativeDate"]));
                            dtPriorValuationDate = AdHocReportHelper.GetRelativeDate(RelType);
                        }

                        decimal _dcSelectedReport = 0;

                        List<ERIMS_DAL.Management_AdHocFilter> lstFilter = new List<Management_AdHocFilter>();

                        _dcSelectedReport = Convert.ToDecimal(dtFilter.Rows[0]["PK_Management_AdHocReport"]);
                        lstFilter = new ERIMS_DAL.Management_AdHocFilter().GetAdHocReportFieldByPk(_dcSelectedReport);

                        ERIMS_DAL.Management_AdHocReport ObjAdHocReport = new ERIMS_DAL.Management_AdHocReport(_dcSelectedReport);

                        strOutPutFields = ObjAdHocReport.OutputFields;
                        string strFilterIDs = string.Empty;
                        for (int i = 0; i < lstFilter.Count; i++)
                        {
                            Management_AdhocReportFields obj = new Management_AdhocReportFields();
                            List<Management_AdhocReportFields> lstAdhoc = obj.GetAdHocReportFieldByPk(Convert.ToDecimal(lstFilter[i].FK_Management_AdhocReportFields));
                            strFilterIDs += lstFilter[i].FK_Management_AdhocReportFields + ",";
                        }
                        strFilterIDs = strFilterIDs.TrimEnd(',');

                        StringBuilder sbRecord = new StringBuilder();
                        if (dtFilter.Rows.Count > 0)
                        {
                            //Get the recipient from the recipient list 
                            DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];
                            DataRow drFilterCriteria = dtFilter.Rows[0];
                            //Get the user who has scheduled the report
                            DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                            String strFirstName, strLastName, strMailFrom;
                            strFirstName = strLastName = strMailFrom = "";
                            if (dtUser.Rows.Count > 0)
                            {
                                strFirstName = Convert.ToString(dtUser.Rows[0]["FIRST_NAME"]).Trim();
                                strLastName = Convert.ToString(dtUser.Rows[0]["LAST_NAME"]).Trim();
                                strMailFrom = Convert.ToString(dtUser.Rows[0]["Email"]).Trim();
                            }
                            //Get Records in Reader
                            Reader = AdHocReportHelper.GetAdHocReportForManagement(strOutPutFields, BindGroupByForManagement(ObjAdHocReport), dtPriorValuationDate, GetWhereConditionForManagement(lstFilter), BindOrderByForManagement(ObjAdHocReport), strFilterIDs, FK_Security_Id);
                            //Get File path where Records Save.
                            string strFilePath = BindReportForManagement(ref sbRecord, Reader, ObjAdHocReport, lstFilter, strReportSchedulerName);

                            //If records found
                            if (File.Exists(strFilePath))
                            {
                                try
                                {
                                    SendMail(strReportSchedulerName, strReportSchedulerName + ".xls", strFirstName, strLastName, strMailFrom, strFilePath, dtRecipients, FK_Security_Id);
                                    EventLog.WriteEntry("eRIMS_Sonic Scheduled Reports Sent successfully scheduled on " + dtSchduleDate.ToString());
                                }
                                catch (Exception ex)
                                {
                                    EventLog.WriteEntry("Error Occurred while sending eRIMS_Sonic Scheduled Reports on " + dtSchduleDate.ToString() + ", " + ex.Message + ",Stack Trace:" + ex.StackTrace);
                                }
                                finally
                                {
                                    dtRecipients.Dispose();
                                    dtUser.Dispose();
                                }
                            }
                        }
                    }
                }
            }

            catch (Exception ex)
            {
                EventLog.WriteEntry("Error Occurred while sending eRIMS_Sonic Scheduled Reports on " + dtSchduleDate.ToString() + ", " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
        }

        // Report 67
        private void BindConstructionAdHocReport(DataRow drReportSchedule)
        {
            IDataReader Reader = null;
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);
                string strReportSchedulerName = Convert.ToString(drReportSchedule["ReportSchedulerName"]);

                //Get Report criteria for the scheduled report
                DataSet ds = new DataSet();
                ds = Report.SelectFilterCriteria(67, pK_Schedule_ID);
                if (ds != null && ds.Tables[0].Rows.Count > 0)
                {
                    DataTable dtFilter = ds.Tables[0];
                    if (dtFilter.Rows.Count > 0)
                    {
                        string strCoverageType = string.Empty, strOutPutFields = string.Empty, strFirstGroupBy = string.Empty, strSecGroupBy = string.Empty;

                        Int32 _dcSelectedReport = 0;

                        _dcSelectedReport = Convert.ToInt32(dtFilter.Rows[0]["Pk_AdHocReport"]);
                        List<Construction_AdHocFilter> lstFilter = Construction_AdHocFilter.SelectList(Construction_AdHocFilter.SelectAdHocFilterByFK(_dcSelectedReport));

                        Construction_AdHocReport ObjAdHocReport = new Construction_AdHocReport(_dcSelectedReport);

                        strOutPutFields = ObjAdHocReport.OutputFields;
                        string strFilterIDs = string.Empty;
                        foreach (ERIMS_DAL.Construction_AdHocFilter adhocFilter in lstFilter)
                        {
                            // AdhocReportFields obj = new AdhocReportFields();
                            // List<AdhocReportFields> lstAdhoc = obj.GetAdHocReportFieldByPk(Convert.ToDecimal(lstFilter[i].FK_AdHocReportFields));
                            strFilterIDs += adhocFilter.FK_AdHocReportFields + ",";
                        }
                        strFilterIDs = strFilterIDs.TrimEnd(',');

                        List<Construction_AdhocReportFields> listConstruction_AdHocReportFields = !string.IsNullOrEmpty(strFilterIDs) ? Construction_AdhocReportFields.SelectList(Construction_AdhocReportFields.GetAdHocReportFieldByMultipleID(strFilterIDs)) : new List<Construction_AdhocReportFields>();

                        StringBuilder sbRecord = new StringBuilder();
                        if (dtFilter.Rows.Count > 0)
                        {
                            //Get the recipient from the recipient list 
                            DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];
                            DataRow drFilterCriteria = dtFilter.Rows[0];
                            //Get the user who has scheduled the report
                            DataTable dtUser = Report.SelectContractorSecurityByPK(FK_Security_Id).Tables[0];

                            String strFirstName, strLastName, strMailFrom;
                            strFirstName = strLastName = strMailFrom = "";
                            if (dtUser.Rows.Count > 0)
                            {
                                strFirstName = Convert.ToString(dtUser.Rows[0]["First_Name"]).Trim();
                                strLastName = Convert.ToString(dtUser.Rows[0]["Last_Name"]).Trim();
                                strMailFrom = Convert.ToString(dtUser.Rows[0]["Email"]).Trim();
                            }
                            //Get Records in Reader
                            Reader = Construction_AdHocReport.GetConstructionAdHocReport(strOutPutFields, BindGroupBy(ObjAdHocReport), GetWhereCondition(lstFilter, listConstruction_AdHocReportFields), BindOrderBy(ObjAdHocReport), strFilterIDs, FK_Security_Id);
                            //Get File path where Records Save.
                            string strFilePath = BindConstructionReport(ref sbRecord, Reader, ObjAdHocReport, lstFilter, listConstruction_AdHocReportFields, strReportSchedulerName);

                            //If records found
                            if (File.Exists(strFilePath))
                            {
                                try
                                {
                                    SendMail(strReportSchedulerName, strReportSchedulerName + ".xls", strFirstName, strLastName, strMailFrom, strFilePath, dtRecipients, FK_Security_Id);
                                    EventLog.WriteEntry("eRIMS_Sonic Scheduled Reports Sent successfully scheduled on " + dtSchduleDate.ToString());
                                }
                                catch (Exception ex)
                                {
                                    EventLog.WriteEntry("Error Occurred while sending eRIMS_Sonic Scheduled Reports on " + dtSchduleDate.ToString() + ", " + ex.Message + ",Stack Trace:" + ex.StackTrace);
                                }
                                finally
                                {
                                    dtRecipients.Dispose();
                                    dtUser.Dispose();
                                }
                            }
                        }
                    }
                }
            }

            catch (Exception ex)
            {
                //EventLog.WriteEntry("Error Occurred while sending eRIMS_Sonic Scheduled Reports on " + dtSchduleDate.ToString() + ", " + ex.Message);
                EventLog.WriteEntry("Error Occurred in Construction AdHoc Report on " + dtSchduleDate.ToString() + ", " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
        }

        //Report 71
        private void BindACIKeyContactReport(DataRow drReportSchedule)
        {
            decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
            decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
            decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

            //Get Report criteria for the scheduled report
            DataTable dtFilter = Report.SelectFilterCriteria(71, pK_Schedule_ID).Tables[0];
            if (dtFilter.Rows.Count > 0)
            {
                //Get the recipient from the recipient list 
                DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                //Get the user who has scheduled the report
                DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                String strFirstName, strLastName, strMailFrom;
                strFirstName = strLastName = strMailFrom = "";
                if (dtUser.Rows.Count > 0)
                {
                    strFirstName = Convert.ToString(dtUser.Rows[0]["FIRST_NAME"]).Trim();
                    strLastName = Convert.ToString(dtUser.Rows[0]["LAST_NAME"]).Trim();
                    strMailFrom = Convert.ToString(dtUser.Rows[0]["Email"]).Trim();
                }

                string strDBA = Convert.ToString(dtFilter.Rows[0]["DBA"]).Trim();
                //string strInspector = Convert.ToString(dtFilter.Rows[0]["Inspector_Name"]).Trim();
                //string strInspectionArea = Convert.ToString(dtFilter.Rows[0]["InspectionArea"]).Trim();
                string strJob_Titles = Convert.ToString(dtFilter.Rows[0]["Job_Title"]).Trim();

                //Get the all Unique records for Selected group (default - last name -sort) by search criteria
                DataSet dsResult = Report.GetACI_Key_Contact_Report(strDBA, strJob_Titles);

                //Create HTML for the report and write into HTML Write object
                StringBuilder strHTML = new StringBuilder();
                System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                #region "Report Title"

                //Add Report Title and Schedule Date
                strHTML.Append("<table>");

                //strHTML.Append("<br />");
                strHTML.Append("<tr><td colspan='12'><b>Report Title : ACI Key Contact Report</b></td></tr>");
                //strHTML.Append("<br /><br />");
                strHTML.Append("<tr><td colspan='12'>Schedule Date : " + Convert.ToDateTime(drReportSchedule["Scheduled_Date"]).ToString(DateDisplayFormat) + "</td></tr>");
                strHTML.Append("<tr><td colspan='12'>Schedule End Date : " + Convert.ToDateTime(drReportSchedule["Schedule_End_Date"]).ToString(DateDisplayFormat) + "</td></tr>");
                //strHTML.Append("<br />");
                strHTML.Append("<tr><td colspan='12'>Recurring Period : " + drReportSchedule["Recurring_Period"].ToString() + "</td></tr>");
                //strHTML.Append("<br />");
                strHTML.Append("<tr><td colspan='12'>Recurring Date : " + dtSchduleDate.ToString(DateDisplayFormat) + "</td></tr>");

                //Add Report Filter Criteria 
                //strHTML.Append("<br /><br />");//<table> <tr> <td>
                strHTML.Append("<tr><td colspan='12'><b>Report Filters </b></td></tr>");
                //strHTML.Append("<br /><table> <tr> <td>");
                //strHTML.Append("Location D/B/A   : " + ((!string.IsNullOrEmpty(strDBA)) ? Report.GetCommaSeperatedDescFromVal("LU_Location", "dba", "PK_LU_Location_ID", strDBA) : ""));
                //strHTML.Append("</td> </tr>");
                //strHTML.Append("<tr> <td>");
                //strHTML.Append("ACI Key Contact Report : " + strJob_Titles);
                //strHTML.Append("</td> </tr>");
                //strHTML.Append("<tr> <td>");
                //strHTML.Append("</td></tr></table> ");


                //strHTML.Append("<br /><br />");
                strHTML.Append("<tr><td colspan='12'>Location D/B/A   : " + ((!string.IsNullOrEmpty(strDBA)) ? Report.GetCommaSeperatedDescFromVal("LU_Location", "dba", "PK_LU_Location_ID", strDBA) : "") + "</td></tr>");
                //strHTML.Append("<br />");
                //strHTML.Append("<tr> <td>");
                strHTML.Append("<tr><td colspan='12'>ACI Key Contact Report : " + strJob_Titles + "</td></tr>");
                //strHTML.Append("<br /><br />");
                //strHTML.Append("<tr> <td>");
                //strHTML.Append("</td></tr></table> ");
                //strHTML.Append("</td></tr>");
                #endregion

                #region "Report Grid header"
                //Top Header
                //strHTML.Append("<tr><td>");
                strHTML.Append("<table border='1'>");
                strHTML.Append("<tr style='font-weight: bold;' valign='bottom'>");
                strHTML.Append("<td align='left' >Sonic Automotive</td>");
                strHTML.Append("<td align='center' colspan='11'>ACI Key Contact Report</td>");
                strHTML.Append("<td align='right' > " + DateTime.Now.ToString() + " </td>");
                strHTML.Append("</tr>");

                //Sub Header
                strHTML.Append("<tr valign='bottom' style='font-weight: bold'>");
                strHTML.Append("<td width='250' align='left'>Location D/B/A</td>");
                strHTML.Append("<td width='150' align='left'>Store Address 1</td>");
                strHTML.Append("<td width='150' align='left'>Store Address 2</td>");
                strHTML.Append("<td width='100' align='left'>Store City</td>");
                strHTML.Append("<td width='100' align='left'>Store State</td>");
                strHTML.Append("<td width='80' align='left'>Store Zip</td>");
                strHTML.Append("<td width='80' align='left'>Location Code</td>");
                strHTML.Append("<td width='120' align='left'>Job Title</td>");
                strHTML.Append("<td width='100' align='left'>First Name</td>");
                strHTML.Append("<td width='100' align='left'>Last Name</td>");
                strHTML.Append("<td width='170' align='left'>Email Address</td>");
                strHTML.Append("<td width='100' align='left'>Cell Phone</td>");
                strHTML.Append("<td width='100' align='left'>Work Phone</td>");
                //strHTML.Append("<td width='100' align='right'>Cost Center</td>");
                //strHTML.Append("<td width='100' align='right'>Secondary Cost Center</td>");
                strHTML.Append("</tr>");

                //Check Whether Record Exists or Not
                if (dsResult != null && dsResult.Tables.Count > 0 && dsResult.Tables[0].Rows.Count > 0)
                {
                    foreach (DataRow dr in dsResult.Tables[0].Rows)
                    {
                        strHTML.Append("<tr valign='top'>");

                        strHTML.Append("<td width='250'>" + Convert.ToString(dr["dba"]) + "</td>");
                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["address_1"]) + "</td>");
                        strHTML.Append("<td width='150'>" + Convert.ToString(dr["address_2"]) + "</td>");
                        strHTML.Append("<td width='100'>" + Convert.ToString(dr["city"]) + "</td>");
                        strHTML.Append("<td width='100'>" + Convert.ToString(dr["State"]) + "</td>");
                        strHTML.Append("<td width='80'>" + Convert.ToString(dr["zip_code"]) + "</td>");
                        strHTML.Append("<td width='80'>" + Convert.ToString(dr["Sonic_Location_Code"]) + "</td>");
                        strHTML.Append("<td width='120'>" + Convert.ToString(dr["job_title"]) + "</td>");
                        strHTML.Append("<td width='100'>" + Convert.ToString(dr["first_name"]) + "</td>");
                        strHTML.Append("<td width='100'>" + Convert.ToString(dr["last_name"]) + "</td>");
                        strHTML.Append("<td width='170'>" + Convert.ToString(dr["email"]) + "</td>");
                        strHTML.Append("<td width='100'>" + Convert.ToString(dr["employee_cell_Phone"]) + "</td>");
                        strHTML.Append("<td width='100'>" + Convert.ToString(dr["work_Phone"]) + "</td>");
                        //strHTML.Append("<td width='100'>" + Convert.ToString(dr["FK_Cost_Center"]) + "</td>");
                        //strHTML.Append("<td width='100'>" + Convert.ToString(dr["Secondary_Cost_Center"]) + "</td>");
                        strHTML.Append("</tr>");
                    }
                }
                else
                {
                    //Add No record found line for year
                    strHTML.Append("<tr><td align='left' style='border:thin' colspan='13'>No Record Found!</td></tr>");
                }
                strHTML.Append("</table></table>");
                //strHTML.Append("</td></tr></table>");

                #endregion

                //Write HTML in to HtmlWriter
                htmlWrite.WriteLine(strHTML.ToString());
                //Send Mail
                SendMail("ACI Key Contact Report", "ACI_Key_Contact_Report.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);

                #region "Send Mail to FROI"

                //DataSet dsSecurity = Report.SelectEmployeeData();
                //DataTable dtSecAndLoc = dsSecurity.Tables[0];
                ////get distinct Security IDs
                //DataTable dtSecurityID = dsSecurity.Tables[1];
                //DataTable dtResult = Report.GetACI_Key_Contact_Report(strDBA, strJob_Titles).Tables[0];
                //String strSonicLocCode = String.Empty;
                //String strLocationID = String.Empty;

                //if (dtSecurityID != null && dtSecurityID.Rows.Count > 0)
                //{
                //    foreach (DataRow drSecurityID in dtSecurityID.Rows)
                //    {
                //        DataRow[] drSecAndLoc = dtSecAndLoc.Select("PK_Security_ID = '" + Convert.ToString(drSecurityID["PK_Security_ID"]) + "'");

                //        foreach (DataRow dr in drSecAndLoc)
                //        {
                //            strSonicLocCode = strSonicLocCode + Convert.ToString(dr["Sonic_Location_Code"]) + ",";
                //            strLocationID = strLocationID + Convert.ToString(dr["PK_LU_Location_ID"]) + ",";
                //        }

                //        strSonicLocCode = strSonicLocCode.TrimEnd(',');
                //        strLocationID = strLocationID.TrimEnd(',');

                //        DataTable dtReportData = new DataView(dtResult, "Sonic_Location_Code IN (" + strSonicLocCode + ")", "", DataViewRowState.CurrentRows).ToTable();
                //        //Create HTML for the report and write into HTML Write object
                //        StringBuilder strHTMLFROI = new StringBuilder();
                //        System.IO.StringWriter stringWriteFROI = new System.IO.StringWriter();
                //        System.Web.UI.HtmlTextWriter htmlWriteFROI = new System.Web.UI.HtmlTextWriter(stringWriteFROI);

                //        #region "Report Title"

                //        //Add Report Title and Schedule Date
                //        strHTMLFROI.Append("<table>");
                //        strHTMLFROI.Append("<tr><td colspan='12'><b>Report Title : ACI Key Contact Report</b></td></tr>");
                //        strHTMLFROI.Append("<tr><td colspan='12'><b>Report Filters </b></td></tr>");
                //        strHTMLFROI.Append("<tr><td colspan='12'>Location D/B/A   : " + ((!string.IsNullOrEmpty(strLocationID)) ? Report.GetCommaSeperatedDescFromVal("LU_Location", "dba", "PK_LU_Location_ID", strLocationID) : "") + "</td></tr>");

                //        #endregion

                //        #region "Report Grid header"

                //        //Top Header
                //        strHTMLFROI.Append("<table border='1'>");
                //        strHTMLFROI.Append("<tr style='font-weight: bold;' valign='bottom'>");
                //        strHTMLFROI.Append("<td align='left' >Sonic Automotive</td>");
                //        strHTMLFROI.Append("<td align='center' colspan='11'>ACI Key Contact Report</td>");
                //        strHTMLFROI.Append("<td align='right' > " + DateTime.Now.ToString() + " </td>");
                //        strHTMLFROI.Append("</tr>");

                //        //Sub Header
                //        strHTMLFROI.Append("<tr valign='bottom' style='font-weight: bold'>");
                //        strHTMLFROI.Append("<td width='250' align='left'>Location D/B/A</td>");
                //        strHTMLFROI.Append("<td width='150' align='left'>Store Address 1</td>");
                //        strHTMLFROI.Append("<td width='150' align='left'>Store Address 2</td>");
                //        strHTMLFROI.Append("<td width='100' align='left'>Store City</td>");
                //        strHTMLFROI.Append("<td width='100' align='left'>Store State</td>");
                //        strHTMLFROI.Append("<td width='80' align='left'>Store Zip</td>");
                //        strHTMLFROI.Append("<td width='80' align='left'>Location Code</td>");
                //        strHTMLFROI.Append("<td width='120' align='left'>Job Title</td>");
                //        strHTMLFROI.Append("<td width='100' align='left'>First Name</td>");
                //        strHTMLFROI.Append("<td width='100' align='left'>Last Name</td>");
                //        strHTMLFROI.Append("<td width='170' align='left'>Email Address</td>");
                //        strHTMLFROI.Append("<td width='100' align='left'>Cell Phone</td>");
                //        strHTMLFROI.Append("<td width='100' align='left'>Work Phone</td>");
                //        strHTMLFROI.Append("</tr>");

                //        //Check Whether Record Exists or Not
                //        if (dtReportData != null && dtReportData.Rows.Count > 0)
                //        {
                //            foreach (DataRow dr in dtReportData.Rows)
                //            {
                //                strHTMLFROI.Append("<tr valign='top'>");
                //                strHTMLFROI.Append("<td width='250'>" + Convert.ToString(dr["dba"]) + "</td>");
                //                strHTMLFROI.Append("<td width='150'>" + Convert.ToString(dr["address_1"]) + "</td>");
                //                strHTMLFROI.Append("<td width='150'>" + Convert.ToString(dr["address_2"]) + "</td>");
                //                strHTMLFROI.Append("<td width='100'>" + Convert.ToString(dr["city"]) + "</td>");
                //                strHTMLFROI.Append("<td width='100'>" + Convert.ToString(dr["State"]) + "</td>");
                //                strHTMLFROI.Append("<td width='80'>" + Convert.ToString(dr["zip_code"]) + "</td>");
                //                strHTMLFROI.Append("<td width='80'>" + Convert.ToString(dr["Sonic_Location_Code"]) + "</td>");
                //                strHTMLFROI.Append("<td width='120'>" + Convert.ToString(dr["job_title"]) + "</td>");
                //                strHTMLFROI.Append("<td width='100'>" + Convert.ToString(dr["first_name"]) + "</td>");
                //                strHTMLFROI.Append("<td width='100'>" + Convert.ToString(dr["last_name"]) + "</td>");
                //                strHTMLFROI.Append("<td width='170'>" + Convert.ToString(dr["email"]) + "</td>");
                //                strHTMLFROI.Append("<td width='100'>" + Convert.ToString(dr["employee_cell_Phone"]) + "</td>");
                //                strHTMLFROI.Append("<td width='100'>" + Convert.ToString(dr["work_Phone"]) + "</td>");
                //                strHTMLFROI.Append("</tr>");
                //            }
                //        }
                //        else
                //        {
                //            //Add No record found line for year
                //            strHTMLFROI.Append("<tr><td align='left' style='border:thin' colspan='13'>No Record Found!</td></tr>");
                //        }
                //        strHTMLFROI.Append("</table></table>");

                //        #endregion

                //        //Write HTML in to HtmlWriter
                //        htmlWriteFROI.WriteLine(strHTMLFROI.ToString());

                //        //Send Mail
                //        DataTable dtRecepient = new DataTable();
                //        dtRecepient.Columns.Add("Email", typeof(String));
                //        dtRecepient.Columns.Add("FirstName", typeof(String));
                //        dtRecepient.Columns.Add("LastName", typeof(String));
                //        dtRecepient.Rows.Add(Convert.ToString(drSecurityID["Email"]), Convert.ToString(drSecurityID["FIRST_NAME"]), Convert.ToString(drSecurityID["LAST_NAME"]));
                //        SendMail("ACI Key Contact Report", "ACI_Key_Contact_Report.xls", strFirstName, strLastName, strMailFrom, stringWriteFROI, dtRecepient);
                //        strSonicLocCode = strLocationID = string.Empty;
                //    }
                //}
                #endregion
            }
        }

        //Report 72
        private void BindVOCEmissionsReport(DataRow drReportSchedule)
        {
            decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
            decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
            decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);

            //Get Report criteria for the scheduled report
            DataTable dtFilter = Report.SelectFilterCriteria(72, pK_Schedule_ID).Tables[0];
            if (dtFilter.Rows.Count > 0)
            {
                //Get the recipient from the recipient list 
                DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];

                //Get the user who has scheduled the report
                DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                String strFirstName, strLastName, strMailFrom;
                strFirstName = strLastName = strMailFrom = "";
                if (dtUser.Rows.Count > 0)
                {
                    strFirstName = Convert.ToString(dtUser.Rows[0]["FIRST_NAME"]).Trim();
                    strLastName = Convert.ToString(dtUser.Rows[0]["LAST_NAME"]).Trim();
                    strMailFrom = Convert.ToString(dtUser.Rows[0]["Email"]).Trim();
                }

                // get start date
                DateTime Start_Date = Convert.ToDateTime(dtFilter.Rows[0]["Start_Date"]);
                // get end date
                DateTime End_Date = Convert.ToDateTime(dtFilter.Rows[0]["End_Date"]);

                string strLocation = Convert.ToString(dtFilter.Rows[0]["Location"]).Trim();
                int startYear, endYear, startMonth, endMonth, selectedLocationCount, allLocationCount;
                startYear = Start_Date.Year;
                endYear = End_Date.Year;
                startMonth = Start_Date.Month;
                endMonth = End_Date.Month;
                string strLoc = string.Empty;

                DataSet dsResult = Report.GetVOCReport(startYear, endYear, startMonth, endMonth, strLocation);
                DataSet dsLocation = Report.GetCommaSepratedLocationFromIDs(strLocation);

                // get data tables from dataset
                DataTable dtCategory = dsResult.Tables[0];
                DataTable dtRegions = dsResult.Tables[1];
                DataTable dtGrand_Total = dsResult.Tables[2];
                DataTable dtYearData = dsResult.Tables[3];
                DataTable dtYearAllCategory = dsResult.Tables[4];
                selectedLocationCount = Convert.ToInt32(dsLocation.Tables[0].Rows[0][0]);
                allLocationCount = Convert.ToInt32(dsLocation.Tables[1].Rows[0][0]);
                DataTable dtSelectedLocation = dsLocation.Tables[2];

                if (selectedLocationCount == allLocationCount)
                {
                    strLoc = "All Locations";
                }
                else
                {
                    strLoc = Convert.ToString(dsLocation.Tables[2].Rows[0][0]);
                }

                System.Text.StringBuilder sbRecorords = new System.Text.StringBuilder("");
                System.IO.StringWriter stringWrite = new System.IO.StringWriter();
                System.Web.UI.HtmlTextWriter htmlWrite = new System.Web.UI.HtmlTextWriter(stringWrite);

                if (dtCategory != null && dtCategory.Rows.Count > 0)
                {
                    sbRecorords.Append("<table style='padding-left:4px;font-size:8.5pt;font-family:Tahoma' cellpadding='4' cellspacing='0' Width='996px'>");
                    sbRecorords.Append("<tr style='font-weight: bold;background-color:#7f7f7f;color:White;font-size:11pt;height:25'>");
                    sbRecorords.Append("<td align='left' style='font-size:9pt'  colspan='5'>VOC Report: " + DateTime.Now.ToString("MM/dd/yyy HH:mm tt") + "</td></tr>");
                    sbRecorords.Append("<tr align='left'  style='font-weight: bold;background-color:#7f7f7f;color:White;font-size:8.5pt'>");
                    sbRecorords.Append("<td colspan='5'></td>");
                    sbRecorords.Append("</tr>");
                    sbRecorords.Append("<tr align='left'  style='font-weight: bold;background-color:#7f7f7f;color:White;font-size:8.5pt'><td align='left' style='font-size:9pt'  colspan='5'><b> Filter Conditions :  </b></td></tr>");
                    sbRecorords.Append("<tr align='left'  style='font-weight: bold;background-color:#7f7f7f;color:White;font-size:8.5pt'><td align='left' style='font-size:9pt'  colspan='5'><b>Start Date: </b>" + Start_Date.ToString("MM/dd/yyyy") + "</td></tr>");
                    sbRecorords.Append("<tr align='left'  style='font-weight: bold;background-color:#7f7f7f;color:White;font-size:8.5pt'><td align='left' style='font-size:9pt'  colspan='5'><b>End Date: </b>" + End_Date.ToString("MM/dd/yyyy") + "</td></tr>");
                    sbRecorords.Append("<tr align='left'  style='font-weight: bold;background-color:#7f7f7f;color:White;font-size:8.5pt'><td align='left' style='font-size:9pt'  colspan='5'><b>Locations: </b>" + strLoc + "</td></tr>");
                    sbRecorords.Append("<tr align='left'  style='font-weight: bold;background-color:#7f7f7f;color:White;font-size:8.5pt'><td align='left' style='font-size:9pt'  colspan='5'><b> Report Columns :  </b></td></tr>");
                    sbRecorords.Append("<tr align='left'  style='font-weight: bold;background-color:#7f7f7f;color:White;font-size:8.5pt'>");
                    sbRecorords.Append("<td class='cols_' width='12.5%'>Product Part Number</td>");
                    sbRecorords.Append("<td class='cols_' width='12.5%'>Unit Volume</td>");
                    sbRecorords.Append("<td class='cols_' width='12.5%'align='left'>Quantity Purchased</td>");
                    sbRecorords.Append("<td class='cols_' width='12.5%'align='left'>Gallons</td>");
                    sbRecorords.Append("<td class='cols_' width='12.5%'align='left'>VOC total</td>");
                    sbRecorords.Append("</tr>");

                    //now category 
                    foreach (DataRow drCategory in dtCategory.Rows)
                    {
                        string category = Convert.ToString(drCategory["Category"]);

                        DataRow[] drVOCEmissions = dtRegions.Select("Category = '" + category + "'");
                        this.FillVocReportRows(sbRecorords, category, drVOCEmissions, false);

                        DataRow[] drYearVOCEmissions = dtYearData.Select("Category = '" + category + "'");

                        if (drYearVOCEmissions != null && drYearVOCEmissions.Length > 0)
                        {
                            int intRes = 0;
                            foreach (DataRow drYearVOCEmission in drYearVOCEmissions)
                            {
                                intRes += 1;
                                if (intRes % 2 == 0)
                                    sbRecorords.Append("<tr align='left' style='font-size:8pt;background-color:#EAEAEA;font-family:Tahoma;'>");
                                else
                                    sbRecorords.Append("<tr align='left' style='font-size:8pt;background-color:#FFFFFF;font-family:Tahoma;'>");

                                sbRecorords.Append("<td  class='cols_' align='left' style='word-wrap:normal;word-break:break-all'>" + Convert.ToString(drYearVOCEmission["Part_Number"]) + "</td>");
                                sbRecorords.Append("<td class='cols_' style='word-wrap:normal;word-break:break-all'>" + Convert.ToString(drYearVOCEmission["Unit"]) + "</td>");
                                sbRecorords.Append("<td class='cols_' align='left' style='word-wrap:normal;word-break:break-all'>" + Convert.ToString(drYearVOCEmission["Quantity"]) + "</td>");
                                sbRecorords.Append("<td class='cols_' align='left' style='word-wrap:normal;word-break:break-all'>" + Convert.ToString(drYearVOCEmission["Gallons"]) + "</td>");
                                sbRecorords.Append("<td class='cols_' align='left' style='word-wrap:normal;word-break:break-all'>" + Convert.ToString(drYearVOCEmission["VOC_Emissions"]) + "</td>");
                                sbRecorords.Append("</tr>");
                            }
                        }
                    }

                    if (dtYearAllCategory != null && dtYearAllCategory.Rows.Count > 0)
                    {
                        DataRow[] drAllCategoryRows = dtYearAllCategory.Select();
                        this.FillVocReportRows(sbRecorords, "All Paint Categories", drAllCategoryRows, true);
                    }

                    //add grand by category
                    sbRecorords.Append("<tr align='left'  style='font-weight: bold;background-color:blue;color:White;font-size:8.5pt'><td align='left' style='font-size:9pt'  colspan='3'> Grand Totals :</td>");
                    sbRecorords.Append("<td align='left' style='font-size:9pt' ><b>" + string.Format("{0:N2}", dtGrand_Total.Rows[0]["Total_Gallons"]) + " </b></td>");
                    sbRecorords.Append("<td align='left' style='font-size:9pt' ><b>" + string.Format("{0:N2}", dtGrand_Total.Rows[0]["VOC_Emissions"]) + " </b></td></tr>");
                    sbRecorords.Append("</table>");
                }
                else
                {
                    // if record not found then hide Header and set width and height so scroll bar not visible.            
                    sbRecorords.Append("<table style='font-family:Tahoma' cellpadding='4' cellspacing='0' Width='100%'>");
                    sbRecorords.Append("<tr style='background-color:#F2F2F2;color:Black;'>");
                    sbRecorords.Append("<td align='center' style='font-size:9pt;'>No Records found.</td></tr></table>");
                }

                //Write HTML in to HtmlWriter
                htmlWrite.WriteLine(sbRecorords.ToString());

                //Send Mail
                if (Convert.ToDecimal(drReportSchedule["Format_Type"]) == 1)
                {
                    SendMail("VOC Emissions Report", "VOC_Emissions_Report.xls", strFirstName, strLastName, strMailFrom, stringWrite, dtRecipients);
                }
                else if (Convert.ToDecimal(drReportSchedule["Format_Type"]) == 2)
                {
                    SendMailPDF("VOC Emissions Report", "VOC_Emissions_Report.pdf", strFirstName, strLastName, strMailFrom, sbRecorords.ToString(), dtRecipients);
                }
            }
        }

        //Report 75
        private void BindSafetyTraining_AdHocReportWriter(DataRow drReportSchedule)
        {
            IDataReader Reader = null;
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);
                string strReportSchedulerName = Convert.ToString(drReportSchedule["ReportSchedulerName"]);
                //decimal pK_Schedule_ID = 6;
                //decimal Fk_RecipientList = 2;
                //decimal FK_Security_Id = 1;
                //string strReportSchedulerName = "test";
                //Get Report criteria for the scheduled report
                DataSet ds = new DataSet();
                ds = Report.SelectFilterCriteria(75, pK_Schedule_ID);
                if (ds != null && ds.Tables[0].Rows.Count > 0)
                {
                    DataTable dtFilter = ds.Tables[0];
                    if (dtFilter.Rows.Count > 0)
                    {
                        string strCoverageType = string.Empty, strOutPutFields = string.Empty, strFirstGroupBy = string.Empty, strSecGroupBy = string.Empty;

                        decimal _dcSelectedReport = 0;

                        List<ERIMS_DAL.Sonic_U_Train_AdHocFilter> lstFilter = new List<Sonic_U_Train_AdHocFilter>();

                        _dcSelectedReport = Convert.ToDecimal(dtFilter.Rows[0]["Pk_AdHocReport"]);
                        lstFilter = new ERIMS_DAL.Sonic_U_Train_AdHocFilter().GetAdHocReportFieldByPk(_dcSelectedReport);

                        ERIMS_DAL.Sonic_U_Train_AdHocReport ObjAdHocReport = new ERIMS_DAL.Sonic_U_Train_AdHocReport(_dcSelectedReport);

                        strOutPutFields = ObjAdHocReport.OutputFields;
                        string strFilterIDs = string.Empty;
                        for (int i = 0; i < lstFilter.Count; i++)
                        {
                            Sonic_U_Train_AdhocReportFields obj = new Sonic_U_Train_AdhocReportFields();
                            List<Sonic_U_Train_AdhocReportFields> lstAdhoc = obj.GetAdHocReportFieldByPk(Convert.ToDecimal(lstFilter[i].FK_AdHocReportFields));
                            strFilterIDs += lstFilter[i].FK_AdHocReportFields + ",";
                        }
                        strFilterIDs = strFilterIDs.TrimEnd(',');

                        StringBuilder sbRecord = new StringBuilder();
                        if (dtFilter.Rows.Count > 0)
                        {
                            //Get the recipient from the recipient list 
                            DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];
                            DataRow drFilterCriteria = dtFilter.Rows[0];
                            //Get the user who has scheduled the report
                            DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                            String strFirstName, strLastName, strMailFrom;
                            strFirstName = strLastName = strMailFrom = "";
                            if (dtUser.Rows.Count > 0)
                            {
                                strFirstName = Convert.ToString(dtUser.Rows[0]["FIRST_NAME"]).Trim();
                                strLastName = Convert.ToString(dtUser.Rows[0]["LAST_NAME"]).Trim();
                                strMailFrom = Convert.ToString(dtUser.Rows[0]["Email"]).Trim();
                            }
                            //Get Records in Reader
                            Reader = AdHocReportHelper.GetAdHocReportSonicUTraining(strOutPutFields, BindGroupBy(ObjAdHocReport), GetWhereConditionForSafetyTraining(lstFilter), BindOrderBy(ObjAdHocReport), strFilterIDs, FK_Security_Id);
                            //Get File path where Records Save.
                            string strFilePath = BindReportForSafetyTraining(ref sbRecord, Reader, ObjAdHocReport, lstFilter, strReportSchedulerName);

                            //If records found
                            if (File.Exists(strFilePath))
                            {
                                try
                                {
                                    isGrid = false;
                                    SendMail(strReportSchedulerName, strReportSchedulerName + ".xls", strFirstName, strLastName, strMailFrom, strFilePath, dtRecipients, FK_Security_Id);
                                    //isGrid = false;
                                    EventLog.WriteEntry("eRIMS_Sonic Scheduled Reports Sent successfully scheduled on " + dtSchduleDate.ToString());
                                }
                                catch (Exception ex)
                                {
                                    EventLog.WriteEntry("Error Occurred while sending eRIMS_Sonic Scheduled Reports on " + dtSchduleDate.ToString() + ", " + ex.Message + ",Stack Trace:" + ex.StackTrace);
                                }
                                finally
                                {
                                    dtRecipients.Dispose();
                                    dtUser.Dispose();
                                }
                            }
                        }
                    }
                }
            }

            catch (Exception ex)
            {
                //EventLog.WriteEntry("Error Occurred while sending eRIMS_Sonic Scheduled Reports on " + dtSchduleDate.ToString() + ", " + ex.Message);
                EventLog.WriteEntry("Error Occurred in Safety Training Adhoc Report on " + dtSchduleDate.ToString() + ", " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
        }

        private void FillVocReportRows(StringBuilder sbRecorords, string category, DataRow[] drVOCEmissions, bool isAllCategories)
        {
            decimal totalGallons = 0, totalVOC_Emissions = 0;
            string SubTotalText = string.Empty;

            if (drVOCEmissions != null && drVOCEmissions.Length > 0)
            {
                sbRecorords.Append("<tr align='left'  style='font-weight: bold;background-color:white; color:#ff9c09;font-size:8.5pt'><td align='left' style='font-size:9pt'  colspan='5'><b>Category : " + category + "</b></td></tr>");
                int intRes = 0;
                foreach (DataRow drVOCEmission in drVOCEmissions)
                {
                    totalGallons += Convert.ToDecimal(drVOCEmission["Gallons"]);
                    totalVOC_Emissions += Convert.ToDecimal(drVOCEmission["VOC_Emissions"]);
                    SubTotalText = Convert.ToString(drVOCEmission["Subtotal_Text"]);

                    intRes += 1;
                    if (intRes % 2 == 0)
                        sbRecorords.Append("<tr align='left' style='font-size:8pt;background-color:#EAEAEA;font-family:Tahoma;'>");
                    else
                        sbRecorords.Append("<tr align='left' style='font-size:8pt;background-color:#FFFFFF;font-family:Tahoma;'>");

                    sbRecorords.Append("<td  class='cols_' align='left' style='word-wrap:normal;word-break:break-all'>" + Convert.ToString(drVOCEmission["Part_Number"]) + "</td>");
                    sbRecorords.Append("<td class='cols_' style='word-wrap:normal;word-break:break-all'>" + Convert.ToString(drVOCEmission["Unit"]) + "</td>");
                    sbRecorords.Append("<td class='cols_' align='left' style='word-wrap:normal;word-break:break-all'>" + Convert.ToString(drVOCEmission["Quantity"]) + "</td>");
                    sbRecorords.Append("<td class='cols_' align='left' style='word-wrap:normal;word-break:break-all'>" + Convert.ToString(drVOCEmission["Gallons"]) + "</td>");
                    sbRecorords.Append("<td class='cols_' align='left' style='word-wrap:normal;word-break:break-all'>" + Convert.ToString(drVOCEmission["VOC_Emissions"]) + "</td>");
                    sbRecorords.Append("</tr>");
                }

                if (!isAllCategories)
                {
                    //add subtotal by category
                    sbRecorords.Append("<tr align='left'  style='font-weight: bold;background-color:yellow;color:black;font-size:8.5pt'><td align='left' style='font-size:9pt'  colspan='3'>Sub Total For " + category + " : </td>");
                    sbRecorords.Append("<td align='left' style='font-size:9pt' ><b>" + string.Format("{0:N2}", totalGallons) + " </b></td>");
                    sbRecorords.Append("<td align='left' style='font-size:9pt' ><b>" + string.Format("{0:N2}", totalVOC_Emissions) + " </b></td></tr>");
                }
            }
        }

        //Report 77
        private void BindProperty_AdHocReportWriter(DataRow drReportSchedule)
        {
            IDataReader Reader = null;
            try
            {
                decimal pK_Schedule_ID = Convert.ToDecimal(drReportSchedule["PK_Schedule"]);
                decimal Fk_RecipientList = Convert.ToDecimal(drReportSchedule["Fk_RecipientList"]);
                decimal FK_Security_Id = Convert.ToDecimal(drReportSchedule["FK_Security_Id"]);
                string strReportSchedulerName = Convert.ToString(drReportSchedule["ReportSchedulerName"]);
                
                //Get Report criteria for the scheduled report
                DataSet ds = new DataSet();
                ds = Report.SelectFilterCriteria(77, pK_Schedule_ID);
                if (ds != null && ds.Tables[0].Rows.Count > 0)
                {
                    DataTable dtFilter = ds.Tables[0];
                    if (dtFilter.Rows.Count > 0)
                    {
                        string strCoverageType = string.Empty, strOutPutFields = string.Empty, strFirstGroupBy = string.Empty, strSecGroupBy = string.Empty;

                        decimal _dcSelectedReport = 0;

                        List<ERIMS_DAL.Property_AdHocFilter> lstFilter = new List<Property_AdHocFilter>();

                        _dcSelectedReport = Convert.ToDecimal(dtFilter.Rows[0]["Pk_AdHocReport"]);
                        lstFilter = new ERIMS_DAL.Property_AdHocFilter().GetAdHocReportFieldByPk(_dcSelectedReport);

                        ERIMS_DAL.Property_AdHocReport ObjAdHocReport = new ERIMS_DAL.Property_AdHocReport(_dcSelectedReport);

                        strOutPutFields = ObjAdHocReport.OutputFields;
                        string strFilterIDs = string.Empty;
                        for (int i = 0; i < lstFilter.Count; i++)
                        {
                            Property_AdhocReportFields obj = new Property_AdhocReportFields();
                            List<Property_AdhocReportFields> lstAdhoc = obj.GetAdHocReportFieldByPk(Convert.ToDecimal(lstFilter[i].FK_AdHocReportFields));
                            strFilterIDs += lstFilter[i].FK_AdHocReportFields + ",";
                        }
                        strFilterIDs = strFilterIDs.TrimEnd(',');

                        StringBuilder sbRecord = new StringBuilder();
                        if (dtFilter.Rows.Count > 0)
                        {
                            //Get the recipient from the recipient list 
                            DataTable dtRecipients = Report.SelectOneRecordWithRecipientList(Fk_RecipientList).Tables[0];
                            DataRow drFilterCriteria = dtFilter.Rows[0];
                            //Get the user who has scheduled the report
                            DataTable dtUser = Report.SelectSecurityByPK(FK_Security_Id).Tables[0];

                            String strFirstName, strLastName, strMailFrom;
                            strFirstName = strLastName = strMailFrom = "";
                            if (dtUser.Rows.Count > 0)
                            {
                                strFirstName = Convert.ToString(dtUser.Rows[0]["FIRST_NAME"]).Trim();
                                strLastName = Convert.ToString(dtUser.Rows[0]["LAST_NAME"]).Trim();
                                strMailFrom = Convert.ToString(dtUser.Rows[0]["Email"]).Trim();
                            }
                            //Get Records in Reader
                            Reader = AdHocReportHelper.GetAdHocReportProperty(strOutPutFields, BindGroupBy(ObjAdHocReport), GetWhereConditionForProperty(lstFilter), BindOrderBy(ObjAdHocReport), strFilterIDs, FK_Security_Id);
                            //Get File path where Records Save.
                            string strFilePath = BindReportForProperty(ref sbRecord, Reader, ObjAdHocReport, lstFilter, strReportSchedulerName);

                            //If records found
                            if (File.Exists(strFilePath))
                            {
                                try
                                {
                                    isGrid = false;
                                    SendMail(strReportSchedulerName, strReportSchedulerName + ".xls", strFirstName, strLastName, strMailFrom, strFilePath, dtRecipients, FK_Security_Id);
                                    //isGrid = false;
                                    EventLog.WriteEntry("eRIMS_Sonic Scheduled Reports Sent successfully scheduled on " + dtSchduleDate.ToString());
                                }
                                catch (Exception ex)
                                {
                                    EventLog.WriteEntry("Error Occurred while sending eRIMS_Sonic Scheduled Reports on " + dtSchduleDate.ToString() + ", " + ex.Message + ",Stack Trace:" + ex.StackTrace);
                                }
                                finally
                                {
                                    dtRecipients.Dispose();
                                    dtUser.Dispose();
                                }
                            }
                        }
                    }
                }
            }

            catch (Exception ex)
            {
                //EventLog.WriteEntry("Error Occurred while sending eRIMS_Sonic Scheduled Reports on " + dtSchduleDate.ToString() + ", " + ex.Message);
                EventLog.WriteEntry("Error Occurred in Safety Training Adhoc Report on " + dtSchduleDate.ToString() + ", " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
        }        

        #endregion

        #region Mail Send Method

        private void SendMail(String strReportTitle, String strFileNameToSave, String strFirstName, String strLastName, String strMailFrom, StringWriter sw, DataTable dtRecipients)
        {

            string strPath = AppDomain.CurrentDomain.BaseDirectory + @"temp\" + strFileNameToSave.Replace(".xls", "") + System.DateTime.Now.ToString("MMddyyhhmmss") + ".xls";

            File.WriteAllText(strPath, sw.ToString());

            bool blnHTML2Excel = false;
            string outputFiles = string.Empty;
            if (File.Exists(strPath))
            {
                string data = File.ReadAllText(strPath);
                data = data.Trim();
                HTML2Excel objHtml2Excel = new HTML2Excel(data);
                outputFiles = Path.GetFullPath(strPath).Replace(".xls", ".xlsx");
                objHtml2Excel.isGrid = isGrid;
                objHtml2Excel.overwriteBorder = false;
                blnHTML2Excel = objHtml2Excel.Convert2Excel(outputFiles);
            }

            MemoryStream memorystream = new MemoryStream();
            //byte[] _bytes = Encoding.UTF8.GetBytes(sw.ToString());
            //memorystream.Write(_bytes, 0, _bytes.Length);
            //memorystream.Seek(0, SeekOrigin.Begin);

            //HTML2Excel objHtml2Excel = new HTML2Excel(data);
            //strMailFrom = "kunal.dobaria@server1.com";
            if (blnHTML2Excel)
            {
                MailMessage mail = new MailMessage();
                mail.From = new MailAddress(strMailFrom);
                mail.Subject = "eRIMS :: " + strReportTitle;
                memorystream = new MemoryStream(File.ReadAllBytes(outputFiles));
                Attachment atts = new Attachment(memorystream, strFileNameToSave.Replace(".xls", ".xlsx"));
                mail.Attachments.Add(atts);

                SmtpClient mSmtpClient = new SmtpClient();
                mSmtpClient.Host = System.Configuration.ConfigurationManager.AppSettings.Get("SMTPServer");
                mSmtpClient.Credentials = new System.Net.NetworkCredential(System.Configuration.ConfigurationManager.AppSettings.Get("SMTPmail"), System.Configuration.ConfigurationManager.AppSettings.Get("SMTPPwd"));
                try
                {
                    for (int i = 0; i < dtRecipients.Rows.Count; i++)
                    {
                        mail.Body = dtRecipients.Rows[i]["FirstName"].ToString() + " " + dtRecipients.Rows[i]["LastName"].ToString() + ",<br />Please find the " + strReportTitle + " Attached with this mail.<br /><br /><br />Thank you!<br />" + strFirstName + " " + strLastName;
                        mail.Body += "<br /> This is system generated message. Please do not reply.";
                        mail.IsBodyHtml = true;
                        mail.To.Add(new MailAddress(dtRecipients.Rows[i]["Email"].ToString()));
                        mSmtpClient.Send(mail);
                        mail.To.Clear();
                    }
                }
                catch (Exception ex)
                {
                    EventLog.WriteEntry("Error in Sending Mail for " + strReportTitle + ", " + ex.Message + ",Stack Trace:" + ex.StackTrace);
                }
                atts.Dispose();

                //if (File.Exists(strPath))
                //    File.Delete(strPath);
                //if (File.Exists(outputFiles))
                //    File.Delete(outputFiles);
            }
            else
            {
                EventLog.WriteEntry("Error in converting Report to excel for " + strReportTitle);
            }
        }

        /// <summary>
        /// Send Mail Function
        /// </summary>
        /// <param name="strReportTitle"></param>
        /// <param name="strFileNameToSave"></param>
        /// <param name="strFirstName"></param>
        /// <param name="strLastName"></param>
        /// <param name="strMailFrom"></param>
        /// <param name="strFilePath"></param>
        /// <param name="dtRecipients"></param>
        /// <param name="FK_Security_Id"></param>
        private void SendMail(String strReportTitle, String strFileNameToSave, String strFirstName, String strLastName, String strMailFrom, string strFilePath, DataTable dtRecipients, decimal FK_Security_Id)
        {
            DataTable dtTemp = null;
            MemoryStream memorystream = new MemoryStream();
            //strMailFrom = "kunal.dobaria@server1.com";

            bool blnHTML2Excel = false;
            string outputFiles = string.Empty;
            if (File.Exists(strFilePath))
            {
                string data = File.ReadAllText(strFilePath);
                data = data.Trim();
                HTML2Excel objHtml2Excel = new HTML2Excel(data);
                outputFiles = Path.GetFullPath(strFilePath).Replace(".xls", ".xlsx");
                objHtml2Excel.isGrid = isGrid;
                blnHTML2Excel = objHtml2Excel.Convert2Excel(outputFiles);
            }

            if (blnHTML2Excel)
            {
                MailMessage mail = new MailMessage();
                mail.From = new MailAddress(strMailFrom);
                mail.Subject = "eRIMS Sonic :: " + strReportTitle;
                memorystream = new MemoryStream(File.ReadAllBytes(outputFiles));
                Attachment att = new Attachment(memorystream, strFileNameToSave.Replace(".xls", ".xlsx"));
                mail.Attachments.Add(att);

                SmtpClient mSmtpClient = new SmtpClient();
                mSmtpClient.Port = Convert.ToInt16(System.Configuration.ConfigurationManager.AppSettings.Get("Port"));
                mSmtpClient.Host = System.Configuration.ConfigurationManager.AppSettings.Get("SMTPServer");
                mSmtpClient.Credentials = new System.Net.NetworkCredential(ConfigurationManager.AppSettings["SMTPmail"], ConfigurationManager.AppSettings["SMTPPwd"]);
                try
                {
                    dtTemp = dtRecipients.Copy();
                    //dtTemp.DefaultView.RowFilter = "ISNULL(Use_Folder,0) = 0";
                    DataTable dtRecipientMails = dtTemp.DefaultView.ToTable();

                    for (int i = 0; i < dtRecipientMails.Rows.Count; i++)
                    {
                        mail.Body = dtRecipientMails.Rows[i]["FirstName"].ToString() + " " + dtRecipientMails.Rows[i]["LastName"].ToString() + ",<br /><br />Please find the " + strReportTitle + " Attached with this mail.<br /><br /><br />Thank You!<br />" + strFirstName + " " + strLastName;
                        mail.Body += "<br /><br /> This is system generated message. Please do not reply.";
                        mail.IsBodyHtml = true;
                        mail.To.Add(new MailAddress(dtRecipientMails.Rows[i]["Email"].ToString()));
                        mSmtpClient.Send(mail);
                        mail.To.Clear();
                    }
                }

                catch (Exception ex)
                {
                    EventLog.WriteEntry("Error in Sending Mail for " + strReportTitle + ", " + ex.Message + ",Stack Trace:" + ex.StackTrace);
                }
                att.Dispose();
            }
            else
            {
                EventLog.WriteEntry("Error in converting Report to excel for " + strReportTitle);
            }
        }

        protected void SendMailPDF(String strReportTitle, String strFileNameToSave, String strFirstName, String strLastName, String strMailFrom, String sw, DataTable dtRecipients)
        {
            string strPath = AppDomain.CurrentDomain.BaseDirectory + @"temp\" + strFileNameToSave.Replace(".pdf", "") + System.DateTime.Now.ToString("MMddyyhhmmss") + ".pdf";

            bool blnHTML2PDF = false;
            Byte[] pdfByte = null;

            PdfConverter objPdf = new PdfConverter();
            //string _strHtmltoPDFConverterKey = "5M/VxNXE0NPE0srUxNfVytXWyt3d3d0=";
            objPdf.LicenseKey = PDFLicenseKey;
            objPdf.PdfDocumentOptions.TopMargin = 20;
            objPdf.PdfDocumentOptions.LeftMargin = 20;
            objPdf.PdfDocumentOptions.RightMargin = 20;
            objPdf.PdfDocumentOptions.BottomMargin = 20;
            objPdf.PdfDocumentOptions.ShowHeader = false;
            objPdf.PdfDocumentOptions.ShowFooter = false;
            objPdf.PdfDocumentOptions.EmbedFonts = false;
            objPdf.PdfDocumentOptions.LiveUrlsEnabled = false;
            objPdf.RightToLeftEnabled = false;
            objPdf.PdfSecurityOptions.CanPrint = true;
            objPdf.PdfSecurityOptions.CanEditContent = true;
            objPdf.PdfSecurityOptions.UserPassword = "";
            objPdf.PdfDocumentOptions.PdfPageOrientation = PDFPageOrientation.Landscape;
            objPdf.PdfDocumentOptions.PdfPageSize = PdfPageSize.Letter;
            objPdf.PdfDocumentInfo.AuthorName = "eRIMS2";
            pdfByte = objPdf.GetPdfBytesFromHtmlString(sw.ToString());

            System.IO.File.WriteAllBytes(strPath, pdfByte);

            if (File.Exists(strPath))
            {
                blnHTML2PDF = true;
            }

            MemoryStream memorystream = new MemoryStream();

            if (blnHTML2PDF)
            {
                MailMessage mail = new MailMessage();
                mail.From = new MailAddress(strMailFrom);
                mail.Subject = "eRIMS :: " + strReportTitle;
                memorystream = new MemoryStream(File.ReadAllBytes(strPath));
                Attachment atts = new Attachment(memorystream, strFileNameToSave);
                mail.Attachments.Add(atts);

                SmtpClient mSmtpClient = new SmtpClient();
                mSmtpClient.Host = System.Configuration.ConfigurationManager.AppSettings.Get("SMTPServer");
                mSmtpClient.Credentials = new System.Net.NetworkCredential(System.Configuration.ConfigurationManager.AppSettings.Get("SMTPmail"), System.Configuration.ConfigurationManager.AppSettings.Get("SMTPPwd"));
                try
                {
                    for (int i = 0; i < dtRecipients.Rows.Count; i++)
                    {
                        mail.Body = dtRecipients.Rows[i]["FirstName"].ToString() + " " + dtRecipients.Rows[i]["LastName"].ToString() + ",<br />Please find the " + strReportTitle + " Attached with this mail.<br /><br /><br />Thankyou!<br />" + strFirstName + " " + strLastName;
                        mail.Body += "<br /> This is system generated message. Please do not reply.";
                        mail.IsBodyHtml = true;
                        mail.To.Add(new MailAddress(dtRecipients.Rows[i]["Email"].ToString()));
                        mSmtpClient.Send(mail);
                        mail.To.Clear();
                    }
                }
                catch (Exception ex)
                {
                    EventLog.WriteEntry("Error in Sending Mail for " + strReportTitle + ", " + ex.Message + ",Stack Trace:" + ex.StackTrace);
                }
                atts.Dispose();

                if (File.Exists(strPath))
                    File.Delete(strPath);
            }

            else
            {
                EventLog.WriteEntry("Error in converting Report to PDF for " + strReportTitle);
            }
        }
        #endregion

        #region Get Month String
        private string GetMonthString(Int32 Month)
        {
            string strMonthName = string.Empty;
            switch (Month)
            {
                case 1:
                    strMonthName = "January";
                    break;
                case 2:
                    strMonthName = "February";
                    break;
                case 3:
                    strMonthName = "March";
                    break;
                case 4:
                    strMonthName = "April";
                    break;
                case 5:
                    strMonthName = "May";
                    break;
                case 6:
                    strMonthName = "June";
                    break;
                case 7:
                    strMonthName = "July";
                    break;
                case 8:
                    strMonthName = "August";
                    break;
                case 9:
                    strMonthName = "September";
                    break;
                case 10:
                    strMonthName = "October";
                    break;
                case 11:
                    strMonthName = "November";
                    break;
                case 12:
                    strMonthName = "December";
                    break;
            }
            return strMonthName;

        }


        #endregion

        #region "Common Methods"
        /// <summary>
        /// Converts decimal value to string to be displayed in labels
        /// </summary>
        /// <param name="decValue"></param>
        /// <returns></returns>
        public static string GetStringValue(object objValue)
        {
            if (objValue == null || objValue == DBNull.Value)
                return string.Empty;
            else
                return Convert.ToDecimal(objValue).ToString("C").Replace("$", "");
        }
        /// <summary>
        /// Sets the dates for the labels which are not mendatory fields,
        /// it may have null value which should return an empty string
        /// </summary>
        /// <param name="objDate"></param>
        /// <returns></returns>
        public static string FormatDBNullDateToDisplay(object objDate)
        {
            if (objDate == DBNull.Value || objDate == null || objDate == "")
                return string.Empty;
            else
                return FormatDateToDisplay(Convert.ToDateTime(objDate));
        }

        /// <summary>
        /// if object is not able to be converted to int, it returns 0
        /// </summary>
        /// <param name="obj"></param>
        /// <returns></returns>
        public static int GetInt(object obj)
        {
            string strObj = Convert.ToString(obj);
            int result;
            int.TryParse(strObj, out result);
            return result;
        }

        /// <summary>
        /// Get Comma Seperated Value from passed table and Column
        /// </summary>
        /// <param name="dt"></param>
        /// <param name="ColumnName"></param>
        /// <returns></returns>
        private static string GetCommaValueFromTable(DataTable dt, string ColumnName)
        {
            string _strValue = string.Empty;

            for (int i = 0; i < dt.Rows.Count; i++)
                _strValue += (_strValue == "") ? dt.Rows[i][ColumnName].ToString().Trim() : "<b>,</b> " + dt.Rows[i][ColumnName].ToString().Trim();

            return _strValue;
        }

        /// <summary>
        /// Sets the dates for the labels which are not mendatory fields,
        /// it may have Minvalue (01/01/1975) which should return an empty string
        /// </summary>
        /// <param name="objDT"></param>
        /// <returns></returns>
        public static string FormatDateToDisplay(DateTime objDate)
        {
            if (Convert.ToDateTime(objDate) != (DateTime)System.Data.SqlTypes.SqlDateTime.MinValue)
                return Convert.ToDateTime(objDate).ToString(DateDisplayFormat);
            else
                return string.Empty;
        }

        /// <summary>
        /// return Date in short date format if it is null then it return minimum value 
        /// </summary>
        /// <param name="obj"></param>
        /// <returns></returns>
        public static DateTime FormatDateToStore(object objDate)
        {
            if (!String.IsNullOrEmpty(objDate.ToString()))
            {
                return Convert.ToDateTime(objDate.ToString());
            }
            else
            {
                return (DateTime)System.Data.SqlTypes.SqlDateTime.MinValue;
            }
        }
        #endregion

        #region "Exposure Report"
        public string GetScoreName(object objValue)
        {
            if (objValue != null)
            {
                if (objValue.ToString() == "1")
                {
                    return "Tin";
                }
                else if (objValue.ToString() == "2")
                {
                    return "Bronze";
                }
                else if (objValue.ToString() == "3")
                {
                    return "Silver";
                }
                else if (objValue.ToString() == "4")
                {
                    return "Gold";
                }
                else if (objValue.ToString() == "5")
                {
                    return "Platinum";
                }
                else
                    return "";
            }
            else
            {
                return "";
            }
        }
        #endregion

        #region "ACI Ad-hoc methods"

        /// <summary>
        /// Bind and return Group By String
        /// </summary>
        /// <param name="ObjAdHocReport"></param>
        /// <returns></returns>
        private string BindGroupBy(ERIMS_DAL.AdHocReport ObjAdHocReport)
        {
            string strGroupBy = string.Empty;
            AdhocReportFields objReportFields = new AdhocReportFields();
            List<AdhocReportFields> lstAdhoc = null;

            if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.FirstGroupBy)))
            {
                if (ObjAdHocReport.FirstGroupBy == -2)
                {
                    strGroupBy = "[Accident Year] " + ObjAdHocReport.FirstGroupByOrder;
                }
                else
                {
                    lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.FirstGroupBy));
                    strGroupBy = " [" + lstAdhoc[0].Field_Header + "] " + ObjAdHocReport.FirstGroupByOrder;
                }
            }

            if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.SecondGroupBy)))
            {
                if (ObjAdHocReport.SecondGroupBy == -3)
                {
                    strGroupBy += (string.IsNullOrEmpty(strGroupBy) ? "" : ",") + "Accident Year" + ObjAdHocReport.SecondGroupByOrder;
                }
                else
                {
                    lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.SecondGroupBy));
                    strGroupBy += (string.IsNullOrEmpty(strGroupBy) ? "" : ",") + " [" + lstAdhoc[0].Field_Header + "] " + ObjAdHocReport.SecondGroupByOrder;
                }
            }

            if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.ThirdGroupBy)))
            {
                if (ObjAdHocReport.ThirdGroupBy == -3)
                {
                    strGroupBy += (string.IsNullOrEmpty(strGroupBy) ? "" : ",") + "Accident Year" + ObjAdHocReport.ThirdGroupByOrder;
                }
                else
                {
                    lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.ThirdGroupBy));
                    strGroupBy += (string.IsNullOrEmpty(strGroupBy) ? "" : ",") + " [" + lstAdhoc[0].Field_Header + "] " + ObjAdHocReport.ThirdGroupByOrder;
                }
            }

            if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.FourthGroupBy)))
            {
                if (ObjAdHocReport.FourthGroupBy == -3)
                {
                    strGroupBy += (string.IsNullOrEmpty(strGroupBy) ? "" : ",") + "Accident Year" + ObjAdHocReport.FourthGroupByOrder;
                }
                else
                {
                    lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.FourthGroupBy));
                    strGroupBy += (string.IsNullOrEmpty(strGroupBy) ? "" : ",") + " [" + lstAdhoc[0].Field_Header + "] " + ObjAdHocReport.FourthGroupByOrder;
                }
            }

            if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.FifthGroupBy)))
            {
                if (ObjAdHocReport.FifthGroupBy == -3)
                {
                    strGroupBy += (string.IsNullOrEmpty(strGroupBy) ? "" : ",") + "Accident Year" + ObjAdHocReport.FifthGroupByOrder;
                }
                else
                {
                    lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.FifthGroupBy));
                    strGroupBy += (string.IsNullOrEmpty(strGroupBy) ? "" : ",") + " [" + lstAdhoc[0].Field_Header + "] " + ObjAdHocReport.FifthGroupByOrder;
                }
            }


            return strGroupBy;
        }

        /// <summary>
        /// Bind and return Group By String for Management
        /// </summary>
        /// <param name="ObjAdHocReport"></param>
        /// <returns></returns>
        private string BindGroupByForManagement(ERIMS_DAL.Management_AdHocReport ObjAdHocReport)
        {
            string strGroupBy = string.Empty;
            Management_AdhocReportFields objReportFields = new Management_AdhocReportFields();
            List<Management_AdhocReportFields> lstAdhoc = null;

            if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.FirstGroupBy)))
            {
                if (ObjAdHocReport.FirstGroupBy == -2)
                {
                    strGroupBy = "[Accident Year] " + ObjAdHocReport.FirstGroupByOrder;
                }
                else
                {
                    lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.FirstGroupBy));
                    strGroupBy = " [" + lstAdhoc[0].Field_Header + "] " + ObjAdHocReport.FirstGroupByOrder;
                }
            }

            if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.SecondGroupBy)))
            {
                if (ObjAdHocReport.SecondGroupBy == -3)
                {
                    strGroupBy += (string.IsNullOrEmpty(strGroupBy) ? "" : ",") + "Accident Year" + ObjAdHocReport.SecondGroupByOrder;
                }
                else
                {
                    lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.SecondGroupBy));
                    strGroupBy += (string.IsNullOrEmpty(strGroupBy) ? "" : ",") + " [" + lstAdhoc[0].Field_Header + "] " + ObjAdHocReport.SecondGroupByOrder;
                }
            }

            if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.ThirdGroupBy)))
            {
                if (ObjAdHocReport.ThirdGroupBy == -3)
                {
                    strGroupBy += (string.IsNullOrEmpty(strGroupBy) ? "" : ",") + "Accident Year" + ObjAdHocReport.ThirdGroupByOrder;
                }
                else
                {
                    lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.ThirdGroupBy));
                    strGroupBy += (string.IsNullOrEmpty(strGroupBy) ? "" : ",") + " [" + lstAdhoc[0].Field_Header + "] " + ObjAdHocReport.ThirdGroupByOrder;
                }
            }

            if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.FourthGroupBy)))
            {
                if (ObjAdHocReport.FourthGroupBy == -3)
                {
                    strGroupBy += (string.IsNullOrEmpty(strGroupBy) ? "" : ",") + "Accident Year" + ObjAdHocReport.FourthGroupByOrder;
                }
                else
                {
                    lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.FourthGroupBy));
                    strGroupBy += (string.IsNullOrEmpty(strGroupBy) ? "" : ",") + " [" + lstAdhoc[0].Field_Header + "] " + ObjAdHocReport.FourthGroupByOrder;
                }
            }

            if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.FifthGroupBy)))
            {
                if (ObjAdHocReport.FifthGroupBy == -3)
                {
                    strGroupBy += (string.IsNullOrEmpty(strGroupBy) ? "" : ",") + "Accident Year" + ObjAdHocReport.FifthGroupByOrder;
                }
                else
                {
                    lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.FifthGroupBy));
                    strGroupBy += (string.IsNullOrEmpty(strGroupBy) ? "" : ",") + " [" + lstAdhoc[0].Field_Header + "] " + ObjAdHocReport.FifthGroupByOrder;
                }
            }


            return strGroupBy;
        }

        /// <summary>
        /// Bind and return Order By String
        /// </summary>
        /// <param name="ObjAdHocReport"></param>
        /// <returns></returns>
        private string BindOrderBy(ERIMS_DAL.AdHocReport ObjAdHocReport)
        {
            string strOrderBy = string.Empty;
            AdhocReportFields objReportFields = new AdhocReportFields();
            List<AdhocReportFields> lstAdhoc = null;
            if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.FirstSortBy)))
            {
                lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.FirstSortBy));
                strOrderBy = " [" + lstAdhoc[0].Field_Header + "] " + ObjAdHocReport.FirstSortByOrder;
            }
            if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.SecondSortBy)))
            {
                lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.SecondSortBy));
                strOrderBy += (string.IsNullOrEmpty(strOrderBy) ? "" : ",") + " [" + lstAdhoc[0].Field_Header + "] " + ObjAdHocReport.SecondGroupByOrder;
            }
            if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.ThirdSortBy)))
            {
                lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.ThirdSortBy));
                strOrderBy += (string.IsNullOrEmpty(strOrderBy) ? "" : ",") + " [" + lstAdhoc[0].Field_Header + "] " + ObjAdHocReport.ThirdSortByOrder;
            }
            if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.FourthSortBy)))
            {
                lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.FourthSortBy));
                strOrderBy += (string.IsNullOrEmpty(strOrderBy) ? "" : ",") + " [" + lstAdhoc[0].Field_Header + "] " + ObjAdHocReport.FourthSortByOrder;
            }
            if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.FifthSortBy)))
            {
                lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.FifthSortBy));
                strOrderBy += (string.IsNullOrEmpty(strOrderBy) ? "" : ",") + " [" + lstAdhoc[0].Field_Header + "] " + ObjAdHocReport.FifthSortByOrder;
            }
            return strOrderBy;
        }

        /// <summary>
        /// Bind and return Order By String For Management
        /// </summary>
        /// <param name="ObjAdHocReport"></param>
        /// <returns></returns>
        private string BindOrderByForManagement(ERIMS_DAL.Management_AdHocReport ObjAdHocReport)
        {
            string strOrderBy = string.Empty;
            Management_AdhocReportFields objReportFields = new Management_AdhocReportFields();
            List<Management_AdhocReportFields> lstAdhoc = null;
            if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.FirstSortBy)))
            {
                lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.FirstSortBy));
                strOrderBy = " [" + lstAdhoc[0].Field_Header + "] " + ObjAdHocReport.FirstSortByOrder;
            }
            if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.SecondSortBy)))
            {
                lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.SecondSortBy));
                strOrderBy += (string.IsNullOrEmpty(strOrderBy) ? "" : ",") + " [" + lstAdhoc[0].Field_Header + "] " + ObjAdHocReport.SecondGroupByOrder;
            }
            if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.ThirdSortBy)))
            {
                lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.ThirdSortBy));
                strOrderBy += (string.IsNullOrEmpty(strOrderBy) ? "" : ",") + " [" + lstAdhoc[0].Field_Header + "] " + ObjAdHocReport.ThirdSortByOrder;
            }
            if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.FourthSortBy)))
            {
                lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.FourthSortBy));
                strOrderBy += (string.IsNullOrEmpty(strOrderBy) ? "" : ",") + " [" + lstAdhoc[0].Field_Header + "] " + ObjAdHocReport.FourthSortByOrder;
            }
            if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.FifthSortBy)))
            {
                lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.FifthSortBy));
                strOrderBy += (string.IsNullOrEmpty(strOrderBy) ? "" : ",") + " [" + lstAdhoc[0].Field_Header + "] " + ObjAdHocReport.FifthSortByOrder;
            }
            return strOrderBy;
        }

        /// <summary>
        /// Bind Report Data.
        /// </summary>
        /// <param name="dsReport">Report Dataset</param>
        private string BindReport(ref StringBuilder sbRecord, IDataReader Reader, ERIMS_DAL.AdHocReport ObjAdHocReport, List<ERIMS_DAL.AdHocFilter> lstFilter, string strReportSchedulerName)
        {
            DataTable dtSchema = null, dtHeader = null;
            AdhocReportFields objReportFields = new AdhocReportFields();
            List<AdhocReportFields> lstAdhoc = null;
            string strPath = string.Empty;
            Boolean IsGroupBySelected = false;
            Int32 countColumn = 0;


            try
            {
                #region "Filter and Title"
                sbRecord.Append("<table cellpadding='0' cellspacing='0' style='font-size:10pt'>");
                sbRecord.Append("<tr><td colspan='3'><b>Report Title : " + strReportSchedulerName + " </b></td></tr>");
                //sbRecord.Append("<br /><br />");

                AdhocReportFields obj = new AdhocReportFields();
                for (int i = 0; i < lstFilter.Count; i++)
                {
                    string strConditionVal = string.Empty;
                    if (lstFilter[i].Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.TextBox)
                    {
                        string strConditionType = lstFilter[i].ConditionType;
                        if (Convert.ToBoolean(lstFilter[i].IsNotSelected) == true)
                            strConditionType = (strConditionType == "1") ? " Not Contains " : (strConditionType == "2" ? " Not Start With " : " Not End With ");
                        else
                            strConditionType = (strConditionType == "1") ? " Contains " : (strConditionType == "2" ? " Start With " : " End With ");
                        strConditionVal = lstFilter[i].ConditionValue;
                        lstAdhoc = obj.GetAdHocReportFieldByPk(Convert.ToDecimal(lstFilter[i].FK_AdHocReportFields));
                        sbRecord.Append("<tr><td colspan='3'><b>" + lstAdhoc[0].Field_Header + " : " + strConditionType + "</b>" + lstFilter[i].ConditionValue + "</td></tr>");
                    }

                    if (lstFilter[i].Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.MultiSelectList)
                    {
                        lstAdhoc = obj.GetAdHocReportFieldByPk(Convert.ToDecimal(lstFilter[i].FK_AdHocReportFields));
                        if (Convert.ToBoolean(lstFilter[i].IsNotSelected) == true)
                            sbRecord.Append("<tr><td colspan='3'><b>" + lstAdhoc[0].Field_Header + " (Not In)</b>" + " : " + FillFilterDropDown(lstAdhoc[0].Field_Header, lstFilter[i].ConditionValue) + "</td></tr>");
                        else
                            sbRecord.Append("<tr><td colspan='3'><b>" + lstAdhoc[0].Field_Header + " (In)</b>" + " : " + FillFilterDropDown(lstAdhoc[0].Field_Header, lstFilter[i].ConditionValue) + "</td></tr>");
                    }

                    if (lstFilter[i].Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.DateControl)
                    {
                        string strConditionType = lstFilter[i].ConditionType;
                        lstAdhoc = obj.GetAdHocReportFieldByPk(Convert.ToDecimal(lstFilter[i].FK_AdHocReportFields));
                        strConditionType = (strConditionType == "O") ? " On " : (strConditionType == "B" ? " Between " : (strConditionType == "BF" ? "On or Before " : "On or After "));

                        string dtFrom = null, dtTo = null;
                        if (string.IsNullOrEmpty(lstFilter[i].FromRelativeCriteria))
                            dtFrom = FormatDBNullDateToDisplay(lstFilter[i].FromDate);
                        else
                        {
                            // set Relative Date From criteria
                            AdHocReportHelper.RaltiveDates RelType = (AdHocReportHelper.RaltiveDates)Enum.Parse(typeof(AdHocReportHelper.RaltiveDates), lstFilter[i].FromRelativeCriteria);
                            dtFrom = AdHocReportHelper.GetRelativeDate(RelType).ToString("MM/dd/yyyy");
                        }
                        if (string.IsNullOrEmpty(lstFilter[i].ToRelativeCriteria))
                            dtTo = FormatDBNullDateToDisplay(lstFilter[i].ToDate);
                        else
                        {
                            // set Relative Date To criteria
                            AdHocReportHelper.RaltiveDates RelType = (AdHocReportHelper.RaltiveDates)Enum.Parse(typeof(AdHocReportHelper.RaltiveDates), lstFilter[i].ToRelativeCriteria);
                            dtTo = AdHocReportHelper.GetRelativeDate(RelType).ToString("MM/dd/yyyy");
                        }

                        if (Convert.ToBoolean(lstFilter[i].IsNotSelected) == true)
                            strConditionType = "Not" + strConditionType;

                        if (strConditionType.Trim() != "Between" && strConditionType.Trim() != "Not Between")
                            strConditionVal = "<tr><td colspan='3'><b>" + lstAdhoc[0].Field_Header + " : " + strConditionType + "</b>" + dtFrom + "</td></tr>";
                        else
                            strConditionVal = "<tr><td colspan='3'><b>" + lstAdhoc[0].Field_Header + " : </b>" + strConditionType + dtFrom + " And " + dtTo + "</td></tr>";

                        sbRecord.Append(strConditionVal);
                    }
                    if (lstFilter[i].Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.AmountControl)
                    {
                        string strConditionType = lstFilter[i].ConditionType;
                        lstAdhoc = obj.GetAdHocReportFieldByPk(Convert.ToDecimal(lstFilter[i].FK_AdHocReportFields));
                        strConditionType = (strConditionType == "0") ? " Equal " : (strConditionType == "1" ? " Greater Than " : (strConditionType == "2" ? " Between " : " Less Than "));

                        if (Convert.ToBoolean(lstFilter[i].IsNotSelected) == true)
                            strConditionType = "Not" + strConditionType;

                        if (strConditionType.Trim() != "Between" && strConditionType.Trim() != "Not Between")
                            strConditionVal = "<tr><td colspan='3'><b>" + lstAdhoc[0].Field_Header + " : " + strConditionType + "</b>" + Convert.ToString(lstFilter[i].AmountFrom) + "</td></tr>";
                        else
                            strConditionVal = "<tr><td colspan='3'><b>" + lstAdhoc[0].Field_Header + " : </b>" + strConditionType + Convert.ToString(lstFilter[i].AmountFrom) + " And " + Convert.ToString(lstFilter[i].AmountTo) + "</td></tr>";
                        sbRecord.Append(strConditionVal);
                    }
                    // sbRecord.Append("<br />");
                }
                //sbRecord.Append("<br /></td></tr></table>");
                //sbRecord.Append("<br/>");
                #endregion

                // Check if Any record is exists or not
                if (Reader.Read())
                {
                    string strFirstGroupBy = string.Empty, strSecGroupBy = string.Empty, strThirdGroupBy = null, strFourthGroupBy = null, strFifthGroupBy = null;

                    if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.FirstGroupBy)))
                    {
                        if (ObjAdHocReport.FirstGroupBy == -2)
                            strFirstGroupBy = "Accident Year";
                        else
                        {
                            lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.FirstGroupBy));
                            strFirstGroupBy = lstAdhoc[0].Field_Header;
                        }

                        IsGroupBySelected = true;
                    }

                    if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.SecondGroupBy)))
                    {
                        if (ObjAdHocReport.SecondGroupBy == -3)
                            strSecGroupBy = "Accident Year";
                        else
                        {
                            lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.SecondGroupBy));
                            strSecGroupBy = lstAdhoc[0].Field_Header;
                        }

                        IsGroupBySelected = true;
                    }

                    if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.ThirdGroupBy)))
                    {
                        if (ObjAdHocReport.ThirdGroupBy == -3)
                            strThirdGroupBy = "Accident Year";
                        else
                        {
                            lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.ThirdGroupBy));
                            strThirdGroupBy = lstAdhoc[0].Field_Header;
                        }

                        IsGroupBySelected = true;
                    }
                    if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.FourthGroupBy)))
                    {
                        if (ObjAdHocReport.FourthGroupBy == -3)
                            strFourthGroupBy = "Accident Year";
                        else
                        {
                            lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.FourthGroupBy));
                            strFourthGroupBy = lstAdhoc[0].Field_Header;
                        }

                        IsGroupBySelected = true;
                    }
                    if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.FifthGroupBy)))
                    {
                        if (ObjAdHocReport.FifthGroupBy == -3)
                            strFifthGroupBy = "Accident Year";
                        else
                        {
                            lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.FifthGroupBy));
                            strFifthGroupBy = lstAdhoc[0].Field_Header;
                        }

                        IsGroupBySelected = true;
                    }

                    //iF First Group By is Not  selected then second Group by will be set as first Group By
                    if (string.IsNullOrEmpty(strFirstGroupBy))
                    {
                        strFirstGroupBy = strSecGroupBy;
                        strSecGroupBy = string.Empty;
                    }

                    dtSchema = Reader.GetSchemaTable();

                    sbRecord.Append("<tr><td><table border='1' cellpadding='0' cellspacing='0' width='" + (150 * (ObjAdHocReport.OutputFields.Split(',').Length + 1)).ToString() + "' style='font-size:10pt'>");

                    #region "Header"
                    // If reader found a records 
                    sbRecord.Append("<tr>");
                    if (IsGroupBySelected)
                        sbRecord.Append("<td colspan='2'>&nbsp;</td>");
                    dtHeader = new DataTable();
                    string strFormatFirstGroupBy = string.Empty, strFormatSecGroupBy = string.Empty, strFormatThirdGroupBy = string.Empty, strFormatFourthGroupBy = string.Empty, strFormatFifthGroupBy = string.Empty;
                    foreach (DataRow drHeader in dtSchema.Rows)
                    {
                        //Remove Group By 
                        if (strFirstGroupBy != Convert.ToString(drHeader["ColumnName"]) && strSecGroupBy != Convert.ToString(drHeader["ColumnName"]) && strThirdGroupBy != Convert.ToString(drHeader["ColumnName"]) && strFourthGroupBy != Convert.ToString(drHeader["ColumnName"]) && strFifthGroupBy != Convert.ToString(drHeader["ColumnName"]))
                        {
                            if (drHeader["ColumnName"].ToString() != "Claim Count")
                            {
                                sbRecord.Append("<td><b>" + drHeader["ColumnName"] + "</b></td>");
                                countColumn++;
                            }

                        }

                        //IF Grand Total Option is Selected.
                        if (Convert.ToString(ObjAdHocReport.GrandTotal) == "Y" && CheckTotalField(drHeader["ColumnName"].ToString()))
                            dtHeader.Columns.Add(new DataColumn(drHeader["ColumnName"].ToString(), Type.GetType("System.Decimal")));

                        //Get  Group By Field's Data Type
                        if (strFirstGroupBy == Convert.ToString(drHeader["ColumnName"]))
                            strFormatFirstGroupBy = drHeader["DataTypeName"].ToString();
                        if (strSecGroupBy == Convert.ToString(drHeader["ColumnName"]))
                            strFormatSecGroupBy = drHeader["DataTypeName"].ToString();
                        if (strThirdGroupBy == Convert.ToString(drHeader["ColumnName"]))
                            strFormatThirdGroupBy = drHeader["DataTypeName"].ToString();
                        if (strFourthGroupBy == Convert.ToString(drHeader["ColumnName"]))
                            strFormatFourthGroupBy = drHeader["DataTypeName"].ToString();
                        if (strFifthGroupBy == Convert.ToString(drHeader["ColumnName"]))
                            strFormatFifthGroupBy = drHeader["DataTypeName"].ToString();

                    }
                    //When Header have records
                    if (dtHeader.Columns.Count > 0)
                    {
                        DataRow drHerder = dtHeader.NewRow();

                        for (int i = 0; i < dtHeader.Columns.Count; i++)
                            drHerder[i] = 0;

                        dtHeader.Rows.Add(drHerder);
                        dtHeader.AcceptChanges();
                    }

                    sbRecord.Append("</tr>");

                    #endregion

                    strPath = AppDomain.CurrentDomain.BaseDirectory + @"temp\" + strReportSchedulerName + System.DateTime.Now.ToString("MMddyyhhmmss") + ".xls";

                    if (!File.Exists(strPath))
                    {
                        if (!Directory.Exists(AppDomain.CurrentDomain.BaseDirectory + @"temp\"))
                            Directory.CreateDirectory(AppDomain.CurrentDomain.BaseDirectory + @"temp\");
                        // Create a file to write to.
                        //Remove WhiteSpace
                        sbRecord.Replace("<tr></tr>", "");
                        File.SetAttributes(AppDomain.CurrentDomain.BaseDirectory, FileAttributes.Normal);
                        using (StreamWriter sw = File.CreateText(strPath))
                        {
                            sw.Write(sbRecord.ToString());
                            sbRecord = new StringBuilder(string.Empty);
                        }
                    }

                    #region "Item Template"

                    DataTable dtSubTotalFirstGroup = dtHeader.Clone();
                    DataTable dtSubTotalSecondGroup = dtHeader.Clone();
                    DataTable dtSubTotalThirdGroup = dtHeader.Clone();
                    DataTable dtSubTotalFourthGroup = dtHeader.Clone();
                    DataTable dtSubTotalFifthGroup = dtHeader.Clone();

                    string strGroupByValue_1 = string.Empty, strGroupByValue_2 = string.Empty, strNOGroup1 = string.Empty, strNOGroup2 = string.Empty;
                    string strGroupByValue_3 = string.Empty, strGroupByValue_4 = string.Empty, strNOGroup3 = string.Empty, strNOGroup4 = string.Empty;
                    string strGroupByValue_5 = string.Empty, strNOGroup5 = string.Empty;

                    do
                    {
                        string strFormat = string.Empty;

                        #region "SUBTOTALS"

                        #region Fifth
                        // print subtotal for 5th group by when the value is changed
                        if (!string.IsNullOrEmpty(strFifthGroupBy) && !string.IsNullOrEmpty(strGroupByValue_5) && strGroupByValue_5 != Convert.ToString(Reader[strFifthGroupBy]))
                        {
                            if (dtSubTotalFifthGroup.Rows.Count > 0)
                            {
                                sbRecord.Append("<tr>");
                                int intCol = 1;
                                //first column is for sub total when sub total is found
                                if (dtSchema.Rows.Count > 0)
                                    sbRecord.Append("<td><b>Sub Total For " + strFifthGroupBy + "</b></td>");
                                foreach (DataRow drSchema in dtSchema.Rows)
                                {
                                    string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();

                                    if (strFirstGroupBy != strColName && strSecGroupBy != strColName && strThirdGroupBy != strColName && strFourthGroupBy != strColName && strFifthGroupBy != strColName)
                                    {
                                        if (dtSubTotalFifthGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                                            sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalFifthGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                                        else
                                        {
                                            //if (intCol == 1)
                                            //    sbRecord.Append("<td><b>Sub Total For " + strFifthGroupBy + "</b></td><td>&nbsp;</td>");
                                            //else
                                            //{
                                            sbRecord.Append("<td>&nbsp;</td>");
                                            //}
                                        }
                                    }
                                    intCol++;
                                }

                                sbRecord.Append("</tr>");
                                dtSubTotalFifthGroup.Clear();
                            }
                        }
                        #endregion

                        #region Fourth
                        // print subtotal for 4th group by when the value is changed
                        if (!string.IsNullOrEmpty(strFourthGroupBy) && !string.IsNullOrEmpty(strGroupByValue_4) && strGroupByValue_4 != Convert.ToString(Reader[strFourthGroupBy]))
                        {
                            if (dtSubTotalFourthGroup.Rows.Count > 0)
                            {
                                sbRecord.Append("<tr>");
                                int intCol = 1;

                                if (dtSchema.Rows.Count > 0)
                                    sbRecord.Append("<td><b>Sub Total For " + strFourthGroupBy + "</b></td>");
                                foreach (DataRow drSchema in dtSchema.Rows)
                                {
                                    string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();
                                    if (strFirstGroupBy != strColName && strSecGroupBy != strColName && strThirdGroupBy != strColName && strFourthGroupBy != strColName && strFifthGroupBy != strColName)
                                    {

                                        if (dtSubTotalFourthGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                                            sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalFourthGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                                        else
                                        {
                                            //if (intCol == 1)
                                            //    sbRecord.Append("<td><b>Sub Total For " + strFourthGroupBy + "</b></td><td>&nbsp;</td>");
                                            //else
                                            //{

                                            sbRecord.Append("<td>&nbsp;</td>");
                                            //}
                                        }
                                    }
                                    intCol++;
                                }

                                sbRecord.Append("</tr>");
                                dtSubTotalFourthGroup.Clear();
                            }
                        }
                        #endregion

                        #region Third
                        // print subtotal for 3rd group by when the value is changed
                        if (!string.IsNullOrEmpty(strThirdGroupBy) && !string.IsNullOrEmpty(strGroupByValue_3) && strGroupByValue_3 != Convert.ToString(Reader[strThirdGroupBy]))
                        {
                            if (dtSubTotalThirdGroup.Rows.Count > 0)
                            {
                                sbRecord.Append("<tr>");
                                int intCol = 1;
                                if (dtSchema.Rows.Count > 0)
                                    sbRecord.Append("<td><b>Sub Total For " + strThirdGroupBy + "</b></td>");
                                foreach (DataRow drSchema in dtSchema.Rows)
                                {
                                    string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();

                                    if (strFirstGroupBy != strColName && strSecGroupBy != strColName && strThirdGroupBy != strColName && strFourthGroupBy != strColName && strFifthGroupBy != strColName)
                                    {

                                        if (dtSubTotalThirdGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                                            sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalThirdGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                                        else
                                        {
                                            //if (intCol == 1)
                                            //    sbRecord.Append("<td><b>Sub Total For " + strThirdGroupBy + "</b></td><td>&nbsp;</td>");
                                            //else
                                            //{

                                            sbRecord.Append("<td>&nbsp;</td>");
                                            //}
                                        }
                                    }

                                    intCol++;
                                }

                                sbRecord.Append("</tr>");
                                dtSubTotalThirdGroup.Clear();
                            }
                        }
                        #endregion

                        #region Second
                        // print subtotal for 2nd group by when the value is changed
                        if (!string.IsNullOrEmpty(strSecGroupBy) && !string.IsNullOrEmpty(strGroupByValue_2) && strGroupByValue_2 != Convert.ToString(Reader[strSecGroupBy]))
                        {
                            if (dtSubTotalSecondGroup.Rows.Count > 0)
                            {
                                sbRecord.Append("<tr>");
                                int intCol = 1;
                                if (dtSchema.Rows.Count > 0)
                                    sbRecord.Append("<td><b>Sub Total For " + strSecGroupBy + "</b></td>");
                                foreach (DataRow drSchema in dtSchema.Rows)
                                {
                                    string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();

                                    if (strFirstGroupBy != strColName && strSecGroupBy != strColName && strThirdGroupBy != strColName && strFourthGroupBy != strColName && strFifthGroupBy != strColName)
                                    {
                                        if (dtSubTotalSecondGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                                            sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalSecondGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                                        else
                                        {
                                            //if (intCol == 1)
                                            //    sbRecord.Append("<td><b>Sub Total For " + strSecGroupBy + "</b></td><td>&nbsp;</td>");
                                            //else
                                            //{

                                            sbRecord.Append("<td>&nbsp;</td>");
                                            // }
                                        }
                                    }

                                    intCol++;
                                }

                                sbRecord.Append("</tr>");
                                dtSubTotalSecondGroup.Clear();
                            }
                        }
                        #endregion

                        #region First
                        // print subtotal for 1st group by when the value is changed
                        if (!string.IsNullOrEmpty(strFirstGroupBy) && !string.IsNullOrEmpty(strGroupByValue_1) && strGroupByValue_1 != Convert.ToString(Reader[strFirstGroupBy]))
                        {
                            if (dtSubTotalFirstGroup.Rows.Count > 0)
                            {
                                sbRecord.Append("<tr>");
                                int intCol = 1;
                                if (dtSchema.Rows.Count > 0)
                                    sbRecord.Append("<td><b>Sub Total For " + strFirstGroupBy + "</b></td>");
                                foreach (DataRow drSchema in dtSchema.Rows)
                                {
                                    string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();

                                    if (strFirstGroupBy != strColName && strSecGroupBy != strColName && strThirdGroupBy != strColName && strFourthGroupBy != strColName && strFifthGroupBy != strColName)
                                    {
                                        if (dtSubTotalFirstGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                                            sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalFirstGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                                        else
                                        {
                                            //if (intCol == 1)
                                            //    sbRecord.Append("<td><b>Sub Total For " + strFirstGroupBy + "</b></td><td>&nbsp;</td>");
                                            //else
                                            //{

                                            sbRecord.Append("<td>&nbsp;</td>");
                                            //}
                                        }
                                    }

                                    intCol++;
                                }

                                sbRecord.Append("</tr>");
                                dtSubTotalFirstGroup.Clear();
                            }
                        }
                        #endregion

                        #endregion

                        #region Group By

                        #region First Group
                        if (!string.IsNullOrEmpty(strFirstGroupBy))
                        {
                            if (strGroupByValue_1 != Convert.ToString(Reader[strFirstGroupBy]))
                            {
                                strGroupByValue_1 = Convert.ToString(Reader[strFirstGroupBy]);
                                if (strFormatFirstGroupBy == "decimal")
                                    sbRecord.Append("<tr><td style='font-weight: bold;color: #FF9C09;' colspan='2' align='right' >&nbsp;" + strFirstGroupBy + ": " + string.Format("{0:c2}", strGroupByValue_1) + "</td></tr>");
                                else if (strFormatFirstGroupBy == "datetime")
                                {
                                    // it display only Time
                                    if (strFirstGroupBy == "Time Theft Reported")
                                        sbRecord.Append("<tr><td style='font-weight: bold;color: #FF9C09;' colspan='2'>&nbsp;" + strFirstGroupBy + ": " + string.Format("{0:HH:mm}", Reader[strFirstGroupBy]) + "</td></tr>");
                                    else sbRecord.Append("<tr><td style='font-weight: bold;color: #FF9C09;' colspan='2'>&nbsp;" + strFirstGroupBy + ": " + FormatDBNullDateToDisplay(strGroupByValue_1) + "</td></tr>");
                                }
                                else sbRecord.Append("<tr><td style='font-weight: bold;color: #FF9C09;' colspan='2'>&nbsp;" + strFirstGroupBy + ": " + strGroupByValue_1 + "</td><td  style='border-bottom:none;' rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                //Change Second Group By when First Groupby is Change
                                strGroupByValue_2 = string.Empty;
                            }
                            // it will set No : [First Group By] when it is null
                            else if ((Reader[strFirstGroupBy] == DBNull.Value || string.IsNullOrEmpty(Convert.ToString(Reader[strFirstGroupBy]))) && strNOGroup1 == string.Empty)
                            {
                                strNOGroup1 = "No " + strFirstGroupBy;
                                sbRecord.Append("<tr><td style='font-weight: bold;color: #FF9C09;' colspan='2'>&nbsp;" + strFirstGroupBy + ": " + strNOGroup1 + "</td></tr>");
                                // When Group by 1 value find as Null
                                strNOGroup1 = strFirstGroupBy;
                                //Change Second Group By when First Groupby is Change
                                strGroupByValue_2 = string.Empty;
                            }
                        }
                        #endregion

                        #region Second Group By
                        if (!string.IsNullOrEmpty(strSecGroupBy))
                        {
                            if (strGroupByValue_2 != Convert.ToString(Reader[strSecGroupBy]))
                            {
                                strGroupByValue_2 = Convert.ToString(Reader[strSecGroupBy]);
                                if (strFormatSecGroupBy == "decimal")
                                    sbRecord.Append("<tr><td style='font-weight: bold;color: #276692;' align='right' colspan='2' >&nbsp;" + strSecGroupBy + ": " + string.Format("{0:c2}", strGroupByValue_2) + "</td><td style='border-bottom:none;' rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                else if (strFormatSecGroupBy == "datetime")
                                {
                                    // it display only Time
                                    if (strSecGroupBy == "Time Theft Reported")
                                        sbRecord.Append("<tr><td style='font-weight: bold;color: #276692;' colspan='2'>&nbsp;" + strSecGroupBy + ": " + string.Format("{0:HH:mm}", Reader[strSecGroupBy]) + "</td><td style='border-bottom:none;' rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                    else sbRecord.Append("<tr><td style='font-weight: bold;color: #276692;' colspan='2'>&nbsp;" + strSecGroupBy + ": " + FormatDBNullDateToDisplay(strGroupByValue_2) + "</td><td style='border-bottom:none;' rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                }
                                else sbRecord.Append("<tr><td style='font-weight: bold;color: #276692;' colspan='2'>&nbsp;" + strSecGroupBy + ": " + strGroupByValue_2 + "</td><td style='border-bottom:none;' rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                            }
                            else if (Reader[strSecGroupBy] == DBNull.Value && strNOGroup2 == string.Empty)
                            {
                                strNOGroup2 = "No " + strSecGroupBy;
                                sbRecord.Append("<tr><td style='font-weight: bold;color: #276692;' colspan='2'>&nbsp;" + strSecGroupBy + ": " + strNOGroup2 + "</td><td style='border-bottom:none;' rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                //No Group by assign
                                strNOGroup2 = strGroupByValue_2;
                            }
                        }
                        #endregion

                        #region Third Group BY
                        if (!string.IsNullOrEmpty(strThirdGroupBy))
                        {
                            if (strGroupByValue_3 != Convert.ToString(Reader[strThirdGroupBy]))
                            {
                                strGroupByValue_3 = Convert.ToString(Reader[strThirdGroupBy]);
                                if (strFormatThirdGroupBy == "decimal")
                                    sbRecord.Append("<tr><td style='font-weight: bold;color: #603311;' align='right' colspan='2'>&nbsp;" + strThirdGroupBy + ": " + string.Format("{0:c2}", strGroupByValue_3) + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                else if (strFormatThirdGroupBy == "datetime")
                                {
                                    // it display only Time
                                    if (strThirdGroupBy == "Time Theft Reported")
                                        sbRecord.Append("<tr><td style='font-weight: bold;color: #603311;' colspan='2'>&nbsp;" + strThirdGroupBy + ": " + string.Format("{0:HH:mm}", Reader[strThirdGroupBy]) + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                    else sbRecord.Append("<tr><td style='font-weight: bold;color: #603311;' colspan='2'>&nbsp;" + strThirdGroupBy + ": " + FormatDBNullDateToDisplay(strGroupByValue_3) + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                }
                                else sbRecord.Append("<tr><td style='font-weight: bold;color: #603311;' colspan='2'>&nbsp;" + strThirdGroupBy + ": " + strGroupByValue_3 + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                strGroupByValue_4 = strGroupByValue_5 = null;
                            }
                            else if ((Reader[strThirdGroupBy] == DBNull.Value || string.IsNullOrEmpty(Convert.ToString(Reader[strThirdGroupBy]))) && strNOGroup3 == string.Empty)
                            {
                                strNOGroup3 = "No " + strThirdGroupBy;
                                sbRecord.Append("<tr><td style='font-weight: bold;color: #603311;' colspan='2'>&nbsp;" + strThirdGroupBy + ": " + strNOGroup3 + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                // When Group by 3 value find as Null
                                strNOGroup3 = strThirdGroupBy;
                                //Change third Group By when 3rd Groupby is Change
                                strGroupByValue_3 = string.Empty;
                            }
                        }
                        #endregion

                        #region Fourth Group BY
                        if (!string.IsNullOrEmpty(strFourthGroupBy))
                        {
                            if (strGroupByValue_4 != Convert.ToString(Reader[strFourthGroupBy]))
                            {
                                strGroupByValue_4 = Convert.ToString(Reader[strFourthGroupBy]);
                                if (strFormatFourthGroupBy == "decimal")
                                    sbRecord.Append("<tr><td style='font-weight: bold;color: green;' align='right' colspan='2'>&nbsp;" + strFourthGroupBy + ": " + string.Format("{0:c2}", strGroupByValue_4) + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                else if (strFormatFourthGroupBy == "datetime")
                                {
                                    // it display only Time
                                    if (strFourthGroupBy == "Time Theft Reported")
                                        sbRecord.Append("<tr><td style='font-weight: bold;color: green;' colspan='2'>&nbsp;" + strFourthGroupBy + ": " + string.Format("{0:HH:mm}", Reader[strFourthGroupBy]) + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                    else sbRecord.Append("<tr><td style='font-weight: bold;color: green;' colspan='2'>&nbsp;" + strFourthGroupBy + ": " + FormatDBNullDateToDisplay(strGroupByValue_4) + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                }
                                else sbRecord.Append("<tr><td style='font-weight: bold;color: green;' colspan='2'>&nbsp;" + strFourthGroupBy + ": " + strGroupByValue_4 + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                strGroupByValue_5 = null;
                            }
                            else if ((Reader[strFourthGroupBy] == DBNull.Value || string.IsNullOrEmpty(Convert.ToString(Reader[strFourthGroupBy]))) && strNOGroup4 == string.Empty)
                            {
                                strNOGroup4 = "No " + strFourthGroupBy;
                                sbRecord.Append("<tr><td style='font-weight: bold;color: green;' colspan='2'>&nbsp;" + strFourthGroupBy + ": " + strNOGroup4 + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                // When Group by 4 value find as Null
                                strNOGroup4 = strFourthGroupBy;
                                //Change Fourth Group By when 4th Groupby is Change
                                strGroupByValue_4 = string.Empty;
                            }
                        }
                        #endregion

                        #region Fifth Group BY
                        if (!string.IsNullOrEmpty(strFifthGroupBy))
                        {
                            if (strGroupByValue_5 != Convert.ToString(Reader[strFifthGroupBy]))
                            {
                                strGroupByValue_5 = Convert.ToString(Reader[strFifthGroupBy]);
                                if (strFormatFifthGroupBy == "decimal")
                                    sbRecord.Append("<tr><td style='font-weight: bold;' align='right' colspan='2'>&nbsp;" + strFifthGroupBy + ": " + string.Format("{0:c2}", strGroupByValue_5) + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                else if (strFormatFifthGroupBy == "datetime")
                                {
                                    // it display only Time
                                    if (strFifthGroupBy == "Time Theft Reported")
                                        sbRecord.Append("<tr><td style='font-weight: bold;' colspan='2'>&nbsp;" + strFifthGroupBy + ": " + string.Format("{0:HH:mm}", Reader[strFifthGroupBy]) + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                    else sbRecord.Append("<tr><td style='font-weight: bold;' colspan='2'>&nbsp;" + strFifthGroupBy + ": " + FormatDBNullDateToDisplay(strGroupByValue_5) + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                }
                                else sbRecord.Append("<tr><td style='font-weight: bold;' colspan='2'>&nbsp;" + strFifthGroupBy + ": " + strGroupByValue_5 + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                            }
                            else if ((Reader[strFifthGroupBy] == DBNull.Value || string.IsNullOrEmpty(Convert.ToString(Reader[strFifthGroupBy]))) && strNOGroup5 == string.Empty)
                            {
                                strNOGroup5 = "No " + strFifthGroupBy;
                                sbRecord.Append("<tr><td style='font-weight: bold;' colspan='2'>&nbsp;" + strFifthGroupBy + ": " + strNOGroup5 + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                // When Group by 5 value find as Null
                                strNOGroup5 = strFifthGroupBy;
                                //Change fifth Group By when fifth Groupby is Change
                                strGroupByValue_5 = string.Empty;
                            }
                        }

                        //sbRecord.Append("</table></td></tr>");
                        #endregion

                        #endregion

                        string strColumnName = string.Empty;
                        sbRecord.Append("<tr>");
                        if (IsGroupBySelected)
                            sbRecord.Append("<td colspan='2'>&nbsp;</td>");
                        ///Print Records
                        //for (int intColumn = 0; intColumn < Reader.FieldCount - 1; intColumn++)
                        for (int intColumn = 0; intColumn <= Reader.FieldCount - 1; intColumn++)
                        {
                            #region " Count Sub Totals"
                            #region First : 1st
                            if (!string.IsNullOrEmpty(strFirstGroupBy) && !string.IsNullOrEmpty(strGroupByValue_1))
                            {
                                if (dtSubTotalFirstGroup.Columns.Contains(Reader.GetName(intColumn)) && Convert.ToString(Reader[strFirstGroupBy]) == strGroupByValue_1)
                                {
                                    if (dtSubTotalFirstGroup.Rows.Count == 0)
                                    {
                                        dtSubTotalFirstGroup.Rows.Add(dtSubTotalFirstGroup.NewRow());
                                        foreach (DataColumn dcTotal in dtSubTotalFirstGroup.Columns)
                                            dtSubTotalFirstGroup.Rows[0][dcTotal] = 0;
                                    }
                                    decimal decTotal = 0;
                                    decTotal = Convert.ToDecimal(dtSubTotalFirstGroup.Rows[0][Reader.GetName(intColumn)]);
                                    decTotal += Reader.IsDBNull(intColumn) ? 0 : Convert.ToDecimal(Reader[intColumn]);
                                    dtSubTotalFirstGroup.Rows[0][Reader.GetName(intColumn)] = decTotal;
                                }
                            }
                            #endregion

                            #region  second: 2nd
                            if (!string.IsNullOrEmpty(strSecGroupBy) && !string.IsNullOrEmpty(strGroupByValue_2))
                            {
                                if (dtSubTotalSecondGroup.Columns.Contains(Reader.GetName(intColumn)) && Convert.ToString(Reader[strSecGroupBy]) == strGroupByValue_2)
                                {
                                    if (dtSubTotalSecondGroup.Rows.Count == 0)
                                    {
                                        dtSubTotalSecondGroup.Rows.Add(dtSubTotalSecondGroup.NewRow());
                                        foreach (DataColumn dcTotal in dtSubTotalSecondGroup.Columns)
                                            dtSubTotalSecondGroup.Rows[0][dcTotal] = 0;
                                    }
                                    decimal decTotal = 0;
                                    decTotal = Convert.ToDecimal(dtSubTotalSecondGroup.Rows[0][Reader.GetName(intColumn)]);
                                    decTotal += Reader.IsDBNull(intColumn) ? 0 : Convert.ToDecimal(Reader[intColumn]);
                                    dtSubTotalSecondGroup.Rows[0][Reader.GetName(intColumn)] = decTotal;
                                }
                            }
                            #endregion

                            #region Third : 3nd
                            //if (!string.IsNullOrEmpty(strThirdGroupBy) && !string.IsNullOrEmpty(strGroupByValue_3))
                            if ((strThirdGroupBy != null) && (strGroupByValue_3 != null))
                            {
                                if (dtSubTotalThirdGroup.Columns.Contains(Reader.GetName(intColumn)) && Convert.ToString(Reader[strThirdGroupBy]) == strGroupByValue_3)
                                {
                                    if (dtSubTotalThirdGroup.Rows.Count == 0)
                                    {
                                        dtSubTotalThirdGroup.Rows.Add(dtSubTotalThirdGroup.NewRow());
                                        foreach (DataColumn dcTotal in dtSubTotalThirdGroup.Columns)
                                            dtSubTotalThirdGroup.Rows[0][dcTotal] = 0;
                                    }
                                    decimal decTotal = 0;
                                    decTotal = Convert.ToDecimal(dtSubTotalThirdGroup.Rows[0][Reader.GetName(intColumn)]);
                                    decTotal += Reader.IsDBNull(intColumn) ? 0 : Convert.ToDecimal(Reader[intColumn]);
                                    dtSubTotalThirdGroup.Rows[0][Reader.GetName(intColumn)] = decTotal;
                                }
                            }
                            #endregion

                            #region Fourth : 4th
                            //if (!string.IsNullOrEmpty(strFourthGroupBy) && !string.IsNullOrEmpty(strGroupByValue_4))
                            if ((strFourthGroupBy != null) && (strGroupByValue_4 != null))
                            {
                                if (dtSubTotalFourthGroup.Columns.Contains(Reader.GetName(intColumn)) && Convert.ToString(Reader[strFourthGroupBy]) == strGroupByValue_4)
                                {
                                    if (dtSubTotalFourthGroup.Rows.Count == 0)
                                    {
                                        dtSubTotalFourthGroup.Rows.Add(dtSubTotalFourthGroup.NewRow());
                                        foreach (DataColumn dcTotal in dtSubTotalFourthGroup.Columns)
                                            dtSubTotalFourthGroup.Rows[0][dcTotal] = 0;
                                    }
                                    decimal decTotal = 0;
                                    decTotal = Convert.ToDecimal(dtSubTotalFourthGroup.Rows[0][Reader.GetName(intColumn)]);
                                    decTotal += Reader.IsDBNull(intColumn) ? 0 : Convert.ToDecimal(Reader[intColumn]);
                                    dtSubTotalFourthGroup.Rows[0][Reader.GetName(intColumn)] = decTotal;
                                }
                            }
                            #endregion

                            #region Fifth : 5th
                            //if (!string.IsNullOrEmpty(strFifthGroupBy) && !string.IsNullOrEmpty(strGroupByValue_5))
                            if ((strFifthGroupBy != null) && (strGroupByValue_5 != null))
                            {
                                if (dtSubTotalFifthGroup.Columns.Contains(Reader.GetName(intColumn)) && Convert.ToString(Reader[strFifthGroupBy]) == strGroupByValue_5)
                                {
                                    if (dtSubTotalFifthGroup.Rows.Count == 0)
                                    {
                                        dtSubTotalFifthGroup.Rows.Add(dtSubTotalFifthGroup.NewRow());
                                        foreach (DataColumn dcTotal in dtSubTotalFifthGroup.Columns)
                                            dtSubTotalFifthGroup.Rows[0][dcTotal] = 0;
                                    }
                                    decimal decTotal = 0;
                                    decTotal = Convert.ToDecimal(dtSubTotalFifthGroup.Rows[0][Reader.GetName(intColumn)]);
                                    decTotal += Reader.IsDBNull(intColumn) ? 0 : Convert.ToDecimal(Reader[intColumn]);
                                    dtSubTotalFifthGroup.Rows[0][Reader.GetName(intColumn)] = decTotal;
                                }
                            }
                            #endregion

                            #endregion
                            //Remove Group By Column
                            #region
                            if (strFirstGroupBy != Convert.ToString(dtSchema.Rows[intColumn]["ColumnName"]) && strSecGroupBy != Convert.ToString(dtSchema.Rows[intColumn]["ColumnName"]) && strThirdGroupBy != Convert.ToString(dtSchema.Rows[intColumn]["ColumnName"]) && strFourthGroupBy != Convert.ToString(dtSchema.Rows[intColumn]["ColumnName"]) && strFifthGroupBy != Convert.ToString(dtSchema.Rows[intColumn]["ColumnName"]))
                            {
                                strFormat = dtSchema.Rows[intColumn]["DataTypeName"].ToString();

                                if (strFormat == "decimal")
                                {
                                    // If dataType is Numeric but it is not Currency field.
                                    if (CheckISdisplayCurrencyFormat(dtSchema.Rows[intColumn][0].ToString()))
                                        sbRecord.Append("<td align='right' >&nbsp;" + string.Format("{0:c2}", Reader[intColumn]) + "</td>");
                                    else
                                        sbRecord.Append("<td align='right' >&nbsp;" + Convert.ToString(Reader[intColumn]) + "</td>");
                                }
                                else if (strFormat == "datetime")
                                {
                                    // it display only Time
                                    if (Convert.ToString(dtSchema.Rows[intColumn]["ColumnName"]) == "Time Theft Reported")
                                        sbRecord.Append("<td >&nbsp;" + string.Format("{0:HH:mm}", Reader[intColumn]) + "</td>");
                                    else sbRecord.Append("<td >&nbsp;" + string.Format("{0:MM/dd/yyyy}", Reader[intColumn]) + "</td>");
                                }
                                else
                                {

                                    //sbRecord.Append(@"<td style='mso-number-format:\@;'>&nbsp;" + Convert.ToString(Reader[intColumn]) + "</td>");
                                    sbRecord.Append(@"<td>&nbsp;" + Convert.ToString(Reader[intColumn]) + "</td>");
                                }
                            }
                            #endregion

                        }
                        #region "Grand Total"
                        for (int intColumn2 = 0; intColumn2 < Reader.FieldCount; intColumn2++)
                        {
                            //IF Grand Total Option is Selected and Have Field for SUM.
                            if (Convert.ToString(ObjAdHocReport.GrandTotal) == "Y" && dtHeader.Columns.Count > 0)
                            {
                                if (dtHeader.Columns.Contains(Reader.GetName(intColumn2)))
                                {
                                    decimal decTotal = 0;
                                    decTotal = Convert.ToDecimal(dtHeader.Rows[0][Reader.GetName(intColumn2)]);
                                    decTotal += Reader.IsDBNull(intColumn2) ? 0 : Convert.ToDecimal(Reader[intColumn2]);
                                    dtHeader.Rows[0][Reader.GetName(intColumn2)] = decTotal;
                                }
                            }
                        }
                        #endregion
                        sbRecord.Append("</tr>");



                        using (StreamWriter sw = File.AppendText(strPath))
                        {
                            sw.Write(sbRecord);
                            sbRecord = new StringBuilder(string.Empty);
                        }
                    } while (Reader.Read());

                    #region " SUBTOAL FOR Last groups "
                    if (dtSubTotalFifthGroup.Rows.Count > 0)
                    {
                        sbRecord.Append("<tr>");
                        int intCol = 1;
                        if (dtSchema.Rows.Count > 0)
                            sbRecord.Append("<td align='left'><b>Sub Total For " + strFifthGroupBy + "</b></td>");
                        foreach (DataRow drSchema in dtSchema.Rows)
                        {
                            string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();
                            if (strFirstGroupBy != strColName && strSecGroupBy != strColName && strThirdGroupBy != strColName && strFourthGroupBy != strColName && strFifthGroupBy != strColName)
                            {
                                if (dtSubTotalFifthGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                                    sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalFifthGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                                else
                                {
                                    //if (intCol == 1)
                                    //    sbRecord.Append("<td align='left'><b>Sub Total For " + strFifthGroupBy + "</b></td>");
                                    //else
                                    //{

                                    sbRecord.Append("<td>&nbsp;</td>");
                                    //}
                                }
                            }
                            intCol++;
                        }
                        sbRecord.Append("</tr>");
                        dtSubTotalFifthGroup.Clear();
                    }
                    if (dtSubTotalFourthGroup.Rows.Count > 0)
                    {
                        sbRecord.Append("<tr>");
                        int intCol = 1;
                        if (dtSchema.Rows.Count > 0)
                            sbRecord.Append("<td align='left'><b>Sub Total For " + strFourthGroupBy + "</b></td>");
                        foreach (DataRow drSchema in dtSchema.Rows)
                        {
                            string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();
                            if (strFirstGroupBy != strColName && strSecGroupBy != strColName && strThirdGroupBy != strColName && strFourthGroupBy != strColName && strFifthGroupBy != strColName)
                            {
                                if (dtSubTotalFourthGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                                    sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalFourthGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                                else
                                {
                                    //if (intCol == 1)
                                    //    sbRecord.Append("<td align='left'><b>Sub Total For " + strFourthGroupBy + "</b></td>");
                                    //else
                                    //{

                                    sbRecord.Append("<td>&nbsp;</td>");
                                    //}
                                }
                            }
                            intCol++;
                        }
                        sbRecord.Append("</tr>");
                        dtSubTotalFourthGroup.Clear();
                    }
                    if (dtSubTotalThirdGroup.Rows.Count > 0)
                    {
                        sbRecord.Append("<tr>");
                        int intCol = 1;
                        if (dtSchema.Rows.Count > 0)
                            sbRecord.Append("<td align='left'><b>Sub Total For " + strThirdGroupBy + "</b></td>");
                        foreach (DataRow drSchema in dtSchema.Rows)
                        {
                            string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();
                            if (strFirstGroupBy != strColName && strSecGroupBy != strColName && strThirdGroupBy != strColName && strFourthGroupBy != strColName && strFifthGroupBy != strColName)
                            {
                                if (dtSubTotalThirdGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                                    sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalThirdGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                                else
                                {
                                    //if (intCol == 1)
                                    //    sbRecord.Append("<td align='left'><b>Sub Total For " + strThirdGroupBy + "</b></td>");
                                    //else
                                    //{

                                    sbRecord.Append("<td>&nbsp;</td>");
                                    //}
                                }
                            }
                            intCol++;
                        }
                        sbRecord.Append("</tr>");
                        dtSubTotalThirdGroup.Clear();
                    }
                    if (dtSubTotalSecondGroup.Rows.Count > 0)
                    {
                        sbRecord.Append("<tr>");
                        int intCol = 1;
                        if (dtSchema.Rows.Count > 0)
                            sbRecord.Append("<td align='left'><b>Sub Total For " + strSecGroupBy + "</b></td>");
                        foreach (DataRow drSchema in dtSchema.Rows)
                        {
                            string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();
                            if (strFirstGroupBy != strColName && strSecGroupBy != strColName && strThirdGroupBy != strColName && strFourthGroupBy != strColName && strFifthGroupBy != strColName)
                            {
                                if (dtSubTotalSecondGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                                    sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalSecondGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                                else
                                {
                                    //if (intCol == 1)
                                    //    sbRecord.Append("<td align='left'><b>Sub Total For " + strSecGroupBy + "</b></td>");
                                    //else
                                    //{
                                    sbRecord.Append("<td>&nbsp;</td>");
                                    //}
                                }
                            }
                            intCol++;
                        }
                        sbRecord.Append("</tr>");
                        dtSubTotalSecondGroup.Clear();
                    }
                    if (dtSubTotalFirstGroup.Rows.Count > 0)
                    {
                        sbRecord.Append("<tr>");
                        int intCol = 1;
                        if (dtSchema.Rows.Count > 0)
                            sbRecord.Append("<td align='left'><b>Sub Total For " + strFirstGroupBy + "</b></td>");
                        foreach (DataRow drSchema in dtSchema.Rows)
                        {
                            string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();
                            if (strFirstGroupBy != strColName && strSecGroupBy != strColName && strThirdGroupBy != strColName && strFourthGroupBy != strColName && strFifthGroupBy != strColName)
                            {
                                if (dtSubTotalFirstGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                                    sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalFirstGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                                else
                                {
                                    //if (intCol == 1)
                                    //    sbRecord.Append("<td align='left'><b>Sub Total For " + strFirstGroupBy + "</b></td>");
                                    //else
                                    //{
                                    sbRecord.Append("<td>&nbsp;</td>");
                                    // }
                                }
                            }
                            intCol++;
                        }
                        sbRecord.Append("</tr>");
                        dtSubTotalFirstGroup.Clear();
                    }

                    #endregion

                    #endregion

                    //Table End
                    sbRecord.Append("</table></td></tr>");


                    #region "Footer Template"
                    // IF Grand Total Option is Checked and Have record from Transaction Table to SUM
                    if ((Convert.ToString(ObjAdHocReport.GrandTotal) == "Y") && dtHeader.Columns.Count > 0)
                    {
                        sbRecord.Append("<tr><td colspan='3'>");
                        string strStyle = "'font-weight: bold;background-color: #507CD1;color: White;'";
                        sbRecord.Append("<br />");
                        sbRecord.Append("<table border='1' cellpadding='0' cellspacing='0'><tr align='right'>");
                        sbRecord.Append("<td style='font-weight: bold;' align='left'>Grand Totals</td>");

                        for (int intColumn = 0; intColumn < dtHeader.Columns.Count; intColumn++)
                            sbRecord.Append("<td style='font-weight: bold;'>" + Convert.ToString(dtHeader.Columns[intColumn]) + "</td>");
                        // show Header for claim count
                        // sbRecord.Append("<td style='font-weight: bold;'>" + Convert.ToString(dtHeader.Columns[0]) + "</td>");
                        sbRecord.Append("</tr>");

                        sbRecord.Append("<tr align='right'>");
                        sbRecord.Append("<td style=" + strStyle + ">&nbsp;</td>");

                        //No column Claim count 
                        for (int intColumn = 0; intColumn < dtHeader.Columns.Count; intColumn++)
                            sbRecord.Append("<td style=" + strStyle + ">" + string.Format("{0:c2}", dtHeader.Rows[0][intColumn]) + "</td>");
                        // show value for Claim Count
                        //sbRecord.Append("<td style=" + strStyle + ">" + dtHeader.Rows[0][dtHeader.Columns.Count - 1] + "</td>");
                        sbRecord.Append("</tr><table>");
                        sbRecord.Append("</td></tr>");
                    }
                    #endregion
                    //Remove White Space.
                    //sbRecord.Replace("<tr></tr>", "");
                    sbRecord.Append("</table>");
                    using (StreamWriter sw = File.AppendText(strPath))
                    {
                        sw.Write(sbRecord);
                        sbRecord = new StringBuilder(string.Empty);
                    }
                }
                else
                {
                    //Remove WhiteSpace
                    sbRecord.Replace("<tr></tr>", "");
                    if (!Directory.Exists(AppDomain.CurrentDomain.BaseDirectory + @"temp\"))
                        Directory.CreateDirectory(AppDomain.CurrentDomain.BaseDirectory + @"temp\");

                    strPath = AppDomain.CurrentDomain.BaseDirectory + @"temp\" + strReportSchedulerName + System.DateTime.Now.ToString("MMddyyhhmmss") + ".xls";
                    ///When records are not found.
                    sbRecord.Append("<table  cellpadding='4' cellspacing='0' Width='100%'>");
                    sbRecord.Append("<tr>");
                    sbRecord.Append("<td align='center'>No Record found.</td></tr></table>");
                    using (StreamWriter sw = File.AppendText(strPath))
                    {
                        sw.Write(sbRecord);
                        sbRecord = new StringBuilder(string.Empty);
                    }
                }

                if (!Reader.IsClosed)
                    Reader.Close();

                return strPath;
            }
            catch (Exception ex)
            {
                //EventLog.WriteEntry("ERROR in Ad Hoc Report Writer , " + ex.Message);
                EventLog.WriteEntry("ERROR in ACI Ad Hoc Report Writer , " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
            finally
            {
                if (Reader != null)
                {
                    Reader.Close();
                    Reader.Dispose();
                }
                if (dtSchema != null)
                    dtSchema.Dispose();
                if (dtHeader != null)
                    dtHeader.Dispose();
            }
            return strPath;
        }

        /// <summary>
        /// Bind Report Data.
        /// </summary>
        /// <param name="dsReport">Report Dataset</param>
        private string BindReportForManagement(ref StringBuilder sbRecord, IDataReader Reader, ERIMS_DAL.Management_AdHocReport ObjAdHocReport, List<ERIMS_DAL.Management_AdHocFilter> lstFilter, string strReportSchedulerName)
        {
            DataTable dtSchema = null, dtHeader = null;
            Management_AdhocReportFields objReportFields = new Management_AdhocReportFields();
            List<Management_AdhocReportFields> lstAdhoc = null;
            string strPath = string.Empty;
            Boolean IsGroupBySelected = false;

            try
            {
                #region "Filter and Title"
                //sbRecord.Append("<table><tr><td colspan='8'>");
                sbRecord.Append("<table cellpadding='0' cellspacing='0' width='" + (150 * ObjAdHocReport.OutputFields.Split(',').Length).ToString() + "' style='font-size:10pt'>");
                sbRecord.Append("<tr><td colspan='8'><b>Report Title : " + strReportSchedulerName + " </b></td></tr><tr><td colspan='8'>&nbsp;</td></tr>");
                //sbRecord.Append("<br /><br />");

                Management_AdhocReportFields obj = new Management_AdhocReportFields();
                for (int i = 0; i < lstFilter.Count; i++)
                {
                    string strConditionVal = string.Empty;
                    if (lstFilter[i].Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.TextBox)
                    {
                        string strConditionType = lstFilter[i].ConditionType;
                        if (Convert.ToBoolean(lstFilter[i].IsNotSelected) == true)
                            strConditionType = (strConditionType == "1") ? " Not Contains " : (strConditionType == "2" ? " Not Start With " : " Not End With ");
                        else
                            strConditionType = (strConditionType == "1") ? " Contains " : (strConditionType == "2" ? " Start With " : " End With ");
                        strConditionVal = lstFilter[i].ConditionValue;
                        lstAdhoc = obj.GetAdHocReportFieldByPk(Convert.ToDecimal(lstFilter[i].FK_Management_AdhocReportFields));
                        sbRecord.Append("<tr><td colspan='8'><b>" + lstAdhoc[0].Field_Header + " : " + strConditionType + "</b>" + lstFilter[i].ConditionValue + "</td></tr><tr><td colspan='8'>&nbsp;</td></tr>");
                    }

                    if (lstFilter[i].Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.MultiSelectList)
                    {
                        lstAdhoc = obj.GetAdHocReportFieldByPk(Convert.ToDecimal(lstFilter[i].FK_Management_AdhocReportFields));

                        string fieldHeaderLocation = lstAdhoc[0].Field_Header;

                        if (fieldHeaderLocation == "DBA")
                        {
                            fieldHeaderLocation = "Location";
                        } 
                        else
                        {
                            fieldHeaderLocation = lstAdhoc[0].Field_Header;
                        }

                        if (Convert.ToBoolean(lstFilter[i].IsNotSelected) == true)
                            sbRecord.Append("<tr><td colspan='8'><b>" + lstAdhoc[0].Field_Header + " (Not In)</b>" + " : " + FillFilterDropDown(fieldHeaderLocation, lstFilter[i].ConditionValue) + "</td></tr>");
                        else
                            sbRecord.Append("<tr><td colspan='8'><b>" + lstAdhoc[0].Field_Header + " (In)</b>" + " : " + FillFilterDropDown(fieldHeaderLocation, lstFilter[i].ConditionValue) + "</td></tr>");
                    }

                    if (lstFilter[i].Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.DateControl)
                    {
                        string strConditionType = lstFilter[i].ConditionType;
                        lstAdhoc = obj.GetAdHocReportFieldByPk(Convert.ToDecimal(lstFilter[i].FK_Management_AdhocReportFields));
                        strConditionType = (strConditionType == "O") ? " On " : (strConditionType == "B" ? " Between " : (strConditionType == "BF" ? "On or Before " : (strConditionType == "IN" ? " IS NULL " : "On or After ")));

                        string dtFrom = null, dtTo = null;
                        if (string.IsNullOrEmpty(lstFilter[i].FromRelativeCriteria))
                            dtFrom = FormatDBNullDateToDisplay(lstFilter[i].FromDate);
                        else
                        {
                            // set Relative Date From criteria
                            AdHocReportHelper.RaltiveDates RelType = (AdHocReportHelper.RaltiveDates)Enum.Parse(typeof(AdHocReportHelper.RaltiveDates), lstFilter[i].FromRelativeCriteria);
                            dtFrom = AdHocReportHelper.GetRelativeDate(RelType).ToString("MM/dd/yyyy");
                        }
                        if (string.IsNullOrEmpty(lstFilter[i].ToRelativeCriteria))
                            dtTo = FormatDBNullDateToDisplay(lstFilter[i].ToDate);
                        else
                        {
                            // set Relative Date To criteria
                            AdHocReportHelper.RaltiveDates RelType = (AdHocReportHelper.RaltiveDates)Enum.Parse(typeof(AdHocReportHelper.RaltiveDates), lstFilter[i].ToRelativeCriteria);
                            dtTo = AdHocReportHelper.GetRelativeDate(RelType).ToString("MM/dd/yyyy");
                        }

                        if (Convert.ToBoolean(lstFilter[i].IsNotSelected) == true)
                            strConditionType = "Not" + strConditionType;

                        if (strConditionType.Trim() != "Between" && strConditionType.Trim() != "Not Between")
                            strConditionVal = "<tr><td colspan='8'><b>" + lstAdhoc[0].Field_Header + " : " + strConditionType + "</b>" + dtFrom + "</td></tr><tr></tr>";
                        else
                            strConditionVal = "<tr><td colspan='8'><b>" + lstAdhoc[0].Field_Header + " : </b>" + strConditionType + dtFrom + " And " + dtTo + "</td></tr>";

                        sbRecord.Append(strConditionVal);
                    }
                    if (lstFilter[i].Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.AmountControl)
                    {
                        string strConditionType = lstFilter[i].ConditionType;
                        lstAdhoc = obj.GetAdHocReportFieldByPk(Convert.ToDecimal(lstFilter[i].FK_Management_AdhocReportFields));
                        strConditionType = (strConditionType == "0") ? " Equal " : (strConditionType == "1" ? " Greater Than " : (strConditionType == "2" ? " Between " : " Less Than "));

                        string amountFrom = string.Empty;
                        if (!DBNull.Value.Equals(lstFilter[i].AmountFrom))
                        {
                            amountFrom = string.Format("{0:C2}", lstFilter[i].AmountFrom);
                        }
                        else
                        {
                            amountFrom = "$ 0.00";
                        }

                        string amountTo = string.Empty;
                        if (!DBNull.Value.Equals(lstFilter[i].AmountTo))
                        {
                            amountTo = string.Format("{0:C2}", lstFilter[i].AmountTo);
                        }
                        else
                        {
                            amountTo = "$ 0.00";
                        }

                        if (Convert.ToBoolean(lstFilter[i].IsNotSelected) == true)
                            strConditionType = "Not" + strConditionType;

                        if (strConditionType.Trim() != "Between" && strConditionType.Trim() != "Not Between")
                            strConditionVal = "<tr><td colspan='8'><b>" + lstAdhoc[0].Field_Header + " : " + strConditionType + "</b>" + amountFrom + "</td></tr>";
                        else
                            strConditionVal = "<tr><td colspan='8'><b>" + lstAdhoc[0].Field_Header + " : </b>" + strConditionType + Convert.ToString(lstFilter[i].AmountFrom) + " And " + amountTo + "</td></tr>";
                        sbRecord.Append(strConditionVal);
                    }
                    //sbRecord.Append("<br />");
                }
                //sbRecord.Append("<br /></td></tr></table>");                
                #endregion

                // Check if Any record is exists or not
                if (Reader.Read())
                {
                    string strFirstGroupBy = string.Empty, strSecGroupBy = string.Empty, strThirdGroupBy = null, strFourthGroupBy = null, strFifthGroupBy = null;

                    if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.FirstGroupBy)))
                    {
                        if (ObjAdHocReport.FirstGroupBy == -2)
                            strFirstGroupBy = "Accident Year";
                        else
                        {
                            lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.FirstGroupBy));
                            strFirstGroupBy = lstAdhoc[0].Field_Header;
                        }

                        IsGroupBySelected = true;
                    }

                    if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.SecondGroupBy)))
                    {
                        if (ObjAdHocReport.SecondGroupBy == -3)
                            strSecGroupBy = "Accident Year";
                        else
                        {
                            lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.SecondGroupBy));
                            strSecGroupBy = lstAdhoc[0].Field_Header;
                        }

                        IsGroupBySelected = true;
                    }

                    if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.ThirdGroupBy)))
                    {
                        if (ObjAdHocReport.ThirdGroupBy == -3)
                            strThirdGroupBy = "Accident Year";
                        else
                        {
                            lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.ThirdGroupBy));
                            strThirdGroupBy = lstAdhoc[0].Field_Header;
                        }

                        IsGroupBySelected = true;
                    }
                    if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.FourthGroupBy)))
                    {
                        if (ObjAdHocReport.FourthGroupBy == -3)
                            strFourthGroupBy = "Accident Year";
                        else
                        {
                            lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.FourthGroupBy));
                            strFourthGroupBy = lstAdhoc[0].Field_Header;
                        }

                        IsGroupBySelected = true;
                    }
                    if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.FifthGroupBy)))
                    {
                        if (ObjAdHocReport.FifthGroupBy == -3)
                            strFifthGroupBy = "Accident Year";
                        else
                        {
                            lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.FifthGroupBy));
                            strFifthGroupBy = lstAdhoc[0].Field_Header;
                        }

                        IsGroupBySelected = true;
                    }

                    //iF First Group By is Not  selected then second Group by will be set as first Group By
                    if (string.IsNullOrEmpty(strFirstGroupBy))
                    {
                        strFirstGroupBy = strSecGroupBy;
                        strSecGroupBy = string.Empty;
                    }

                    dtSchema = Reader.GetSchemaTable();

                    //sbRecord.Append("<table border='1' cellpadding='0' cellspacing='0' width='" + (150 * ObjAdHocReport.OutputFields.Split(',').Length).ToString() + "' style='font-size:10pt'>");

                    #region "Header"
                    // If reader found a records 
                    sbRecord.Append("<tr><td><table border='1'>");
                    sbRecord.Append("<tr>");
                    if (IsGroupBySelected)
                        sbRecord.Append("<td>&nbsp;</td>");
                    dtHeader = new DataTable();
                    string strFormatFirstGroupBy = string.Empty, strFormatSecGroupBy = string.Empty, strFormatThirdGroupBy = string.Empty, strFormatFourthGroupBy = string.Empty, strFormatFifthGroupBy = string.Empty;
                    foreach (DataRow drHeader in dtSchema.Rows)
                    {
                        //Remove Group By 
                        if (strFirstGroupBy != Convert.ToString(drHeader["ColumnName"]) && strSecGroupBy != Convert.ToString(drHeader["ColumnName"]) && strThirdGroupBy != Convert.ToString(drHeader["ColumnName"]) && strFourthGroupBy != Convert.ToString(drHeader["ColumnName"]) && strFifthGroupBy != Convert.ToString(drHeader["ColumnName"]))
                        {
                            if (drHeader["ColumnName"].ToString() != "Claim Count")
                            {
                                sbRecord.Append("<td><b>" + drHeader["ColumnName"] + "</b></td>");
                            }

                        }

                        //IF Grand Total Option is Selected.
                        if (Convert.ToString(ObjAdHocReport.GrandTotal) == "Y" && CheckTotalField(drHeader["ColumnName"].ToString()))
                            dtHeader.Columns.Add(new DataColumn(drHeader["ColumnName"].ToString(), Type.GetType("System.Decimal")));

                        //Get  Group By Field's Data Type
                        if (strFirstGroupBy == Convert.ToString(drHeader["ColumnName"]))
                            strFormatFirstGroupBy = drHeader["DataTypeName"].ToString();
                        if (strSecGroupBy == Convert.ToString(drHeader["ColumnName"]))
                            strFormatSecGroupBy = drHeader["DataTypeName"].ToString();
                        if (strThirdGroupBy == Convert.ToString(drHeader["ColumnName"]))
                            strFormatThirdGroupBy = drHeader["DataTypeName"].ToString();
                        if (strFourthGroupBy == Convert.ToString(drHeader["ColumnName"]))
                            strFormatFourthGroupBy = drHeader["DataTypeName"].ToString();
                        if (strFifthGroupBy == Convert.ToString(drHeader["ColumnName"]))
                            strFormatFifthGroupBy = drHeader["DataTypeName"].ToString();

                    }
                    //When Header have records
                    if (dtHeader.Columns.Count > 0)
                    {
                        DataRow drHerder = dtHeader.NewRow();

                        for (int i = 0; i < dtHeader.Columns.Count; i++)
                            drHerder[i] = 0;

                        dtHeader.Rows.Add(drHerder);
                        dtHeader.AcceptChanges();
                    }

                    sbRecord.Append("</tr>");

                    #endregion

                    strPath = AppDomain.CurrentDomain.BaseDirectory + @"temp\" + strReportSchedulerName + System.DateTime.Now.ToString("MMddyyhhmmss") + ".xls";

                    if (!File.Exists(strPath))
                    {
                        if (!Directory.Exists(AppDomain.CurrentDomain.BaseDirectory + @"temp\"))
                            Directory.CreateDirectory(AppDomain.CurrentDomain.BaseDirectory + @"temp\");
                        // Create a file to write to.
                        //Remove WhiteSpace
                        sbRecord.Replace("<tr></tr>", "");
                        File.SetAttributes(AppDomain.CurrentDomain.BaseDirectory, FileAttributes.Normal);
                        using (StreamWriter sw = File.CreateText(strPath))
                        {
                            sw.Write(sbRecord.ToString());
                            sbRecord = new StringBuilder(string.Empty);
                        }
                    }

                    #region "Item Template"

                    DataTable dtSubTotalFirstGroup = dtHeader.Clone();
                    DataTable dtSubTotalSecondGroup = dtHeader.Clone();
                    DataTable dtSubTotalThirdGroup = dtHeader.Clone();
                    DataTable dtSubTotalFourthGroup = dtHeader.Clone();
                    DataTable dtSubTotalFifthGroup = dtHeader.Clone();

                    string strGroupByValue_1 = string.Empty, strGroupByValue_2 = string.Empty, strNOGroup1 = string.Empty, strNOGroup2 = string.Empty;
                    string strGroupByValue_3 = string.Empty, strGroupByValue_4 = string.Empty, strNOGroup3 = string.Empty, strNOGroup4 = string.Empty;
                    string strGroupByValue_5 = string.Empty, strNOGroup5 = string.Empty;

                    do
                    {
                        string strFormat = string.Empty;

                        #region "SUBTOTALS"

                        #region Fifth
                        // print subtotal for 5th group by when the value is changed
                        if (!string.IsNullOrEmpty(strFifthGroupBy) && !string.IsNullOrEmpty(strGroupByValue_5) && strGroupByValue_5 != Convert.ToString(Reader[strFifthGroupBy]))
                        {
                            if (dtSubTotalFifthGroup.Rows.Count > 0)
                            {
                                sbRecord.Append("<tr>");
                                int intCol = 1;
                                //first column is for sub total when sub total is found
                                if (dtSchema.Rows.Count > 0)
                                    sbRecord.Append("<td><b>Sub Total For " + strFifthGroupBy + "</b></td>");
                                foreach (DataRow drSchema in dtSchema.Rows)
                                {
                                    string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();

                                    if (strFirstGroupBy != strColName && strSecGroupBy != strColName && strThirdGroupBy != strColName && strFourthGroupBy != strColName && strFifthGroupBy != strColName)
                                    {
                                        if (dtSubTotalFifthGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                                            sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalFifthGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                                        else
                                        {
                                            //if (intCol == 1)
                                            //    sbRecord.Append("<td><b>Sub Total For " + strFifthGroupBy + "</b></td><td>&nbsp;</td>");
                                            //else
                                            //{
                                            sbRecord.Append("<td>&nbsp;</td>");
                                            //}
                                        }
                                    }
                                    intCol++;
                                }

                                sbRecord.Append("</tr>");
                                dtSubTotalFifthGroup.Clear();
                            }
                        }
                        #endregion

                        #region Fourth
                        // print subtotal for 4th group by when the value is changed
                        if (!string.IsNullOrEmpty(strFourthGroupBy) && !string.IsNullOrEmpty(strGroupByValue_4) && strGroupByValue_4 != Convert.ToString(Reader[strFourthGroupBy]))
                        {
                            if (dtSubTotalFourthGroup.Rows.Count > 0)
                            {
                                sbRecord.Append("<tr>");
                                int intCol = 1;

                                if (dtSchema.Rows.Count > 0)
                                    sbRecord.Append("<td><b>Sub Total For " + strFourthGroupBy + "</b></td>");
                                foreach (DataRow drSchema in dtSchema.Rows)
                                {
                                    string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();
                                    if (strFirstGroupBy != strColName && strSecGroupBy != strColName && strThirdGroupBy != strColName && strFourthGroupBy != strColName && strFifthGroupBy != strColName)
                                    {

                                        if (dtSubTotalFourthGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                                            sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalFourthGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                                        else
                                        {
                                            //if (intCol == 1)
                                            //    sbRecord.Append("<td><b>Sub Total For " + strFourthGroupBy + "</b></td><td>&nbsp;</td>");
                                            //else
                                            //{

                                            sbRecord.Append("<td>&nbsp;</td>");
                                            //}
                                        }
                                    }
                                    intCol++;
                                }

                                sbRecord.Append("</tr>");
                                dtSubTotalFourthGroup.Clear();
                            }
                        }
                        #endregion

                        #region Third
                        // print subtotal for 3rd group by when the value is changed
                        if (!string.IsNullOrEmpty(strThirdGroupBy) && !string.IsNullOrEmpty(strGroupByValue_3) && strGroupByValue_3 != Convert.ToString(Reader[strThirdGroupBy]))
                        {
                            if (dtSubTotalThirdGroup.Rows.Count > 0)
                            {
                                sbRecord.Append("<tr>");
                                int intCol = 1;
                                if (dtSchema.Rows.Count > 0)
                                    sbRecord.Append("<td><b>Sub Total For " + strThirdGroupBy + "</b></td>");
                                foreach (DataRow drSchema in dtSchema.Rows)
                                {
                                    string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();

                                    if (strFirstGroupBy != strColName && strSecGroupBy != strColName && strThirdGroupBy != strColName && strFourthGroupBy != strColName && strFifthGroupBy != strColName)
                                    {

                                        if (dtSubTotalThirdGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                                            sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalThirdGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                                        else
                                        {
                                            //if (intCol == 1)
                                            //    sbRecord.Append("<td><b>Sub Total For " + strThirdGroupBy + "</b></td><td>&nbsp;</td>");
                                            //else
                                            //{

                                            sbRecord.Append("<td>&nbsp;</td>");
                                            //}
                                        }
                                    }

                                    intCol++;
                                }

                                sbRecord.Append("</tr>");
                                dtSubTotalThirdGroup.Clear();
                            }
                        }
                        #endregion

                        #region Second
                        // print subtotal for 2nd group by when the value is changed
                        if (!string.IsNullOrEmpty(strSecGroupBy) && !string.IsNullOrEmpty(strGroupByValue_2) && strGroupByValue_2 != Convert.ToString(Reader[strSecGroupBy]))
                        {
                            if (dtSubTotalSecondGroup.Rows.Count > 0)
                            {
                                sbRecord.Append("<tr>");
                                int intCol = 1;
                                if (dtSchema.Rows.Count > 0)
                                    sbRecord.Append("<td><b>Sub Total For " + strSecGroupBy + "</b></td>");
                                foreach (DataRow drSchema in dtSchema.Rows)
                                {
                                    string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();

                                    if (strFirstGroupBy != strColName && strSecGroupBy != strColName && strThirdGroupBy != strColName && strFourthGroupBy != strColName && strFifthGroupBy != strColName)
                                    {
                                        if (dtSubTotalSecondGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                                            sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalSecondGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                                        else
                                        {
                                            //if (intCol == 1)
                                            //    sbRecord.Append("<td><b>Sub Total For " + strSecGroupBy + "</b></td><td>&nbsp;</td>");
                                            //else
                                            //{

                                            sbRecord.Append("<td>&nbsp;</td>");
                                            // }
                                        }
                                    }

                                    intCol++;
                                }

                                sbRecord.Append("</tr>");
                                dtSubTotalSecondGroup.Clear();
                            }
                        }
                        #endregion

                        #region First
                        // print subtotal for 1st group by when the value is changed
                        if (!string.IsNullOrEmpty(strFirstGroupBy) && !string.IsNullOrEmpty(strGroupByValue_1) && strGroupByValue_1 != Convert.ToString(Reader[strFirstGroupBy]))
                        {
                            if (dtSubTotalFirstGroup.Rows.Count > 0)
                            {
                                sbRecord.Append("<tr>");
                                int intCol = 1;
                                if (dtSchema.Rows.Count > 0)
                                    sbRecord.Append("<td><b>Sub Total For " + strFirstGroupBy + "</b></td>");
                                foreach (DataRow drSchema in dtSchema.Rows)
                                {
                                    string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();

                                    if (strFirstGroupBy != strColName && strSecGroupBy != strColName && strThirdGroupBy != strColName && strFourthGroupBy != strColName && strFifthGroupBy != strColName)
                                    {
                                        if (dtSubTotalFirstGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                                            sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalFirstGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                                        else
                                        {
                                            //if (intCol == 1)
                                            //    sbRecord.Append("<td><b>Sub Total For " + strFirstGroupBy + "</b></td><td>&nbsp;</td>");
                                            //else
                                            //{

                                            sbRecord.Append("<td>&nbsp;</td>");
                                            //}
                                        }
                                    }

                                    intCol++;
                                }

                                sbRecord.Append("</tr>");
                                dtSubTotalFirstGroup.Clear();
                            }
                        }
                        #endregion

                        #endregion

                        #region Group By

                        #region First Group
                        if (!string.IsNullOrEmpty(strFirstGroupBy))
                        {
                            if (strGroupByValue_1 != Convert.ToString(Reader[strFirstGroupBy]))
                            {
                                strGroupByValue_1 = Convert.ToString(Reader[strFirstGroupBy]);
                                if (strFormatFirstGroupBy == "decimal")
                                    sbRecord.Append("<tr><td style='font-weight: bold;color: #FF9C09;' align='right'>&nbsp;" + strFirstGroupBy + ": " + string.Format("{0:c2}", strGroupByValue_1) + "</td></tr>");
                                else if (strFormatFirstGroupBy == "datetime")
                                {
                                    // it display only Time
                                    if (strFirstGroupBy == "Time Theft Reported")
                                        sbRecord.Append("<tr><td style='font-weight: bold;color: #FF9C09;'>&nbsp;" + strFirstGroupBy + ": " + string.Format("{0:HH:mm}", Reader[strFirstGroupBy]) + "</td></tr>");
                                    else sbRecord.Append("<tr><td style='font-weight: bold;color: #FF9C09;'>&nbsp;" + strFirstGroupBy + ": " + FormatDBNullDateToDisplay(strGroupByValue_1) + "</td></tr>");
                                }
                                else sbRecord.Append("<tr><td style='font-weight: bold;color: #FF9C09;'>&nbsp;" + strFirstGroupBy + ": " + strGroupByValue_1 + "</td></tr>");
                                //Change Second Group By when First Groupby is Change
                                strGroupByValue_2 = string.Empty;
                            }
                            // it will set No : [First Group By] when it is null
                            else if ((Reader[strFirstGroupBy] == DBNull.Value || string.IsNullOrEmpty(Convert.ToString(Reader[strFirstGroupBy]))) && strNOGroup1 == string.Empty)
                            {
                                strNOGroup1 = "No " + strFirstGroupBy;
                                sbRecord.Append("<tr><td style='font-weight: bold;color: #FF9C09;' >&nbsp;" + strFirstGroupBy + ": " + strNOGroup1 + "</td></tr>");
                                // When Group by 1 value find as Null
                                strNOGroup1 = strFirstGroupBy;
                                //Change Second Group By when First Groupby is Change
                                strGroupByValue_2 = string.Empty;
                            }
                        }
                        #endregion

                        #region Second Group By
                        if (!string.IsNullOrEmpty(strSecGroupBy))
                        {
                            if (strGroupByValue_2 != Convert.ToString(Reader[strSecGroupBy]))
                            {
                                strGroupByValue_2 = Convert.ToString(Reader[strSecGroupBy]);
                                if (strFormatSecGroupBy == "decimal")
                                    sbRecord.Append("<tr><td style='font-weight: bold;color: #276692;' align='right' >&nbsp;" + strSecGroupBy + ": " + string.Format("{0:c2}", strGroupByValue_2) + "</td></tr>");
                                else if (strFormatSecGroupBy == "datetime")
                                {
                                    // it display only Time
                                    if (strSecGroupBy == "Time Theft Reported")
                                        sbRecord.Append("<tr><td style='font-weight: bold;color: #276692;'>&nbsp;" + strSecGroupBy + ": " + string.Format("{0:HH:mm}", Reader[strSecGroupBy]) + "</td></tr>");
                                    else sbRecord.Append("<tr><td style='font-weight: bold;color: #276692;' >&nbsp;" + strSecGroupBy + ": " + FormatDBNullDateToDisplay(strGroupByValue_2) + "</td></tr>");
                                }
                                else sbRecord.Append("<tr><td style='font-weight: bold;color: #276692;' >&nbsp;" + strSecGroupBy + ": " + strGroupByValue_2 + "</td></tr>");
                            }
                            else if (Reader[strSecGroupBy] == DBNull.Value && strNOGroup2 == string.Empty)
                            {
                                strNOGroup2 = "No " + strSecGroupBy;
                                sbRecord.Append("<tr><td style='font-weight: bold;color: #276692;' >&nbsp;" + strSecGroupBy + ": " + strNOGroup2 + "</td></tr>");
                                //No Group by assign
                                strNOGroup2 = strGroupByValue_2;
                            }
                        }
                        #endregion

                        #region Third Group BY
                        if (!string.IsNullOrEmpty(strThirdGroupBy))
                        {
                            if (strGroupByValue_3 != Convert.ToString(Reader[strThirdGroupBy]))
                            {
                                strGroupByValue_3 = Convert.ToString(Reader[strThirdGroupBy]);
                                if (strFormatThirdGroupBy == "decimal")
                                    sbRecord.Append("<tr><td style='font-weight: bold;color: #603311;' align='right' >&nbsp;" + strThirdGroupBy + ": " + string.Format("{0:c2}", strGroupByValue_3) + "</td></tr>");
                                else if (strFormatThirdGroupBy == "datetime")
                                {
                                    // it display only Time
                                    if (strThirdGroupBy == "Time Theft Reported")
                                        sbRecord.Append("<tr><td style='font-weight: bold;color: #603311;'>&nbsp;" + strThirdGroupBy + ": " + string.Format("{0:HH:mm}", Reader[strThirdGroupBy]) + "</td></tr>");
                                    else sbRecord.Append("<tr><td style='font-weight: bold;color: #603311;' >&nbsp;" + strThirdGroupBy + ": " + FormatDBNullDateToDisplay(strGroupByValue_3) + "</td></tr>");
                                }
                                else sbRecord.Append("<tr><td style='font-weight: bold;color: #603311;' >&nbsp;" + strThirdGroupBy + ": " + strGroupByValue_3 + "</td></tr>");
                                strGroupByValue_4 = strGroupByValue_5 = null;
                            }
                            else if ((Reader[strThirdGroupBy] == DBNull.Value || string.IsNullOrEmpty(Convert.ToString(Reader[strThirdGroupBy]))) && strNOGroup3 == string.Empty)
                            {
                                strNOGroup3 = "No " + strThirdGroupBy;
                                sbRecord.Append("<tr><td style='font-weight: bold;color: #603311;' >&nbsp;" + strThirdGroupBy + ": " + strNOGroup3 + "</td></tr>");
                                // When Group by 3 value find as Null
                                strNOGroup3 = strThirdGroupBy;
                                //Change third Group By when 3rd Groupby is Change
                                strGroupByValue_3 = string.Empty;
                            }
                        }
                        #endregion

                        #region Fourth Group BY
                        if (!string.IsNullOrEmpty(strFourthGroupBy))
                        {
                            if (strGroupByValue_4 != Convert.ToString(Reader[strFourthGroupBy]))
                            {
                                strGroupByValue_4 = Convert.ToString(Reader[strFourthGroupBy]);
                                if (strFormatFourthGroupBy == "decimal")
                                    sbRecord.Append("<tr><td style='font-weight: bold;color: green;' align='right' >&nbsp;" + strFourthGroupBy + ": " + string.Format("{0:c2}", strGroupByValue_4) + "</td></tr>");
                                else if (strFormatFourthGroupBy == "datetime")
                                {
                                    // it display only Time
                                    if (strFourthGroupBy == "Time Theft Reported")
                                        sbRecord.Append("<tr><td style='font-weight: bold;color: green;'>&nbsp;" + strFourthGroupBy + ": " + string.Format("{0:HH:mm}", Reader[strFourthGroupBy]) + "</td></tr>");
                                    else sbRecord.Append("<tr><td style='font-weight: bold;color: green;' >&nbsp;" + strFourthGroupBy + ": " + FormatDBNullDateToDisplay(strGroupByValue_4) + "</td></tr>");
                                }
                                else sbRecord.Append("<tr><td style='font-weight: bold;color: green;' >&nbsp;" + strFourthGroupBy + ": " + strGroupByValue_4 + "</td></tr>");
                                strGroupByValue_5 = null;
                            }
                            else if ((Reader[strFourthGroupBy] == DBNull.Value || string.IsNullOrEmpty(Convert.ToString(Reader[strFourthGroupBy]))) && strNOGroup4 == string.Empty)
                            {
                                strNOGroup4 = "No " + strFourthGroupBy;
                                sbRecord.Append("<tr><td style='font-weight: bold;color: green;' >&nbsp;" + strFourthGroupBy + ": " + strNOGroup4 + "</td></tr>");
                                // When Group by 4 value find as Null
                                strNOGroup4 = strFourthGroupBy;
                                //Change Fourth Group By when 4th Groupby is Change
                                strGroupByValue_4 = string.Empty;
                            }
                        }
                        #endregion

                        #region Fifth Group BY
                        if (!string.IsNullOrEmpty(strFifthGroupBy))
                        {
                            if (strGroupByValue_5 != Convert.ToString(Reader[strFifthGroupBy]))
                            {
                                strGroupByValue_5 = Convert.ToString(Reader[strFifthGroupBy]);
                                if (strFormatFifthGroupBy == "decimal")
                                    sbRecord.Append("<tr><td style='font-weight: bold;' align='right' >&nbsp;" + strFifthGroupBy + ": " + string.Format("{0:c2}", strGroupByValue_5) + "</td></tr>");
                                else if (strFormatFifthGroupBy == "datetime")
                                {
                                    // it display only Time
                                    if (strFifthGroupBy == "Time Theft Reported")
                                        sbRecord.Append("<tr><td style='font-weight: bold;'>&nbsp;" + strFifthGroupBy + ": " + string.Format("{0:HH:mm}", Reader[strFifthGroupBy]) + "</td></tr>");
                                    else sbRecord.Append("<tr><td style='font-weight: bold;' >&nbsp;" + strFifthGroupBy + ": " + FormatDBNullDateToDisplay(strGroupByValue_5) + "</td></tr>");
                                }
                                else sbRecord.Append("<tr><td style='font-weight: bold;' >&nbsp;" + strFifthGroupBy + ": " + strGroupByValue_5 + "</td></tr>");
                            }
                            else if ((Reader[strFifthGroupBy] == DBNull.Value || string.IsNullOrEmpty(Convert.ToString(Reader[strFifthGroupBy]))) && strNOGroup5 == string.Empty)
                            {
                                strNOGroup5 = "No " + strFifthGroupBy;
                                sbRecord.Append("<tr><td style='font-weight: bold;' >&nbsp;" + strFifthGroupBy + ": " + strNOGroup5 + "</td></tr>");
                                // When Group by 5 value find as Null
                                strNOGroup5 = strFifthGroupBy;
                                //Change fifth Group By when fifth Groupby is Change
                                strGroupByValue_5 = string.Empty;
                            }
                        }
                        #endregion

                        #endregion

                        string strColumnName = string.Empty;
                        sbRecord.Append("<tr>");
                        if (IsGroupBySelected)
                            sbRecord.Append("<td>&nbsp;</td>");
                        ///Print Records
                        //for (int intColumn = 0; intColumn < Reader.FieldCount - 1; intColumn++)
                        for (int intColumn = 0; intColumn <= Reader.FieldCount - 1; intColumn++)
                        {
                            #region " Count Sub Totals"
                            #region First : 1st
                            if (!string.IsNullOrEmpty(strFirstGroupBy) && !string.IsNullOrEmpty(strGroupByValue_1))
                            {
                                if (dtSubTotalFirstGroup.Columns.Contains(Reader.GetName(intColumn)) && Convert.ToString(Reader[strFirstGroupBy]) == strGroupByValue_1)
                                {
                                    if (dtSubTotalFirstGroup.Rows.Count == 0)
                                    {
                                        dtSubTotalFirstGroup.Rows.Add(dtSubTotalFirstGroup.NewRow());
                                        foreach (DataColumn dcTotal in dtSubTotalFirstGroup.Columns)
                                            dtSubTotalFirstGroup.Rows[0][dcTotal] = 0;
                                    }
                                    decimal decTotal = 0;
                                    decTotal = Convert.ToDecimal(dtSubTotalFirstGroup.Rows[0][Reader.GetName(intColumn)]);
                                    decTotal += Reader.IsDBNull(intColumn) ? 0 : Convert.ToDecimal(Reader[intColumn]);
                                    dtSubTotalFirstGroup.Rows[0][Reader.GetName(intColumn)] = decTotal;
                                }
                            }
                            #endregion

                            #region  second: 2nd
                            if (!string.IsNullOrEmpty(strSecGroupBy) && !string.IsNullOrEmpty(strGroupByValue_2))
                            {
                                if (dtSubTotalSecondGroup.Columns.Contains(Reader.GetName(intColumn)) && Convert.ToString(Reader[strSecGroupBy]) == strGroupByValue_2)
                                {
                                    if (dtSubTotalSecondGroup.Rows.Count == 0)
                                    {
                                        dtSubTotalSecondGroup.Rows.Add(dtSubTotalSecondGroup.NewRow());
                                        foreach (DataColumn dcTotal in dtSubTotalSecondGroup.Columns)
                                            dtSubTotalSecondGroup.Rows[0][dcTotal] = 0;
                                    }
                                    decimal decTotal = 0;
                                    decTotal = Convert.ToDecimal(dtSubTotalSecondGroup.Rows[0][Reader.GetName(intColumn)]);
                                    decTotal += Reader.IsDBNull(intColumn) ? 0 : Convert.ToDecimal(Reader[intColumn]);
                                    dtSubTotalSecondGroup.Rows[0][Reader.GetName(intColumn)] = decTotal;
                                }
                            }
                            #endregion

                            #region Third : 3nd
                            //if (!string.IsNullOrEmpty(strThirdGroupBy) && !string.IsNullOrEmpty(strGroupByValue_3))
                            if ((strThirdGroupBy != null) && (strGroupByValue_3 != null))
                            {
                                if (dtSubTotalThirdGroup.Columns.Contains(Reader.GetName(intColumn)) && Convert.ToString(Reader[strThirdGroupBy]) == strGroupByValue_3)
                                {
                                    if (dtSubTotalThirdGroup.Rows.Count == 0)
                                    {
                                        dtSubTotalThirdGroup.Rows.Add(dtSubTotalThirdGroup.NewRow());
                                        foreach (DataColumn dcTotal in dtSubTotalThirdGroup.Columns)
                                            dtSubTotalThirdGroup.Rows[0][dcTotal] = 0;
                                    }
                                    decimal decTotal = 0;
                                    decTotal = Convert.ToDecimal(dtSubTotalThirdGroup.Rows[0][Reader.GetName(intColumn)]);
                                    decTotal += Reader.IsDBNull(intColumn) ? 0 : Convert.ToDecimal(Reader[intColumn]);
                                    dtSubTotalThirdGroup.Rows[0][Reader.GetName(intColumn)] = decTotal;
                                }
                            }
                            #endregion

                            #region Fourth : 4th
                            //if (!string.IsNullOrEmpty(strFourthGroupBy) && !string.IsNullOrEmpty(strGroupByValue_4))
                            if ((strFourthGroupBy != null) && (strGroupByValue_4 != null))
                            {
                                if (dtSubTotalFourthGroup.Columns.Contains(Reader.GetName(intColumn)) && Convert.ToString(Reader[strFourthGroupBy]) == strGroupByValue_4)
                                {
                                    if (dtSubTotalFourthGroup.Rows.Count == 0)
                                    {
                                        dtSubTotalFourthGroup.Rows.Add(dtSubTotalFourthGroup.NewRow());
                                        foreach (DataColumn dcTotal in dtSubTotalFourthGroup.Columns)
                                            dtSubTotalFourthGroup.Rows[0][dcTotal] = 0;
                                    }
                                    decimal decTotal = 0;
                                    decTotal = Convert.ToDecimal(dtSubTotalFourthGroup.Rows[0][Reader.GetName(intColumn)]);
                                    decTotal += Reader.IsDBNull(intColumn) ? 0 : Convert.ToDecimal(Reader[intColumn]);
                                    dtSubTotalFourthGroup.Rows[0][Reader.GetName(intColumn)] = decTotal;
                                }
                            }
                            #endregion

                            #region Fifth : 5th
                            //if (!string.IsNullOrEmpty(strFifthGroupBy) && !string.IsNullOrEmpty(strGroupByValue_5))
                            if ((strFifthGroupBy != null) && (strGroupByValue_5 != null))
                            {
                                if (dtSubTotalFifthGroup.Columns.Contains(Reader.GetName(intColumn)) && Convert.ToString(Reader[strFifthGroupBy]) == strGroupByValue_5)
                                {
                                    if (dtSubTotalFifthGroup.Rows.Count == 0)
                                    {
                                        dtSubTotalFifthGroup.Rows.Add(dtSubTotalFifthGroup.NewRow());
                                        foreach (DataColumn dcTotal in dtSubTotalFifthGroup.Columns)
                                            dtSubTotalFifthGroup.Rows[0][dcTotal] = 0;
                                    }
                                    decimal decTotal = 0;
                                    decTotal = Convert.ToDecimal(dtSubTotalFifthGroup.Rows[0][Reader.GetName(intColumn)]);
                                    decTotal += Reader.IsDBNull(intColumn) ? 0 : Convert.ToDecimal(Reader[intColumn]);
                                    dtSubTotalFifthGroup.Rows[0][Reader.GetName(intColumn)] = decTotal;
                                }
                            }
                            #endregion

                            #endregion
                            //Remove Group By Column
                            #region
                            if (strFirstGroupBy != Convert.ToString(dtSchema.Rows[intColumn]["ColumnName"]) && strSecGroupBy != Convert.ToString(dtSchema.Rows[intColumn]["ColumnName"]) && strThirdGroupBy != Convert.ToString(dtSchema.Rows[intColumn]["ColumnName"]) && strFourthGroupBy != Convert.ToString(dtSchema.Rows[intColumn]["ColumnName"]) && strFifthGroupBy != Convert.ToString(dtSchema.Rows[intColumn]["ColumnName"]))
                            {
                                strFormat = dtSchema.Rows[intColumn]["DataTypeName"].ToString();

                                if (strFormat == "decimal")
                                {
                                    // If dataType is Numeric but it is not Currency field.
                                    if (CheckISdisplayCurrencyFormat(dtSchema.Rows[intColumn][0].ToString()))
                                        sbRecord.Append("<td align='right' >&nbsp;" + string.Format("{0:c2}", Reader[intColumn]) + "</td>");
                                    else
                                        sbRecord.Append("<td align='right' >&nbsp;" + Convert.ToString(Reader[intColumn]) + "</td>");
                                }
                                else if (strFormat == "datetime")
                                {
                                    // it display only Time
                                    if (Convert.ToString(dtSchema.Rows[intColumn]["ColumnName"]) == "Time Theft Reported")
                                        sbRecord.Append("<td >&nbsp;" + string.Format("{0:HH:mm}", Reader[intColumn]) + "</td>");
                                    else sbRecord.Append("<td >&nbsp;" + string.Format("{0:MM/dd/yyyy}", Reader[intColumn]) + "</td>");
                                }
                                else
                                {

                                    //sbRecord.Append(@"<td style='mso-number-format:\@;'>&nbsp;" + Convert.ToString(Reader[intColumn]) + "</td>");
                                    sbRecord.Append(@"<td>&nbsp;" + Convert.ToString(Reader[intColumn]) + "</td>");
                                }
                            }
                            #endregion

                        }
                        #region "Grand Total"
                        for (int intColumn2 = 0; intColumn2 < Reader.FieldCount; intColumn2++)
                        {
                            //IF Grand Total Option is Selected and Have Field for SUM.
                            if (Convert.ToString(ObjAdHocReport.GrandTotal) == "Y" && dtHeader.Columns.Count > 0)
                            {
                                if (dtHeader.Columns.Contains(Reader.GetName(intColumn2)))
                                {
                                    decimal decTotal = 0;
                                    decTotal = Convert.ToDecimal(dtHeader.Rows[0][Reader.GetName(intColumn2)]);
                                    decTotal += Reader.IsDBNull(intColumn2) ? 0 : Convert.ToDecimal(Reader[intColumn2]);
                                    dtHeader.Rows[0][Reader.GetName(intColumn2)] = decTotal;
                                }
                            }
                        }
                        #endregion
                        sbRecord.Append("</tr>");



                        using (StreamWriter sw = File.AppendText(strPath))
                        {
                            sw.Write(sbRecord);
                            sbRecord = new StringBuilder(string.Empty);
                        }
                    } while (Reader.Read());

                    #region " SUBTOAL FOR Last groups "
                    if (dtSubTotalFifthGroup.Rows.Count > 0)
                    {
                        sbRecord.Append("<tr>");
                        int intCol = 1;
                        if (dtSchema.Rows.Count > 0)
                            sbRecord.Append("<td align='left'><b>Sub Total For " + strFifthGroupBy + "</b></td>");
                        foreach (DataRow drSchema in dtSchema.Rows)
                        {
                            string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();
                            if (strFirstGroupBy != strColName && strSecGroupBy != strColName && strThirdGroupBy != strColName && strFourthGroupBy != strColName && strFifthGroupBy != strColName)
                            {
                                if (dtSubTotalFifthGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                                    sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalFifthGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                                else
                                {
                                    //if (intCol == 1)
                                    //    sbRecord.Append("<td align='left'><b>Sub Total For " + strFifthGroupBy + "</b></td>");
                                    //else
                                    //{

                                    sbRecord.Append("<td>&nbsp;</td>");
                                    //}
                                }
                            }
                            intCol++;
                        }
                        sbRecord.Append("</tr>");
                        dtSubTotalFifthGroup.Clear();
                    }
                    if (dtSubTotalFourthGroup.Rows.Count > 0)
                    {
                        sbRecord.Append("<tr>");
                        int intCol = 1;
                        if (dtSchema.Rows.Count > 0)
                            sbRecord.Append("<td align='left'><b>Sub Total For " + strFourthGroupBy + "</b></td>");
                        foreach (DataRow drSchema in dtSchema.Rows)
                        {
                            string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();
                            if (strFirstGroupBy != strColName && strSecGroupBy != strColName && strThirdGroupBy != strColName && strFourthGroupBy != strColName && strFifthGroupBy != strColName)
                            {
                                if (dtSubTotalFourthGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                                    sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalFourthGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                                else
                                {
                                    //if (intCol == 1)
                                    //    sbRecord.Append("<td align='left'><b>Sub Total For " + strFourthGroupBy + "</b></td>");
                                    //else
                                    //{

                                    sbRecord.Append("<td>&nbsp;</td>");
                                    //}
                                }
                            }
                            intCol++;
                        }
                        sbRecord.Append("</tr>");
                        dtSubTotalFourthGroup.Clear();
                    }
                    if (dtSubTotalThirdGroup.Rows.Count > 0)
                    {
                        sbRecord.Append("<tr>");
                        int intCol = 1;
                        if (dtSchema.Rows.Count > 0)
                            sbRecord.Append("<td align='left'><b>Sub Total For " + strThirdGroupBy + "</b></td>");
                        foreach (DataRow drSchema in dtSchema.Rows)
                        {
                            string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();
                            if (strFirstGroupBy != strColName && strSecGroupBy != strColName && strThirdGroupBy != strColName && strFourthGroupBy != strColName && strFifthGroupBy != strColName)
                            {
                                if (dtSubTotalThirdGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                                    sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalThirdGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                                else
                                {
                                    //if (intCol == 1)
                                    //    sbRecord.Append("<td align='left'><b>Sub Total For " + strThirdGroupBy + "</b></td>");
                                    //else
                                    //{

                                    sbRecord.Append("<td>&nbsp;</td>");
                                    //}
                                }
                            }
                            intCol++;
                        }
                        sbRecord.Append("</tr>");
                        dtSubTotalThirdGroup.Clear();
                    }
                    if (dtSubTotalSecondGroup.Rows.Count > 0)
                    {
                        sbRecord.Append("<tr>");
                        int intCol = 1;
                        if (dtSchema.Rows.Count > 0)
                            sbRecord.Append("<td align='left'><b>Sub Total For " + strSecGroupBy + "</b></td>");
                        foreach (DataRow drSchema in dtSchema.Rows)
                        {
                            string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();
                            if (strFirstGroupBy != strColName && strSecGroupBy != strColName && strThirdGroupBy != strColName && strFourthGroupBy != strColName && strFifthGroupBy != strColName)
                            {
                                if (dtSubTotalSecondGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                                    sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalSecondGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                                else
                                {
                                    //if (intCol == 1)
                                    //    sbRecord.Append("<td align='left'><b>Sub Total For " + strSecGroupBy + "</b></td>");
                                    //else
                                    //{
                                    sbRecord.Append("<td>&nbsp;</td>");
                                    //}
                                }
                            }
                            intCol++;
                        }
                        sbRecord.Append("</tr>");
                        dtSubTotalSecondGroup.Clear();
                    }
                    if (dtSubTotalFirstGroup.Rows.Count > 0)
                    {
                        sbRecord.Append("<tr>");
                        int intCol = 1;
                        if (dtSchema.Rows.Count > 0)
                            sbRecord.Append("<td align='left'><b>Sub Total For " + strFirstGroupBy + "</b></td>");
                        foreach (DataRow drSchema in dtSchema.Rows)
                        {
                            string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();
                            if (strFirstGroupBy != strColName && strSecGroupBy != strColName && strThirdGroupBy != strColName && strFourthGroupBy != strColName && strFifthGroupBy != strColName)
                            {
                                if (dtSubTotalFirstGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                                    sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalFirstGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                                else
                                {
                                    //if (intCol == 1)
                                    //    sbRecord.Append("<td align='left'><b>Sub Total For " + strFirstGroupBy + "</b></td>");
                                    //else
                                    //{
                                    sbRecord.Append("<td>&nbsp;</td>");
                                    // }
                                }
                            }
                            intCol++;
                        }
                        sbRecord.Append("</tr>");
                        dtSubTotalFirstGroup.Clear();
                    }

                    #endregion

                    #endregion

                    //Table End
                    sbRecord.Append("</table></td></tr>");

                    #region "Footer Template"
                    // IF Grand Total Option is Checked and Have record from Transaction Table to SUM
                    if ((Convert.ToString(ObjAdHocReport.GrandTotal) == "Y") && dtHeader.Columns.Count > 0)
                    {
                        string strStyle = "'font-weight: bold;background-color: #507CD1;color: White;'";
                        //sbRecord.Append("<br />");
                        sbRecord.Append("<tr><td colspan='8'>");
                        sbRecord.Append("<table border='1' cellpadding='0' cellspacing='0'><tr align='right'>");
                        sbRecord.Append("<td style='font-weight: bold;' align='left'>Grand Totals</td>");

                        for (int intColumn = 0; intColumn < dtHeader.Columns.Count; intColumn++)
                            sbRecord.Append("<td style='font-weight: bold;'>" + Convert.ToString(dtHeader.Columns[intColumn]) + "</td>");
                        // show Header for claim count
                        // sbRecord.Append("<td style='font-weight: bold;'>" + Convert.ToString(dtHeader.Columns[0]) + "</td>");
                        sbRecord.Append("</tr>");

                        sbRecord.Append("<tr align='right'>");
                        sbRecord.Append("<td style=" + strStyle + ">&nbsp;</td>");

                        //No column Claim count 
                        for (int intColumn = 0; intColumn < dtHeader.Columns.Count; intColumn++)
                            sbRecord.Append("<td style=" + strStyle + ">" + string.Format("{0:c2}", dtHeader.Rows[0][intColumn]) + "</td>");
                        // show value for Claim Count
                        //sbRecord.Append("<td style=" + strStyle + ">" + dtHeader.Rows[0][dtHeader.Columns.Count - 1] + "</td>");
                        sbRecord.Append("</table></td></tr>");
                    }
                    sbRecord.Append("</table>");
                    #endregion
                    //Remove White Space.
                    //sbRecord.Replace("<tr></tr>", "");
                    using (StreamWriter sw = File.AppendText(strPath))
                    {
                        sw.Write(sbRecord);
                        sbRecord = new StringBuilder(string.Empty);
                    }
                }
                else
                {
                    //Remove WhiteSpace
                    sbRecord.Replace("<tr></tr>", "");
                    if (!Directory.Exists(AppDomain.CurrentDomain.BaseDirectory + @"temp\"))
                        Directory.CreateDirectory(AppDomain.CurrentDomain.BaseDirectory + @"temp\");

                    strPath = AppDomain.CurrentDomain.BaseDirectory + @"temp\" + strReportSchedulerName + System.DateTime.Now.ToString("MMddyyhhmmss") + ".xls";
                    ///When records are not found.
                    sbRecord.Append("<table  cellpadding='4' cellspacing='0' Width='100%'>");
                    sbRecord.Append("<tr>");
                    sbRecord.Append("<td align='center'>No Record found.</td></tr></table>");
                    using (StreamWriter sw = File.AppendText(strPath))
                    {
                        sw.Write(sbRecord);
                        sbRecord = new StringBuilder(string.Empty);
                    }
                }

                if (!Reader.IsClosed)
                    Reader.Close();

                return strPath;
            }
            catch (Exception ex)
            {
                //EventLog.WriteEntry("ERROR in Ad Hoc Report Writer , " + ex.Message);
                EventLog.WriteEntry("ERROR in ACI Management Ad Hoc Report Writer , " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
            finally
            {
                if (Reader != null)
                {
                    Reader.Close();
                    Reader.Dispose();
                }
                if (dtSchema != null)
                    dtSchema.Dispose();
                if (dtHeader != null)
                    dtHeader.Dispose();
            }
            return strPath;
        }

        /// <summary>
        /// Bind Report Data.
        /// </summary>
        /// <param name="dsReport">Report Dataset</param>
        private string BindReportForSafetyTraining(ref StringBuilder sbRecord, IDataReader Reader, ERIMS_DAL.Sonic_U_Train_AdHocReport ObjAdHocReport, List<ERIMS_DAL.Sonic_U_Train_AdHocFilter> lstFilter, string strReportSchedulerName)
        {
            DataTable dtSchema = null, dtHeader = null;
            Sonic_U_Train_AdhocReportFields objReportFields = new Sonic_U_Train_AdhocReportFields();
            List<Sonic_U_Train_AdhocReportFields> lstAdhoc = null;
            string strPath = string.Empty;
            Boolean IsGroupBySelected = false;
            Int32 countColumn = 0;


            try
            {
                #region "Filter and Title"
                sbRecord.Append("<table cellpadding='0' cellspacing='0' style='font-size:10pt'>");
                sbRecord.Append("<tr><td colspan='3'><b>Report Title : " + strReportSchedulerName + " </b></td></tr>");
                //sbRecord.Append("<br /><br />");

                Sonic_U_Train_AdhocReportFields obj = new Sonic_U_Train_AdhocReportFields();
                for (int i = 0; i < lstFilter.Count; i++)
                {
                    string strConditionVal = string.Empty;
                    if (lstFilter[i].Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.TextBox)
                    {
                        string strConditionType = lstFilter[i].ConditionType;
                        strConditionType = (strConditionType == "1") ? " Contains " : (strConditionType == "2" ? " Start With " : " End With ");
                        strConditionVal = lstFilter[i].ConditionValue;
                        lstAdhoc = obj.GetAdHocReportFieldByPk(Convert.ToDecimal(lstFilter[i].FK_AdHocReportFields));
                        sbRecord.Append("<tr><td colspan='3'><b>" + lstAdhoc[0].Field_Header + strConditionType + " : " + "</b>" + lstFilter[i].ConditionValue + "</td></tr>");
                    }

                    if (lstFilter[i].Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.MultiSelectList)
                    {
                        lstAdhoc = obj.GetAdHocReportFieldByPk(Convert.ToDecimal(lstFilter[i].FK_AdHocReportFields));
                        sbRecord.Append("<tr><td colspan='3'><b>" + lstAdhoc[0].Field_Header + " (In)</b>" + " : " + FillFilterDropDownForSafetyTraining(lstAdhoc[0].Field_Header, lstFilter[i].ConditionValue) + "</td></tr>");
                    }

                    if (lstFilter[i].Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.DateControl)
                    {
                        string strConditionType = lstFilter[i].ConditionType;
                        lstAdhoc = obj.GetAdHocReportFieldByPk(Convert.ToDecimal(lstFilter[i].FK_AdHocReportFields));
                        strConditionType = (strConditionType == "O") ? " On " : (strConditionType == "B" ? " Between " : (strConditionType == "BF" ? "On or Before " : "On or After "));

                        string dtFrom = null, dtTo = null;
                        if (string.IsNullOrEmpty(lstFilter[i].FromRelativeCriteria))
                            dtFrom = FormatDBNullDateToDisplay(lstFilter[i].FromDate);
                        else
                        {
                            // set Relative Date From criteria
                            AdHocReportHelper.RaltiveDates RelType = (AdHocReportHelper.RaltiveDates)Enum.Parse(typeof(AdHocReportHelper.RaltiveDates), lstFilter[i].FromRelativeCriteria);
                            dtFrom = AdHocReportHelper.GetRelativeDate(RelType).ToString("MM/dd/yyyy");
                        }
                        if (string.IsNullOrEmpty(lstFilter[i].ToRelativeCriteria))
                            dtTo = FormatDBNullDateToDisplay(lstFilter[i].ToDate);
                        else
                        {
                            // set Relative Date To criteria
                            AdHocReportHelper.RaltiveDates RelType = (AdHocReportHelper.RaltiveDates)Enum.Parse(typeof(AdHocReportHelper.RaltiveDates), lstFilter[i].ToRelativeCriteria);
                            dtTo = AdHocReportHelper.GetRelativeDate(RelType).ToString("MM/dd/yyyy");
                        }

                        //if (Convert.ToBoolean(lstFilter[i].IsNotSelected) == true)
                        //    strConditionType = "Not" + strConditionType;

                        if (strConditionType.Trim() != "Between" && strConditionType.Trim() != "Not Between")
                            strConditionVal = "<tr><td colspan='3'><b>" + lstAdhoc[0].Field_Header + " : " + strConditionType + "</b>" + dtFrom + "</td></tr>";
                        else
                            strConditionVal = "<tr><td colspan='3'><b>" + lstAdhoc[0].Field_Header + " : </b>" + strConditionType + dtFrom + " And " + dtTo + "</td></tr>";

                        sbRecord.Append(strConditionVal);
                    }
                    if (lstFilter[i].Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.AmountControl)
                    {
                        string strConditionType = lstFilter[i].ConditionType;
                        lstAdhoc = obj.GetAdHocReportFieldByPk(Convert.ToDecimal(lstFilter[i].FK_AdHocReportFields));
                        strConditionType = (strConditionType == "0") ? " Equal " : (strConditionType == "1" ? " Greater Than " : (strConditionType == "2" ? " Between " : " Less Than "));

                        //if (Convert.ToBoolean(lstFilter[i].IsNotSelected) == true)
                        //    strConditionType = "Not" + strConditionType;

                        if (strConditionType.Trim() != "Between" && strConditionType.Trim() != "Not Between")
                            strConditionVal = "<tr><td colspan='3'><b>" + lstAdhoc[0].Field_Header + " : " + strConditionType + "</b>" + Convert.ToString(lstFilter[i].AmountFrom) + "</td></tr>";
                        else
                            strConditionVal = "<tr><td colspan='3'><b>" + lstAdhoc[0].Field_Header + " : </b>" + strConditionType + Convert.ToString(lstFilter[i].AmountFrom) + " And " + Convert.ToString(lstFilter[i].AmountTo) + "</td></tr>";
                        sbRecord.Append(strConditionVal);
                    }
                    // sbRecord.Append("<br />");
                }
                //sbRecord.Append("<br /></td></tr></table>");
                //sbRecord.Append("<br/>");
                #endregion

                // Check if Any record is exists or not
                if (Reader.Read())
                {
                    string strFirstGroupBy = string.Empty, strSecGroupBy = string.Empty, strThirdGroupBy = null, strFourthGroupBy = null, strFifthGroupBy = null;

                    if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.FirstGroupBy)))
                    {
                        if (ObjAdHocReport.FirstGroupBy == -2)
                            strFirstGroupBy = "Accident Year";
                        else
                        {
                            lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.FirstGroupBy));
                            strFirstGroupBy = lstAdhoc[0].Field_Header;
                        }

                        IsGroupBySelected = true;
                    }

                    if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.SecondGroupBy)))
                    {
                        if (ObjAdHocReport.SecondGroupBy == -3)
                            strSecGroupBy = "Accident Year";
                        else
                        {
                            lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.SecondGroupBy));
                            strSecGroupBy = lstAdhoc[0].Field_Header;
                        }

                        IsGroupBySelected = true;
                    }



                    //iF First Group By is Not  selected then second Group by will be set as first Group By
                    if (string.IsNullOrEmpty(strFirstGroupBy))
                    {
                        strFirstGroupBy = strSecGroupBy;
                        strSecGroupBy = string.Empty;
                    }

                    dtSchema = Reader.GetSchemaTable();

                    sbRecord.Append("<tr><td><table border='1' cellpadding='0' cellspacing='0' width='" + (150 * (ObjAdHocReport.OutputFields.Split(',').Length + 1)).ToString() + "' style='font-size:10pt'>");

                    #region "Header"
                    // If reader found a records 
                    sbRecord.Append("<tr>");
                    if (IsGroupBySelected)
                        sbRecord.Append("<td colspan='2'>&nbsp;</td>");
                    dtHeader = new DataTable();
                    string strFormatFirstGroupBy = string.Empty, strFormatSecGroupBy = string.Empty, strFormatThirdGroupBy = string.Empty, strFormatFourthGroupBy = string.Empty, strFormatFifthGroupBy = string.Empty;
                    foreach (DataRow drHeader in dtSchema.Rows)
                    {
                        //Remove Group By 
                        if (strFirstGroupBy != Convert.ToString(drHeader["ColumnName"]) && strSecGroupBy != Convert.ToString(drHeader["ColumnName"]) && strThirdGroupBy != Convert.ToString(drHeader["ColumnName"]) && strFourthGroupBy != Convert.ToString(drHeader["ColumnName"]) && strFifthGroupBy != Convert.ToString(drHeader["ColumnName"]))
                        {
                            if (drHeader["ColumnName"].ToString() != "Claim Count")
                            {
                                sbRecord.Append("<td><b>" + drHeader["ColumnName"] + "</b></td>");
                                countColumn++;
                            }

                        }

                        //IF Grand Total Option is Selected.
                        //if (Convert.ToString(ObjAdHocReport.GrandTotal) == "Y" && CheckTotalField(drHeader["ColumnName"].ToString()))
                        //    dtHeader.Columns.Add(new DataColumn(drHeader["ColumnName"].ToString(), Type.GetType("System.Decimal")));

                        //Get  Group By Field's Data Type
                        if (strFirstGroupBy == Convert.ToString(drHeader["ColumnName"]))
                            strFormatFirstGroupBy = drHeader["DataTypeName"].ToString();
                        if (strSecGroupBy == Convert.ToString(drHeader["ColumnName"]))
                            strFormatSecGroupBy = drHeader["DataTypeName"].ToString();
                        if (strThirdGroupBy == Convert.ToString(drHeader["ColumnName"]))
                            strFormatThirdGroupBy = drHeader["DataTypeName"].ToString();
                        if (strFourthGroupBy == Convert.ToString(drHeader["ColumnName"]))
                            strFormatFourthGroupBy = drHeader["DataTypeName"].ToString();
                        if (strFifthGroupBy == Convert.ToString(drHeader["ColumnName"]))
                            strFormatFifthGroupBy = drHeader["DataTypeName"].ToString();

                    }
                    //When Header have records
                    if (dtHeader.Columns.Count > 0)
                    {
                        DataRow drHerder = dtHeader.NewRow();

                        for (int i = 0; i < dtHeader.Columns.Count; i++)
                            drHerder[i] = 0;

                        dtHeader.Rows.Add(drHerder);
                        dtHeader.AcceptChanges();
                    }

                    sbRecord.Append("</tr>");

                    #endregion

                    strPath = AppDomain.CurrentDomain.BaseDirectory + @"temp\" + strReportSchedulerName + System.DateTime.Now.ToString("MMddyyhhmmss") + ".xls";

                    if (!File.Exists(strPath))
                    {
                        if (!Directory.Exists(AppDomain.CurrentDomain.BaseDirectory + @"temp\"))
                            Directory.CreateDirectory(AppDomain.CurrentDomain.BaseDirectory + @"temp\");
                        // Create a file to write to.
                        //Remove WhiteSpace
                        sbRecord.Replace("<tr></tr>", "");
                        File.SetAttributes(AppDomain.CurrentDomain.BaseDirectory, FileAttributes.Normal);
                        using (StreamWriter sw = File.CreateText(strPath))
                        {
                            sw.Write(sbRecord.ToString());
                            sbRecord = new StringBuilder(string.Empty);
                        }
                    }

                    #region "Item Template"

                    DataTable dtSubTotalFirstGroup = dtHeader.Clone();
                    DataTable dtSubTotalSecondGroup = dtHeader.Clone();
                    DataTable dtSubTotalThirdGroup = dtHeader.Clone();
                    DataTable dtSubTotalFourthGroup = dtHeader.Clone();
                    DataTable dtSubTotalFifthGroup = dtHeader.Clone();

                    string strGroupByValue_1 = string.Empty, strGroupByValue_2 = string.Empty, strNOGroup1 = string.Empty, strNOGroup2 = string.Empty;
                    string strGroupByValue_3 = string.Empty, strGroupByValue_4 = string.Empty, strNOGroup3 = string.Empty, strNOGroup4 = string.Empty;
                    string strGroupByValue_5 = string.Empty, strNOGroup5 = string.Empty;

                    do
                    {
                        string strFormat = string.Empty;

                        #region "SUBTOTALS"

                        #region Fifth
                        // print subtotal for 5th group by when the value is changed
                        if (!string.IsNullOrEmpty(strFifthGroupBy) && !string.IsNullOrEmpty(strGroupByValue_5) && strGroupByValue_5 != Convert.ToString(Reader[strFifthGroupBy]))
                        {
                            if (dtSubTotalFifthGroup.Rows.Count > 0)
                            {
                                sbRecord.Append("<tr>");
                                int intCol = 1;
                                //first column is for sub total when sub total is found
                                if (dtSchema.Rows.Count > 0)
                                    sbRecord.Append("<td><b>Sub Total For " + strFifthGroupBy + "</b></td>");
                                foreach (DataRow drSchema in dtSchema.Rows)
                                {
                                    string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();

                                    if (strFirstGroupBy != strColName && strSecGroupBy != strColName && strThirdGroupBy != strColName && strFourthGroupBy != strColName && strFifthGroupBy != strColName)
                                    {
                                        if (dtSubTotalFifthGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                                            sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalFifthGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                                        else
                                        {
                                            //if (intCol == 1)
                                            //    sbRecord.Append("<td><b>Sub Total For " + strFifthGroupBy + "</b></td><td>&nbsp;</td>");
                                            //else
                                            //{
                                            sbRecord.Append("<td>&nbsp;</td>");
                                            //}
                                        }
                                    }
                                    intCol++;
                                }

                                sbRecord.Append("</tr>");
                                dtSubTotalFifthGroup.Clear();
                            }
                        }
                        #endregion

                        #region Fourth
                        // print subtotal for 4th group by when the value is changed
                        if (!string.IsNullOrEmpty(strFourthGroupBy) && !string.IsNullOrEmpty(strGroupByValue_4) && strGroupByValue_4 != Convert.ToString(Reader[strFourthGroupBy]))
                        {
                            if (dtSubTotalFourthGroup.Rows.Count > 0)
                            {
                                sbRecord.Append("<tr>");
                                int intCol = 1;

                                if (dtSchema.Rows.Count > 0)
                                    sbRecord.Append("<td><b>Sub Total For " + strFourthGroupBy + "</b></td>");
                                foreach (DataRow drSchema in dtSchema.Rows)
                                {
                                    string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();
                                    if (strFirstGroupBy != strColName && strSecGroupBy != strColName && strThirdGroupBy != strColName && strFourthGroupBy != strColName && strFifthGroupBy != strColName)
                                    {

                                        if (dtSubTotalFourthGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                                            sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalFourthGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                                        else
                                        {
                                            //if (intCol == 1)
                                            //    sbRecord.Append("<td><b>Sub Total For " + strFourthGroupBy + "</b></td><td>&nbsp;</td>");
                                            //else
                                            //{

                                            sbRecord.Append("<td>&nbsp;</td>");
                                            //}
                                        }
                                    }
                                    intCol++;
                                }

                                sbRecord.Append("</tr>");
                                dtSubTotalFourthGroup.Clear();
                            }
                        }
                        #endregion

                        #region Third
                        // print subtotal for 3rd group by when the value is changed
                        if (!string.IsNullOrEmpty(strThirdGroupBy) && !string.IsNullOrEmpty(strGroupByValue_3) && strGroupByValue_3 != Convert.ToString(Reader[strThirdGroupBy]))
                        {
                            if (dtSubTotalThirdGroup.Rows.Count > 0)
                            {
                                sbRecord.Append("<tr>");
                                int intCol = 1;
                                if (dtSchema.Rows.Count > 0)
                                    sbRecord.Append("<td><b>Sub Total For " + strThirdGroupBy + "</b></td>");
                                foreach (DataRow drSchema in dtSchema.Rows)
                                {
                                    string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();

                                    if (strFirstGroupBy != strColName && strSecGroupBy != strColName && strThirdGroupBy != strColName && strFourthGroupBy != strColName && strFifthGroupBy != strColName)
                                    {

                                        if (dtSubTotalThirdGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                                            sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalThirdGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                                        else
                                        {
                                            //if (intCol == 1)
                                            //    sbRecord.Append("<td><b>Sub Total For " + strThirdGroupBy + "</b></td><td>&nbsp;</td>");
                                            //else
                                            //{

                                            sbRecord.Append("<td>&nbsp;</td>");
                                            //}
                                        }
                                    }

                                    intCol++;
                                }

                                sbRecord.Append("</tr>");
                                dtSubTotalThirdGroup.Clear();
                            }
                        }
                        #endregion

                        #region Second
                        // print subtotal for 2nd group by when the value is changed
                        if (!string.IsNullOrEmpty(strSecGroupBy) && !string.IsNullOrEmpty(strGroupByValue_2) && strGroupByValue_2 != Convert.ToString(Reader[strSecGroupBy]))
                        {
                            if (dtSubTotalSecondGroup.Rows.Count > 0)
                            {
                                sbRecord.Append("<tr>");
                                int intCol = 1;
                                if (dtSchema.Rows.Count > 0)
                                    sbRecord.Append("<td><b>Sub Total For " + strSecGroupBy + "</b></td>");
                                foreach (DataRow drSchema in dtSchema.Rows)
                                {
                                    string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();

                                    if (strFirstGroupBy != strColName && strSecGroupBy != strColName && strThirdGroupBy != strColName && strFourthGroupBy != strColName && strFifthGroupBy != strColName)
                                    {
                                        if (dtSubTotalSecondGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                                            sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalSecondGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                                        else
                                        {
                                            //if (intCol == 1)
                                            //    sbRecord.Append("<td><b>Sub Total For " + strSecGroupBy + "</b></td><td>&nbsp;</td>");
                                            //else
                                            //{

                                            sbRecord.Append("<td>&nbsp;</td>");
                                            // }
                                        }
                                    }

                                    intCol++;
                                }

                                sbRecord.Append("</tr>");
                                dtSubTotalSecondGroup.Clear();
                            }
                        }
                        #endregion

                        #region First
                        // print subtotal for 1st group by when the value is changed
                        if (!string.IsNullOrEmpty(strFirstGroupBy) && !string.IsNullOrEmpty(strGroupByValue_1) && strGroupByValue_1 != Convert.ToString(Reader[strFirstGroupBy]))
                        {
                            if (dtSubTotalFirstGroup.Rows.Count > 0)
                            {
                                sbRecord.Append("<tr>");
                                int intCol = 1;
                                if (dtSchema.Rows.Count > 0)
                                    sbRecord.Append("<td><b>Sub Total For " + strFirstGroupBy + "</b></td>");
                                foreach (DataRow drSchema in dtSchema.Rows)
                                {
                                    string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();

                                    if (strFirstGroupBy != strColName && strSecGroupBy != strColName && strThirdGroupBy != strColName && strFourthGroupBy != strColName && strFifthGroupBy != strColName)
                                    {
                                        if (dtSubTotalFirstGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                                            sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalFirstGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                                        else
                                        {
                                            //if (intCol == 1)
                                            //    sbRecord.Append("<td><b>Sub Total For " + strFirstGroupBy + "</b></td><td>&nbsp;</td>");
                                            //else
                                            //{

                                            sbRecord.Append("<td>&nbsp;</td>");
                                            //}
                                        }
                                    }

                                    intCol++;
                                }

                                sbRecord.Append("</tr>");
                                dtSubTotalFirstGroup.Clear();
                            }
                        }
                        #endregion

                        #endregion

                        #region Group By

                        #region First Group
                        if (!string.IsNullOrEmpty(strFirstGroupBy))
                        {
                            if (strGroupByValue_1 != Convert.ToString(Reader[strFirstGroupBy]))
                            {
                                strGroupByValue_1 = Convert.ToString(Reader[strFirstGroupBy]);
                                if (strFormatFirstGroupBy == "decimal")
                                    sbRecord.Append("<tr><td style='font-weight: bold;color: #FF9C09;' colspan='2' align='right' >&nbsp;" + strFirstGroupBy + ": " + string.Format("{0:c2}", strGroupByValue_1) + "</td></tr>");
                                else if (strFormatFirstGroupBy == "datetime")
                                {
                                    // it display only Time
                                    if (strFirstGroupBy == "Time Theft Reported")
                                        sbRecord.Append("<tr><td style='font-weight: bold;color: #FF9C09;' colspan='2'>&nbsp;" + strFirstGroupBy + ": " + string.Format("{0:HH:mm}", Reader[strFirstGroupBy]) + "</td></tr>");
                                    else sbRecord.Append("<tr><td style='font-weight: bold;color: #FF9C09;' colspan='2'>&nbsp;" + strFirstGroupBy + ": " + FormatDBNullDateToDisplay(strGroupByValue_1) + "</td></tr>");
                                }
                                else sbRecord.Append("<tr><td style='font-weight: bold;color: #FF9C09;' colspan='2'>&nbsp;" + strFirstGroupBy + ": " + strGroupByValue_1 + "</td><td  style='border-bottom:none;' rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                //Change Second Group By when First Groupby is Change
                                strGroupByValue_2 = string.Empty;
                            }
                            // it will set No : [First Group By] when it is null
                            else if ((Reader[strFirstGroupBy] == DBNull.Value || string.IsNullOrEmpty(Convert.ToString(Reader[strFirstGroupBy]))) && strNOGroup1 == string.Empty)
                            {
                                strNOGroup1 = "No " + strFirstGroupBy;
                                sbRecord.Append("<tr><td style='font-weight: bold;color: #FF9C09;' colspan='2'>&nbsp;" + strFirstGroupBy + ": " + strNOGroup1 + "</td></tr>");
                                // When Group by 1 value find as Null
                                strNOGroup1 = strFirstGroupBy;
                                //Change Second Group By when First Groupby is Change
                                strGroupByValue_2 = string.Empty;
                            }
                        }
                        #endregion

                        #region Second Group By
                        if (!string.IsNullOrEmpty(strSecGroupBy))
                        {
                            if (strGroupByValue_2 != Convert.ToString(Reader[strSecGroupBy]))
                            {
                                strGroupByValue_2 = Convert.ToString(Reader[strSecGroupBy]);
                                if (strFormatSecGroupBy == "decimal")
                                    sbRecord.Append("<tr><td style='font-weight: bold;color: #276692;' align='right' colspan='2' >&nbsp;" + strSecGroupBy + ": " + string.Format("{0:c2}", strGroupByValue_2) + "</td><td style='border-bottom:none;' rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                else if (strFormatSecGroupBy == "datetime")
                                {
                                    // it display only Time
                                    if (strSecGroupBy == "Time Theft Reported")
                                        sbRecord.Append("<tr><td style='font-weight: bold;color: #276692;' colspan='2'>&nbsp;" + strSecGroupBy + ": " + string.Format("{0:HH:mm}", Reader[strSecGroupBy]) + "</td><td style='border-bottom:none;' rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                    else sbRecord.Append("<tr><td style='font-weight: bold;color: #276692;' colspan='2'>&nbsp;" + strSecGroupBy + ": " + FormatDBNullDateToDisplay(strGroupByValue_2) + "</td><td style='border-bottom:none;' rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                }
                                else sbRecord.Append("<tr><td style='font-weight: bold;color: #276692;' colspan='2'>&nbsp;" + strSecGroupBy + ": " + strGroupByValue_2 + "</td><td style='border-bottom:none;' rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                            }
                            else if (Reader[strSecGroupBy] == DBNull.Value && strNOGroup2 == string.Empty)
                            {
                                strNOGroup2 = "No " + strSecGroupBy;
                                sbRecord.Append("<tr><td style='font-weight: bold;color: #276692;' colspan='2'>&nbsp;" + strSecGroupBy + ": " + strNOGroup2 + "</td><td style='border-bottom:none;' rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                //No Group by assign
                                strNOGroup2 = strGroupByValue_2;
                            }
                        }
                        #endregion

                        #region Third Group BY
                        if (!string.IsNullOrEmpty(strThirdGroupBy))
                        {
                            if (strGroupByValue_3 != Convert.ToString(Reader[strThirdGroupBy]))
                            {
                                strGroupByValue_3 = Convert.ToString(Reader[strThirdGroupBy]);
                                if (strFormatThirdGroupBy == "decimal")
                                    sbRecord.Append("<tr><td style='font-weight: bold;color: #603311;' align='right' colspan='2'>&nbsp;" + strThirdGroupBy + ": " + string.Format("{0:c2}", strGroupByValue_3) + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                else if (strFormatThirdGroupBy == "datetime")
                                {
                                    // it display only Time
                                    if (strThirdGroupBy == "Time Theft Reported")
                                        sbRecord.Append("<tr><td style='font-weight: bold;color: #603311;' colspan='2'>&nbsp;" + strThirdGroupBy + ": " + string.Format("{0:HH:mm}", Reader[strThirdGroupBy]) + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                    else sbRecord.Append("<tr><td style='font-weight: bold;color: #603311;' colspan='2'>&nbsp;" + strThirdGroupBy + ": " + FormatDBNullDateToDisplay(strGroupByValue_3) + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                }
                                else sbRecord.Append("<tr><td style='font-weight: bold;color: #603311;' colspan='2'>&nbsp;" + strThirdGroupBy + ": " + strGroupByValue_3 + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                strGroupByValue_4 = strGroupByValue_5 = null;
                            }
                            else if ((Reader[strThirdGroupBy] == DBNull.Value || string.IsNullOrEmpty(Convert.ToString(Reader[strThirdGroupBy]))) && strNOGroup3 == string.Empty)
                            {
                                strNOGroup3 = "No " + strThirdGroupBy;
                                sbRecord.Append("<tr><td style='font-weight: bold;color: #603311;' colspan='2'>&nbsp;" + strThirdGroupBy + ": " + strNOGroup3 + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                // When Group by 3 value find as Null
                                strNOGroup3 = strThirdGroupBy;
                                //Change third Group By when 3rd Groupby is Change
                                strGroupByValue_3 = string.Empty;
                            }
                        }
                        #endregion

                        #region Fourth Group BY
                        if (!string.IsNullOrEmpty(strFourthGroupBy))
                        {
                            if (strGroupByValue_4 != Convert.ToString(Reader[strFourthGroupBy]))
                            {
                                strGroupByValue_4 = Convert.ToString(Reader[strFourthGroupBy]);
                                if (strFormatFourthGroupBy == "decimal")
                                    sbRecord.Append("<tr><td style='font-weight: bold;color: green;' align='right' colspan='2'>&nbsp;" + strFourthGroupBy + ": " + string.Format("{0:c2}", strGroupByValue_4) + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                else if (strFormatFourthGroupBy == "datetime")
                                {
                                    // it display only Time
                                    if (strFourthGroupBy == "Time Theft Reported")
                                        sbRecord.Append("<tr><td style='font-weight: bold;color: green;' colspan='2'>&nbsp;" + strFourthGroupBy + ": " + string.Format("{0:HH:mm}", Reader[strFourthGroupBy]) + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                    else sbRecord.Append("<tr><td style='font-weight: bold;color: green;' colspan='2'>&nbsp;" + strFourthGroupBy + ": " + FormatDBNullDateToDisplay(strGroupByValue_4) + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                }
                                else sbRecord.Append("<tr><td style='font-weight: bold;color: green;' colspan='2'>&nbsp;" + strFourthGroupBy + ": " + strGroupByValue_4 + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                strGroupByValue_5 = null;
                            }
                            else if ((Reader[strFourthGroupBy] == DBNull.Value || string.IsNullOrEmpty(Convert.ToString(Reader[strFourthGroupBy]))) && strNOGroup4 == string.Empty)
                            {
                                strNOGroup4 = "No " + strFourthGroupBy;
                                sbRecord.Append("<tr><td style='font-weight: bold;color: green;' colspan='2'>&nbsp;" + strFourthGroupBy + ": " + strNOGroup4 + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                // When Group by 4 value find as Null
                                strNOGroup4 = strFourthGroupBy;
                                //Change Fourth Group By when 4th Groupby is Change
                                strGroupByValue_4 = string.Empty;
                            }
                        }
                        #endregion

                        #region Fifth Group BY
                        if (!string.IsNullOrEmpty(strFifthGroupBy))
                        {
                            if (strGroupByValue_5 != Convert.ToString(Reader[strFifthGroupBy]))
                            {
                                strGroupByValue_5 = Convert.ToString(Reader[strFifthGroupBy]);
                                if (strFormatFifthGroupBy == "decimal")
                                    sbRecord.Append("<tr><td style='font-weight: bold;' align='right' colspan='2'>&nbsp;" + strFifthGroupBy + ": " + string.Format("{0:c2}", strGroupByValue_5) + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                else if (strFormatFifthGroupBy == "datetime")
                                {
                                    // it display only Time
                                    if (strFifthGroupBy == "Time Theft Reported")
                                        sbRecord.Append("<tr><td style='font-weight: bold;' colspan='2'>&nbsp;" + strFifthGroupBy + ": " + string.Format("{0:HH:mm}", Reader[strFifthGroupBy]) + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                    else sbRecord.Append("<tr><td style='font-weight: bold;' colspan='2'>&nbsp;" + strFifthGroupBy + ": " + FormatDBNullDateToDisplay(strGroupByValue_5) + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                }
                                else sbRecord.Append("<tr><td style='font-weight: bold;' colspan='2'>&nbsp;" + strFifthGroupBy + ": " + strGroupByValue_5 + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                            }
                            else if ((Reader[strFifthGroupBy] == DBNull.Value || string.IsNullOrEmpty(Convert.ToString(Reader[strFifthGroupBy]))) && strNOGroup5 == string.Empty)
                            {
                                strNOGroup5 = "No " + strFifthGroupBy;
                                sbRecord.Append("<tr><td style='font-weight: bold;' colspan='2'>&nbsp;" + strFifthGroupBy + ": " + strNOGroup5 + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                // When Group by 5 value find as Null
                                strNOGroup5 = strFifthGroupBy;
                                //Change fifth Group By when fifth Groupby is Change
                                strGroupByValue_5 = string.Empty;
                            }
                        }

                        //sbRecord.Append("</table></td></tr>");
                        #endregion

                        #endregion

                        string strColumnName = string.Empty;
                        sbRecord.Append("<tr>");
                        if (IsGroupBySelected)
                            sbRecord.Append("<td colspan='2'>&nbsp;</td>");
                        ///Print Records
                        //for (int intColumn = 0; intColumn < Reader.FieldCount - 1; intColumn++)
                        for (int intColumn = 0; intColumn <= Reader.FieldCount - 1; intColumn++)
                        {
                            #region " Count Sub Totals"
                            #region First : 1st
                            if (!string.IsNullOrEmpty(strFirstGroupBy) && !string.IsNullOrEmpty(strGroupByValue_1))
                            {
                                if (dtSubTotalFirstGroup.Columns.Contains(Reader.GetName(intColumn)) && Convert.ToString(Reader[strFirstGroupBy]) == strGroupByValue_1)
                                {
                                    if (dtSubTotalFirstGroup.Rows.Count == 0)
                                    {
                                        dtSubTotalFirstGroup.Rows.Add(dtSubTotalFirstGroup.NewRow());
                                        foreach (DataColumn dcTotal in dtSubTotalFirstGroup.Columns)
                                            dtSubTotalFirstGroup.Rows[0][dcTotal] = 0;
                                    }
                                    decimal decTotal = 0;
                                    decTotal = Convert.ToDecimal(dtSubTotalFirstGroup.Rows[0][Reader.GetName(intColumn)]);
                                    decTotal += Reader.IsDBNull(intColumn) ? 0 : Convert.ToDecimal(Reader[intColumn]);
                                    dtSubTotalFirstGroup.Rows[0][Reader.GetName(intColumn)] = decTotal;
                                }
                            }
                            #endregion

                            #region  second: 2nd
                            if (!string.IsNullOrEmpty(strSecGroupBy) && !string.IsNullOrEmpty(strGroupByValue_2))
                            {
                                if (dtSubTotalSecondGroup.Columns.Contains(Reader.GetName(intColumn)) && Convert.ToString(Reader[strSecGroupBy]) == strGroupByValue_2)
                                {
                                    if (dtSubTotalSecondGroup.Rows.Count == 0)
                                    {
                                        dtSubTotalSecondGroup.Rows.Add(dtSubTotalSecondGroup.NewRow());
                                        foreach (DataColumn dcTotal in dtSubTotalSecondGroup.Columns)
                                            dtSubTotalSecondGroup.Rows[0][dcTotal] = 0;
                                    }
                                    decimal decTotal = 0;
                                    decTotal = Convert.ToDecimal(dtSubTotalSecondGroup.Rows[0][Reader.GetName(intColumn)]);
                                    decTotal += Reader.IsDBNull(intColumn) ? 0 : Convert.ToDecimal(Reader[intColumn]);
                                    dtSubTotalSecondGroup.Rows[0][Reader.GetName(intColumn)] = decTotal;
                                }
                            }
                            #endregion

                            #region Third : 3nd
                            //if (!string.IsNullOrEmpty(strThirdGroupBy) && !string.IsNullOrEmpty(strGroupByValue_3))
                            if ((strThirdGroupBy != null) && (strGroupByValue_3 != null))
                            {
                                if (dtSubTotalThirdGroup.Columns.Contains(Reader.GetName(intColumn)) && Convert.ToString(Reader[strThirdGroupBy]) == strGroupByValue_3)
                                {
                                    if (dtSubTotalThirdGroup.Rows.Count == 0)
                                    {
                                        dtSubTotalThirdGroup.Rows.Add(dtSubTotalThirdGroup.NewRow());
                                        foreach (DataColumn dcTotal in dtSubTotalThirdGroup.Columns)
                                            dtSubTotalThirdGroup.Rows[0][dcTotal] = 0;
                                    }
                                    decimal decTotal = 0;
                                    decTotal = Convert.ToDecimal(dtSubTotalThirdGroup.Rows[0][Reader.GetName(intColumn)]);
                                    decTotal += Reader.IsDBNull(intColumn) ? 0 : Convert.ToDecimal(Reader[intColumn]);
                                    dtSubTotalThirdGroup.Rows[0][Reader.GetName(intColumn)] = decTotal;
                                }
                            }
                            #endregion

                            #region Fourth : 4th
                            //if (!string.IsNullOrEmpty(strFourthGroupBy) && !string.IsNullOrEmpty(strGroupByValue_4))
                            if ((strFourthGroupBy != null) && (strGroupByValue_4 != null))
                            {
                                if (dtSubTotalFourthGroup.Columns.Contains(Reader.GetName(intColumn)) && Convert.ToString(Reader[strFourthGroupBy]) == strGroupByValue_4)
                                {
                                    if (dtSubTotalFourthGroup.Rows.Count == 0)
                                    {
                                        dtSubTotalFourthGroup.Rows.Add(dtSubTotalFourthGroup.NewRow());
                                        foreach (DataColumn dcTotal in dtSubTotalFourthGroup.Columns)
                                            dtSubTotalFourthGroup.Rows[0][dcTotal] = 0;
                                    }
                                    decimal decTotal = 0;
                                    decTotal = Convert.ToDecimal(dtSubTotalFourthGroup.Rows[0][Reader.GetName(intColumn)]);
                                    decTotal += Reader.IsDBNull(intColumn) ? 0 : Convert.ToDecimal(Reader[intColumn]);
                                    dtSubTotalFourthGroup.Rows[0][Reader.GetName(intColumn)] = decTotal;
                                }
                            }
                            #endregion

                            #region Fifth : 5th
                            //if (!string.IsNullOrEmpty(strFifthGroupBy) && !string.IsNullOrEmpty(strGroupByValue_5))
                            if ((strFifthGroupBy != null) && (strGroupByValue_5 != null))
                            {
                                if (dtSubTotalFifthGroup.Columns.Contains(Reader.GetName(intColumn)) && Convert.ToString(Reader[strFifthGroupBy]) == strGroupByValue_5)
                                {
                                    if (dtSubTotalFifthGroup.Rows.Count == 0)
                                    {
                                        dtSubTotalFifthGroup.Rows.Add(dtSubTotalFifthGroup.NewRow());
                                        foreach (DataColumn dcTotal in dtSubTotalFifthGroup.Columns)
                                            dtSubTotalFifthGroup.Rows[0][dcTotal] = 0;
                                    }
                                    decimal decTotal = 0;
                                    decTotal = Convert.ToDecimal(dtSubTotalFifthGroup.Rows[0][Reader.GetName(intColumn)]);
                                    decTotal += Reader.IsDBNull(intColumn) ? 0 : Convert.ToDecimal(Reader[intColumn]);
                                    dtSubTotalFifthGroup.Rows[0][Reader.GetName(intColumn)] = decTotal;
                                }
                            }
                            #endregion

                            #endregion
                            //Remove Group By Column
                            #region
                            if (strFirstGroupBy != Convert.ToString(dtSchema.Rows[intColumn]["ColumnName"]) && strSecGroupBy != Convert.ToString(dtSchema.Rows[intColumn]["ColumnName"]) && strThirdGroupBy != Convert.ToString(dtSchema.Rows[intColumn]["ColumnName"]) && strFourthGroupBy != Convert.ToString(dtSchema.Rows[intColumn]["ColumnName"]) && strFifthGroupBy != Convert.ToString(dtSchema.Rows[intColumn]["ColumnName"]))
                            {
                                strFormat = dtSchema.Rows[intColumn]["DataTypeName"].ToString();

                                if (strFormat == "decimal")
                                {
                                    // If dataType is Numeric but it is not Currency field.
                                    if (CheckISdisplayCurrencyFormat(dtSchema.Rows[intColumn][0].ToString()))
                                        sbRecord.Append("<td align='right' >&nbsp;" + string.Format("{0:c2}", Reader[intColumn]) + "</td>");
                                    else
                                        sbRecord.Append("<td align='right' >&nbsp;" + Convert.ToString(Reader[intColumn]) + "</td>");
                                }
                                else if (strFormat == "datetime")
                                {
                                    // it display only Time
                                    if (Convert.ToString(dtSchema.Rows[intColumn]["ColumnName"]) == "Time Theft Reported")
                                        sbRecord.Append("<td >&nbsp;" + string.Format("{0:HH:mm}", Reader[intColumn]) + "</td>");
                                    else sbRecord.Append("<td >&nbsp;" + string.Format("{0:MM/dd/yyyy}", Reader[intColumn]) + "</td>");
                                }
                                else
                                {

                                    //sbRecord.Append(@"<td style='mso-number-format:\@;'>&nbsp;" + Convert.ToString(Reader[intColumn]) + "</td>");
                                    sbRecord.Append(@"<td>&nbsp;" + Convert.ToString(Reader[intColumn]) + "</td>");
                                }
                            }
                            #endregion

                        }
                        #region "Grand Total"
                        for (int intColumn2 = 0; intColumn2 < Reader.FieldCount; intColumn2++)
                        {
                            //IF Grand Total Option is Selected and Have Field for SUM.
                            //if (Convert.ToString(ObjAdHocReport.GrandTotal) == "Y" && dtHeader.Columns.Count > 0)
                            //{
                            //    if (dtHeader.Columns.Contains(Reader.GetName(intColumn2)))
                            //    {
                            //        decimal decTotal = 0;
                            //        decTotal = Convert.ToDecimal(dtHeader.Rows[0][Reader.GetName(intColumn2)]);
                            //        decTotal += Reader.IsDBNull(intColumn2) ? 0 : Convert.ToDecimal(Reader[intColumn2]);
                            //        dtHeader.Rows[0][Reader.GetName(intColumn2)] = decTotal;
                            //    }
                            //}
                        }
                        #endregion
                        sbRecord.Append("</tr>");



                        using (StreamWriter sw = File.AppendText(strPath))
                        {
                            sw.Write(sbRecord);
                            sbRecord = new StringBuilder(string.Empty);
                        }
                    } while (Reader.Read());

                    #region " SUBTOAL FOR Last groups "
                    if (dtSubTotalFifthGroup.Rows.Count > 0)
                    {
                        sbRecord.Append("<tr>");
                        int intCol = 1;
                        if (dtSchema.Rows.Count > 0)
                            sbRecord.Append("<td align='left'><b>Sub Total For " + strFifthGroupBy + "</b></td>");
                        foreach (DataRow drSchema in dtSchema.Rows)
                        {
                            string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();
                            if (strFirstGroupBy != strColName && strSecGroupBy != strColName && strThirdGroupBy != strColName && strFourthGroupBy != strColName && strFifthGroupBy != strColName)
                            {
                                if (dtSubTotalFifthGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                                    sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalFifthGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                                else
                                {
                                    //if (intCol == 1)
                                    //    sbRecord.Append("<td align='left'><b>Sub Total For " + strFifthGroupBy + "</b></td>");
                                    //else
                                    //{

                                    sbRecord.Append("<td>&nbsp;</td>");
                                    //}
                                }
                            }
                            intCol++;
                        }
                        sbRecord.Append("</tr>");
                        dtSubTotalFifthGroup.Clear();
                    }
                    if (dtSubTotalFourthGroup.Rows.Count > 0)
                    {
                        sbRecord.Append("<tr>");
                        int intCol = 1;
                        if (dtSchema.Rows.Count > 0)
                            sbRecord.Append("<td align='left'><b>Sub Total For " + strFourthGroupBy + "</b></td>");
                        foreach (DataRow drSchema in dtSchema.Rows)
                        {
                            string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();
                            if (strFirstGroupBy != strColName && strSecGroupBy != strColName && strThirdGroupBy != strColName && strFourthGroupBy != strColName && strFifthGroupBy != strColName)
                            {
                                if (dtSubTotalFourthGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                                    sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalFourthGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                                else
                                {
                                    //if (intCol == 1)
                                    //    sbRecord.Append("<td align='left'><b>Sub Total For " + strFourthGroupBy + "</b></td>");
                                    //else
                                    //{

                                    sbRecord.Append("<td>&nbsp;</td>");
                                    //}
                                }
                            }
                            intCol++;
                        }
                        sbRecord.Append("</tr>");
                        dtSubTotalFourthGroup.Clear();
                    }
                    if (dtSubTotalThirdGroup.Rows.Count > 0)
                    {
                        sbRecord.Append("<tr>");
                        int intCol = 1;
                        if (dtSchema.Rows.Count > 0)
                            sbRecord.Append("<td align='left'><b>Sub Total For " + strThirdGroupBy + "</b></td>");
                        foreach (DataRow drSchema in dtSchema.Rows)
                        {
                            string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();
                            if (strFirstGroupBy != strColName && strSecGroupBy != strColName && strThirdGroupBy != strColName && strFourthGroupBy != strColName && strFifthGroupBy != strColName)
                            {
                                if (dtSubTotalThirdGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                                    sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalThirdGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                                else
                                {
                                    //if (intCol == 1)
                                    //    sbRecord.Append("<td align='left'><b>Sub Total For " + strThirdGroupBy + "</b></td>");
                                    //else
                                    //{

                                    sbRecord.Append("<td>&nbsp;</td>");
                                    //}
                                }
                            }
                            intCol++;
                        }
                        sbRecord.Append("</tr>");
                        dtSubTotalThirdGroup.Clear();
                    }
                    if (dtSubTotalSecondGroup.Rows.Count > 0)
                    {
                        sbRecord.Append("<tr>");
                        int intCol = 1;
                        if (dtSchema.Rows.Count > 0)
                            sbRecord.Append("<td align='left'><b>Sub Total For " + strSecGroupBy + "</b></td>");
                        foreach (DataRow drSchema in dtSchema.Rows)
                        {
                            string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();
                            if (strFirstGroupBy != strColName && strSecGroupBy != strColName && strThirdGroupBy != strColName && strFourthGroupBy != strColName && strFifthGroupBy != strColName)
                            {
                                if (dtSubTotalSecondGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                                    sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalSecondGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                                else
                                {
                                    //if (intCol == 1)
                                    //    sbRecord.Append("<td align='left'><b>Sub Total For " + strSecGroupBy + "</b></td>");
                                    //else
                                    //{
                                    sbRecord.Append("<td>&nbsp;</td>");
                                    //}
                                }
                            }
                            intCol++;
                        }
                        sbRecord.Append("</tr>");
                        dtSubTotalSecondGroup.Clear();
                    }
                    if (dtSubTotalFirstGroup.Rows.Count > 0)
                    {
                        sbRecord.Append("<tr>");
                        int intCol = 1;
                        if (dtSchema.Rows.Count > 0)
                            sbRecord.Append("<td align='left'><b>Sub Total For " + strFirstGroupBy + "</b></td>");
                        foreach (DataRow drSchema in dtSchema.Rows)
                        {
                            string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();
                            if (strFirstGroupBy != strColName && strSecGroupBy != strColName && strThirdGroupBy != strColName && strFourthGroupBy != strColName && strFifthGroupBy != strColName)
                            {
                                if (dtSubTotalFirstGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                                    sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalFirstGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                                else
                                {
                                    //if (intCol == 1)
                                    //    sbRecord.Append("<td align='left'><b>Sub Total For " + strFirstGroupBy + "</b></td>");
                                    //else
                                    //{
                                    sbRecord.Append("<td>&nbsp;</td>");
                                    // }
                                }
                            }
                            intCol++;
                        }
                        sbRecord.Append("</tr>");
                        dtSubTotalFirstGroup.Clear();
                    }

                    #endregion

                    #endregion

                    //Table End
                    sbRecord.Append("</table></td></tr>");


                    #region "Footer Template"
                    // IF Grand Total Option is Checked and Have record from Transaction Table to SUM
                    //if ((Convert.ToString(ObjAdHocReport.GrandTotal) == "Y") && dtHeader.Columns.Count > 0)
                    //{
                    //    sbRecord.Append("<tr><td colspan='3'>");
                    //    string strStyle = "'font-weight: bold;background-color: #507CD1;color: White;'";
                    //    sbRecord.Append("<br />");
                    //    sbRecord.Append("<table border='1' cellpadding='0' cellspacing='0'><tr align='right'>");
                    //    sbRecord.Append("<td style='font-weight: bold;' align='left'>Grand Totals</td>");

                    //    for (int intColumn = 0; intColumn < dtHeader.Columns.Count; intColumn++)
                    //        sbRecord.Append("<td style='font-weight: bold;'>" + Convert.ToString(dtHeader.Columns[intColumn]) + "</td>");
                    //    // show Header for claim count
                    //    // sbRecord.Append("<td style='font-weight: bold;'>" + Convert.ToString(dtHeader.Columns[0]) + "</td>");
                    //    sbRecord.Append("</tr>");

                    //    sbRecord.Append("<tr align='right'>");
                    //    sbRecord.Append("<td style=" + strStyle + ">&nbsp;</td>");

                    //    //No column Claim count 
                    //    for (int intColumn = 0; intColumn < dtHeader.Columns.Count; intColumn++)
                    //        sbRecord.Append("<td style=" + strStyle + ">" + string.Format("{0:c2}", dtHeader.Rows[0][intColumn]) + "</td>");
                    //    // show value for Claim Count
                    //    //sbRecord.Append("<td style=" + strStyle + ">" + dtHeader.Rows[0][dtHeader.Columns.Count - 1] + "</td>");
                    //    sbRecord.Append("</tr><table>");
                    //    sbRecord.Append("</td></tr>");
                    //}
                    #endregion
                    //Remove White Space.
                    //sbRecord.Replace("<tr></tr>", "");
                    sbRecord.Append("</table>");
                    using (StreamWriter sw = File.AppendText(strPath))
                    {
                        sw.Write(sbRecord);
                        sbRecord = new StringBuilder(string.Empty);
                    }
                }
                else
                {
                    //Remove WhiteSpace
                    sbRecord.Replace("<tr></tr>", "");
                    if (!Directory.Exists(AppDomain.CurrentDomain.BaseDirectory + @"temp\"))
                        Directory.CreateDirectory(AppDomain.CurrentDomain.BaseDirectory + @"temp\");

                    strPath = AppDomain.CurrentDomain.BaseDirectory + @"temp\" + strReportSchedulerName + System.DateTime.Now.ToString("MMddyyhhmmss") + ".xls";
                    ///When records are not found.
                    sbRecord.Append("<table  cellpadding='4' cellspacing='0' Width='100%'>");
                    sbRecord.Append("<tr>");
                    sbRecord.Append("<td align='center'>No Record found.</td></tr></table>");
                    using (StreamWriter sw = File.AppendText(strPath))
                    {
                        sw.Write(sbRecord);
                        sbRecord = new StringBuilder(string.Empty);
                    }
                }

                if (!Reader.IsClosed)
                    Reader.Close();

                return strPath;
            }
            catch (Exception ex)
            {
                //EventLog.WriteEntry("ERROR in Ad Hoc Report Writer , " + ex.Message);
                EventLog.WriteEntry("ERROR in ACI Ad Hoc Report Writer , " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
            finally
            {
                if (Reader != null)
                {
                    Reader.Close();
                    Reader.Dispose();
                }
                if (dtSchema != null)
                    dtSchema.Dispose();
                if (dtHeader != null)
                    dtHeader.Dispose();
            }
            return strPath;
        }


        /// <summary>
        /// Check This Header should be display in Currency format.
        /// </summary>
        /// <param name="strHeader"></param>
        /// <returns></returns>
        private bool CheckISdisplayCurrencyFormat(string strHeader)
        {
            //Array contains value have numeric field but should not display with $ sign,
            string strNumericField = "Location Code";
            string[] arrNumericField = strNumericField.Split(',');

            // if header is defined numeric filed it return false
            for (int intI = 0; intI < arrNumericField.Length; intI++)
            {
                if (strHeader == arrNumericField[intI])
                    return false;
            }
            return true;
        }

        /// <summary>
        /// Check Whether it is Grand TOtal FIeld or Not.
        /// </summary>
        /// <param name="strColumnName"></param>
        /// <returns></returns>
        private bool CheckTotalField(string strColumnName)
        {
            if ((strColumnName.Contains("PITO Cost") || strColumnName.Contains("Addon Cost") || strColumnName.Contains("Previous Appraisal BuildingValue") || strColumnName.Contains("Building Value")))
            {
                return true;
            }
            return false;
        }

        /// <summary>
        /// Bind and Return Where Condition
        /// </summary>
        /// <param name="lstFilter"></param>
        /// <returns></returns>
        private string GetWhereCondition(List<ERIMS_DAL.AdHocFilter> lstFilter)
        {
            string strWhere = string.Empty;
            for (int i = 0; i < lstFilter.Count; i++)
            {
                AdhocReportFields obj = new AdhocReportFields();
                List<AdhocReportFields> lstAdhoc = obj.GetAdHocReportFieldByPk(Convert.ToDecimal(lstFilter[i].FK_AdHocReportFields));
                string strConditionType = lstFilter[i].ConditionType;
                string strConditionValue = lstFilter[i].ConditionValue;
                string strField = lstAdhoc[0].WhereField;

                string strCntrolType = lstFilter[i].Fk_ControlType.ToString();

                if (lstFilter[i].Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.TextBox)
                {
                    strWhere += BindTextCondition(lstFilter[i].ConditionType, lstFilter[i].ConditionValue, lstAdhoc[0].Field_Name, lstAdhoc[0].Table_Name, Convert.ToBoolean(lstFilter[i].IsNotSelected));
                }
                else if (lstFilter[i].Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.MultiSelectList && lstFilter[i].ConditionValue != null)
                {
                    strWhere += BindDropDownCondition(lstFilter[i].ConditionType, lstFilter[i].ConditionValue, lstAdhoc[0].WhereField, lstAdhoc[0].Table_Name, Convert.ToBoolean(lstFilter[i].IsNotSelected));

                }
                else if (lstFilter[i].Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.DateControl)
                {
                    strWhere += BindDateCondition(lstFilter[i], lstAdhoc[0].Field_Name, lstAdhoc[0].Table_Name, Convert.ToBoolean(lstFilter[i].IsNotSelected));
                }
                else if (lstFilter[i].Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.AmountControl)
                {
                    strWhere += BindAmountCondition(lstFilter[i], lstFilter[i].ConditionType, lstFilter[i].ConditionValue, lstAdhoc[0].Field_Name, lstAdhoc[0].Table_Name, Convert.ToBoolean(lstFilter[i].IsNotSelected));
                }
            }
            return strWhere;
        }

        /// <summary>
        /// Bind and Return Where Condition
        /// </summary>
        /// <param name="lstFilter"></param>
        /// <returns></returns>
        private string GetWhereConditionForManagement(List<ERIMS_DAL.Management_AdHocFilter> lstFilter)
        {
            string strWhere = string.Empty;
            for (int i = 0; i < lstFilter.Count; i++)
            {
                Management_AdhocReportFields obj = new Management_AdhocReportFields();
                List<Management_AdhocReportFields> lstAdhoc = obj.GetAdHocReportFieldByPk(Convert.ToDecimal(lstFilter[i].FK_Management_AdhocReportFields));
                string strConditionType = lstFilter[i].ConditionType;
                string strConditionValue = lstFilter[i].ConditionValue;
                string strField = lstAdhoc[0].WhereField;

                string strCntrolType = lstFilter[i].Fk_ControlType.ToString();

                if (lstFilter[i].Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.TextBox)
                {
                    strWhere += BindTextCondition(lstFilter[i].ConditionType, lstFilter[i].ConditionValue, lstAdhoc[0].Field_Name, lstAdhoc[0].Table_Name, Convert.ToBoolean(lstFilter[i].IsNotSelected));
                }
                else if (lstFilter[i].Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.MultiSelectList && lstFilter[i].ConditionValue != null)
                {
                    strWhere += BindDropDownCondition(lstFilter[i].ConditionType, lstFilter[i].ConditionValue, lstAdhoc[0].WhereField, lstAdhoc[0].Table_Name, Convert.ToBoolean(lstFilter[i].IsNotSelected));

                }
                else if (lstFilter[i].Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.DateControl)
                {
                    strWhere += BindDateConditionForManagement(lstFilter[i], lstAdhoc[0].Field_Name, lstAdhoc[0].Table_Name, Convert.ToBoolean(lstFilter[i].IsNotSelected));
                }
                else if (lstFilter[i].Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.AmountControl)
                {
                    strWhere += BindAmountConditionForManagement(lstFilter[i], lstFilter[i].ConditionType, lstFilter[i].ConditionValue, lstAdhoc[0].Field_Name, lstAdhoc[0].Table_Name, Convert.ToBoolean(lstFilter[i].IsNotSelected));
                }
            }
            return strWhere;
        }

        /// <summary>
        /// Bind and Return Where Condition
        /// </summary>
        /// <param name="lstFilter"></param>
        /// <returns></returns>
        private string GetWhereConditionForSafetyTraining(List<ERIMS_DAL.Sonic_U_Train_AdHocFilter> lstFilter)
        {
            string strWhere = string.Empty;
            for (int i = 0; i < lstFilter.Count; i++)
            {
                Sonic_U_Train_AdhocReportFields obj = new Sonic_U_Train_AdhocReportFields();
                List<Sonic_U_Train_AdhocReportFields> lstAdhoc = obj.GetAdHocReportFieldByPk(Convert.ToDecimal(lstFilter[i].FK_AdHocReportFields));
                string strConditionType = lstFilter[i].ConditionType;
                string strConditionValue = lstFilter[i].ConditionValue;
                string strField = lstAdhoc[0].WhereField;

                string strCntrolType = lstFilter[i].Fk_ControlType.ToString();

                if (lstFilter[i].Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.TextBox)
                {
                    strWhere += BindTextCondition(lstFilter[i].ConditionType, lstFilter[i].ConditionValue, lstAdhoc[0].Field_Name, lstAdhoc[0].Table_Name, false);
                }
                else if (lstFilter[i].Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.MultiSelectList && lstFilter[i].ConditionValue != null)
                {
                    strWhere += BindDropDownCondition(lstFilter[i].ConditionType, lstFilter[i].ConditionValue, lstAdhoc[0].WhereField, lstAdhoc[0].Table_Name, false);

                }
                else if (lstFilter[i].Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.DateControl)
                {
                    strWhere += BindDateConditionForSafetyTraining(lstFilter[i], lstAdhoc[0].Field_Name, lstAdhoc[0].Table_Name, false);
                }
                else if (lstFilter[i].Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.AmountControl)
                {
                    strWhere += BindAmountConditionForSafetyTraining(lstFilter[i], lstFilter[i].ConditionType, lstFilter[i].ConditionValue, lstAdhoc[0].Field_Name, lstAdhoc[0].Table_Name, false);
                }
            }
            return strWhere;
        }

        /// <summary>
        /// Bind and Return TextBox Type Condition
        /// </summary>
        /// <param name="lstFilter"></param>
        /// <returns></returns>
        private string BindTextCondition(string strConditionType, string strConditionValue, string strField, string strTableName, bool IsNotSelected)
        {
            string strWhere = string.Empty;

            if (!string.IsNullOrEmpty(strConditionValue))
            {
                if (strField.Contains("Date_Theft_Reported"))
                    strWhere = " And (CONVERT(VARCHAR," + strField + " ,108))";
                else strWhere = " And [" + strTableName + "]." + strField;

                if (IsNotSelected == true)
                {
                    if (strConditionType == "1")
                        strWhere += " NOT LIKE  '%" + strConditionValue.Trim().Replace("'", "''") + "%' ";
                    else if (strConditionType == "2")
                        strWhere += " NOT LIKE '" + strConditionValue.Trim().Replace("'", "''") + "%'";
                    else if (strConditionType == "3")
                        strWhere += " NOT LIKE '%" + strConditionValue.Trim().Replace("'", "''") + "'";
                }
                else
                {
                    if (strConditionType == "1")
                        strWhere += " LIKE  '%" + strConditionValue.Trim().Replace("'", "''") + "%' ";
                    else if (strConditionType == "2")
                        strWhere += " LIKE '" + strConditionValue.Trim().Replace("'", "''") + "%'";
                    else if (strConditionType == "3")
                        strWhere += " LIKE '%" + strConditionValue.Trim().Replace("'", "''") + "'";
                }
            }
            return strWhere;
        }


        /// <summary>
        /// Bind and Return Dropdown Type Condition
        /// </summary>
        /// <param name="lstFilter"></param>
        /// <returns></returns>
        private string BindDropDownCondition(string strConditionType, string strConditionValue, string strField, string strTableName, bool IsNotSelected)
        {
            //string strNewList = string.Empty;
            string strWhere = string.Empty;
            //string[] arrwhere = strConditionValue.Split(',');

            if (!string.IsNullOrEmpty(strField) && !string.IsNullOrEmpty(strConditionValue))
            {
                //if (IsNotSelected == true)
                //    strWhere = " And " + strTableName + ".[" + strField + "] NOT IN (" + strConditionValue + ")";
                //else
                //    strWhere = " And " + strTableName + ".[" + strField + "] IN (" + strConditionValue + ")";
                if (IsNotSelected == true)
                {
                    if (strConditionValue.Trim().ToUpper() == "Y" || strConditionValue.Trim().ToUpper() == "N" || strConditionValue.Trim().ToUpper() == "Y,N" || strConditionValue.Trim().ToUpper() == "EXTERIOR" || strConditionValue.Trim().ToUpper() == "INTERIOR" || strConditionValue.Trim().ToUpper() == "EXTERIOR,INTERIOR")
                    {
                        if (strField == "Is_Actionable" || strField == "Video_Requested_By_Sonic")
                            strWhere = " And ISNULL([" + strTableName + "]." + strField + ",'N') NOT IN ('" + strConditionValue.Replace(",", "','") + "') ";
                        else
                            strWhere = " And " + strTableName + ".[" + strField + "] NOT IN ('" + strConditionValue.Replace(",", "','") + "') ";
                    }
                    else if (strField == "PK_LU_Approval_Submission" && strConditionValue == "0")
                        strWhere = " And " + strTableName + ".[" + strField + "] IS NOT NULL ";
                    else if (strField == "PK_LU_Approval_Submission" && strConditionValue.Contains("0"))
                        strWhere = " And (" + strTableName + ".[" + strField + "] IS NOT NULL " + " AND " + strTableName + ".[" + strField + "] NOT IN (" + strConditionValue + ") )";
                    else if (strField == "PK_LU_Approval_Submission" && !strConditionValue.Contains("0"))
                        strWhere = " And (" + strTableName + ".[" + strField + "] IS NULL " + " OR " + strTableName + ".[" + strField + "] NOT IN (" + strConditionValue + ") )";
                    else
                        strWhere = " And " + strTableName + ".[" + strField + "] NOT IN (" + strConditionValue + ") ";
                }
                else if (strConditionValue.Trim().ToUpper() == "Y" || strConditionValue.Trim().ToUpper() == "N" || strConditionValue.Trim().ToUpper() == "Y,N" || strConditionValue.Trim().ToUpper() == "O" || strConditionValue.Trim().ToUpper() == "C" || strConditionValue.Trim().ToUpper() == "O,C" || strConditionValue.Trim().ToUpper() == "C,O"
                     || strConditionValue.Trim().ToUpper() == "EXTERIOR" || strConditionValue.Trim().ToUpper() == "INTERIOR" || strConditionValue.Trim().ToUpper() == "EXTERIOR,INTERIOR")
                {
                    if (strField == "Is_Actionable" || strField == "Video_Requested_By_Sonic")
                        strWhere = " And ISNULL([" + strTableName + "]." + strField + ",'N') IN ('" + strConditionValue.Replace(",", "','") + "') ";
                    else
                        strWhere = " And " + strTableName + ".[" + strField + "] IN ('" + strConditionValue.Replace(",", "','") + "') ";
                }
                else if (strField == "PK_LU_Approval_Submission" && strConditionValue == "0")
                    strWhere = " And " + strTableName + ".[" + strField + "] IS NULL ";
                //else if (strField == "Completed")
                //    strWhere = " And ( CASE WHEN ( MTD.Pk_Manage_Training_Data IS NULL AND TD.Completed = 0 ) THEN '1' WHEN ( MTD.Pk_Manage_Training_Data IS NULL AND TD.Completed = 1 ) THEN '0' ELSE '2' END ) IN (" + strConditionValue + ") ";
                else
                    strWhere = " And " + strTableName + ".[" + strField + "] IN (" + strConditionValue + ") ";
            }
            return strWhere;
        }


        /// <summary>
        /// Bind and Return DateTime Type Condition
        /// </summary>
        /// <param name="lstFilter"></param>
        /// <returns></returns>
        private string BindDateCondition(ERIMS_DAL.AdHocFilter objFilter, string strField, string strTableName, bool IsNotSelected)
        {
            string strWhere = string.Empty;

            DateTime? dtFrom = null, dtTo = null;

            if (string.IsNullOrEmpty(objFilter.FromRelativeCriteria))
                dtFrom = FormatNullDateToStore(Convert.ToString(objFilter.FromDate));
            else
            {
                // set Relative Date From criteria
                AdHocReportHelper.RaltiveDates RelType = (AdHocReportHelper.RaltiveDates)Enum.Parse(typeof(AdHocReportHelper.RaltiveDates), objFilter.FromRelativeCriteria);
                dtFrom = AdHocReportHelper.GetRelativeDate(RelType);
            }
            if (string.IsNullOrEmpty(objFilter.ToRelativeCriteria))
                dtTo = FormatNullDateToStore(Convert.ToString(objFilter.ToDate));
            else
            {
                // set Relative Date To criteria
                AdHocReportHelper.RaltiveDates RelType = (AdHocReportHelper.RaltiveDates)Enum.Parse(typeof(AdHocReportHelper.RaltiveDates), objFilter.ToRelativeCriteria);
                dtTo = AdHocReportHelper.GetRelativeDate(RelType);
            }

            AdHocReportHelper.DateCriteria DtType = AdHocReportHelper.DateCriteria.On;

            if (objFilter.ConditionType == "On")
                DtType = AdHocReportHelper.DateCriteria.On;
            else if (objFilter.ConditionType == "BF")
                DtType = AdHocReportHelper.DateCriteria.Before;
            else if (objFilter.ConditionType == "A")
                DtType = AdHocReportHelper.DateCriteria.After;
            else if (objFilter.ConditionType == "B")
                DtType = AdHocReportHelper.DateCriteria.Between;

            if (dtFrom.HasValue)
                strWhere = AdHocReportHelper.GetDateWhereAbsolute(strTableName + ".[" + strField + "]", dtFrom, dtTo, DtType, IsNotSelected);

            else if (dtTo.HasValue)
                strWhere = AdHocReportHelper.GetDateWhereAbsolute(strTableName + ".[" + strField + "]", dtFrom, dtTo, DtType, IsNotSelected);
            return strWhere;
        }

        /// <summary>
        /// Bind and Return DateTime Type Condition
        /// </summary>
        /// <param name="lstFilter"></param>
        /// <returns></returns>
        private string BindDateConditionForManagement(ERIMS_DAL.Management_AdHocFilter objFilter, string strField, string strTableName, bool IsNotSelected)
        {
            string strWhere = string.Empty;

            DateTime? dtFrom = null, dtTo = null;

            if (string.IsNullOrEmpty(objFilter.FromRelativeCriteria))
                dtFrom = FormatNullDateToStore(Convert.ToString(objFilter.FromDate));
            else
            {
                // set Relative Date From criteria
                AdHocReportHelper.RaltiveDates RelType = (AdHocReportHelper.RaltiveDates)Enum.Parse(typeof(AdHocReportHelper.RaltiveDates), objFilter.FromRelativeCriteria);
                dtFrom = AdHocReportHelper.GetRelativeDate(RelType);
            }
            if (string.IsNullOrEmpty(objFilter.ToRelativeCriteria))
                dtTo = FormatNullDateToStore(Convert.ToString(objFilter.ToDate));
            else
            {
                // set Relative Date To criteria
                AdHocReportHelper.RaltiveDates RelType = (AdHocReportHelper.RaltiveDates)Enum.Parse(typeof(AdHocReportHelper.RaltiveDates), objFilter.ToRelativeCriteria);
                dtTo = AdHocReportHelper.GetRelativeDate(RelType);
            }

            AdHocReportHelper.DateCriteria DtType = AdHocReportHelper.DateCriteria.On;

            if (objFilter.ConditionType == "On")
                DtType = AdHocReportHelper.DateCriteria.On;
            else if (objFilter.ConditionType == "BF")
                DtType = AdHocReportHelper.DateCriteria.Before;
            else if (objFilter.ConditionType == "A")
                DtType = AdHocReportHelper.DateCriteria.After;
            else if (objFilter.ConditionType == "B")
                DtType = AdHocReportHelper.DateCriteria.Between;
            else if (objFilter.ConditionType == "IN")
            {
                DtType = AdHocReportHelper.DateCriteria.Is_Null;
                dtFrom = null;
                dtTo = null;

                if (IsNotSelected)
                    strWhere = " AND " + strTableName + ".[" + strField + "]" + " IS NOT NULL";
                else
                    strWhere = " AND " + strTableName + ".[" + strField + "]" + " IS NULL";
            }

            if (dtFrom.HasValue)
                strWhere = AdHocReportHelper.GetDateWhereAbsolute(strTableName + ".[" + strField + "]", dtFrom, dtTo, DtType, IsNotSelected);

            else if (dtTo.HasValue)
                strWhere = AdHocReportHelper.GetDateWhereAbsolute(strTableName + ".[" + strField + "]", dtFrom, dtTo, DtType, IsNotSelected);
            return strWhere;
        }

        /// <summary>
        /// Bind and Return DateTime Type Condition
        /// </summary>
        /// <param name="lstFilter"></param>
        /// <returns></returns>
        private string BindDateConditionForSafetyTraining(ERIMS_DAL.Sonic_U_Train_AdHocFilter objFilter, string strField, string strTableName, bool IsNotSelected)
        {
            string strWhere = string.Empty;

            DateTime? dtFrom = null, dtTo = null;

            if (string.IsNullOrEmpty(objFilter.FromRelativeCriteria))
                dtFrom = FormatNullDateToStore(Convert.ToString(objFilter.FromDate));
            else
            {
                // set Relative Date From criteria
                AdHocReportHelper.RaltiveDates RelType = (AdHocReportHelper.RaltiveDates)Enum.Parse(typeof(AdHocReportHelper.RaltiveDates), objFilter.FromRelativeCriteria);
                dtFrom = AdHocReportHelper.GetRelativeDate(RelType);
            }
            if (string.IsNullOrEmpty(objFilter.ToRelativeCriteria))
                dtTo = FormatNullDateToStore(Convert.ToString(objFilter.ToDate));
            else
            {
                // set Relative Date To criteria
                AdHocReportHelper.RaltiveDates RelType = (AdHocReportHelper.RaltiveDates)Enum.Parse(typeof(AdHocReportHelper.RaltiveDates), objFilter.ToRelativeCriteria);
                dtTo = AdHocReportHelper.GetRelativeDate(RelType);
            }

            AdHocReportHelper.DateCriteria DtType = AdHocReportHelper.DateCriteria.On;

            if (objFilter.ConditionType == "On")
                DtType = AdHocReportHelper.DateCriteria.On;
            else if (objFilter.ConditionType == "BF")
                DtType = AdHocReportHelper.DateCriteria.Before;
            else if (objFilter.ConditionType == "A")
                DtType = AdHocReportHelper.DateCriteria.After;
            else if (objFilter.ConditionType == "B")
                DtType = AdHocReportHelper.DateCriteria.Between;
            else if (objFilter.ConditionType == "IN")
            {
                DtType = AdHocReportHelper.DateCriteria.Is_Null;
                dtFrom = null;
                dtTo = null;

                if (IsNotSelected)
                    strWhere = " AND " + strTableName + ".[" + strField + "]" + " IS NOT NULL";
                else
                    strWhere = " AND " + strTableName + ".[" + strField + "]" + " IS NULL";
            }

            if (dtFrom.HasValue)
                strWhere = AdHocReportHelper.GetDateWhereAbsolute(strTableName + ".[" + strField.Replace("[","").Replace("]","") + "]", dtFrom, dtTo, DtType, IsNotSelected);

            else if (dtTo.HasValue)
                strWhere = AdHocReportHelper.GetDateWhereAbsolute(strTableName + ".[" + strField.Replace("[", "").Replace("]", "") + "]", dtFrom, dtTo, DtType, IsNotSelected);
            return strWhere;
        }

        /// <summary>
        /// Bind and Return Amount Type Condition
        /// </summary>
        /// <param name="lstFilter"></param>
        /// <returns></returns>
        private string BindAmountCondition(ERIMS_DAL.AdHocFilter objFilter, string strConditionType, string strConditionValue, string strField, string strTableName, bool IsNotSelected)
        {
            string strWhere = string.Empty;
            AdHocReportHelper.AmountCriteria AmtType = AdHocReportHelper.AmountCriteria.Equal;

            decimal? dFrom = null;
            decimal? dTo = null;

            if (!string.IsNullOrEmpty(Convert.ToString(objFilter.AmountFrom)))
                dFrom = Convert.ToDecimal(objFilter.AmountFrom);

            if (!string.IsNullOrEmpty(Convert.ToString(objFilter.AmountTo)))
                dTo = Convert.ToDecimal(objFilter.AmountTo);

            if (Convert.ToInt16(objFilter.ConditionType) == (int)AdHocReportHelper.AmountCriteria.Equal)
                AmtType = AdHocReportHelper.AmountCriteria.Equal;
            else if (Convert.ToInt16(objFilter.ConditionType) == (int)AdHocReportHelper.AmountCriteria.GreaterThan)
                AmtType = AdHocReportHelper.AmountCriteria.GreaterThan;
            else if (Convert.ToInt16(objFilter.ConditionType) == (int)AdHocReportHelper.AmountCriteria.Between)
                AmtType = AdHocReportHelper.AmountCriteria.Between;
            else if (Convert.ToInt16(objFilter.ConditionType) == (int)AdHocReportHelper.AmountCriteria.LessThan)
                AmtType = AdHocReportHelper.AmountCriteria.LessThan;

            if (dFrom.HasValue)
                strWhere = AdHocReportHelper.GetAmountWhere("[" + strTableName.Trim() + "]" + "." + "[" + strField.Trim() + "]", dFrom, dTo, AmtType, IsNotSelected);
            else if (dTo.HasValue)
                strWhere = AdHocReportHelper.GetAmountWhere("[" + strTableName.Trim() + "]", dFrom, dTo, AmtType, IsNotSelected);

            return strWhere;
        }

        /// <summary>
        /// Bind and Return Amount Type Condition
        /// </summary>
        /// <param name="lstFilter"></param>
        /// <returns></returns>
        private string BindAmountConditionForManagement(ERIMS_DAL.Management_AdHocFilter objFilter, string strConditionType, string strConditionValue, string strField, string strTableName, bool IsNotSelected)
        {
            string strWhere = string.Empty;
            AdHocReportHelper.AmountCriteria AmtType = AdHocReportHelper.AmountCriteria.Equal;

            decimal? dFrom = null;
            decimal? dTo = null;

            if (!string.IsNullOrEmpty(Convert.ToString(objFilter.AmountFrom)))
                dFrom = Convert.ToDecimal(objFilter.AmountFrom);

            if (!string.IsNullOrEmpty(Convert.ToString(objFilter.AmountTo)))
                dTo = Convert.ToDecimal(objFilter.AmountTo);

            if (Convert.ToInt16(objFilter.ConditionType) == (int)AdHocReportHelper.AmountCriteria.Equal)
                AmtType = AdHocReportHelper.AmountCriteria.Equal;
            else if (Convert.ToInt16(objFilter.ConditionType) == (int)AdHocReportHelper.AmountCriteria.GreaterThan)
                AmtType = AdHocReportHelper.AmountCriteria.GreaterThan;
            else if (Convert.ToInt16(objFilter.ConditionType) == (int)AdHocReportHelper.AmountCriteria.Between)
                AmtType = AdHocReportHelper.AmountCriteria.Between;
            else if (Convert.ToInt16(objFilter.ConditionType) == (int)AdHocReportHelper.AmountCriteria.LessThan)
                AmtType = AdHocReportHelper.AmountCriteria.LessThan;

            if (dFrom.HasValue)
                strWhere = AdHocReportHelper.GetAmountWhere("[" + strTableName.Trim() + "]" + "." + "[" + strField.Trim() + "]", dFrom, dTo, AmtType, IsNotSelected);
            else if (dTo.HasValue)
                strWhere = AdHocReportHelper.GetAmountWhere("[" + strTableName.Trim() + "]", dFrom, dTo, AmtType, IsNotSelected);

            return strWhere;
        }

        /// <summary>
        /// Bind and Return Amount Type Condition
        /// </summary>
        /// <param name="lstFilter"></param>
        /// <returns></returns>
        private string BindAmountConditionForSafetyTraining(ERIMS_DAL.Sonic_U_Train_AdHocFilter objFilter, string strConditionType, string strConditionValue, string strField, string strTableName, bool IsNotSelected)
        {
            string strWhere = string.Empty;
            AdHocReportHelper.AmountCriteria AmtType = AdHocReportHelper.AmountCriteria.Equal;

            decimal? dFrom = null;
            decimal? dTo = null;

            if (!string.IsNullOrEmpty(Convert.ToString(objFilter.AmountFrom)))
                dFrom = Convert.ToDecimal(objFilter.AmountFrom);

            if (!string.IsNullOrEmpty(Convert.ToString(objFilter.AmountTo)))
                dTo = Convert.ToDecimal(objFilter.AmountTo);

            if (Convert.ToInt16(objFilter.ConditionType) == (int)AdHocReportHelper.AmountCriteria.Equal)
                AmtType = AdHocReportHelper.AmountCriteria.Equal;
            else if (Convert.ToInt16(objFilter.ConditionType) == (int)AdHocReportHelper.AmountCriteria.GreaterThan)
                AmtType = AdHocReportHelper.AmountCriteria.GreaterThan;
            else if (Convert.ToInt16(objFilter.ConditionType) == (int)AdHocReportHelper.AmountCriteria.Between)
                AmtType = AdHocReportHelper.AmountCriteria.Between;
            else if (Convert.ToInt16(objFilter.ConditionType) == (int)AdHocReportHelper.AmountCriteria.LessThan)
                AmtType = AdHocReportHelper.AmountCriteria.LessThan;

            if (dFrom.HasValue)
                strWhere = AdHocReportHelper.GetAmountWhere("[" + strTableName.Trim() + "]" + "." + "[" + strField.Trim() + "]", dFrom, dTo, AmtType, IsNotSelected);
            else if (dTo.HasValue)
                strWhere = AdHocReportHelper.GetAmountWhere("[" + strTableName.Trim() + "]", dFrom, dTo, AmtType, IsNotSelected);

            return strWhere;
        }


        #region "Generate Sub Row by group by"

        /// <summary>
        /// Generates HTML text for report rows
        /// </summary>
        /// <param name="sbRecorords"></param>
        /// <param name="dvReCoverage"></param>
        /// <param name="strOperatingCompany"></param>
        /// <returns></returns>
        //private StringBuilder GenerateReportRowsPoinInTIme(StringBuilder sbRecorords, DataView dvReCoverage, string strOperatingCompany)
        //{
        //    for (int introws = 0; introws < dvReCoverage.Count; introws++)
        //    {
        //        int intRes;
        //        int intDiv = System.Math.DivRem(introws, 2, out intRes);
        //        string strRowStyle = "font-size:8pt;font-family:Tahoma;";
        //        string strAltRowStyle = "font-size:8pt;background-color:#EAEAEA;font-family:Tahoma;";

        //        sbRecorords.Append("<tr   align='right' style='" + ((intRes == 0) ? strRowStyle : strAltRowStyle) + "' >");
        //        sbRecorords.Append("<td class='cols_'  width='40%' align='left'>" + Convert.ToString(dvReCoverage[introws]["CLAIM_NUMBER"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'  width='10%' align='left'>" + FormatDBNullDateToDisplay(dvReCoverage[introws]["Loss_DateTime"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'   width='10%'>Incurred:  </td>");
        //        sbRecorords.Append("<td class='cols_'   width='10%'>" + string.Format("{0:c2}", dvReCoverage[introws]["InccuredAmt1"]) + " </td>");
        //        sbRecorords.Append("<td class='cols_'   width='10%'>" + string.Format("{0:c2}", dvReCoverage[introws]["InccuredAmt2"]) + "  </td>");
        //        sbRecorords.Append("<td class='cols_'   width='10%'  >" + string.Format("{0:c2}", dvReCoverage[introws]["InccuredDiff"]) + " </td>");
        //        sbRecorords.Append("<td class='cols_'   width='10%'  >" + string.Format("{0:N2}", dvReCoverage[introws]["InccuredDiffPer"]) + " </td>");
        //        sbRecorords.Append("</tr>");

        //        sbRecorords.Append("<tr align='right' style='" + ((intRes == 0) ? strRowStyle : strAltRowStyle) + "' >");
        //        sbRecorords.Append("<td class='cols_'  width='40%' align='left'>" + Convert.ToString(dvReCoverage[introws]["CLAIMANT_NAME"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'  width='10%' align='left'>" + Convert.ToString(dvReCoverage[introws]["FK_LU_Status"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'   width='10%'>Paid:  </td>");
        //        sbRecorords.Append("<td class='cols_'   width='10%'>" + string.Format("{0:c2}", dvReCoverage[introws]["PaidAmt1"]) + " </td>");
        //        sbRecorords.Append("<td class='cols_'   width='10%'>" + string.Format("{0:c2}", dvReCoverage[introws]["PaidAmt2"]) + "  </td>");
        //        sbRecorords.Append("<td class='cols_'   width='10%'  >" + string.Format("{0:c2}", dvReCoverage[introws]["PaidDiff"]) + " </td>");
        //        sbRecorords.Append("<td class='cols_'   width='10%'  >" + string.Format("{0:N2}", dvReCoverage[introws]["PaidDiffPer"]) + " </td>");
        //        sbRecorords.Append("</tr>");

        //        sbRecorords.Append("<tr  valign='top' align='right'  style='" + ((intRes == 0) ? strRowStyle : strAltRowStyle) + "'>");
        //        sbRecorords.Append("<td  style='border-bottom: #EAEAEA 1px solid' class='cols_' width='40%' align='left'>" + Convert.ToString(dvReCoverage[introws]["Claim_Description"]) + "&nbsp;</td>");
        //        sbRecorords.Append("<td  style='border-bottom: #EAEAEA 1px solid' class='cols_' width='10%' align='left'>" + Convert.ToString(dvReCoverage[introws]["FK_LU_Coverage"]) + "&nbsp;</td>");
        //        sbRecorords.Append("<td style='border-bottom: #EAEAEA 1px solid' class='cols_' width='10%'>Outstanding:  </td>");
        //        sbRecorords.Append("<td style='border-bottom: #EAEAEA 1px solid' class='cols_' width='10%'>" + string.Format("{0:c2}", dvReCoverage[introws]["OUTSTANDING1"]) + " </td>");
        //        sbRecorords.Append("<td style='border-bottom: #EAEAEA 1px solid' class='cols_' width='10%'>" + string.Format("{0:c2}", dvReCoverage[introws]["OUTSTANDING2"]) + "  </td>");
        //        sbRecorords.Append("<td style='border-bottom: #EAEAEA 1px solid' class='cols_' width='10%'>" + string.Format("{0:c2}", dvReCoverage[introws]["OUTSTANDINGDiff"]) + " </td>");//Diffrence Plz Change
        //        sbRecorords.Append("<td style='border-bottom: #EAEAEA 1px solid' class='cols_' width='10%'>" + string.Format("{0:N2}", dvReCoverage[introws]["OutstandingDiffPer"]) + " </td>");//Diffrence Plz Change
        //        sbRecorords.Append("</tr>");
        //    }
        //    return sbRecorords;
        //}

        /// <summary>
        /// Get Html Row
        /// </summary>
        /// <param name="sbRecorords"></param>
        /// <param name="dtRecords_Payment"></param>
        /// <param name="strFirstGroupBy"></param>
        /// <param name="strSecondGroupBy"></param>
        /// <returns></returns>
        //private StringBuilder GenerateReportRows(StringBuilder sbRecorords, DataTable dtRecords_Payment, string strFirstGroupBy, string strSecondGroupBy)
        //{
        //    string strFilter = "";
        //    if (!string.IsNullOrEmpty(strSecondGroupBy))
        //        strFilter = string.Format("FirstGroupBy = '{0}' and  SecondGroupBy = '{1}' ", strFirstGroupBy, strSecondGroupBy);
        //    else
        //        strFilter = string.Format("FirstGroupBy = '{0}'", strFirstGroupBy);

        //    // Find Incurred Amount transaction record
        //    DataRow[] drRecords_Payment = dtRecords_Payment.Select(strFilter + " And PaymentDetail ='Incurred'");

        //    if (drRecords_Payment.Length > 0)
        //    {
        //        sbRecorords.Append("<tr  align='right'>");

        //        sbRecorords.Append("<td class='cols_'  align='left'>Incurred</td>");
        //        sbRecorords.Append("<td class='cols_' >" + string.Format("{0:C}", drRecords_Payment[0]["Med_BI_Comp"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_' >" + string.Format("{0:C}", drRecords_Payment[0]["Expense"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_' >" + string.Format("{0:C}", drRecords_Payment[0]["Ind_Pd_Coll"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_' >" + string.Format("{0:C}", drRecords_Payment[0]["Legal"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_' >" + string.Format("{0:C}", drRecords_Payment[0]["Other"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_' >" + string.Format("{0:C}", drRecords_Payment[0]["Total"]) + "</td>");
        //        if (!string.IsNullOrEmpty(strSecondGroupBy))
        //            sbRecorords.Append("<td class='cols_' >&nbsp;</td>");
        //        else
        //            sbRecorords.Append("<td class='cols_' style='font-weight: bold;'  align='center' >" + string.Format("{0:N0}", drRecords_Payment[0]["Claim_Count"]) + "</td>");
        //        sbRecorords.Append("</tr>");

        //    }

        //    // Find paid Amount transaction record
        //    drRecords_Payment = dtRecords_Payment.Select(strFilter + " And PaymentDetail ='Paid'");
        //    if (drRecords_Payment.Length > 0)
        //    {
        //        sbRecorords.Append("<tr  align='right'>");

        //        sbRecorords.Append("<td class='cols_'  align='left'>Paid</td>");
        //        sbRecorords.Append("<td class='cols_' >" + string.Format("{0:C}", drRecords_Payment[0]["Med_BI_Comp"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_' >" + string.Format("{0:C}", drRecords_Payment[0]["Expense"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_' >" + string.Format("{0:C}", drRecords_Payment[0]["Ind_Pd_Coll"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_' >" + string.Format("{0:C}", drRecords_Payment[0]["Legal"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_' >" + string.Format("{0:C}", drRecords_Payment[0]["Other"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_' >" + string.Format("{0:C}", drRecords_Payment[0]["Total"]) + "</td>");//Total Need to be Change
        //        sbRecorords.Append("<td class='cols_' >&nbsp;</td>");

        //        sbRecorords.Append("</tr>");

        //    }

        //    // Find Total Outstanding Amount transaction record
        //    drRecords_Payment = dtRecords_Payment.Select(strFilter + " And PaymentDetail ='TOutStanding'");
        //    if (drRecords_Payment.Length > 0)
        //    {
        //        sbRecorords.Append("<tr  align='right'>");

        //        sbRecorords.Append("<td class='cols_'  align='left'>Outstanding</td>");
        //        sbRecorords.Append("<td class='cols_' >" + string.Format("{0:C}", drRecords_Payment[0]["Med_BI_Comp"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_' >" + string.Format("{0:C}", drRecords_Payment[0]["Expense"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_' >" + string.Format("{0:C}", drRecords_Payment[0]["Ind_Pd_Coll"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_' >" + string.Format("{0:C}", drRecords_Payment[0]["Legal"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_' >" + string.Format("{0:C}", drRecords_Payment[0]["Other"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_' >" + string.Format("{0:C}", drRecords_Payment[0]["Total"]) + "</td>");//Total Need to be Change
        //        sbRecorords.Append("<td class='cols_' >&nbsp;</td>");
        //        sbRecorords.Append("</tr>");

        //    }
        //    return sbRecorords;
        //}

        /// <summary>
        /// Generate Sub Row for Three Line Claim Detail Report
        /// </summary>
        /// <param name="sbRecorords"></param>
        /// <param name="dtRecords_Payment"></param>
        /// <param name="strFirstGroupBy"></param>
        /// <param name="strSecondGroupBy"></param>
        /// <returns></returns>
        //private StringBuilder GenerateReportRowsForThreeLine(StringBuilder sbRecorords, DataTable dtRecords_Payment, string strFirstGroupBy, string strSecondGroupBy)
        //{
        //    string strFilter = "";
        //    if (!string.IsNullOrEmpty(strSecondGroupBy))
        //        strFilter = string.Format("FirstGroupBy = '{0}' and  SecondGroupBy = '{1}' ", strFirstGroupBy, strSecondGroupBy);
        //    else
        //        strFilter = string.Format("FirstGroupBy = '{0}'", strFirstGroupBy);

        //    DataRow[] drRecords_Payment = dtRecords_Payment.Select(strFilter);
        //    for (int intI4 = 0; intI4 < drRecords_Payment.Length; intI4++)
        //    {
        //        int intRes;
        //        int intDiv = System.Math.DivRem(intI4, 2, out intRes);
        //        string strRowStyle = "font-size:8pt;font-family:Tahoma;";
        //        string strAltRowStyle = "font-size:8pt;background-color:#EAEAEA;font-family:Tahoma;";

        //        sbRecorords.Append("<tr  align='right' style='" + ((intRes == 0) ? strRowStyle : strAltRowStyle) + "'>");
        //        sbRecorords.Append("<td class='cols_'  align='left' valign='top'>" + Convert.ToString(drRecords_Payment[intI4]["Claim_Number"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'  align='left' valign='top'>" + Convert.ToString(drRecords_Payment[intI4]["Driver_Claimant_Name"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'  colspan='8' align='left' valign='top'>" + Convert.ToString(drRecords_Payment[intI4]["Coverage"]) + "</td>");
        //        sbRecorords.Append("</tr>");

        //        sbRecorords.Append("<tr  align='right' style='" + ((intRes == 0) ? strRowStyle : strAltRowStyle) + "'>");
        //        sbRecorords.Append("<td class='cols_'  align='left' valign='top'>" + Convert.ToString(drRecords_Payment[intI4]["OperatingCompanies"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'  align='left' valign='top'>" + string.Format("{0:MM/dd/yyyy}", drRecords_Payment[intI4]["Loss_DateTime"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'  align='left' valign='top'>" + string.Format("{0:MM/dd/yyyy}", drRecords_Payment[intI4]["Report_Date"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'  align='left' valign='top'>" + Convert.ToString(drRecords_Payment[intI4]["Statuses"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'  align='right' valign='top'>" + string.Format("{0:C}", drRecords_Payment[intI4]["INC_Med_BI_Comp"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'  align='right' valign='top'>" + string.Format("{0:C}", drRecords_Payment[intI4]["Inc_Expense"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'  align='right' valign='top'>" + string.Format("{0:C}", drRecords_Payment[intI4]["INC_Ind_PD_Coll"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'  align='right' valign='top'>" + string.Format("{0:C}", drRecords_Payment[intI4]["INC_Legal"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'  align='right' valign='top'>" + string.Format("{0:C}", drRecords_Payment[intI4]["INC_Other"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'  align='right' valign='top'>" + string.Format("{0:C}", drRecords_Payment[intI4]["TotalIncurred"]) + "</td>");
        //        sbRecorords.Append("</tr>");

        //        sbRecorords.Append("<tr  align='right' style='" + ((intRes == 0) ? strRowStyle : strAltRowStyle) + "'>");
        //        sbRecorords.Append("<td class='cols_'  align='left' valign='top'>" + Convert.ToString(drRecords_Payment[intI4]["Claim_Description"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'  align='left' valign='top'>" + Convert.ToString(drRecords_Payment[intI4]["Causes"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'  align='left'>&nbsp;</td>");
        //        sbRecorords.Append("<td class='cols_'  align='left'>&nbsp;</td>");
        //        sbRecorords.Append("<td class='cols_'  align='right' valign='top'>" + string.Format("{0:C}", drRecords_Payment[intI4]["Paid_Med_BI_Comp"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'  align='right' valign='top'>" + string.Format("{0:C}", drRecords_Payment[intI4]["Paid_Expense"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'  align='right' valign='top'>" + string.Format("{0:C}", drRecords_Payment[intI4]["Paid_Ind_PD_Coll"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'  align='right' valign='top'>" + string.Format("{0:C}", drRecords_Payment[intI4]["Paid_Legal"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'  align='right' valign='top'>" + string.Format("{0:C}", drRecords_Payment[intI4]["Paid_Other"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'  align='right' valign='top'>" + string.Format("{0:C}", drRecords_Payment[intI4]["TotalPaid"]) + "</td>");
        //        sbRecorords.Append("</tr>");

        //        sbRecorords.Append("<tr  align='right' style='font-size:8pt;font-family:Tahoma;'>");
        //        sbRecorords.Append("<td class='cols_' colspan='10' >&nbsp;</td>");
        //        sbRecorords.Append("</tr>");
        //    }

        //    return sbRecorords;
        //}

        /// <summary>
        /// Get Sum value Return Total 
        /// </summary>
        /// <param name="sbRecorords"></param>
        /// <param name="dtReport"></param>
        /// <param name="bSubTotal"></param>
        /// <param name="strSubTotalFor"></param>
        /// <returns></returns>
        //private StringBuilder GenerateTotals(StringBuilder sbRecorords, DataTable dtReport, bool bSubTotal, string strSubTotalFor)
        //{
        //    ///// Sub Total for the group
        //    if (dtReport.Rows.Count > 0)
        //    {
        //        decimal decIncurred1M = 0, decIncurred2M = 0, decPaid1M = 0, decPaid2M = 0, decOS1M = 0, decOS2m = 0;
        //        decimal decOut = 0;
        //        if (decimal.TryParse(Convert.ToString(dtReport.Compute("SUM(InccuredAmt1)", "")), out decOut)) decIncurred1M = decOut;
        //        decOut = 0;
        //        if (decimal.TryParse(Convert.ToString(dtReport.Compute("SUM(InccuredAmt2)", "")), out decOut)) decIncurred2M = decOut;
        //        decOut = 0;
        //        if (decimal.TryParse(Convert.ToString(dtReport.Compute("SUM(PaidAmt1)", "")), out decOut)) decPaid1M = decOut;
        //        decOut = 0;
        //        if (decimal.TryParse(Convert.ToString(dtReport.Compute("SUM(PaidAmt2)", "")), out decOut)) decPaid2M = decOut;
        //        decOut = 0;
        //        if (decimal.TryParse(Convert.ToString(dtReport.Compute("SUM(OUTSTANDING1)", "")), out decOut)) decOS1M = decOut;
        //        decOut = 0;
        //        if (decimal.TryParse(Convert.ToString(dtReport.Compute("SUM(OUTSTANDING2)", "")), out decOut)) decOS2m = decOut;

        //        string strSubTotalRowStyle = "font-weight:bold";
        //        string strGrandTotalRowStyle = "font-weight: bold;background-color: #507CD1;color: White;";

        //        sbRecorords.Append("<tr style='" + (bSubTotal ? strSubTotalRowStyle : strGrandTotalRowStyle) + "' valign='top' align='right'>");
        //        sbRecorords.Append("<td  style='border-bottom: #EAEAEA 1px solid' class='cols_'  width='40%' align='left'>" + (bSubTotal ? ("Sub Total For " + strSubTotalFor + "&nbsp;") : "Grand Totals") + "</td>");
        //        sbRecorords.Append("<td  style='border-bottom: #EAEAEA 1px solid' class='cols_'  width='10%' align='left'> &nbsp;</td>");
        //        sbRecorords.Append("<td  style='border-bottom: #EAEAEA 1px solid' class='cols_'   width='10%'> Incurred: </td>");
        //        sbRecorords.Append("<td  style='border-bottom: #EAEAEA 1px solid' class='cols_'   width='10%'>" + string.Format("{0:c2}", decIncurred1M) + " </td>");
        //        sbRecorords.Append("<td  style='border-bottom: #EAEAEA 1px solid' class='cols_'   width='10%'>" + string.Format("{0:c2}", decIncurred2M) + "  </td>");
        //        sbRecorords.Append("<td  style='border-bottom: #EAEAEA 1px solid' class='cols_'   width='10%'  >" + string.Format("{0:c2}", (decIncurred2M - decIncurred1M)) + " </td>");//Diffrence Plz Change
        //        sbRecorords.Append("<td  style='border-bottom: #EAEAEA 1px solid' class='cols_'   width='10%'  > " + string.Format("{0:c2}", (decIncurred2M > 0) ? string.Format("{0:N2}", ((decIncurred1M / decIncurred2M) * 100)) : "0.00" + " </td>"));//Diffrence Plz Change
        //        sbRecorords.Append("</tr>");
        //        sbRecorords.Append("<tr style='" + (bSubTotal ? strSubTotalRowStyle : strGrandTotalRowStyle) + "'   valign='top' align='right'>");
        //        sbRecorords.Append("<td  style='border-bottom: #EAEAEA 1px solid' class='cols_'  width='40%' align='left'>  &nbsp;</td>");
        //        sbRecorords.Append("<td  style='border-bottom: #EAEAEA 1px solid' class='cols_'  width='10%' align='left'> &nbsp;</td>");
        //        sbRecorords.Append("<td  style='border-bottom: #EAEAEA 1px solid' class='cols_'   width='10%'> Paid: </td>");
        //        sbRecorords.Append("<td  style='border-bottom: #EAEAEA 1px solid' class='cols_'   width='10%'>" + string.Format("{0:c2}", decPaid1M) + " </td>");
        //        sbRecorords.Append("<td  style='border-bottom: #EAEAEA 1px solid' class='cols_'   width='10%'>" + string.Format("{0:c2}", decPaid2M) + "  </td>");
        //        sbRecorords.Append("<td  style='border-bottom: #EAEAEA 1px solid' class='cols_'   width='10%'  >" + string.Format("{0:c2}", (decPaid2M - decPaid1M)) + " </td>");//Diffrence Plz Change
        //        sbRecorords.Append("<td  style='border-bottom: #EAEAEA 1px solid' class='cols_'   width='10%'  > " + string.Format("{0:c2}", (decPaid2M > 0) ? string.Format("{0:N2}", ((decPaid1M / decPaid2M) * 100)) : "0.00" + " </td>"));//Diffrence Plz Change
        //        sbRecorords.Append("</tr>");
        //        sbRecorords.Append("<tr style='" + (bSubTotal ? strSubTotalRowStyle : strGrandTotalRowStyle) + "'   valign='top' align='right'>");
        //        sbRecorords.Append("<td  style='border-bottom: #EAEAEA 1px solid' class='cols_'  width='40%' align='left'>  &nbsp;</td>");
        //        sbRecorords.Append("<td  style='border-bottom: #EAEAEA 1px solid' class='cols_'  width='10%' align='left'> &nbsp;</td>");
        //        sbRecorords.Append("<td  style='border-bottom: #EAEAEA 1px solid' class='cols_'   width='10%'> Outstanding: </td>");
        //        sbRecorords.Append("<td  style='border-bottom: #EAEAEA 1px solid' class='cols_'   width='10%'>" + string.Format("{0:c2}", decOS1M) + " </td>");
        //        sbRecorords.Append("<td  style='border-bottom: #EAEAEA 1px solid' class='cols_'   width='10%'>" + string.Format("{0:c2}", decOS2m) + "  </td>");
        //        sbRecorords.Append("<td  style='border-bottom: #EAEAEA 1px solid' class='cols_'   width='10%'  >" + string.Format("{0:c2}", (decOS2m - decOS1M)) + " </td>");//Diffrence Plz Change
        //        sbRecorords.Append("<td  style='border-bottom: #EAEAEA 1px solid' class='cols_'   width='10%'  > " + string.Format("{0:c2}", (decOS2m > 0) ? string.Format("{0:N2}", ((decOS1M / decOS2m) * 100)) : "0.00" + " </td>"));//Diffrence Plz Change
        //        sbRecorords.Append("</tr>");
        //    }
        //    return sbRecorords;
        //}

        /// <summary>
        /// Generate Sub Row for Large Loss Claim Detail Report
        /// </summary>
        /// <param name="sbRecorords"></param>
        /// <param name="dtRecords_Payment"></param>
        /// <param name="strFirstGroupBy"></param>
        /// <param name="strSecondGroupBy"></param>
        /// <returns></returns>
        //private StringBuilder GenerateReportRowsForLargeLossReport(StringBuilder sbRecorords, DataTable dtRecords_Payment, string strFirstGroupBy, string strSecondGroupBy)
        //{
        //    string strFilter = "";
        //    if (!string.IsNullOrEmpty(strSecondGroupBy))
        //        strFilter = string.Format("FirstGroupBy = '{0}' and  SecondGroupBy = '{1}' ", strFirstGroupBy, strSecondGroupBy);
        //    else
        //        strFilter = string.Format("FirstGroupBy = '{0}'", strFirstGroupBy);

        //    DataRow[] drRecords_Payment = dtRecords_Payment.Select(strFilter);
        //    for (int intI4 = 0; intI4 < drRecords_Payment.Length; intI4++)
        //    {
        //        int intRes;
        //        int intDiv = System.Math.DivRem(intI4, 2, out intRes);
        //        string strRowStyle = "font-size:8pt;font-family:Tahoma;";
        //        string strAltRowStyle = "font-size:8pt;background-color:#EAEAEA;font-family:Tahoma;";

        //        sbRecorords.Append("<tr  align='right' style='" + ((intRes == 0) ? strRowStyle : strAltRowStyle) + "'>");
        //        sbRecorords.Append("<td class='cols_'  align='left' valign='top'>" + Convert.ToString(drRecords_Payment[intI4]["Claim_Number"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'  align='left' valign='top'>" + Convert.ToString(drRecords_Payment[intI4]["Driver_Claimant_Name"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'  colspan='8' align='left' valign='top'>" + Convert.ToString(drRecords_Payment[intI4]["Coverage"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_' >&nbsp;</td>");
        //        sbRecorords.Append("</tr>");

        //        sbRecorords.Append("<tr  align='right' style='" + ((intRes == 0) ? strRowStyle : strAltRowStyle) + "'>");
        //        sbRecorords.Append("<td class='cols_'  align='left' valign='top'>" + Convert.ToString(drRecords_Payment[intI4]["OperatingCompanies"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'  align='left' valign='top'>" + string.Format("{0:MM/dd/yyyy}", drRecords_Payment[intI4]["Loss_DateTime"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'  align='left' valign='top'>" + string.Format("{0:MM/dd/yyyy}", drRecords_Payment[intI4]["Report_Date"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'  align='left' valign='top'>" + Convert.ToString(drRecords_Payment[intI4]["Statuses"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'  align='right' valign='top'>" + string.Format("{0:C}", drRecords_Payment[intI4]["INC_Med_BI_Comp"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'  align='right' valign='top'>" + string.Format("{0:C}", drRecords_Payment[intI4]["Inc_Expense"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'  align='right' valign='top'>" + string.Format("{0:C}", drRecords_Payment[intI4]["INC_Ind_PD_Coll"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'  align='right' valign='top'>" + string.Format("{0:C}", drRecords_Payment[intI4]["INC_Legal"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'  align='right' valign='top'>" + string.Format("{0:C}", drRecords_Payment[intI4]["INC_Other"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'  align='right' valign='top'>" + string.Format("{0:C}", drRecords_Payment[intI4]["TotalIncurred"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'> &nbsp;</td>");
        //        sbRecorords.Append("</tr>");

        //        sbRecorords.Append("<tr  align='right' style='" + ((intRes == 0) ? strRowStyle : strAltRowStyle) + "'>");
        //        sbRecorords.Append("<td class='cols_'  align='left' valign='top'>" + Convert.ToString(drRecords_Payment[intI4]["Claim_Description"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'  align='left' valign='top'>" + Convert.ToString(drRecords_Payment[intI4]["Causes"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'  align='left'>&nbsp;</td>");
        //        sbRecorords.Append("<td class='cols_'  align='left'>&nbsp;</td>");
        //        sbRecorords.Append("<td class='cols_'  align='right' valign='top'>" + string.Format("{0:C}", drRecords_Payment[intI4]["Paid_Med_BI_Comp"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'  align='right' valign='top'>" + string.Format("{0:C}", drRecords_Payment[intI4]["Paid_Expense"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'  align='right' valign='top'>" + string.Format("{0:C}", drRecords_Payment[intI4]["Paid_Ind_PD_Coll"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'  align='right' valign='top'>" + string.Format("{0:C}", drRecords_Payment[intI4]["Paid_Legal"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'  align='right' valign='top'>" + string.Format("{0:C}", drRecords_Payment[intI4]["Paid_Other"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'  align='right' valign='top'>" + string.Format("{0:C}", drRecords_Payment[intI4]["TotalPaid"]) + "</td>");
        //        sbRecorords.Append("<td class='cols_'  nowarp='nowarp' align='left' valign='top'>" + Convert.ToString(drRecords_Payment[intI4]["Adjustor_Notes"]) + "</td>");
        //        sbRecorords.Append("</tr>");

        //        sbRecorords.Append("<tr  align='right' style='font-size:8pt;font-family:Tahoma;'>");
        //        sbRecorords.Append("<td class='cols_' colspan='11' >&nbsp;</td>");
        //        sbRecorords.Append("</tr>");
        //    }


        //    return sbRecorords;
        //}

        #endregion

        /// <summary>
        /// Format Null Date To Store 
        /// </summary>
        /// <param name="strDate"></param>
        /// <returns></returns>
        public static Nullable<DateTime> FormatNullDateToStore(string strDate)
        {
            if (!String.IsNullOrEmpty(strDate.Trim()))
            {
                return Convert.ToDateTime(strDate.Trim());
            }
            else
            {
                return null;
            }
        }

        /// <summary>
        /// Get Date Where Condition
        /// </summary>
        /// <param name="strCriteria"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <returns></returns>
        private string GetDateCriteriaForPrint(string strCriteria, DateTime? FromDate, DateTime? ToDate)
        {
            string strWhere = string.Empty;

            if (!string.IsNullOrEmpty(strCriteria) && (FromDate.HasValue || ToDate.HasValue))
            {

                if (strCriteria == "O" && FromDate.HasValue)
                    strWhere = "<td> <b> On Date : </b><td>" + FromDate.Value.ToString(DateDisplayFormat) + " ";
                else if (strCriteria == "BF" && FromDate.HasValue)
                    strWhere = "<td> <b> On or Before Date : </b><td>" + FromDate.Value.ToString(DateDisplayFormat) + " ";
                else if (strCriteria == "A" && FromDate.HasValue)
                    strWhere = "<td> <b> On or After Date : </b><td>" + FromDate.Value.ToString(DateDisplayFormat) + " ";
                else if (strCriteria == "B")
                {
                    strWhere = "<td><b> Start Date : </b><td>&nbsp;";
                    if (FromDate.HasValue)
                        strWhere += " " + FromDate.Value.ToString(DateDisplayFormat) + " ";

                    strWhere += "<td><b> End Date : </b>";
                    // if to date is passed and then add and condition for between
                    if (ToDate.HasValue)
                        strWhere += "<td>" + ToDate.Value.ToString(DateDisplayFormat) + " ";
                }
            }

            return strWhere;
        }

        /// <summary>
        /// Fill Filter Value from Dropdown
        /// </summary>
        /// <param name="strField_Name"></param>
        /// <param name="strConValue"></param>
        /// <returns></returns>
        public static string FillFilterDropDown(string strField_Name, string strConValue)
        {
            try
            {

                /*
                 * This function used for Fill drop down For Adhoc Report.
                 * As Filter come from database directly, We maintain one XML file for Field name and Table Name.
                 * Some of the drop down are static in system. Like Yes, No ,N/A  values drop down
                 * In XML file there are one field "Title" which map with "Header" of Adhoc Report Field.
                 * Same way another property "TableName" which is Actual table name in database.
                 * "Type" property is used for define static drop down type.
                 * "HasCode" property define if table has both Description and Code fields
                 * 
                 * First of all Find "Title" in XML File. based on that Fill Drop Down 
                 * If It is static values meand "Type" is not "DropDown" then Add Static Fields to Dropdown
                 * 
                 * */

                DataSet dsXML = new System.Data.DataSet();
                // Read XML Files

                dsXML.ReadXml(AppDomain.CurrentDomain.BaseDirectory + "\\AdHocReportFields.xml");
                string strTable = string.Empty, strType = string.Empty, strDesc = string.Empty, strRecord = string.Empty;
                bool IsTableHasCode = true;

                if (dsXML.Tables.Count > 0)
                {
                    DataRow[] drFilter = dsXML.Tables[0].Select("Title = '" + strField_Name + "'");

                    if (drFilter.Length > 0)
                    {
                        strTable = Convert.ToString(drFilter[0]["TableName"]);
                        strType = Convert.ToString(drFilter[0]["Type"]);
                        strDesc = Convert.ToString(drFilter[0]["Field_Name"]);
                        IsTableHasCode = (Convert.ToString(drFilter[0]["HasCode"]) == "Y");
                    }
                }
                dsXML.Dispose();
                dsXML = null;

                if (string.Compare(strType, "DropDown", true) == 0)
                {
                    if (!string.IsNullOrEmpty(strConValue))
                        strRecord = GetCommaValueFromTable(Report.LuTableSelectByIDs(strTable, strConValue, strDesc), strDesc);
                }
                else
                {
                    if (!string.IsNullOrEmpty(strConValue))
                    {
                        string[] arrConditionValue = strConValue.Split(',');
                        for (int intj = 0; intj < arrConditionValue.Length; intj++)
                        {
                            if (arrConditionValue[intj] == "1" || arrConditionValue[intj] == "Y")
                            {
                                if (strField_Name == "Work to Be Completed By")
                                {
                                    strRecord += "ACI,";
                                }
                                else if (strField_Name == "GM Decision" || strField_Name == "RLCM Decision" || strField_Name == "NAPM Decision" || strField_Name == "DRM Decision")
                                {
                                    strRecord += "Approve,";
                                }
                                else
                                {
                                    strRecord += "Yes,";
                                }
                            }
                            else if (arrConditionValue[intj] == "0" || arrConditionValue[intj] == "N")
                            {
                                if (strField_Name == "Work to Be Completed By")
                                {
                                    strRecord += "Sonic,";
                                }
                                else if (strField_Name == "GM Decision" || strField_Name == "RLCM Decision" || strField_Name == "NAPM Decision" || strField_Name == "DRM Decision")
                                {
                                    strRecord += "Not Approve,";
                                }
                                else
                                {
                                    strRecord += "No,";
                                }
                            }
                            else if (arrConditionValue[intj] == "C")
                            {
                                strRecord += "Close,";

                            }
                            else if (arrConditionValue[intj] == "O")
                            {
                                strRecord += "Open,";
                            }
                            else if (arrConditionValue[intj] == "3")
                            {
                                if (string.Compare(strTable, "drpTest", true) == 0)
                                    strRecord += "Time Expired-no test,";
                                else if (string.Compare(strTable, "drpYesNo9999", true) == 0)
                                    strRecord += "9999,";
                                else if (string.Compare(strTable, "drpTest", true) == 0)
                                    strRecord += "Time Expired-no test,";
                            }
                            else
                                strRecord += strConValue;
                        }
                        strRecord = strRecord.TrimEnd(',');
                    }
                }
                return strRecord;
            }
            catch (Exception e)
            {
                throw e;
            }
        }

        /// <summary>
        /// Fill Filter DropDown For Construction AdHoc Report
        /// </summary>
        /// <param name="strField_Name"></param>
        /// <param name="strConValue"></param>
        /// <returns></returns>
        public static string FillFilterDropDownForConstructionReport(string strField_Name, string strConValue)
        {
            try
            {

                /*
                 * This function used for Fill drop down For Adhoc Report.
                 * As Filter come from database directly, We maintain one XML file for Field name and Table Name.
                 * Some of the drop down are static in system. Like Yes, No ,N/A  values drop down
                 * In XML file there are one field "Title" which map with "Header" of Adhoc Report Field.
                 * Same way another property "TableName" which is Actual table name in database.
                 * "Type" property is used for define static drop down type.
                 * "HasCode" property define if table has both Description and Code fields
                 * 
                 * First of all Find "Title" in XML File. based on that Fill Drop Down 
                 * If It is static values meand "Type" is not "DropDown" then Add Static Fields to Dropdown
                 * 
                 * */

                DataSet dsXML = new System.Data.DataSet();
                // Read XML Files

                dsXML.ReadXml(AppDomain.CurrentDomain.BaseDirectory + "\\ConstructionAdHocReportFields.xml");
                string strTable = string.Empty, strType = string.Empty, strDesc = string.Empty, strRecord = string.Empty, valueField = string.Empty, textField = string.Empty, sortField = string.Empty;
                bool IsTableHasCode = true;
                bool hasUnderScore = false;

                if (dsXML.Tables.Count > 0)
                {
                    DataRow[] drFilter = dsXML.Tables[0].Select("Title = '" + strField_Name + "'");

                    if (drFilter.Length > 0)
                    {
                        strTable = Convert.ToString(drFilter[0]["TableName"]);
                        strType = Convert.ToString(drFilter[0]["Type"]);
                        IsTableHasCode = (Convert.ToString(drFilter[0]["HasCode"]) == "Y");
                        hasUnderScore = (Convert.ToString(drFilter[0]["HasUnderScore"]) == "Y");
                        valueField = Convert.ToString(drFilter[0]["DataValueField"]);
                        textField = Convert.ToString(drFilter[0]["DataTextField"]);
                        sortField = Convert.ToString(drFilter[0]["SortField"]);
                    }
                }
                dsXML.Dispose();
                dsXML = null;

                if (string.Compare(strType, "DropDown", true) == 0)
                {
                    if (!string.IsNullOrEmpty(strConValue))
                    {
                        DataTable dtReport = Report.SelectByTableName(strTable, hasUnderScore);
                        dtReport.DefaultView.Sort = sortField;
                        strRecord = GetCommaValueFromTable(dtReport, textField);
                    }
                }
                else if (string.Compare(strType, "DropDownStatus", true) == 0)
                {
                    if (!string.IsNullOrEmpty(strConValue))
                    {
                        if (strConValue.Contains(","))
                        {
                            string[] arrConditionValue = strConValue.Split(',');
                            foreach (string conditionValue in arrConditionValue)
                            {
                                if (!string.IsNullOrEmpty(conditionValue))
                                {
                                    switch (conditionValue.ToUpper())
                                    {
                                        case "O":
                                            strConValue += "Open,";
                                            break;
                                        case "I":
                                            strConValue += "In Process,";
                                            break;
                                        case "C":
                                            strConValue += "Complete,";
                                            break;
                                    }
                                }
                            }
                        }
                    }

                    strConValue = (!string.IsNullOrEmpty(strConValue)) ? strConValue.TrimEnd(',') : "";
                }
                return strRecord;
            }
            catch (Exception e)
            {
                throw e;
            }
        }

        /// <summary>
        /// Fill Filter Value from Dropdown
        /// </summary>
        /// <param name="strField_Name"></param>
        /// <param name="strConValue"></param>
        /// <returns></returns>
        public static string FillFilterDropDownForSafetyTraining(string strField_Name, string strConValue)
        {
            try
            {

                /*
                 * This function used for Fill drop down For Adhoc Report.
                 * As Filter come from database directly, We maintain one XML file for Field name and Table Name.
                 * Some of the drop down are static in system. Like Yes, No ,N/A  values drop down
                 * In XML file there are one field "Title" which map with "Header" of Adhoc Report Field.
                 * Same way another property "TableName" which is Actual table name in database.
                 * "Type" property is used for define static drop down type.
                 * "HasCode" property define if table has both Description and Code fields
                 * 
                 * First of all Find "Title" in XML File. based on that Fill Drop Down 
                 * If It is static values meand "Type" is not "DropDown" then Add Static Fields to Dropdown
                 * 
                 * */

                DataSet dsXML = new System.Data.DataSet();
                // Read XML Files

                dsXML.ReadXml(AppDomain.CurrentDomain.BaseDirectory + "\\SafetyTrainingAdHocReportFields.xml");
                string strTable = string.Empty, strType = string.Empty, strDesc = string.Empty, strRecord = string.Empty;
                bool IsTableHasCode = true;

                if (dsXML.Tables.Count > 0)
                {
                    DataRow[] drFilter = dsXML.Tables[0].Select("Title = '" + strField_Name + "'");

                    if (drFilter.Length > 0)
                    {
                        strTable = Convert.ToString(drFilter[0]["TableName"]);
                        strType = Convert.ToString(drFilter[0]["Type"]);
                        strDesc = Convert.ToString(drFilter[0]["Field_Name"]);
                        IsTableHasCode = (Convert.ToString(drFilter[0]["HasCode"]) == "Y");
                    }
                }
                dsXML.Dispose();
                dsXML = null;

                if (string.Compare(strType, "DropDown", true) == 0)
                {
                    if (!string.IsNullOrEmpty(strConValue))
                        strRecord = GetCommaValueFromTable(Report.LuTableSelectByIDs(strTable, strConValue, strDesc), strDesc);
                }
                else
                {
                    if (!string.IsNullOrEmpty(strConValue))
                    {
                        string[] arrConditionValue = strConValue.Split(',');
                        for (int intj = 0; intj < arrConditionValue.Length; intj++)
                        {
                            if (arrConditionValue[intj] == "1" || arrConditionValue[intj] == "Y")
                            {
                                if (strField_Name == "Work to Be Completed By")
                                {
                                    strRecord += "ACI,";
                                }
                                else if (strField_Name == "GM Decision" || strField_Name == "RLCM Decision" || strField_Name == "NAPM Decision" || strField_Name == "DRM Decision")
                                {
                                    strRecord += "Approve,";
                                }
                                else
                                {
                                    strRecord += "Yes,";
                                }
                            }
                            else if (arrConditionValue[intj] == "0" || arrConditionValue[intj] == "N")
                            {
                                if (strField_Name == "Work to Be Completed By")
                                {
                                    strRecord += "Sonic,";
                                }
                                else if (strField_Name == "GM Decision" || strField_Name == "RLCM Decision" || strField_Name == "NAPM Decision" || strField_Name == "DRM Decision")
                                {
                                    strRecord += "Not Approve,";
                                }
                                else
                                {
                                    strRecord += "No,";
                                }
                            }
                            else if (arrConditionValue[intj] == "C")
                            {
                                strRecord += "Close,";
                            }
                            else if (arrConditionValue[intj] == "O")
                            {
                                strRecord += "Open,";
                            }
                            else if (strField_Name == "Training Completed")
                            {
                                if (arrConditionValue[intj] == "'Completed'")
                                {
                                    strRecord += "Completed,";
                                }
                                else if (arrConditionValue[intj] == "'Incomplete'")
                                {
                                    strRecord += "Incomplete,";
                                }
                                //else if (arrConditionValue[intj] == "'2'")
                                //{
                                //    strRecord += "Waived,";
                                //}

                            }
                            else if (arrConditionValue[intj] == "3")
                            {
                                if (string.Compare(strTable, "drpTest", true) == 0)
                                    strRecord += "Time Expired-no test,";
                                else if (string.Compare(strTable, "drpYesNo9999", true) == 0)
                                    strRecord += "9999,";
                                else if (string.Compare(strTable, "drpTest", true) == 0)
                                    strRecord += "Time Expired-no test,";
                            }
                            else
                                strRecord += strConValue;
                        }
                        strRecord = strRecord.TrimEnd(',');
                    }
                }
                return strRecord;
            }
            catch (Exception e)
            {
                throw e;
            }
        }

        #endregion

        #region Construction Ad-Hoc Report Methods

        /// <summary>
        /// Bind and return Group By String
        /// </summary>
        /// <param name="ObjAdHocReport"></param>
        /// <returns></returns>
        private string BindGroupBy(Construction_AdHocReport ObjAdHocReport)
        {
            string strGroupBy = string.Empty;

            if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.FirstGroupBy)))
            {
                Construction_AdhocReportFields objReportFields = new Construction_AdhocReportFields(ObjAdHocReport.FirstGroupBy.Value);
                string firstGroupByOrder = "ASC";
                if (!string.IsNullOrEmpty(ObjAdHocReport.FirstGroupByOrder))
                {
                    firstGroupByOrder = ObjAdHocReport.FirstGroupByOrder.ToUpper() == "TRUE" ? "ASC" : "DESC";
                }
                strGroupBy = " [" + objReportFields.Field_Header + "] " + firstGroupByOrder;
            }

            if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.SecondGroupBy)))
            {
                Construction_AdhocReportFields objReportFields = new Construction_AdhocReportFields(ObjAdHocReport.SecondGroupBy.Value);
                string secondGroupByOrder = "ASC";
                if (!string.IsNullOrEmpty(ObjAdHocReport.SecondGroupByOrder))
                {
                    secondGroupByOrder = ObjAdHocReport.SecondGroupByOrder.ToUpper() == "TRUE" ? "ASC" : "DESC";
                }
                strGroupBy += (string.IsNullOrEmpty(strGroupBy) ? "" : ",") + " [" + objReportFields.Field_Header + "] " + secondGroupByOrder;
            }

            if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.ThirdGroupBy)))
            {
                Construction_AdhocReportFields objReportFields = new Construction_AdhocReportFields(ObjAdHocReport.ThirdGroupBy.Value);
                string thirdGroupByOrder = "ASC";
                if (!string.IsNullOrEmpty(ObjAdHocReport.ThirdGroupByOrder))
                {
                    thirdGroupByOrder = ObjAdHocReport.ThirdGroupByOrder.ToUpper() == "TRUE" ? "ASC" : "DESC";
                }
                strGroupBy += (string.IsNullOrEmpty(strGroupBy) ? "" : ",") + " [" + objReportFields.Field_Header + "] " + thirdGroupByOrder;
            }

            return strGroupBy;
        }

        /// <summary>
        /// Bind and return Order By String
        /// </summary>
        /// <param name="ObjAdHocReport"></param>
        /// <returns></returns>
        private string BindOrderBy(Construction_AdHocReport ObjAdHocReport)
        {
            string strOrderBy = string.Empty;
            if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.FirstSortBy)))
            {
                Construction_AdhocReportFields objReportFields = new Construction_AdhocReportFields(ObjAdHocReport.FirstSortBy.Value);
                strOrderBy = " [" + objReportFields.Field_Header + "] " + ObjAdHocReport.FirstSortByOrder;
            }
            if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.SecondSortBy)))
            {
                Construction_AdhocReportFields objReportFields = new Construction_AdhocReportFields(ObjAdHocReport.SecondSortBy.Value);
                strOrderBy += (string.IsNullOrEmpty(strOrderBy) ? "" : ",") + " [" + objReportFields.Field_Header + "] " + ObjAdHocReport.SecondGroupByOrder;
            }
            if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.ThirdSortBy)))
            {
                Construction_AdhocReportFields objReportFields = new Construction_AdhocReportFields(ObjAdHocReport.SecondSortBy.Value);
                strOrderBy += (string.IsNullOrEmpty(strOrderBy) ? "" : ",") + " [" + objReportFields.Field_Header + "] " + ObjAdHocReport.ThirdSortByOrder;
            }
            return strOrderBy;
        }

        /// <summary>
        /// Bind and Return Where Condition
        /// </summary>
        /// <param name="lstFilter"></param>
        /// <returns></returns>
        private string GetWhereCondition(List<Construction_AdHocFilter> lstFilter, List<Construction_AdhocReportFields> listConstruction_AdHocReportFields)
        {
            string strWhere = string.Empty;
            for (int i = 0; i < lstFilter.Count; i++)
            {
                Construction_AdhocReportFields construction_AdhocReportFields = listConstruction_AdHocReportFields.Find(a => a.Pk_AdhocReportFields == lstFilter[i].FK_AdHocReportFields);

                if (construction_AdhocReportFields.Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.TextBox)
                {
                    strWhere += BindTextCondition(lstFilter[i].ConditionType, lstFilter[i].ConditionValue, construction_AdhocReportFields.Field_Name, construction_AdhocReportFields.Table_Name, Convert.ToBoolean(lstFilter[i].IsNotSelected));
                }
                else if (construction_AdhocReportFields.Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.MultiSelectList && lstFilter[i].ConditionValue != null)
                {
                    strWhere += BindDropDownCondition(lstFilter[i].ConditionType, lstFilter[i].ConditionValue, construction_AdhocReportFields.WhereField, construction_AdhocReportFields.Table_Name, Convert.ToBoolean(lstFilter[i].IsNotSelected));

                }
                else if (construction_AdhocReportFields.Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.DateControl)
                {
                    strWhere += BindDateCondition(lstFilter[i], construction_AdhocReportFields.Field_Name, construction_AdhocReportFields.Table_Name, Convert.ToBoolean(lstFilter[i].IsNotSelected));
                }
                else if (construction_AdhocReportFields.Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.AmountControl)
                {
                    strWhere += BindAmountCondition(lstFilter[i], lstFilter[i].ConditionType, lstFilter[i].ConditionValue, construction_AdhocReportFields.Field_Name, construction_AdhocReportFields.Table_Name, Convert.ToBoolean(lstFilter[i].IsNotSelected));
                }
            }
            return strWhere;
        }

        /// <summary>
        /// Bind and Return DateTime Type Condition
        /// </summary>
        /// <param name="lstFilter"></param>
        /// <returns></returns>
        private string BindDateCondition(ERIMS_DAL.Construction_AdHocFilter objFilter, string strField, string strTableName, bool IsNotSelected)
        {
            string strWhere = string.Empty;

            DateTime? dtFrom = null, dtTo = null;

            if (string.IsNullOrEmpty(objFilter.FromRelativeCriteria))
                dtFrom = FormatNullDateToStore(Convert.ToString(objFilter.FromDate));
            else
            {
                // set Relative Date From criteria
                AdHocReportHelper.RaltiveDates RelType = (AdHocReportHelper.RaltiveDates)Enum.Parse(typeof(AdHocReportHelper.RaltiveDates), objFilter.FromRelativeCriteria);
                dtFrom = AdHocReportHelper.GetRelativeDate(RelType);
            }
            if (string.IsNullOrEmpty(objFilter.ToRelativeCriteria))
                dtTo = FormatNullDateToStore(Convert.ToString(objFilter.ToDate));
            else
            {
                // set Relative Date To criteria
                AdHocReportHelper.RaltiveDates RelType = (AdHocReportHelper.RaltiveDates)Enum.Parse(typeof(AdHocReportHelper.RaltiveDates), objFilter.ToRelativeCriteria);
                dtTo = AdHocReportHelper.GetRelativeDate(RelType);
            }

            AdHocReportHelper.DateCriteria DtType = AdHocReportHelper.DateCriteria.On;

            if (objFilter.ConditionType == "On")
                DtType = AdHocReportHelper.DateCriteria.On;
            else if (objFilter.ConditionType == "BF")
                DtType = AdHocReportHelper.DateCriteria.Before;
            else if (objFilter.ConditionType == "A")
                DtType = AdHocReportHelper.DateCriteria.After;
            else if (objFilter.ConditionType == "B")
                DtType = AdHocReportHelper.DateCriteria.Between;

            if (dtFrom.HasValue)
                strWhere = AdHocReportHelper.GetDateWhereAbsolute(strTableName + ".[" + strField + "]", dtFrom, dtTo, DtType, IsNotSelected);

            else if (dtTo.HasValue)
                strWhere = AdHocReportHelper.GetDateWhereAbsolute(strTableName + ".[" + strField + "]", dtFrom, dtTo, DtType, IsNotSelected);
            return strWhere;
        }

        /// <summary>
        /// Bind and Return Amount Type Condition
        /// </summary>
        /// <param name="lstFilter"></param>
        /// <returns></returns>
        private string BindAmountCondition(ERIMS_DAL.Construction_AdHocFilter objFilter, string strConditionType, string strConditionValue, string strField, string strTableName, bool IsNotSelected)
        {
            string strWhere = string.Empty;
            AdHocReportHelper.AmountCriteria AmtType = AdHocReportHelper.AmountCriteria.Equal;

            decimal? dFrom = null;
            decimal? dTo = null;

            if (!string.IsNullOrEmpty(Convert.ToString(objFilter.AmountFrom)))
                dFrom = Convert.ToDecimal(objFilter.AmountFrom);

            if (!string.IsNullOrEmpty(Convert.ToString(objFilter.AmountTo)))
                dTo = Convert.ToDecimal(objFilter.AmountTo);

            if (Convert.ToInt16(objFilter.ConditionType) == (int)AdHocReportHelper.AmountCriteria.Equal)
                AmtType = AdHocReportHelper.AmountCriteria.Equal;
            else if (Convert.ToInt16(objFilter.ConditionType) == (int)AdHocReportHelper.AmountCriteria.GreaterThan)
                AmtType = AdHocReportHelper.AmountCriteria.GreaterThan;
            else if (Convert.ToInt16(objFilter.ConditionType) == (int)AdHocReportHelper.AmountCriteria.Between)
                AmtType = AdHocReportHelper.AmountCriteria.Between;
            else if (Convert.ToInt16(objFilter.ConditionType) == (int)AdHocReportHelper.AmountCriteria.LessThan)
                AmtType = AdHocReportHelper.AmountCriteria.LessThan;

            if (dFrom.HasValue)
                strWhere = AdHocReportHelper.GetAmountWhere("[" + strTableName.Trim() + "]" + "." + "[" + strField.Trim() + "]", dFrom, dTo, AmtType, IsNotSelected);
            else if (dTo.HasValue)
                strWhere = AdHocReportHelper.GetAmountWhere("[" + strTableName.Trim() + "]", dFrom, dTo, AmtType, IsNotSelected);

            return strWhere;
        }

        /// <summary>
        /// Bind Report Data.
        /// </summary>
        /// <param name="dsReport">Report Dataset</param>
        private string BindConstructionReport(ref StringBuilder sbRecord, IDataReader Reader, Construction_AdHocReport ObjAdHocReport, List<Construction_AdHocFilter> lstFilter, List<Construction_AdhocReportFields> listConstruction_AdHocReportFields, string strReportSchedulerName)
        {
               DataTable dtSchema = null, dtHeader = null;
            Construction_AdhocReportFields objReportFields = new Construction_AdhocReportFields();
            string strPath = string.Empty;
            Boolean IsGroupBySelected = false;


            try
            {
                #region "Filter and Title"
                //sbRecord.Append("<br />");
                //sbRecord.Append("<b>Report Title : " + strReportSchedulerName + " </b>");
                //sbRecord.Append("<br /><br />");
                sbRecord.Append("<table border='1' cellpadding='0' cellspacing='0' width='" + (150 * ObjAdHocReport.OutputFields.Split(',').Length).ToString() + "' style='font-size:10pt'>");
                sbRecord.Append("<tr><td colspan='" + ObjAdHocReport.OutputFields.Split(',').Length + "'>Report Title : " + strReportSchedulerName + " </td></tr>");
                for (int i = 0; i < lstFilter.Count; i++)
                {
                    string strConditionVal = string.Empty;
                    Construction_AdhocReportFields construction_AdhocReportFields = listConstruction_AdHocReportFields.Find(a => a.Pk_AdhocReportFields == lstFilter[i].FK_AdHocReportFields);
                    if (construction_AdhocReportFields.Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.TextBox)
                    {
                        string strConditionType = lstFilter[i].ConditionType;
                        if (Convert.ToBoolean(lstFilter[i].IsNotSelected) == true)
                            strConditionType = (strConditionType == "1") ? " Not Contains " : (strConditionType == "2" ? " Not Start With " : " Not End With ");
                        else
                            strConditionType = (strConditionType == "1") ? " Contains " : (strConditionType == "2" ? " Start With " : " End With ");
                        strConditionVal = lstFilter[i].ConditionValue;
                        sbRecord.Append("<tr><td colspan='" + ObjAdHocReport.OutputFields.Split(',').Length + "'><b>" + construction_AdhocReportFields.Field_Header + "</b> : " + strConditionType + lstFilter[i].ConditionValue + "</td><tr>");                        
                    }

                    if (construction_AdhocReportFields.Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.MultiSelectList)
                    {
                        if (Convert.ToBoolean(lstFilter[i].IsNotSelected) == true)
                            sbRecord.Append("<tr><td colspan='" + ObjAdHocReport.OutputFields.Split(',').Length + "'><b>" + construction_AdhocReportFields.Field_Header + "</b> (Not In)" + " : " + FillFilterDropDownForConstructionReport(construction_AdhocReportFields.Field_Header, lstFilter[i].ConditionValue)+"</td></tr>");
                        else
                            sbRecord.Append("<tr><td colspan='" + ObjAdHocReport.OutputFields.Split(',').Length + "'><b>" + construction_AdhocReportFields.Field_Header + "</b> (In)" + " : " + FillFilterDropDownForConstructionReport(construction_AdhocReportFields.Field_Header, lstFilter[i].ConditionValue) + "</td></tr>");
                    }

                    if (construction_AdhocReportFields.Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.DateControl)
                    {
                        string strConditionType = lstFilter[i].ConditionType;
                        Construction_AdhocReportFields objConstruction_AdhocReportFields = new Construction_AdhocReportFields(Convert.ToDecimal(lstFilter[i].FK_AdHocReportFields));
                        strConditionType = (strConditionType == "O") ? " On " : (strConditionType == "B" ? " Between " : (strConditionType == "BF" ? "On or Before " : "On or After "));

                        string dtFrom = null, dtTo = null;
                        if (string.IsNullOrEmpty(lstFilter[i].FromRelativeCriteria))
                            dtFrom = FormatDBNullDateToDisplay(lstFilter[i].FromDate);
                        else
                        {
                            // set Relative Date From criteria
                            AdHocReportHelper.RaltiveDates RelType = (AdHocReportHelper.RaltiveDates)Enum.Parse(typeof(AdHocReportHelper.RaltiveDates), lstFilter[i].FromRelativeCriteria);
                            dtFrom = AdHocReportHelper.GetRelativeDate(RelType).ToString("MM/dd/yyyy");
                        }
                        if (string.IsNullOrEmpty(lstFilter[i].ToRelativeCriteria))
                            dtTo = FormatDBNullDateToDisplay(lstFilter[i].ToDate);
                        else
                        {
                            // set Relative Date To criteria
                            AdHocReportHelper.RaltiveDates RelType = (AdHocReportHelper.RaltiveDates)Enum.Parse(typeof(AdHocReportHelper.RaltiveDates), lstFilter[i].ToRelativeCriteria);
                            dtTo = AdHocReportHelper.GetRelativeDate(RelType).ToString("MM/dd/yyyy");
                        }

                        if (Convert.ToBoolean(lstFilter[i].IsNotSelected) == true)
                            strConditionType = "Not" + strConditionType;

                        if (strConditionType.Trim() != "Between" && strConditionType.Trim() != "Not Between")
                            strConditionVal = "<b>" + construction_AdhocReportFields.Field_Header + " : " + strConditionType + "</b>" + dtFrom;
                        else
                            strConditionVal = "<b>" + construction_AdhocReportFields.Field_Header + " : </b>" + strConditionType + dtFrom + " And " + dtTo;

                        sbRecord.Append("<tr><td colspan='" + ObjAdHocReport.OutputFields.Split(',').Length + "'>" + strConditionVal + "</td></tr>");
                    }
                    if (construction_AdhocReportFields.Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.AmountControl)
                    {
                        string strConditionType = lstFilter[i].ConditionType;
                        strConditionType = (strConditionType == "0") ? " Equal " : (strConditionType == "1" ? " Greater Than " : (strConditionType == "2" ? " Between " : " Less Than "));

                        if (Convert.ToBoolean(lstFilter[i].IsNotSelected) == true)
                            strConditionType = "Not" + strConditionType;

                        if (strConditionType.Trim() != "Between" && strConditionType.Trim() != "Not Between")
                            strConditionVal = "<b>" + construction_AdhocReportFields.Field_Header + " : " + strConditionType + "</b>" + Convert.ToString(lstFilter[i].AmountFrom);
                        else
                            strConditionVal = "<b>" + construction_AdhocReportFields.Field_Header + " : </b>" + strConditionType + Convert.ToString(lstFilter[i].AmountFrom) + " And " + Convert.ToString(lstFilter[i].AmountTo);
                        //sbRecord.Append(strConditionVal);
                        sbRecord.Append("<tr><td colspan='" + ObjAdHocReport.OutputFields.Split(',').Length + "'>" + strConditionVal + "</td></tr>");
                    }
                    //sbRecord.Append("<br />");
                }
                //sbRecord.Append("<br />");
                sbRecord.Append("<tr><td colspan='" + ObjAdHocReport.OutputFields.Split(',').Length + "'></td></tr>");
                //sbRecord.Append("</table>");

                #endregion

                // Check if Any record is exists or not
                if (Reader.Read())
                {
                    string strFirstGroupBy = string.Empty, strSecGroupBy = string.Empty, strThirdGroupBy = string.Empty;
                    if (listConstruction_AdHocReportFields != null && listConstruction_AdHocReportFields.Count > 0)
                    {
                        if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.FirstGroupBy)))
                        {
                            Construction_AdhocReportFields construction_AdhocReportFields = listConstruction_AdHocReportFields.Find(a => a.Pk_AdhocReportFields == ObjAdHocReport.FirstGroupBy.Value);
                            strFirstGroupBy = construction_AdhocReportFields.Field_Header;

                            IsGroupBySelected = true;
                        }

                        if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.SecondGroupBy)))
                        {
                            Construction_AdhocReportFields construction_AdhocReportFields = listConstruction_AdHocReportFields.Find(a => a.Pk_AdhocReportFields == ObjAdHocReport.SecondGroupBy.Value);
                            strSecGroupBy = construction_AdhocReportFields.Field_Header;

                            IsGroupBySelected = true;
                        }

                        if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.ThirdGroupBy)))
                        {
                            Construction_AdhocReportFields construction_AdhocReportFields = listConstruction_AdHocReportFields.Find(a => a.Pk_AdhocReportFields == ObjAdHocReport.ThirdGroupBy.Value);
                            strThirdGroupBy = construction_AdhocReportFields.Field_Header;

                            IsGroupBySelected = true;
                        }
                    }
                    //iF First Group By is Not  selected then second Group by will be set as first Group By
                    if (string.IsNullOrEmpty(strFirstGroupBy))
                    {
                        strFirstGroupBy = strSecGroupBy;
                        strSecGroupBy = string.Empty;
                    }

                    dtSchema = Reader.GetSchemaTable();

                    //sbRecord.Append("<table border='1' cellpadding='0' cellspacing='0' width='" + (150 * ObjAdHocReport.OutputFields.Split(',').Length).ToString() + "' style='font-size:10pt'>");

                    #region "Header"

                    // If reader found a records 
                    sbRecord.Append("<tr>");
                    if (IsGroupBySelected)
                        sbRecord.Append("<td>&nbsp;</td>");
                    dtHeader = new DataTable();
                    string strFormatFirstGroupBy = string.Empty, strFormatSecGroupBy = string.Empty, strFormatThirdGroupBy = string.Empty;

                    foreach (DataRow drHeader in dtSchema.Rows)
                    {
                        //Remove Group By 
                        if (strFirstGroupBy != Convert.ToString(drHeader["ColumnName"]) && strSecGroupBy != Convert.ToString(drHeader["ColumnName"]) && strThirdGroupBy != Convert.ToString(drHeader["ColumnName"]))
                        {
                            if (drHeader["ColumnName"].ToString() != "Claim Count")
                            {
                                sbRecord.Append("<td><b>" + drHeader["ColumnName"] + "</b></td>");
                            }
                        }

                        //Get  Group By Field's Data Type
                        if (strFirstGroupBy == Convert.ToString(drHeader["ColumnName"]))
                            strFormatFirstGroupBy = drHeader["DataTypeName"].ToString();
                        if (strSecGroupBy == Convert.ToString(drHeader["ColumnName"]))
                            strFormatSecGroupBy = drHeader["DataTypeName"].ToString();
                        if (strThirdGroupBy == Convert.ToString(drHeader["ColumnName"]))
                            strFormatThirdGroupBy = drHeader["DataTypeName"].ToString();
                    }

                    //When Header have records
                    if (dtHeader.Columns.Count > 0)
                    {
                        DataRow drHerder = dtHeader.NewRow();

                        for (int i = 0; i < dtHeader.Columns.Count; i++)
                            drHerder[i] = 0;

                        dtHeader.Rows.Add(drHerder);
                        dtHeader.AcceptChanges();
                    }

                    sbRecord.Append("</tr>");

                    #endregion

                    strPath = AppDomain.CurrentDomain.BaseDirectory + @"temp\" + strReportSchedulerName + System.DateTime.Now.ToString("MMddyyhhmmss") + ".xls";

                    if (!File.Exists(strPath))
                    {
                        if (!Directory.Exists(AppDomain.CurrentDomain.BaseDirectory + @"temp\"))
                            Directory.CreateDirectory(AppDomain.CurrentDomain.BaseDirectory + @"temp\");
                        // Create a file to write to.
                        //Remove WhiteSpace
                        sbRecord.Replace("<tr></tr>", "");
                        File.SetAttributes(AppDomain.CurrentDomain.BaseDirectory, FileAttributes.Normal);
                        using (StreamWriter sw = File.CreateText(strPath))
                        {
                            sw.Write(sbRecord.ToString());
                            sbRecord = new StringBuilder(string.Empty);
                        }
                    }

                    #region "Item Template"

                    DataTable dtSubTotalFirstGroup = dtHeader.Clone();
                    DataTable dtSubTotalSecondGroup = dtHeader.Clone();
                    DataTable dtSubTotalThirdGroup = dtHeader.Clone();

                    string strGroupByValue_1 = string.Empty, strGroupByValue_2 = string.Empty, strNOGroup1 = string.Empty, strNOGroup2 = string.Empty;
                    string strGroupByValue_3 = string.Empty, strNOGroup3 = string.Empty;

                    do
                    {
                        string strFormat = string.Empty;

                        #region "SUBTOTALS"

                        #region Third

                        // print subtotal for 3rd group by when the value is changed
                        if (!string.IsNullOrEmpty(strThirdGroupBy) && !string.IsNullOrEmpty(strGroupByValue_3) && strGroupByValue_3 != Convert.ToString(Reader[strThirdGroupBy]))
                        {
                            if (dtSubTotalThirdGroup.Rows.Count > 0)
                            {
                                sbRecord.Append("<tr>");
                                int intCol = 1;
                                if (dtSchema.Rows.Count > 0)
                                    sbRecord.Append("<td><b>Sub Total For " + strThirdGroupBy + "</b></td>");
                                foreach (DataRow drSchema in dtSchema.Rows)
                                {
                                    string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();

                                    if (strFirstGroupBy != strColName && strSecGroupBy != strColName && strThirdGroupBy != strColName)
                                    {
                                        if (dtSubTotalThirdGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                                            sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalThirdGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                                        else
                                        {
                                            sbRecord.Append("<td>&nbsp;</td>");
                                        }
                                    }

                                    intCol++;
                                }

                                sbRecord.Append("</tr>");
                                dtSubTotalThirdGroup.Clear();
                            }
                        }

                        #endregion

                        #region Second

                        // print subtotal for 2nd group by when the value is changed
                        if (!string.IsNullOrEmpty(strSecGroupBy) && !string.IsNullOrEmpty(strGroupByValue_2) && strGroupByValue_2 != Convert.ToString(Reader[strSecGroupBy]))
                        {
                            if (dtSubTotalSecondGroup.Rows.Count > 0)
                            {
                                sbRecord.Append("<tr>");
                                int intCol = 1;
                                if (dtSchema.Rows.Count > 0)
                                    sbRecord.Append("<td><b>Sub Total For " + strSecGroupBy + "</b></td>");
                                foreach (DataRow drSchema in dtSchema.Rows)
                                {
                                    string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();

                                    if (strFirstGroupBy != strColName && strSecGroupBy != strColName && strThirdGroupBy != strColName)
                                    {
                                        if (dtSubTotalSecondGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                                            sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalSecondGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                                        else
                                        {
                                            sbRecord.Append("<td>&nbsp;</td>");
                                        }
                                    }

                                    intCol++;
                                }

                                sbRecord.Append("</tr>");
                                dtSubTotalSecondGroup.Clear();
                            }
                        }

                        #endregion

                        #region First
                        // print subtotal for 1st group by when the value is changed
                        if (!string.IsNullOrEmpty(strFirstGroupBy) && !string.IsNullOrEmpty(strGroupByValue_1) && strGroupByValue_1 != Convert.ToString(Reader[strFirstGroupBy]))
                        {
                            if (dtSubTotalFirstGroup.Rows.Count > 0)
                            {
                                sbRecord.Append("<tr>");
                                int intCol = 1;
                                if (dtSchema.Rows.Count > 0)
                                    sbRecord.Append("<td><b>Sub Total For " + strFirstGroupBy + "</b></td>");
                                foreach (DataRow drSchema in dtSchema.Rows)
                                {
                                    string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();

                                    if (strFirstGroupBy != strColName && strSecGroupBy != strColName && strThirdGroupBy != strColName)
                                    {
                                        if (dtSubTotalFirstGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                                            sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalFirstGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                                        else
                                        {
                                            sbRecord.Append("<td>&nbsp;</td>");
                                        }
                                    }

                                    intCol++;
                                }

                                sbRecord.Append("</tr>");
                                dtSubTotalFirstGroup.Clear();
                            }
                        }
                        #endregion

                        #endregion

                        #region Group By

                        #region First Group

                        if (!string.IsNullOrEmpty(strFirstGroupBy))
                        {
                            if (strGroupByValue_1 != Convert.ToString(Reader[strFirstGroupBy]))
                            {
                                strGroupByValue_1 = Convert.ToString(Reader[strFirstGroupBy]);
                                if (strFormatFirstGroupBy == "decimal")
                                    sbRecord.Append("<tr><td style='font-weight: bold;color: #FF9C09;' align='right'>&nbsp;" + strFirstGroupBy + ": " + string.Format("{0:c2}", strGroupByValue_1) + "</td></tr>");
                                else if (strFormatFirstGroupBy == "datetime")
                                {
                                    // it display only Time
                                    if (strFirstGroupBy == "Time Theft Reported")
                                        sbRecord.Append("<tr><td style='font-weight: bold;color: #FF9C09;'>&nbsp;" + strFirstGroupBy + ": " + string.Format("{0:HH:mm}", Reader[strFirstGroupBy]) + "</td></tr>");
                                    else sbRecord.Append("<tr><td style='font-weight: bold;color: #FF9C09;'>&nbsp;" + strFirstGroupBy + ": " + FormatDBNullDateToDisplay(strGroupByValue_1) + "</td></tr>");
                                }
                                else sbRecord.Append("<tr><td style='font-weight: bold;color: #FF9C09;'>&nbsp;" + strFirstGroupBy + ": " + strGroupByValue_1 + "</td></tr>");
                                //Change Second Group By when First Groupby is Change
                                strGroupByValue_2 = string.Empty;
                            }
                            // it will set No : [First Group By] when it is null
                            else if ((Reader[strFirstGroupBy] == DBNull.Value || string.IsNullOrEmpty(Convert.ToString(Reader[strFirstGroupBy]))) && strNOGroup1 == string.Empty)
                            {
                                strNOGroup1 = "No " + strFirstGroupBy;
                                sbRecord.Append("<tr><td style='font-weight: bold;color: #FF9C09;' >&nbsp;" + strFirstGroupBy + ": " + strNOGroup1 + "</td></tr>");
                                // When Group by 1 value find as Null
                                strNOGroup1 = strFirstGroupBy;
                                //Change Second Group By when First Groupby is Change
                                strGroupByValue_2 = string.Empty;
                            }
                        }

                        #endregion

                        #region Second Group By

                        if (!string.IsNullOrEmpty(strSecGroupBy))
                        {
                            if (strGroupByValue_2 != Convert.ToString(Reader[strSecGroupBy]))
                            {
                                strGroupByValue_2 = Convert.ToString(Reader[strSecGroupBy]);
                                if (strFormatSecGroupBy == "decimal")
                                    sbRecord.Append("<tr><td style='font-weight: bold;color: #276692;' align='right' >&nbsp;" + strSecGroupBy + ": " + string.Format("{0:c2}", strGroupByValue_2) + "</td></tr>");
                                else if (strFormatSecGroupBy == "datetime")
                                {
                                    // it display only Time
                                    if (strSecGroupBy == "Time Theft Reported")
                                        sbRecord.Append("<tr><td style='font-weight: bold;color: #276692;'>&nbsp;" + strSecGroupBy + ": " + string.Format("{0:HH:mm}", Reader[strSecGroupBy]) + "</td></tr>");
                                    else sbRecord.Append("<tr><td style='font-weight: bold;color: #276692;' >&nbsp;" + strSecGroupBy + ": " + FormatDBNullDateToDisplay(strGroupByValue_2) + "</td></tr>");
                                }
                                else sbRecord.Append("<tr><td style='font-weight: bold;color: #276692;' >&nbsp;" + strSecGroupBy + ": " + strGroupByValue_2 + "</td></tr>");
                            }
                            else if (Reader[strSecGroupBy] == DBNull.Value && strNOGroup2 == string.Empty)
                            {
                                strNOGroup2 = "No " + strSecGroupBy;
                                sbRecord.Append("<tr><td style='font-weight: bold;color: #276692;' >&nbsp;" + strSecGroupBy + ": " + strNOGroup2 + "</td></tr>");
                                //No Group by assign
                                strNOGroup2 = strGroupByValue_2;
                            }
                        }

                        #endregion

                        #region Third Group BY

                        if (!string.IsNullOrEmpty(strThirdGroupBy))
                        {
                            if (strGroupByValue_3 != Convert.ToString(Reader[strThirdGroupBy]))
                            {
                                strGroupByValue_3 = Convert.ToString(Reader[strThirdGroupBy]);
                                if (strFormatThirdGroupBy == "decimal")
                                    sbRecord.Append("<tr><td style='font-weight: bold;color: #603311;' align='right' >&nbsp;" + strThirdGroupBy + ": " + string.Format("{0:c2}", strGroupByValue_3) + "</td></tr>");
                                else if (strFormatThirdGroupBy == "datetime")
                                {
                                    // it display only Time
                                    if (strThirdGroupBy == "Time Theft Reported")
                                        sbRecord.Append("<tr><td style='font-weight: bold;color: #603311;'>&nbsp;" + strThirdGroupBy + ": " + string.Format("{0:HH:mm}", Reader[strThirdGroupBy]) + "</td></tr>");
                                    else sbRecord.Append("<tr><td style='font-weight: bold;color: #603311;' >&nbsp;" + strThirdGroupBy + ": " + FormatDBNullDateToDisplay(strGroupByValue_3) + "</td></tr>");
                                }
                                else sbRecord.Append("<tr><td style='font-weight: bold;color: #603311;' >&nbsp;" + strThirdGroupBy + ": " + strGroupByValue_3 + "</td></tr>");
                            }
                            else if ((Reader[strThirdGroupBy] == DBNull.Value || string.IsNullOrEmpty(Convert.ToString(Reader[strThirdGroupBy]))) && strNOGroup3 == string.Empty)
                            {
                                strNOGroup3 = "No " + strThirdGroupBy;
                                sbRecord.Append("<tr><td style='font-weight: bold;color: #603311;' >&nbsp;" + strThirdGroupBy + ": " + strNOGroup3 + "</td></tr>");
                                // When Group by 3 value find as Null
                                strNOGroup3 = strThirdGroupBy;
                                //Change third Group By when 3rd Groupby is Change
                                strGroupByValue_3 = string.Empty;
                            }
                        }

                        #endregion

                        #endregion

                        string strColumnName = string.Empty;
                        sbRecord.Append("<tr>");
                        if (IsGroupBySelected)
                            sbRecord.Append("<td>&nbsp;</td>");
                        ///Print Records
                        //for (int intColumn = 0; intColumn < Reader.FieldCount - 1; intColumn++)
                        for (int intColumn = 0; intColumn <= Reader.FieldCount - 1; intColumn++)
                        {
                            #region " Count Sub Totals"
                            #region First : 1st
                            if (!string.IsNullOrEmpty(strFirstGroupBy) && !string.IsNullOrEmpty(strGroupByValue_1))
                            {
                                if (dtSubTotalFirstGroup.Columns.Contains(Reader.GetName(intColumn)) && Convert.ToString(Reader[strFirstGroupBy]) == strGroupByValue_1)
                                {
                                    if (dtSubTotalFirstGroup.Rows.Count == 0)
                                    {
                                        dtSubTotalFirstGroup.Rows.Add(dtSubTotalFirstGroup.NewRow());
                                        foreach (DataColumn dcTotal in dtSubTotalFirstGroup.Columns)
                                            dtSubTotalFirstGroup.Rows[0][dcTotal] = 0;
                                    }
                                    decimal decTotal = 0;
                                    decTotal = Convert.ToDecimal(dtSubTotalFirstGroup.Rows[0][Reader.GetName(intColumn)]);
                                    decTotal += Reader.IsDBNull(intColumn) ? 0 : Convert.ToDecimal(Reader[intColumn]);
                                    dtSubTotalFirstGroup.Rows[0][Reader.GetName(intColumn)] = decTotal;
                                }
                            }
                            #endregion

                            #region  second: 2nd

                            if (!string.IsNullOrEmpty(strSecGroupBy) && !string.IsNullOrEmpty(strGroupByValue_2))
                            {
                                if (dtSubTotalSecondGroup.Columns.Contains(Reader.GetName(intColumn)) && Convert.ToString(Reader[strSecGroupBy]) == strGroupByValue_2)
                                {
                                    if (dtSubTotalSecondGroup.Rows.Count == 0)
                                    {
                                        dtSubTotalSecondGroup.Rows.Add(dtSubTotalSecondGroup.NewRow());
                                        foreach (DataColumn dcTotal in dtSubTotalSecondGroup.Columns)
                                            dtSubTotalSecondGroup.Rows[0][dcTotal] = 0;
                                    }
                                    decimal decTotal = 0;
                                    decTotal = Convert.ToDecimal(dtSubTotalSecondGroup.Rows[0][Reader.GetName(intColumn)]);
                                    decTotal += Reader.IsDBNull(intColumn) ? 0 : Convert.ToDecimal(Reader[intColumn]);
                                    dtSubTotalSecondGroup.Rows[0][Reader.GetName(intColumn)] = decTotal;
                                }
                            }

                            #endregion

                            #region Third : 3nd

                            //if (!string.IsNullOrEmpty(strThirdGroupBy) && !string.IsNullOrEmpty(strGroupByValue_3))
                            if ((strThirdGroupBy != null) && (strGroupByValue_3 != null))
                            {
                                if (dtSubTotalThirdGroup.Columns.Contains(Reader.GetName(intColumn)) && Convert.ToString(Reader[strThirdGroupBy]) == strGroupByValue_3)
                                {
                                    if (dtSubTotalThirdGroup.Rows.Count == 0)
                                    {
                                        dtSubTotalThirdGroup.Rows.Add(dtSubTotalThirdGroup.NewRow());
                                        foreach (DataColumn dcTotal in dtSubTotalThirdGroup.Columns)
                                            dtSubTotalThirdGroup.Rows[0][dcTotal] = 0;
                                    }
                                    decimal decTotal = 0;
                                    decTotal = Convert.ToDecimal(dtSubTotalThirdGroup.Rows[0][Reader.GetName(intColumn)]);
                                    decTotal += Reader.IsDBNull(intColumn) ? 0 : Convert.ToDecimal(Reader[intColumn]);
                                    dtSubTotalThirdGroup.Rows[0][Reader.GetName(intColumn)] = decTotal;
                                }
                            }

                            #endregion

                            #endregion

                            //Remove Group By Column
                            #region

                            if (strFirstGroupBy != Convert.ToString(dtSchema.Rows[intColumn]["ColumnName"]) && strSecGroupBy != Convert.ToString(dtSchema.Rows[intColumn]["ColumnName"]) && strThirdGroupBy != Convert.ToString(dtSchema.Rows[intColumn]["ColumnName"]))
                            {
                                strFormat = dtSchema.Rows[intColumn]["DataTypeName"].ToString();

                                if (strFormat == "decimal")
                                {
                                    // If dataType is Numeric but it is not Currency field.
                                    if (CheckISdisplayCurrencyFormat(dtSchema.Rows[intColumn][0].ToString()))
                                        sbRecord.Append("<td align='right' >&nbsp;" + string.Format("{0:c2}", Reader[intColumn]) + "</td>");
                                    else
                                        sbRecord.Append("<td align='right' >&nbsp;" + Convert.ToString(Reader[intColumn]) + "</td>");
                                }
                                else if (strFormat == "datetime")
                                {
                                    // it display only Time
                                    if (Convert.ToString(dtSchema.Rows[intColumn]["ColumnName"]) == "Time Theft Reported")
                                        sbRecord.Append("<td >&nbsp;" + string.Format("{0:HH:mm}", Reader[intColumn]) + "</td>");
                                    else sbRecord.Append("<td >&nbsp;" + string.Format("{0:MM/dd/yyyy}", Reader[intColumn]) + "</td>");
                                }
                                else
                                {
                                    //sbRecord.Append(@"<td style='mso-number-format:\@;'>&nbsp;" + Convert.ToString(Reader[intColumn]) + "</td>");
                                    sbRecord.Append(@"<td>&nbsp;" + Convert.ToString(Reader[intColumn]) + "</td>");
                                }
                            }

                            #endregion
                        }

                        sbRecord.Append("</tr>");

                        using (StreamWriter sw = File.AppendText(strPath))
                        {
                            sw.Write(sbRecord);
                            sbRecord = new StringBuilder(string.Empty);
                        }
                    } while (Reader.Read());

                    #region " SUBTOAL FOR Last groups "

                    if (dtSubTotalThirdGroup.Rows.Count > 0)
                    {
                        sbRecord.Append("<tr>");
                        int intCol = 1;
                        if (dtSchema.Rows.Count > 0)
                            sbRecord.Append("<td align='left'><b>Sub Total For " + strThirdGroupBy + "</b></td>");
                        foreach (DataRow drSchema in dtSchema.Rows)
                        {
                            string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();
                            if (strFirstGroupBy != strColName && strSecGroupBy != strColName && strThirdGroupBy != strColName)
                            {
                                if (dtSubTotalThirdGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                                    sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalThirdGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                                else
                                {
                                    sbRecord.Append("<td>&nbsp;</td>");
                                }
                            }
                            intCol++;
                        }
                        sbRecord.Append("</tr>");
                        dtSubTotalThirdGroup.Clear();
                    }

                    if (dtSubTotalSecondGroup.Rows.Count > 0)
                    {
                        sbRecord.Append("<tr>");
                        int intCol = 1;
                        if (dtSchema.Rows.Count > 0)
                            sbRecord.Append("<td align='left'><b>Sub Total For " + strSecGroupBy + "</b></td>");
                        foreach (DataRow drSchema in dtSchema.Rows)
                        {
                            string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();
                            if (strFirstGroupBy != strColName && strSecGroupBy != strColName)
                            {
                                if (dtSubTotalSecondGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                                    sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalSecondGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                                else
                                {
                                    sbRecord.Append("<td>&nbsp;</td>");
                                }
                            }
                            intCol++;
                        }
                        sbRecord.Append("</tr>");
                        dtSubTotalSecondGroup.Clear();
                    }

                    if (dtSubTotalFirstGroup.Rows.Count > 0)
                    {
                        sbRecord.Append("<tr>");
                        int intCol = 1;
                        if (dtSchema.Rows.Count > 0)
                            sbRecord.Append("<td align='left'><b>Sub Total For " + strFirstGroupBy + "</b></td>");
                        foreach (DataRow drSchema in dtSchema.Rows)
                        {
                            string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();
                            if (strFirstGroupBy != strColName && strSecGroupBy != strColName)
                            {
                                if (dtSubTotalFirstGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                                    sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalFirstGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                                else
                                {
                                    sbRecord.Append("<td>&nbsp;</td>");
                                }
                            }
                            intCol++;
                        }
                        sbRecord.Append("</tr>");
                        dtSubTotalFirstGroup.Clear();
                    }

                    #endregion

                    #endregion

                    //Table End
                    sbRecord.Append("</table>");

                    //Remove White Space.
                    //sbRecord.Replace("<tr></tr>", "");
                    using (StreamWriter sw = File.AppendText(strPath))
                    {
                        sw.Write(sbRecord);
                        sbRecord = new StringBuilder(string.Empty);
                    }
                }
                else
                {
                    //Remove WhiteSpace
                    sbRecord.Replace("<tr></tr>", "");
                    if (!Directory.Exists(AppDomain.CurrentDomain.BaseDirectory + @"temp\"))
                        Directory.CreateDirectory(AppDomain.CurrentDomain.BaseDirectory + @"temp\");

                    strPath = AppDomain.CurrentDomain.BaseDirectory + @"temp\" + strReportSchedulerName + System.DateTime.Now.ToString("MMddyyhhmmss") + ".xls";
                    ///When records are not found.
                    sbRecord.Append("<table  cellpadding='4' cellspacing='0' Width='100%'>");
                    sbRecord.Append("<tr>");
                    sbRecord.Append("<td align='center'>No Record found.</td></tr></table>");
                    using (StreamWriter sw = File.AppendText(strPath))
                    {
                        sw.Write(sbRecord);
                        sbRecord = new StringBuilder(string.Empty);
                    }
                }

                if (!Reader.IsClosed)
                    Reader.Close();

                return strPath;
            }
            catch (Exception ex)
            {
                //EventLog.WriteEntry("ERROR in Ad Hoc Report Writer , " + ex.Message);
                EventLog.WriteEntry("ERROR in Construction Ad Hoc Report Writer , " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
            finally
            {
                if (Reader != null)
                {
                    Reader.Close();
                    Reader.Dispose();
                }
                if (dtSchema != null)
                    dtSchema.Dispose();
                if (dtHeader != null)
                    dtHeader.Dispose();
            }
            return strPath;
        }

        #endregion

        #region "Safety Training Ad-hoc methods"
        /// <summary>
        /// Bind and return Group By String
        /// </summary>
        /// <param name="ObjAdHocReport"></param>
        /// <returns></returns>
        private string BindGroupBy(ERIMS_DAL.Sonic_U_Train_AdHocReport ObjAdHocReport)
        {
            string strGroupBy = string.Empty;
            Sonic_U_Train_AdhocReportFields objReportFields = new Sonic_U_Train_AdhocReportFields();
            List<Sonic_U_Train_AdhocReportFields> lstAdhoc = null;

            if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.FirstGroupBy)))
            {
                if (ObjAdHocReport.FirstGroupBy == -2)
                {
                    strGroupBy = "[Accident Year] " + ObjAdHocReport.FirstGroupByOrder;
                }
                else
                {
                    lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.FirstGroupBy));
                    strGroupBy = " [" + lstAdhoc[0].Field_Header + "] " + ObjAdHocReport.FirstGroupByOrder;
                }
            }

            if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.SecondGroupBy)))
            {
                if (ObjAdHocReport.SecondGroupBy == -3)
                {
                    strGroupBy += (string.IsNullOrEmpty(strGroupBy) ? "" : ",") + "Accident Year" + ObjAdHocReport.SecondGroupByOrder;
                }
                else
                {
                    lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.SecondGroupBy));
                    strGroupBy += (string.IsNullOrEmpty(strGroupBy) ? "" : ",") + " [" + lstAdhoc[0].Field_Header + "] " + ObjAdHocReport.SecondGroupByOrder;
                }
            }

            return strGroupBy;
        }

        /// <summary>
        /// Bind and return Order By String
        /// </summary>
        /// <param name="ObjAdHocReport"></param>
        /// <returns></returns>
        private string BindOrderBy(ERIMS_DAL.Sonic_U_Train_AdHocReport ObjAdHocReport)
        {
            string strOrderBy = string.Empty;
            Sonic_U_Train_AdhocReportFields objReportFields = new Sonic_U_Train_AdhocReportFields();
            List<Sonic_U_Train_AdhocReportFields> lstAdhoc = null;
            if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.FirstSortBy)))
            {
                lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.FirstSortBy));
                strOrderBy = " [" + lstAdhoc[0].Field_Header + "] " + ObjAdHocReport.FirstSortByOrder;
            }
            if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.SecondSortBy)))
            {
                lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.SecondSortBy));
                strOrderBy += (string.IsNullOrEmpty(strOrderBy) ? "" : ",") + " [" + lstAdhoc[0].Field_Header + "] " + ObjAdHocReport.SecondGroupByOrder;
            }
            if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.ThirdSortBy)))
            {
                lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.ThirdSortBy));
                strOrderBy += (string.IsNullOrEmpty(strOrderBy) ? "" : ",") + " [" + lstAdhoc[0].Field_Header + "] " + ObjAdHocReport.ThirdSortByOrder;
            }

            return strOrderBy;
        }
        #endregion

        #region "Property Ad-hoc methods"

        /// <summary>
        /// Fill Filter Value from Dropdown
        /// </summary>
        /// <param name="strField_Name"></param>
        /// <param name="strConValue"></param>
        /// <returns></returns>
        public static string FillFilterDropDownForProperty(string strField_Name, string strConValue)
        {
            try
            {              
                string strRecord = string.Empty;
               
                if (strField_Name == "Building Improvement-Status")
                {
                    if (!string.IsNullOrEmpty(strConValue))
                        strRecord = GetCommaValueFromTable(Report.LuTableSelectByIDs("LU_BI_Status", strConValue, "Fld_Desc"), "Fld_Desc");
                }
                else
                {
                    if (!string.IsNullOrEmpty(strConValue))
                    {
                        string[] arrConditionValue = strConValue.Split(',');
                        for (int intj = 0; intj < arrConditionValue.Length; intj++)
                        {
                            if (arrConditionValue[intj] == "'1'" || arrConditionValue[intj] == "'Y'")
                            {
                                    strRecord += "Yes,";                             
                            }
                            else if (arrConditionValue[intj] == "'0'" || arrConditionValue[intj] == "'N'")
                            {
                               
                                    strRecord += "No,";                              
                            }                       
                            else
                                strRecord += arrConditionValue[intj]+",";
                        }
                        strRecord = strRecord.TrimEnd(',');
                    }
                }
                return strRecord;
            }
            catch (Exception e)
            {
                throw e;
            }
        }

        /// <summary>
        /// Bind and return Group By String
        /// </summary>
        /// <param name="ObjAdHocReport"></param>
        /// <returns></returns>
        private string BindGroupBy(ERIMS_DAL.Property_AdHocReport ObjAdHocReport)
        {
            string strGroupBy = string.Empty;
            Property_AdhocReportFields objReportFields = new Property_AdhocReportFields();
            List<Property_AdhocReportFields> lstAdhoc = null;

            if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.FirstGroupBy)))
            {
                if (ObjAdHocReport.FirstGroupBy == -2)
                {
                    strGroupBy = "[Accident Year] " + ObjAdHocReport.FirstGroupByOrder;
                }
                else
                {
                    lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.FirstGroupBy));
                    strGroupBy = " [" + lstAdhoc[0].Field_Header + "] " + ObjAdHocReport.FirstGroupByOrder;
                }
            }

            if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.SecondGroupBy)))
            {
                if (ObjAdHocReport.SecondGroupBy == -3)
                {
                    strGroupBy += (string.IsNullOrEmpty(strGroupBy) ? "" : ",") + "Accident Year" + ObjAdHocReport.SecondGroupByOrder;
                }
                else
                {
                    lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.SecondGroupBy));
                    strGroupBy += (string.IsNullOrEmpty(strGroupBy) ? "" : ",") + " [" + lstAdhoc[0].Field_Header + "] " + ObjAdHocReport.SecondGroupByOrder;
                }
            }

            return strGroupBy;
        }

        /// <summary>
        /// Bind and return Order By String
        /// </summary>
        /// <param name="ObjAdHocReport"></param>
        /// <returns></returns>
        private string BindOrderBy(ERIMS_DAL.Property_AdHocReport ObjAdHocReport)
        {
            string strOrderBy = string.Empty;
            Property_AdhocReportFields objReportFields = new Property_AdhocReportFields();
            List<Property_AdhocReportFields> lstAdhoc = null;
            if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.FirstSortBy)))
            {
                lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.FirstSortBy));
                strOrderBy = " [" + lstAdhoc[0].Field_Header + "] " + ObjAdHocReport.FirstSortByOrder;
            }
            if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.SecondSortBy)))
            {
                lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.SecondSortBy));
                strOrderBy += (string.IsNullOrEmpty(strOrderBy) ? "" : ",") + " [" + lstAdhoc[0].Field_Header + "] " + ObjAdHocReport.SecondGroupByOrder;
            }
            if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.ThirdSortBy)))
            {
                lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.ThirdSortBy));
                strOrderBy += (string.IsNullOrEmpty(strOrderBy) ? "" : ",") + " [" + lstAdhoc[0].Field_Header + "] " + ObjAdHocReport.ThirdSortByOrder;
            }

            return strOrderBy;
        }

          /// <summary>
        /// Bind and Return Where Condition
        /// </summary>
        /// <param name="lstFilter"></param>
        /// <returns></returns>
        private string GetWhereConditionForProperty(List<ERIMS_DAL.Property_AdHocFilter> lstFilter)
        {
            string strWhere = string.Empty;
            for (int i = 0; i < lstFilter.Count; i++)
            {
                Property_AdhocReportFields obj = new Property_AdhocReportFields();
                List<Property_AdhocReportFields> lstAdhoc = obj.GetAdHocReportFieldByPk(Convert.ToDecimal(lstFilter[i].FK_AdHocReportFields));
                string strConditionType = lstFilter[i].ConditionType;
                string strConditionValue = lstFilter[i].ConditionValue;
                string strField = lstAdhoc[0].WhereField;

                string strCntrolType = lstFilter[i].Fk_ControlType.ToString();

                if (lstFilter[i].Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.TextBox)
                {
                    strWhere += BindTextCondition(lstFilter[i].ConditionType, lstFilter[i].ConditionValue, lstAdhoc[0].Field_Name, lstAdhoc[0].Table_Name, false);
                }
                else if (lstFilter[i].Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.MultiSelectList && lstFilter[i].ConditionValue != null || lstFilter[i].Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.MultiSelectTextList && lstFilter[i].ConditionValue != null)
                {
                    strWhere += BindDropDownCondition(lstFilter[i].ConditionType, lstFilter[i].ConditionValue, lstAdhoc[0].WhereField, lstAdhoc[0].Table_Name, false);

                }
                else if (lstFilter[i].Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.DateControl)
                {
                    strWhere += BindDateConditionForProperty(lstFilter[i], lstAdhoc[0].Field_Name, lstAdhoc[0].Table_Name, false);
                }
                else if (lstFilter[i].Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.AmountControl)
                {
                    strWhere += BindAmountConditionForProperty(lstFilter[i], lstFilter[i].ConditionType, lstFilter[i].ConditionValue, lstAdhoc[0].Field_Name, lstAdhoc[0].Table_Name, false);
                }
            }
            return strWhere;
        }

         /// <summary>
        /// Bind and Return DateTime Type Condition
        /// </summary>
        /// <param name="lstFilter"></param>
        /// <returns></returns>
        private string BindDateConditionForProperty(ERIMS_DAL.Property_AdHocFilter objFilter, string strField, string strTableName, bool IsNotSelected)
        {
            string strWhere = string.Empty;

            DateTime? dtFrom = null, dtTo = null;

            if (string.IsNullOrEmpty(objFilter.FromRelativeCriteria))
                dtFrom = FormatNullDateToStore(Convert.ToString(objFilter.FromDate));
            else
            {
                // set Relative Date From criteria
                AdHocReportHelper.RaltiveDates RelType = (AdHocReportHelper.RaltiveDates)Enum.Parse(typeof(AdHocReportHelper.RaltiveDates), objFilter.FromRelativeCriteria);
                dtFrom = AdHocReportHelper.GetRelativeDate(RelType);
            }
            if (string.IsNullOrEmpty(objFilter.ToRelativeCriteria))
                dtTo = FormatNullDateToStore(Convert.ToString(objFilter.ToDate));
            else
            {
                // set Relative Date To criteria
                AdHocReportHelper.RaltiveDates RelType = (AdHocReportHelper.RaltiveDates)Enum.Parse(typeof(AdHocReportHelper.RaltiveDates), objFilter.ToRelativeCriteria);
                dtTo = AdHocReportHelper.GetRelativeDate(RelType);
            }

            AdHocReportHelper.DateCriteria DtType = AdHocReportHelper.DateCriteria.On;

            if (objFilter.ConditionType == "On")
                DtType = AdHocReportHelper.DateCriteria.On;
            else if (objFilter.ConditionType == "BF")
                DtType = AdHocReportHelper.DateCriteria.Before;
            else if (objFilter.ConditionType == "A")
                DtType = AdHocReportHelper.DateCriteria.After;
            else if (objFilter.ConditionType == "B")
                DtType = AdHocReportHelper.DateCriteria.Between;
            else if (objFilter.ConditionType == "IN")
            {
                DtType = AdHocReportHelper.DateCriteria.Is_Null;
                dtFrom = null;
                dtTo = null;

                if (IsNotSelected)
                    strWhere = " AND " + strTableName + ".[" + strField + "]" + " IS NOT NULL";
                else
                    strWhere = " AND " + strTableName + ".[" + strField + "]" + " IS NULL";
            }

            if (dtFrom.HasValue)
                strWhere = AdHocReportHelper.GetDateWhereAbsolute(strTableName + ".[" + strField.Replace("[","").Replace("]","") + "]", dtFrom, dtTo, DtType, IsNotSelected);

            else if (dtTo.HasValue)
                strWhere = AdHocReportHelper.GetDateWhereAbsolute(strTableName + ".[" + strField.Replace("[", "").Replace("]", "") + "]", dtFrom, dtTo, DtType, IsNotSelected);
            return strWhere;
        }

        /// <summary>
        /// Bind and Return Amount Type Condition
        /// </summary>
        /// <param name="lstFilter"></param>
        /// <returns></returns>
        private string BindAmountConditionForProperty(ERIMS_DAL.Property_AdHocFilter objFilter, string strConditionType, string strConditionValue, string strField, string strTableName, bool IsNotSelected)
        {
            string strWhere = string.Empty;
            AdHocReportHelper.AmountCriteria AmtType = AdHocReportHelper.AmountCriteria.Equal;

            decimal? dFrom = null;
            decimal? dTo = null;

            if (!string.IsNullOrEmpty(Convert.ToString(objFilter.AmountFrom)))
                dFrom = Convert.ToDecimal(objFilter.AmountFrom);

            if (!string.IsNullOrEmpty(Convert.ToString(objFilter.AmountTo)))
                dTo = Convert.ToDecimal(objFilter.AmountTo);

            if (Convert.ToInt16(objFilter.ConditionType) == (int)AdHocReportHelper.AmountCriteria.Equal)
                AmtType = AdHocReportHelper.AmountCriteria.Equal;
            else if (Convert.ToInt16(objFilter.ConditionType) == (int)AdHocReportHelper.AmountCriteria.GreaterThan)
                AmtType = AdHocReportHelper.AmountCriteria.GreaterThan;
            else if (Convert.ToInt16(objFilter.ConditionType) == (int)AdHocReportHelper.AmountCriteria.Between)
                AmtType = AdHocReportHelper.AmountCriteria.Between;
            else if (Convert.ToInt16(objFilter.ConditionType) == (int)AdHocReportHelper.AmountCriteria.LessThan)
                AmtType = AdHocReportHelper.AmountCriteria.LessThan;

            if (dFrom.HasValue)
                strWhere = AdHocReportHelper.GetAmountWhere("[" + strTableName.Trim() + "]" + "." + "[" + strField.Trim() + "]", dFrom, dTo, AmtType, IsNotSelected);
            else if (dTo.HasValue)
                strWhere = AdHocReportHelper.GetAmountWhere("[" + strTableName.Trim() + "]", dFrom, dTo, AmtType, IsNotSelected);

            return strWhere;
        }

        /// <summary>
        /// Bind Report Data.
        /// </summary>
        /// <param name="dsReport">Report Dataset</param>
        private string BindReportForProperty(ref StringBuilder sbRecord, IDataReader Reader, ERIMS_DAL.Property_AdHocReport ObjAdHocReport, List<ERIMS_DAL.Property_AdHocFilter> lstFilter, string strReportSchedulerName)
        {
            DataTable dtSchema = null, dtHeader = null;
            Property_AdhocReportFields objReportFields = new Property_AdhocReportFields();
            List<Property_AdhocReportFields> lstAdhoc = null;
            string strPath = string.Empty;
            Boolean IsGroupBySelected = false;
            Int32 countColumn = 0;

            try
            {
                #region "Filter and Title"
                sbRecord.Append("<html><head><meta charset = 'utf-8'></head><body><table cellpadding='0' cellspacing='0' style='font-size:10pt'>");
                sbRecord.Append("<tr><td colspan='3'><b>Report Title : " + strReportSchedulerName + " </b></td></tr><tr><td colspan='8'>&nbsp;</td></tr>");
                //sbRecord.Append("<br /><br />");

                Property_AdhocReportFields obj = new Property_AdhocReportFields();
                for (int i = 0; i < lstFilter.Count; i++)
                {
                    string strConditionVal = string.Empty;
                    if (lstFilter[i].Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.TextBox)
                    {
                        string strConditionType = lstFilter[i].ConditionType;
                        if (Convert.ToBoolean(lstFilter[i].IsNotSelected) == true)
                            strConditionType = (strConditionType == "1") ? " Not Contains " : (strConditionType == "2" ? " Not Start With " : " Not End With ");
                        else
                            strConditionType = (strConditionType == "1") ? " Contains " : (strConditionType == "2" ? " Start With " : " End With ");
                        strConditionVal = lstFilter[i].ConditionValue;
                        lstAdhoc = obj.GetAdHocReportFieldByPk(Convert.ToDecimal(lstFilter[i].FK_AdHocReportFields));
                        sbRecord.Append("<tr><td colspan='3'><b>" + lstAdhoc[0].Field_Header + " : " + strConditionType + "</b>" + lstFilter[i].ConditionValue + "</td></tr>");
                    }

                    if (lstFilter[i].Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.MultiSelectList || lstFilter[i].Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.MultiSelectTextList)
                    {
                        lstAdhoc = obj.GetAdHocReportFieldByPk(Convert.ToDecimal(lstFilter[i].FK_AdHocReportFields));
                        string filterValue = FillFilterDropDownForProperty(lstAdhoc[0].Field_Header, lstFilter[i].ConditionValue).Replace("\"", " ").Replace(">", "&gt;").Replace("<", "&lt;");
                        //string filterValue = FillFilterDropDownForProperty(lstAdhoc[0].Field_Header, lstFilter[i].ConditionValue);
                        if (Convert.ToBoolean(lstFilter[i].IsNotSelected) == true)
                            sbRecord.Append("<tr><td colspan='3'><b>" + lstAdhoc[0].Field_Header + " (Not In)</b>" + " : " + filterValue + "</td></tr>");
                        else
                            sbRecord.Append("<tr><td colspan='3'><b>" + lstAdhoc[0].Field_Header + " (In)</b>" + " : " + filterValue + "</td></tr>");
                    }                 

                    if (lstFilter[i].Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.DateControl)
                    {
                        string strConditionType = lstFilter[i].ConditionType;
                        lstAdhoc = obj.GetAdHocReportFieldByPk(Convert.ToDecimal(lstFilter[i].FK_AdHocReportFields));
                        strConditionType = (strConditionType == "O") ? " On " : (strConditionType == "B" ? " Between " : (strConditionType == "BF" ? "On or Before " : "On or After "));

                        string dtFrom = null, dtTo = null;
                        if (string.IsNullOrEmpty(lstFilter[i].FromRelativeCriteria))
                            dtFrom = FormatDBNullDateToDisplay(lstFilter[i].FromDate);
                        else
                        {
                            // set Relative Date From criteria
                            AdHocReportHelper.RaltiveDates RelType = (AdHocReportHelper.RaltiveDates)Enum.Parse(typeof(AdHocReportHelper.RaltiveDates), lstFilter[i].FromRelativeCriteria);
                            dtFrom = AdHocReportHelper.GetRelativeDate(RelType).ToString("MM/dd/yyyy");
                        }
                        if (string.IsNullOrEmpty(lstFilter[i].ToRelativeCriteria))
                            dtTo = FormatDBNullDateToDisplay(lstFilter[i].ToDate);
                        else
                        {
                            // set Relative Date To criteria
                            AdHocReportHelper.RaltiveDates RelType = (AdHocReportHelper.RaltiveDates)Enum.Parse(typeof(AdHocReportHelper.RaltiveDates), lstFilter[i].ToRelativeCriteria);
                            dtTo = AdHocReportHelper.GetRelativeDate(RelType).ToString("MM/dd/yyyy");
                        }

                        if (Convert.ToBoolean(lstFilter[i].IsNotSelected) == true)
                            strConditionType = "Not" + strConditionType;

                        if (strConditionType.Trim() != "Between" && strConditionType.Trim() != "Not Between")
                            strConditionVal = "<tr><td colspan='3'><b>" + lstAdhoc[0].Field_Header + " : " + strConditionType + "</b>" + dtFrom + "</td></tr>";
                        else
                            strConditionVal = "<tr><td colspan='3'><b>" + lstAdhoc[0].Field_Header + " : </b>" + strConditionType + dtFrom + " And " + dtTo + "</td></tr>";

                        sbRecord.Append(strConditionVal);
                    }
                    if (lstFilter[i].Fk_ControlType.Value == (int)AdHocReportHelper.AdHocControlType.AmountControl)
                    {
                        string strConditionType = lstFilter[i].ConditionType;
                        lstAdhoc = obj.GetAdHocReportFieldByPk(Convert.ToDecimal(lstFilter[i].FK_AdHocReportFields));
                        strConditionType = (strConditionType == "0") ? " Equal " : (strConditionType == "1" ? " Greater Than " : (strConditionType == "2" ? " Between " : " Less Than "));

                        if (Convert.ToBoolean(lstFilter[i].IsNotSelected) == true)
                            strConditionType = "Not" + strConditionType;

                        if (strConditionType.Trim() != "Between" && strConditionType.Trim() != "Not Between")
                            strConditionVal = "<tr><td colspan='3'><b>" + lstAdhoc[0].Field_Header + " : " + strConditionType + "</b>" + Convert.ToString(lstFilter[i].AmountFrom) + "</td></tr>";
                        else
                            strConditionVal = "<tr><td colspan='3'><b>" + lstAdhoc[0].Field_Header + " : </b>" + strConditionType + Convert.ToString(lstFilter[i].AmountFrom) + " And " + Convert.ToString(lstFilter[i].AmountTo) + "</td></tr>";
                        sbRecord.Append(strConditionVal);
                    }
                    // sbRecord.Append("<br />");
                }
                //sbRecord.Replace("<1 MIles", "&lt;1 MIles").Replace(">10 Miles", "&gt;10 Miles");
                //sbRecord.Append("<br /></td></tr></table>");
                //sbRecord.Append("<br/>");
                #endregion

                // Check if Any record is exists or not
                if (Reader.Read())
                {
                    string strFirstGroupBy = string.Empty, strSecGroupBy = string.Empty;
                    //, strThirdGroupBy = null, strFourthGroupBy = null, strFifthGroupBy = null;

                    if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.FirstGroupBy)))
                    {
                        if (ObjAdHocReport.FirstGroupBy == -2)
                            strFirstGroupBy = "Accident Year";
                        else
                        {
                            lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.FirstGroupBy));
                            strFirstGroupBy = lstAdhoc[0].Field_Header;
                        }

                        IsGroupBySelected = true;
                    }

                    if (!string.IsNullOrEmpty(Convert.ToString(ObjAdHocReport.SecondGroupBy)))
                    {
                        if (ObjAdHocReport.SecondGroupBy == -3)
                            strSecGroupBy = "Accident Year";
                        else
                        {
                            lstAdhoc = objReportFields.GetAdHocReportFieldByPk(Convert.ToDecimal(ObjAdHocReport.SecondGroupBy));
                            strSecGroupBy = lstAdhoc[0].Field_Header;
                        }

                        IsGroupBySelected = true;
                    }



                    //iF First Group By is Not  selected then second Group by will be set as first Group By
                    if (string.IsNullOrEmpty(strFirstGroupBy))
                    {
                        strFirstGroupBy = strSecGroupBy;
                        strSecGroupBy = string.Empty;
                    }

                    dtSchema = Reader.GetSchemaTable();

                    sbRecord.Append("<tr><td><table border='1' cellpadding='0' cellspacing='0' width='" + (150 * (ObjAdHocReport.OutputFields.Split(',').Length + 1)).ToString() + "' style='font-size:10pt'>");

                    #region "Header"
                    // If reader found a records 
                    sbRecord.Append("<tr>");
                    if (IsGroupBySelected)
                        sbRecord.Append("<td colspan='2'>&nbsp;</td>");
                    dtHeader = new DataTable();
                    string strFormatFirstGroupBy = string.Empty, strFormatSecGroupBy = string.Empty;
                        //, strFormatThirdGroupBy = string.Empty, strFormatFourthGroupBy = string.Empty, strFormatFifthGroupBy = string.Empty;
                    foreach (DataRow drHeader in dtSchema.Rows)
                    {
                        //Remove Group By 
                        if (strFirstGroupBy != Convert.ToString(drHeader["ColumnName"]) && strSecGroupBy != Convert.ToString(drHeader["ColumnName"])) 
                            //&& strThirdGroupBy != Convert.ToString(drHeader["ColumnName"]) && strFourthGroupBy != Convert.ToString(drHeader["ColumnName"]) && strFifthGroupBy != Convert.ToString(drHeader["ColumnName"]))
                        {
                            if (drHeader["ColumnName"].ToString() != "Claim Count")
                            {
                                sbRecord.Append("<td><b>" + drHeader["ColumnName"] + "</b></td>");
                                countColumn++;
                            }

                        }

                        //IF Grand Total Option is Selected.
                        //if (Convert.ToString(ObjAdHocReport.GrandTotal) == "Y" && CheckTotalField(drHeader["ColumnName"].ToString()))
                        //    dtHeader.Columns.Add(new DataColumn(drHeader["ColumnName"].ToString(), Type.GetType("System.Decimal")));

                        //Get  Group By Field's Data Type
                        if (strFirstGroupBy == Convert.ToString(drHeader["ColumnName"]))
                            strFormatFirstGroupBy = drHeader["DataTypeName"].ToString();
                        if (strSecGroupBy == Convert.ToString(drHeader["ColumnName"]))
                            strFormatSecGroupBy = drHeader["DataTypeName"].ToString();
                        //if (strThirdGroupBy == Convert.ToString(drHeader["ColumnName"]))
                        //    strFormatThirdGroupBy = drHeader["DataTypeName"].ToString();
                        //if (strFourthGroupBy == Convert.ToString(drHeader["ColumnName"]))
                        //    strFormatFourthGroupBy = drHeader["DataTypeName"].ToString();
                        //if (strFifthGroupBy == Convert.ToString(drHeader["ColumnName"]))
                        //    strFormatFifthGroupBy = drHeader["DataTypeName"].ToString();

                    }
                    //When Header have records
                    if (dtHeader.Columns.Count > 0)
                    {
                        DataRow drHerder = dtHeader.NewRow();

                        for (int i = 0; i < dtHeader.Columns.Count; i++)
                            drHerder[i] = 0;

                        dtHeader.Rows.Add(drHerder);
                        dtHeader.AcceptChanges();
                    }

                    sbRecord.Append("</tr>");

                    #endregion

                    strPath = AppDomain.CurrentDomain.BaseDirectory + @"temp\" + strReportSchedulerName + System.DateTime.Now.ToString("MMddyyhhmmss") + ".xls";

                    if (!File.Exists(strPath))
                    {
                        if (!Directory.Exists(AppDomain.CurrentDomain.BaseDirectory + @"temp\"))
                            Directory.CreateDirectory(AppDomain.CurrentDomain.BaseDirectory + @"temp\");
                        // Create a file to write to.
                        //Remove WhiteSpace
                        sbRecord.Replace("<tr></tr>", "");
                        File.SetAttributes(AppDomain.CurrentDomain.BaseDirectory, FileAttributes.Normal);
                        using (StreamWriter sw = File.CreateText(strPath))
                        {
                            sw.Write(sbRecord.ToString());
                            sbRecord = new StringBuilder(string.Empty);
                        }
                    }

                    #region "Item Template"

                    DataTable dtSubTotalFirstGroup = dtHeader.Clone();
                    DataTable dtSubTotalSecondGroup = dtHeader.Clone();
                    DataTable dtSubTotalThirdGroup = dtHeader.Clone();
                    DataTable dtSubTotalFourthGroup = dtHeader.Clone();
                    DataTable dtSubTotalFifthGroup = dtHeader.Clone();

                    string strGroupByValue_1 = string.Empty, strGroupByValue_2 = string.Empty, strNOGroup1 = string.Empty, strNOGroup2 = string.Empty;
                    string strGroupByValue_3 = string.Empty, strGroupByValue_4 = string.Empty, strNOGroup3 = string.Empty, strNOGroup4 = string.Empty;
                    string strGroupByValue_5 = string.Empty, strNOGroup5 = string.Empty;

                    do
                    {
                        string strFormat = string.Empty;

                        #region "SUBTOTALS"

                        //#region Fifth
                        //// print subtotal for 5th group by when the value is changed
                        //if (!string.IsNullOrEmpty(strFifthGroupBy) && !string.IsNullOrEmpty(strGroupByValue_5) && strGroupByValue_5 != Convert.ToString(Reader[strFifthGroupBy]))
                        //{
                        //    if (dtSubTotalFifthGroup.Rows.Count > 0)
                        //    {
                        //        sbRecord.Append("<tr>");
                        //        int intCol = 1;
                        //        //first column is for sub total when sub total is found
                        //        if (dtSchema.Rows.Count > 0)
                        //            sbRecord.Append("<td><b>Sub Total For " + strFifthGroupBy + "</b></td>");
                        //        foreach (DataRow drSchema in dtSchema.Rows)
                        //        {
                        //            string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();

                        //            if (strFirstGroupBy != strColName && strSecGroupBy != strColName && strThirdGroupBy != strColName && strFourthGroupBy != strColName && strFifthGroupBy != strColName)
                        //            {
                        //                if (dtSubTotalFifthGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                        //                    sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalFifthGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                        //                else
                        //                {
                        //                    //if (intCol == 1)
                        //                    //    sbRecord.Append("<td><b>Sub Total For " + strFifthGroupBy + "</b></td><td>&nbsp;</td>");
                        //                    //else
                        //                    //{
                        //                    sbRecord.Append("<td>&nbsp;</td>");
                        //                    //}
                        //                }
                        //            }
                        //            intCol++;
                        //        }

                        //        sbRecord.Append("</tr>");
                        //        dtSubTotalFifthGroup.Clear();
                        //    }
                        //}
                        //#endregion

                        //#region Fourth
                        //// print subtotal for 4th group by when the value is changed
                        //if (!string.IsNullOrEmpty(strFourthGroupBy) && !string.IsNullOrEmpty(strGroupByValue_4) && strGroupByValue_4 != Convert.ToString(Reader[strFourthGroupBy]))
                        //{
                        //    if (dtSubTotalFourthGroup.Rows.Count > 0)
                        //    {
                        //        sbRecord.Append("<tr>");
                        //        int intCol = 1;

                        //        if (dtSchema.Rows.Count > 0)
                        //            sbRecord.Append("<td><b>Sub Total For " + strFourthGroupBy + "</b></td>");
                        //        foreach (DataRow drSchema in dtSchema.Rows)
                        //        {
                        //            string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();
                        //            if (strFirstGroupBy != strColName && strSecGroupBy != strColName && strThirdGroupBy != strColName && strFourthGroupBy != strColName && strFifthGroupBy != strColName)
                        //            {

                        //                if (dtSubTotalFourthGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                        //                    sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalFourthGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                        //                else
                        //                {
                        //                    //if (intCol == 1)
                        //                    //    sbRecord.Append("<td><b>Sub Total For " + strFourthGroupBy + "</b></td><td>&nbsp;</td>");
                        //                    //else
                        //                    //{

                        //                    sbRecord.Append("<td>&nbsp;</td>");
                        //                    //}
                        //                }
                        //            }
                        //            intCol++;
                        //        }

                        //        sbRecord.Append("</tr>");
                        //        dtSubTotalFourthGroup.Clear();
                        //    }
                        //}
                        //#endregion

                        //#region Third
                        //// print subtotal for 3rd group by when the value is changed
                        //if (!string.IsNullOrEmpty(strThirdGroupBy) && !string.IsNullOrEmpty(strGroupByValue_3) && strGroupByValue_3 != Convert.ToString(Reader[strThirdGroupBy]))
                        //{
                        //    if (dtSubTotalThirdGroup.Rows.Count > 0)
                        //    {
                        //        sbRecord.Append("<tr>");
                        //        int intCol = 1;
                        //        if (dtSchema.Rows.Count > 0)
                        //            sbRecord.Append("<td><b>Sub Total For " + strThirdGroupBy + "</b></td>");
                        //        foreach (DataRow drSchema in dtSchema.Rows)
                        //        {
                        //            string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();

                        //            if (strFirstGroupBy != strColName && strSecGroupBy != strColName && strThirdGroupBy != strColName && strFourthGroupBy != strColName && strFifthGroupBy != strColName)
                        //            {

                        //                if (dtSubTotalThirdGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                        //                    sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalThirdGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                        //                else
                        //                {
                        //                    //if (intCol == 1)
                        //                    //    sbRecord.Append("<td><b>Sub Total For " + strThirdGroupBy + "</b></td><td>&nbsp;</td>");
                        //                    //else
                        //                    //{

                        //                    sbRecord.Append("<td>&nbsp;</td>");
                        //                    //}
                        //                }
                        //            }

                        //            intCol++;
                        //        }

                        //        sbRecord.Append("</tr>");
                        //        dtSubTotalThirdGroup.Clear();
                        //    }
                        //}
                        //#endregion

                        #region Second
                        // print subtotal for 2nd group by when the value is changed
                        if (!string.IsNullOrEmpty(strSecGroupBy) && !string.IsNullOrEmpty(strGroupByValue_2) && strGroupByValue_2 != Convert.ToString(Reader[strSecGroupBy]))
                        {
                            if (dtSubTotalSecondGroup.Rows.Count > 0)
                            {
                                sbRecord.Append("<tr>");
                                int intCol = 1;
                                if (dtSchema.Rows.Count > 0)
                                    sbRecord.Append("<td><b>Sub Total For " + strSecGroupBy + "</b></td>");
                                foreach (DataRow drSchema in dtSchema.Rows)
                                {
                                    string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();

                                    if (strFirstGroupBy != strColName && strSecGroupBy != strColName)
                                        //&& strThirdGroupBy != strColName && strFourthGroupBy != strColName && strFifthGroupBy != strColName)
                                    {
                                        if (dtSubTotalSecondGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                                            sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalSecondGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                                        else
                                        {
                                            //if (intCol == 1)
                                            //    sbRecord.Append("<td><b>Sub Total For " + strSecGroupBy + "</b></td><td>&nbsp;</td>");
                                            //else
                                            //{

                                            sbRecord.Append("<td>&nbsp;</td>");
                                            // }
                                        }
                                    }

                                    intCol++;
                                }

                                sbRecord.Append("</tr>");
                                dtSubTotalSecondGroup.Clear();
                            }
                        }
                        #endregion

                        #region First
                        // print subtotal for 1st group by when the value is changed
                        if (!string.IsNullOrEmpty(strFirstGroupBy) && !string.IsNullOrEmpty(strGroupByValue_1) && strGroupByValue_1 != Convert.ToString(Reader[strFirstGroupBy]))
                        {
                            if (dtSubTotalFirstGroup.Rows.Count > 0)
                            {
                                sbRecord.Append("<tr>");
                                int intCol = 1;
                                if (dtSchema.Rows.Count > 0)
                                    sbRecord.Append("<td><b>Sub Total For " + strFirstGroupBy + "</b></td>");
                                foreach (DataRow drSchema in dtSchema.Rows)
                                {
                                    string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();

                                    if (strFirstGroupBy != strColName && strSecGroupBy != strColName)
                                        //&& strThirdGroupBy != strColName && strFourthGroupBy != strColName && strFifthGroupBy != strColName)
                                    {
                                        if (dtSubTotalFirstGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                                            sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalFirstGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                                        else
                                        {
                                            //if (intCol == 1)
                                            //    sbRecord.Append("<td><b>Sub Total For " + strFirstGroupBy + "</b></td><td>&nbsp;</td>");
                                            //else
                                            //{

                                            sbRecord.Append("<td>&nbsp;</td>");
                                            //}
                                        }
                                    }

                                    intCol++;
                                }

                                sbRecord.Append("</tr>");
                                dtSubTotalFirstGroup.Clear();
                            }
                        }
                        #endregion

                        #endregion

                        #region Group By

                        #region First Group
                        if (!string.IsNullOrEmpty(strFirstGroupBy))
                        {
                            if (strGroupByValue_1 != Convert.ToString(Reader[strFirstGroupBy]))
                            {
                                strGroupByValue_1 = Convert.ToString(Reader[strFirstGroupBy]);
                                if (strFormatFirstGroupBy == "decimal")
                                    sbRecord.Append("<tr><td style='font-weight: bold;color: #FF9C09;' colspan='2' align='right' >&nbsp;" + strFirstGroupBy + ": " + string.Format("{0:c2}", strGroupByValue_1) + "</td></tr>");
                                else if (strFormatFirstGroupBy == "datetime")
                                {
                                    // it display only Time
                                    if (strFirstGroupBy == "Time Theft Reported")
                                        sbRecord.Append("<tr><td style='font-weight: bold;color: #FF9C09;' colspan='2'>&nbsp;" + strFirstGroupBy + ": " + string.Format("{0:HH:mm}", Reader[strFirstGroupBy]) + "</td></tr>");
                                    else sbRecord.Append("<tr><td style='font-weight: bold;color: #FF9C09;' colspan='2'>&nbsp;" + strFirstGroupBy + ": " + FormatDBNullDateToDisplay(strGroupByValue_1) + "</td></tr>");
                                }
                                else sbRecord.Append("<tr><td style='font-weight: bold;color: #FF9C09;' colspan='2'>&nbsp;" + strFirstGroupBy + ": " + strGroupByValue_1 + "</td><td  style='border-bottom:none;' rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                //Change Second Group By when First Groupby is Change
                                strGroupByValue_2 = string.Empty;
                            }
                            // it will set No : [First Group By] when it is null
                            else if ((Reader[strFirstGroupBy] == DBNull.Value || string.IsNullOrEmpty(Convert.ToString(Reader[strFirstGroupBy]))) && strNOGroup1 == string.Empty)
                            {
                                strNOGroup1 = "No " + strFirstGroupBy;
                                sbRecord.Append("<tr><td style='font-weight: bold;color: #FF9C09;' colspan='2'>&nbsp;" + strFirstGroupBy + ": " + strNOGroup1 + "</td></tr>");
                                // When Group by 1 value find as Null
                                strNOGroup1 = strFirstGroupBy;
                                //Change Second Group By when First Groupby is Change
                                strGroupByValue_2 = string.Empty;
                            }
                        }
                        #endregion

                        #region Second Group By
                        if (!string.IsNullOrEmpty(strSecGroupBy))
                        {
                            if (strGroupByValue_2 != Convert.ToString(Reader[strSecGroupBy]))
                            {
                                strGroupByValue_2 = Convert.ToString(Reader[strSecGroupBy]);
                                if (strFormatSecGroupBy == "decimal")
                                    sbRecord.Append("<tr><td style='font-weight: bold;color: #276692;' align='right' colspan='2' >&nbsp;" + strSecGroupBy + ": " + string.Format("{0:c2}", strGroupByValue_2) + "</td><td style='border-bottom:none;' rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                else if (strFormatSecGroupBy == "datetime")
                                {
                                    // it display only Time
                                    if (strSecGroupBy == "Time Theft Reported")
                                        sbRecord.Append("<tr><td style='font-weight: bold;color: #276692;' colspan='2'>&nbsp;" + strSecGroupBy + ": " + string.Format("{0:HH:mm}", Reader[strSecGroupBy]) + "</td><td style='border-bottom:none;' rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                    else sbRecord.Append("<tr><td style='font-weight: bold;color: #276692;' colspan='2'>&nbsp;" + strSecGroupBy + ": " + FormatDBNullDateToDisplay(strGroupByValue_2) + "</td><td style='border-bottom:none;' rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                }
                                else sbRecord.Append("<tr><td style='font-weight: bold;color: #276692;' colspan='2'>&nbsp;" + strSecGroupBy + ": " + strGroupByValue_2 + "</td><td style='border-bottom:none;' rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                            }
                            else if (Reader[strSecGroupBy] == DBNull.Value && strNOGroup2 == string.Empty)
                            {
                                strNOGroup2 = "No " + strSecGroupBy;
                                sbRecord.Append("<tr><td style='font-weight: bold;color: #276692;' colspan='2'>&nbsp;" + strSecGroupBy + ": " + strNOGroup2 + "</td><td style='border-bottom:none;' rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                                //No Group by assign
                                strNOGroup2 = strGroupByValue_2;
                            }
                        }
                        #endregion

                        //#region Third Group BY
                        //if (!string.IsNullOrEmpty(strThirdGroupBy))
                        //{
                        //    if (strGroupByValue_3 != Convert.ToString(Reader[strThirdGroupBy]))
                        //    {
                        //        strGroupByValue_3 = Convert.ToString(Reader[strThirdGroupBy]);
                        //        if (strFormatThirdGroupBy == "decimal")
                        //            sbRecord.Append("<tr><td style='font-weight: bold;color: #603311;' align='right' colspan='2'>&nbsp;" + strThirdGroupBy + ": " + string.Format("{0:c2}", strGroupByValue_3) + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                        //        else if (strFormatThirdGroupBy == "datetime")
                        //        {
                        //            // it display only Time
                        //            if (strThirdGroupBy == "Time Theft Reported")
                        //                sbRecord.Append("<tr><td style='font-weight: bold;color: #603311;' colspan='2'>&nbsp;" + strThirdGroupBy + ": " + string.Format("{0:HH:mm}", Reader[strThirdGroupBy]) + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                        //            else sbRecord.Append("<tr><td style='font-weight: bold;color: #603311;' colspan='2'>&nbsp;" + strThirdGroupBy + ": " + FormatDBNullDateToDisplay(strGroupByValue_3) + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                        //        }
                        //        else sbRecord.Append("<tr><td style='font-weight: bold;color: #603311;' colspan='2'>&nbsp;" + strThirdGroupBy + ": " + strGroupByValue_3 + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                        //        strGroupByValue_4 = strGroupByValue_5 = null;
                        //    }
                        //    else if ((Reader[strThirdGroupBy] == DBNull.Value || string.IsNullOrEmpty(Convert.ToString(Reader[strThirdGroupBy]))) && strNOGroup3 == string.Empty)
                        //    {
                        //        strNOGroup3 = "No " + strThirdGroupBy;
                        //        sbRecord.Append("<tr><td style='font-weight: bold;color: #603311;' colspan='2'>&nbsp;" + strThirdGroupBy + ": " + strNOGroup3 + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                        //        // When Group by 3 value find as Null
                        //        strNOGroup3 = strThirdGroupBy;
                        //        //Change third Group By when 3rd Groupby is Change
                        //        strGroupByValue_3 = string.Empty;
                        //    }
                        //}
                        //#endregion

                        //#region Fourth Group BY
                        //if (!string.IsNullOrEmpty(strFourthGroupBy))
                        //{
                        //    if (strGroupByValue_4 != Convert.ToString(Reader[strFourthGroupBy]))
                        //    {
                        //        strGroupByValue_4 = Convert.ToString(Reader[strFourthGroupBy]);
                        //        if (strFormatFourthGroupBy == "decimal")
                        //            sbRecord.Append("<tr><td style='font-weight: bold;color: green;' align='right' colspan='2'>&nbsp;" + strFourthGroupBy + ": " + string.Format("{0:c2}", strGroupByValue_4) + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                        //        else if (strFormatFourthGroupBy == "datetime")
                        //        {
                        //            // it display only Time
                        //            if (strFourthGroupBy == "Time Theft Reported")
                        //                sbRecord.Append("<tr><td style='font-weight: bold;color: green;' colspan='2'>&nbsp;" + strFourthGroupBy + ": " + string.Format("{0:HH:mm}", Reader[strFourthGroupBy]) + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                        //            else sbRecord.Append("<tr><td style='font-weight: bold;color: green;' colspan='2'>&nbsp;" + strFourthGroupBy + ": " + FormatDBNullDateToDisplay(strGroupByValue_4) + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                        //        }
                        //        else sbRecord.Append("<tr><td style='font-weight: bold;color: green;' colspan='2'>&nbsp;" + strFourthGroupBy + ": " + strGroupByValue_4 + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                        //        strGroupByValue_5 = null;
                        //    }
                        //    else if ((Reader[strFourthGroupBy] == DBNull.Value || string.IsNullOrEmpty(Convert.ToString(Reader[strFourthGroupBy]))) && strNOGroup4 == string.Empty)
                        //    {
                        //        strNOGroup4 = "No " + strFourthGroupBy;
                        //        sbRecord.Append("<tr><td style='font-weight: bold;color: green;' colspan='2'>&nbsp;" + strFourthGroupBy + ": " + strNOGroup4 + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                        //        // When Group by 4 value find as Null
                        //        strNOGroup4 = strFourthGroupBy;
                        //        //Change Fourth Group By when 4th Groupby is Change
                        //        strGroupByValue_4 = string.Empty;
                        //    }
                        //}
                        //#endregion

                        //#region Fifth Group BY
                        //if (!string.IsNullOrEmpty(strFifthGroupBy))
                        //{
                        //    if (strGroupByValue_5 != Convert.ToString(Reader[strFifthGroupBy]))
                        //    {
                        //        strGroupByValue_5 = Convert.ToString(Reader[strFifthGroupBy]);
                        //        if (strFormatFifthGroupBy == "decimal")
                        //            sbRecord.Append("<tr><td style='font-weight: bold;' align='right' colspan='2'>&nbsp;" + strFifthGroupBy + ": " + string.Format("{0:c2}", strGroupByValue_5) + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                        //        else if (strFormatFifthGroupBy == "datetime")
                        //        {
                        //            // it display only Time
                        //            if (strFifthGroupBy == "Time Theft Reported")
                        //                sbRecord.Append("<tr><td style='font-weight: bold;' colspan='2'>&nbsp;" + strFifthGroupBy + ": " + string.Format("{0:HH:mm}", Reader[strFifthGroupBy]) + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                        //            else sbRecord.Append("<tr><td style='font-weight: bold;' colspan='2'>&nbsp;" + strFifthGroupBy + ": " + FormatDBNullDateToDisplay(strGroupByValue_5) + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                        //        }
                        //        else sbRecord.Append("<tr><td style='font-weight: bold;' colspan='2'>&nbsp;" + strFifthGroupBy + ": " + strGroupByValue_5 + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                        //    }
                        //    else if ((Reader[strFifthGroupBy] == DBNull.Value || string.IsNullOrEmpty(Convert.ToString(Reader[strFifthGroupBy]))) && strNOGroup5 == string.Empty)
                        //    {
                        //        strNOGroup5 = "No " + strFifthGroupBy;
                        //        sbRecord.Append("<tr><td style='font-weight: bold;' colspan='2'>&nbsp;" + strFifthGroupBy + ": " + strNOGroup5 + "</td><td rowspan='5' colspan='" + (countColumn) + "'></td></tr>");
                        //        // When Group by 5 value find as Null
                        //        strNOGroup5 = strFifthGroupBy;
                        //        //Change fifth Group By when fifth Groupby is Change
                        //        strGroupByValue_5 = string.Empty;
                        //    }
                        //}

                        ////sbRecord.Append("</table></td></tr>");
                        //#endregion

                        #endregion

                        string strColumnName = string.Empty;
                        sbRecord.Append("<tr>");
                        if (IsGroupBySelected)
                            sbRecord.Append("<td colspan='2'>&nbsp;</td>");
                        ///Print Records
                        //for (int intColumn = 0; intColumn < Reader.FieldCount - 1; intColumn++)
                        for (int intColumn = 0; intColumn <= Reader.FieldCount - 1; intColumn++)
                        {
                            #region " Count Sub Totals"
                            #region First : 1st
                            if (!string.IsNullOrEmpty(strFirstGroupBy) && !string.IsNullOrEmpty(strGroupByValue_1))
                            {
                                if (dtSubTotalFirstGroup.Columns.Contains(Reader.GetName(intColumn)) && Convert.ToString(Reader[strFirstGroupBy]) == strGroupByValue_1)
                                {
                                    if (dtSubTotalFirstGroup.Rows.Count == 0)
                                    {
                                        dtSubTotalFirstGroup.Rows.Add(dtSubTotalFirstGroup.NewRow());
                                        foreach (DataColumn dcTotal in dtSubTotalFirstGroup.Columns)
                                            dtSubTotalFirstGroup.Rows[0][dcTotal] = 0;
                                    }
                                    decimal decTotal = 0;
                                    decTotal = Convert.ToDecimal(dtSubTotalFirstGroup.Rows[0][Reader.GetName(intColumn)]);
                                    decTotal += Reader.IsDBNull(intColumn) ? 0 : Convert.ToDecimal(Reader[intColumn]);
                                    dtSubTotalFirstGroup.Rows[0][Reader.GetName(intColumn)] = decTotal;
                                }
                            }
                            #endregion

                            #region  second: 2nd
                            if (!string.IsNullOrEmpty(strSecGroupBy) && !string.IsNullOrEmpty(strGroupByValue_2))
                            {
                                if (dtSubTotalSecondGroup.Columns.Contains(Reader.GetName(intColumn)) && Convert.ToString(Reader[strSecGroupBy]) == strGroupByValue_2)
                                {
                                    if (dtSubTotalSecondGroup.Rows.Count == 0)
                                    {
                                        dtSubTotalSecondGroup.Rows.Add(dtSubTotalSecondGroup.NewRow());
                                        foreach (DataColumn dcTotal in dtSubTotalSecondGroup.Columns)
                                            dtSubTotalSecondGroup.Rows[0][dcTotal] = 0;
                                    }
                                    decimal decTotal = 0;
                                    decTotal = Convert.ToDecimal(dtSubTotalSecondGroup.Rows[0][Reader.GetName(intColumn)]);
                                    decTotal += Reader.IsDBNull(intColumn) ? 0 : Convert.ToDecimal(Reader[intColumn]);
                                    dtSubTotalSecondGroup.Rows[0][Reader.GetName(intColumn)] = decTotal;
                                }
                            }
                            #endregion

                            //#region Third : 3nd
                            ////if (!string.IsNullOrEmpty(strThirdGroupBy) && !string.IsNullOrEmpty(strGroupByValue_3))
                            //if ((strThirdGroupBy != null) && (strGroupByValue_3 != null))
                            //{
                            //    if (dtSubTotalThirdGroup.Columns.Contains(Reader.GetName(intColumn)) && Convert.ToString(Reader[strThirdGroupBy]) == strGroupByValue_3)
                            //    {
                            //        if (dtSubTotalThirdGroup.Rows.Count == 0)
                            //        {
                            //            dtSubTotalThirdGroup.Rows.Add(dtSubTotalThirdGroup.NewRow());
                            //            foreach (DataColumn dcTotal in dtSubTotalThirdGroup.Columns)
                            //                dtSubTotalThirdGroup.Rows[0][dcTotal] = 0;
                            //        }
                            //        decimal decTotal = 0;
                            //        decTotal = Convert.ToDecimal(dtSubTotalThirdGroup.Rows[0][Reader.GetName(intColumn)]);
                            //        decTotal += Reader.IsDBNull(intColumn) ? 0 : Convert.ToDecimal(Reader[intColumn]);
                            //        dtSubTotalThirdGroup.Rows[0][Reader.GetName(intColumn)] = decTotal;
                            //    }
                            //}
                            //#endregion

                            //#region Fourth : 4th
                            ////if (!string.IsNullOrEmpty(strFourthGroupBy) && !string.IsNullOrEmpty(strGroupByValue_4))
                            //if ((strFourthGroupBy != null) && (strGroupByValue_4 != null))
                            //{
                            //    if (dtSubTotalFourthGroup.Columns.Contains(Reader.GetName(intColumn)) && Convert.ToString(Reader[strFourthGroupBy]) == strGroupByValue_4)
                            //    {
                            //        if (dtSubTotalFourthGroup.Rows.Count == 0)
                            //        {
                            //            dtSubTotalFourthGroup.Rows.Add(dtSubTotalFourthGroup.NewRow());
                            //            foreach (DataColumn dcTotal in dtSubTotalFourthGroup.Columns)
                            //                dtSubTotalFourthGroup.Rows[0][dcTotal] = 0;
                            //        }
                            //        decimal decTotal = 0;
                            //        decTotal = Convert.ToDecimal(dtSubTotalFourthGroup.Rows[0][Reader.GetName(intColumn)]);
                            //        decTotal += Reader.IsDBNull(intColumn) ? 0 : Convert.ToDecimal(Reader[intColumn]);
                            //        dtSubTotalFourthGroup.Rows[0][Reader.GetName(intColumn)] = decTotal;
                            //    }
                            //}
                            //#endregion

                            //#region Fifth : 5th
                            ////if (!string.IsNullOrEmpty(strFifthGroupBy) && !string.IsNullOrEmpty(strGroupByValue_5))
                            //if ((strFifthGroupBy != null) && (strGroupByValue_5 != null))
                            //{
                            //    if (dtSubTotalFifthGroup.Columns.Contains(Reader.GetName(intColumn)) && Convert.ToString(Reader[strFifthGroupBy]) == strGroupByValue_5)
                            //    {
                            //        if (dtSubTotalFifthGroup.Rows.Count == 0)
                            //        {
                            //            dtSubTotalFifthGroup.Rows.Add(dtSubTotalFifthGroup.NewRow());
                            //            foreach (DataColumn dcTotal in dtSubTotalFifthGroup.Columns)
                            //                dtSubTotalFifthGroup.Rows[0][dcTotal] = 0;
                            //        }
                            //        decimal decTotal = 0;
                            //        decTotal = Convert.ToDecimal(dtSubTotalFifthGroup.Rows[0][Reader.GetName(intColumn)]);
                            //        decTotal += Reader.IsDBNull(intColumn) ? 0 : Convert.ToDecimal(Reader[intColumn]);
                            //        dtSubTotalFifthGroup.Rows[0][Reader.GetName(intColumn)] = decTotal;
                            //    }
                            //}
                            //#endregion

                            #endregion
                            //Remove Group By Column
                            #region
                            if (strFirstGroupBy != Convert.ToString(dtSchema.Rows[intColumn]["ColumnName"]) && strSecGroupBy != Convert.ToString(dtSchema.Rows[intColumn]["ColumnName"])) 
                                //&& strThirdGroupBy != Convert.ToString(dtSchema.Rows[intColumn]["ColumnName"]) && strFourthGroupBy != Convert.ToString(dtSchema.Rows[intColumn]["ColumnName"]) && strFifthGroupBy != Convert.ToString(dtSchema.Rows[intColumn]["ColumnName"]))
                            {
                                strFormat = dtSchema.Rows[intColumn]["DataTypeName"].ToString();

                                if (strFormat == "decimal")
                                {
                                    // If dataType is Numeric but it is not Currency field.
                                    if (CheckISdisplayCurrencyFormat(dtSchema.Rows[intColumn][0].ToString()))
                                        sbRecord.Append("<td align='right' >&nbsp;" + string.Format("{0:c2}", Reader[intColumn]) + "</td>");
                                    else
                                        sbRecord.Append("<td align='right' >&nbsp;" + Convert.ToString(Reader[intColumn]) + "</td>");
                                }
                                else if (strFormat == "datetime")
                                {
                                    // it display only Time
                                    if (Convert.ToString(dtSchema.Rows[intColumn]["ColumnName"]) == "Time Theft Reported")
                                        sbRecord.Append("<td >&nbsp;" + string.Format("{0:HH:mm}", Reader[intColumn]) + "</td>");
                                    else sbRecord.Append("<td >&nbsp;" + string.Format("{0:MM/dd/yyyy}", Reader[intColumn]) + "</td>");
                                }
                                else
                                {

                                    //sbRecord.Append(@"<td style='mso-number-format:\@;'>&nbsp;" + Convert.ToString(Reader[intColumn]) + "</td>");
                                    sbRecord.Append(@"<td>&nbsp;" + Convert.ToString(Reader[intColumn]) + "</td>");
                                }
                            }
                            #endregion

                        }
                        #region "Grand Total"
                        for (int intColumn2 = 0; intColumn2 < Reader.FieldCount; intColumn2++)
                        {
                            //IF Grand Total Option is Selected and Have Field for SUM.
                            //if (Convert.ToString(ObjAdHocReport.GrandTotal) == "Y" && dtHeader.Columns.Count > 0)
                            //{
                            //    if (dtHeader.Columns.Contains(Reader.GetName(intColumn2)))
                            //    {
                            //        decimal decTotal = 0;
                            //        decTotal = Convert.ToDecimal(dtHeader.Rows[0][Reader.GetName(intColumn2)]);
                            //        decTotal += Reader.IsDBNull(intColumn2) ? 0 : Convert.ToDecimal(Reader[intColumn2]);
                            //        dtHeader.Rows[0][Reader.GetName(intColumn2)] = decTotal;
                            //    }
                            //}
                        }
                        #endregion
                        sbRecord.Append("</tr>");



                        using (StreamWriter sw = File.AppendText(strPath))
                        {
                            sw.Write(sbRecord);
                            sbRecord = new StringBuilder(string.Empty);
                        }
                    } while (Reader.Read());

                    #region " SUBTOAL FOR Last groups "
                    //if (dtSubTotalFifthGroup.Rows.Count > 0)
                    //{
                    //    sbRecord.Append("<tr>");
                    //    int intCol = 1;
                    //    if (dtSchema.Rows.Count > 0)
                    //        sbRecord.Append("<td align='left'><b>Sub Total For " + strFifthGroupBy + "</b></td>");
                    //    foreach (DataRow drSchema in dtSchema.Rows)
                    //    {
                    //        string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();
                    //        if (strFirstGroupBy != strColName && strSecGroupBy != strColName && strThirdGroupBy != strColName && strFourthGroupBy != strColName && strFifthGroupBy != strColName)
                    //        {
                    //            if (dtSubTotalFifthGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                    //                sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalFifthGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                    //            else
                    //            {
                    //                //if (intCol == 1)
                    //                //    sbRecord.Append("<td align='left'><b>Sub Total For " + strFifthGroupBy + "</b></td>");
                    //                //else
                    //                //{

                    //                sbRecord.Append("<td>&nbsp;</td>");
                    //                //}
                    //            }
                    //        }
                    //        intCol++;
                    //    }
                    //    sbRecord.Append("</tr>");
                    //    dtSubTotalFifthGroup.Clear();
                    //}
                    //if (dtSubTotalFourthGroup.Rows.Count > 0)
                    //{
                    //    sbRecord.Append("<tr>");
                    //    int intCol = 1;
                    //    if (dtSchema.Rows.Count > 0)
                    //        sbRecord.Append("<td align='left'><b>Sub Total For " + strFourthGroupBy + "</b></td>");
                    //    foreach (DataRow drSchema in dtSchema.Rows)
                    //    {
                    //        string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();
                    //        if (strFirstGroupBy != strColName && strSecGroupBy != strColName && strThirdGroupBy != strColName && strFourthGroupBy != strColName && strFifthGroupBy != strColName)
                    //        {
                    //            if (dtSubTotalFourthGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                    //                sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalFourthGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                    //            else
                    //            {
                    //                //if (intCol == 1)
                    //                //    sbRecord.Append("<td align='left'><b>Sub Total For " + strFourthGroupBy + "</b></td>");
                    //                //else
                    //                //{

                    //                sbRecord.Append("<td>&nbsp;</td>");
                    //                //}
                    //            }
                    //        }
                    //        intCol++;
                    //    }
                    //    sbRecord.Append("</tr>");
                    //    dtSubTotalFourthGroup.Clear();
                    //}
                    //if (dtSubTotalThirdGroup.Rows.Count > 0)
                    //{
                    //    sbRecord.Append("<tr>");
                    //    int intCol = 1;
                    //    if (dtSchema.Rows.Count > 0)
                    //        sbRecord.Append("<td align='left'><b>Sub Total For " + strThirdGroupBy + "</b></td>");
                    //    foreach (DataRow drSchema in dtSchema.Rows)
                    //    {
                    //        string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();
                    //        if (strFirstGroupBy != strColName && strSecGroupBy != strColName && strThirdGroupBy != strColName && strFourthGroupBy != strColName && strFifthGroupBy != strColName)
                    //        {
                    //            if (dtSubTotalThirdGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                    //                sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalThirdGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                    //            else
                    //            {
                    //                //if (intCol == 1)
                    //                //    sbRecord.Append("<td align='left'><b>Sub Total For " + strThirdGroupBy + "</b></td>");
                    //                //else
                    //                //{

                    //                sbRecord.Append("<td>&nbsp;</td>");
                    //                //}
                    //            }
                    //        }
                    //        intCol++;
                    //    }
                    //    sbRecord.Append("</tr>");
                    //    dtSubTotalThirdGroup.Clear();
                    //}
                    if (dtSubTotalSecondGroup.Rows.Count > 0)
                    {
                        sbRecord.Append("<tr>");
                        int intCol = 1;
                        if (dtSchema.Rows.Count > 0)
                            sbRecord.Append("<td align='left'><b>Sub Total For " + strSecGroupBy + "</b></td>");
                        foreach (DataRow drSchema in dtSchema.Rows)
                        {
                            string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();
                            if (strFirstGroupBy != strColName && strSecGroupBy != strColName) 
                                //&& strThirdGroupBy != strColName && strFourthGroupBy != strColName && strFifthGroupBy != strColName)
                            {
                                if (dtSubTotalSecondGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                                    sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalSecondGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                                else
                                {
                                    //if (intCol == 1)
                                    //    sbRecord.Append("<td align='left'><b>Sub Total For " + strSecGroupBy + "</b></td>");
                                    //else
                                    //{
                                    sbRecord.Append("<td>&nbsp;</td>");
                                    //}
                                }
                            }
                            intCol++;
                        }
                        sbRecord.Append("</tr>");
                        dtSubTotalSecondGroup.Clear();
                    }
                    if (dtSubTotalFirstGroup.Rows.Count > 0)
                    {
                        sbRecord.Append("<tr>");
                        int intCol = 1;
                        if (dtSchema.Rows.Count > 0)
                            sbRecord.Append("<td align='left'><b>Sub Total For " + strFirstGroupBy + "</b></td>");
                        foreach (DataRow drSchema in dtSchema.Rows)
                        {
                            string strColName = Convert.ToString(drSchema["ColumnName"]).ToString();
                            if (strFirstGroupBy != strColName && strSecGroupBy != strColName) 
                                //&& strThirdGroupBy != strColName && strFourthGroupBy != strColName && strFifthGroupBy != strColName)
                            {
                                if (dtSubTotalFirstGroup.Columns.Contains(Convert.ToString(drSchema["ColumnName"])))
                                    sbRecord.Append("<td align='right'><b>" + string.Format("{0:c2}", dtSubTotalFirstGroup.Rows[0][Convert.ToString(drSchema["ColumnName"])]) + "</b></td>");
                                else
                                {
                                    //if (intCol == 1)
                                    //    sbRecord.Append("<td align='left'><b>Sub Total For " + strFirstGroupBy + "</b></td>");
                                    //else
                                    //{
                                    sbRecord.Append("<td>&nbsp;</td>");
                                    // }
                                }
                            }
                            intCol++;
                        }
                        sbRecord.Append("</tr>");
                        dtSubTotalFirstGroup.Clear();
                    }

                    #endregion

                    #endregion

                    //Table End
                    sbRecord.Append("</table></td></tr>"); 


                    #region "Footer Template"
                    // IF Grand Total Option is Checked and Have record from Transaction Table to SUM
                    //if ((Convert.ToString(ObjAdHocReport.GrandTotal) == "Y") && dtHeader.Columns.Count > 0)
                    //{
                    //    sbRecord.Append("<tr><td colspan='3'>");
                    //    string strStyle = "'font-weight: bold;background-color: #507CD1;color: White;'";
                    //    sbRecord.Append("<br />");
                    //    sbRecord.Append("<table border='1' cellpadding='0' cellspacing='0'><tr align='right'>");
                    //    sbRecord.Append("<td style='font-weight: bold;' align='left'>Grand Totals</td>");

                    //    for (int intColumn = 0; intColumn < dtHeader.Columns.Count; intColumn++)
                    //        sbRecord.Append("<td style='font-weight: bold;'>" + Convert.ToString(dtHeader.Columns[intColumn]) + "</td>");
                    //    // show Header for claim count
                    //    // sbRecord.Append("<td style='font-weight: bold;'>" + Convert.ToString(dtHeader.Columns[0]) + "</td>");
                    //    sbRecord.Append("</tr>");

                    //    sbRecord.Append("<tr align='right'>");
                    //    sbRecord.Append("<td style=" + strStyle + ">&nbsp;</td>");

                    //    //No column Claim count 
                    //    for (int intColumn = 0; intColumn < dtHeader.Columns.Count; intColumn++)
                    //        sbRecord.Append("<td style=" + strStyle + ">" + string.Format("{0:c2}", dtHeader.Rows[0][intColumn]) + "</td>");
                    //    // show value for Claim Count
                    //    //sbRecord.Append("<td style=" + strStyle + ">" + dtHeader.Rows[0][dtHeader.Columns.Count - 1] + "</td>");
                    //    sbRecord.Append("</tr><table>");
                    //    sbRecord.Append("</td></tr>");
                    //}
                    #endregion
                    //Remove White Space.
                    //sbRecord.Replace("<tr></tr>", "");
                    sbRecord.Append("</table></body></html>");
                    using (StreamWriter sw = File.AppendText(strPath))
                    {
                        sw.Write(sbRecord);
                        sbRecord = new StringBuilder(string.Empty);
                    }
                }
                else
                {
                    //Remove WhiteSpace
                    sbRecord.Replace("<tr></tr>", "");
                    if (!Directory.Exists(AppDomain.CurrentDomain.BaseDirectory + @"temp\"))
                        Directory.CreateDirectory(AppDomain.CurrentDomain.BaseDirectory + @"temp\");

                    strPath = AppDomain.CurrentDomain.BaseDirectory + @"temp\" + strReportSchedulerName + System.DateTime.Now.ToString("MMddyyhhmmss") + ".xls";
                    ///When records are not found.
                    sbRecord.Append("<table  cellpadding='4' cellspacing='0' Width='100%'>");
                    sbRecord.Append("<tr>");
                    sbRecord.Append("<td align='center'>No Record found.</td></tr></table>");
                    using (StreamWriter sw = File.AppendText(strPath))
                    {
                        sw.Write(sbRecord);
                        sbRecord = new StringBuilder(string.Empty);
                    }
                }

                if (!Reader.IsClosed)
                    Reader.Close();

                return strPath;
            }
            catch (Exception ex)
            {
                //EventLog.WriteEntry("ERROR in Property Ad Hoc Report Writer , " + ex.Message);
                EventLog.WriteEntry("ERROR in Property Ad Hoc Report Writer , " + ex.Message + ",Stack Trace:" + ex.StackTrace);
            }
            finally
            {
                if (Reader != null)
                {
                    Reader.Close();
                    Reader.Dispose();
                }
                if (dtSchema != null)
                    dtSchema.Dispose();
                if (dtHeader != null)
                    dtHeader.Dispose();
            }
            return strPath;
        }
        #endregion
    }
}